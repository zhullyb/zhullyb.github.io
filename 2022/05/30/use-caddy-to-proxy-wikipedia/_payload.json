[{"data":1,"prerenderedAt":546},["ShallowReactive",2],{"post-2022-05-30-use-caddy-to-proxy-wikipedia-zh":3,"surround-2022-05-30-use-caddy-to-proxy-wikipedia-zh":533,"randomIndex/2022/05/30/use-caddy-to-proxy-wikipedia/":113,"language-switch-/2022/05/30/use-caddy-to-proxy-wikipedia/-en":545},{"title":4,"date":5,"path":6,"tags":7,"body":9,"description":15},"使用caddy反向代理维基百科中文站点","2022-05-30 08:59:21","/2022/05/30/use-caddy-to-proxy-wikipedia",[8],"Caddy",{"type":10,"value":11,"toc":527},"minimark",[12,16,26,29,33,66,70,461,464,470,477,484,492,495,517,523],[13,14,15],"p",{},"反代的目的无非是两点",[17,18,19,23],"ul",{},[20,21,22],"li",{},"满足自己在无代理情况下访问无法访问的站点的需求",[20,24,25],{},"方便将站点分享给亲朋好友。",[13,27,28],{},"一直以来，我都想用 caddy 去反代一份维基百科来用，今天刚好就顺手解决了。",[30,31,32],"h2",{"id":32},"注意事项",[17,34,35,38,41,44],{},[20,36,37],{},"用于反代的机子需要有对目标站点的访问能力",[20,39,40],{},"最好准备一个新的域名作为白手套，防止被污染",[20,42,43],{},"建议增加密码保护，一来使得小鸡流量不被滥用，二来防止防火墙检测到站点内容",[20,45,46,47,51,52,55,56,62,63,65],{},"本文使用的 caddy 开启了 ",[48,49,50],"code",{},"replace_response"," 插件，可以使用 ",[48,53,54],{},"xcaddy"," 编译或直接前往 ",[57,58,59],"a",{"href":59,"rel":60},"https://caddyserver.com/download",[61],"nofollow"," 勾选相应插件后下载。安装时，建议先根据官方文档安装原版 caddy，再用启用了 ",[48,64,50],{}," 插件的 caddy 二进制文件覆盖掉原版 caddy，这样就不需要去手写 systemd 相关的文件了。",[30,67,69],{"id":68},"caddyfile","Caddyfile",[71,72,77],"pre",{"className":73,"code":74,"language":75,"meta":76,"style":76},"language-nginx shiki shiki-themes one-light one-dark-pro","{\n        order replace after encode\n}\n\nhttps://zhwiki.example.com {\n\n        reverse_proxy * https://zh.wikipedia.org {\n                header_up Host {upstream_hostport}\n                header_up X-Real-IP {http.request.remote.host}\n                header_up X-Forwarded-For {http.request.remote.host}\n                header_up X-Forwarded-Port {http.request.port}\n                header_up X-Forwarded-Proto {http.request.scheme}\n                header_up Accept-Encoding identity\n                header_down location (https://zh.wikipedia.org/)(.*) https://zhwiki.example.com/$2\n                header_down location (https://zh.m.wikipedia.org/)(.*) http://m.zhwiki.example.com/$2\n        }\n\n        replace {\n                \"upload.wikimedia.org\" \"up.zhwiki.example.com\"\n                \"zh.wikipedia.org\" \"zhwiki.example.com\"\n                \"zh.m.wikipedia.org\" \"m.zhwiki.example.com\"\n        }\n}\n\nhttps://m.zhwiki.example.com {\n\n        reverse_proxy * https://zh.m.wikipedia.org {\n                header_up Host {upstream_hostport}\n                header_up X-Real-IP {http.request.remote.host}\n                header_up X-Forwarded-For {http.request.remote.host}\n                header_up X-Forwarded-Port {http.request.port}\n                header_up X-Forwarded-Proto {http.request.scheme}\n                header_up Accept-Encoding identity\n                header_down location (https://zh.wikipedia.org/)(.*) https://zhwiki.example.com/$2\n                header_down location (https://zh.m.wikipedia.org/)(.*) http://m.zhwiki.example.com/$2\n        }\n\n        replace {\n                \"upload.wikimedia.org\" \"up.zhwiki.example.com\"\n                \"zh.wikipedia.org\" \"zhwiki.example.com\"\n                \"zh.m.wikipedia.org\" \"m.zhwiki.example.com\"\n        }\n}\n\nhttps://up.zhwiki.example.com {\n        reverse_proxy * https://upload.wikimedia.org {\n                header_up Host {upstream_hostport}\n                header_up X-Real-IP {http.request.remote.host}\n                header_up X-Forwarded-For {http.request.remote.host}\n                header_up X-Forwarded-Port {http.request.port}\n                header_up X-Forwarded-Proto {http.request.scheme}\n                header_up Accept-Encoding identity\n        }\n}\n\n","nginx","",[48,78,79,88,98,104,111,123,128,137,146,154,162,170,178,186,199,209,215,220,228,234,240,246,251,256,261,271,276,284,291,298,305,312,319,326,335,344,349,354,361,366,371,376,381,386,391,401,409,416,423,430,437,444,451,456],{"__ignoreMap":76},[80,81,84],"span",{"class":82,"line":83},"line",1,[80,85,87],{"class":86},"s5ixo","{\n",[80,89,91,95],{"class":82,"line":90},2,[80,92,94],{"class":93},"sLKXg","        order",[80,96,97],{"class":86}," replace after encode\n",[80,99,101],{"class":82,"line":100},3,[80,102,103],{"class":86},"}\n",[80,105,107],{"class":82,"line":106},4,[80,108,110],{"emptyLinePlaceholder":109},true,"\n",[80,112,114,117,120],{"class":82,"line":113},5,[80,115,116],{"class":86},"https://zhwiki.example.",[80,118,119],{"class":93},"com",[80,121,122],{"class":86}," {\n",[80,124,126],{"class":82,"line":125},6,[80,127,110],{"emptyLinePlaceholder":109},[80,129,131,134],{"class":82,"line":130},7,[80,132,133],{"class":93},"        reverse_proxy",[80,135,136],{"class":86}," * https://zh.wikipedia.org {\n",[80,138,140,143],{"class":82,"line":139},8,[80,141,142],{"class":93},"                header_up",[80,144,145],{"class":86}," Host {upstream_hostport}\n",[80,147,149,151],{"class":82,"line":148},9,[80,150,142],{"class":93},[80,152,153],{"class":86}," X-Real-IP {http.request.remote.host}\n",[80,155,157,159],{"class":82,"line":156},10,[80,158,142],{"class":93},[80,160,161],{"class":86}," X-Forwarded-For {http.request.remote.host}\n",[80,163,165,167],{"class":82,"line":164},11,[80,166,142],{"class":93},[80,168,169],{"class":86}," X-Forwarded-Port {http.request.port}\n",[80,171,173,175],{"class":82,"line":172},12,[80,174,142],{"class":93},[80,176,177],{"class":86}," X-Forwarded-Proto {http.request.scheme}\n",[80,179,181,183],{"class":82,"line":180},13,[80,182,142],{"class":93},[80,184,185],{"class":86}," Accept-Encoding identity\n",[80,187,189,192,195],{"class":82,"line":188},14,[80,190,191],{"class":93},"                header_down",[80,193,194],{"class":86}," location (https://zh.wikipedia.org/)(.*) https://zhwiki.example.com/$",[80,196,198],{"class":197},"sJa8x","2\n",[80,200,202,204,207],{"class":82,"line":201},15,[80,203,191],{"class":93},[80,205,206],{"class":86}," location (https://zh.m.wikipedia.org/)(.*) http://m.zhwiki.example.com/$",[80,208,198],{"class":197},[80,210,212],{"class":82,"line":211},16,[80,213,214],{"class":86},"        }\n",[80,216,218],{"class":82,"line":217},17,[80,219,110],{"emptyLinePlaceholder":109},[80,221,223,226],{"class":82,"line":222},18,[80,224,225],{"class":93},"        replace",[80,227,122],{"class":86},[80,229,231],{"class":82,"line":230},19,[80,232,233],{"class":86},"                \"upload.wikimedia.org\" \"up.zhwiki.example.com\"\n",[80,235,237],{"class":82,"line":236},20,[80,238,239],{"class":86},"                \"zh.wikipedia.org\" \"zhwiki.example.com\"\n",[80,241,243],{"class":82,"line":242},21,[80,244,245],{"class":86},"                \"zh.m.wikipedia.org\" \"m.zhwiki.example.com\"\n",[80,247,249],{"class":82,"line":248},22,[80,250,214],{"class":86},[80,252,254],{"class":82,"line":253},23,[80,255,103],{"class":86},[80,257,259],{"class":82,"line":258},24,[80,260,110],{"emptyLinePlaceholder":109},[80,262,264,267,269],{"class":82,"line":263},25,[80,265,266],{"class":86},"https://m.zhwiki.example.",[80,268,119],{"class":93},[80,270,122],{"class":86},[80,272,274],{"class":82,"line":273},26,[80,275,110],{"emptyLinePlaceholder":109},[80,277,279,281],{"class":82,"line":278},27,[80,280,133],{"class":93},[80,282,283],{"class":86}," * https://zh.m.wikipedia.org {\n",[80,285,287,289],{"class":82,"line":286},28,[80,288,142],{"class":93},[80,290,145],{"class":86},[80,292,294,296],{"class":82,"line":293},29,[80,295,142],{"class":93},[80,297,153],{"class":86},[80,299,301,303],{"class":82,"line":300},30,[80,302,142],{"class":93},[80,304,161],{"class":86},[80,306,308,310],{"class":82,"line":307},31,[80,309,142],{"class":93},[80,311,169],{"class":86},[80,313,315,317],{"class":82,"line":314},32,[80,316,142],{"class":93},[80,318,177],{"class":86},[80,320,322,324],{"class":82,"line":321},33,[80,323,142],{"class":93},[80,325,185],{"class":86},[80,327,329,331,333],{"class":82,"line":328},34,[80,330,191],{"class":93},[80,332,194],{"class":86},[80,334,198],{"class":197},[80,336,338,340,342],{"class":82,"line":337},35,[80,339,191],{"class":93},[80,341,206],{"class":86},[80,343,198],{"class":197},[80,345,347],{"class":82,"line":346},36,[80,348,214],{"class":86},[80,350,352],{"class":82,"line":351},37,[80,353,110],{"emptyLinePlaceholder":109},[80,355,357,359],{"class":82,"line":356},38,[80,358,225],{"class":93},[80,360,122],{"class":86},[80,362,364],{"class":82,"line":363},39,[80,365,233],{"class":86},[80,367,369],{"class":82,"line":368},40,[80,370,239],{"class":86},[80,372,374],{"class":82,"line":373},41,[80,375,245],{"class":86},[80,377,379],{"class":82,"line":378},42,[80,380,214],{"class":86},[80,382,384],{"class":82,"line":383},43,[80,385,103],{"class":86},[80,387,389],{"class":82,"line":388},44,[80,390,110],{"emptyLinePlaceholder":109},[80,392,394,397,399],{"class":82,"line":393},45,[80,395,396],{"class":86},"https://up.zhwiki.example.",[80,398,119],{"class":93},[80,400,122],{"class":86},[80,402,404,406],{"class":82,"line":403},46,[80,405,133],{"class":93},[80,407,408],{"class":86}," * https://upload.wikimedia.org {\n",[80,410,412,414],{"class":82,"line":411},47,[80,413,142],{"class":93},[80,415,145],{"class":86},[80,417,419,421],{"class":82,"line":418},48,[80,420,142],{"class":93},[80,422,153],{"class":86},[80,424,426,428],{"class":82,"line":425},49,[80,427,142],{"class":93},[80,429,161],{"class":86},[80,431,433,435],{"class":82,"line":432},50,[80,434,142],{"class":93},[80,436,169],{"class":86},[80,438,440,442],{"class":82,"line":439},51,[80,441,142],{"class":93},[80,443,177],{"class":86},[80,445,447,449],{"class":82,"line":446},52,[80,448,142],{"class":93},[80,450,185],{"class":86},[80,452,454],{"class":82,"line":453},53,[80,455,214],{"class":86},[80,457,459],{"class":82,"line":458},54,[80,460,103],{"class":86},[30,462,463],{"id":463},"简单解释",[13,465,466,467,469],{},"第一大段是启用 ",[48,468,50],{}," 插件的部分，直接照抄即可。",[13,471,472,473,476],{},"第二和第三大段的思路是一致的，分别反向代理了 PC 端和移动段的网页。两行 ",[48,474,475],{}," header_down"," 的写法是受到了知乎上那篇 Github 反代的启发，避免了源站发出 302 重定向时访客被带到源站去。replace 部分不用多说，就是将针对三个源站域名的请求改到反代站域名。",[13,478,479,480,483],{},"第四大段就是中规中举地反代了 ",[48,481,482],{},"upload.wikimedia.org"," 这个域名，上面存放的大多数是媒体文件，如果条件允许的话其实可以考虑使用多个服务器反代。",[13,485,486,487,491],{},"密码保护在我这份 Caddyfile 中没有启用，如果有需要的话可以参考我的",[57,488,490],{"href":489},"/2021/10/21/picuploader-on-archlinux-with-caddy/#%E8%AE%BE%E7%BD%AE%E8%AE%BF%E9%97%AE%E5%AF%86%E7%A0%81%EF%BC%88%E5%8F%AF%E9%80%89%EF%BC%89","另一篇博客","。",[30,493,494],{"id":494},"参考资料",[13,496,497,502,507,512],{},[57,498,501],{"href":499,"rel":500},"https://caddyserver.com/docs/",[61],"Caddy 官方文档",[57,503,506],{"href":504,"rel":505},"https://zhuanlan.zhihu.com/p/476390779",[61],"The Road to Serfdom——如何为GitHub搭建反向代理",[57,508,511],{"href":509,"rel":510},"https://ichon.me/post/1026.html",[61],"使用 Caddy 配置 Wikipedia 反向代理",[57,513,516],{"href":514,"rel":515},"https://learningman.top/archives/365",[61],"使用 Caddy 反代 ghcr.io",[13,518,519],{},[520,521,522],"em",{},"所有参考资料除官方文档外均使用 web.archive.org 和 archive.ph 进行存档，如有无法访问的情况，请自行前往存档站获取历史存档。",[524,525,526],"style",{},"html pre.shiki code .s5ixo, html code.shiki .s5ixo{--shiki-default:#383A42;--shiki-dark:#ABB2BF}html pre.shiki code .sLKXg, html code.shiki .sLKXg{--shiki-default:#A626A4;--shiki-dark:#C678DD}html pre.shiki code .sJa8x, html code.shiki .sJa8x{--shiki-default:#E45649;--shiki-dark:#E06C75}html .default .shiki span {color: var(--shiki-default);background: var(--shiki-default-bg);font-style: var(--shiki-default-font-style);font-weight: var(--shiki-default-font-weight);text-decoration: var(--shiki-default-text-decoration);}html .shiki span {color: var(--shiki-default);background: var(--shiki-default-bg);font-style: var(--shiki-default-font-style);font-weight: var(--shiki-default-font-weight);text-decoration: var(--shiki-default-text-decoration);}html .dark .shiki span {color: var(--shiki-dark);background: var(--shiki-dark-bg);font-style: var(--shiki-dark-font-style);font-weight: var(--shiki-dark-font-weight);text-decoration: var(--shiki-dark-text-decoration);}html.dark .shiki span {color: var(--shiki-dark);background: var(--shiki-dark-bg);font-style: var(--shiki-dark-font-style);font-weight: var(--shiki-dark-font-weight);text-decoration: var(--shiki-dark-text-decoration);}",{"title":76,"searchDepth":90,"depth":90,"links":528},[529,530,531,532],{"id":32,"depth":90,"text":32},{"id":68,"depth":90,"text":69},{"id":463,"depth":90,"text":463},{"id":494,"depth":90,"text":494},[534,540],{"title":535,"path":536,"stem":537,"date":538,"lang":539,"children":-1},"处理 fcitx5 的文字候选框在 tg 客户端上闪烁的问题","/2022/07/03/fcitx5-blinking-on-tg-under-wayland-kde","posts/zh/fcitx5-blinking-on-tg-under-wayland-kde","2022-07-03 13:52:44","zh-CN",{"title":541,"path":542,"stem":543,"date":544,"lang":539,"children":-1},"创建一个本地的 Fedora 镜像源","/2022/05/11/setup-a-local-fedora-source","posts/zh/setup-a-local-fedora-source","2022-05-11 04:18:26",null,1769818305712]