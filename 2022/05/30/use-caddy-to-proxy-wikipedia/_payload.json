[{"data":1,"prerenderedAt":553},["ShallowReactive",2],{"post-2022-05-30-use-caddy-to-proxy-wikipedia-zh":3,"surround-2022-05-30-use-caddy-to-proxy-wikipedia-zh":542,"randomIndex/2022/05/30/use-caddy-to-proxy-wikipedia/":103},{"id":4,"title":5,"body":6,"date":530,"description":12,"extension":531,"lang":532,"meta":533,"navigation":106,"path":534,"rawbody":535,"seo":536,"stem":537,"sticky":538,"tags":539,"__hash__":541},"posts/posts/zh/use-caddy-to-proxy-wikipedia.md","使用caddy反向代理维基百科中文站点",{"type":7,"value":8,"toc":524},"minimark",[9,13,23,26,30,63,67,458,461,467,474,481,489,492,514,520],[10,11,12],"p",{},"反代的目的无非是两点",[14,15,16,20],"ul",{},[17,18,19],"li",{},"满足自己在无代理情况下访问无法访问的站点的需求",[17,21,22],{},"方便将站点分享给亲朋好友。",[10,24,25],{},"一直以来，我都想用 caddy 去反代一份维基百科来用，今天刚好就顺手解决了。",[27,28,29],"h2",{"id":29},"注意事项",[14,31,32,35,38,41],{},[17,33,34],{},"用于反代的机子需要有对目标站点的访问能力",[17,36,37],{},"最好准备一个新的域名作为白手套，防止被污染",[17,39,40],{},"建议增加密码保护，一来使得小鸡流量不被滥用，二来防止防火墙检测到站点内容",[17,42,43,44,48,49,52,53,59,60,62],{},"本文使用的 caddy 开启了 ",[45,46,47],"code",{},"replace_response"," 插件，可以使用 ",[45,50,51],{},"xcaddy"," 编译或直接前往 ",[54,55,56],"a",{"href":56,"rel":57},"https://caddyserver.com/download",[58],"nofollow"," 勾选相应插件后下载。安装时，建议先根据官方文档安装原版 caddy，再用启用了 ",[45,61,47],{}," 插件的 caddy 二进制文件覆盖掉原版 caddy，这样就不需要去手写 systemd 相关的文件了。",[27,64,66],{"id":65},"caddyfile","Caddyfile",[68,69,74],"pre",{"className":70,"code":71,"language":72,"meta":73,"style":73},"language-nginx shiki shiki-themes one-light one-dark-pro","{\n        order replace after encode\n}\n\nhttps://zhwiki.example.com {\n\n        reverse_proxy * https://zh.wikipedia.org {\n                header_up Host {upstream_hostport}\n                header_up X-Real-IP {http.request.remote.host}\n                header_up X-Forwarded-For {http.request.remote.host}\n                header_up X-Forwarded-Port {http.request.port}\n                header_up X-Forwarded-Proto {http.request.scheme}\n                header_up Accept-Encoding identity\n                header_down location (https://zh.wikipedia.org/)(.*) https://zhwiki.example.com/$2\n                header_down location (https://zh.m.wikipedia.org/)(.*) http://m.zhwiki.example.com/$2\n        }\n\n        replace {\n                \"upload.wikimedia.org\" \"up.zhwiki.example.com\"\n                \"zh.wikipedia.org\" \"zhwiki.example.com\"\n                \"zh.m.wikipedia.org\" \"m.zhwiki.example.com\"\n        }\n}\n\nhttps://m.zhwiki.example.com {\n\n        reverse_proxy * https://zh.m.wikipedia.org {\n                header_up Host {upstream_hostport}\n                header_up X-Real-IP {http.request.remote.host}\n                header_up X-Forwarded-For {http.request.remote.host}\n                header_up X-Forwarded-Port {http.request.port}\n                header_up X-Forwarded-Proto {http.request.scheme}\n                header_up Accept-Encoding identity\n                header_down location (https://zh.wikipedia.org/)(.*) https://zhwiki.example.com/$2\n                header_down location (https://zh.m.wikipedia.org/)(.*) http://m.zhwiki.example.com/$2\n        }\n\n        replace {\n                \"upload.wikimedia.org\" \"up.zhwiki.example.com\"\n                \"zh.wikipedia.org\" \"zhwiki.example.com\"\n                \"zh.m.wikipedia.org\" \"m.zhwiki.example.com\"\n        }\n}\n\nhttps://up.zhwiki.example.com {\n        reverse_proxy * https://upload.wikimedia.org {\n                header_up Host {upstream_hostport}\n                header_up X-Real-IP {http.request.remote.host}\n                header_up X-Forwarded-For {http.request.remote.host}\n                header_up X-Forwarded-Port {http.request.port}\n                header_up X-Forwarded-Proto {http.request.scheme}\n                header_up Accept-Encoding identity\n        }\n}\n\n","nginx","",[45,75,76,85,95,101,108,120,125,134,143,151,159,167,175,183,196,206,212,217,225,231,237,243,248,253,258,268,273,281,288,295,302,309,316,323,332,341,346,351,358,363,368,373,378,383,388,398,406,413,420,427,434,441,448,453],{"__ignoreMap":73},[77,78,81],"span",{"class":79,"line":80},"line",1,[77,82,84],{"class":83},"s5ixo","{\n",[77,86,88,92],{"class":79,"line":87},2,[77,89,91],{"class":90},"sLKXg","        order",[77,93,94],{"class":83}," replace after encode\n",[77,96,98],{"class":79,"line":97},3,[77,99,100],{"class":83},"}\n",[77,102,104],{"class":79,"line":103},4,[77,105,107],{"emptyLinePlaceholder":106},true,"\n",[77,109,111,114,117],{"class":79,"line":110},5,[77,112,113],{"class":83},"https://zhwiki.example.",[77,115,116],{"class":90},"com",[77,118,119],{"class":83}," {\n",[77,121,123],{"class":79,"line":122},6,[77,124,107],{"emptyLinePlaceholder":106},[77,126,128,131],{"class":79,"line":127},7,[77,129,130],{"class":90},"        reverse_proxy",[77,132,133],{"class":83}," * https://zh.wikipedia.org {\n",[77,135,137,140],{"class":79,"line":136},8,[77,138,139],{"class":90},"                header_up",[77,141,142],{"class":83}," Host {upstream_hostport}\n",[77,144,146,148],{"class":79,"line":145},9,[77,147,139],{"class":90},[77,149,150],{"class":83}," X-Real-IP {http.request.remote.host}\n",[77,152,154,156],{"class":79,"line":153},10,[77,155,139],{"class":90},[77,157,158],{"class":83}," X-Forwarded-For {http.request.remote.host}\n",[77,160,162,164],{"class":79,"line":161},11,[77,163,139],{"class":90},[77,165,166],{"class":83}," X-Forwarded-Port {http.request.port}\n",[77,168,170,172],{"class":79,"line":169},12,[77,171,139],{"class":90},[77,173,174],{"class":83}," X-Forwarded-Proto {http.request.scheme}\n",[77,176,178,180],{"class":79,"line":177},13,[77,179,139],{"class":90},[77,181,182],{"class":83}," Accept-Encoding identity\n",[77,184,186,189,192],{"class":79,"line":185},14,[77,187,188],{"class":90},"                header_down",[77,190,191],{"class":83}," location (https://zh.wikipedia.org/)(.*) https://zhwiki.example.com/$",[77,193,195],{"class":194},"sJa8x","2\n",[77,197,199,201,204],{"class":79,"line":198},15,[77,200,188],{"class":90},[77,202,203],{"class":83}," location (https://zh.m.wikipedia.org/)(.*) http://m.zhwiki.example.com/$",[77,205,195],{"class":194},[77,207,209],{"class":79,"line":208},16,[77,210,211],{"class":83},"        }\n",[77,213,215],{"class":79,"line":214},17,[77,216,107],{"emptyLinePlaceholder":106},[77,218,220,223],{"class":79,"line":219},18,[77,221,222],{"class":90},"        replace",[77,224,119],{"class":83},[77,226,228],{"class":79,"line":227},19,[77,229,230],{"class":83},"                \"upload.wikimedia.org\" \"up.zhwiki.example.com\"\n",[77,232,234],{"class":79,"line":233},20,[77,235,236],{"class":83},"                \"zh.wikipedia.org\" \"zhwiki.example.com\"\n",[77,238,240],{"class":79,"line":239},21,[77,241,242],{"class":83},"                \"zh.m.wikipedia.org\" \"m.zhwiki.example.com\"\n",[77,244,246],{"class":79,"line":245},22,[77,247,211],{"class":83},[77,249,251],{"class":79,"line":250},23,[77,252,100],{"class":83},[77,254,256],{"class":79,"line":255},24,[77,257,107],{"emptyLinePlaceholder":106},[77,259,261,264,266],{"class":79,"line":260},25,[77,262,263],{"class":83},"https://m.zhwiki.example.",[77,265,116],{"class":90},[77,267,119],{"class":83},[77,269,271],{"class":79,"line":270},26,[77,272,107],{"emptyLinePlaceholder":106},[77,274,276,278],{"class":79,"line":275},27,[77,277,130],{"class":90},[77,279,280],{"class":83}," * https://zh.m.wikipedia.org {\n",[77,282,284,286],{"class":79,"line":283},28,[77,285,139],{"class":90},[77,287,142],{"class":83},[77,289,291,293],{"class":79,"line":290},29,[77,292,139],{"class":90},[77,294,150],{"class":83},[77,296,298,300],{"class":79,"line":297},30,[77,299,139],{"class":90},[77,301,158],{"class":83},[77,303,305,307],{"class":79,"line":304},31,[77,306,139],{"class":90},[77,308,166],{"class":83},[77,310,312,314],{"class":79,"line":311},32,[77,313,139],{"class":90},[77,315,174],{"class":83},[77,317,319,321],{"class":79,"line":318},33,[77,320,139],{"class":90},[77,322,182],{"class":83},[77,324,326,328,330],{"class":79,"line":325},34,[77,327,188],{"class":90},[77,329,191],{"class":83},[77,331,195],{"class":194},[77,333,335,337,339],{"class":79,"line":334},35,[77,336,188],{"class":90},[77,338,203],{"class":83},[77,340,195],{"class":194},[77,342,344],{"class":79,"line":343},36,[77,345,211],{"class":83},[77,347,349],{"class":79,"line":348},37,[77,350,107],{"emptyLinePlaceholder":106},[77,352,354,356],{"class":79,"line":353},38,[77,355,222],{"class":90},[77,357,119],{"class":83},[77,359,361],{"class":79,"line":360},39,[77,362,230],{"class":83},[77,364,366],{"class":79,"line":365},40,[77,367,236],{"class":83},[77,369,371],{"class":79,"line":370},41,[77,372,242],{"class":83},[77,374,376],{"class":79,"line":375},42,[77,377,211],{"class":83},[77,379,381],{"class":79,"line":380},43,[77,382,100],{"class":83},[77,384,386],{"class":79,"line":385},44,[77,387,107],{"emptyLinePlaceholder":106},[77,389,391,394,396],{"class":79,"line":390},45,[77,392,393],{"class":83},"https://up.zhwiki.example.",[77,395,116],{"class":90},[77,397,119],{"class":83},[77,399,401,403],{"class":79,"line":400},46,[77,402,130],{"class":90},[77,404,405],{"class":83}," * https://upload.wikimedia.org {\n",[77,407,409,411],{"class":79,"line":408},47,[77,410,139],{"class":90},[77,412,142],{"class":83},[77,414,416,418],{"class":79,"line":415},48,[77,417,139],{"class":90},[77,419,150],{"class":83},[77,421,423,425],{"class":79,"line":422},49,[77,424,139],{"class":90},[77,426,158],{"class":83},[77,428,430,432],{"class":79,"line":429},50,[77,431,139],{"class":90},[77,433,166],{"class":83},[77,435,437,439],{"class":79,"line":436},51,[77,438,139],{"class":90},[77,440,174],{"class":83},[77,442,444,446],{"class":79,"line":443},52,[77,445,139],{"class":90},[77,447,182],{"class":83},[77,449,451],{"class":79,"line":450},53,[77,452,211],{"class":83},[77,454,456],{"class":79,"line":455},54,[77,457,100],{"class":83},[27,459,460],{"id":460},"简单解释",[10,462,463,464,466],{},"第一大段是启用 ",[45,465,47],{}," 插件的部分，直接照抄即可。",[10,468,469,470,473],{},"第二和第三大段的思路是一致的，分别反向代理了 PC 端和移动段的网页。两行 ",[45,471,472],{}," header_down"," 的写法是受到了知乎上那篇 Github 反代的启发，避免了源站发出 302 重定向时访客被带到源站去。replace 部分不用多说，就是将针对三个源站域名的请求改到反代站域名。",[10,475,476,477,480],{},"第四大段就是中规中举地反代了 ",[45,478,479],{},"upload.wikimedia.org"," 这个域名，上面存放的大多数是媒体文件，如果条件允许的话其实可以考虑使用多个服务器反代。",[10,482,483,484,488],{},"密码保护在我这份 Caddyfile 中没有启用，如果有需要的话可以参考我的",[54,485,487],{"href":486},"/2021/10/21/picuploader-on-archlinux-with-caddy/#%E8%AE%BE%E7%BD%AE%E8%AE%BF%E9%97%AE%E5%AF%86%E7%A0%81%EF%BC%88%E5%8F%AF%E9%80%89%EF%BC%89","另一篇博客","。",[27,490,491],{"id":491},"参考资料",[10,493,494,499,504,509],{},[54,495,498],{"href":496,"rel":497},"https://caddyserver.com/docs/",[58],"Caddy 官方文档",[54,500,503],{"href":501,"rel":502},"https://zhuanlan.zhihu.com/p/476390779",[58],"The Road to Serfdom——如何为GitHub搭建反向代理",[54,505,508],{"href":506,"rel":507},"https://ichon.me/post/1026.html",[58],"使用 Caddy 配置 Wikipedia 反向代理",[54,510,513],{"href":511,"rel":512},"https://learningman.top/archives/365",[58],"使用 Caddy 反代 ghcr.io",[10,515,516],{},[517,518,519],"em",{},"所有参考资料除官方文档外均使用 web.archive.org 和 archive.ph 进行存档，如有无法访问的情况，请自行前往存档站获取历史存档。",[521,522,523],"style",{},"html pre.shiki code .s5ixo, html code.shiki .s5ixo{--shiki-default:#383A42;--shiki-dark:#ABB2BF}html pre.shiki code .sLKXg, html code.shiki .sLKXg{--shiki-default:#A626A4;--shiki-dark:#C678DD}html pre.shiki code .sJa8x, html code.shiki .sJa8x{--shiki-default:#E45649;--shiki-dark:#E06C75}html .default .shiki span {color: var(--shiki-default);background: var(--shiki-default-bg);font-style: var(--shiki-default-font-style);font-weight: var(--shiki-default-font-weight);text-decoration: var(--shiki-default-text-decoration);}html .shiki span {color: var(--shiki-default);background: var(--shiki-default-bg);font-style: var(--shiki-default-font-style);font-weight: var(--shiki-default-font-weight);text-decoration: var(--shiki-default-text-decoration);}html .dark .shiki span {color: var(--shiki-dark);background: var(--shiki-dark-bg);font-style: var(--shiki-dark-font-style);font-weight: var(--shiki-dark-font-weight);text-decoration: var(--shiki-dark-text-decoration);}html.dark .shiki span {color: var(--shiki-dark);background: var(--shiki-dark-bg);font-style: var(--shiki-dark-font-style);font-weight: var(--shiki-dark-font-weight);text-decoration: var(--shiki-dark-text-decoration);}",{"title":73,"searchDepth":87,"depth":87,"links":525},[526,527,528,529],{"id":29,"depth":87,"text":29},{"id":65,"depth":87,"text":66},{"id":460,"depth":87,"text":460},{"id":491,"depth":87,"text":491},"2022-05-30 08:59:21","md","zh-CN",{},"/2022/05/30/use-caddy-to-proxy-wikipedia","---\ntitle: 使用caddy反向代理维基百科中文站点\ndate: 2022-05-30 08:59:21\nsticky:\ntags:\n- Caddy\n---\n\n反代的目的无非是两点\n\n- 满足自己在无代理情况下访问无法访问的站点的需求\n- 方便将站点分享给亲朋好友。\n\n一直以来，我都想用 caddy 去反代一份维基百科来用，今天刚好就顺手解决了。\n\n## 注意事项\n\n- 用于反代的机子需要有对目标站点的访问能力\n- 最好准备一个新的域名作为白手套，防止被污染\n- 建议增加密码保护，一来使得小鸡流量不被滥用，二来防止防火墙检测到站点内容\n- 本文使用的 caddy 开启了 `replace_response` 插件，可以使用 `xcaddy` 编译或直接前往 https://caddyserver.com/download 勾选相应插件后下载。安装时，建议先根据官方文档安装原版 caddy，再用启用了 `replace_response` 插件的 caddy 二进制文件覆盖掉原版 caddy，这样就不需要去手写 systemd 相关的文件了。\n\n## Caddyfile\n\n```nginx\n{\n        order replace after encode\n}\n\nhttps://zhwiki.example.com {\n\n        reverse_proxy * https://zh.wikipedia.org {\n                header_up Host {upstream_hostport}\n                header_up X-Real-IP {http.request.remote.host}\n                header_up X-Forwarded-For {http.request.remote.host}\n                header_up X-Forwarded-Port {http.request.port}\n                header_up X-Forwarded-Proto {http.request.scheme}\n                header_up Accept-Encoding identity\n                header_down location (https://zh.wikipedia.org/)(.*) https://zhwiki.example.com/$2\n                header_down location (https://zh.m.wikipedia.org/)(.*) http://m.zhwiki.example.com/$2\n        }\n\n        replace {\n                \"upload.wikimedia.org\" \"up.zhwiki.example.com\"\n                \"zh.wikipedia.org\" \"zhwiki.example.com\"\n                \"zh.m.wikipedia.org\" \"m.zhwiki.example.com\"\n        }\n}\n\nhttps://m.zhwiki.example.com {\n\n        reverse_proxy * https://zh.m.wikipedia.org {\n                header_up Host {upstream_hostport}\n                header_up X-Real-IP {http.request.remote.host}\n                header_up X-Forwarded-For {http.request.remote.host}\n                header_up X-Forwarded-Port {http.request.port}\n                header_up X-Forwarded-Proto {http.request.scheme}\n                header_up Accept-Encoding identity\n                header_down location (https://zh.wikipedia.org/)(.*) https://zhwiki.example.com/$2\n                header_down location (https://zh.m.wikipedia.org/)(.*) http://m.zhwiki.example.com/$2\n        }\n\n        replace {\n                \"upload.wikimedia.org\" \"up.zhwiki.example.com\"\n                \"zh.wikipedia.org\" \"zhwiki.example.com\"\n                \"zh.m.wikipedia.org\" \"m.zhwiki.example.com\"\n        }\n}\n\nhttps://up.zhwiki.example.com {\n        reverse_proxy * https://upload.wikimedia.org {\n                header_up Host {upstream_hostport}\n                header_up X-Real-IP {http.request.remote.host}\n                header_up X-Forwarded-For {http.request.remote.host}\n                header_up X-Forwarded-Port {http.request.port}\n                header_up X-Forwarded-Proto {http.request.scheme}\n                header_up Accept-Encoding identity\n        }\n}\n\n```\n\n## 简单解释\n\n第一大段是启用 `replace_response` 插件的部分，直接照抄即可。\n\n第二和第三大段的思路是一致的，分别反向代理了 PC 端和移动段的网页。两行 ` header_down` 的写法是受到了知乎上那篇 Github 反代的启发，避免了源站发出 302 重定向时访客被带到源站去。replace 部分不用多说，就是将针对三个源站域名的请求改到反代站域名。\n\n第四大段就是中规中举地反代了 `upload.wikimedia.org` 这个域名，上面存放的大多数是媒体文件，如果条件允许的话其实可以考虑使用多个服务器反代。\n\n密码保护在我这份 Caddyfile 中没有启用，如果有需要的话可以参考我的[另一篇博客](/2021/10/21/picuploader-on-archlinux-with-caddy/#设置访问密码（可选）)。\n\n## 参考资料\n\n[Caddy 官方文档](https://caddyserver.com/docs/)\n[The Road to Serfdom——如何为GitHub搭建反向代理](https://zhuanlan.zhihu.com/p/476390779)\n[使用 Caddy 配置 Wikipedia 反向代理](https://ichon.me/post/1026.html)\n[使用 Caddy 反代 ghcr.io](https://learningman.top/archives/365)\n\n*所有参考资料除官方文档外均使用 web.archive.org 和 archive.ph 进行存档，如有无法访问的情况，请自行前往存档站获取历史存档。*\n\n",{"title":5,"description":12},"posts/zh/use-caddy-to-proxy-wikipedia",false,[540],"Caddy","yjfS4hFmlS7PZ1own5Z2Tq5iKykEUzdAr5ZweZESjPw",[543,548],{"title":544,"path":545,"stem":546,"date":547,"lang":532,"children":-1},"处理 fcitx5 的文字候选框在 tg 客户端上闪烁的问题","/2022/07/03/fcitx5-blinking-on-tg-under-wayland-kde","posts/zh/fcitx5-blinking-on-tg-under-wayland-kde","2022-07-03 13:52:44",{"title":549,"path":550,"stem":551,"date":552,"lang":532,"children":-1},"创建一个本地的 Fedora 镜像源","/2022/05/11/setup-a-local-fedora-source","posts/zh/setup-a-local-fedora-source","2022-05-11 04:18:26",1763639506853]