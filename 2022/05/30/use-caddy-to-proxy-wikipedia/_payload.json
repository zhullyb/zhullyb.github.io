[{"data":1,"prerenderedAt":466},["ShallowReactive",2],{"post-2022-05-30-use-caddy-to-proxy-wikipedia":3,"surround-2022-05-30-use-caddy-to-proxy-wikipedia":455,"randomIndex/2022/05/30/use-caddy-to-proxy-wikipedia":105},{"id":4,"title":5,"body":6,"date":444,"description":12,"extension":445,"meta":446,"navigation":101,"path":447,"rawbody":448,"seo":449,"stem":450,"sticky":451,"tags":452,"__hash__":454},"posts/posts/use-caddy-to-proxy-wikipedia.md","使用caddy反向代理维基百科中文站点",{"type":7,"value":8,"toc":438},"minimark",[9,13,23,26,30,63,67,372,375,381,388,395,403,406,428,434],[10,11,12],"p",{},"反代的目的无非是两点",[14,15,16,20],"ul",{},[17,18,19],"li",{},"满足自己在无代理情况下访问无法访问的站点的需求",[17,21,22],{},"方便将站点分享给亲朋好友。",[10,24,25],{},"一直以来，我都想用 caddy 去反代一份维基百科来用，今天刚好就顺手解决了。",[27,28,29],"h2",{"id":29},"注意事项",[14,31,32,35,38,41],{},[17,33,34],{},"用于反代的机子需要有对目标站点的访问能力",[17,36,37],{},"最好准备一个新的域名作为白手套，防止被污染",[17,39,40],{},"建议增加密码保护，一来使得小鸡流量不被滥用，二来防止防火墙检测到站点内容",[17,42,43,44,48,49,52,53,59,60,62],{},"本文使用的 caddy 开启了 ",[45,46,47],"code",{},"replace_response"," 插件，可以使用 ",[45,50,51],{},"xcaddy"," 编译或直接前往 ",[54,55,56],"a",{"href":56,"rel":57},"https://caddyserver.com/download",[58],"nofollow"," 勾选相应插件后下载。安装时，建议先根据官方文档安装原版 caddy，再用启用了 ",[45,61,47],{}," 插件的 caddy 二进制文件覆盖掉原版 caddy，这样就不需要去手写 systemd 相关的文件了。",[27,64,66],{"id":65},"caddyfile","Caddyfile",[68,69,74],"pre",{"className":70,"code":71,"language":72,"meta":73,"style":73},"language-nginx shiki shiki-themes github-light github-dark","{\n        order replace after encode\n}\n\nhttps://zhwiki.example.com {\n\n        reverse_proxy * https://zh.wikipedia.org {\n                header_up Host {upstream_hostport}\n                header_up X-Real-IP {http.request.remote.host}\n                header_up X-Forwarded-For {http.request.remote.host}\n                header_up X-Forwarded-Port {http.request.port}\n                header_up X-Forwarded-Proto {http.request.scheme}\n                header_up Accept-Encoding identity\n                header_down location (https://zh.wikipedia.org/)(.*) https://zhwiki.example.com/$2\n                header_down location (https://zh.m.wikipedia.org/)(.*) http://m.zhwiki.example.com/$2\n        }\n\n        replace {\n                \"upload.wikimedia.org\" \"up.zhwiki.example.com\"\n                \"zh.wikipedia.org\" \"zhwiki.example.com\"\n                \"zh.m.wikipedia.org\" \"m.zhwiki.example.com\"\n        }\n}\n\nhttps://m.zhwiki.example.com {\n\n        reverse_proxy * https://zh.m.wikipedia.org {\n                header_up Host {upstream_hostport}\n                header_up X-Real-IP {http.request.remote.host}\n                header_up X-Forwarded-For {http.request.remote.host}\n                header_up X-Forwarded-Port {http.request.port}\n                header_up X-Forwarded-Proto {http.request.scheme}\n                header_up Accept-Encoding identity\n                header_down location (https://zh.wikipedia.org/)(.*) https://zhwiki.example.com/$2\n                header_down location (https://zh.m.wikipedia.org/)(.*) http://m.zhwiki.example.com/$2\n        }\n\n        replace {\n                \"upload.wikimedia.org\" \"up.zhwiki.example.com\"\n                \"zh.wikipedia.org\" \"zhwiki.example.com\"\n                \"zh.m.wikipedia.org\" \"m.zhwiki.example.com\"\n        }\n}\n\nhttps://up.zhwiki.example.com {\n        reverse_proxy * https://upload.wikimedia.org {\n                header_up Host {upstream_hostport}\n                header_up X-Real-IP {http.request.remote.host}\n                header_up X-Forwarded-For {http.request.remote.host}\n                header_up X-Forwarded-Port {http.request.port}\n                header_up X-Forwarded-Proto {http.request.scheme}\n                header_up Accept-Encoding identity\n        }\n}\n\n","nginx","",[45,75,76,84,90,96,103,109,114,120,126,132,138,144,150,156,162,168,174,179,185,191,197,203,208,213,218,224,229,235,240,245,250,255,260,265,270,275,280,285,290,295,300,305,310,315,320,326,332,337,342,347,352,357,362,367],{"__ignoreMap":73},[77,78,81],"span",{"class":79,"line":80},"line",1,[77,82,83],{},"{\n",[77,85,87],{"class":79,"line":86},2,[77,88,89],{},"        order replace after encode\n",[77,91,93],{"class":79,"line":92},3,[77,94,95],{},"}\n",[77,97,99],{"class":79,"line":98},4,[77,100,102],{"emptyLinePlaceholder":101},true,"\n",[77,104,106],{"class":79,"line":105},5,[77,107,108],{},"https://zhwiki.example.com {\n",[77,110,112],{"class":79,"line":111},6,[77,113,102],{"emptyLinePlaceholder":101},[77,115,117],{"class":79,"line":116},7,[77,118,119],{},"        reverse_proxy * https://zh.wikipedia.org {\n",[77,121,123],{"class":79,"line":122},8,[77,124,125],{},"                header_up Host {upstream_hostport}\n",[77,127,129],{"class":79,"line":128},9,[77,130,131],{},"                header_up X-Real-IP {http.request.remote.host}\n",[77,133,135],{"class":79,"line":134},10,[77,136,137],{},"                header_up X-Forwarded-For {http.request.remote.host}\n",[77,139,141],{"class":79,"line":140},11,[77,142,143],{},"                header_up X-Forwarded-Port {http.request.port}\n",[77,145,147],{"class":79,"line":146},12,[77,148,149],{},"                header_up X-Forwarded-Proto {http.request.scheme}\n",[77,151,153],{"class":79,"line":152},13,[77,154,155],{},"                header_up Accept-Encoding identity\n",[77,157,159],{"class":79,"line":158},14,[77,160,161],{},"                header_down location (https://zh.wikipedia.org/)(.*) https://zhwiki.example.com/$2\n",[77,163,165],{"class":79,"line":164},15,[77,166,167],{},"                header_down location (https://zh.m.wikipedia.org/)(.*) http://m.zhwiki.example.com/$2\n",[77,169,171],{"class":79,"line":170},16,[77,172,173],{},"        }\n",[77,175,177],{"class":79,"line":176},17,[77,178,102],{"emptyLinePlaceholder":101},[77,180,182],{"class":79,"line":181},18,[77,183,184],{},"        replace {\n",[77,186,188],{"class":79,"line":187},19,[77,189,190],{},"                \"upload.wikimedia.org\" \"up.zhwiki.example.com\"\n",[77,192,194],{"class":79,"line":193},20,[77,195,196],{},"                \"zh.wikipedia.org\" \"zhwiki.example.com\"\n",[77,198,200],{"class":79,"line":199},21,[77,201,202],{},"                \"zh.m.wikipedia.org\" \"m.zhwiki.example.com\"\n",[77,204,206],{"class":79,"line":205},22,[77,207,173],{},[77,209,211],{"class":79,"line":210},23,[77,212,95],{},[77,214,216],{"class":79,"line":215},24,[77,217,102],{"emptyLinePlaceholder":101},[77,219,221],{"class":79,"line":220},25,[77,222,223],{},"https://m.zhwiki.example.com {\n",[77,225,227],{"class":79,"line":226},26,[77,228,102],{"emptyLinePlaceholder":101},[77,230,232],{"class":79,"line":231},27,[77,233,234],{},"        reverse_proxy * https://zh.m.wikipedia.org {\n",[77,236,238],{"class":79,"line":237},28,[77,239,125],{},[77,241,243],{"class":79,"line":242},29,[77,244,131],{},[77,246,248],{"class":79,"line":247},30,[77,249,137],{},[77,251,253],{"class":79,"line":252},31,[77,254,143],{},[77,256,258],{"class":79,"line":257},32,[77,259,149],{},[77,261,263],{"class":79,"line":262},33,[77,264,155],{},[77,266,268],{"class":79,"line":267},34,[77,269,161],{},[77,271,273],{"class":79,"line":272},35,[77,274,167],{},[77,276,278],{"class":79,"line":277},36,[77,279,173],{},[77,281,283],{"class":79,"line":282},37,[77,284,102],{"emptyLinePlaceholder":101},[77,286,288],{"class":79,"line":287},38,[77,289,184],{},[77,291,293],{"class":79,"line":292},39,[77,294,190],{},[77,296,298],{"class":79,"line":297},40,[77,299,196],{},[77,301,303],{"class":79,"line":302},41,[77,304,202],{},[77,306,308],{"class":79,"line":307},42,[77,309,173],{},[77,311,313],{"class":79,"line":312},43,[77,314,95],{},[77,316,318],{"class":79,"line":317},44,[77,319,102],{"emptyLinePlaceholder":101},[77,321,323],{"class":79,"line":322},45,[77,324,325],{},"https://up.zhwiki.example.com {\n",[77,327,329],{"class":79,"line":328},46,[77,330,331],{},"        reverse_proxy * https://upload.wikimedia.org {\n",[77,333,335],{"class":79,"line":334},47,[77,336,125],{},[77,338,340],{"class":79,"line":339},48,[77,341,131],{},[77,343,345],{"class":79,"line":344},49,[77,346,137],{},[77,348,350],{"class":79,"line":349},50,[77,351,143],{},[77,353,355],{"class":79,"line":354},51,[77,356,149],{},[77,358,360],{"class":79,"line":359},52,[77,361,155],{},[77,363,365],{"class":79,"line":364},53,[77,366,173],{},[77,368,370],{"class":79,"line":369},54,[77,371,95],{},[27,373,374],{"id":374},"简单解释",[10,376,377,378,380],{},"第一大段是启用 ",[45,379,47],{}," 插件的部分，直接照抄即可。",[10,382,383,384,387],{},"第二和第三大段的思路是一致的，分别反向代理了 PC 端和移动段的网页。两行 ",[45,385,386],{}," header_down"," 的写法是受到了知乎上那篇 Github 反代的启发，避免了源站发出 302 重定向时访客被带到源站去。replace 部分不用多说，就是将针对三个源站域名的请求改到反代站域名。",[10,389,390,391,394],{},"第四大段就是中规中举地反代了 ",[45,392,393],{},"upload.wikimedia.org"," 这个域名，上面存放的大多数是媒体文件，如果条件允许的话其实可以考虑使用多个服务器反代。",[10,396,397,398,402],{},"密码保护在我这份 Caddyfile 中没有启用，如果有需要的话可以参考我的",[54,399,401],{"href":400},"/2021/10/21/picuploader-on-archlinux-with-caddy/#%E8%AE%BE%E7%BD%AE%E8%AE%BF%E9%97%AE%E5%AF%86%E7%A0%81%EF%BC%88%E5%8F%AF%E9%80%89%EF%BC%89","另一篇博客","。",[27,404,405],{"id":405},"参考资料",[10,407,408,413,418,423],{},[54,409,412],{"href":410,"rel":411},"https://caddyserver.com/docs/",[58],"Caddy 官方文档",[54,414,417],{"href":415,"rel":416},"https://zhuanlan.zhihu.com/p/476390779",[58],"The Road to Serfdom——如何为GitHub搭建反向代理",[54,419,422],{"href":420,"rel":421},"https://ichon.me/post/1026.html",[58],"使用 Caddy 配置 Wikipedia 反向代理",[54,424,427],{"href":425,"rel":426},"https://learningman.top/archives/365",[58],"使用 Caddy 反代 ghcr.io",[10,429,430],{},[431,432,433],"em",{},"所有参考资料除官方文档外均使用 web.archive.org 和 archive.ph 进行存档，如有无法访问的情况，请自行前往存档站获取历史存档。",[435,436,437],"style",{},"html .default .shiki span {color: var(--shiki-default);background: var(--shiki-default-bg);font-style: var(--shiki-default-font-style);font-weight: var(--shiki-default-font-weight);text-decoration: var(--shiki-default-text-decoration);}html .shiki span {color: var(--shiki-default);background: var(--shiki-default-bg);font-style: var(--shiki-default-font-style);font-weight: var(--shiki-default-font-weight);text-decoration: var(--shiki-default-text-decoration);}html .dark .shiki span {color: var(--shiki-dark);background: var(--shiki-dark-bg);font-style: var(--shiki-dark-font-style);font-weight: var(--shiki-dark-font-weight);text-decoration: var(--shiki-dark-text-decoration);}html.dark .shiki span {color: var(--shiki-dark);background: var(--shiki-dark-bg);font-style: var(--shiki-dark-font-style);font-weight: var(--shiki-dark-font-weight);text-decoration: var(--shiki-dark-text-decoration);}",{"title":73,"searchDepth":86,"depth":86,"links":439},[440,441,442,443],{"id":29,"depth":86,"text":29},{"id":65,"depth":86,"text":66},{"id":374,"depth":86,"text":374},{"id":405,"depth":86,"text":405},"2022-05-30 08:59:21","md",{},"/2022/05/30/use-caddy-to-proxy-wikipedia","---\ntitle: 使用caddy反向代理维基百科中文站点\ndate: 2022-05-30 08:59:21\nsticky:\ntags:\n- Caddy\n---\n\n反代的目的无非是两点\n\n- 满足自己在无代理情况下访问无法访问的站点的需求\n- 方便将站点分享给亲朋好友。\n\n一直以来，我都想用 caddy 去反代一份维基百科来用，今天刚好就顺手解决了。\n\n## 注意事项\n\n- 用于反代的机子需要有对目标站点的访问能力\n- 最好准备一个新的域名作为白手套，防止被污染\n- 建议增加密码保护，一来使得小鸡流量不被滥用，二来防止防火墙检测到站点内容\n- 本文使用的 caddy 开启了 `replace_response` 插件，可以使用 `xcaddy` 编译或直接前往 https://caddyserver.com/download 勾选相应插件后下载。安装时，建议先根据官方文档安装原版 caddy，再用启用了 `replace_response` 插件的 caddy 二进制文件覆盖掉原版 caddy，这样就不需要去手写 systemd 相关的文件了。\n\n## Caddyfile\n\n```nginx\n{\n        order replace after encode\n}\n\nhttps://zhwiki.example.com {\n\n        reverse_proxy * https://zh.wikipedia.org {\n                header_up Host {upstream_hostport}\n                header_up X-Real-IP {http.request.remote.host}\n                header_up X-Forwarded-For {http.request.remote.host}\n                header_up X-Forwarded-Port {http.request.port}\n                header_up X-Forwarded-Proto {http.request.scheme}\n                header_up Accept-Encoding identity\n                header_down location (https://zh.wikipedia.org/)(.*) https://zhwiki.example.com/$2\n                header_down location (https://zh.m.wikipedia.org/)(.*) http://m.zhwiki.example.com/$2\n        }\n\n        replace {\n                \"upload.wikimedia.org\" \"up.zhwiki.example.com\"\n                \"zh.wikipedia.org\" \"zhwiki.example.com\"\n                \"zh.m.wikipedia.org\" \"m.zhwiki.example.com\"\n        }\n}\n\nhttps://m.zhwiki.example.com {\n\n        reverse_proxy * https://zh.m.wikipedia.org {\n                header_up Host {upstream_hostport}\n                header_up X-Real-IP {http.request.remote.host}\n                header_up X-Forwarded-For {http.request.remote.host}\n                header_up X-Forwarded-Port {http.request.port}\n                header_up X-Forwarded-Proto {http.request.scheme}\n                header_up Accept-Encoding identity\n                header_down location (https://zh.wikipedia.org/)(.*) https://zhwiki.example.com/$2\n                header_down location (https://zh.m.wikipedia.org/)(.*) http://m.zhwiki.example.com/$2\n        }\n\n        replace {\n                \"upload.wikimedia.org\" \"up.zhwiki.example.com\"\n                \"zh.wikipedia.org\" \"zhwiki.example.com\"\n                \"zh.m.wikipedia.org\" \"m.zhwiki.example.com\"\n        }\n}\n\nhttps://up.zhwiki.example.com {\n        reverse_proxy * https://upload.wikimedia.org {\n                header_up Host {upstream_hostport}\n                header_up X-Real-IP {http.request.remote.host}\n                header_up X-Forwarded-For {http.request.remote.host}\n                header_up X-Forwarded-Port {http.request.port}\n                header_up X-Forwarded-Proto {http.request.scheme}\n                header_up Accept-Encoding identity\n        }\n}\n\n```\n\n## 简单解释\n\n第一大段是启用 `replace_response` 插件的部分，直接照抄即可。\n\n第二和第三大段的思路是一致的，分别反向代理了 PC 端和移动段的网页。两行 ` header_down` 的写法是受到了知乎上那篇 Github 反代的启发，避免了源站发出 302 重定向时访客被带到源站去。replace 部分不用多说，就是将针对三个源站域名的请求改到反代站域名。\n\n第四大段就是中规中举地反代了 `upload.wikimedia.org` 这个域名，上面存放的大多数是媒体文件，如果条件允许的话其实可以考虑使用多个服务器反代。\n\n密码保护在我这份 Caddyfile 中没有启用，如果有需要的话可以参考我的[另一篇博客](/2021/10/21/picuploader-on-archlinux-with-caddy/#设置访问密码（可选）)。\n\n## 参考资料\n\n[Caddy 官方文档](https://caddyserver.com/docs/)\n[The Road to Serfdom——如何为GitHub搭建反向代理](https://zhuanlan.zhihu.com/p/476390779)\n[使用 Caddy 配置 Wikipedia 反向代理](https://ichon.me/post/1026.html)\n[使用 Caddy 反代 ghcr.io](https://learningman.top/archives/365)\n\n*所有参考资料除官方文档外均使用 web.archive.org 和 archive.ph 进行存档，如有无法访问的情况，请自行前往存档站获取历史存档。*\n\n",{"title":5,"description":12},"posts/use-caddy-to-proxy-wikipedia",false,[453],"Caddy","zLADWNl7CVhN091ZrMl31neJTDfUt41ewV728jx1TM8",[456,461],{"title":457,"path":458,"stem":459,"date":460},"处理 fcitx5 的文字候选框在 tg 客户端上闪烁的问题","/2022/07/03/fcitx5-blinking-on-tg-under-wayland-kde","posts/fcitx5-blinking-on-tg-under-wayland-kde","2022-07-03 13:52:44",{"title":462,"path":463,"stem":464,"date":465},"创建一个本地的 Fedora 镜像源","/2022/05/11/setup-a-local-fedora-source","posts/setup-a-local-fedora-source","2022-05-11 04:18:26",1761697387054]