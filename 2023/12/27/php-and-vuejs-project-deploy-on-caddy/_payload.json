[{"data":1,"prerenderedAt":374},["ShallowReactive",2],{"post-2023-12-27-php-and-vuejs-project-deploy-on-caddy-zh":3,"surround-2023-12-27-php-and-vuejs-project-deploy-on-caddy-zh":361,"randomIndex/2023/12/27/php-and-vuejs-project-deploy-on-caddy/":75,"language-switch-/2023/12/27/php-and-vuejs-project-deploy-on-caddy/-en":373},{"title":4,"date":5,"path":6,"tags":7,"body":14,"description":61},"vuejs、php、caddy 与 docker —— web 期末大作业上云部署","2023-12-27 22:09:00","/2023/12/27/php-and-vuejs-project-deploy-on-caddy",[8,9,10,11,12,13],"PHP","Caddy","Vue.js","Network","Docker","Web",{"type":15,"value":16,"toc":353},"minimark",[17,37,41,52,55,97,106,123,130,201,216,221,224,231,239,242,245,252,278,281,284,295,299,302,308,331,335,342,349],[18,19,20,24,31,34],"blockquote",{},[21,22,23],"p",{},"这学期修了一门叫《用HTML5 和 PHP编写JavaScript，jQuery 和 AJAX脚本》的 web 课（对，听起来很奇怪的名字）。期末大作业是写一个影评系统，前端允许使用框架，后端仅允许使用 php，具体的作业要求如下",[21,25,26],{},[27,28],"img",{"alt":29,"src":30},"作业要求","https://static.031130.xyz/uploads/2024/08/12/658c4c3128ae4.webp",[21,32,33],{},"（源码会在验收结束以后开源）",[21,35,36],{},"大作业写了得要有三个礼拜，工作时长加起来得有 30 个小时，想着验收之前上线一段时间积累一些评论数据，验收的时候也会更加顺利一些，于是就开始尝试在服务器上部署。部署的过程还是比较复杂的，所以写下这篇博客记录一下。",[38,39,40],"h2",{"id":40},"后端部分",[21,42,43,44,51],{},"早前有",[45,46,50],"a",{"href":47,"rel":48},"https://zhul.in/2021/10/21/picuploader-on-archlinux-with-caddy/",[49],"nofollow","《PicUploader使用系列（一）——在Archlinux上使用Caddy部署PicUploader》","的经验，便觉得使用 Caddy + php-fpm 部署的方式多少有点麻烦了，这次便尝试了使用 Docker 部署、Caddy 反代的方式。",[21,53,54],{},"Dockerfile 如下:",[56,57,62],"pre",{"className":58,"code":59,"language":60,"meta":61,"style":61},"language-dockerfile shiki shiki-themes one-light one-dark-pro","FROM php:8-apache\nRUN docker-php-ext-install mysqli\nRUN a2enmod rewrite\nCOPY . /var/www/html\nEXPOSE 80\n","dockerfile","",[63,64,65,73,79,85,91],"code",{"__ignoreMap":61},[66,67,70],"span",{"class":68,"line":69},"line",1,[66,71,72],{},"FROM php:8-apache\n",[66,74,76],{"class":68,"line":75},2,[66,77,78],{},"RUN docker-php-ext-install mysqli\n",[66,80,82],{"class":68,"line":81},3,[66,83,84],{},"RUN a2enmod rewrite\n",[66,86,88],{"class":68,"line":87},4,[66,89,90],{},"COPY . /var/www/html\n",[66,92,94],{"class":68,"line":93},5,[66,95,96],{},"EXPOSE 80\n",[21,98,99,100,105],{},"在后端的根目录下有一个 .htaccess 文件，将所有的请求都交给 index.php 来处理，这样就可以根据我的",[45,101,104],{"href":102,"rel":103},"https://zhul.in/2023/12/12/php-simple-rest-api/",[49],"上一篇博客","中所提到的方式去构建不使用任何 php 框架实现的简易 router 效果",[56,107,111],{"className":108,"code":109,"language":110,"meta":61,"style":61},"language-htaccess shiki shiki-themes one-light one-dark-pro","RewriteEngine On\nRewriteRule ^(.*) index.php [QSA,L]\n","htaccess",[63,112,113,118],{"__ignoreMap":61},[66,114,115],{"class":68,"line":69},[66,116,117],{},"RewriteEngine On\n",[66,119,120],{"class":68,"line":75},[66,121,122],{},"RewriteRule ^(.*) index.php [QSA,L]\n",[21,124,125,126,129],{},"构建 Docker 镜像时使用 ",[63,127,128],{},"docker build . -t mrs-php"," 命令，运行 docker 容器时使用命令",[56,131,135],{"className":132,"code":133,"language":134,"meta":61,"style":61},"language-bash shiki shiki-themes one-light one-dark-pro","docker run -d \\\n    -p 7788:80 \\\n    --name mrs-php \\\n    -v /path/to/uploads:/var/www/html/uploads \\\n    --restart unless-stopped \\\n    mrs-php\n","bash",[63,136,137,155,165,175,185,195],{"__ignoreMap":61},[66,138,139,143,147,151],{"class":68,"line":69},[66,140,142],{"class":141},"sAdtL","docker",[66,144,146],{"class":145},"sDhpE"," run",[66,148,150],{"class":149},"sAGMh"," -d",[66,152,154],{"class":153},"s_Sar"," \\\n",[66,156,157,160,163],{"class":68,"line":75},[66,158,159],{"class":149},"    -p",[66,161,162],{"class":145}," 7788:80",[66,164,154],{"class":153},[66,166,167,170,173],{"class":68,"line":81},[66,168,169],{"class":149},"    --name",[66,171,172],{"class":145}," mrs-php",[66,174,154],{"class":153},[66,176,177,180,183],{"class":68,"line":87},[66,178,179],{"class":149},"    -v",[66,181,182],{"class":145}," /path/to/uploads:/var/www/html/uploads",[66,184,154],{"class":153},[66,186,187,190,193],{"class":68,"line":93},[66,188,189],{"class":149},"    --restart",[66,191,192],{"class":145}," unless-stopped",[66,194,154],{"class":153},[66,196,198],{"class":68,"line":197},6,[66,199,200],{"class":145},"    mrs-php\n",[21,202,203,204,207,208,211,212,215],{},"这样，后端就在 7788 端口上开起来了，后续 Caddy 只要将打到 ",[63,205,206],{},"/api/*"," 和 ",[63,209,210],{},"/uploads/*"," 的请求转发到 7788 端口即可，避免了使用 php-fpm 时需要的配置。",[63,213,214],{},"uploads"," 目录是用来存放图片的，我将这个路径挂在在宿主机的目录下，方便备份导入等操作。",[217,218,220],"h3",{"id":219},"mysql-连接时的小插曲","mysql 连接时的小插曲",[21,222,223],{},"需要注意的是，在 Docker 容器中运行的 php 如果想要访问宿主机上的 mysql，需要注意修改 mysql 服务器的 ip 地址，并允许 mysql 接收来自非本机的请求。",[21,225,226,227,230],{},"在宿主机中运行 ",[63,228,229],{},"ip -br a"," 命令可以看到 docker 所采用的虚拟网卡的 ip 地址",[56,232,237],{"className":233,"code":235,"language":236},[234],"language-text","docker0          UP             172.17.0.1/16 fe80::42:eff:febf:b26c/64\n","text",[63,238,235],{"__ignoreMap":61},[21,240,241],{},"我这边得到的 ip 地址是 172.17.0.1，所以在 php 那边访问的数据库 ip 地址就应该是 172.17.0.1，而非 localhost 或者 127.0.0.1",[21,243,244],{},"此外，需要允许宿主机的 mysql 接收来自 Docker 容器的请求",[21,246,247,248,251],{},"使用 ",[63,249,250],{},"docker network inspect bridge"," 命令可以查到 docker 容器的 ip 地址，接着需要去允许来自这个 ip 的请求。建议去网上自行搜索，因为 mysql 语句我自己也不熟悉。我使用的 mysql 版本是 8，语句似乎和以前的版本不兼容？我使用下面三个命令轮着输就好了（有时候报错，有时侯又不报错），有大佬懂的话评论区讲讲。",[56,253,257],{"className":254,"code":255,"language":256,"meta":61,"style":61},"language-mysql shiki shiki-themes one-light one-dark-pro","use mysql;\nGRANT ALL ON *.* TO 'root'@'%';\nupdate user set host='%' where user='root';\nGRANT ALL ON *.* TO 'root'@'%';\n","mysql",[63,258,259,264,269,274],{"__ignoreMap":61},[66,260,261],{"class":68,"line":69},[66,262,263],{},"use mysql;\n",[66,265,266],{"class":68,"line":75},[66,267,268],{},"GRANT ALL ON *.* TO 'root'@'%';\n",[66,270,271],{"class":68,"line":81},[66,272,273],{},"update user set host='%' where user='root';\n",[66,275,276],{"class":68,"line":87},[66,277,268],{},[38,279,280],{"id":280},"前端部分",[21,282,283],{},"前端部分部署起来没什么难度",[21,285,286,287,290,291,294],{},"我使用的是 vite 开发的 vuejs 项目，直接使用 ",[63,288,289],{},"pnpm build"," 构建出静态文件，然后放入了 ",[63,292,293],{},"/var/www/mrs"," 目录，这部分没什么可说的",[38,296,298],{"id":297},"caddy-配置","Caddy 配置",[21,300,301],{},"Caddy 配置如下",[56,303,306],{"className":304,"code":305,"language":236},[234],"example.com {\n    handle /api/* {\n        reverse_proxy localhost:7788\n    }\n\n    handle /uploads/* {\n        reverse_proxy localhost:7788\n    }\n\n    handle /* {\n        root * /var/www/mrs\n        file_server\n        try_files {path} /\n    }\n}\n",[63,307,305],{"__ignoreMap":61},[21,309,310,311,207,313,315,316,319,320,323,324,327,328,330],{},"将打到 ",[63,312,206],{},[63,314,210],{}," 都交给 7788 端口的后端进行处理，前端部分要使用 ",[63,317,318],{},"try_files"," 将请求都指向 ",[63,321,322],{},"/"," 或 ",[63,325,326],{},"/index.html"," 交由 vue-router 处理，否则 caddy 就找不到对应的文件了。这里我尝试过使用 route 关键词代替 handle，但 ",[63,329,318],{}," 的功能没有生效，这两者的区别官方文档中有提到，但我没看懂，等我以后看看有没有机会去折腾了。",[38,332,334],{"id":333},"参考","参考:",[21,336,337],{},[45,338,341],{"href":339,"rel":340},"https://homeboyc.cn/blog/%E4%BD%BF%E7%94%A8caddy%E9%85%8D%E7%BD%AE%E5%90%8C%E4%B8%80%E5%9F%9F%E5%90%8D%E4%B8%8B%E7%9A%84%E5%89%8D%E5%90%8E%E5%88%86%E7%A6%BB/",[49],"使用Caddy配置同一域名下的前后分离",[21,343,344],{},[45,345,348],{"href":346,"rel":347},"https://blog.lyh543.cn/notes/linux/caddy.html",[49],"Caddy 2",[350,351,352],"style",{},"html .default .shiki span {color: var(--shiki-default);background: var(--shiki-default-bg);font-style: var(--shiki-default-font-style);font-weight: var(--shiki-default-font-weight);text-decoration: var(--shiki-default-text-decoration);}html .shiki span {color: var(--shiki-default);background: var(--shiki-default-bg);font-style: var(--shiki-default-font-style);font-weight: var(--shiki-default-font-weight);text-decoration: var(--shiki-default-text-decoration);}html .dark .shiki span {color: var(--shiki-dark);background: var(--shiki-dark-bg);font-style: var(--shiki-dark-font-style);font-weight: var(--shiki-dark-font-weight);text-decoration: var(--shiki-dark-text-decoration);}html.dark .shiki span {color: var(--shiki-dark);background: var(--shiki-dark-bg);font-style: var(--shiki-dark-font-style);font-weight: var(--shiki-dark-font-weight);text-decoration: var(--shiki-dark-text-decoration);}html pre.shiki code .sAdtL, html code.shiki .sAdtL{--shiki-default:#4078F2;--shiki-dark:#61AFEF}html pre.shiki code .sDhpE, html code.shiki .sDhpE{--shiki-default:#50A14F;--shiki-dark:#98C379}html pre.shiki code .sAGMh, html code.shiki .sAGMh{--shiki-default:#986801;--shiki-dark:#D19A66}html pre.shiki code .s_Sar, html code.shiki .s_Sar{--shiki-default:#0184BC;--shiki-dark:#56B6C2}",{"title":61,"searchDepth":75,"depth":75,"links":354},[355,358,359,360],{"id":40,"depth":75,"text":40,"children":356},[357],{"id":219,"depth":81,"text":220},{"id":280,"depth":75,"text":280},{"id":297,"depth":75,"text":298},{"id":333,"depth":75,"text":334},[362,368],{"title":363,"path":364,"stem":365,"date":366,"lang":367,"children":-1},"结合 Vue.js 与 php 完成的 web 期末大作业，讲讲前后端分离站点开发与部署中可能遇到的 CORS 跨域问题","/2024/01/10/cors-when-using-splited-frontend-and-backend","posts/zh/cors-when-using-splited-frontend-and-backend","2024-01-10 23:55:36","zh-CN",{"title":369,"path":370,"stem":371,"date":372,"lang":367,"children":-1},"【翻译】使用 PHP 构建简单的 REST API","/2023/12/12/php-simple-rest-api","posts/zh/php-simple-rest-api","2023-12-12 13:07:32",null,1765392887161]