[{"data":1,"prerenderedAt":1317},["ShallowReactive",2],{"post-2023-07-31-run-qq-bot-on-phicomm-n1-openwrt-zh":3,"surround-2023-07-31-run-qq-bot-on-phicomm-n1-openwrt-zh":1305,"randomIndex/2023/07/31/run-qq-bot-on-phicomm-n1-openwrt/":67,"language-switch-/2023/07/31/run-qq-bot-on-phicomm-n1-openwrt/-en":1316},{"id":4,"title":5,"body":6,"date":1291,"description":12,"extension":1292,"lang":1293,"meta":1294,"navigation":285,"path":1295,"rawbody":1296,"seo":1297,"stem":1298,"sticky":1299,"tags":1300,"__hash__":1304},"posts/posts/zh/run-qq-bot-on-phicomm-n1-openwrt.md","在运行OpenWRT的N1盒子上部署 QQBot",{"type":7,"value":8,"toc":1282},"minimark",[9,13,18,40,144,159,163,172,198,202,211,215,218,222,225,229,232,235,242,245,1260,1278],[10,11,12],"p",{},"由于学校社团的招新需要，我写了一个依赖于 go-cqhttp 运行的 QQ Bot，并没有实现什么花里胡哨的功能，只是实现了关键词回复和新人入群时的欢迎语。因为没考虑后续维护的问题，代码也写得比较草，但毕竟是能跑。这么一个小型的程序并不会占用的多少的服务器资源，单独为这么一个 Bot 去开一台国内的 vps 似乎是有些大材小用了，刚好我手上有一台运行在 OpenWRT 上的 Phicomm N1 盒子，反正也是 Linux 系统，便打算拿来挂 QQ Bot。",[14,15,17],"h2",{"id":16},"安装-jdk","安装 JDK",[10,19,20,21,28,29,33,34,39],{},"由于腾讯近几个月对于 Bot 风控非常严格，所以不得不采用 SignServer 项目 ",[22,23,27],"a",{"href":24,"rel":25},"https://github.com/fuqiuluo/unidbg-fetch-qsign",[26],"nofollow","fuqiuluo/unidbg-fetch-qsign"," 来确保 Bot 账号不会被风控一次保证 Bot 运行的稳定性。而这个项目又是使用 Java 开发的，因此需要先安装 JDK/JRE。但 OpenWRT 的开发者可能并没有考虑到在路由器设备上运行 Java 程序的需求，因此 OpenWRT 的源里面是没有预先打包 JDK 的，因此我们需要额外安装。我直接 google 搜索了 ",[30,31,32],"code",{},"install java on openwrt"," 的关键词，在 Github 找到了这个脚本: ",[22,35,38],{"href":36,"rel":37},"https://gist.github.com/simonswine/64773a80e748f36615e3251234f29d1d%E3%80%82%E4%BD%86%E5%BE%88%E9%81%97%E6%86%BE%EF%BC%8C%E4%BB%A3%E7%A0%81%E8%B7%91%E4%B8%8D%E8%B5%B7%E6%9D%A5%EF%BC%8C%E4%B8%8B%E8%BD%BD%E6%97%B6%E6%8F%90%E7%A4%BA",[26],"https://gist.github.com/simonswine/64773a80e748f36615e3251234f29d1d。但很遗憾，代码跑不起来，下载时提示"," 404。于是我打开脚本细细一看，脚本中 jdk 的版本号和设备的架构均需要改动。具体改动如下:",[41,42,47],"pre",{"className":43,"code":44,"language":45,"meta":46,"style":46},"language-diff shiki shiki-themes one-light one-dark-pro","- REVISION=8.212.04-r0\n+ REVISION=8.302.08-r1\n# 版本号请自行去仓库内翻最新的\n......\n- URL=http://dl-cdn.alpinelinux.org/alpine/v3.10/community/armv7/\n+ URL=http://dl-cdn.alpinelinux.org/alpine/v3.14/community/aarch64/\n......\n- # verify packages\n- sha256sum -c \u003C\u003CEOF\n- e2fce9ee7348e9322c542206c3c3949e40690716d65e9f0e44dbbfca95d59d8c  openjdk8-8.212.04-r0.apk\n- 26ad786ff1ebeeb7cd24abee10bc56211a026a2d871cf161bb309563e1fcbabc  openjdk8-jre-8.212.04-r0.apk\n- 947d5f72ed2dc367c97d1429158913c9366f9c6ae01b7311dd8546b10ded8743  openjdk8-jre-base-- 8.212.04-r0.apk\n- c6a65402bf0a7051c60b45e1c6a8f4277a68a8b7e807078f20db17e0233dea8e  openjdk8-jre-lib-8.212.04-r0.apk\n- EOF\n# 我这里直接将 sha256 校验给删除了，有兴趣可以自己去更新这几个文件的文件名和其对应的哈希值\n","diff","",[30,48,49,58,65,72,79,85,91,96,102,108,114,120,126,132,138],{"__ignoreMap":46},[50,51,54],"span",{"class":52,"line":53},"line",1,[50,55,57],{"class":56},"sJa8x","- REVISION=8.212.04-r0\n",[50,59,61],{"class":52,"line":60},2,[50,62,64],{"class":63},"sDhpE","+ REVISION=8.302.08-r1\n",[50,66,68],{"class":52,"line":67},3,[50,69,71],{"class":70},"sW2Sy","# 版本号请自行去仓库内翻最新的\n",[50,73,75],{"class":52,"line":74},4,[50,76,78],{"class":77},"s5ixo","......\n",[50,80,82],{"class":52,"line":81},5,[50,83,84],{"class":56},"- URL=http://dl-cdn.alpinelinux.org/alpine/v3.10/community/armv7/\n",[50,86,88],{"class":52,"line":87},6,[50,89,90],{"class":63},"+ URL=http://dl-cdn.alpinelinux.org/alpine/v3.14/community/aarch64/\n",[50,92,94],{"class":52,"line":93},7,[50,95,78],{"class":77},[50,97,99],{"class":52,"line":98},8,[50,100,101],{"class":56},"- # verify packages\n",[50,103,105],{"class":52,"line":104},9,[50,106,107],{"class":56},"- sha256sum -c \u003C\u003CEOF\n",[50,109,111],{"class":52,"line":110},10,[50,112,113],{"class":56},"- e2fce9ee7348e9322c542206c3c3949e40690716d65e9f0e44dbbfca95d59d8c  openjdk8-8.212.04-r0.apk\n",[50,115,117],{"class":52,"line":116},11,[50,118,119],{"class":56},"- 26ad786ff1ebeeb7cd24abee10bc56211a026a2d871cf161bb309563e1fcbabc  openjdk8-jre-8.212.04-r0.apk\n",[50,121,123],{"class":52,"line":122},12,[50,124,125],{"class":56},"- 947d5f72ed2dc367c97d1429158913c9366f9c6ae01b7311dd8546b10ded8743  openjdk8-jre-base-- 8.212.04-r0.apk\n",[50,127,129],{"class":52,"line":128},13,[50,130,131],{"class":56},"- c6a65402bf0a7051c60b45e1c6a8f4277a68a8b7e807078f20db17e0233dea8e  openjdk8-jre-lib-8.212.04-r0.apk\n",[50,133,135],{"class":52,"line":134},14,[50,136,137],{"class":56},"- EOF\n",[50,139,141],{"class":52,"line":140},15,[50,142,143],{"class":70},"# 我这里直接将 sha256 校验给删除了，有兴趣可以自己去更新这几个文件的文件名和其对应的哈希值\n",[10,145,146,147,150,151,154,155,158],{},"随后 ",[30,148,149],{},"chmod +x"," 授予脚本可执行权限后直接执行，我们就将 alpine linux 上的 openjdk 成功解包并安装到了我们的 OpenWRT 中，我们只需要配置好环境变量即可完成安装。但我又比较懒，我看见 SignServer 的启动脚本里是可以通过读取 ",[30,152,153],{},"$JAVA_HOME"," 来获取 Java 二进制可执行文件的代码逻辑，于是我便在每次启动 SignServer 脚本前提前执行 ",[30,156,157],{},"export JAVA_HOME=/opt/java-1.8-openjdk"," 即可。",[14,160,162],{"id":161},"安装-screen","安装 screen",[10,164,165,166,171],{},"相比起前面 JDK 的安装，这一步 screen 的安装反而没有那么麻烦，",[22,167,170],{"href":168,"rel":169},"https://openwrt.org/packages/pkgdata/screen",[26],"在最新版本的 OpenWRT 源中，screen 已经被包括进去了","，我们直接把 OpenWRT 换好源，从源里就可以安装。",[41,173,177],{"className":174,"code":175,"language":176,"meta":46,"style":46},"language-bash shiki shiki-themes one-light one-dark-pro","opkg update\nopkg install screen\n","bash",[30,178,179,188],{"__ignoreMap":46},[50,180,181,185],{"class":52,"line":53},[50,182,184],{"class":183},"sAdtL","opkg",[50,186,187],{"class":63}," update\n",[50,189,190,192,195],{"class":52,"line":60},[50,191,184],{"class":183},[50,193,194],{"class":63}," install",[50,196,197],{"class":63}," screen\n",[14,199,201],{"id":200},"下载-fixed-版本的-go-cqhttp","下载 fixed 版本的 go-cqhttp",[10,203,204,205,210],{},"由于 SignServer 更新，在其请求中多添加了 key 的参数要求，导致原版 go-cqhttp 的最新 release 中释出的二进制文件无法适配最新版的 SignServer，我暂时选用了一个",[22,206,209],{"href":207,"rel":208},"https://github.com/tomato-aoarasi/go-cqhttp-1.1.0-sign-fixed/",[26],"修复了这个问题的 fork"," 去运行 Bot。下载到 OpenWRT 后记得也要授予可执行文件。",[14,212,214],{"id":213},"安装-python-脚本中所需要使用到的库","安装 Python 脚本中所需要使用到的库",[10,216,217],{},"OpenWRT 自带了 python 和 pip，这让我很欣慰。直接使用 pip 安装 flask 和 xlrd 等库即可，完全没有难度。",[14,219,221],{"id":220},"运行-signserver","运行 SignServer",[10,223,224],{},"这一步很简单，将原项目的 Release 下载下来解压后上传到 OpenWRT 的某个路径后，开个 screen 窗口，设置好 JAVA_HOME 变量后再去调用 SignServer 中自带的 shell 脚本即可",[14,226,228],{"id":227},"运行-go-cqhttp","运行 go-cqhttp",[10,230,231],{},"这一步也很简单，得益于 go 静态链接的特性，我们不需要为 go-cqhttp 安装任何额外的依赖就可以执行 Release 中的二进制文件，直接将我们在 PC 上登录好的 session、配置好的 device.json、config.yml 等文件上传到 N1 ，开个 screen 窗口运行即可。",[14,233,234],{"id":234},"运行主程序",[10,236,237,238,241],{},"这个没什么好讲的，同样是开个 screen 窗口运行 ",[30,239,240],{},"python main.py"," 的事情",[10,243,244],{},"python 代码如下:",[41,246,250],{"className":247,"code":248,"language":249,"meta":46,"style":46},"language-python shiki shiki-themes one-light one-dark-pro","from flask import Flask,request\nimport requests\nimport xlrd\n\n# 读取 xls 中的关键词以及回应语句，将其加载到 dict 数据结构中\n_data2 = xlrd.open_workbook('/root/8yue222.xls')\nmain_table2 = _data2.sheets()[0]\nkey_lst2 = main_table2.col_values(0)[1:]\nvalue_lst2 = main_table2.col_values(1)[1:]\nfinal_dict = dict(zip(key_lst2,value_lst2))\n# 读取第二份 xls，并对相同的关键词做覆盖\n_data = xlrd.open_workbook('/root/daihao.xls')\nmain_table = _data.sheets()[0]\nkey_lst = main_table.col_values(4)[1:]\nkey_lst = [str(int(item)) if type(item) == float else item for item in key_lst if item != '']\nkey_lst.remove('Gary')\nvalue_lst = main_table.col_values(5)[1:]\nvalue_lst = [str(int(item)) if type(item) == float else item for item in value_lst if item != '']\nfinal_dict.update(dict(zip(key_lst,value_lst)))\n\napp = Flask(__name__)\nclass API:\n        @staticmethod\n        def send(message):\n                url = \"http://127.0.0.1:5700/send_msg\"\n                data = request.get_json()\n                params = {\n                        \"group_id\":data['group_id'],\n                        \"message\":message\n                }\n                requests.get(url,params=params)\n\n@app.route('/', methods=[\"POST\"])\ndef post_data():\n    data = request.get_json()\n    print(data)\n    if data['post_type'] == 'message':\n        message = data['message']\n        messagex()\n    elif data['post_type'] == 'notice' and data['notice_type'] == 'group_increase':\n        welcome()\n    else:\n        print(\"忽略消息\")\n\n    return \"OK\"\n\ndef messagex():\n        data = request.get_json()\n        message = data['message'].replace('％','%')\n        for key in final_dict.keys():\n                if key == message:\n                        API.send(final_dict[key])\n                        break\n\ndef welcome():\n        data = request.get_json()\n        group_id = data['group_id']\n        user_id = data['user_id']\n        API.send(\"[CQ:at,qq={}] 欢迎来到浙江工业大学，精弘网络欢迎各位的到来！如果想进一步了解我们，请戳精弘首页：www.jh.zjut.edu.cn\\n输入 菜单 获取精小弘机器人的菜单 哦！\\n请及时修改群名片\\n格式如下：姓名+专业/大类\".format(user_id))\n\nif __name__ == '__main__':\n    app.run(host='0.0.0.0', port=5701)\n","python",[30,251,252,267,274,281,287,292,317,340,366,387,406,411,429,447,470,534,550,573,623,644,649,667,680,689,707,718,735,746,761,770,776,797,802,837,849,863,872,894,909,917,951,959,967,980,985,994,999,1009,1023,1052,1071,1084,1099,1105,1110,1120,1133,1147,1162,1207,1212,1228],{"__ignoreMap":46},[50,253,254,258,261,264],{"class":52,"line":53},[50,255,257],{"class":256},"sLKXg","from",[50,259,260],{"class":77}," flask ",[50,262,263],{"class":256},"import",[50,265,266],{"class":77}," Flask,request\n",[50,268,269,271],{"class":52,"line":60},[50,270,263],{"class":256},[50,272,273],{"class":77}," requests\n",[50,275,276,278],{"class":52,"line":67},[50,277,263],{"class":256},[50,279,280],{"class":77}," xlrd\n",[50,282,283],{"class":52,"line":74},[50,284,286],{"emptyLinePlaceholder":285},true,"\n",[50,288,289],{"class":52,"line":81},[50,290,291],{"class":70},"# 读取 xls 中的关键词以及回应语句，将其加载到 dict 数据结构中\n",[50,293,294,297,301,304,308,311,314],{"class":52,"line":87},[50,295,296],{"class":77},"_data2 ",[50,298,300],{"class":299},"sknuh","=",[50,302,303],{"class":77}," xlrd.",[50,305,307],{"class":306},"slOjB","open_workbook",[50,309,310],{"class":77},"(",[50,312,313],{"class":63},"'/root/8yue222.xls'",[50,315,316],{"class":77},")\n",[50,318,319,322,324,327,330,333,337],{"class":52,"line":93},[50,320,321],{"class":77},"main_table2 ",[50,323,300],{"class":299},[50,325,326],{"class":77}," _data2.",[50,328,329],{"class":306},"sheets",[50,331,332],{"class":77},"()[",[50,334,336],{"class":335},"sAGMh","0",[50,338,339],{"class":77},"]\n",[50,341,342,345,347,350,353,355,357,360,363],{"class":52,"line":98},[50,343,344],{"class":77},"key_lst2 ",[50,346,300],{"class":299},[50,348,349],{"class":77}," main_table2.",[50,351,352],{"class":306},"col_values",[50,354,310],{"class":77},[50,356,336],{"class":335},[50,358,359],{"class":77},")[",[50,361,362],{"class":335},"1",[50,364,365],{"class":77},":]\n",[50,367,368,371,373,375,377,379,381,383,385],{"class":52,"line":104},[50,369,370],{"class":77},"value_lst2 ",[50,372,300],{"class":299},[50,374,349],{"class":77},[50,376,352],{"class":306},[50,378,310],{"class":77},[50,380,362],{"class":335},[50,382,359],{"class":77},[50,384,362],{"class":335},[50,386,365],{"class":77},[50,388,389,392,394,398,400,403],{"class":52,"line":110},[50,390,391],{"class":77},"final_dict ",[50,393,300],{"class":299},[50,395,397],{"class":396},"s_Sar"," dict",[50,399,310],{"class":77},[50,401,402],{"class":396},"zip",[50,404,405],{"class":77},"(key_lst2,value_lst2))\n",[50,407,408],{"class":52,"line":116},[50,409,410],{"class":70},"# 读取第二份 xls，并对相同的关键词做覆盖\n",[50,412,413,416,418,420,422,424,427],{"class":52,"line":122},[50,414,415],{"class":77},"_data ",[50,417,300],{"class":299},[50,419,303],{"class":77},[50,421,307],{"class":306},[50,423,310],{"class":77},[50,425,426],{"class":63},"'/root/daihao.xls'",[50,428,316],{"class":77},[50,430,431,434,436,439,441,443,445],{"class":52,"line":128},[50,432,433],{"class":77},"main_table ",[50,435,300],{"class":299},[50,437,438],{"class":77}," _data.",[50,440,329],{"class":306},[50,442,332],{"class":77},[50,444,336],{"class":335},[50,446,339],{"class":77},[50,448,449,452,454,457,459,461,464,466,468],{"class":52,"line":134},[50,450,451],{"class":77},"key_lst ",[50,453,300],{"class":299},[50,455,456],{"class":77}," main_table.",[50,458,352],{"class":306},[50,460,310],{"class":77},[50,462,463],{"class":335},"4",[50,465,359],{"class":77},[50,467,362],{"class":335},[50,469,365],{"class":77},[50,471,472,474,476,479,482,484,487,490,493,496,499,502,505,508,511,514,516,519,522,524,526,529,532],{"class":52,"line":140},[50,473,451],{"class":77},[50,475,300],{"class":299},[50,477,478],{"class":77}," [",[50,480,481],{"class":396},"str",[50,483,310],{"class":77},[50,485,486],{"class":396},"int",[50,488,489],{"class":77},"(item)) ",[50,491,492],{"class":256},"if",[50,494,495],{"class":396}," type",[50,497,498],{"class":77},"(item) ",[50,500,501],{"class":299},"==",[50,503,504],{"class":396}," float",[50,506,507],{"class":256}," else",[50,509,510],{"class":77}," item ",[50,512,513],{"class":256},"for",[50,515,510],{"class":77},[50,517,518],{"class":256},"in",[50,520,521],{"class":77}," key_lst ",[50,523,492],{"class":256},[50,525,510],{"class":77},[50,527,528],{"class":299},"!=",[50,530,531],{"class":63}," ''",[50,533,339],{"class":77},[50,535,537,540,543,545,548],{"class":52,"line":536},16,[50,538,539],{"class":77},"key_lst.",[50,541,542],{"class":306},"remove",[50,544,310],{"class":77},[50,546,547],{"class":63},"'Gary'",[50,549,316],{"class":77},[50,551,553,556,558,560,562,564,567,569,571],{"class":52,"line":552},17,[50,554,555],{"class":77},"value_lst ",[50,557,300],{"class":299},[50,559,456],{"class":77},[50,561,352],{"class":306},[50,563,310],{"class":77},[50,565,566],{"class":335},"5",[50,568,359],{"class":77},[50,570,362],{"class":335},[50,572,365],{"class":77},[50,574,576,578,580,582,584,586,588,590,592,594,596,598,600,602,604,606,608,610,613,615,617,619,621],{"class":52,"line":575},18,[50,577,555],{"class":77},[50,579,300],{"class":299},[50,581,478],{"class":77},[50,583,481],{"class":396},[50,585,310],{"class":77},[50,587,486],{"class":396},[50,589,489],{"class":77},[50,591,492],{"class":256},[50,593,495],{"class":396},[50,595,498],{"class":77},[50,597,501],{"class":299},[50,599,504],{"class":396},[50,601,507],{"class":256},[50,603,510],{"class":77},[50,605,513],{"class":256},[50,607,510],{"class":77},[50,609,518],{"class":256},[50,611,612],{"class":77}," value_lst ",[50,614,492],{"class":256},[50,616,510],{"class":77},[50,618,528],{"class":299},[50,620,531],{"class":63},[50,622,339],{"class":77},[50,624,626,629,632,634,637,639,641],{"class":52,"line":625},19,[50,627,628],{"class":77},"final_dict.",[50,630,631],{"class":306},"update",[50,633,310],{"class":77},[50,635,636],{"class":396},"dict",[50,638,310],{"class":77},[50,640,402],{"class":396},[50,642,643],{"class":77},"(key_lst,value_lst)))\n",[50,645,647],{"class":52,"line":646},20,[50,648,286],{"emptyLinePlaceholder":285},[50,650,652,655,657,660,662,665],{"class":52,"line":651},21,[50,653,654],{"class":77},"app ",[50,656,300],{"class":299},[50,658,659],{"class":306}," Flask",[50,661,310],{"class":77},[50,663,664],{"class":56},"__name__",[50,666,316],{"class":77},[50,668,670,673,677],{"class":52,"line":669},22,[50,671,672],{"class":256},"class",[50,674,676],{"class":675},"sC09Y"," API",[50,678,679],{"class":77},":\n",[50,681,683,686],{"class":52,"line":682},23,[50,684,685],{"class":183},"        @",[50,687,688],{"class":396},"staticmethod\n",[50,690,692,695,698,700,704],{"class":52,"line":691},24,[50,693,694],{"class":256},"        def",[50,696,697],{"class":183}," send",[50,699,310],{"class":77},[50,701,703],{"class":702},"so_Uh","message",[50,705,706],{"class":77},"):\n",[50,708,710,713,715],{"class":52,"line":709},25,[50,711,712],{"class":77},"                url ",[50,714,300],{"class":299},[50,716,717],{"class":63}," \"http://127.0.0.1:5700/send_msg\"\n",[50,719,721,724,726,729,732],{"class":52,"line":720},26,[50,722,723],{"class":77},"                data ",[50,725,300],{"class":299},[50,727,728],{"class":77}," request.",[50,730,731],{"class":306},"get_json",[50,733,734],{"class":77},"()\n",[50,736,738,741,743],{"class":52,"line":737},27,[50,739,740],{"class":77},"                params ",[50,742,300],{"class":299},[50,744,745],{"class":77}," {\n",[50,747,749,752,755,758],{"class":52,"line":748},28,[50,750,751],{"class":63},"                        \"group_id\"",[50,753,754],{"class":77},":data[",[50,756,757],{"class":63},"'group_id'",[50,759,760],{"class":77},"],\n",[50,762,764,767],{"class":52,"line":763},29,[50,765,766],{"class":63},"                        \"message\"",[50,768,769],{"class":77},":message\n",[50,771,773],{"class":52,"line":772},30,[50,774,775],{"class":77},"                }\n",[50,777,779,782,785,788,792,794],{"class":52,"line":778},31,[50,780,781],{"class":77},"                requests.",[50,783,784],{"class":306},"get",[50,786,787],{"class":77},"(url,",[50,789,791],{"class":790},"sp7wS","params",[50,793,300],{"class":299},[50,795,796],{"class":77},"params)\n",[50,798,800],{"class":52,"line":799},32,[50,801,286],{"emptyLinePlaceholder":285},[50,803,805,808,812,815,817,820,823,826,828,831,834],{"class":52,"line":804},33,[50,806,807],{"class":183},"@app",[50,809,811],{"class":810},"siaei",".",[50,813,814],{"class":183},"route",[50,816,310],{"class":77},[50,818,819],{"class":63},"'/'",[50,821,822],{"class":77},",",[50,824,825],{"class":790}," methods",[50,827,300],{"class":299},[50,829,830],{"class":77},"[",[50,832,833],{"class":63},"\"POST\"",[50,835,836],{"class":77},"])\n",[50,838,840,843,846],{"class":52,"line":839},34,[50,841,842],{"class":256},"def",[50,844,845],{"class":183}," post_data",[50,847,848],{"class":77},"():\n",[50,850,852,855,857,859,861],{"class":52,"line":851},35,[50,853,854],{"class":77},"    data ",[50,856,300],{"class":299},[50,858,728],{"class":77},[50,860,731],{"class":306},[50,862,734],{"class":77},[50,864,866,869],{"class":52,"line":865},36,[50,867,868],{"class":396},"    print",[50,870,871],{"class":77},"(data)\n",[50,873,875,878,881,884,887,889,892],{"class":52,"line":874},37,[50,876,877],{"class":256},"    if",[50,879,880],{"class":77}," data[",[50,882,883],{"class":63},"'post_type'",[50,885,886],{"class":77},"] ",[50,888,501],{"class":299},[50,890,891],{"class":63}," 'message'",[50,893,679],{"class":77},[50,895,897,900,902,904,907],{"class":52,"line":896},38,[50,898,899],{"class":77},"        message ",[50,901,300],{"class":299},[50,903,880],{"class":77},[50,905,906],{"class":63},"'message'",[50,908,339],{"class":77},[50,910,912,915],{"class":52,"line":911},39,[50,913,914],{"class":306},"        messagex",[50,916,734],{"class":77},[50,918,920,923,925,927,929,931,934,937,939,942,944,946,949],{"class":52,"line":919},40,[50,921,922],{"class":256},"    elif",[50,924,880],{"class":77},[50,926,883],{"class":63},[50,928,886],{"class":77},[50,930,501],{"class":299},[50,932,933],{"class":63}," 'notice'",[50,935,936],{"class":256}," and",[50,938,880],{"class":77},[50,940,941],{"class":63},"'notice_type'",[50,943,886],{"class":77},[50,945,501],{"class":299},[50,947,948],{"class":63}," 'group_increase'",[50,950,679],{"class":77},[50,952,954,957],{"class":52,"line":953},41,[50,955,956],{"class":306},"        welcome",[50,958,734],{"class":77},[50,960,962,965],{"class":52,"line":961},42,[50,963,964],{"class":256},"    else",[50,966,679],{"class":77},[50,968,970,973,975,978],{"class":52,"line":969},43,[50,971,972],{"class":396},"        print",[50,974,310],{"class":77},[50,976,977],{"class":63},"\"忽略消息\"",[50,979,316],{"class":77},[50,981,983],{"class":52,"line":982},44,[50,984,286],{"emptyLinePlaceholder":285},[50,986,988,991],{"class":52,"line":987},45,[50,989,990],{"class":256},"    return",[50,992,993],{"class":63}," \"OK\"\n",[50,995,997],{"class":52,"line":996},46,[50,998,286],{"emptyLinePlaceholder":285},[50,1000,1002,1004,1007],{"class":52,"line":1001},47,[50,1003,842],{"class":256},[50,1005,1006],{"class":183}," messagex",[50,1008,848],{"class":77},[50,1010,1012,1015,1017,1019,1021],{"class":52,"line":1011},48,[50,1013,1014],{"class":77},"        data ",[50,1016,300],{"class":299},[50,1018,728],{"class":77},[50,1020,731],{"class":306},[50,1022,734],{"class":77},[50,1024,1026,1028,1030,1032,1034,1037,1040,1042,1045,1047,1050],{"class":52,"line":1025},49,[50,1027,899],{"class":77},[50,1029,300],{"class":299},[50,1031,880],{"class":77},[50,1033,906],{"class":63},[50,1035,1036],{"class":77},"].",[50,1038,1039],{"class":306},"replace",[50,1041,310],{"class":77},[50,1043,1044],{"class":63},"'％'",[50,1046,822],{"class":77},[50,1048,1049],{"class":63},"'%'",[50,1051,316],{"class":77},[50,1053,1055,1058,1061,1063,1066,1069],{"class":52,"line":1054},50,[50,1056,1057],{"class":256},"        for",[50,1059,1060],{"class":77}," key ",[50,1062,518],{"class":256},[50,1064,1065],{"class":77}," final_dict.",[50,1067,1068],{"class":306},"keys",[50,1070,848],{"class":77},[50,1072,1074,1077,1079,1081],{"class":52,"line":1073},51,[50,1075,1076],{"class":256},"                if",[50,1078,1060],{"class":77},[50,1080,501],{"class":299},[50,1082,1083],{"class":77}," message:\n",[50,1085,1087,1091,1093,1096],{"class":52,"line":1086},52,[50,1088,1090],{"class":1089},"sYebD","                        API",[50,1092,811],{"class":77},[50,1094,1095],{"class":306},"send",[50,1097,1098],{"class":77},"(final_dict[key])\n",[50,1100,1102],{"class":52,"line":1101},53,[50,1103,1104],{"class":256},"                        break\n",[50,1106,1108],{"class":52,"line":1107},54,[50,1109,286],{"emptyLinePlaceholder":285},[50,1111,1113,1115,1118],{"class":52,"line":1112},55,[50,1114,842],{"class":256},[50,1116,1117],{"class":183}," welcome",[50,1119,848],{"class":77},[50,1121,1123,1125,1127,1129,1131],{"class":52,"line":1122},56,[50,1124,1014],{"class":77},[50,1126,300],{"class":299},[50,1128,728],{"class":77},[50,1130,731],{"class":306},[50,1132,734],{"class":77},[50,1134,1136,1139,1141,1143,1145],{"class":52,"line":1135},57,[50,1137,1138],{"class":77},"        group_id ",[50,1140,300],{"class":299},[50,1142,880],{"class":77},[50,1144,757],{"class":63},[50,1146,339],{"class":77},[50,1148,1150,1153,1155,1157,1160],{"class":52,"line":1149},58,[50,1151,1152],{"class":77},"        user_id ",[50,1154,300],{"class":299},[50,1156,880],{"class":77},[50,1158,1159],{"class":63},"'user_id'",[50,1161,339],{"class":77},[50,1163,1165,1168,1170,1172,1174,1177,1180,1183,1186,1189,1191,1194,1196,1199,1201,1204],{"class":52,"line":1164},59,[50,1166,1167],{"class":1089},"        API",[50,1169,811],{"class":77},[50,1171,1095],{"class":306},[50,1173,310],{"class":77},[50,1175,1176],{"class":63},"\"[CQ:at,qq=",[50,1178,1179],{"class":335},"{}",[50,1181,1182],{"class":63},"] 欢迎来到浙江工业大学，精弘网络欢迎各位的到来！如果想进一步了解我们，请戳精弘首页：www.jh.zjut.edu.cn",[50,1184,1185],{"class":396},"\\n",[50,1187,1188],{"class":63},"输入 菜单 获取精小弘机器人的菜单 哦！",[50,1190,1185],{"class":396},[50,1192,1193],{"class":63},"请及时修改群名片",[50,1195,1185],{"class":396},[50,1197,1198],{"class":63},"格式如下：姓名+专业/大类\"",[50,1200,811],{"class":77},[50,1202,1203],{"class":306},"format",[50,1205,1206],{"class":77},"(user_id))\n",[50,1208,1210],{"class":52,"line":1209},60,[50,1211,286],{"emptyLinePlaceholder":285},[50,1213,1215,1217,1220,1223,1226],{"class":52,"line":1214},61,[50,1216,492],{"class":256},[50,1218,1219],{"class":56}," __name__",[50,1221,1222],{"class":299}," ==",[50,1224,1225],{"class":63}," '__main__'",[50,1227,679],{"class":77},[50,1229,1231,1234,1237,1239,1242,1244,1247,1250,1253,1255,1258],{"class":52,"line":1230},62,[50,1232,1233],{"class":77},"    app.",[50,1235,1236],{"class":306},"run",[50,1238,310],{"class":77},[50,1240,1241],{"class":790},"host",[50,1243,300],{"class":299},[50,1245,1246],{"class":63},"'0.0.0.0'",[50,1248,1249],{"class":77},", ",[50,1251,1252],{"class":790},"port",[50,1254,300],{"class":299},[50,1256,1257],{"class":335},"5701",[50,1259,316],{"class":77},[1261,1262,1263,1266,1272],"blockquote",{},[10,1264,1265],{},"参考资料:",[10,1267,1268],{},[22,1269,1270],{"href":1270,"rel":1271},"https://gist.github.com/simonswine/64773a80e748f36615e3251234f29d1d",[26],[10,1273,1274],{},[22,1275,1276],{"href":1276,"rel":1277},"https://blog.csdn.net/qq_64126275/article/details/128586651",[26],[1279,1280,1281],"style",{},"html pre.shiki code .sJa8x, html code.shiki .sJa8x{--shiki-default:#E45649;--shiki-dark:#E06C75}html pre.shiki code .sDhpE, html code.shiki .sDhpE{--shiki-default:#50A14F;--shiki-dark:#98C379}html pre.shiki code .sW2Sy, html code.shiki .sW2Sy{--shiki-default:#A0A1A7;--shiki-default-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic}html pre.shiki code .s5ixo, html code.shiki .s5ixo{--shiki-default:#383A42;--shiki-dark:#ABB2BF}html .default .shiki span {color: var(--shiki-default);background: var(--shiki-default-bg);font-style: var(--shiki-default-font-style);font-weight: var(--shiki-default-font-weight);text-decoration: var(--shiki-default-text-decoration);}html .shiki span {color: var(--shiki-default);background: var(--shiki-default-bg);font-style: var(--shiki-default-font-style);font-weight: var(--shiki-default-font-weight);text-decoration: var(--shiki-default-text-decoration);}html .dark .shiki span {color: var(--shiki-dark);background: var(--shiki-dark-bg);font-style: var(--shiki-dark-font-style);font-weight: var(--shiki-dark-font-weight);text-decoration: var(--shiki-dark-text-decoration);}html.dark .shiki span {color: var(--shiki-dark);background: var(--shiki-dark-bg);font-style: var(--shiki-dark-font-style);font-weight: var(--shiki-dark-font-weight);text-decoration: var(--shiki-dark-text-decoration);}html pre.shiki code .sAdtL, html code.shiki .sAdtL{--shiki-default:#4078F2;--shiki-dark:#61AFEF}html pre.shiki code .sLKXg, html code.shiki .sLKXg{--shiki-default:#A626A4;--shiki-dark:#C678DD}html pre.shiki code .sknuh, html code.shiki .sknuh{--shiki-default:#383A42;--shiki-dark:#56B6C2}html pre.shiki code .slOjB, html code.shiki .slOjB{--shiki-default:#383A42;--shiki-dark:#61AFEF}html pre.shiki code .sAGMh, html code.shiki .sAGMh{--shiki-default:#986801;--shiki-dark:#D19A66}html pre.shiki code .s_Sar, html code.shiki .s_Sar{--shiki-default:#0184BC;--shiki-dark:#56B6C2}html pre.shiki code .sC09Y, html code.shiki .sC09Y{--shiki-default:#C18401;--shiki-dark:#E5C07B}html pre.shiki code .so_Uh, html code.shiki .so_Uh{--shiki-default:#986801;--shiki-default-font-style:inherit;--shiki-dark:#D19A66;--shiki-dark-font-style:italic}html pre.shiki code .sp7wS, html code.shiki .sp7wS{--shiki-default:#986801;--shiki-default-font-style:inherit;--shiki-dark:#E06C75;--shiki-dark-font-style:italic}html pre.shiki code .siaei, html code.shiki .siaei{--shiki-default:#4078F2;--shiki-dark:#ABB2BF}html pre.shiki code .sYebD, html code.shiki .sYebD{--shiki-default:#383A42;--shiki-dark:#D19A66}",{"title":46,"searchDepth":60,"depth":60,"links":1283},[1284,1285,1286,1287,1288,1289,1290],{"id":16,"depth":60,"text":17},{"id":161,"depth":60,"text":162},{"id":200,"depth":60,"text":201},{"id":213,"depth":60,"text":214},{"id":220,"depth":60,"text":221},{"id":227,"depth":60,"text":228},{"id":234,"depth":60,"text":234},"2023-07-31 04:11:31","md","zh-CN",{},"/2023/07/31/run-qq-bot-on-phicomm-n1-openwrt","---\ntitle: 在运行OpenWRT的N1盒子上部署 QQBot\ndate: 2023-07-31 04:11:31\nsticky:\ntags:\n- Linux\n- Network\n- Bot\n---\n\n由于学校社团的招新需要，我写了一个依赖于 go-cqhttp 运行的 QQ Bot，并没有实现什么花里胡哨的功能，只是实现了关键词回复和新人入群时的欢迎语。因为没考虑后续维护的问题，代码也写得比较草，但毕竟是能跑。这么一个小型的程序并不会占用的多少的服务器资源，单独为这么一个 Bot 去开一台国内的 vps 似乎是有些大材小用了，刚好我手上有一台运行在 OpenWRT 上的 Phicomm N1 盒子，反正也是 Linux 系统，便打算拿来挂 QQ Bot。\n\n## 安装 JDK\n\n由于腾讯近几个月对于 Bot 风控非常严格，所以不得不采用 SignServer 项目 [fuqiuluo/unidbg-fetch-qsign](https://github.com/fuqiuluo/unidbg-fetch-qsign) 来确保 Bot 账号不会被风控一次保证 Bot 运行的稳定性。而这个项目又是使用 Java 开发的，因此需要先安装 JDK/JRE。但 OpenWRT 的开发者可能并没有考虑到在路由器设备上运行 Java 程序的需求，因此 OpenWRT 的源里面是没有预先打包 JDK 的，因此我们需要额外安装。我直接 google 搜索了 `install java on openwrt` 的关键词，在 Github 找到了这个脚本: https://gist.github.com/simonswine/64773a80e748f36615e3251234f29d1d。但很遗憾，代码跑不起来，下载时提示 404。于是我打开脚本细细一看，脚本中 jdk 的版本号和设备的架构均需要改动。具体改动如下:\n\n```diff\n- REVISION=8.212.04-r0\n+ REVISION=8.302.08-r1\n# 版本号请自行去仓库内翻最新的\n......\n- URL=http://dl-cdn.alpinelinux.org/alpine/v3.10/community/armv7/\n+ URL=http://dl-cdn.alpinelinux.org/alpine/v3.14/community/aarch64/\n......\n- # verify packages\n- sha256sum -c \u003C\u003CEOF\n- e2fce9ee7348e9322c542206c3c3949e40690716d65e9f0e44dbbfca95d59d8c  openjdk8-8.212.04-r0.apk\n- 26ad786ff1ebeeb7cd24abee10bc56211a026a2d871cf161bb309563e1fcbabc  openjdk8-jre-8.212.04-r0.apk\n- 947d5f72ed2dc367c97d1429158913c9366f9c6ae01b7311dd8546b10ded8743  openjdk8-jre-base-- 8.212.04-r0.apk\n- c6a65402bf0a7051c60b45e1c6a8f4277a68a8b7e807078f20db17e0233dea8e  openjdk8-jre-lib-8.212.04-r0.apk\n- EOF\n# 我这里直接将 sha256 校验给删除了，有兴趣可以自己去更新这几个文件的文件名和其对应的哈希值\n```\n\n随后 `chmod +x` 授予脚本可执行权限后直接执行，我们就将 alpine linux 上的 openjdk 成功解包并安装到了我们的 OpenWRT 中，我们只需要配置好环境变量即可完成安装。但我又比较懒，我看见 SignServer 的启动脚本里是可以通过读取 `$JAVA_HOME` 来获取 Java 二进制可执行文件的代码逻辑，于是我便在每次启动 SignServer 脚本前提前执行 `export JAVA_HOME=/opt/java-1.8-openjdk` 即可。\n\n## 安装 screen\n\n相比起前面 JDK 的安装，这一步 screen 的安装反而没有那么麻烦，[在最新版本的 OpenWRT 源中，screen 已经被包括进去了](https://openwrt.org/packages/pkgdata/screen)，我们直接把 OpenWRT 换好源，从源里就可以安装。\n\n```bash\nopkg update\nopkg install screen\n```\n\n## 下载 fixed 版本的 go-cqhttp\n\n由于 SignServer 更新，在其请求中多添加了 key 的参数要求，导致原版 go-cqhttp 的最新 release 中释出的二进制文件无法适配最新版的 SignServer，我暂时选用了一个[修复了这个问题的 fork](https://github.com/tomato-aoarasi/go-cqhttp-1.1.0-sign-fixed/) 去运行 Bot。下载到 OpenWRT 后记得也要授予可执行文件。\n\n## 安装 Python 脚本中所需要使用到的库\n\nOpenWRT 自带了 python 和 pip，这让我很欣慰。直接使用 pip 安装 flask 和 xlrd 等库即可，完全没有难度。\n\n## 运行 SignServer\n\n这一步很简单，将原项目的 Release 下载下来解压后上传到 OpenWRT 的某个路径后，开个 screen 窗口，设置好 JAVA_HOME 变量后再去调用 SignServer 中自带的 shell 脚本即可\n\n## 运行 go-cqhttp\n\n这一步也很简单，得益于 go 静态链接的特性，我们不需要为 go-cqhttp 安装任何额外的依赖就可以执行 Release 中的二进制文件，直接将我们在 PC 上登录好的 session、配置好的 device.json、config.yml 等文件上传到 N1 ，开个 screen 窗口运行即可。\n\n## 运行主程序\n\n这个没什么好讲的，同样是开个 screen 窗口运行 `python main.py` 的事情\n\npython 代码如下:\n\n```python\nfrom flask import Flask,request\nimport requests\nimport xlrd\n\n# 读取 xls 中的关键词以及回应语句，将其加载到 dict 数据结构中\n_data2 = xlrd.open_workbook('/root/8yue222.xls')\nmain_table2 = _data2.sheets()[0]\nkey_lst2 = main_table2.col_values(0)[1:]\nvalue_lst2 = main_table2.col_values(1)[1:]\nfinal_dict = dict(zip(key_lst2,value_lst2))\n# 读取第二份 xls，并对相同的关键词做覆盖\n_data = xlrd.open_workbook('/root/daihao.xls')\nmain_table = _data.sheets()[0]\nkey_lst = main_table.col_values(4)[1:]\nkey_lst = [str(int(item)) if type(item) == float else item for item in key_lst if item != '']\nkey_lst.remove('Gary')\nvalue_lst = main_table.col_values(5)[1:]\nvalue_lst = [str(int(item)) if type(item) == float else item for item in value_lst if item != '']\nfinal_dict.update(dict(zip(key_lst,value_lst)))\n\napp = Flask(__name__)\nclass API:\n        @staticmethod\n        def send(message):\n                url = \"http://127.0.0.1:5700/send_msg\"\n                data = request.get_json()\n                params = {\n                        \"group_id\":data['group_id'],\n                        \"message\":message\n                }\n                requests.get(url,params=params)\n\n@app.route('/', methods=[\"POST\"])\ndef post_data():\n    data = request.get_json()\n    print(data)\n    if data['post_type'] == 'message':\n        message = data['message']\n        messagex()\n    elif data['post_type'] == 'notice' and data['notice_type'] == 'group_increase':\n        welcome()\n    else:\n        print(\"忽略消息\")\n\n    return \"OK\"\n\ndef messagex():\n        data = request.get_json()\n        message = data['message'].replace('％','%')\n        for key in final_dict.keys():\n                if key == message:\n                        API.send(final_dict[key])\n                        break\n\ndef welcome():\n        data = request.get_json()\n        group_id = data['group_id']\n        user_id = data['user_id']\n        API.send(\"[CQ:at,qq={}] 欢迎来到浙江工业大学，精弘网络欢迎各位的到来！如果想进一步了解我们，请戳精弘首页：www.jh.zjut.edu.cn\\n输入 菜单 获取精小弘机器人的菜单 哦！\\n请及时修改群名片\\n格式如下：姓名+专业/大类\".format(user_id))\n\nif __name__ == '__main__':\n    app.run(host='0.0.0.0', port=5701)\n```\n\n>  参考资料: \n>\n> https://gist.github.com/simonswine/64773a80e748f36615e3251234f29d1d\n>\n> https://blog.csdn.net/qq_64126275/article/details/128586651\n",{"title":5,"description":12},"posts/zh/run-qq-bot-on-phicomm-n1-openwrt",false,[1301,1302,1303],"Linux","Network","Bot","2t_O_XOSVccdU7D3AjdWchEwA-MrIHT_lDr_O9gCh44",[1306,1311],{"title":1307,"path":1308,"stem":1309,"date":1310,"lang":1293,"children":-1},"从零开始的静态网页部署（到个人云服务器）","/2023/08/04/static-webpage-deployment-for-a-beginner","posts/zh/static-webpage-deployment-for-a-beginner","2023-08-04 01:19:22",{"title":1312,"path":1313,"stem":1314,"date":1315,"lang":1293,"children":-1},"在浙工大宿舍使用路由器连接移动网络(校园网)","/2023/06/24/connect-china-mobile-with-router-in-zjut-dormitory","posts/zh/connect-china-mobile-with-router-in-zjut-dormitory","2023-06-24 14:30:24",null,1763662448246]