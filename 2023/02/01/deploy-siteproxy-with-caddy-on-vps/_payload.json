[{"data":1,"prerenderedAt":528},["ShallowReactive",2],{"post-2023-02-01-deploy-siteproxy-with-caddy-on-vps-zh":3,"surround-2023-02-01-deploy-siteproxy-with-caddy-on-vps-zh":516,"randomIndex/2023/02/01/deploy-siteproxy-with-caddy-on-vps/":164,"language-switch-/2023/02/01/deploy-siteproxy-with-caddy-on-vps/-en":527},{"id":4,"title":5,"body":6,"date":500,"description":501,"extension":502,"lang":503,"meta":504,"navigation":505,"path":506,"rawbody":507,"seo":508,"stem":509,"sticky":510,"tags":511,"__hash__":515},"posts/posts/zh/deploy-siteproxy-with-caddy-on-vps.md","在 vps 上配合 caddy 部署 siteproxy",{"type":7,"value":8,"toc":489},"minimark",[9,21,29,32,49,52,57,73,168,179,183,198,201,208,211,214,260,293,299,302,388,392,399,412,419,422,435,442,449,452,455,463,470,474,481,485],[10,11,12,13,20],"p",{},"之前趁着春节活动的时候在某 vps 服务商买了 1 年的 vps，线路不算太好，但勉强够用，于是打算在上面部署一些反代程序。在群友的推荐下，发现了这款名为 ",[14,15,19],"a",{"href":16,"rel":17},"https://github.com/netptop/siteproxy",[18],"nofollow","siteproxy"," 的开源项目。",[10,22,23,24,28],{},"siteproxy 相较于我在 ",[25,26,27],"code",{},"r.zhullyb.top"," 部署的那个反代，其特点是可以运行在 vps 上，且将会替换被反代页面上的所有 url，因此遇到使用相对路径的网页也可以从容应对。",[10,30,31],{},"在项目的 README 中介绍了一种部署方案，但我仍有以下几点不太满意",[33,34,35,39,46],"ul",{},[36,37,38],"li",{},"README 中的方案仅支持 nginx 部署，但我希望使用 caddy",[36,40,41,42,45],{},"README 中的方案使用 npm 安装了 ",[25,43,44],{},"forever"," 来达到保活的目的，甚至为此安装了 nvm，但我一不希望使用 npm 在系统上安装软件、二不希望安装 nvm 与 forever",[36,47,48],{},"原项目把根目录页做成了一个导航，指向了一些比较敏感的站点，而我希望换掉这个网页。",[10,50,51],{},"因此这篇博客也就应运而生。",[53,54,56],"h2",{"id":55},"反代-8011-端口","反代 8011 端口",[10,58,59,60,63,64,68,69,72],{},"根据项目 README 的描述，我们应当使用 nginx 去反代 ",[25,61,62],{},"127.0.0.1:8011"," 端口，但我是 caddy 用户，此前也",[14,65,67],{"href":66},"/2022/05/30/use-caddy-to-proxy-wikipedia/","有过使用 caddy 反代","的经验，所以很容易写出一段使得程序可以正确运行的 ",[25,70,71],{},"Caddyfile","。",[74,75,80],"pre",{"className":76,"code":77,"language":78,"meta":79,"style":79},"language-nginx shiki shiki-themes one-light one-dark-pro","example.com {\n        reverse_proxy   127.0.0.1:8011 {\n                header_up Host {upstream_hostport}\n                header_up X-Real-IP {http.request.remote.host}\n                header_up X-Forwarded-For {http.request.remote.host}\n                header_up X-Forwarded-Port {http.request.port}\n                header_up X-Forwarded-Proto {http.request.scheme}\n                header_up Accept-Encoding identity\n        }\n}\n","nginx","",[25,81,82,98,107,116,124,132,140,148,156,162],{"__ignoreMap":79},[83,84,87,91,95],"span",{"class":85,"line":86},"line",1,[83,88,90],{"class":89},"s5ixo","example.",[83,92,94],{"class":93},"sLKXg","com",[83,96,97],{"class":89}," {\n",[83,99,101,104],{"class":85,"line":100},2,[83,102,103],{"class":93},"        reverse_proxy",[83,105,106],{"class":89},"   127.0.0.1:8011 {\n",[83,108,110,113],{"class":85,"line":109},3,[83,111,112],{"class":93},"                header_up",[83,114,115],{"class":89}," Host {upstream_hostport}\n",[83,117,119,121],{"class":85,"line":118},4,[83,120,112],{"class":93},[83,122,123],{"class":89}," X-Real-IP {http.request.remote.host}\n",[83,125,127,129],{"class":85,"line":126},5,[83,128,112],{"class":93},[83,130,131],{"class":89}," X-Forwarded-For {http.request.remote.host}\n",[83,133,135,137],{"class":85,"line":134},6,[83,136,112],{"class":93},[83,138,139],{"class":89}," X-Forwarded-Port {http.request.port}\n",[83,141,143,145],{"class":85,"line":142},7,[83,144,112],{"class":93},[83,146,147],{"class":89}," X-Forwarded-Proto {http.request.scheme}\n",[83,149,151,153],{"class":85,"line":150},8,[83,152,112],{"class":93},[83,154,155],{"class":89}," Accept-Encoding identity\n",[83,157,159],{"class":85,"line":158},9,[83,160,161],{"class":89},"        }\n",[83,163,165],{"class":85,"line":164},10,[83,166,167],{"class":89},"}\n",[10,169,170,171,174,175,178],{},"将 ",[25,172,173],{},"example.com"," 的 A 记录解析到 vps 主机的 ip，并使用 ",[25,176,177],{},"systemctl"," 重新启动 caddy，这一步就算完成了。",[53,180,182],{"id":181},"安装-nodejs","安装 nodejs",[10,184,185,186,189,190,193,194,197],{},"我在 vps 上安装的发行版是 Archlinux，所以直接 ",[25,187,188],{},"pacman -S nodejs"," 安装完就是了，别的发行版应该也可以直接调用系统默认的包管理器安装 ",[25,191,192],{},"node"," 或者 ",[25,195,196],{},"nodejs"," 完成这一步。",[53,199,200],{"id":200},"下载程序",[10,202,203,204,207],{},"首先，我们需要一个地方来存放我们下载的程序，我使用的是 ",[25,205,206],{},"/opt"," 路径。",[10,209,210],{},"我们可以直接根据 README 所说的，直接 clone 整个项目，但我本人并不想这么做，项目里似乎有太多对于 vps 用户没有用的东西了。此外，整个项目首页我也不想要，首页的导航指向了一些比较敏感的网站，而我的反代就想安安心心的一个人用。",[10,212,213],{},"综合以上需求，我所需要的文件一共就五个:",[74,215,219],{"className":216,"code":217,"language":218,"meta":79,"style":79},"language-bash shiki shiki-themes one-light one-dark-pro","├── config.js\n├── index.js\n├── logger.js\n├── package.json\n└── Proxy.js\n","bash",[25,220,221,231,238,245,252],{"__ignoreMap":79},[83,222,223,227],{"class":85,"line":86},[83,224,226],{"class":225},"sAdtL","├──",[83,228,230],{"class":229},"sDhpE"," config.js\n",[83,232,233,235],{"class":85,"line":100},[83,234,226],{"class":225},[83,236,237],{"class":229}," index.js\n",[83,239,240,242],{"class":85,"line":109},[83,241,226],{"class":225},[83,243,244],{"class":229}," logger.js\n",[83,246,247,249],{"class":85,"line":118},[83,248,226],{"class":225},[83,250,251],{"class":229}," package.json\n",[83,253,254,257],{"class":85,"line":126},[83,255,256],{"class":225},"└──",[83,258,259],{"class":229}," Proxy.js\n",[74,261,263],{"className":216,"code":262,"language":218,"meta":79,"style":79},"mkdir -p /opt/siteproxy\ncd /opt/siteproxy\nwget https://raw.githubusercontent.com/netptop/siteproxy/master/{config.js,index.js,logger.js,package.json,Proxy.js}\n",[25,264,265,277,285],{"__ignoreMap":79},[83,266,267,270,274],{"class":85,"line":86},[83,268,269],{"class":225},"mkdir",[83,271,273],{"class":272},"sAGMh"," -p",[83,275,276],{"class":229}," /opt/siteproxy\n",[83,278,279,283],{"class":85,"line":100},[83,280,282],{"class":281},"s_Sar","cd",[83,284,276],{"class":229},[83,286,287,290],{"class":85,"line":109},[83,288,289],{"class":225},"wget",[83,291,292],{"class":229}," https://raw.githubusercontent.com/netptop/siteproxy/master/{config.js,index.js,logger.js,package.json,Proxy.js}\n",[10,294,295,296],{},"然后补上一个 ",[25,297,298],{},"index.html",[10,300,301],{},"我这边选择直接使用 JavaScript 将对于 / 的访问直接重定向到我的博客。",[74,303,307],{"className":304,"code":305,"language":306,"meta":79,"style":79},"language-javascript shiki shiki-themes one-light one-dark-pro","\u003Chtml>\u003Chead>\u003Cmeta http-equiv=\"refresh\" content=\"0; url=https://zhul.in/\" />\u003C/head>\u003Cbody>Redirect to \u003Ca href=\"\">https://zhul.in/\u003C/a>\u003C/body>\u003C/html>\n","javascript",[25,308,309],{"__ignoreMap":79},[83,310,311,314,318,321,324,326,329,333,337,340,343,345,348,351,353,355,358,361,363,366,368,371,374,376,379,381,383,385],{"class":85,"line":86},[83,312,313],{"class":89},"\u003C",[83,315,317],{"class":316},"sJa8x","html",[83,319,320],{"class":89},">\u003C",[83,322,323],{"class":316},"head",[83,325,320],{"class":89},[83,327,328],{"class":316},"meta",[83,330,332],{"class":331},"so_Uh"," http-equiv",[83,334,336],{"class":335},"sknuh","=",[83,338,339],{"class":229},"\"refresh\"",[83,341,342],{"class":331}," content",[83,344,336],{"class":335},[83,346,347],{"class":229},"\"0; url=https://zhul.in/\"",[83,349,350],{"class":89}," />\u003C/",[83,352,323],{"class":316},[83,354,320],{"class":89},[83,356,357],{"class":316},"body",[83,359,360],{"class":89},">Redirect to \u003C",[83,362,14],{"class":316},[83,364,365],{"class":331}," href",[83,367,336],{"class":335},[83,369,370],{"class":229},"\"\"",[83,372,373],{"class":89},">https://zhul.in/\u003C/",[83,375,14],{"class":316},[83,377,378],{"class":89},">\u003C/",[83,380,357],{"class":316},[83,382,378],{"class":89},[83,384,317],{"class":316},[83,386,387],{"class":89},">\n",[389,390,391],"h3",{"id":391},"安装依赖",[10,393,394,395,398],{},"在 ",[25,396,397],{},"/opt/siteproxy"," 目录下执行",[74,400,402],{"className":216,"code":401,"language":218,"meta":79,"style":79},"npm install\n",[25,403,404],{"__ignoreMap":79},[83,405,406,409],{"class":85,"line":86},[83,407,408],{"class":225},"npm",[83,410,411],{"class":229}," install\n",[10,413,414,415,418],{},"npm 将会根据 ",[25,416,417],{},"package.json"," 的内容自动安装所需的依赖。",[53,420,421],{"id":421},"修改配置文件",[74,423,425],{"className":216,"code":424,"language":218,"meta":79,"style":79},"$EDITOR /opt/siteproxy/config.js\n",[25,426,427],{"__ignoreMap":79},[83,428,429,432],{"class":85,"line":86},[83,430,431],{"class":316},"$EDITOR",[83,433,434],{"class":89}," /opt/siteproxy/config.js\n",[10,436,437,438,441],{},"按照 README 所说，修改 ",[25,439,440],{},"serverName"," 字段",[10,443,444],{},[445,446],"img",{"alt":447,"src":448},"需要修改的 serverName 字段","https://static.031130.xyz/uploads/2024/08/12/63da866e26712.webp",[53,450,451],{"id":451},"设置开机自启动",[10,453,454],{},"这里我选择使用 systemd 帮助我实现 siteproxy 程序的开机自启动，service 文件是我直接根据 frp 程序提供的 service 改的。",[74,456,461],{"className":457,"code":459,"language":460},[458],"language-text","cat /usr/lib/systemd/system/siteproxy.service \n-----\n[Unit]\nDescription=SiteProxy\nAfter=network-online.target\nWants=network-online.target\n\n[Service]\nType=simple\nUser=nobody\nRestart=on-failure\nRestartSec=5s\nEnvironment=\"NODE_PATH=/opt/siteproxy/\"\nExecStart=node --tls-min-v1.0 /opt/siteproxy/index.js \n\n[Install]\nWantedBy=multi-user.target\n","text",[25,462,459],{"__ignoreMap":79},[10,464,465,466,469],{},"随后使用 ",[25,467,468],{},"systemctl enable siteproxy --now"," 启动即可访问。",[53,471,473],{"id":472},"为反代站点添加访问密码可选","为反代站点添加访问密码（可选）",[10,475,476,477,72],{},"参考",[14,478,480],{"href":479},"/2021/10/21/picuploader-on-archlinux-with-caddy/#%E8%AE%BE%E7%BD%AE%E8%AE%BF%E9%97%AE%E5%AF%86%E7%A0%81%EF%BC%88%E5%8F%AF%E9%80%89%EF%BC%89","我的另一篇博客",[53,482,484],{"id":483},"使用防火墙程序禁止-8011-的公网访问可选","使用防火墙程序禁止 8011 的公网访问（可选）",[486,487,488],"style",{},"html pre.shiki code .s5ixo, html code.shiki .s5ixo{--shiki-default:#383A42;--shiki-dark:#ABB2BF}html pre.shiki code .sLKXg, html code.shiki .sLKXg{--shiki-default:#A626A4;--shiki-dark:#C678DD}html .default .shiki span {color: var(--shiki-default);background: var(--shiki-default-bg);font-style: var(--shiki-default-font-style);font-weight: var(--shiki-default-font-weight);text-decoration: var(--shiki-default-text-decoration);}html .shiki span {color: var(--shiki-default);background: var(--shiki-default-bg);font-style: var(--shiki-default-font-style);font-weight: var(--shiki-default-font-weight);text-decoration: var(--shiki-default-text-decoration);}html .dark .shiki span {color: var(--shiki-dark);background: var(--shiki-dark-bg);font-style: var(--shiki-dark-font-style);font-weight: var(--shiki-dark-font-weight);text-decoration: var(--shiki-dark-text-decoration);}html.dark .shiki span {color: var(--shiki-dark);background: var(--shiki-dark-bg);font-style: var(--shiki-dark-font-style);font-weight: var(--shiki-dark-font-weight);text-decoration: var(--shiki-dark-text-decoration);}html pre.shiki code .sAdtL, html code.shiki .sAdtL{--shiki-default:#4078F2;--shiki-dark:#61AFEF}html pre.shiki code .sDhpE, html code.shiki .sDhpE{--shiki-default:#50A14F;--shiki-dark:#98C379}html pre.shiki code .sAGMh, html code.shiki .sAGMh{--shiki-default:#986801;--shiki-dark:#D19A66}html pre.shiki code .s_Sar, html code.shiki .s_Sar{--shiki-default:#0184BC;--shiki-dark:#56B6C2}html pre.shiki code .sJa8x, html code.shiki .sJa8x{--shiki-default:#E45649;--shiki-dark:#E06C75}html pre.shiki code .so_Uh, html code.shiki .so_Uh{--shiki-default:#986801;--shiki-default-font-style:inherit;--shiki-dark:#D19A66;--shiki-dark-font-style:italic}html pre.shiki code .sknuh, html code.shiki .sknuh{--shiki-default:#383A42;--shiki-dark:#56B6C2}",{"title":79,"searchDepth":100,"depth":100,"links":490},[491,492,493,496,497,498,499],{"id":55,"depth":100,"text":56},{"id":181,"depth":100,"text":182},{"id":200,"depth":100,"text":200,"children":494},[495],{"id":391,"depth":109,"text":391},{"id":421,"depth":100,"text":421},{"id":451,"depth":100,"text":451},{"id":472,"depth":100,"text":473},{"id":483,"depth":100,"text":484},"2023-02-01 22:33:53","之前趁着春节活动的时候在某 vps 服务商买了 1 年的 vps，线路不算太好，但勉强够用，于是打算在上面部署一些反代程序。在群友的推荐下，发现了这款名为 siteproxy 的开源项目。","md","zh-CN",{},true,"/2023/02/01/deploy-siteproxy-with-caddy-on-vps","---\ntitle: 在 vps 上配合 caddy 部署 siteproxy\ndate: 2023-02-01 22:33:53\nsticky:\ntags:\n- OpenSource Project\n- siteproxy\n- Archlinux\n- nodejs\n- Caddy\n---\n\n之前趁着春节活动的时候在某 vps 服务商买了 1 年的 vps，线路不算太好，但勉强够用，于是打算在上面部署一些反代程序。在群友的推荐下，发现了这款名为 [siteproxy](https://github.com/netptop/siteproxy) 的开源项目。\n\nsiteproxy 相较于我在 `r.zhullyb.top` 部署的那个反代，其特点是可以运行在 vps 上，且将会替换被反代页面上的所有 url，因此遇到使用相对路径的网页也可以从容应对。\n\n在项目的 README 中介绍了一种部署方案，但我仍有以下几点不太满意\n\n- README 中的方案仅支持 nginx 部署，但我希望使用 caddy\n- README 中的方案使用 npm 安装了 `forever` 来达到保活的目的，甚至为此安装了 nvm，但我一不希望使用 npm 在系统上安装软件、二不希望安装 nvm 与 forever\n- 原项目把根目录页做成了一个导航，指向了一些比较敏感的站点，而我希望换掉这个网页。\n\n因此这篇博客也就应运而生。\n\n## 反代 8011 端口\n\n根据项目 README 的描述，我们应当使用 nginx 去反代 `127.0.0.1:8011` 端口，但我是 caddy 用户，此前也[有过使用 caddy 反代](/2022/05/30/use-caddy-to-proxy-wikipedia/)的经验，所以很容易写出一段使得程序可以正确运行的 `Caddyfile`。\n\n```nginx\nexample.com {\n        reverse_proxy   127.0.0.1:8011 {\n                header_up Host {upstream_hostport}\n                header_up X-Real-IP {http.request.remote.host}\n                header_up X-Forwarded-For {http.request.remote.host}\n                header_up X-Forwarded-Port {http.request.port}\n                header_up X-Forwarded-Proto {http.request.scheme}\n                header_up Accept-Encoding identity\n        }\n}\n```\n\n将 `example.com` 的 A 记录解析到 vps 主机的 ip，并使用 `systemctl` 重新启动 caddy，这一步就算完成了。\n\n## 安装 nodejs\n\n我在 vps 上安装的发行版是 Archlinux，所以直接 `pacman -S nodejs` 安装完就是了，别的发行版应该也可以直接调用系统默认的包管理器安装 `node` 或者 `nodejs` 完成这一步。\n\n## 下载程序\n\n首先，我们需要一个地方来存放我们下载的程序，我使用的是 `/opt` 路径。\n\n我们可以直接根据 README 所说的，直接 clone 整个项目，但我本人并不想这么做，项目里似乎有太多对于 vps 用户没有用的东西了。此外，整个项目首页我也不想要，首页的导航指向了一些比较敏感的网站，而我的反代就想安安心心的一个人用。\n\n综合以上需求，我所需要的文件一共就五个: \n\n```bash\n├── config.js\n├── index.js\n├── logger.js\n├── package.json\n└── Proxy.js\n```\n\n```bash\nmkdir -p /opt/siteproxy\ncd /opt/siteproxy\nwget https://raw.githubusercontent.com/netptop/siteproxy/master/{config.js,index.js,logger.js,package.json,Proxy.js}\n```\n\n然后补上一个 `index.html`\n\n我这边选择直接使用 JavaScript 将对于 / 的访问直接重定向到我的博客。\n\n```javascript\n\u003Chtml>\u003Chead>\u003Cmeta http-equiv=\"refresh\" content=\"0; url=https://zhul.in/\" />\u003C/head>\u003Cbody>Redirect to \u003Ca href=\"\">https://zhul.in/\u003C/a>\u003C/body>\u003C/html>\n```\n\n### 安装依赖\n\n在 `/opt/siteproxy` 目录下执行\n\n```bash\nnpm install\n```\n\nnpm 将会根据 `package.json` 的内容自动安装所需的依赖。\n\n## 修改配置文件\n\n```bash\n$EDITOR /opt/siteproxy/config.js\n```\n\n按照 README 所说，修改 `serverName` 字段\n\n![需要修改的 serverName 字段](https://static.031130.xyz/uploads/2024/08/12/63da866e26712.webp)\n\n## 设置开机自启动\n\n这里我选择使用 systemd 帮助我实现 siteproxy 程序的开机自启动，service 文件是我直接根据 frp 程序提供的 service 改的。\n\n```\ncat /usr/lib/systemd/system/siteproxy.service \n-----\n[Unit]\nDescription=SiteProxy\nAfter=network-online.target\nWants=network-online.target\n\n[Service]\nType=simple\nUser=nobody\nRestart=on-failure\nRestartSec=5s\nEnvironment=\"NODE_PATH=/opt/siteproxy/\"\nExecStart=node --tls-min-v1.0 /opt/siteproxy/index.js \n\n[Install]\nWantedBy=multi-user.target\n```\n\n随后使用 `systemctl enable siteproxy --now` 启动即可访问。\n\n## 为反代站点添加访问密码（可选）\n\n参考[我的另一篇博客](/2021/10/21/picuploader-on-archlinux-with-caddy/#%E8%AE%BE%E7%BD%AE%E8%AE%BF%E9%97%AE%E5%AF%86%E7%A0%81%EF%BC%88%E5%8F%AF%E9%80%89%EF%BC%89)。\n\n## 使用防火墙程序禁止 8011 的公网访问（可选）\n",{"title":5,"description":501},"posts/zh/deploy-siteproxy-with-caddy-on-vps",false,[512,19,513,196,514],"OpenSource Project","Archlinux","Caddy","hVLf9nBKuwNchfYSWxTKR8SSG_CCubcgy1VSjH0BGSw",[517,522],{"title":518,"path":519,"stem":520,"date":521,"lang":503,"children":-1},"隐式转发——骚套路建站方案","/2023/03/26/implicit-forwarding-is-a-new-site-deploying-method","posts/zh/implicit-forwarding-is-a-new-site-deploying-method","2023-03-26 00:10:02",{"title":523,"path":524,"stem":525,"date":526,"lang":503,"children":-1},"onedrive(by abraunegg) —— 一个 Linux 下的开源 OneDrive 客户端(cli)","/2022/12/24/onedrive-abraunegg-recommendation","posts/zh/onedrive-abraunegg-recommendation","2022-12-24 22:40:13",null,1763672462079]