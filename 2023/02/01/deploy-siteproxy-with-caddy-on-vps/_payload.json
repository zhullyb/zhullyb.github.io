[{"data":1,"prerenderedAt":519},["ShallowReactive",2],{"post-2023-02-01-deploy-siteproxy-with-caddy-on-vps-zh":3,"surround-2023-02-01-deploy-siteproxy-with-caddy-on-vps-zh":506,"randomIndex/2023/02/01/deploy-siteproxy-with-caddy-on-vps/":115,"language-switch-/2023/02/01/deploy-siteproxy-with-caddy-on-vps/-en":518},{"title":4,"date":5,"path":6,"tags":7,"body":13,"description":505},"在 vps 上配合 caddy 部署 siteproxy","2023-02-01 22:33:53","/2023/02/01/deploy-siteproxy-with-caddy-on-vps",[8,9,10,11,12],"OpenSource Project","siteproxy","Archlinux","nodejs","Caddy",{"type":14,"value":15,"toc":494},"minimark",[16,27,35,38,55,58,63,79,174,185,189,203,206,213,216,219,265,298,304,307,393,397,404,417,424,427,440,447,454,457,460,468,475,479,486,490],[17,18,19,20,26],"p",{},"之前趁着春节活动的时候在某 vps 服务商买了 1 年的 vps，线路不算太好，但勉强够用，于是打算在上面部署一些反代程序。在群友的推荐下，发现了这款名为 ",[21,22,9],"a",{"href":23,"rel":24},"https://github.com/netptop/siteproxy",[25],"nofollow"," 的开源项目。",[17,28,29,30,34],{},"siteproxy 相较于我在 ",[31,32,33],"code",{},"r.zhullyb.top"," 部署的那个反代，其特点是可以运行在 vps 上，且将会替换被反代页面上的所有 url，因此遇到使用相对路径的网页也可以从容应对。",[17,36,37],{},"在项目的 README 中介绍了一种部署方案，但我仍有以下几点不太满意",[39,40,41,45,52],"ul",{},[42,43,44],"li",{},"README 中的方案仅支持 nginx 部署，但我希望使用 caddy",[42,46,47,48,51],{},"README 中的方案使用 npm 安装了 ",[31,49,50],{},"forever"," 来达到保活的目的，甚至为此安装了 nvm，但我一不希望使用 npm 在系统上安装软件、二不希望安装 nvm 与 forever",[42,53,54],{},"原项目把根目录页做成了一个导航，指向了一些比较敏感的站点，而我希望换掉这个网页。",[17,56,57],{},"因此这篇博客也就应运而生。",[59,60,62],"h2",{"id":61},"反代-8011-端口","反代 8011 端口",[17,64,65,66,69,70,74,75,78],{},"根据项目 README 的描述，我们应当使用 nginx 去反代 ",[31,67,68],{},"127.0.0.1:8011"," 端口，但我是 caddy 用户，此前也",[21,71,73],{"href":72},"/2022/05/30/use-caddy-to-proxy-wikipedia/","有过使用 caddy 反代","的经验，所以很容易写出一段使得程序可以正确运行的 ",[31,76,77],{},"Caddyfile","。",[80,81,86],"pre",{"className":82,"code":83,"language":84,"meta":85,"style":85},"language-nginx shiki shiki-themes one-light one-dark-pro","example.com {\n        reverse_proxy   127.0.0.1:8011 {\n                header_up Host {upstream_hostport}\n                header_up X-Real-IP {http.request.remote.host}\n                header_up X-Forwarded-For {http.request.remote.host}\n                header_up X-Forwarded-Port {http.request.port}\n                header_up X-Forwarded-Proto {http.request.scheme}\n                header_up Accept-Encoding identity\n        }\n}\n","nginx","",[31,87,88,104,113,122,130,138,146,154,162,168],{"__ignoreMap":85},[89,90,93,97,101],"span",{"class":91,"line":92},"line",1,[89,94,96],{"class":95},"s5ixo","example.",[89,98,100],{"class":99},"sLKXg","com",[89,102,103],{"class":95}," {\n",[89,105,107,110],{"class":91,"line":106},2,[89,108,109],{"class":99},"        reverse_proxy",[89,111,112],{"class":95},"   127.0.0.1:8011 {\n",[89,114,116,119],{"class":91,"line":115},3,[89,117,118],{"class":99},"                header_up",[89,120,121],{"class":95}," Host {upstream_hostport}\n",[89,123,125,127],{"class":91,"line":124},4,[89,126,118],{"class":99},[89,128,129],{"class":95}," X-Real-IP {http.request.remote.host}\n",[89,131,133,135],{"class":91,"line":132},5,[89,134,118],{"class":99},[89,136,137],{"class":95}," X-Forwarded-For {http.request.remote.host}\n",[89,139,141,143],{"class":91,"line":140},6,[89,142,118],{"class":99},[89,144,145],{"class":95}," X-Forwarded-Port {http.request.port}\n",[89,147,149,151],{"class":91,"line":148},7,[89,150,118],{"class":99},[89,152,153],{"class":95}," X-Forwarded-Proto {http.request.scheme}\n",[89,155,157,159],{"class":91,"line":156},8,[89,158,118],{"class":99},[89,160,161],{"class":95}," Accept-Encoding identity\n",[89,163,165],{"class":91,"line":164},9,[89,166,167],{"class":95},"        }\n",[89,169,171],{"class":91,"line":170},10,[89,172,173],{"class":95},"}\n",[17,175,176,177,180,181,184],{},"将 ",[31,178,179],{},"example.com"," 的 A 记录解析到 vps 主机的 ip，并使用 ",[31,182,183],{},"systemctl"," 重新启动 caddy，这一步就算完成了。",[59,186,188],{"id":187},"安装-nodejs","安装 nodejs",[17,190,191,192,195,196,199,200,202],{},"我在 vps 上安装的发行版是 Archlinux，所以直接 ",[31,193,194],{},"pacman -S nodejs"," 安装完就是了，别的发行版应该也可以直接调用系统默认的包管理器安装 ",[31,197,198],{},"node"," 或者 ",[31,201,11],{}," 完成这一步。",[59,204,205],{"id":205},"下载程序",[17,207,208,209,212],{},"首先，我们需要一个地方来存放我们下载的程序，我使用的是 ",[31,210,211],{},"/opt"," 路径。",[17,214,215],{},"我们可以直接根据 README 所说的，直接 clone 整个项目，但我本人并不想这么做，项目里似乎有太多对于 vps 用户没有用的东西了。此外，整个项目首页我也不想要，首页的导航指向了一些比较敏感的网站，而我的反代就想安安心心的一个人用。",[17,217,218],{},"综合以上需求，我所需要的文件一共就五个:",[80,220,224],{"className":221,"code":222,"language":223,"meta":85,"style":85},"language-bash shiki shiki-themes one-light one-dark-pro","├── config.js\n├── index.js\n├── logger.js\n├── package.json\n└── Proxy.js\n","bash",[31,225,226,236,243,250,257],{"__ignoreMap":85},[89,227,228,232],{"class":91,"line":92},[89,229,231],{"class":230},"sAdtL","├──",[89,233,235],{"class":234},"sDhpE"," config.js\n",[89,237,238,240],{"class":91,"line":106},[89,239,231],{"class":230},[89,241,242],{"class":234}," index.js\n",[89,244,245,247],{"class":91,"line":115},[89,246,231],{"class":230},[89,248,249],{"class":234}," logger.js\n",[89,251,252,254],{"class":91,"line":124},[89,253,231],{"class":230},[89,255,256],{"class":234}," package.json\n",[89,258,259,262],{"class":91,"line":132},[89,260,261],{"class":230},"└──",[89,263,264],{"class":234}," Proxy.js\n",[80,266,268],{"className":221,"code":267,"language":223,"meta":85,"style":85},"mkdir -p /opt/siteproxy\ncd /opt/siteproxy\nwget https://raw.githubusercontent.com/netptop/siteproxy/master/{config.js,index.js,logger.js,package.json,Proxy.js}\n",[31,269,270,282,290],{"__ignoreMap":85},[89,271,272,275,279],{"class":91,"line":92},[89,273,274],{"class":230},"mkdir",[89,276,278],{"class":277},"sAGMh"," -p",[89,280,281],{"class":234}," /opt/siteproxy\n",[89,283,284,288],{"class":91,"line":106},[89,285,287],{"class":286},"s_Sar","cd",[89,289,281],{"class":234},[89,291,292,295],{"class":91,"line":115},[89,293,294],{"class":230},"wget",[89,296,297],{"class":234}," https://raw.githubusercontent.com/netptop/siteproxy/master/{config.js,index.js,logger.js,package.json,Proxy.js}\n",[17,299,300,301],{},"然后补上一个 ",[31,302,303],{},"index.html",[17,305,306],{},"我这边选择直接使用 JavaScript 将对于 / 的访问直接重定向到我的博客。",[80,308,312],{"className":309,"code":310,"language":311,"meta":85,"style":85},"language-javascript shiki shiki-themes one-light one-dark-pro","\u003Chtml>\u003Chead>\u003Cmeta http-equiv=\"refresh\" content=\"0; url=https://zhul.in/\" />\u003C/head>\u003Cbody>Redirect to \u003Ca href=\"\">https://zhul.in/\u003C/a>\u003C/body>\u003C/html>\n","javascript",[31,313,314],{"__ignoreMap":85},[89,315,316,319,323,326,329,331,334,338,342,345,348,350,353,356,358,360,363,366,368,371,373,376,379,381,384,386,388,390],{"class":91,"line":92},[89,317,318],{"class":95},"\u003C",[89,320,322],{"class":321},"sJa8x","html",[89,324,325],{"class":95},">\u003C",[89,327,328],{"class":321},"head",[89,330,325],{"class":95},[89,332,333],{"class":321},"meta",[89,335,337],{"class":336},"so_Uh"," http-equiv",[89,339,341],{"class":340},"sknuh","=",[89,343,344],{"class":234},"\"refresh\"",[89,346,347],{"class":336}," content",[89,349,341],{"class":340},[89,351,352],{"class":234},"\"0; url=https://zhul.in/\"",[89,354,355],{"class":95}," />\u003C/",[89,357,328],{"class":321},[89,359,325],{"class":95},[89,361,362],{"class":321},"body",[89,364,365],{"class":95},">Redirect to \u003C",[89,367,21],{"class":321},[89,369,370],{"class":336}," href",[89,372,341],{"class":340},[89,374,375],{"class":234},"\"\"",[89,377,378],{"class":95},">https://zhul.in/\u003C/",[89,380,21],{"class":321},[89,382,383],{"class":95},">\u003C/",[89,385,362],{"class":321},[89,387,383],{"class":95},[89,389,322],{"class":321},[89,391,392],{"class":95},">\n",[394,395,396],"h3",{"id":396},"安装依赖",[17,398,399,400,403],{},"在 ",[31,401,402],{},"/opt/siteproxy"," 目录下执行",[80,405,407],{"className":221,"code":406,"language":223,"meta":85,"style":85},"npm install\n",[31,408,409],{"__ignoreMap":85},[89,410,411,414],{"class":91,"line":92},[89,412,413],{"class":230},"npm",[89,415,416],{"class":234}," install\n",[17,418,419,420,423],{},"npm 将会根据 ",[31,421,422],{},"package.json"," 的内容自动安装所需的依赖。",[59,425,426],{"id":426},"修改配置文件",[80,428,430],{"className":221,"code":429,"language":223,"meta":85,"style":85},"$EDITOR /opt/siteproxy/config.js\n",[31,431,432],{"__ignoreMap":85},[89,433,434,437],{"class":91,"line":92},[89,435,436],{"class":321},"$EDITOR",[89,438,439],{"class":95}," /opt/siteproxy/config.js\n",[17,441,442,443,446],{},"按照 README 所说，修改 ",[31,444,445],{},"serverName"," 字段",[17,448,449],{},[450,451],"img",{"alt":452,"src":453},"需要修改的 serverName 字段","https://static.031130.xyz/uploads/2024/08/12/63da866e26712.webp",[59,455,456],{"id":456},"设置开机自启动",[17,458,459],{},"这里我选择使用 systemd 帮助我实现 siteproxy 程序的开机自启动，service 文件是我直接根据 frp 程序提供的 service 改的。",[80,461,466],{"className":462,"code":464,"language":465},[463],"language-text","cat /usr/lib/systemd/system/siteproxy.service \n-----\n[Unit]\nDescription=SiteProxy\nAfter=network-online.target\nWants=network-online.target\n\n[Service]\nType=simple\nUser=nobody\nRestart=on-failure\nRestartSec=5s\nEnvironment=\"NODE_PATH=/opt/siteproxy/\"\nExecStart=node --tls-min-v1.0 /opt/siteproxy/index.js \n\n[Install]\nWantedBy=multi-user.target\n","text",[31,467,464],{"__ignoreMap":85},[17,469,470,471,474],{},"随后使用 ",[31,472,473],{},"systemctl enable siteproxy --now"," 启动即可访问。",[59,476,478],{"id":477},"为反代站点添加访问密码可选","为反代站点添加访问密码（可选）",[17,480,481,482,78],{},"参考",[21,483,485],{"href":484},"/2021/10/21/picuploader-on-archlinux-with-caddy/#%E8%AE%BE%E7%BD%AE%E8%AE%BF%E9%97%AE%E5%AF%86%E7%A0%81%EF%BC%88%E5%8F%AF%E9%80%89%EF%BC%89","我的另一篇博客",[59,487,489],{"id":488},"使用防火墙程序禁止-8011-的公网访问可选","使用防火墙程序禁止 8011 的公网访问（可选）",[491,492,493],"style",{},"html pre.shiki code .s5ixo, html code.shiki .s5ixo{--shiki-default:#383A42;--shiki-dark:#ABB2BF}html pre.shiki code .sLKXg, html code.shiki .sLKXg{--shiki-default:#A626A4;--shiki-dark:#C678DD}html .default .shiki span {color: var(--shiki-default);background: var(--shiki-default-bg);font-style: var(--shiki-default-font-style);font-weight: var(--shiki-default-font-weight);text-decoration: var(--shiki-default-text-decoration);}html .shiki span {color: var(--shiki-default);background: var(--shiki-default-bg);font-style: var(--shiki-default-font-style);font-weight: var(--shiki-default-font-weight);text-decoration: var(--shiki-default-text-decoration);}html .dark .shiki span {color: var(--shiki-dark);background: var(--shiki-dark-bg);font-style: var(--shiki-dark-font-style);font-weight: var(--shiki-dark-font-weight);text-decoration: var(--shiki-dark-text-decoration);}html.dark .shiki span {color: var(--shiki-dark);background: var(--shiki-dark-bg);font-style: var(--shiki-dark-font-style);font-weight: var(--shiki-dark-font-weight);text-decoration: var(--shiki-dark-text-decoration);}html pre.shiki code .sAdtL, html code.shiki .sAdtL{--shiki-default:#4078F2;--shiki-dark:#61AFEF}html pre.shiki code .sDhpE, html code.shiki .sDhpE{--shiki-default:#50A14F;--shiki-dark:#98C379}html pre.shiki code .sAGMh, html code.shiki .sAGMh{--shiki-default:#986801;--shiki-dark:#D19A66}html pre.shiki code .s_Sar, html code.shiki .s_Sar{--shiki-default:#0184BC;--shiki-dark:#56B6C2}html pre.shiki code .sJa8x, html code.shiki .sJa8x{--shiki-default:#E45649;--shiki-dark:#E06C75}html pre.shiki code .so_Uh, html code.shiki .so_Uh{--shiki-default:#986801;--shiki-default-font-style:inherit;--shiki-dark:#D19A66;--shiki-dark-font-style:italic}html pre.shiki code .sknuh, html code.shiki .sknuh{--shiki-default:#383A42;--shiki-dark:#56B6C2}",{"title":85,"searchDepth":106,"depth":106,"links":495},[496,497,498,501,502,503,504],{"id":61,"depth":106,"text":62},{"id":187,"depth":106,"text":188},{"id":205,"depth":106,"text":205,"children":499},[500],{"id":396,"depth":115,"text":396},{"id":426,"depth":106,"text":426},{"id":456,"depth":106,"text":456},{"id":477,"depth":106,"text":478},{"id":488,"depth":106,"text":489},"之前趁着春节活动的时候在某 vps 服务商买了 1 年的 vps，线路不算太好，但勉强够用，于是打算在上面部署一些反代程序。在群友的推荐下，发现了这款名为 siteproxy 的开源项目。",[507,513],{"title":508,"path":509,"stem":510,"date":511,"lang":512,"children":-1},"隐式转发——骚套路建站方案","/2023/03/26/implicit-forwarding-is-a-new-site-deploying-method","posts/zh/implicit-forwarding-is-a-new-site-deploying-method","2023-03-26 00:10:02","zh-CN",{"title":514,"path":515,"stem":516,"date":517,"lang":512,"children":-1},"onedrive(by abraunegg) —— 一个 Linux 下的开源 OneDrive 客户端(cli)","/2022/12/24/onedrive-abraunegg-recommendation","posts/zh/onedrive-abraunegg-recommendation","2022-12-24 22:40:13",null,1765307268253]