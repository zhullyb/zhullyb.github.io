[{"data":1,"prerenderedAt":1216},["ShallowReactive",2],{"post-2023-10-29-create-b23tv-remover-bot-zh":3,"has-other-2023-10-29-create-b23tv-remover-bot-zh":1199,"surround-2023-10-29-create-b23tv-remover-bot-zh":1205,"randomIndex/2023/10/29/create-b23tv-remover-bot/":189},{"id":4,"title":5,"body":6,"date":1191,"description":38,"extension":1192,"lang":1193,"meta":1194,"navigation":710,"path":1195,"rawbody":1196,"seo":1197,"stem":1198,"sticky":1199,"tags":1200,"__hash__":1204},"posts/posts/zh/create-b23tv-remover-bot.md","创建 b23.tv 追踪参数移除 bot",{"type":7,"value":8,"toc":1186},"minimark",[9,16,19,22,25,30,33,40,43,53,56,60,63,66,73,76,310,313,315,652,656,659,661,1158,1169,1182],[10,11,12],"blockquote",{},[13,14,15],"p",{},"前两天似乎有人高调宣称自己发 b23.tv 没问题，结果过两天就被拿下的消息。我自己并不是他的粉丝，但这个戏剧性的流言也又一次说明了注重隐私保护的重要性。",[13,17,18],{},"早前就有 b23.tf 和 b23.wtf 两个域名专门在做移除追踪参数的事情。只要将短链接中的 b23.tv 改成 b23.tf ，别人访问链接时就会被转到移除了追踪参数的链接。但这需要发送者在分享时手动更改域名。",[13,20,21],{},"因此，我也开始为自己的 bot 添加了 b23.tv 的 track id 移除功能。当用户的信息中包含 b23.tv 短链接，将会自动发送一条移除了 track id 的信息，用户就可以直接点击无追踪参数的链接。",[13,23,24],{},"当然，这两种方案并不能保护链接分享者的个人信息泄漏，因为 b23.tv 后面的参数是可以被别人看到的，通过这些参数就可以定位到链接分享者的个人信息，所以不能防止群里的内鬼倒查分享者的个人信息，但起码可以阻止大数据算法对群里的几个人产生关联。",[26,27,29],"h2",{"id":28},"b23-短链接将会泄漏哪些个人信息","b23 短链接将会泄漏哪些个人信息？",[13,31,32],{},"通过 curl 命令，我们就可以看到 b23.tv 短链接重定向到了哪个页面。",[13,34,35],{},[36,37],"img",{"alt":38,"src":39},"","https://static.031130.xyz/uploads/2024/08/12/653d49fe955f7.webp",[13,41,42],{},"这是所携带的 GET 请求参数",[44,45,50],"pre",{"className":46,"code":48,"language":49},[47],"language-text"," 'buvid': ['*************************************'],\n 'from_spmid': ['tm.recommend.0.0'],\n 'is_story_h5': ['false'],\n 'mid': ['************************'],\n 'p': ['1'],\n 'plat_id': ['116'],\n 'share_from': ['ugc'],\n 'share_medium': ['android'],\n 'share_plat': ['android'],\n 'share_session_id': ['************************************'],\n 'share_source': ['GENERIC'],\n 'share_tag': ['s_i'],\n 'spmid': ['united.player-video-detail.0.0'],\n 'timestamp': ['**********'],\n 'unique_k': ['*******'],\n 'up_id': ['*********']\n","text",[51,52,48],"code",{"__ignoreMap":38},[13,54,55],{},"其中，我替换成星号的部分都是有可能涉及到信息泄漏的部分，甚至没打码的部分也可以用来推测你的平台信息。",[26,57,59],{"id":58},"qq-bot","QQ Bot",[13,61,62],{},"尽管目前腾讯针对 go-cqhttp 的封杀力度挺大的，但我还在用。",[13,64,65],{},"在 QQ 中的 b23.tv 追踪参数移除主要有两个方面。一是用户发送的消息中可能含有 b23.tv 短链接，二是用户在手机端直接调用 bilibili 自带的「分享到QQ」的功能，这样的话在 QQ 中会显示为小程序，go-cqhttp 接收到的是一个 json 的 CQ Code。",[13,67,68,69,72],{},"针对第一种情况，处理起来就相对简单，首先判断用户的信息中是否存在 ",[51,70,71],{},"b23.tv"," 这一关键词，然后用正则表达式获取完整的 b23 链接，再使用 python 的 requests 库去请求对应链接，返回带有明文追踪参数的 url 后去除 GET 参数即可。",[13,74,75],{},"参考代码如下",[44,77,81],{"className":78,"code":79,"language":80,"meta":38,"style":38},"language-python shiki shiki-themes one-light one-dark-pro","if 'https://b23.tv' in message:\n    pattern = r'https://b23\\.tv/[^\\s]+'\n    urls = re.findall(pattern, message)\n    ret = 'TrackID removed:'\n    for i in urls:\n    ret = ret + '\\n' + b23_to_bvid(i)\n    \ndef b23_to_bvid(url):\n    tracked_url = requests.get(url,allow_redirects=False).headers['location']\n    return tracked_url.split('?', 1)[0]\n","python",[51,82,83,103,143,161,172,187,218,224,243,279],{"__ignoreMap":38},[84,85,88,92,96,99],"span",{"class":86,"line":87},"line",1,[84,89,91],{"class":90},"sLKXg","if",[84,93,95],{"class":94},"sDhpE"," 'https://b23.tv'",[84,97,98],{"class":90}," in",[84,100,102],{"class":101},"s5ixo"," message:\n",[84,104,106,109,113,116,120,124,127,131,134,137,140],{"class":86,"line":105},2,[84,107,108],{"class":101},"    pattern ",[84,110,112],{"class":111},"sknuh","=",[84,114,115],{"class":90}," r",[84,117,119],{"class":118},"sDaw7","'https://b23",[84,121,123],{"class":122},"s_Sar","\\.",[84,125,126],{"class":118},"tv/",[84,128,130],{"class":129},"sYebD","[",[84,132,133],{"class":101},"^",[84,135,136],{"class":118},"\\s",[84,138,139],{"class":129},"]+",[84,141,142],{"class":118},"'\n",[84,144,146,149,151,154,158],{"class":86,"line":145},3,[84,147,148],{"class":101},"    urls ",[84,150,112],{"class":111},[84,152,153],{"class":101}," re.",[84,155,157],{"class":156},"slOjB","findall",[84,159,160],{"class":101},"(pattern, message)\n",[84,162,164,167,169],{"class":86,"line":163},4,[84,165,166],{"class":101},"    ret ",[84,168,112],{"class":111},[84,170,171],{"class":94}," 'TrackID removed:'\n",[84,173,175,178,181,184],{"class":86,"line":174},5,[84,176,177],{"class":90},"    for",[84,179,180],{"class":101}," i ",[84,182,183],{"class":90},"in",[84,185,186],{"class":101}," urls:\n",[84,188,190,192,194,197,200,203,206,209,212,215],{"class":86,"line":189},6,[84,191,166],{"class":101},[84,193,112],{"class":111},[84,195,196],{"class":101}," ret ",[84,198,199],{"class":111},"+",[84,201,202],{"class":94}," '",[84,204,205],{"class":122},"\\n",[84,207,208],{"class":94},"'",[84,210,211],{"class":111}," +",[84,213,214],{"class":156}," b23_to_bvid",[84,216,217],{"class":101},"(i)\n",[84,219,221],{"class":86,"line":220},7,[84,222,223],{"class":101},"    \n",[84,225,227,230,233,236,240],{"class":86,"line":226},8,[84,228,229],{"class":90},"def",[84,231,214],{"class":232},"sAdtL",[84,234,235],{"class":101},"(",[84,237,239],{"class":238},"so_Uh","url",[84,241,242],{"class":101},"):\n",[84,244,246,249,251,254,257,260,264,266,270,273,276],{"class":86,"line":245},9,[84,247,248],{"class":101},"    tracked_url ",[84,250,112],{"class":111},[84,252,253],{"class":101}," requests.",[84,255,256],{"class":156},"get",[84,258,259],{"class":101},"(url,",[84,261,263],{"class":262},"sp7wS","allow_redirects",[84,265,112],{"class":111},[84,267,269],{"class":268},"sAGMh","False",[84,271,272],{"class":101},").headers[",[84,274,275],{"class":94},"'location'",[84,277,278],{"class":101},"]\n",[84,280,282,285,288,291,293,296,299,302,305,308],{"class":86,"line":281},10,[84,283,284],{"class":90},"    return",[84,286,287],{"class":101}," tracked_url.",[84,289,290],{"class":156},"split",[84,292,235],{"class":101},[84,294,295],{"class":94},"'?'",[84,297,298],{"class":101},", ",[84,300,301],{"class":268},"1",[84,303,304],{"class":101},")[",[84,306,307],{"class":268},"0",[84,309,278],{"class":101},[13,311,312],{},"而针对第二种情况，则需要先解析对应的 json 信息，再参考第一种方法获取无追踪参数的链接。",[13,314,75],{},[44,316,318],{"className":78,"code":317,"language":80,"meta":38,"style":38},"if message.startswith('[CQ:json,data') and 'b23.tv' in message:\n    decoded_data = html.unescape(message)\n    match = re.search(r'\\[CQ:json,data=(\\{.*?\\})\\]', decoded_data)\n    json_str = match.group(1)\n    json_data = json.loads(json_str)\n    if json_data['meta'].get('detail_1') is not None:\n        raw_url = json_data['meta'].get('detail_1').get('qqdocurl')\n    elif json_data['meta'].get('news') is not None:\n        raw_url = json_data['meta'].get('news').get('jumpUrl')\n    clean_url = b23_to_bvid(raw_url)\n    \ndef b23_to_bvid(url):\n    tracked_url = requests.get(url,allow_redirects=False).headers['location']\n    return tracked_url.split('?', 1)[0]\n",[51,319,320,348,364,415,435,451,486,517,545,574,586,591,604,629],{"__ignoreMap":38},[84,321,322,324,327,330,332,335,338,341,344,346],{"class":86,"line":87},[84,323,91],{"class":90},[84,325,326],{"class":101}," message.",[84,328,329],{"class":156},"startswith",[84,331,235],{"class":101},[84,333,334],{"class":94},"'[CQ:json,data'",[84,336,337],{"class":101},") ",[84,339,340],{"class":90},"and",[84,342,343],{"class":94}," 'b23.tv'",[84,345,98],{"class":90},[84,347,102],{"class":101},[84,349,350,353,355,358,361],{"class":86,"line":105},[84,351,352],{"class":101},"    decoded_data ",[84,354,112],{"class":111},[84,356,357],{"class":101}," html.",[84,359,360],{"class":156},"unescape",[84,362,363],{"class":101},"(message)\n",[84,365,366,369,371,373,376,378,381,383,386,389,392,395,398,401,404,407,410,412],{"class":86,"line":145},[84,367,368],{"class":101},"    match ",[84,370,112],{"class":111},[84,372,153],{"class":101},[84,374,375],{"class":156},"search",[84,377,235],{"class":101},[84,379,380],{"class":90},"r",[84,382,208],{"class":118},[84,384,385],{"class":122},"\\[",[84,387,388],{"class":118},"CQ:json,data=",[84,390,235],{"class":391},"sYoRg",[84,393,394],{"class":122},"\\{",[84,396,397],{"class":118},".",[84,399,400],{"class":129},"*?",[84,402,403],{"class":122},"\\}",[84,405,406],{"class":391},")",[84,408,409],{"class":122},"\\]",[84,411,208],{"class":118},[84,413,414],{"class":101},", decoded_data)\n",[84,416,417,420,422,425,428,430,432],{"class":86,"line":163},[84,418,419],{"class":101},"    json_str ",[84,421,112],{"class":111},[84,423,424],{"class":101}," match.",[84,426,427],{"class":156},"group",[84,429,235],{"class":101},[84,431,301],{"class":268},[84,433,434],{"class":101},")\n",[84,436,437,440,442,445,448],{"class":86,"line":174},[84,438,439],{"class":101},"    json_data ",[84,441,112],{"class":111},[84,443,444],{"class":101}," json.",[84,446,447],{"class":156},"loads",[84,449,450],{"class":101},"(json_str)\n",[84,452,453,456,459,462,465,467,469,472,474,477,480,483],{"class":86,"line":189},[84,454,455],{"class":90},"    if",[84,457,458],{"class":101}," json_data[",[84,460,461],{"class":94},"'meta'",[84,463,464],{"class":101},"].",[84,466,256],{"class":156},[84,468,235],{"class":101},[84,470,471],{"class":94},"'detail_1'",[84,473,337],{"class":101},[84,475,476],{"class":90},"is",[84,478,479],{"class":90}," not",[84,481,482],{"class":268}," None",[84,484,485],{"class":101},":\n",[84,487,488,491,493,495,497,499,501,503,505,508,510,512,515],{"class":86,"line":220},[84,489,490],{"class":101},"        raw_url ",[84,492,112],{"class":111},[84,494,458],{"class":101},[84,496,461],{"class":94},[84,498,464],{"class":101},[84,500,256],{"class":156},[84,502,235],{"class":101},[84,504,471],{"class":94},[84,506,507],{"class":101},").",[84,509,256],{"class":156},[84,511,235],{"class":101},[84,513,514],{"class":94},"'qqdocurl'",[84,516,434],{"class":101},[84,518,519,522,524,526,528,530,532,535,537,539,541,543],{"class":86,"line":226},[84,520,521],{"class":90},"    elif",[84,523,458],{"class":101},[84,525,461],{"class":94},[84,527,464],{"class":101},[84,529,256],{"class":156},[84,531,235],{"class":101},[84,533,534],{"class":94},"'news'",[84,536,337],{"class":101},[84,538,476],{"class":90},[84,540,479],{"class":90},[84,542,482],{"class":268},[84,544,485],{"class":101},[84,546,547,549,551,553,555,557,559,561,563,565,567,569,572],{"class":86,"line":245},[84,548,490],{"class":101},[84,550,112],{"class":111},[84,552,458],{"class":101},[84,554,461],{"class":94},[84,556,464],{"class":101},[84,558,256],{"class":156},[84,560,235],{"class":101},[84,562,534],{"class":94},[84,564,507],{"class":101},[84,566,256],{"class":156},[84,568,235],{"class":101},[84,570,571],{"class":94},"'jumpUrl'",[84,573,434],{"class":101},[84,575,576,579,581,583],{"class":86,"line":281},[84,577,578],{"class":101},"    clean_url ",[84,580,112],{"class":111},[84,582,214],{"class":156},[84,584,585],{"class":101},"(raw_url)\n",[84,587,589],{"class":86,"line":588},11,[84,590,223],{"class":101},[84,592,594,596,598,600,602],{"class":86,"line":593},12,[84,595,229],{"class":90},[84,597,214],{"class":232},[84,599,235],{"class":101},[84,601,239],{"class":238},[84,603,242],{"class":101},[84,605,607,609,611,613,615,617,619,621,623,625,627],{"class":86,"line":606},13,[84,608,248],{"class":101},[84,610,112],{"class":111},[84,612,253],{"class":101},[84,614,256],{"class":156},[84,616,259],{"class":101},[84,618,263],{"class":262},[84,620,112],{"class":111},[84,622,269],{"class":268},[84,624,272],{"class":101},[84,626,275],{"class":94},[84,628,278],{"class":101},[84,630,632,634,636,638,640,642,644,646,648,650],{"class":86,"line":631},14,[84,633,284],{"class":90},[84,635,287],{"class":101},[84,637,290],{"class":156},[84,639,235],{"class":101},[84,641,295],{"class":94},[84,643,298],{"class":101},[84,645,301],{"class":268},[84,647,304],{"class":101},[84,649,307],{"class":268},[84,651,278],{"class":101},[26,653,655],{"id":654},"tg-bot","TG Bot",[13,657,658],{},"这个平台是提供了 Bot 的 API 的，所以也不用担心会被官方封杀，可惜用户访问起来可能相对困难，也不能要求所有联系人都迁移到这个平台上。思路也是一样的，用 requests 去请求 b23 短链，返回去除跟踪参数的 url。",[13,660,75],{},[44,662,664],{"className":78,"code":663,"language":80,"meta":38,"style":38},"from telegram import Update\nfrom telegram.ext import ApplicationBuilder, ContextTypes, CommandHandler, MessageHandler, filters\nimport requests\nimport re\n\nua = 'Mozilla/5.0 (X11; Linux x86_64; rv:120.0) Gecko/20100101 Firefox/120.0'\n\nasync def start(update: Update, context):\n    await context.bot.send_message(chat_id=update.effective_chat.id, text=\"Hello World!\")\n    \nasync def b23_remover(update: Update, context):\n    seng_msg = 'TrackID removed:'\n    if 'https://b23.tv' in update.message.text:\n        pattern = r'https://b23\\.tv/[^\\s]+'\n        urls = re.findall(pattern, update.message.text)\n        for i in urls:\n            seng_msg += '\\n' + await b23_to_bvid(i)\n        await context.bot.send_message(chat_id=update.effective_chat.id, text=seng_msg)\n        \nasync def b23_to_bvid(url):\n    tracked_url = requests.get(url,allow_redirects=False,headers={'User-Agent': ua}).headers['Location']\n    return tracked_url.split('?', 1)[0]\n    \nstart_handler = CommandHandler(\"start\", start)\nb23_remove_handler = MessageHandler(filters.TEXT, b23_remover)\n\nif __name__ == '__main__':\n    TOKEN='**********************************************'\n    application = ApplicationBuilder().token(TOKEN).build()\n    application.add_handler(start_handler)\n    application.add_handler(b23_remove_handler)\n    application.run_polling()\n\n",[51,665,666,680,692,699,706,712,722,726,757,787,791,814,823,834,859,874,886,910,935,941,956,996,1019,1024,1043,1063,1068,1085,1096,1126,1138,1148],{"__ignoreMap":38},[84,667,668,671,674,677],{"class":86,"line":87},[84,669,670],{"class":90},"from",[84,672,673],{"class":101}," telegram ",[84,675,676],{"class":90},"import",[84,678,679],{"class":101}," Update\n",[84,681,682,684,687,689],{"class":86,"line":105},[84,683,670],{"class":90},[84,685,686],{"class":101}," telegram.ext ",[84,688,676],{"class":90},[84,690,691],{"class":101}," ApplicationBuilder, ContextTypes, CommandHandler, MessageHandler, filters\n",[84,693,694,696],{"class":86,"line":145},[84,695,676],{"class":90},[84,697,698],{"class":101}," requests\n",[84,700,701,703],{"class":86,"line":163},[84,702,676],{"class":90},[84,704,705],{"class":101}," re\n",[84,707,708],{"class":86,"line":174},[84,709,711],{"emptyLinePlaceholder":710},true,"\n",[84,713,714,717,719],{"class":86,"line":189},[84,715,716],{"class":101},"ua ",[84,718,112],{"class":111},[84,720,721],{"class":94}," 'Mozilla/5.0 (X11; Linux x86_64; rv:120.0) Gecko/20100101 Firefox/120.0'\n",[84,723,724],{"class":86,"line":220},[84,725,711],{"emptyLinePlaceholder":710},[84,727,728,731,734,737,739,742,745,749,752,755],{"class":86,"line":226},[84,729,730],{"class":90},"async",[84,732,733],{"class":90}," def",[84,735,736],{"class":232}," start",[84,738,235],{"class":101},[84,740,741],{"class":238},"update",[84,743,744],{"class":101},":",[84,746,748],{"class":747},"sxymB"," Update",[84,750,751],{"class":101},",",[84,753,754],{"class":238}," context",[84,756,242],{"class":101},[84,758,759,762,765,768,770,773,775,778,780,782,785],{"class":86,"line":245},[84,760,761],{"class":90},"    await",[84,763,764],{"class":101}," context.bot.",[84,766,767],{"class":156},"send_message",[84,769,235],{"class":101},[84,771,772],{"class":262},"chat_id",[84,774,112],{"class":111},[84,776,777],{"class":101},"update.effective_chat.id, ",[84,779,49],{"class":262},[84,781,112],{"class":111},[84,783,784],{"class":94},"\"Hello World!\"",[84,786,434],{"class":101},[84,788,789],{"class":86,"line":281},[84,790,223],{"class":101},[84,792,793,795,797,800,802,804,806,808,810,812],{"class":86,"line":588},[84,794,730],{"class":90},[84,796,733],{"class":90},[84,798,799],{"class":232}," b23_remover",[84,801,235],{"class":101},[84,803,741],{"class":238},[84,805,744],{"class":101},[84,807,748],{"class":747},[84,809,751],{"class":101},[84,811,754],{"class":238},[84,813,242],{"class":101},[84,815,816,819,821],{"class":86,"line":593},[84,817,818],{"class":101},"    seng_msg ",[84,820,112],{"class":111},[84,822,171],{"class":94},[84,824,825,827,829,831],{"class":86,"line":606},[84,826,455],{"class":90},[84,828,95],{"class":94},[84,830,98],{"class":90},[84,832,833],{"class":101}," update.message.text:\n",[84,835,836,839,841,843,845,847,849,851,853,855,857],{"class":86,"line":631},[84,837,838],{"class":101},"        pattern ",[84,840,112],{"class":111},[84,842,115],{"class":90},[84,844,119],{"class":118},[84,846,123],{"class":122},[84,848,126],{"class":118},[84,850,130],{"class":129},[84,852,133],{"class":101},[84,854,136],{"class":118},[84,856,139],{"class":129},[84,858,142],{"class":118},[84,860,862,865,867,869,871],{"class":86,"line":861},15,[84,863,864],{"class":101},"        urls ",[84,866,112],{"class":111},[84,868,153],{"class":101},[84,870,157],{"class":156},[84,872,873],{"class":101},"(pattern, update.message.text)\n",[84,875,877,880,882,884],{"class":86,"line":876},16,[84,878,879],{"class":90},"        for",[84,881,180],{"class":101},[84,883,183],{"class":90},[84,885,186],{"class":101},[84,887,889,892,895,897,899,901,903,906,908],{"class":86,"line":888},17,[84,890,891],{"class":101},"            seng_msg ",[84,893,894],{"class":111},"+=",[84,896,202],{"class":94},[84,898,205],{"class":122},[84,900,208],{"class":94},[84,902,211],{"class":111},[84,904,905],{"class":90}," await",[84,907,214],{"class":156},[84,909,217],{"class":101},[84,911,913,916,918,920,922,924,926,928,930,932],{"class":86,"line":912},18,[84,914,915],{"class":90},"        await",[84,917,764],{"class":101},[84,919,767],{"class":156},[84,921,235],{"class":101},[84,923,772],{"class":262},[84,925,112],{"class":111},[84,927,777],{"class":101},[84,929,49],{"class":262},[84,931,112],{"class":111},[84,933,934],{"class":101},"seng_msg)\n",[84,936,938],{"class":86,"line":937},19,[84,939,940],{"class":101},"        \n",[84,942,944,946,948,950,952,954],{"class":86,"line":943},20,[84,945,730],{"class":90},[84,947,733],{"class":90},[84,949,214],{"class":232},[84,951,235],{"class":101},[84,953,239],{"class":238},[84,955,242],{"class":101},[84,957,959,961,963,965,967,969,971,973,975,977,980,982,985,988,991,994],{"class":86,"line":958},21,[84,960,248],{"class":101},[84,962,112],{"class":111},[84,964,253],{"class":101},[84,966,256],{"class":156},[84,968,259],{"class":101},[84,970,263],{"class":262},[84,972,112],{"class":111},[84,974,269],{"class":268},[84,976,751],{"class":101},[84,978,979],{"class":262},"headers",[84,981,112],{"class":111},[84,983,984],{"class":101},"{",[84,986,987],{"class":94},"'User-Agent'",[84,989,990],{"class":101},": ua}).headers[",[84,992,993],{"class":94},"'Location'",[84,995,278],{"class":101},[84,997,999,1001,1003,1005,1007,1009,1011,1013,1015,1017],{"class":86,"line":998},22,[84,1000,284],{"class":90},[84,1002,287],{"class":101},[84,1004,290],{"class":156},[84,1006,235],{"class":101},[84,1008,295],{"class":94},[84,1010,298],{"class":101},[84,1012,301],{"class":268},[84,1014,304],{"class":101},[84,1016,307],{"class":268},[84,1018,278],{"class":101},[84,1020,1022],{"class":86,"line":1021},23,[84,1023,223],{"class":101},[84,1025,1027,1030,1032,1035,1037,1040],{"class":86,"line":1026},24,[84,1028,1029],{"class":101},"start_handler ",[84,1031,112],{"class":111},[84,1033,1034],{"class":156}," CommandHandler",[84,1036,235],{"class":101},[84,1038,1039],{"class":94},"\"start\"",[84,1041,1042],{"class":101},", start)\n",[84,1044,1046,1049,1051,1054,1057,1060],{"class":86,"line":1045},25,[84,1047,1048],{"class":101},"b23_remove_handler ",[84,1050,112],{"class":111},[84,1052,1053],{"class":156}," MessageHandler",[84,1055,1056],{"class":101},"(filters.",[84,1058,1059],{"class":129},"TEXT",[84,1061,1062],{"class":101},", b23_remover)\n",[84,1064,1066],{"class":86,"line":1065},26,[84,1067,711],{"emptyLinePlaceholder":710},[84,1069,1071,1073,1077,1080,1083],{"class":86,"line":1070},27,[84,1072,91],{"class":90},[84,1074,1076],{"class":1075},"sJa8x"," __name__",[84,1078,1079],{"class":111}," ==",[84,1081,1082],{"class":94}," '__main__'",[84,1084,485],{"class":101},[84,1086,1088,1091,1093],{"class":86,"line":1087},28,[84,1089,1090],{"class":129},"    TOKEN",[84,1092,112],{"class":111},[84,1094,1095],{"class":94},"'**********************************************'\n",[84,1097,1099,1102,1104,1107,1110,1113,1115,1118,1120,1123],{"class":86,"line":1098},29,[84,1100,1101],{"class":101},"    application ",[84,1103,112],{"class":111},[84,1105,1106],{"class":156}," ApplicationBuilder",[84,1108,1109],{"class":101},"().",[84,1111,1112],{"class":156},"token",[84,1114,235],{"class":101},[84,1116,1117],{"class":129},"TOKEN",[84,1119,507],{"class":101},[84,1121,1122],{"class":156},"build",[84,1124,1125],{"class":101},"()\n",[84,1127,1129,1132,1135],{"class":86,"line":1128},30,[84,1130,1131],{"class":101},"    application.",[84,1133,1134],{"class":156},"add_handler",[84,1136,1137],{"class":101},"(start_handler)\n",[84,1139,1141,1143,1145],{"class":86,"line":1140},31,[84,1142,1131],{"class":101},[84,1144,1134],{"class":156},[84,1146,1147],{"class":101},"(b23_remove_handler)\n",[84,1149,1151,1153,1156],{"class":86,"line":1150},32,[84,1152,1131],{"class":101},[84,1154,1155],{"class":156},"run_polling",[84,1157,1125],{"class":101},[13,1159,1160,1161,1168],{},"代码编写参考了 ",[1162,1163,1167],"a",{"href":1164,"rel":1165},"https://krau.top/posts/tg-bot-dev-note-kmua",[1166],"nofollow","柯罗krau的博客 | krau's blog","，使用时请注意以下问题:",[1170,1171,1172,1176,1179],"ul",{},[1173,1174,1175],"li",{},"你的机子是否拥有能访问到对应的 api 的网络环境",[1173,1177,1178],{},"botfather 那边是否打开了 allow group",[1173,1180,1181],{},"botfather 那边是否关闭了 privacy mode",[1183,1184,1185],"style",{},"html pre.shiki code .sLKXg, html code.shiki .sLKXg{--shiki-default:#A626A4;--shiki-dark:#C678DD}html pre.shiki code .sDhpE, html code.shiki .sDhpE{--shiki-default:#50A14F;--shiki-dark:#98C379}html pre.shiki code .s5ixo, html code.shiki .s5ixo{--shiki-default:#383A42;--shiki-dark:#ABB2BF}html pre.shiki code .sknuh, html code.shiki .sknuh{--shiki-default:#383A42;--shiki-dark:#56B6C2}html pre.shiki code .sDaw7, html code.shiki .sDaw7{--shiki-default:#0184BC;--shiki-dark:#E06C75}html pre.shiki code .s_Sar, html code.shiki .s_Sar{--shiki-default:#0184BC;--shiki-dark:#56B6C2}html pre.shiki code .sYebD, html code.shiki .sYebD{--shiki-default:#383A42;--shiki-dark:#D19A66}html pre.shiki code .slOjB, html code.shiki .slOjB{--shiki-default:#383A42;--shiki-dark:#61AFEF}html pre.shiki code .sAdtL, html code.shiki .sAdtL{--shiki-default:#4078F2;--shiki-dark:#61AFEF}html pre.shiki code .so_Uh, html code.shiki .so_Uh{--shiki-default:#986801;--shiki-default-font-style:inherit;--shiki-dark:#D19A66;--shiki-dark-font-style:italic}html pre.shiki code .sp7wS, html code.shiki .sp7wS{--shiki-default:#986801;--shiki-default-font-style:inherit;--shiki-dark:#E06C75;--shiki-dark-font-style:italic}html pre.shiki code .sAGMh, html code.shiki .sAGMh{--shiki-default:#986801;--shiki-dark:#D19A66}html .default .shiki span {color: var(--shiki-default);background: var(--shiki-default-bg);font-style: var(--shiki-default-font-style);font-weight: var(--shiki-default-font-weight);text-decoration: var(--shiki-default-text-decoration);}html .shiki span {color: var(--shiki-default);background: var(--shiki-default-bg);font-style: var(--shiki-default-font-style);font-weight: var(--shiki-default-font-weight);text-decoration: var(--shiki-default-text-decoration);}html .dark .shiki span {color: var(--shiki-dark);background: var(--shiki-dark-bg);font-style: var(--shiki-dark-font-style);font-weight: var(--shiki-dark-font-weight);text-decoration: var(--shiki-dark-text-decoration);}html.dark .shiki span {color: var(--shiki-dark);background: var(--shiki-dark-bg);font-style: var(--shiki-dark-font-style);font-weight: var(--shiki-dark-font-weight);text-decoration: var(--shiki-dark-text-decoration);}html pre.shiki code .sYoRg, html code.shiki .sYoRg{--shiki-default:#0184BC;--shiki-dark:#D19A66}html pre.shiki code .sxymB, html code.shiki .sxymB{--shiki-default:#986801;--shiki-dark:#ABB2BF}html pre.shiki code .sJa8x, html code.shiki .sJa8x{--shiki-default:#E45649;--shiki-dark:#E06C75}",{"title":38,"searchDepth":105,"depth":105,"links":1187},[1188,1189,1190],{"id":28,"depth":105,"text":29},{"id":58,"depth":105,"text":59},{"id":654,"depth":105,"text":655},"2023-10-29 00:35:48","md","zh-CN",{},"/2023/10/29/create-b23tv-remover-bot","---\ntitle: 创建 b23.tv 追踪参数移除 bot\ndate: 2023-10-29 00:35:48\nsticky:\ntags:\n- Python\n- Bot\n- Privacy\n---\n\n> 前两天似乎有人高调宣称自己发 b23.tv 没问题，结果过两天就被拿下的消息。我自己并不是他的粉丝，但这个戏剧性的流言也又一次说明了注重隐私保护的重要性。\n\n早前就有 b23.tf 和 b23.wtf 两个域名专门在做移除追踪参数的事情。只要将短链接中的 b23.tv 改成 b23.tf ，别人访问链接时就会被转到移除了追踪参数的链接。但这需要发送者在分享时手动更改域名。\n\n因此，我也开始为自己的 bot 添加了 b23.tv 的 track id 移除功能。当用户的信息中包含 b23.tv 短链接，将会自动发送一条移除了 track id 的信息，用户就可以直接点击无追踪参数的链接。\n\n当然，这两种方案并不能保护链接分享者的个人信息泄漏，因为 b23.tv 后面的参数是可以被别人看到的，通过这些参数就可以定位到链接分享者的个人信息，所以不能防止群里的内鬼倒查分享者的个人信息，但起码可以阻止大数据算法对群里的几个人产生关联。\n\n## b23 短链接将会泄漏哪些个人信息？\n\n通过 curl 命令，我们就可以看到 b23.tv 短链接重定向到了哪个页面。\n\n![](https://static.031130.xyz/uploads/2024/08/12/653d49fe955f7.webp)\n\n这是所携带的 GET 请求参数\n\n```\n 'buvid': ['*************************************'],\n 'from_spmid': ['tm.recommend.0.0'],\n 'is_story_h5': ['false'],\n 'mid': ['************************'],\n 'p': ['1'],\n 'plat_id': ['116'],\n 'share_from': ['ugc'],\n 'share_medium': ['android'],\n 'share_plat': ['android'],\n 'share_session_id': ['************************************'],\n 'share_source': ['GENERIC'],\n 'share_tag': ['s_i'],\n 'spmid': ['united.player-video-detail.0.0'],\n 'timestamp': ['**********'],\n 'unique_k': ['*******'],\n 'up_id': ['*********']\n```\n\n其中，我替换成星号的部分都是有可能涉及到信息泄漏的部分，甚至没打码的部分也可以用来推测你的平台信息。\n\n## QQ Bot\n\n尽管目前腾讯针对 go-cqhttp 的封杀力度挺大的，但我还在用。\n\n在 QQ 中的 b23.tv 追踪参数移除主要有两个方面。一是用户发送的消息中可能含有 b23.tv 短链接，二是用户在手机端直接调用 bilibili 自带的「分享到QQ」的功能，这样的话在 QQ 中会显示为小程序，go-cqhttp 接收到的是一个 json 的 CQ Code。\n\n针对第一种情况，处理起来就相对简单，首先判断用户的信息中是否存在 `b23.tv` 这一关键词，然后用正则表达式获取完整的 b23 链接，再使用 python 的 requests 库去请求对应链接，返回带有明文追踪参数的 url 后去除 GET 参数即可。\n\n参考代码如下\n\n```python\nif 'https://b23.tv' in message:\n\tpattern = r'https://b23\\.tv/[^\\s]+'\n\turls = re.findall(pattern, message)\n    ret = 'TrackID removed:'\n\tfor i in urls:\n\tret = ret + '\\n' + b23_to_bvid(i)\n    \ndef b23_to_bvid(url):\n    tracked_url = requests.get(url,allow_redirects=False).headers['location']\n    return tracked_url.split('?', 1)[0]\n```\n\n而针对第二种情况，则需要先解析对应的 json 信息，再参考第一种方法获取无追踪参数的链接。\n\n参考代码如下\n\n```python\nif message.startswith('[CQ:json,data') and 'b23.tv' in message:\n    decoded_data = html.unescape(message)\n    match = re.search(r'\\[CQ:json,data=(\\{.*?\\})\\]', decoded_data)\n    json_str = match.group(1)\n    json_data = json.loads(json_str)\n    if json_data['meta'].get('detail_1') is not None:\n\t\traw_url = json_data['meta'].get('detail_1').get('qqdocurl')\n\telif json_data['meta'].get('news') is not None:\n\t\traw_url = json_data['meta'].get('news').get('jumpUrl')\n    clean_url = b23_to_bvid(raw_url)\n    \ndef b23_to_bvid(url):\n    tracked_url = requests.get(url,allow_redirects=False).headers['location']\n    return tracked_url.split('?', 1)[0]\n```\n\n## TG Bot\n\n这个平台是提供了 Bot 的 API 的，所以也不用担心会被官方封杀，可惜用户访问起来可能相对困难，也不能要求所有联系人都迁移到这个平台上。思路也是一样的，用 requests 去请求 b23 短链，返回去除跟踪参数的 url。\n\n参考代码如下\n\n```python\nfrom telegram import Update\nfrom telegram.ext import ApplicationBuilder, ContextTypes, CommandHandler, MessageHandler, filters\nimport requests\nimport re\n\nua = 'Mozilla/5.0 (X11; Linux x86_64; rv:120.0) Gecko/20100101 Firefox/120.0'\n\nasync def start(update: Update, context):\n    await context.bot.send_message(chat_id=update.effective_chat.id, text=\"Hello World!\")\n    \nasync def b23_remover(update: Update, context):\n    seng_msg = 'TrackID removed:'\n    if 'https://b23.tv' in update.message.text:\n        pattern = r'https://b23\\.tv/[^\\s]+'\n        urls = re.findall(pattern, update.message.text)\n        for i in urls:\n            seng_msg += '\\n' + await b23_to_bvid(i)\n        await context.bot.send_message(chat_id=update.effective_chat.id, text=seng_msg)\n        \nasync def b23_to_bvid(url):\n    tracked_url = requests.get(url,allow_redirects=False,headers={'User-Agent': ua}).headers['Location']\n    return tracked_url.split('?', 1)[0]\n    \nstart_handler = CommandHandler(\"start\", start)\nb23_remove_handler = MessageHandler(filters.TEXT, b23_remover)\n\nif __name__ == '__main__':\n    TOKEN='**********************************************'\n    application = ApplicationBuilder().token(TOKEN).build()\n    application.add_handler(start_handler)\n    application.add_handler(b23_remove_handler)\n    application.run_polling()\n\n```\n\n代码编写参考了 [柯罗krau的博客 | krau's blog](https://krau.top/posts/tg-bot-dev-note-kmua)，使用时请注意以下问题:\n\n- 你的机子是否拥有能访问到对应的 api 的网络环境\n- botfather 那边是否打开了 allow group\n- botfather 那边是否关闭了 privacy mode\n",{"title":5,"description":38},"posts/zh/create-b23tv-remover-bot",false,[1201,1202,1203],"Python","Bot","Privacy","wyLJ_XC0hNxCGrkFNuLA_1yJ91BUtSBloOYONrDowGE",[1206,1211],{"title":1207,"path":1208,"stem":1209,"date":1210,"children":-1},"使用 Root 后的安卓手机获取向日葵智能插座 C2 的开关 api","/2023/11/01/unveiling-sunflower-smart-adapter-api-intercepting-utilizing-api-android-packet-sniffing","posts/zh/unveiling-sunflower-smart-adapter-api-intercepting-utilizing-api-android-packet-sniffing","2023-11-01 23:46:28",{"title":1212,"path":1213,"stem":1214,"date":1215,"children":-1},"jinja2 中如何优雅地实现换行","/2023/09/03/jinja2-nl-to-br","posts/zh/jinja2-nl-to-br","2023-09-03 13:37:35",1763565787694]