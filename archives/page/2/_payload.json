[{"data":1,"prerenderedAt":8265},["ShallowReactive",2],{"randomIndex/archives/page/2/":3,"index-page-2":4,"posts-nums-total":8264},27,[5,276,2059,2347,2681,3541,4086,5377,5894,7965],{"title":6,"date":7,"path":8,"tags":9,"body":15},"el-image 和 el-table 怎么就打架了？Stacking Context 是什么？","2025-05-31 00:29:40","/2025/05/31/el-image-and-el-table-why-the-fight-and-what-is-a-stacking-context",[10,11,12,13,14],"Vue.js","JavaScript","CSS","HTML","Web",{"type":16,"value":17,"toc":267},"minimark",[18,22,29,39,46,49,55,58,63,114,117,122,125,128,143,146,150,153,184,188,193,196,199,202,205,216,223,226,263],[19,20,21],"p",{},"这是精弘内部的图床开发时遇到的事情，大一的小朋友反馈说 el-image 和 el-table 打架了。",[19,23,24],{},[25,26],"img",{"alt":27,"src":28},"截图","https://static.031130.xyz/uploads/2025/05/31/c6674f6f13955.webp",[19,30,31,38],{},[32,33,37],"a",{"href":34,"rel":35},"https://static.031130.xyz/demo/el-image-el-table-conflict.html",[36],"nofollow","demo"," 的 iframe 引入",[40,41],"iframe",{"src":34,"width":42,"height":43,"allowFullScreen":44,"loading":45},"100%",500,true,"lazy",[19,47,48],{},"看到后面的表格透出 el-image 的预览层，我的第一反应是叫小朋友去检查 z-index 是否正确，el-image 的 mask 遮罩的 z-index 是否大于表格。",[19,50,51],{},[25,52],{"alt":53,"src":54},"","https://static.031130.xyz/uploads/2025/05/31/1c20b4ea0b37e.webp",[19,56,57],{},"经过我本地调试，发现 z-index 的设置确实没问题，但后面的元素为什么会透出来？谷歌搜索一番，找到了这篇文章",[19,59,60],{},[25,61],{"alt":53,"src":62},"https://static.031130.xyz/uploads/2025/05/31/99845899e3524.webp",[64,65,66,69],"blockquote",{},[19,67,68],{},"给 el-table 加一行如下代码即可",[70,71,75],"pre",{"className":72,"code":73,"language":74,"meta":53,"style":53},"language-css shiki shiki-themes one-light one-dark-pro",".el-table__cell {\n    position: static !important;\n}\n","css",[76,77,78,91,108],"code",{"__ignoreMap":53},[79,80,83,87],"span",{"class":81,"line":82},"line",1,[79,84,86],{"class":85},"sAGMh",".el-table__cell",[79,88,90],{"class":89},"s5ixo"," {\n",[79,92,94,97,101,105],{"class":81,"line":93},2,[79,95,96],{"class":89},"    position: ",[79,98,100],{"class":99},"sYebD","static",[79,102,104],{"class":103},"sLKXg"," !important",[79,106,107],{"class":89},";\n",[79,109,111],{"class":81,"line":110},3,[79,112,113],{"class":89},"}\n",[19,115,116],{},"经本地调试确认，这一方案确实能解决问题，但为什么呢？这就涉及到 Stacking Context （层叠上下文）了。",[118,119,121],"h2",{"id":120},"stacking-context层叠上下文究竟是什么","Stacking Context（层叠上下文）究竟是什么？",[19,123,124],{},"简单来说，Stacking Context 可以被类比成画布。在同一块画布上，z-index 值越高的元素就处于越上方，会覆盖掉 z-index 较低的元素，这也是为什么我最开始让检查 z-index 的设置是否有问题。但问题出在 Stacking Context 也是有上下顺序之分的。",[19,126,127],{},"现在假设我们有 A、B 两块画布，在 A 上有一个设置了 z-index 为 1145141919810 的元素。那这个元素具备非常高的优先级，理应出现在浏览器窗口的最上方。但如果 B 画布的优先级高于 A 画布，那么 B 元素上的所有元素都会优先显示（当了躺赢狗）。那么画布靠什么来决定优先级呢？",[129,130,131,138],"ul",{},[132,133,134],"li",{},[135,136,137],"strong",{},"处于同级的 Stacking Context 之间靠 z-index 值来区分优先级",[132,139,140],{},[135,141,142],{},"对于 z-index 值相同的 Stacking Context，在 html 文档中位置靠后的元素拥有更高的优先级",[19,144,145],{},"第二条规则也能解释为什么在上面的 demo 中，只有在表格中位置排在图片元素后面的元素出现了透出来的情况。",[118,147,149],{"id":148},"所以为什么-el-image-和-el-table-打架了","所以为什么 el-image 和 el-table 打架了？",[19,151,152],{},"这次的冲突主要是下面两个因素引起的",[154,155,156,173],"ol",{},[132,157,158,159,162,163,166,170,172],{},"el-table 给每个 cell 都设置了 ",[76,160,161],{},"position: relative"," 的 css 属性，而 position 被设为 relative 时，当前元素就会生成一个 Stacking Context。",[164,165],"br",{},[25,167],{"alt":168,"src":169},"image-20250531013029154","https://static.031130.xyz/uploads/2025/05/31/9df43b865b3c6.webp",[164,171],{},"所以我们这么一个有十个格子的表格，其实就生成了十个画布。而这其中每个画布 z-index 都为 1。根据刚才的规则，在图片格子后面的那些格子对应的 html 代码片段在整体的 html 文档中更靠后，所以他们的优先级都高于图片格子。",[132,174,175,176,178,181,183],{},"el-image 的预览功能所展开的遮罩层处于 el-image 标签内部",[164,177],{},[25,179],{"alt":53,"src":180},"https://static.031130.xyz/uploads/2025/05/31/f18a2b54afd63.webp",[164,182],{},"上图中橙色部分是 el-image 在预览时提供的遮罩，可以看到 element-plus 组件的 image 预览的默认行为是将预览时所需要的遮罩层直接放在 \u003Cel-image> \u003C/el-image> 标签内部，这导致 el-image 的遮罩层被困在一个低优先级的 Stacking Context 中，后面的格子里的内容就是能凭借高优先级透过来。",[118,185,187],{"id":186},"所以解决方案是什么","所以解决方案是什么？",[189,190,192],"h3",{"id":191},"更改-position-值在这里确实是可行的","更改 position 值在这里确实是可行的",[19,194,195],{},"上面我谷歌搜到的将 el-table 中 cell 的 position 值强制设为 static 确实是有效的，因为 static 不会创建新的 Stacking Context，这样就不会有现在的问题。",[189,197,198],{"id":198},"将需要出现在最顶层的代码放置在优先级最大的位置是更常见的方案",[19,200,201],{},"但别的组件库在处理这个需求时，一般会将预览时提供的遮罩的 html 代码片段直接插入到 body 标签内部的最尾部，并设置一个相对比较大的 z-index 值，以确保这个遮罩层能够获得最高的优先级，以此能出现在屏幕的最上方。（像一些 dialog 对话框、popover 悬浮框也都是这个原理）。",[19,203,204],{},"事实上，element-plus 组件库也提供了这个功能",[64,206,207],{},[19,208,209,212,213],{},[135,210,211],{},"preview-teleported:"," image-viewer 是否插入至 body 元素上。嵌套的父元素属性会发生修改时应该将此属性设置为 ",[76,214,215],{},"true",[19,217,218,219,222],{},"所以在使用 el-image 时传入一个 ",[76,220,221],{},":preview-teleported=\"true\""," 是一个更普适的方案，因为我们并不能确保 el-image 的父元素除了 el-table 的 cell 以外还有什么其他的父元素会创建新的 Stacking Context。",[118,224,225],{"id":225},"参见",[129,227,228,235,242,249,256],{},[132,229,230],{},[32,231,234],{"href":232,"rel":233},"https://developer.mozilla.org/en-US/docs/Web/CSS/CSS_positioned_layout/Stacking_context",[36],"层叠上下文 - CSS：层叠样式表 | MDN",[132,236,237],{},[32,238,241],{"href":239,"rel":240},"https://juejin.cn/post/6844903667175260174",[36],"彻底搞懂CSS层叠上下文、层叠等级、层叠顺序、z-index最近，在项目中遇到一个关于CSS中元素z-index属性的问 - 掘金",[132,243,244],{},[32,245,248],{"href":246,"rel":247},"https://www.zhangxinxu.com/wordpress/2016/01/understand-css-stacking-context-order-z-index/",[36],"深入理解CSS中的层叠上下文和层叠顺序 «  张鑫旭-鑫空间-鑫生活",[132,250,251],{},[32,252,255],{"href":253,"rel":254},"https://element-plus.org/zh-CN/component/image.html",[36],"Image 图片 | Element Plus",[132,257,258],{},[32,259,262],{"href":260,"rel":261},"https://blog.csdn.net/qq_61402485/article/details/131202117",[36],"element ui e-image 和e-table一起使用显示问题_el-table el-image-CSDN博客",[264,265,266],"style",{},"html pre.shiki code .sAGMh, html code.shiki .sAGMh{--shiki-default:#986801;--shiki-dark:#D19A66}html pre.shiki code .s5ixo, html code.shiki .s5ixo{--shiki-default:#383A42;--shiki-dark:#ABB2BF}html pre.shiki code .sYebD, html code.shiki .sYebD{--shiki-default:#383A42;--shiki-dark:#D19A66}html pre.shiki code .sLKXg, html code.shiki .sLKXg{--shiki-default:#A626A4;--shiki-dark:#C678DD}html .default .shiki span {color: var(--shiki-default);background: var(--shiki-default-bg);font-style: var(--shiki-default-font-style);font-weight: var(--shiki-default-font-weight);text-decoration: var(--shiki-default-text-decoration);}html .shiki span {color: var(--shiki-default);background: var(--shiki-default-bg);font-style: var(--shiki-default-font-style);font-weight: var(--shiki-default-font-weight);text-decoration: var(--shiki-default-text-decoration);}html .dark .shiki span {color: var(--shiki-dark);background: var(--shiki-dark-bg);font-style: var(--shiki-dark-font-style);font-weight: var(--shiki-dark-font-weight);text-decoration: var(--shiki-dark-text-decoration);}html.dark .shiki span {color: var(--shiki-dark);background: var(--shiki-dark-bg);font-style: var(--shiki-dark-font-style);font-weight: var(--shiki-dark-font-weight);text-decoration: var(--shiki-dark-text-decoration);}",{"title":53,"searchDepth":93,"depth":93,"links":268},[269,270,271,275],{"id":120,"depth":93,"text":121},{"id":148,"depth":93,"text":149},{"id":186,"depth":93,"text":187,"children":272},[273,274],{"id":191,"depth":110,"text":192},{"id":198,"depth":110,"text":198},{"id":225,"depth":93,"text":225},{"title":277,"date":278,"path":279,"tags":280,"body":281},"2025年，前端如何使用 JS 将文本复制到剪切板？","2025-04-21 19:48:05","/2025/04/21/how-we-copy-text-to-clipboard-with-js-in-2025",[11],{"type":16,"value":282,"toc":2042},[283,286,294,302,317,320,576,599,602,610,613,618,640,661,666,677,688,991,1004,1007,1016,1023,1026,1029,1034,1037,1069,1073,1076,1100,1105,1108,1111,1119,1122,1135,1138,1255,1258,1261,1268,1280,1283,1320,1323,1331,1346,1567,1571,1574,1582,1589,1892,1900,1913,1921,1927,1935,1945,1948,1951,1954,1957,1959,2039],[118,284,285],{"id":285},"基础原理",[19,287,288,289],{},"如果你尝试在搜索引擎上检索本文的标题，你搜到的文章大概会让你使用下面两个 API。",[79,290,293],{"className":291},[292],"heimu","我希望你用的搜索引擎不至于像某度一样灵车到 2025 年还在让你使用基于 Flash 的 ZeroClipboard 方案",[189,295,297],{"id":296},"documentexeccommand",[32,298,301],{"href":299,"rel":300},"https://developer.mozilla.org/zh-CN/docs/Web/API/Document/execCommand",[36],"document.execCommand",[19,303,304,305,310,311,316],{},"2012 年不止有世界末日，还有 IE 10。随着 IE 10 在当年 9 月 4 日发布，execCommand 家族迎来了两个新的成员—— copy/cut 命令（此说法来自 ",[32,306,309],{"href":307,"rel":308},"https://developer.chrome.com/blog/cut-and-copy-commands",[36],"Chrome 的博客","，而 ",[32,312,315],{"href":313,"rel":314},"https://web.archive.org/web/20160315042044/https://developer.mozilla.org/zh-CN/docs/Web/API/Document/execCommand",[36],"MDN 认为 IE 9 就已经支持了","）。三年之后，随着 Google Chrome 在 2015 年 4 月 14 日的发布的 42 版本对 execCommand 的 copy/cut 跟进，越来越多的浏览器厂商开始在自家的浏览器中跟进这个实现标准。最终在 2016 年 9 月 13 日发布的 Safari 10 on IOS 后，WEB 开发者们总算获得了历史上第一个非 Flash 实现的 js 复制到剪切板的方案。",[19,318,319],{},"当 document.execCommand 的第一个参数为 copy 时，可以将用户选中的文本复制到剪切板。基于这个 API 实现，很快便有人研究出了当今 web 下最常见的 js 实现——先创建一个不可见的 dom，用 js 操作模拟用户选中文本，并调用 execCommand('copy') 将文本复制到用户的剪切板。大致的代码实现如下：",[70,321,325],{"className":322,"code":323,"language":324,"meta":53,"style":53},"language-javascript shiki shiki-themes one-light one-dark-pro","// 来自「JS复制文字到剪贴板的坑及完整方案。」一文，本文结尾有跳转链接\n\nconst textArea = document.createElement(\"textArea\");\ntextArea.value = val;\ntextArea.style.width = 0;\ntextArea.style.position = \"fixed\";\ntextArea.style.left = \"-999px\";\ntextArea.style.top = \"10px\";\ntextArea.setAttribute(\"readonly\", \"readonly\");\ndocument.body.appendChild(textArea);\n\ntextArea.select();\ndocument.execCommand(\"copy\");\ndocument.body.removeChild(textArea);\n","javascript",[76,326,327,333,338,372,392,414,435,456,477,499,521,526,539,556],{"__ignoreMap":53},[79,328,329],{"class":81,"line":82},[79,330,332],{"class":331},"sW2Sy","// 来自「JS复制文字到剪贴板的坑及完整方案。」一文，本文结尾有跳转链接\n",[79,334,335],{"class":81,"line":93},[79,336,337],{"emptyLinePlaceholder":44},"\n",[79,339,340,343,347,351,355,358,362,365,369],{"class":81,"line":110},[79,341,342],{"class":103},"const",[79,344,346],{"class":345},"sNmU0"," textArea",[79,348,350],{"class":349},"s_Sar"," =",[79,352,354],{"class":353},"s7GmK"," document",[79,356,357],{"class":89},".",[79,359,361],{"class":360},"sAdtL","createElement",[79,363,364],{"class":89},"(",[79,366,368],{"class":367},"sDhpE","\"textArea\"",[79,370,371],{"class":89},");\n",[79,373,375,378,380,384,386,390],{"class":81,"line":374},4,[79,376,377],{"class":353},"textArea",[79,379,357],{"class":89},[79,381,383],{"class":382},"sJa8x","value",[79,385,350],{"class":349},[79,387,389],{"class":388},"sz0mV"," val",[79,391,107],{"class":89},[79,393,395,397,399,402,404,407,409,412],{"class":81,"line":394},5,[79,396,377],{"class":353},[79,398,357],{"class":89},[79,400,264],{"class":401},"s2QsP",[79,403,357],{"class":89},[79,405,406],{"class":382},"width",[79,408,350],{"class":349},[79,410,411],{"class":85}," 0",[79,413,107],{"class":89},[79,415,417,419,421,423,425,428,430,433],{"class":81,"line":416},6,[79,418,377],{"class":353},[79,420,357],{"class":89},[79,422,264],{"class":401},[79,424,357],{"class":89},[79,426,427],{"class":382},"position",[79,429,350],{"class":349},[79,431,432],{"class":367}," \"fixed\"",[79,434,107],{"class":89},[79,436,438,440,442,444,446,449,451,454],{"class":81,"line":437},7,[79,439,377],{"class":353},[79,441,357],{"class":89},[79,443,264],{"class":401},[79,445,357],{"class":89},[79,447,448],{"class":382},"left",[79,450,350],{"class":349},[79,452,453],{"class":367}," \"-999px\"",[79,455,107],{"class":89},[79,457,459,461,463,465,467,470,472,475],{"class":81,"line":458},8,[79,460,377],{"class":353},[79,462,357],{"class":89},[79,464,264],{"class":401},[79,466,357],{"class":89},[79,468,469],{"class":382},"top",[79,471,350],{"class":349},[79,473,474],{"class":367}," \"10px\"",[79,476,107],{"class":89},[79,478,480,482,484,487,489,492,495,497],{"class":81,"line":479},9,[79,481,377],{"class":353},[79,483,357],{"class":89},[79,485,486],{"class":360},"setAttribute",[79,488,364],{"class":89},[79,490,491],{"class":367},"\"readonly\"",[79,493,494],{"class":89},", ",[79,496,491],{"class":367},[79,498,371],{"class":89},[79,500,502,505,507,510,512,515,517,519],{"class":81,"line":501},10,[79,503,504],{"class":353},"document",[79,506,357],{"class":89},[79,508,509],{"class":401},"body",[79,511,357],{"class":89},[79,513,514],{"class":360},"appendChild",[79,516,364],{"class":89},[79,518,377],{"class":388},[79,520,371],{"class":89},[79,522,524],{"class":81,"line":523},11,[79,525,337],{"emptyLinePlaceholder":44},[79,527,529,531,533,536],{"class":81,"line":528},12,[79,530,377],{"class":353},[79,532,357],{"class":89},[79,534,535],{"class":360},"select",[79,537,538],{"class":89},"();\n",[79,540,542,544,546,549,551,554],{"class":81,"line":541},13,[79,543,504],{"class":353},[79,545,357],{"class":89},[79,547,548],{"class":360},"execCommand",[79,550,364],{"class":89},[79,552,553],{"class":367},"\"copy\"",[79,555,371],{"class":89},[79,557,559,561,563,565,567,570,572,574],{"class":81,"line":558},14,[79,560,504],{"class":353},[79,562,357],{"class":89},[79,564,509],{"class":401},[79,566,357],{"class":89},[79,568,569],{"class":360},"removeChild",[79,571,364],{"class":89},[79,573,377],{"class":388},[79,575,371],{"class":89},[19,577,578,579,582,583,588,589,594,595,598],{},"尽管",[135,580,581],{},"这个 API 早已被 w3c 弃用","，在 MDN 被标注为 Deprecated，但这仍然是市面上最常见的方案。在编写本文的时候，我扒了扒 MDN 的英文原始页面在 archive.org 的存档及其在 Github 的变更记录，这个 API 在 ",[32,584,587],{"href":585,"rel":586},"https://web.archive.org/web/20200221235207/https://developer.mozilla.org/en-US/docs/Web/API/Document/execCommand",[36],"2020 年 1~2 月","被首次标记为 Obsolete（过时的），在 ",[32,590,593],{"href":591,"rel":592},"https://github.com/mdn/content/commit/0c31e2bc4d6601a079bc57521e79529539c8cf68#diff-85ef9d1e72565f0ae2ffd8199d10b34c11c615aec5d116057ac2a33c21cc072f",[36],"2021 年 1 月","被首次标记为 Deprecated（已弃用），并附上了红色 Section Background Color 提示开发者该 API 可能",[135,596,597],{},"随时无法正常工作","。但截至本文发布，所有的常用浏览器都保留着对该 API 的兼容，起码在 copy 命令下是这样的。",[19,600,601],{},"这个 API 被广泛应用在了太多站点，以至于移除对该 API 的支持将会导致大量的站点异常，我想各家浏览器内核在短期内恐怕都没有动力以丢失兼容性为代价去移除这个 API，这也意味着这个创建一个不可见的 dom 代替用户选中文本并执行 execCommand 复制到用户剪切板的（看似奇葩的）曲线救国方案已然在前端开发的历史上留下了浓墨重彩的一笔。",[189,603,605],{"id":604},"clipboardwritetext",[32,606,609],{"href":607,"rel":608},"https://developer.mozilla.org/zh-CN/docs/Web/API/Clipboard/writeText",[36],"Clipboard.writeText()",[19,611,612],{},"随着原生 JS 一步步被增强，开发者们总算补上了 Clipboard 这一块的拼图。2018 年 4 月 17 日，Chrome 66 率先迈出了这一步；同年 10 月 23 日，Firefox 跟进了 ClipBoard API 的实现。最终在 2020 年 3 月 24 日，随着 Apple 自家 Safari 13.4 的姗姗来迟，前端开发者门总算喘了口气，再一次得到了一个主流浏览器通用的复制方案。",[19,614,615],{},[135,616,617],{},"那么 execCommand 明明已经实现了纯 js 实现的复制文本到剪切板了，为什么我们还需要 Clipboard API ？或者说，这个特意去实现的 Clipboard API 到底有什么优势？",[154,619,620,623,626,637],{},[132,621,622],{},"传统的 execCommand 方案在使用的时候通常需要创建一个临时的不可见的 DOM，放入文本、用 JS 选中文本、执行 copy 命令。我们暂且不说这种 hacky 的方式在代码编写时是多么不优雅，但一个使用 JS 去选中文本这个操作就会修改用户当前的文本选择状态，在某些时候导致一些用户体验的下降。",[132,624,625],{},"Clipboard API 是异步的，这意味着其在复制大量文本时不会阻塞主线程。",[132,627,628,629,632,633,636],{},"Clipboard API 提供了更多的能力，比如 ",[76,630,631],{},"write()"," 和 ",[76,634,635],{},"read()"," 允许对剪切板读写更复杂的数据，比如富文本或图片。",[132,638,639],{},"Clipboard API 具有更现代、更明确的权限控制—— write 操作需要由用户的主动操作来调用，read 操作则需要用户在浏览器 UI 上明确授予权限。这些权限控制给予了用户更大的控制权，因此，当 execCommand 退出历史的舞台后，WEB 的安全性将得到进一步提升。",[19,641,642,643,645,646,649,650,653,654,656,657,660],{},"不过在现阶段，",[76,644,609],{}," 未必就能解决所有的问题。抛开旧版浏览器的兼容性问题不谈，",[76,647,648],{},"navigator.clipboard"," ",[135,651,652],{},"仅在通过 https 访问的页面中可用","（或是 localhost），如果你的项目部署在局域网，你试图通过 192.18.1.x 的 ip + port 直接访问，那么 ",[76,655,648],{}," 将会是 ",[76,658,659],{},"undefined"," 状态。",[19,662,663],{},[25,664],{"alt":53,"src":665},"https://static.031130.xyz/uploads/2025/04/19/3437b1c022853.webp",[19,667,668,669,672,673,676],{},"除此之外，",[135,670,671],{},"安卓原生的 Webview"," 还有因为 Permissions API 没实现而",[135,674,675],{},"用不了"," Clipboard API 的问题。",[19,678,679,680,683,684,687],{},"基于以上原因，很多网站现在都会优先尝试使用 ",[76,681,682],{},"navigator.clipboard.writeText()","，失败后再转去使用 ",[76,685,686],{},"execCommand('copy')","。大致的代码实现如下：",[70,689,691],{"className":322,"code":690,"language":324,"meta":53,"style":53},"// 来自「JS复制文字到剪贴板的坑及完整方案。」一文，本文结尾有跳转链接\n\nconst copyText = async val => {\n  if (navigator.clipboard && navigator.permissions) {\n    await navigator.clipboard.writeText(val);\n  } else {\n    const textArea = document.createElement(\"textArea\");\n    textArea.value = val;\n    textArea.style.width = 0;\n    textArea.style.position = \"fixed\";\n    textArea.style.left = \"-999px\";\n    textArea.style.top = \"10px\";\n    textArea.setAttribute(\"readonly\", \"readonly\");\n    document.body.appendChild(textArea);\n\n    textArea.select();\n    document.execCommand(\"copy\");\n    document.body.removeChild(textArea);\n  }\n};\n",[76,692,693,697,701,721,751,774,784,805,820,838,856,874,892,910,929,934,945,960,979,985],{"__ignoreMap":53},[79,694,695],{"class":81,"line":82},[79,696,332],{"class":331},[79,698,699],{"class":81,"line":93},[79,700,337],{"emptyLinePlaceholder":44},[79,702,703,705,708,710,713,716,719],{"class":81,"line":110},[79,704,342],{"class":103},[79,706,707],{"class":360}," copyText",[79,709,350],{"class":349},[79,711,712],{"class":103}," async",[79,714,389],{"class":715},"s8iYz",[79,717,718],{"class":103}," =>",[79,720,90],{"class":89},[79,722,723,726,729,732,734,737,740,743,745,748],{"class":81,"line":374},[79,724,725],{"class":103},"  if",[79,727,728],{"class":89}," (",[79,730,731],{"class":353},"navigator",[79,733,357],{"class":89},[79,735,736],{"class":382},"clipboard",[79,738,739],{"class":349}," &&",[79,741,742],{"class":353}," navigator",[79,744,357],{"class":89},[79,746,747],{"class":382},"permissions",[79,749,750],{"class":89},") {\n",[79,752,753,756,758,760,762,764,767,769,772],{"class":81,"line":394},[79,754,755],{"class":103},"    await",[79,757,742],{"class":353},[79,759,357],{"class":89},[79,761,736],{"class":401},[79,763,357],{"class":89},[79,765,766],{"class":360},"writeText",[79,768,364],{"class":89},[79,770,771],{"class":388},"val",[79,773,371],{"class":89},[79,775,776,779,782],{"class":81,"line":416},[79,777,778],{"class":89},"  } ",[79,780,781],{"class":103},"else",[79,783,90],{"class":89},[79,785,786,789,791,793,795,797,799,801,803],{"class":81,"line":437},[79,787,788],{"class":103},"    const",[79,790,346],{"class":345},[79,792,350],{"class":349},[79,794,354],{"class":353},[79,796,357],{"class":89},[79,798,361],{"class":360},[79,800,364],{"class":89},[79,802,368],{"class":367},[79,804,371],{"class":89},[79,806,807,810,812,814,816,818],{"class":81,"line":458},[79,808,809],{"class":353},"    textArea",[79,811,357],{"class":89},[79,813,383],{"class":382},[79,815,350],{"class":349},[79,817,389],{"class":388},[79,819,107],{"class":89},[79,821,822,824,826,828,830,832,834,836],{"class":81,"line":479},[79,823,809],{"class":353},[79,825,357],{"class":89},[79,827,264],{"class":401},[79,829,357],{"class":89},[79,831,406],{"class":382},[79,833,350],{"class":349},[79,835,411],{"class":85},[79,837,107],{"class":89},[79,839,840,842,844,846,848,850,852,854],{"class":81,"line":501},[79,841,809],{"class":353},[79,843,357],{"class":89},[79,845,264],{"class":401},[79,847,357],{"class":89},[79,849,427],{"class":382},[79,851,350],{"class":349},[79,853,432],{"class":367},[79,855,107],{"class":89},[79,857,858,860,862,864,866,868,870,872],{"class":81,"line":523},[79,859,809],{"class":353},[79,861,357],{"class":89},[79,863,264],{"class":401},[79,865,357],{"class":89},[79,867,448],{"class":382},[79,869,350],{"class":349},[79,871,453],{"class":367},[79,873,107],{"class":89},[79,875,876,878,880,882,884,886,888,890],{"class":81,"line":528},[79,877,809],{"class":353},[79,879,357],{"class":89},[79,881,264],{"class":401},[79,883,357],{"class":89},[79,885,469],{"class":382},[79,887,350],{"class":349},[79,889,474],{"class":367},[79,891,107],{"class":89},[79,893,894,896,898,900,902,904,906,908],{"class":81,"line":541},[79,895,809],{"class":353},[79,897,357],{"class":89},[79,899,486],{"class":360},[79,901,364],{"class":89},[79,903,491],{"class":367},[79,905,494],{"class":89},[79,907,491],{"class":367},[79,909,371],{"class":89},[79,911,912,915,917,919,921,923,925,927],{"class":81,"line":558},[79,913,914],{"class":353},"    document",[79,916,357],{"class":89},[79,918,509],{"class":401},[79,920,357],{"class":89},[79,922,514],{"class":360},[79,924,364],{"class":89},[79,926,377],{"class":388},[79,928,371],{"class":89},[79,930,932],{"class":81,"line":931},15,[79,933,337],{"emptyLinePlaceholder":44},[79,935,937,939,941,943],{"class":81,"line":936},16,[79,938,809],{"class":353},[79,940,357],{"class":89},[79,942,535],{"class":360},[79,944,538],{"class":89},[79,946,948,950,952,954,956,958],{"class":81,"line":947},17,[79,949,914],{"class":353},[79,951,357],{"class":89},[79,953,548],{"class":360},[79,955,364],{"class":89},[79,957,553],{"class":367},[79,959,371],{"class":89},[79,961,963,965,967,969,971,973,975,977],{"class":81,"line":962},18,[79,964,914],{"class":353},[79,966,357],{"class":89},[79,968,509],{"class":401},[79,970,357],{"class":89},[79,972,569],{"class":360},[79,974,364],{"class":89},[79,976,377],{"class":388},[79,978,371],{"class":89},[79,980,982],{"class":81,"line":981},19,[79,983,984],{"class":89},"  }\n",[79,986,988],{"class":81,"line":987},20,[79,989,990],{"class":89},"};\n",[189,992,994],{"id":993},"flash-方案zeroclipboard",[995,996,997,998,1003],"del",{},"Flash 方案（",[32,999,1002],{"href":1000,"rel":1001},"https://github.com/zeroclipboard/zeroclipboard",[36],"ZeroClipboard","）",[19,1005,1006],{},"其实上面两个 API 差不多就把基础原理讲完了，不过我在查资料的时候发现，在 execCommand 方案之前，前端居然大多是依靠 Flash 来实现复制文本到剪切板的，这不得拿出来讲讲？",[19,1008,1009,1010,1015],{},"目前在 ZeroClipboard 的 Github 仓库能找到的最老的 tag 是 ",[32,1011,1014],{"href":1012,"rel":1013},"https://github.com/zeroclipboard/zeroclipboard/releases/tag/v1.0.7",[36],"v1.0.7","，发布于 2012 年 6 月 9 日。我打赌这个项目不是第一个通过 Flash 实现复制文本到剪切板的，在此之前肯定有人使用 Flash 实现过这个功能，只是没单独拎出来作为一个库开源出来。",[19,1017,1018,1019,1022],{},"ZeroClipboard 通过创建一个透明的 Flash Movie 覆盖在触发按钮上，当用户点击按钮时，实际上点到的是 Flash Movie，随后 JavaScript 与 Flash Movie 通过 ",[76,1020,1021],{},"ExternalInterface"," 进行通信，将需要复制的文本传递给 Flash，再经 Flash 的 API 将文本写入用户的剪切板。",[19,1024,1025],{},"在当时的时代背景下，这是唯一一个能够跨浏览器实现复制文本到剪切板的方案（尽管并不是每台电脑都装有 Flash，尽管 IOS 并不支持 Flash），6.6k star 的 Github 仓库见证了那个各家浏览器抱着各家私有 API 的混沌时代，最终随着 execCommand 方案的崛起，ZeroClipboard 与 Flash 一同落幕。",[189,1027,1028],{"id":1028},"其他不完美的方案",[1030,1031,1033],"h4",{"id":1032},"windowclipboarddatasetdata","window.clipboardData.setData",[19,1035,1036],{},"该 API 主要在 2000 年 —2010 年前后被使用，仅适用于 IE 浏览器。Firefox 在这段时间里还不支持纯 js 实现的复制文本至浏览器的操作；Chrome 第一个版本在 2008 年才发布，尚未成为主流。",[70,1038,1040],{"className":322,"code":1039,"language":324,"meta":53,"style":53},"window.clipboardData.setData(\"Text\", text2copy);\n",[76,1041,1042],{"__ignoreMap":53},[79,1043,1044,1047,1049,1052,1054,1057,1059,1062,1064,1067],{"class":81,"line":82},[79,1045,1046],{"class":353},"window",[79,1048,357],{"class":89},[79,1050,1051],{"class":401},"clipboardData",[79,1053,357],{"class":89},[79,1055,1056],{"class":360},"setData",[79,1058,364],{"class":89},[79,1060,1061],{"class":367},"\"Text\"",[79,1063,494],{"class":89},[79,1065,1066],{"class":388},"text2copy",[79,1068,371],{"class":89},[1030,1070,1072],{"id":1071},"摆烂prompt","摆烂（prompt）",[19,1074,1075],{},"调 prompt 弹窗让用户自己复制。",[70,1077,1079],{"className":322,"code":1078,"language":324,"meta":53,"style":53},"prompt('Press Ctrl + C, then Enter to copy to clipboard','copy me')\n",[76,1080,1081],{"__ignoreMap":53},[79,1082,1083,1086,1088,1091,1094,1097],{"class":81,"line":82},[79,1084,1085],{"class":360},"prompt",[79,1087,364],{"class":89},[79,1089,1090],{"class":367},"'Press Ctrl + C, then Enter to copy to clipboard'",[79,1092,1093],{"class":89},",",[79,1095,1096],{"class":367},"'copy me'",[79,1098,1099],{"class":89},")\n",[19,1101,1102],{},[25,1103],{"alt":53,"src":1104},"https://static.031130.xyz/uploads/2025/04/19/7f5310ca03c80.webp",[118,1106,1107],{"id":1107},"第三方库封装",[19,1109,1110],{},"由于 execCommand 的方案过于抽象，不够优雅，所以我们有一些现成的第三方库对复制到剪切板的代码进行了封装。",[189,1112,1114],{"id":1113},"clipboardjs",[32,1115,1118],{"href":1116,"rel":1117},"https://github.com/zenorocha/clipboard.js/",[36],"clipboard.js",[19,1120,1121],{},"clipboard.js 是最负盛名的一款第三方库，截至本文完成时间，在 Github 共收获 34.1k 的 star。最早的一个 tag 版本发布于 2015 年 10 月 28 日，也就是 Firefox 支持 execCommand、PC 端三大浏览器巨头全面兼容的一个月后。",[19,1123,1124,1125,1130,1131,1134],{},"clipboard.js ",[32,1126,1129],{"href":1127,"rel":1128},"https://github.com/zenorocha/clipboard.js/blob/master/src/common/command.js",[36],"仅使用 execCommand"," 实现复制到剪切板的操作，项目的 owner 希望开发者自行使用 ",[76,1132,1133],{},"ClipboardJS.isSupported()"," 来判断用户的浏览器是否支持 execCommand 方案，并根据命令执行的返回值自行安排成功/失败后的动作。。",[19,1136,1137],{},"不过让我感到奇怪的是，clipboard.js 在实例化时会要求开发者传入一个 DOM 选择（或者是 HTML 元素/元素列表）。它一定要有一个实体的 html 元素，用设置事件监听器来触发复制操作，而不是提供一个 js 函数让开发者来调用——尽管这不是来自 execCommand 的限制。示例如下",[70,1139,1143],{"className":1140,"code":1141,"language":1142,"meta":53,"style":53},"language-html shiki shiki-themes one-light one-dark-pro","\u003C!-- Target -->\n\u003Cinput id=\"foo\" value=\"text2copy\" />\n\n\u003C!-- Trigger -->\n\u003Cbutton class=\"btn\" data-clipboard-target=\"#foo\">\u003C/button>\n\n\u003Cscript>\n    new ClipboardJS('.btn');\n\u003C/script>\n","html",[76,1144,1145,1150,1178,1182,1187,1218,1222,1231,1246],{"__ignoreMap":53},[79,1146,1147],{"class":81,"line":82},[79,1148,1149],{"class":331},"\u003C!-- Target -->\n",[79,1151,1152,1155,1158,1161,1164,1167,1170,1172,1175],{"class":81,"line":93},[79,1153,1154],{"class":89},"\u003C",[79,1156,1157],{"class":382},"input",[79,1159,1160],{"class":85}," id",[79,1162,1163],{"class":89},"=",[79,1165,1166],{"class":367},"\"foo\"",[79,1168,1169],{"class":85}," value",[79,1171,1163],{"class":89},[79,1173,1174],{"class":367},"\"text2copy\"",[79,1176,1177],{"class":89}," />\n",[79,1179,1180],{"class":81,"line":110},[79,1181,337],{"emptyLinePlaceholder":44},[79,1183,1184],{"class":81,"line":374},[79,1185,1186],{"class":331},"\u003C!-- Trigger -->\n",[79,1188,1189,1191,1194,1197,1199,1202,1205,1207,1210,1213,1215],{"class":81,"line":394},[79,1190,1154],{"class":89},[79,1192,1193],{"class":382},"button",[79,1195,1196],{"class":85}," class",[79,1198,1163],{"class":89},[79,1200,1201],{"class":367},"\"btn\"",[79,1203,1204],{"class":85}," data-clipboard-target",[79,1206,1163],{"class":89},[79,1208,1209],{"class":367},"\"#foo\"",[79,1211,1212],{"class":89},">\u003C/",[79,1214,1193],{"class":382},[79,1216,1217],{"class":89},">\n",[79,1219,1220],{"class":81,"line":416},[79,1221,337],{"emptyLinePlaceholder":44},[79,1223,1224,1226,1229],{"class":81,"line":437},[79,1225,1154],{"class":89},[79,1227,1228],{"class":382},"script",[79,1230,1217],{"class":89},[79,1232,1233,1236,1239,1241,1244],{"class":81,"line":458},[79,1234,1235],{"class":103},"    new",[79,1237,1238],{"class":360}," ClipboardJS",[79,1240,364],{"class":89},[79,1242,1243],{"class":367},"'.btn'",[79,1245,371],{"class":89},[79,1247,1248,1251,1253],{"class":81,"line":479},[79,1249,1250],{"class":89},"\u003C/",[79,1252,1228],{"class":382},[79,1254,1217],{"class":89},[19,1256,1257],{},"对，就一行 js 就能给所有带有 btn class 的 dom 加上监听器。或许这就是为什么这个仓库能获得 34.1k star 的原因，在 2015 年那个大多数人还在用三件套写前端的时代，clipboard.js 能够降低代码量，不用开发者自行设置监听器。",[19,1259,1260],{},"clipboard.js 当然也提供了很多高级选项来满足不同开发者的需求，比如允许你通过传入一个 function 来获取你需要让用户复制的文本而，或是通过 Event 监听器来反馈是否复制成功，总之灵活性是够用的。",[189,1262,1264],{"id":1263},"copy-to-clipboard",[32,1265,1263],{"href":1266,"rel":1267},"https://github.com/sudodoki/copy-to-clipboard",[36],[19,1269,1270,1271,1276,1277,1279],{},"同样是一款",[32,1272,1275],{"href":1273,"rel":1274},"https://github.com/sudodoki/copy-to-clipboard/blob/main/index.js#L79",[36],"利用 execCommand"," 的第三方库，虽然只有 1.3k star。第一个 tag 版本发布于 2015 年的 5 月 24 日，比 clipboard.js 还要早。相比起 clipboard.js，copy-to-clipboard 不依赖 html 元素，可以直接在 js 中被调用，我个人是比较喜欢这个的。在 vue/react 等现代化的前端框架中，我们一般不直接操作 dom，因此并不是很适合使用 clipboard.js，这个 copy-to-clipboard 就挺好的。此外，除了 execCommand 与方案，copy-to-clipboard 还对老版本的 IE 浏览器针对性的适配了 ",[76,1278,1033],{}," 的方案，并且在两者都失败时会调用 prompt 窗口让用户自主复制实现最终的兜底。",[19,1281,1282],{},"示例如下:",[70,1284,1286],{"className":322,"code":1285,"language":324,"meta":53,"style":53},"import copy from 'copy-to-clipboard';\n\ncopy('Text');\n",[76,1287,1288,1304,1308],{"__ignoreMap":53},[79,1289,1290,1293,1296,1299,1302],{"class":81,"line":82},[79,1291,1292],{"class":103},"import",[79,1294,1295],{"class":382}," copy",[79,1297,1298],{"class":103}," from",[79,1300,1301],{"class":367}," 'copy-to-clipboard'",[79,1303,107],{"class":89},[79,1305,1306],{"class":81,"line":93},[79,1307,337],{"emptyLinePlaceholder":44},[79,1309,1310,1313,1315,1318],{"class":81,"line":110},[79,1311,1312],{"class":360},"copy",[79,1314,364],{"class":89},[79,1316,1317],{"class":367},"'Text'",[79,1319,371],{"class":89},[19,1321,1322],{},"相比起 clipboard.js 的使用思路是更加直观了，可惜生不逢时，不如 clipboard.js 出名（也可能有取名的原因在里面）。",[189,1324,1326],{"id":1325},"vueuse-useclipboard",[32,1327,1330],{"href":1328,"rel":1329},"https://vueuse.org/core/useClipboard/",[36],"VueUse - useClipboard",[19,1332,1333,1334,1339,1340,649,1342,1345],{},"VueUse 实现的这个 useClipboard 是令我最为满意的一个。useClipboard 充分考虑了浏览器的兼容性，在检测到满足 navigator.clipboard 的使用条件时",[135,1335,1336,1337],{},"优先使用 ",[76,1338,682],{}," ，在不支持 navigator.clipboard 或者 ",[76,1341,682],{},[135,1343,1344],{},"复制失败时转去使用 execCommand 实现的 legacyCopy","，并且借助 Vue3 中的 Composables 实现了一个 1.5 秒后自动恢复初始状态的 copied 变量，算是很有心了。",[70,1347,1351],{"className":1348,"code":1349,"language":1350,"meta":53,"style":53},"language-vue shiki shiki-themes one-light one-dark-pro","const { text, copy, copied, isSupported } = useClipboard({ source })\n\u003C/script>\n\n\u003Ctemplate>\n  \u003Cdiv v-if=\"isSupported\">\n    \u003Cbutton @click=\"copy(source)\">\n      \u003C!-- by default, `copied` will be reset in 1.5s -->\n      \u003Cspan v-if=\"!copied\">Copy\u003C/span>\n      \u003Cspan v-else>Copied!\u003C/span>\n    \u003C/button>\n    \u003Cp>Current copied: \u003Ccode>{{ text || 'none' }}\u003C/code>\u003C/p>\n  \u003C/div>\n  \u003Cp v-else>\n    Your browser does not support Clipboard API\n  \u003C/p>\n\u003C/template>\n","vue",[76,1352,1353,1358,1366,1370,1379,1399,1410,1442,1461,1478,1487,1527,1536,1546,1551,1559],{"__ignoreMap":53},[79,1354,1355],{"class":81,"line":82},[79,1356,1357],{"class":89},"const { text, copy, copied, isSupported } = useClipboard({ source })\n",[79,1359,1360,1362,1364],{"class":81,"line":93},[79,1361,1250],{"class":89},[79,1363,1228],{"class":382},[79,1365,1217],{"class":89},[79,1367,1368],{"class":81,"line":110},[79,1369,337],{"emptyLinePlaceholder":44},[79,1371,1372,1374,1377],{"class":81,"line":374},[79,1373,1154],{"class":89},[79,1375,1376],{"class":382},"template",[79,1378,1217],{"class":89},[79,1380,1381,1384,1387,1391,1394,1397],{"class":81,"line":394},[79,1382,1383],{"class":89},"  \u003C",[79,1385,1386],{"class":382},"div",[79,1388,1390],{"class":1389},"so_Uh"," v-if",[79,1392,1163],{"class":1393},"sknuh",[79,1395,1396],{"class":367},"\"isSupported\"",[79,1398,1217],{"class":89},[79,1400,1401,1404,1406],{"class":81,"line":416},[79,1402,1403],{"class":89},"    \u003C",[79,1405,1193],{"class":382},[79,1407,1409],{"class":1408},"sUNH4"," @click=\"copy(source)\">\n",[79,1411,1412,1415,1418,1421,1424,1427,1430,1433,1436,1439],{"class":81,"line":437},[79,1413,1414],{"class":1408},"      \u003C!--",[79,1416,1417],{"class":1389}," by",[79,1419,1420],{"class":1408}," default,",[79,1422,1423],{"class":1408}," `copied`",[79,1425,1426],{"class":1389}," will",[79,1428,1429],{"class":1389}," be",[79,1431,1432],{"class":1389}," reset",[79,1434,1435],{"class":1389}," in",[79,1437,1438],{"class":1408}," 1.5s",[79,1440,1441],{"class":1408}," -->\n",[79,1443,1444,1447,1449,1451,1454,1457,1459],{"class":81,"line":458},[79,1445,1446],{"class":1408},"      \u003Cspan",[79,1448,1390],{"class":1389},[79,1450,1163],{"class":1393},[79,1452,1453],{"class":367},"\"!copied\"",[79,1455,1456],{"class":89},">Copy\u003C/",[79,1458,79],{"class":382},[79,1460,1217],{"class":89},[79,1462,1463,1466,1468,1471,1474,1476],{"class":81,"line":479},[79,1464,1465],{"class":89},"      \u003C",[79,1467,79],{"class":382},[79,1469,1470],{"class":1389}," v-else",[79,1472,1473],{"class":89},">Copied!\u003C/",[79,1475,79],{"class":382},[79,1477,1217],{"class":89},[79,1479,1480,1483,1485],{"class":81,"line":501},[79,1481,1482],{"class":89},"    \u003C/",[79,1484,1193],{"class":382},[79,1486,1217],{"class":89},[79,1488,1489,1491,1493,1496,1498,1501,1505,1508,1511,1514,1517,1519,1521,1523,1525],{"class":81,"line":523},[79,1490,1403],{"class":89},[79,1492,19],{"class":382},[79,1494,1495],{"class":89},">Current copied: \u003C",[79,1497,76],{"class":382},[79,1499,1500],{"class":89},">",[79,1502,1504],{"class":1503},"sAOjX","{",[79,1506,1507],{"class":89},"{ text || ",[79,1509,1510],{"class":367},"'none'",[79,1512,1513],{"class":89}," }",[79,1515,1516],{"class":1503},"}",[79,1518,1250],{"class":89},[79,1520,76],{"class":382},[79,1522,1212],{"class":89},[79,1524,19],{"class":382},[79,1526,1217],{"class":89},[79,1528,1529,1532,1534],{"class":81,"line":528},[79,1530,1531],{"class":89},"  \u003C/",[79,1533,1386],{"class":382},[79,1535,1217],{"class":89},[79,1537,1538,1540,1542,1544],{"class":81,"line":541},[79,1539,1383],{"class":89},[79,1541,19],{"class":382},[79,1543,1470],{"class":1389},[79,1545,1217],{"class":89},[79,1547,1548],{"class":81,"line":558},[79,1549,1550],{"class":89},"    Your browser does not support Clipboard API\n",[79,1552,1553,1555,1557],{"class":81,"line":931},[79,1554,1531],{"class":89},[79,1556,19],{"class":382},[79,1558,1217],{"class":89},[79,1560,1561,1563,1565],{"class":81,"line":936},[79,1562,1250],{"class":349},[79,1564,1376],{"class":388},[79,1566,1217],{"class":349},[189,1568,1570],{"id":1569},"react-相关生态","React 相关生态",[19,1572,1573],{},"React 这边不像 VueUse 一家独大，出现了很多可用的 hooks 库，那就全都过一遍",[1030,1575,1577],{"id":1576},"react-use-usecopytoclipboard",[32,1578,1581],{"href":1579,"rel":1580},"https://github.com/streamich/react-use",[36],"react-use - useCopyToClipboard",[19,1583,1584,1585,1588],{},"react-use 是我能搜到的目前最大的 React Hooks 库，42.9k star。采用的复制方案是直接依赖上面介绍过的 ",[32,1586,1263],{"href":1266,"rel":1587},[36],"，也就是 execCommand 方案。",[70,1590,1594],{"className":1591,"code":1592,"language":1593,"meta":53,"style":53},"language-jsx shiki shiki-themes one-light one-dark-pro","const Demo = () => {\n  const [text, setText] = React.useState('');\n  const [state, copyToClipboard] = useCopyToClipboard();\n\n  return (\n    \u003Cdiv>\n      \u003Cinput value={text} onChange={e => setText(e.target.value)} />\n      \u003Cbutton type=\"button\" onClick={() => copyToClipboard(text)}>copy text\u003C/button>\n      {state.error\n        ? \u003Cp>Unable to copy value: {state.error.message}\u003C/p>\n        : state.value && \u003Cp>Copied {state.value}\u003C/p>}\n    \u003C/div>\n  )\n}\n","jsx",[76,1595,1596,1613,1649,1672,1676,1684,1692,1744,1788,1800,1836,1875,1883,1888],{"__ignoreMap":53},[79,1597,1598,1600,1603,1605,1608,1611],{"class":81,"line":82},[79,1599,342],{"class":103},[79,1601,1602],{"class":360}," Demo",[79,1604,350],{"class":349},[79,1606,1607],{"class":89}," () ",[79,1609,1610],{"class":103},"=>",[79,1612,90],{"class":89},[79,1614,1615,1618,1621,1624,1626,1629,1632,1634,1637,1639,1642,1644,1647],{"class":81,"line":93},[79,1616,1617],{"class":103},"  const",[79,1619,1620],{"class":89}," [",[79,1622,1623],{"class":345},"text",[79,1625,494],{"class":89},[79,1627,1628],{"class":345},"setText",[79,1630,1631],{"class":89},"] ",[79,1633,1163],{"class":349},[79,1635,1636],{"class":353}," React",[79,1638,357],{"class":89},[79,1640,1641],{"class":360},"useState",[79,1643,364],{"class":89},[79,1645,1646],{"class":367},"''",[79,1648,371],{"class":89},[79,1650,1651,1653,1655,1658,1660,1663,1665,1667,1670],{"class":81,"line":110},[79,1652,1617],{"class":103},[79,1654,1620],{"class":89},[79,1656,1657],{"class":345},"state",[79,1659,494],{"class":89},[79,1661,1662],{"class":345},"copyToClipboard",[79,1664,1631],{"class":89},[79,1666,1163],{"class":349},[79,1668,1669],{"class":360}," useCopyToClipboard",[79,1671,538],{"class":89},[79,1673,1674],{"class":81,"line":374},[79,1675,337],{"emptyLinePlaceholder":44},[79,1677,1678,1681],{"class":81,"line":394},[79,1679,1680],{"class":103},"  return",[79,1682,1683],{"class":89}," (\n",[79,1685,1686,1688,1690],{"class":81,"line":416},[79,1687,1403],{"class":89},[79,1689,1386],{"class":382},[79,1691,1217],{"class":89},[79,1693,1694,1696,1698,1700,1702,1705,1707,1709,1712,1714,1716,1719,1721,1724,1726,1728,1730,1733,1735,1737,1740,1742],{"class":81,"line":437},[79,1695,1465],{"class":89},[79,1697,1157],{"class":382},[79,1699,1169],{"class":1389},[79,1701,1163],{"class":1393},[79,1703,1504],{"class":1704},"sblXP",[79,1706,1623],{"class":388},[79,1708,1516],{"class":1704},[79,1710,1711],{"class":1389}," onChange",[79,1713,1163],{"class":1393},[79,1715,1504],{"class":1704},[79,1717,1718],{"class":715},"e",[79,1720,718],{"class":103},[79,1722,1723],{"class":360}," setText",[79,1725,364],{"class":89},[79,1727,1718],{"class":353},[79,1729,357],{"class":89},[79,1731,1732],{"class":401},"target",[79,1734,357],{"class":89},[79,1736,383],{"class":382},[79,1738,1739],{"class":89},")",[79,1741,1516],{"class":1704},[79,1743,1177],{"class":89},[79,1745,1746,1748,1750,1753,1755,1758,1761,1763,1765,1768,1770,1773,1775,1777,1779,1781,1784,1786],{"class":81,"line":458},[79,1747,1465],{"class":89},[79,1749,1193],{"class":382},[79,1751,1752],{"class":1389}," type",[79,1754,1163],{"class":1393},[79,1756,1757],{"class":367},"\"button\"",[79,1759,1760],{"class":1389}," onClick",[79,1762,1163],{"class":1393},[79,1764,1504],{"class":1704},[79,1766,1767],{"class":89},"() ",[79,1769,1610],{"class":103},[79,1771,1772],{"class":360}," copyToClipboard",[79,1774,364],{"class":89},[79,1776,1623],{"class":388},[79,1778,1739],{"class":89},[79,1780,1516],{"class":1704},[79,1782,1783],{"class":89},">copy text\u003C/",[79,1785,1193],{"class":382},[79,1787,1217],{"class":89},[79,1789,1790,1793,1795,1797],{"class":81,"line":479},[79,1791,1792],{"class":1503},"      {",[79,1794,1657],{"class":353},[79,1796,357],{"class":89},[79,1798,1799],{"class":382},"error\n",[79,1801,1802,1806,1809,1811,1814,1816,1818,1820,1823,1825,1828,1830,1832,1834],{"class":81,"line":501},[79,1803,1805],{"class":1804},"s7DPa","        ?",[79,1807,1808],{"class":89}," \u003C",[79,1810,19],{"class":382},[79,1812,1813],{"class":89},">Unable to copy value: ",[79,1815,1504],{"class":1503},[79,1817,1657],{"class":353},[79,1819,357],{"class":89},[79,1821,1822],{"class":401},"error",[79,1824,357],{"class":89},[79,1826,1827],{"class":382},"message",[79,1829,1516],{"class":1503},[79,1831,1250],{"class":89},[79,1833,19],{"class":382},[79,1835,1217],{"class":89},[79,1837,1838,1841,1844,1846,1848,1850,1852,1854,1857,1859,1861,1863,1865,1867,1869,1871,1873],{"class":81,"line":523},[79,1839,1840],{"class":1804},"        :",[79,1842,1843],{"class":353}," state",[79,1845,357],{"class":89},[79,1847,383],{"class":382},[79,1849,739],{"class":349},[79,1851,1808],{"class":89},[79,1853,19],{"class":382},[79,1855,1856],{"class":89},">Copied ",[79,1858,1504],{"class":1503},[79,1860,1657],{"class":353},[79,1862,357],{"class":89},[79,1864,383],{"class":382},[79,1866,1516],{"class":1503},[79,1868,1250],{"class":89},[79,1870,19],{"class":382},[79,1872,1500],{"class":89},[79,1874,113],{"class":1503},[79,1876,1877,1879,1881],{"class":81,"line":528},[79,1878,1482],{"class":89},[79,1880,1386],{"class":382},[79,1882,1217],{"class":89},[79,1884,1885],{"class":81,"line":541},[79,1886,1887],{"class":89},"  )\n",[79,1889,1890],{"class":81,"line":558},[79,1891,113],{"class":89},[1030,1893,1895],{"id":1894},"ant-design-typography",[32,1896,1899],{"href":1897,"rel":1898},"https://ant.design/components/typography-cn#typography-demo-copyable",[36],"Ant Design - Typography",[19,1901,1902,1903,1908,1909,1912],{},"ahooks 是",[32,1904,1907],{"href":1905,"rel":1906},"https://site.j10ccc.xyz/",[36],"小麦茶","第一个报出来的 react hooks 库，由 Ant Design 原班人马维护。不过其在仓库中并没有对剪贴板的封装，因此在小麦茶的建议下我跑去翻了 Ant Design 中的 Typography 对复制能力的实现。和上面的 react-use 一样，都是直接用 ",[32,1910,1263],{"href":1266,"rel":1911},[36],"，属于 execCommand 方案。",[1030,1914,1916],{"id":1915},"usehooks-usecopytoclipboard",[32,1917,1920],{"href":1918,"rel":1919},"https://usehooks.com/usecopytoclipboard",[36],"usehooks - useCopyToClipboard",[19,1922,1923,1924,1926],{},"这个库是我问 llm 知道的，现在有 10.5k star。非常逆天的一点在于它的所有逻辑代码都是在 index.js 这样一个单文件里实现的，属实是看不懂了。会先采用 ",[76,1925,682],{}," 尝试写入，失败后再换用 execCommand 的方案。hooks 的用法和上面的 react-use 大差不差。",[1030,1928,1930],{"id":1929},"usehooks-ts-usecopytoclipboard",[32,1931,1934],{"href":1932,"rel":1933},"https://usehooks-ts.com/react-hook/use-copy-to-clipboard",[36],"usehooks-ts - useCopyToClipboard",[19,1936,1937,1938,1940,1941,1944],{},"不知道是不是为了解决上面那玩意儿不支持 ts 才开的库。只使用 ",[76,1939,682],{}," 尝试写入剪切板，失败后直接 ",[76,1942,1943],{},"console.warn"," 报错，没有 fallback 方案。",[118,1946,1947],{"id":1947},"结语",[19,1949,1950],{},"从结果上来看，VueUse 的封装无疑是最令我满意的。优先尝试性能最好的 Clipboard API，再尝试 execCommand 作为回落，同时辅以多个响应式变量帮助开发，但又不擅作主张地使用 prompt 作为保底，最大程度地把操作空间留给开发者。",[19,1952,1953],{},"站在 2025 年的节点回望，前端剪切板操作技术的演进轨迹清晰可见：从早期依赖 Flash 的脆弱方案，到 execCommand 的曲线救国，最终迈向标准化 Clipboard API 的优雅实现。这段历程不仅是技术迭代的缩影，更折射出前端开发中独特的「妥协艺术」。",[19,1955,1956],{},"在未来的很长一段时间里，或许我们还是会在「优雅实现」与「向下兼容」之间寻找平衡点、在浏览器沙箱里戴着镣铐跳芭蕾，但那些为兼容性而生的临时方案，终将成为见证前端进化史的珍贵注脚。",[118,1958,225],{"id":225},[129,1960,1961,1968,1975,1981,1988,1994,2000,2006,2013,2019,2025,2032],{},[132,1962,1963],{},[32,1964,1967],{"href":1965,"rel":1966},"https://liruifengv.com/posts/copy-text/",[36],"JS复制文字到剪贴板的坑及完整方案。",[132,1969,1970],{},[32,1971,1974],{"href":1972,"rel":1973},"https://jiongks.name/blog/zeroclipboard-intro",[36],"ZeroClipboard 学习笔记 | 囧克斯",[132,1976,1977],{},[32,1978,1980],{"href":307,"rel":1979},[36],"Cut and copy commands  |  Blog  |  Chrome for Developers",[132,1982,1983],{},[32,1984,1987],{"href":1985,"rel":1986},"https://learn.microsoft.com/en-us/previous-versions/windows/internet-explorer/ie-developer/platform-apis/ms536419(v=vs.85)",[36],"execCommand method (Internet Explorer) | Microsoft Learn",[132,1989,1990],{},[32,1991,1993],{"href":1266,"rel":1992},[36],"sudodoki/copy-to-clipboard",[132,1995,1996],{},[32,1997,1999],{"href":1116,"rel":1998},[36],"zenorocha/clipboard.js",[132,2001,2002],{},[32,2003,2005],{"href":1328,"rel":2004},[36],"useClipboard | VueUse",[132,2007,2008],{},[32,2009,2012],{"href":2010,"rel":2011},"https://streamich.github.io/react-use/?path=/story/side-effects-usecopytoclipboard--docs",[36],"Side-effects / useCopyToClipboard - Docs ⋅ Storybook",[132,2014,2015],{},[32,2016,2018],{"href":299,"rel":2017},[36],"document.execCommand - Web API | MDN",[132,2020,2021],{},[32,2022,2024],{"href":607,"rel":2023},[36],"Clipboard.writeText() - Web API | MDN",[132,2026,2027],{},[32,2028,2031],{"href":2029,"rel":2030},"https://www.sitepoint.com/community/t/onclick-select-all-and-copy-to-clipboard/3837/2",[36],"Onclick Select All and Copy to Clipboard? - JavaScript - SitePoint Forums | Web Development & Design Community",[132,2033,2034],{},[32,2035,2038],{"href":2036,"rel":2037},"https://stackoverflow.com/questions/16526814/how-would-i-implement-copy-url-to-clipboard-from-a-link-or-button-using-javasc",[36],"How would I implement 'copy url to clipboard' from a link or button using javascript or dojo without flash - Stack Overflow",[264,2040,2041],{},"html pre.shiki code .sW2Sy, html code.shiki .sW2Sy{--shiki-default:#A0A1A7;--shiki-default-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic}html pre.shiki code .sLKXg, html code.shiki .sLKXg{--shiki-default:#A626A4;--shiki-dark:#C678DD}html pre.shiki code .sNmU0, html code.shiki .sNmU0{--shiki-default:#986801;--shiki-dark:#E5C07B}html pre.shiki code .s_Sar, html code.shiki .s_Sar{--shiki-default:#0184BC;--shiki-dark:#56B6C2}html pre.shiki code .s7GmK, html code.shiki .s7GmK{--shiki-default:#383A42;--shiki-dark:#E5C07B}html pre.shiki code .s5ixo, html code.shiki .s5ixo{--shiki-default:#383A42;--shiki-dark:#ABB2BF}html pre.shiki code .sAdtL, html code.shiki .sAdtL{--shiki-default:#4078F2;--shiki-dark:#61AFEF}html pre.shiki code .sDhpE, html code.shiki .sDhpE{--shiki-default:#50A14F;--shiki-dark:#98C379}html pre.shiki code .sJa8x, html code.shiki .sJa8x{--shiki-default:#E45649;--shiki-dark:#E06C75}html pre.shiki code .sz0mV, html code.shiki .sz0mV{--shiki-default:#383A42;--shiki-dark:#E06C75}html pre.shiki code .s2QsP, html code.shiki .s2QsP{--shiki-default:#E45649;--shiki-dark:#E5C07B}html pre.shiki code .sAGMh, html code.shiki .sAGMh{--shiki-default:#986801;--shiki-dark:#D19A66}html .default .shiki span {color: var(--shiki-default);background: var(--shiki-default-bg);font-style: var(--shiki-default-font-style);font-weight: var(--shiki-default-font-weight);text-decoration: var(--shiki-default-text-decoration);}html .shiki span {color: var(--shiki-default);background: var(--shiki-default-bg);font-style: var(--shiki-default-font-style);font-weight: var(--shiki-default-font-weight);text-decoration: var(--shiki-default-text-decoration);}html .dark .shiki span {color: var(--shiki-dark);background: var(--shiki-dark-bg);font-style: var(--shiki-dark-font-style);font-weight: var(--shiki-dark-font-weight);text-decoration: var(--shiki-dark-text-decoration);}html.dark .shiki span {color: var(--shiki-dark);background: var(--shiki-dark-bg);font-style: var(--shiki-dark-font-style);font-weight: var(--shiki-dark-font-weight);text-decoration: var(--shiki-dark-text-decoration);}html pre.shiki code .s8iYz, html code.shiki .s8iYz{--shiki-default:#383A42;--shiki-default-font-style:inherit;--shiki-dark:#E06C75;--shiki-dark-font-style:italic}html pre.shiki code .so_Uh, html code.shiki .so_Uh{--shiki-default:#986801;--shiki-default-font-style:inherit;--shiki-dark:#D19A66;--shiki-dark-font-style:italic}html pre.shiki code .sknuh, html code.shiki .sknuh{--shiki-default:#383A42;--shiki-dark:#56B6C2}html pre.shiki code .sUNH4, html code.shiki .sUNH4{--shiki-default:white;--shiki-dark:#FFFFFF}html pre.shiki code .sAOjX, html code.shiki .sAOjX{--shiki-default:#CA1243;--shiki-dark:#C678DD}html pre.shiki code .sblXP, html code.shiki .sblXP{--shiki-default:#383A42;--shiki-dark:#C678DD}html pre.shiki code .s7DPa, html code.shiki .s7DPa{--shiki-default:#0184BC;--shiki-dark:#C678DD}",{"title":53,"searchDepth":93,"depth":93,"links":2043},[2044,2051,2057,2058],{"id":285,"depth":93,"text":285,"children":2045},[2046,2047,2048,2050],{"id":296,"depth":110,"text":301},{"id":604,"depth":110,"text":609},{"id":993,"depth":110,"text":2049},"Flash 方案（ZeroClipboard）",{"id":1028,"depth":110,"text":1028},{"id":1107,"depth":93,"text":1107,"children":2052},[2053,2054,2055,2056],{"id":1113,"depth":110,"text":1118},{"id":1263,"depth":110,"text":1263},{"id":1325,"depth":110,"text":1330},{"id":1569,"depth":110,"text":1570},{"id":1947,"depth":93,"text":1947},{"id":225,"depth":93,"text":225},{"title":2060,"date":2061,"path":2062,"tags":2063,"body":2070},"ssh 拯救世界——通过 ssh 隧道在内网服务器执行 APT 更新","2025-03-30 21:45:24","/2025/03/30/apt-upgrade-on-internal-server-via-ssh-tunnel-and-reverse-proxy",[2064,2065,2066,2067,2068,2069],"Apt","Network","OpenSSH","Caddy","Linux","Debian",{"type":16,"value":2071,"toc":2341},[2072,2081,2086,2089,2092,2104,2107,2116,2119,2150,2153,2174,2179,2182,2187,2192,2196,2199,2218,2227,2230,2233,2246,2251,2254,2257,2270,2275,2287,2315,2321,2327,2330,2335,2338],[19,2073,2074,2075,2080],{},"事情的起因是因为精弘的",[32,2076,2079],{"href":2077,"rel":2078},"https://blog.cnpatrickstar.com/",[36],"前技术总监","抱怨学校的内网服务器无法连接外网，从而导致 apt 安装与更新异常困难，需要手动从源中下载软件包、软件包的依赖及其依赖的依赖。。。然后将这些包通过 sftp/rsync 一类的手段传到服务器上手动安装。",[19,2082,2083],{},[25,2084],{"alt":53,"src":2085},"https://static.031130.xyz/uploads/2025/03/30/0447b7d64886a.webp",[19,2087,2088],{},"于是本文应运而生，我们可以在本机使用 Caddy （Nginx 当然也行）反代一个 APT 源镜像站，通过 ssh 隧道建立端口转发，这样就可以在内网服务器上访问到本地的 Caddy 服务器，进而访问到外网的镜像站。",[118,2090,2091],{"id":2091},"前提条件",[129,2093,2094,2097],{},[132,2095,2096],{},"主控机（你自己的电脑）能够通过 ssh 直接连接电脑（可以是使用一些网络工具），而不是先通过 ssh 登陆到一台中转机，再从中转机登陆到目标服务器。后面这种情况当然也可以使用类似的手段实现我们的目标，但会更复杂一些。",[132,2098,2099,2100,2103],{},"主控机（你自己的电脑）在连接内网服务器的同时，能够连接公网镜像站（",[995,2101,2102],{},"不行的话要不然你提前本地同步一份镜像做离线镜像站","）。",[118,2105,2106],{"id":2106},"反代镜像站",[19,2108,2109,2110,2115],{},"我这里选择了 Caddy 而非 Nginx，一方面是 Caddy 的配置文件写起来简单，另一方面 Caddy 是 Golang 编写，一个二进制走天下，Windows 也能直接",[32,2111,2114],{"href":2112,"rel":2113},"https://caddyserver.com/download",[36],"下载","运行。",[19,2117,2118],{},"我们以最常见的清华 tuna 镜像站为例，一个简单的 caddy 配置文件是这样的",[70,2120,2124],{"className":2121,"code":2122,"language":2123,"meta":53,"style":53},"language-nginx shiki shiki-themes one-light one-dark-pro",":8080 {\n    reverse_proxy https://mirrors.tuna.tsinghua.edu.cn {\n        header_up Host {http.reverse_proxy.upstream.hostport}\n    }\n}\n","nginx",[76,2125,2126,2131,2136,2141,2146],{"__ignoreMap":53},[79,2127,2128],{"class":81,"line":82},[79,2129,2130],{},":8080 {\n",[79,2132,2133],{"class":81,"line":93},[79,2134,2135],{},"    reverse_proxy https://mirrors.tuna.tsinghua.edu.cn {\n",[79,2137,2138],{"class":81,"line":110},[79,2139,2140],{},"        header_up Host {http.reverse_proxy.upstream.hostport}\n",[79,2142,2143],{"class":81,"line":374},[79,2144,2145],{},"    }\n",[79,2147,2148],{"class":81,"line":394},[79,2149,113],{},[19,2151,2152],{},"将上面这段代码保存为 Caddyfile 文件名，随后使用 caddy 命令在保存路径运行",[70,2154,2158],{"className":2155,"code":2156,"language":2157,"meta":53,"style":53},"language-bash shiki shiki-themes one-light one-dark-pro","caddy run --config ./Caddyfile\n","bash",[76,2159,2160],{"__ignoreMap":53},[79,2161,2162,2165,2168,2171],{"class":81,"line":82},[79,2163,2164],{"class":360},"caddy",[79,2166,2167],{"class":367}," run",[79,2169,2170],{"class":85}," --config",[79,2172,2173],{"class":367}," ./Caddyfile\n",[19,2175,2176],{},[25,2177],{"alt":53,"src":2178},"https://static.031130.xyz/uploads/2025/03/30/8ef15a08e4852.webp",[19,2180,2181],{},"如果没有报错，那你应该能在本地的 8080 端口看到清华的镜像站",[19,2183,2184],{},[25,2185],{"alt":53,"src":2186},"https://static.031130.xyz/uploads/2025/03/30/a9083c95c07a2.webp",[64,2188,2189],{},[19,2190,2191],{},"你可能注意到，反代后的页面和清华的镜像站有些许差异，没有清华的 logo，这大概是因为页面的 js 对 host 进行了判断，如果不是清华或者北外的页面，就不会添加学校的名称，但这不影响我们从这些镜像站获取更新。",[118,2193,2195],{"id":2194},"建立-ssh-隧道","建立 ssh 隧道",[19,2197,2198],{},"建立隧道时，需要使用如下的命令",[70,2200,2202],{"className":2155,"code":2201,"language":2157,"meta":53,"style":53},"ssh -R 8085:localhost:8080 root@remote.example.com\n",[76,2203,2204],{"__ignoreMap":53},[79,2205,2206,2209,2212,2215],{"class":81,"line":82},[79,2207,2208],{"class":360},"ssh",[79,2210,2211],{"class":85}," -R",[79,2213,2214],{"class":367}," 8085:localhost:8080",[79,2216,2217],{"class":367}," root@remote.example.com\n",[19,2219,2220,2221,2226],{},"-R 表示建立反向隧道，其他的参数选项可以参考这一篇博客「",[32,2222,2225],{"href":2223,"rel":2224},"https://www.entropy-tree.top/2024/04/18/ssh-tunneling-techniques/",[36],"SSH 隧道技术","」，也是精弘的学长写的。",[19,2228,2229],{},"此时，我们建立了一个内网服务器 8085 端口到本机 8080 端口的 ssh 端口转发。（使用 8085 端口是我为了区分其和 8080 端口，实际上可以使用任何空余端口）",[19,2231,2232],{},"我们可以在服务器上使用 curl 来测试一下是否能够正常访问，我这里简单访问了下 Debian 源根目录下的一个 README 文件。",[70,2234,2236],{"className":2155,"code":2235,"language":2157,"meta":53,"style":53},"curl http://localhost:8085/debian/README\n",[76,2237,2238],{"__ignoreMap":53},[79,2239,2240,2243],{"class":81,"line":82},[79,2241,2242],{"class":360},"curl",[79,2244,2245],{"class":367}," http://localhost:8085/debian/README\n",[19,2247,2248],{},[25,2249],{"alt":53,"src":2250},"https://static.031130.xyz/uploads/2025/03/30/597c4af0d398d.webp",[118,2252,2253],{"id":2253},"换源",[19,2255,2256],{},"所以现在我们在内网服务器的 8085 端口上有一个清华开源镜像站的反代，我们可以通过 8085 端口访问镜像站中的所有内容。",[19,2258,2259,2260,2265,2266,2269],{},"先遵循",[32,2261,2264],{"href":2262,"rel":2263},"https://mirrors.tuna.tsinghua.edu.cn/help/debian/",[36],"清华开源镜像站的指示","，进行换源，",[135,2267,2268],{},"记得一定要勾选「强制安全更新使用镜像」","。",[19,2271,2272],{},[25,2273],{"alt":53,"src":2274},"https://static.031130.xyz/uploads/2025/03/30/46e3c7030ded4.webp",[19,2276,2277,2278,2282,2283],{},"随后，我们将源中的所有 ",[32,2279,2280],{"href":2280,"rel":2281},"https://mirrors.tuna.tsinghua.edu.cn",[36]," 替换成 ",[32,2284,2285],{"href":2285,"rel":2286},"http://localhost:8085",[36],[70,2288,2290],{"className":2155,"code":2289,"language":2157,"meta":53,"style":53},"sed -i 's|https\\?://mirrors\\.tuna\\.tsinghua\\.edu\\.cn|http://localhost:8085|g' `grep -rlE 'http(s)?://mirrors\\.tuna\\.tsinghua\\.edu\\.cn' /etc/apt/`\n",[76,2291,2292],{"__ignoreMap":53},[79,2293,2294,2297,2300,2303,2306,2309,2312],{"class":81,"line":82},[79,2295,2296],{"class":360},"sed",[79,2298,2299],{"class":85}," -i",[79,2301,2302],{"class":367}," 's|https\\?://mirrors\\.tuna\\.tsinghua\\.edu\\.cn|http://localhost:8085|g'",[79,2304,2305],{"class":367}," `",[79,2307,2308],{"class":360},"grep",[79,2310,2311],{"class":85}," -rlE",[79,2313,2314],{"class":367}," 'http(s)?://mirrors\\.tuna\\.tsinghua\\.edu\\.cn' /etc/apt/`\n",[19,2316,2317],{},[25,2318],{"alt":2319,"src":2320},"执行 apt update","https://static.031130.xyz/uploads/2025/03/30/a8f0c70d48f5b.webp",[19,2322,2323],{},[25,2324],{"alt":2325,"src":2326},"使用 apt 安装 unzip","https://static.031130.xyz/uploads/2025/03/30/07919bf939e92.webp",[19,2328,2329],{},"可以看到，我们通过 ssh 隧道实现了在内网服务器执行 APT 更新及安装软件。",[64,2331,2332],{},[19,2333,2334],{},"温馨提示，ssh 隧道在本世纪 10 年代初经常被用来进行搭建一些跨境访问，但因为其独特的流量特征很快淡出了历史舞台，因此不要使用 ssh 进行大量的跨境网络传输，容易被封禁。",[19,2336,2337],{},"当然，实现这一目标的方法是很多的，其他一些例如 frp 的工具同样能做到这种效果，只不过 ssh 隧道这种方案随开随用，随关随停，不需要更多的配置，因此我主要推荐。",[264,2339,2340],{},"html .default .shiki span {color: var(--shiki-default);background: var(--shiki-default-bg);font-style: var(--shiki-default-font-style);font-weight: var(--shiki-default-font-weight);text-decoration: var(--shiki-default-text-decoration);}html .shiki span {color: var(--shiki-default);background: var(--shiki-default-bg);font-style: var(--shiki-default-font-style);font-weight: var(--shiki-default-font-weight);text-decoration: var(--shiki-default-text-decoration);}html .dark .shiki span {color: var(--shiki-dark);background: var(--shiki-dark-bg);font-style: var(--shiki-dark-font-style);font-weight: var(--shiki-dark-font-weight);text-decoration: var(--shiki-dark-text-decoration);}html.dark .shiki span {color: var(--shiki-dark);background: var(--shiki-dark-bg);font-style: var(--shiki-dark-font-style);font-weight: var(--shiki-dark-font-weight);text-decoration: var(--shiki-dark-text-decoration);}html pre.shiki code .sAdtL, html code.shiki .sAdtL{--shiki-default:#4078F2;--shiki-dark:#61AFEF}html pre.shiki code .sDhpE, html code.shiki .sDhpE{--shiki-default:#50A14F;--shiki-dark:#98C379}html pre.shiki code .sAGMh, html code.shiki .sAGMh{--shiki-default:#986801;--shiki-dark:#D19A66}",{"title":53,"searchDepth":93,"depth":93,"links":2342},[2343,2344,2345,2346],{"id":2091,"depth":93,"text":2091},{"id":2106,"depth":93,"text":2106},{"id":2194,"depth":93,"text":2195},{"id":2253,"depth":93,"text":2253},{"title":2348,"date":2349,"path":2350,"tags":2351,"body":2357},"Cudy TR3000 吃鹅(daed)记","2025-02-28 21:18:34","/2025/02/28/cudy-tr3000-daed-install-record",[2352,2353,2065,2354,2355,2356],"OpenSource Project","Hardware","Router","OpenWRT","ImmortalWRT",{"type":16,"value":2358,"toc":2670},[2359,2362,2370,2375,2378,2384,2393,2396,2399,2406,2411,2414,2417,2420,2427,2430,2435,2439,2442,2447,2450,2455,2458,2464,2467,2472,2477,2481,2487,2492,2498,2504,2509,2512,2531,2536,2540,2543,2550,2556,2561,2564,2569,2580,2585,2588,2593,2596,2601,2607,2613,2616,2622,2628,2630,2667],[118,2360,2361],{"id":2361},"缘起",[19,2363,2364,2365,2369],{},"前不久在京东自营看到我馋了很久的 Cudy TR3000 有 ￥153 的折扣价，虽然比起 ￥130 的史低价（甚至 ￥110 的凑单史低价）还有些距离，但已经到我的可接受范围内了，于是果断下单剁手了这台我心心念念的 Cudy TR3000 迷你路由器，以此来缓解我的",[79,2366,2368],{"className":2367},[292],"开学前综合症","（一种精神性疾病）",[19,2371,2372],{},[25,2373],{"alt":53,"src":2374},"https://static.031130.xyz/uploads/2025/02/23/8b0a4d5812179.webp",[19,2376,2377],{},"这台路由器使用 Type-C 供电，拥有一个 2.5Gbps 的 WAN 口和一个 1Gbps 的 LAN 口，在此基础上还有一个 USB 口可用于打印机共享、挂载外接存储、安卓手机 USB 共享网络等多种用途。更让我心动的地方在于其小巧的体型，非常适合出差、旅行、短期租房等场景。考虑到接下来一段实习可能会有租房需求，于是便趁此机会果断下单了。",[19,2379,2380],{},[25,2381],{"alt":2382,"src":2383},"与一台小米8的宽高对比","https://static.031130.xyz/uploads/2025/02/23/ef2b394e6fc0d.webp",[19,2385,2386,2387,2392],{},"官方系统是基于 openwrt 定制的，功能比较单一，因此考虑刷入 openwrt 原版系统增加可玩性。在恩山无限论坛上发现已经有人编译了",[32,2388,2391],{"href":2389,"rel":2390},"https://www.right.com.cn/forum/forum.php?mod=viewthread&tid=8418091",[36],"基于 Linux 6.6 版本的 OpenWRT 系统","，这已经满足了 dae 的 Bind to LAN 功能的内核版本要求（ >= 5.17 ），且 512MB 的内存大小刚好达到了推荐的最小内存大小，于是这 dae 肯定是要试着吃一吃的。如果成功了，这就是我手上第一台吃上大鹅的硬路由。",[2394,2395],"hr",{},[118,2397,2398],{"id":2398},"开始刷机",[19,2400,2401,2402,2405],{},"路由器官方系统的后台管理地址是 192.168.10.1，初次进入会要求你设置密码，然后就是一路随便点，完成初始化，随后就进入到主页。我手上这台的 FW 版本号是 ",[76,2403,2404],{},"2.3.2-20241226","，不清楚后续的版本能不能仍然使用这套方案。",[19,2407,2408],{},[25,2409],{"alt":53,"src":2410},"https://static.031130.xyz/uploads/2025/02/28/1c066cb1dab3f.webp",[189,2412,2413],{"id":2413},"过渡固件",[19,2415,2416],{},"首先我们需要先刷入所谓的「过渡固件」。刷入过渡固件的意义在于，这个过渡固件能被官方系统的升级程序所承认，这样就允许我们进行后续的操作。",[19,2418,2419],{},"过渡固件的文件名和 md5 值如下:",[70,2421,2425],{"className":2422,"code":2424,"language":1623},[2423],"language-text","b8333d8eebd067fcb43bec855ac22364  cudy_tr3000-v1-sysupgrade.bin\n",[76,2426,2424],{"__ignoreMap":53},[19,2428,2429],{},"随后我们可以在路由器的管理页面的基本设置中找到固件升级的地方，在本地更新一栏中选择过渡固件上传更新即可。",[19,2431,2432],{},[25,2433],{"alt":53,"src":2434},"https://static.031130.xyz/uploads/2025/02/28/3582e569954a6.webp",[189,2436,2438],{"id":2437},"刷入解锁-fip-分区写入权限的固件","刷入解锁 FIP 分区写入权限的固件",[19,2440,2441],{},"刷入过渡固件后稍等大约一分钟，路由器的 DHCP 重新工作，我们就可以通过 192.168.1.1 进入过渡固件的管理页面。",[19,2443,2444],{},[25,2445],{"alt":53,"src":2446},"https://static.031130.xyz/uploads/2025/02/28/6fe8107a87e87.webp",[19,2448,2449],{},"初次登陆时没有密码，随便输就能登陆成功。考虑到后续可能会有恢复出厂的需求，建议在这一步对 FIP 分区进行备份。",[19,2451,2452],{},[25,2453],{"alt":53,"src":2454},"https://static.031130.xyz/uploads/2025/02/28/79caf5f643689.webp",[19,2456,2457],{},"这次我们需要刷入下面这个 LEDE 固件来解锁 FIP 分区的写入权限，文件名和 md5 仍然放在下面",[70,2459,2462],{"className":2460,"code":2461,"language":1623},[2423],"4af5129368cbf0d556061f682b1614f2  openwrt-mediatek-filogic-cudy_tr3000-v1-squashfs-sysupgrade.bin\n",[76,2463,2461],{"__ignoreMap":53},[19,2465,2466],{},"在下方选择刷入固件，上传我们本次需要刷入的固件，刷入。",[19,2468,2469],{},[25,2470],{"alt":53,"src":2471},"https://static.031130.xyz/uploads/2025/02/28/79d300bb33d21.webp",[19,2473,2474],{},[25,2475],{"alt":53,"src":2476},"https://static.031130.xyz/uploads/2025/02/28/bc29dc9cad24a.webp",[189,2478,2480],{"id":2479},"刷入-uboot","刷入 uboot",[19,2482,2483,2484],{},"再等待一分钟左右，电脑重新连接上路由器后，我们可以进入到这个解锁了 FIP 分区写入权限的固件，默认密码是 ",[76,2485,2486],{},"password",[19,2488,2489],{},[25,2490],{"alt":53,"src":2491},"https://static.031130.xyz/uploads/2025/02/28/f98051faba608.webp",[19,2493,2494,2495],{},"在侧栏选择文件传输，将本次要刷入的 uboot 上传，文件名和 md5 还是放在下面。",[135,2496,2497],{},"注意 zip 包要解压",[70,2499,2502],{"className":2500,"code":2501,"language":1623},[2423],"e5ff31bac07108b6ac6cd63189b4d113  dhcp-mt7981_cudy_tr3000-fip-fixed-parts-multi-layout.bin\n",[76,2503,2501],{"__ignoreMap":53},[19,2505,2506],{},[25,2507],{"alt":53,"src":2508},"https://static.031130.xyz/uploads/2025/02/28/547c5d324f0a0.webp",[19,2510,2511],{},"随后侧栏进入 TTYD 终端，输入默认的用户名密码 root / password，执行命令刷入 uboot",[70,2513,2515],{"className":2155,"code":2514,"language":2157,"meta":53,"style":53},"mtd write /tmp/upload/dhcp-mt7981_cudy_tr3000-fip-fixed-parts-multi-layout.bin FIP\n",[76,2516,2517],{"__ignoreMap":53},[79,2518,2519,2522,2525,2528],{"class":81,"line":82},[79,2520,2521],{"class":360},"mtd",[79,2523,2524],{"class":367}," write",[79,2526,2527],{"class":367}," /tmp/upload/dhcp-mt7981_cudy_tr3000-fip-fixed-parts-multi-layout.bin",[79,2529,2530],{"class":367}," FIP\n",[19,2532,2533],{},[25,2534],{"alt":53,"src":2535},"https://static.031130.xyz/uploads/2025/02/28/46b4fc5be8c82.webp",[189,2537,2539],{"id":2538},"刷入自编译的-immortalwrt","刷入自编译的 immortalwrt",[19,2541,2542],{},"刷入 uboot 以后，给路由器断电，确保网线分别连接电脑和路由器 LAN 口后，按住 reset 键再插入电源键，直至白灯闪烁四次后转为红灯后松开 reset 键，即可进入 uboot。",[19,2544,2545,2546,2549],{},"我编译的是 112m 的布局，因此需要选择 ",[76,2547,2548],{},"mod-112m"," 这个 mtd 布局后上传固件刷入。",[70,2551,2554],{"className":2552,"code":2553,"language":1623},[2423],"8c9a44f29c8c5a0617e61d49bf8ad45d  112m-immortalwrt-cudy_tr3000-ebpf_by_zhullyb_20250325-squashfs-sysupgrade.bin\n",[76,2555,2553],{"__ignoreMap":53},[19,2557,2558],{},[25,2559],{"alt":53,"src":2560},"https://static.031130.xyz/uploads/2025/02/28/41c250db91756.webp",[19,2562,2563],{},"再次等待电脑重新连接路由器，这是最终吃上 daed 的系统了，依然是没有默认密码，随便输入即可进入。在连接上网络后，在系统 - 软件包页面，更新软件包列表。",[19,2565,2566],{},[25,2567],{"alt":53,"src":2568},"https://static.031130.xyz/uploads/2025/02/28/e56084ff09a5d.webp",[19,2570,2571,2572,2575,2576,2579],{},"随后就可以安装 dae / daed 相关软件了，可视需求选择 ",[76,2573,2574],{},"luci-i18n-dae-zh-cn"," 或者 ",[76,2577,2578],{},"luci-i18n-daed-zh-cn","，其他包会作为依赖一同被安装。我这里安装的是 daed。",[19,2581,2582],{},[25,2583],{"alt":53,"src":2584},"https://static.031130.xyz/uploads/2025/02/28/dc4fa4a688cf5.webp",[19,2586,2587],{},"安装后刷新界面，我们就可以在顶栏的服务板块看到 daed。",[19,2589,2590],{},[25,2591],{"alt":53,"src":2592},"https://static.031130.xyz/uploads/2025/02/28/551f1f2eb9ab4.webp",[19,2594,2595],{},"daed 正常运行，能正常跑满我家的 300Mbps 宽带下行（单线程实测 250Mbps），速度峰值时 CPU 占用图如下。",[19,2597,2598],{},[25,2599],{"alt":53,"src":2600},"https://static.031130.xyz/uploads/2025/02/28/651bed7ad4aba.webp",[19,2602,2603],{},[25,2604],{"alt":2605,"src":2606},"多线程测速","https://static.031130.xyz/uploads/2025/03/01/9fcee79afa63b.png",[19,2608,2609],{},[25,2610],{"alt":2611,"src":2612},"单线程测速","https://static.031130.xyz/uploads/2025/03/01/6716d723a2b0d.png",[118,2614,2615],{"id":2615},"文章中提到的文件",[19,2617,2618],{},[32,2619,2620],{"href":2620,"rel":2621},"https://www.123684.com/s/gfprVv-wEQ8d",[36],[19,2623,2624],{},[32,2625,2626],{"href":2626,"rel":2627},"https://www.123912.com/s/gfprVv-wEQ8d",[36],[118,2629,225],{"id":225},[129,2631,2632,2639,2646,2653,2660],{},[132,2633,2634],{},[32,2635,2638],{"href":2636,"rel":2637},"https://www.right.com.cn/forum/forum.php?mod=viewthread&tid=8410353",[36],"Cudy TR3000 刷机教程指北",[132,2640,2641],{},[32,2642,2645],{"href":2643,"rel":2644},"https://abxy.fun/post/immortalwrt-dae/",[36],"使用 ImmortalWrt+Dae 为 Windows 配置透明代理",[132,2647,2648],{},[32,2649,2652],{"href":2650,"rel":2651},"https://www.right.com.cn/forum/forum.php?mod=viewthread&tid=8415351",[36],"cudy tr3000 v1中文三分区DHCP uboot第二版",[132,2654,2655],{},[32,2656,2659],{"href":2657,"rel":2658},"https://blog.imouto.in/#/posts/10",[36],"使用 hanwckf/bl-mt798x 引导主线 OpenWrt 固件",[132,2661,2662],{},[32,2663,2666],{"href":2664,"rel":2665},"https://github.com/QiuSimons/luci-app-daed",[36],"QiuSimons/luci-app-daed",[264,2668,2669],{},"html pre.shiki code .sAdtL, html code.shiki .sAdtL{--shiki-default:#4078F2;--shiki-dark:#61AFEF}html pre.shiki code .sDhpE, html code.shiki .sDhpE{--shiki-default:#50A14F;--shiki-dark:#98C379}html .default .shiki span {color: var(--shiki-default);background: var(--shiki-default-bg);font-style: var(--shiki-default-font-style);font-weight: var(--shiki-default-font-weight);text-decoration: var(--shiki-default-text-decoration);}html .shiki span {color: var(--shiki-default);background: var(--shiki-default-bg);font-style: var(--shiki-default-font-style);font-weight: var(--shiki-default-font-weight);text-decoration: var(--shiki-default-text-decoration);}html .dark .shiki span {color: var(--shiki-dark);background: var(--shiki-dark-bg);font-style: var(--shiki-dark-font-style);font-weight: var(--shiki-dark-font-weight);text-decoration: var(--shiki-dark-text-decoration);}html.dark .shiki span {color: var(--shiki-dark);background: var(--shiki-dark-bg);font-style: var(--shiki-dark-font-style);font-weight: var(--shiki-dark-font-weight);text-decoration: var(--shiki-dark-text-decoration);}",{"title":53,"searchDepth":93,"depth":93,"links":2671},[2672,2673,2679,2680],{"id":2361,"depth":93,"text":2361},{"id":2398,"depth":93,"text":2398,"children":2674},[2675,2676,2677,2678],{"id":2413,"depth":110,"text":2413},{"id":2437,"depth":110,"text":2438},{"id":2479,"depth":110,"text":2480},{"id":2538,"depth":110,"text":2539},{"id":2615,"depth":93,"text":2615},{"id":225,"depth":93,"text":225},{"title":2682,"date":2683,"path":2684,"tags":2685,"body":2688},"使用 Cloudflare Workers 监控 Fedora Copr 构建状态","2025-02-23 12:12:53","/2025/02/23/monitor-copr-build-state-with-cloudflare-workers",[11,2686,2687],"Cloudflare","Fedora",{"type":16,"value":2689,"toc":3539},[2690,2697,2705,2719,2732,2737,2740,2743,2966,2969,3158,3161,3518,3521,3526,3536],[64,2691,2692],{},[19,2693,2694],{},[995,2695,2696],{},"确信，是 cloudflare workers 用上瘾了",[19,2698,2699,2700,2704],{},"在",[32,2701,2703],{"href":2702},"/2024/04/29/update-a-rpm-spec-by-github-action/","「使用 Github Action 更新用于 rpm 打包的 spec 文件」","一文中，我利用 Github Action 实现了自动化的 spec 版本号更新，配合 Fedora Copr 的 webhook 就可以实现 Copr 软件包更新的自动化构建。看似很完美，但缺少了一个构建状态的监控机制，这导致出现构建错误的时候我不能及时得到通知（无论构建错误是 spec 本身的问题或者是构建时的网络环境问题）。",[19,2706,2707,2712,2713,2718],{},[32,2708,2711],{"href":2709,"rel":2710},"https://yanqiyu.info",[36],"西木野羰基"," 提出 ",[32,2714,2717],{"href":2715,"rel":2716},"https://notifications.fedoraproject.org/",[36],"notifications.fedoraproject.org"," 可以配置通知，Filters 的 Applications 选项中有 copr，但很可惜，实测没有效果。这里的通知配置的似乎只是邮件的过滤规则——如果 copr 本来就没打算构建失败的时候给你发邮件，那即使建立了过滤规则，依然是不可能收到邮件的。",[19,2720,2721,2722,2727,2728,2731],{},"不过好在 Fedora Copr 本身有非常完备的 ",[32,2723,2726],{"href":2724,"rel":2725},"https://copr.fedorainfracloud.org/api_3/docs",[36],"api 文档","，",[76,2729,2730],{},"/monitor"," 这个 API 能用来获取软件包最新的构建情况。",[19,2733,2734],{},[25,2735],{"alt":53,"src":2736},"https://static.031130.xyz/uploads/2025/02/23/637811d2d85f6.webp",[19,2738,2739],{},"因此，我们就可以通过 Cloudflare 的 cronjob 定时请求这个接口，查询是否有软件包构建失败。",[19,2741,2742],{},"先来编写打请求的部分",[70,2744,2746],{"className":322,"code":2745,"language":324,"meta":53,"style":53},"async function fetchCopr() {\n    const ownername = \"zhullyb\";\n    const projectname = \"v2rayA\";\n\n    const url = new URL(\"https://copr.fedorainfracloud.org/api_3/monitor\")\n    url.searchParams.set(\"ownername\", ownername)\n    url.searchParams.set(\"projectname\", projectname)\n    const response = await fetch(url)\n    const data = await response.json()\n    if (data.output !== \"ok\") {\n        throw new Error(\"Failed to fetch COPR data\")\n    }\n    return data\n}\n",[76,2747,2748,2762,2776,2790,2794,2816,2843,2867,2889,2910,2933,2950,2954,2962],{"__ignoreMap":53},[79,2749,2750,2753,2756,2759],{"class":81,"line":82},[79,2751,2752],{"class":103},"async",[79,2754,2755],{"class":103}," function",[79,2757,2758],{"class":360}," fetchCopr",[79,2760,2761],{"class":89},"() {\n",[79,2763,2764,2766,2769,2771,2774],{"class":81,"line":93},[79,2765,788],{"class":103},[79,2767,2768],{"class":345}," ownername",[79,2770,350],{"class":349},[79,2772,2773],{"class":367}," \"zhullyb\"",[79,2775,107],{"class":89},[79,2777,2778,2780,2783,2785,2788],{"class":81,"line":110},[79,2779,788],{"class":103},[79,2781,2782],{"class":345}," projectname",[79,2784,350],{"class":349},[79,2786,2787],{"class":367}," \"v2rayA\"",[79,2789,107],{"class":89},[79,2791,2792],{"class":81,"line":374},[79,2793,337],{"emptyLinePlaceholder":44},[79,2795,2796,2798,2801,2803,2806,2809,2811,2814],{"class":81,"line":394},[79,2797,788],{"class":103},[79,2799,2800],{"class":345}," url",[79,2802,350],{"class":349},[79,2804,2805],{"class":103}," new",[79,2807,2808],{"class":360}," URL",[79,2810,364],{"class":89},[79,2812,2813],{"class":367},"\"https://copr.fedorainfracloud.org/api_3/monitor\"",[79,2815,1099],{"class":89},[79,2817,2818,2821,2823,2826,2828,2831,2833,2836,2838,2841],{"class":81,"line":416},[79,2819,2820],{"class":353},"    url",[79,2822,357],{"class":89},[79,2824,2825],{"class":401},"searchParams",[79,2827,357],{"class":89},[79,2829,2830],{"class":360},"set",[79,2832,364],{"class":89},[79,2834,2835],{"class":367},"\"ownername\"",[79,2837,494],{"class":89},[79,2839,2840],{"class":388},"ownername",[79,2842,1099],{"class":89},[79,2844,2845,2847,2849,2851,2853,2855,2857,2860,2862,2865],{"class":81,"line":437},[79,2846,2820],{"class":353},[79,2848,357],{"class":89},[79,2850,2825],{"class":401},[79,2852,357],{"class":89},[79,2854,2830],{"class":360},[79,2856,364],{"class":89},[79,2858,2859],{"class":367},"\"projectname\"",[79,2861,494],{"class":89},[79,2863,2864],{"class":388},"projectname",[79,2866,1099],{"class":89},[79,2868,2869,2871,2874,2876,2879,2882,2884,2887],{"class":81,"line":458},[79,2870,788],{"class":103},[79,2872,2873],{"class":345}," response",[79,2875,350],{"class":349},[79,2877,2878],{"class":103}," await",[79,2880,2881],{"class":360}," fetch",[79,2883,364],{"class":89},[79,2885,2886],{"class":388},"url",[79,2888,1099],{"class":89},[79,2890,2891,2893,2896,2898,2900,2902,2904,2907],{"class":81,"line":479},[79,2892,788],{"class":103},[79,2894,2895],{"class":345}," data",[79,2897,350],{"class":349},[79,2899,2878],{"class":103},[79,2901,2873],{"class":353},[79,2903,357],{"class":89},[79,2905,2906],{"class":360},"json",[79,2908,2909],{"class":89},"()\n",[79,2911,2912,2915,2917,2920,2922,2925,2928,2931],{"class":81,"line":501},[79,2913,2914],{"class":103},"    if",[79,2916,728],{"class":89},[79,2918,2919],{"class":353},"data",[79,2921,357],{"class":89},[79,2923,2924],{"class":382},"output",[79,2926,2927],{"class":349}," !==",[79,2929,2930],{"class":367}," \"ok\"",[79,2932,750],{"class":89},[79,2934,2935,2938,2940,2943,2945,2948],{"class":81,"line":523},[79,2936,2937],{"class":103},"        throw",[79,2939,2805],{"class":103},[79,2941,2942],{"class":360}," Error",[79,2944,364],{"class":89},[79,2946,2947],{"class":367},"\"Failed to fetch COPR data\"",[79,2949,1099],{"class":89},[79,2951,2952],{"class":81,"line":528},[79,2953,2145],{"class":89},[79,2955,2956,2959],{"class":81,"line":541},[79,2957,2958],{"class":103},"    return",[79,2960,2961],{"class":388}," data\n",[79,2963,2964],{"class":81,"line":558},[79,2965,113],{"class":89},[19,2967,2968],{},"随后编写通知部分，我这里采用的是飞书的 webhook 机器人",[70,2970,2972],{"className":322,"code":2971,"language":324,"meta":53,"style":53},"async function notify(text) {\n    const webhook = \"https://open.feishu.cn/open-apis/bot/v2/hook/ffffffff-ffff-ffff-ffff-ffffffffffff\"\n    const body = {\n        msg_type: \"text\",\n        content: {\n            text: text\n        }\n    }\n    const response = await fetch(webhook, {\n        method: \"POST\",\n        headers: {\n            \"Content-Type\": \"application/json\"\n        },\n        body: JSON.stringify(body)\n    })\n    console.log(response)\n}\n",[76,2973,2974,2989,3001,3012,3027,3036,3046,3051,3055,3075,3087,3096,3106,3111,3132,3137,3154],{"__ignoreMap":53},[79,2975,2976,2978,2980,2983,2985,2987],{"class":81,"line":82},[79,2977,2752],{"class":103},[79,2979,2755],{"class":103},[79,2981,2982],{"class":360}," notify",[79,2984,364],{"class":89},[79,2986,1623],{"class":715},[79,2988,750],{"class":89},[79,2990,2991,2993,2996,2998],{"class":81,"line":93},[79,2992,788],{"class":103},[79,2994,2995],{"class":345}," webhook",[79,2997,350],{"class":349},[79,2999,3000],{"class":367}," \"https://open.feishu.cn/open-apis/bot/v2/hook/ffffffff-ffff-ffff-ffff-ffffffffffff\"\n",[79,3002,3003,3005,3008,3010],{"class":81,"line":110},[79,3004,788],{"class":103},[79,3006,3007],{"class":345}," body",[79,3009,350],{"class":349},[79,3011,90],{"class":89},[79,3013,3014,3017,3021,3024],{"class":81,"line":374},[79,3015,3016],{"class":382},"        msg_type",[79,3018,3020],{"class":3019},"st7oF",":",[79,3022,3023],{"class":367}," \"text\"",[79,3025,3026],{"class":89},",\n",[79,3028,3029,3032,3034],{"class":81,"line":394},[79,3030,3031],{"class":382},"        content",[79,3033,3020],{"class":3019},[79,3035,90],{"class":89},[79,3037,3038,3041,3043],{"class":81,"line":416},[79,3039,3040],{"class":382},"            text",[79,3042,3020],{"class":3019},[79,3044,3045],{"class":388}," text\n",[79,3047,3048],{"class":81,"line":437},[79,3049,3050],{"class":89},"        }\n",[79,3052,3053],{"class":81,"line":458},[79,3054,2145],{"class":89},[79,3056,3057,3059,3061,3063,3065,3067,3069,3072],{"class":81,"line":479},[79,3058,788],{"class":103},[79,3060,2873],{"class":345},[79,3062,350],{"class":349},[79,3064,2878],{"class":103},[79,3066,2881],{"class":360},[79,3068,364],{"class":89},[79,3070,3071],{"class":388},"webhook",[79,3073,3074],{"class":89},", {\n",[79,3076,3077,3080,3082,3085],{"class":81,"line":501},[79,3078,3079],{"class":382},"        method",[79,3081,3020],{"class":3019},[79,3083,3084],{"class":367}," \"POST\"",[79,3086,3026],{"class":89},[79,3088,3089,3092,3094],{"class":81,"line":523},[79,3090,3091],{"class":382},"        headers",[79,3093,3020],{"class":3019},[79,3095,90],{"class":89},[79,3097,3098,3101,3103],{"class":81,"line":528},[79,3099,3100],{"class":367},"            \"Content-Type\"",[79,3102,3020],{"class":3019},[79,3104,3105],{"class":367}," \"application/json\"\n",[79,3107,3108],{"class":81,"line":541},[79,3109,3110],{"class":89},"        },\n",[79,3112,3113,3116,3118,3121,3123,3126,3128,3130],{"class":81,"line":558},[79,3114,3115],{"class":382},"        body",[79,3117,3020],{"class":3019},[79,3119,3120],{"class":345}," JSON",[79,3122,357],{"class":89},[79,3124,3125],{"class":360},"stringify",[79,3127,364],{"class":89},[79,3129,509],{"class":388},[79,3131,1099],{"class":89},[79,3133,3134],{"class":81,"line":931},[79,3135,3136],{"class":89},"    })\n",[79,3138,3139,3142,3144,3147,3149,3152],{"class":81,"line":936},[79,3140,3141],{"class":353},"    console",[79,3143,357],{"class":89},[79,3145,3146],{"class":360},"log",[79,3148,364],{"class":89},[79,3150,3151],{"class":388},"response",[79,3153,1099],{"class":89},[79,3155,3156],{"class":81,"line":947},[79,3157,113],{"class":89},[19,3159,3160],{},"最后就是 cronjob 的调用部分和构建状态解析部分",[70,3162,3164],{"className":322,"code":3163,"language":324,"meta":53,"style":53},"export default {\n    async fetch(request, env, ctx) {\n      return new Response('Hello World!');\n    },\n\n    async scheduled(event, env, ctx) {\n        const data = await fetchCopr()\n        const errorPackages = new Array()\n\n        for (const pkg of data.packages) {\n            for (const chroot of Object.values(pkg.chroots)) {\n                if (chroot.state == \"failed\") {\n                    errorPackages.push(pkg.name)\n                    break\n                }\n            }\n        }\n\n        if (errorPackages.length > 0) {\n            await notify(`COPR 以下包发生构建失败:\\n${errorPackages.join(\"\\n\")}`)\n        } else {\n            console.log(\"COPR 所有包构建成功\")\n        }\n    }\n};\n",[76,3165,3166,3177,3201,3218,3223,3227,3249,3264,3280,3284,3308,3343,3365,3386,3391,3396,3401,3405,3409,3431,3476,3486,3503,3508,3513],{"__ignoreMap":53},[79,3167,3168,3171,3175],{"class":81,"line":82},[79,3169,3170],{"class":103},"export",[79,3172,3174],{"class":3173},"sq3v1"," default",[79,3176,90],{"class":89},[79,3178,3179,3182,3184,3186,3189,3191,3194,3196,3199],{"class":81,"line":93},[79,3180,3181],{"class":103},"    async",[79,3183,2881],{"class":360},[79,3185,364],{"class":89},[79,3187,3188],{"class":715},"request",[79,3190,494],{"class":89},[79,3192,3193],{"class":715},"env",[79,3195,494],{"class":89},[79,3197,3198],{"class":715},"ctx",[79,3200,750],{"class":89},[79,3202,3203,3206,3208,3211,3213,3216],{"class":81,"line":110},[79,3204,3205],{"class":103},"      return",[79,3207,2805],{"class":103},[79,3209,3210],{"class":360}," Response",[79,3212,364],{"class":89},[79,3214,3215],{"class":367},"'Hello World!'",[79,3217,371],{"class":89},[79,3219,3220],{"class":81,"line":374},[79,3221,3222],{"class":89},"    },\n",[79,3224,3225],{"class":81,"line":394},[79,3226,337],{"emptyLinePlaceholder":44},[79,3228,3229,3231,3234,3236,3239,3241,3243,3245,3247],{"class":81,"line":416},[79,3230,3181],{"class":103},[79,3232,3233],{"class":360}," scheduled",[79,3235,364],{"class":89},[79,3237,3238],{"class":715},"event",[79,3240,494],{"class":89},[79,3242,3193],{"class":715},[79,3244,494],{"class":89},[79,3246,3198],{"class":715},[79,3248,750],{"class":89},[79,3250,3251,3254,3256,3258,3260,3262],{"class":81,"line":437},[79,3252,3253],{"class":103},"        const",[79,3255,2895],{"class":345},[79,3257,350],{"class":349},[79,3259,2878],{"class":103},[79,3261,2758],{"class":360},[79,3263,2909],{"class":89},[79,3265,3266,3268,3271,3273,3275,3278],{"class":81,"line":458},[79,3267,3253],{"class":103},[79,3269,3270],{"class":345}," errorPackages",[79,3272,350],{"class":349},[79,3274,2805],{"class":103},[79,3276,3277],{"class":360}," Array",[79,3279,2909],{"class":89},[79,3281,3282],{"class":81,"line":479},[79,3283,337],{"emptyLinePlaceholder":44},[79,3285,3286,3289,3291,3293,3296,3299,3301,3303,3306],{"class":81,"line":501},[79,3287,3288],{"class":103},"        for",[79,3290,728],{"class":89},[79,3292,342],{"class":103},[79,3294,3295],{"class":345}," pkg",[79,3297,3298],{"class":103}," of",[79,3300,2895],{"class":353},[79,3302,357],{"class":89},[79,3304,3305],{"class":382},"packages",[79,3307,750],{"class":89},[79,3309,3310,3313,3315,3317,3320,3322,3325,3327,3330,3332,3335,3337,3340],{"class":81,"line":523},[79,3311,3312],{"class":103},"            for",[79,3314,728],{"class":89},[79,3316,342],{"class":103},[79,3318,3319],{"class":345}," chroot",[79,3321,3298],{"class":103},[79,3323,3324],{"class":353}," Object",[79,3326,357],{"class":89},[79,3328,3329],{"class":360},"values",[79,3331,364],{"class":89},[79,3333,3334],{"class":353},"pkg",[79,3336,357],{"class":89},[79,3338,3339],{"class":382},"chroots",[79,3341,3342],{"class":89},")) {\n",[79,3344,3345,3348,3350,3353,3355,3357,3360,3363],{"class":81,"line":528},[79,3346,3347],{"class":103},"                if",[79,3349,728],{"class":89},[79,3351,3352],{"class":353},"chroot",[79,3354,357],{"class":89},[79,3356,1657],{"class":382},[79,3358,3359],{"class":349}," ==",[79,3361,3362],{"class":367}," \"failed\"",[79,3364,750],{"class":89},[79,3366,3367,3370,3372,3375,3377,3379,3381,3384],{"class":81,"line":541},[79,3368,3369],{"class":353},"                    errorPackages",[79,3371,357],{"class":89},[79,3373,3374],{"class":360},"push",[79,3376,364],{"class":89},[79,3378,3334],{"class":353},[79,3380,357],{"class":89},[79,3382,3383],{"class":382},"name",[79,3385,1099],{"class":89},[79,3387,3388],{"class":81,"line":558},[79,3389,3390],{"class":103},"                    break\n",[79,3392,3393],{"class":81,"line":931},[79,3394,3395],{"class":89},"                }\n",[79,3397,3398],{"class":81,"line":936},[79,3399,3400],{"class":89},"            }\n",[79,3402,3403],{"class":81,"line":947},[79,3404,3050],{"class":89},[79,3406,3407],{"class":81,"line":962},[79,3408,337],{"emptyLinePlaceholder":44},[79,3410,3411,3414,3416,3419,3421,3424,3427,3429],{"class":81,"line":981},[79,3412,3413],{"class":103},"        if",[79,3415,728],{"class":89},[79,3417,3418],{"class":353},"errorPackages",[79,3420,357],{"class":89},[79,3422,3423],{"class":382},"length",[79,3425,3426],{"class":349}," >",[79,3428,411],{"class":85},[79,3430,750],{"class":89},[79,3432,3433,3436,3438,3440,3443,3446,3449,3451,3454,3457,3459,3463,3465,3467,3469,3471,3474],{"class":81,"line":987},[79,3434,3435],{"class":103},"            await",[79,3437,2982],{"class":360},[79,3439,364],{"class":89},[79,3441,3442],{"class":367},"`COPR 以下包发生构建失败:",[79,3444,3445],{"class":349},"\\n",[79,3447,3448],{"class":1503},"${",[79,3450,3418],{"class":353},[79,3452,357],{"class":3453},"sMj0N",[79,3455,3456],{"class":360},"join",[79,3458,364],{"class":89},[79,3460,3462],{"class":3461},"sWwuK","\"",[79,3464,3445],{"class":349},[79,3466,3462],{"class":3461},[79,3468,1739],{"class":89},[79,3470,1516],{"class":1503},[79,3472,3473],{"class":367},"`",[79,3475,1099],{"class":89},[79,3477,3479,3482,3484],{"class":81,"line":3478},21,[79,3480,3481],{"class":89},"        } ",[79,3483,781],{"class":103},[79,3485,90],{"class":89},[79,3487,3489,3492,3494,3496,3498,3501],{"class":81,"line":3488},22,[79,3490,3491],{"class":353},"            console",[79,3493,357],{"class":89},[79,3495,3146],{"class":360},[79,3497,364],{"class":89},[79,3499,3500],{"class":367},"\"COPR 所有包构建成功\"",[79,3502,1099],{"class":89},[79,3504,3506],{"class":81,"line":3505},23,[79,3507,3050],{"class":89},[79,3509,3511],{"class":81,"line":3510},24,[79,3512,2145],{"class":89},[79,3514,3516],{"class":81,"line":3515},25,[79,3517,990],{"class":89},[19,3519,3520],{},"随后在 Cloudflare Workers 的 Settings 部分设置好 Cron 表达式即可，我这里选择在每小时的 55 分进行一次检测，这样下来一天只会消耗 24 次 workers 次数，简直毫无压力。",[19,3522,3523],{},[25,3524],{"alt":53,"src":3525},"https://static.031130.xyz/uploads/2025/02/23/c38edfd637934.webp",[19,3527,3528,3531,3532,3535],{},[135,3529,3530],{},"缺点:"," 我懒得使用持久化数据库记录软件包构建的成功状态，这会导致出现一个包构建失败后，每隔 1 小时都会有一条提醒，",[995,3533,3534],{},"什么夺命连环 call","。我目前不想修复这个问题，要不然还是降低 cron 的触发频率好了。",[264,3537,3538],{},"html pre.shiki code .sLKXg, html code.shiki .sLKXg{--shiki-default:#A626A4;--shiki-dark:#C678DD}html pre.shiki code .sAdtL, html code.shiki .sAdtL{--shiki-default:#4078F2;--shiki-dark:#61AFEF}html pre.shiki code .s5ixo, html code.shiki .s5ixo{--shiki-default:#383A42;--shiki-dark:#ABB2BF}html pre.shiki code .sNmU0, html code.shiki .sNmU0{--shiki-default:#986801;--shiki-dark:#E5C07B}html pre.shiki code .s_Sar, html code.shiki .s_Sar{--shiki-default:#0184BC;--shiki-dark:#56B6C2}html pre.shiki code .sDhpE, html code.shiki .sDhpE{--shiki-default:#50A14F;--shiki-dark:#98C379}html pre.shiki code .s7GmK, html code.shiki .s7GmK{--shiki-default:#383A42;--shiki-dark:#E5C07B}html pre.shiki code .s2QsP, html code.shiki .s2QsP{--shiki-default:#E45649;--shiki-dark:#E5C07B}html pre.shiki code .sz0mV, html code.shiki .sz0mV{--shiki-default:#383A42;--shiki-dark:#E06C75}html pre.shiki code .sJa8x, html code.shiki .sJa8x{--shiki-default:#E45649;--shiki-dark:#E06C75}html .default .shiki span {color: var(--shiki-default);background: var(--shiki-default-bg);font-style: var(--shiki-default-font-style);font-weight: var(--shiki-default-font-weight);text-decoration: var(--shiki-default-text-decoration);}html .shiki span {color: var(--shiki-default);background: var(--shiki-default-bg);font-style: var(--shiki-default-font-style);font-weight: var(--shiki-default-font-weight);text-decoration: var(--shiki-default-text-decoration);}html .dark .shiki span {color: var(--shiki-dark);background: var(--shiki-dark-bg);font-style: var(--shiki-dark-font-style);font-weight: var(--shiki-dark-font-weight);text-decoration: var(--shiki-dark-text-decoration);}html.dark .shiki span {color: var(--shiki-dark);background: var(--shiki-dark-bg);font-style: var(--shiki-dark-font-style);font-weight: var(--shiki-dark-font-weight);text-decoration: var(--shiki-dark-text-decoration);}html pre.shiki code .s8iYz, html code.shiki .s8iYz{--shiki-default:#383A42;--shiki-default-font-style:inherit;--shiki-dark:#E06C75;--shiki-dark-font-style:italic}html pre.shiki code .st7oF, html code.shiki .st7oF{--shiki-default:#0184BC;--shiki-dark:#ABB2BF}html pre.shiki code .sq3v1, html code.shiki .sq3v1{--shiki-default:#E45649;--shiki-dark:#C678DD}html pre.shiki code .sAGMh, html code.shiki .sAGMh{--shiki-default:#986801;--shiki-dark:#D19A66}html pre.shiki code .sAOjX, html code.shiki .sAOjX{--shiki-default:#CA1243;--shiki-dark:#C678DD}html pre.shiki code .sMj0N, html code.shiki .sMj0N{--shiki-default:#50A14F;--shiki-dark:#ABB2BF}html pre.shiki code .sWwuK, html code.shiki .sWwuK{--shiki-default:#CA1243;--shiki-dark:#98C379}",{"title":53,"searchDepth":93,"depth":93,"links":3540},[],{"title":3542,"date":3543,"path":3544,"tags":3545,"body":3547},"基于 Cloudflare Workers 实现的在线服务状态检测告警系统","2025-01-18 02:00:08","/2025/01/18/service-status-monitor-based-on-cloudflare-workers",[2686,11,3546,2065],"crontab",{"type":16,"value":3548,"toc":4075},[3549,3552,3559,3562,3568,3584,3587,3601,3604,3615,3622,3629,3635,3639,3652,3655,3663,3682,3693,3699,3706,3709,3726,3733,3760,3763,3869,3872,3895,3898,3904,3907,3916,3992,3995,3998,4010,4013,4025,4028,4035,4040,4043,4049,4051,4058,4065,4072],[118,3550,3551],{"id":3551},"起因",[19,3553,3554,3555,3558],{},"受一些客观因素的影响，微精弘前一阵子针对学校教务系统的数据爬取服务状态出现了非常不稳定的状态，而后端在设计初并没有考虑到异常告警机制，恰逢现任员工都身陷期末周的痛苦之中，我这种计院 Lite 专业的精弘老人就打算实现一个针对「",[135,3556,3557],{},"微精弘主后端 \u003C->  funnel 爬虫服务 \u003C-> 教务系统","」这一条链路的告警机制。旨在短期内（即期末周结束之前）填补微精弘的后端服务告警机制的空白，让运维人员能够及时收到并处理排查后端网络链路的异常情况，尽最大努力保证服务在线率，保障工大本科生在期末周内使用体验。",[118,3560,3561],{"id":3561},"需求分析",[19,3563,3564],{},[25,3565],{"alt":3566,"src":3567},"微精弘的技术架构图","https://static.031130.xyz/uploads/2025/01/19/74362573e371d.webp",[64,3569,3570],{},[19,3571,3572,3573,3578,3579,2269],{},"如果你不知道微精弘的具体架构实现，这里有一篇由前技术总监提笔并由现任技术总监完善的架构杂谈「",[32,3574,3577],{"href":3575,"rel":3576},"https://mp.weixin.qq.com/s/8d6JAPsLa4TzLr50uDG8uw",[36],"微精弘 | 架构杂谈","」，原文最初发表于前者的",[32,3580,3583],{"href":3581,"rel":3582},"https://blog.cnpatrickstar.com/posts/wejh-architecture/",[36],"博客",[19,3585,3586],{},"基于上述客观条件以及我个人在服务监控告警领域近乎为 0 的经验，我一拍脑袋提出了以下几点需求：",[154,3588,3589,3592,3595,3598],{},[132,3590,3591],{},"稳定性。告警服务本身必须要比我们的主后端更加稳定，这是告警服务的基础。",[132,3593,3594],{},"针对现有服务的侵入性低。告警服务不能影响到现有服务，最好能够完全分离开来，不应当部署在同一台服务器上。",[132,3596,3597],{},"开发快速。整个服务需要尽快落地，因为现有的服务在一周内出现了三次故障，且由于主动的监控告警机制的缺失，我们每次都要等服务 down 机的两小时后才意识到服务挂掉了，如果真在考试周这个使用高峰期内再出现这样的故障不容允许的（用户需要查询考场信息）。",[132,3599,3600],{},"尽可能低的运维成本。没什么好解释的，谁也不希望一个告警服务占用太多的运维成本，无论是人力上的还是资源上的。",[118,3602,3603],{"id":3603},"技术选型",[19,3605,3606,3607,3610,3611,3614],{},"结合我已有的经验，我选用了 ",[135,3608,3609],{},"Cloudflare Worker"," 来完成这个任务。Cloudflare Workers 本身是支持 ",[135,3612,3613],{},"cron job"," 的，能够以分钟级为单位的间隔对服务进行主动探测。Cloudflare 每天都有 10w 次免费的 Workers 调用额度，本身的服务在线率也过硬，唯一的缺点可能就是海外节点访问国内服务器的延迟过高了。不过考虑到我们探测的是在线情况而非延迟情况，倒也不是不能接受。",[19,3616,3617,3618,3621],{},"由于服务特性的关系，我们容许一定的访问失败概率。比如五次访问中如果有两三次失败，我们也认为线路是通的，",[995,3619,3620],{},"可能只是教务系统的土豆快熟了","。因此并不是每一次失败的探测都需要进行告警。另外，我们还需要记录当前的服务状态，一旦服务被认定为下线状态，后续探测失败我们就不再进行告警，直到我们重新判定服务状态为上线（即每段连续的下线时间都只触发一次告警）。Cloudflare Worker 是一种 serverless 服务，且每次执行探测任务的可能都不是同一个 Cloudflare 的边缘节点，因此我们没法使用变量在内存中记录目前的服务状态，需要引入外部数据库来完成短期内的数据存储。",[19,3623,3624,3625,3628],{},"在数据库上，我们必须选择 Cloudflare 自家的在线数据库服务，通过 Cloudflare 自己内部的网络传输数据库查询结果才能得到尽可能低的延迟。在一番考量过后，KV 数据库和 SQL 数据库中，我果断选择了 ",[135,3626,3627],{},"Cloudflare D1"," 这个 SQL 数据库（本质是 SQLite），D1 数据库以更长的查询时间换取数据的实时性。Cloudflare 为免费用户提供了每天 500w 行读取和 10w 行写入的免费额度，只要好好加以利用，就不太可能超出限额。后续我还考虑通过这些数据库的数据使用 Cloudflare Worker 构建 uptime status 的后端 API，实现一个类似 status.openai.com 的在线服务状态可视化界面。",[19,3630,3631],{},[25,3632],{"alt":3633,"src":3634},"OpenAI 的 uptime status","https://static.031130.xyz/uploads/2025/01/19/f817539504140.webp",[118,3636,3638],{"id":3637},"登陆-wrangler","登陆 wrangler",[70,3640,3642],{"className":2155,"code":3641,"language":2157,"meta":53,"style":53},"wrangler login\n",[76,3643,3644],{"__ignoreMap":53},[79,3645,3646,3649],{"class":81,"line":82},[79,3647,3648],{"class":360},"wrangler",[79,3650,3651],{"class":367}," login\n",[118,3653,3654],{"id":3654},"项目初始化",[19,3656,3657,3658,3662],{},"由于之前有过一些编写 Cloudflare Workers 的经验，我深知在 Cloudflare 网页的 code server 编辑器上编辑单文件的 worker.js 的不便，选择使用 Cloudflare 官方推出的工具 ",[32,3659,3648],{"href":3660,"rel":3661},"https://developers.cloudflare.com/workers/wrangler/",[36]," 进行项目的初始化。",[70,3664,3666],{"className":2155,"code":3665,"language":2157,"meta":53,"style":53},"npm create cloudflare@latest wjh-monitor\n",[76,3667,3668],{"__ignoreMap":53},[79,3669,3670,3673,3676,3679],{"class":81,"line":82},[79,3671,3672],{"class":360},"npm",[79,3674,3675],{"class":367}," create",[79,3677,3678],{"class":367}," cloudflare@latest",[79,3680,3681],{"class":367}," wjh-monitor\n",[64,3683,3684,3687,3690],{},[19,3685,3686],{},"Q: What would you like to start with?\nA: Hello World example",[19,3688,3689],{},"Q: Which template would you like to use?\nA: Hello World Worker",[19,3691,3692],{},"Q: Which language do you want to use?\nA: TypeScript",[19,3694,3695],{},[25,3696],{"alt":3697,"src":3698},"得到的项目结构","https://static.031130.xyz/uploads/2025/01/20/bf105c9fc18a3.webp",[19,3700,3701,3702,3705],{},"我们只需要在 ",[76,3703,3704],{},"index.ts"," 中编写我们的主要逻辑即可。",[118,3707,3708],{"id":3708},"数据库初始化",[70,3710,3712],{"className":2155,"code":3711,"language":2157,"meta":53,"style":53},"wrangler d1 create wjh-monitor-db\n",[76,3713,3714],{"__ignoreMap":53},[79,3715,3716,3718,3721,3723],{"class":81,"line":82},[79,3717,3648],{"class":360},[79,3719,3720],{"class":367}," d1",[79,3722,3675],{"class":367},[79,3724,3725],{"class":367}," wjh-monitor-db\n",[19,3727,3728,3729,3732],{},"随后会输出这些内容，我们需要把这些配置文件写入项目的 ",[76,3730,3731],{},"wrangler.toml"," 文件中",[70,3734,3738],{"className":3735,"code":3736,"language":3737,"meta":53,"style":53},"language-toml shiki shiki-themes one-light one-dark-pro","[[d1_databases]]\nbinding = \"DB\"\ndatabase_name = \"wjh-monitor-db\"\ndatabase_id = \"ffffffff-ffff-ffff-ffff-ffffffffffff\"\n","toml",[76,3739,3740,3745,3750,3755],{"__ignoreMap":53},[79,3741,3742],{"class":81,"line":82},[79,3743,3744],{},"[[d1_databases]]\n",[79,3746,3747],{"class":81,"line":93},[79,3748,3749],{},"binding = \"DB\"\n",[79,3751,3752],{"class":81,"line":110},[79,3753,3754],{},"database_name = \"wjh-monitor-db\"\n",[79,3756,3757],{"class":81,"line":374},[79,3758,3759],{},"database_id = \"ffffffff-ffff-ffff-ffff-ffffffffffff\"\n",[19,3761,3762],{},"编写一个 sql 文件创建数据表，并通过 wrangler 创建它",[70,3764,3768],{"className":3765,"code":3766,"language":3767,"meta":53,"style":53},"language-sql shiki shiki-themes one-light one-dark-pro","// schema.sql\nCREATE TABLE IF NOT EXISTS DATA (\n    id INTEGER PRIMARY KEY AUTOINCREMENT,\n    check_time TIMESTAMP DEFAULT CURRENT_TIMESTAMP,\n    check_item VARCHAR(10),\n    response_time INTEGER NOT NULL,\n    success BOOLEAN NOT NULL,\n    online_status BOOLEAN NOT NULL,\n    notify BOOLEAN DEFAULT FALSE,\n    other TEXT,\n    INDEX check_time_idx (check_time)\n);\nINSERT INTO DATA (\n        response_time,\n        success,\n        online_status,\n        notify,\n        other\n    )\nVALUES (100, 1, 1, 0, 'initial');\n","sql",[76,3769,3770,3775,3780,3785,3790,3795,3800,3805,3810,3815,3820,3825,3829,3834,3839,3844,3849,3854,3859,3864],{"__ignoreMap":53},[79,3771,3772],{"class":81,"line":82},[79,3773,3774],{},"// schema.sql\n",[79,3776,3777],{"class":81,"line":93},[79,3778,3779],{},"CREATE TABLE IF NOT EXISTS DATA (\n",[79,3781,3782],{"class":81,"line":110},[79,3783,3784],{},"    id INTEGER PRIMARY KEY AUTOINCREMENT,\n",[79,3786,3787],{"class":81,"line":374},[79,3788,3789],{},"    check_time TIMESTAMP DEFAULT CURRENT_TIMESTAMP,\n",[79,3791,3792],{"class":81,"line":394},[79,3793,3794],{},"    check_item VARCHAR(10),\n",[79,3796,3797],{"class":81,"line":416},[79,3798,3799],{},"    response_time INTEGER NOT NULL,\n",[79,3801,3802],{"class":81,"line":437},[79,3803,3804],{},"    success BOOLEAN NOT NULL,\n",[79,3806,3807],{"class":81,"line":458},[79,3808,3809],{},"    online_status BOOLEAN NOT NULL,\n",[79,3811,3812],{"class":81,"line":479},[79,3813,3814],{},"    notify BOOLEAN DEFAULT FALSE,\n",[79,3816,3817],{"class":81,"line":501},[79,3818,3819],{},"    other TEXT,\n",[79,3821,3822],{"class":81,"line":523},[79,3823,3824],{},"    INDEX check_time_idx (check_time)\n",[79,3826,3827],{"class":81,"line":528},[79,3828,371],{},[79,3830,3831],{"class":81,"line":541},[79,3832,3833],{},"INSERT INTO DATA (\n",[79,3835,3836],{"class":81,"line":558},[79,3837,3838],{},"        response_time,\n",[79,3840,3841],{"class":81,"line":931},[79,3842,3843],{},"        success,\n",[79,3845,3846],{"class":81,"line":936},[79,3847,3848],{},"        online_status,\n",[79,3850,3851],{"class":81,"line":947},[79,3852,3853],{},"        notify,\n",[79,3855,3856],{"class":81,"line":962},[79,3857,3858],{},"        other\n",[79,3860,3861],{"class":81,"line":981},[79,3862,3863],{},"    )\n",[79,3865,3866],{"class":81,"line":987},[79,3867,3868],{},"VALUES (100, 1, 1, 0, 'initial');\n",[19,3870,3871],{},"使用 sql 文件创建远程数据表",[70,3873,3875],{"className":2155,"code":3874,"language":2157,"meta":53,"style":53},"wrangler d1 execute wjh-monitor-db --remote --file=./schema.sql\n",[76,3876,3877],{"__ignoreMap":53},[79,3878,3879,3881,3883,3886,3889,3892],{"class":81,"line":82},[79,3880,3648],{"class":360},[79,3882,3720],{"class":367},[79,3884,3885],{"class":367}," execute",[79,3887,3888],{"class":367}," wjh-monitor-db",[79,3890,3891],{"class":85}," --remote",[79,3893,3894],{"class":85}," --file=./schema.sql\n",[19,3896,3897],{},"随后我们可以使用 wrangler 在远程数据库上执行 query 命令，并获得相应的结果",[70,3899,3902],{"className":3900,"code":3901,"language":1623},[2423],"wrangler d1 execute wjh-monitor-db --remote --command='SELECT * FROM DATA'\n",[76,3903,3901],{"__ignoreMap":53},[118,3905,3906],{"id":3906},"主体逻辑编写",[19,3908,3909,3910,3915],{},"说实话，代码部分没什么太多好说的，正要了解思路直接去看",[32,3911,3914],{"href":3912,"rel":3913},"https://github.com/zhullyb/wjh-monitor",[36],"源码","就好。我在这里简单提两点。",[154,3917,3918,3928,3938],{},[132,3919,3920,3921,3924,3925,3927],{},"目录下的 ",[76,3922,3923],{},"worker-configuration.d.ts"," 定义了 env 变量的类型定义，如果我们在项目中绑定了一些变量（比如我们在 ",[76,3926,3731],{}," 中绑定了 d1 数据库，变量名为 DB），需要在这里声明以防止后续 TypeScript 的报错。",[132,3929,3930,3931,3934,3935,3937],{},"在 ",[76,3932,3933],{},"export default {}"," 中是将会被导出的主要函数，Hello World 项目编写了 fetch 函数，这是在 workers 被通过 http 方式访问时所调用的，如果要使用 cron job 功能，我们需要编写 scheduled 函数来被 workers 调用，并在 ",[76,3936,3731],{}," 中配置好 crontab 触发器。",[132,3939,3940,3941,3943,3944,3949,3950],{},"我们在 ",[76,3942,3731],{}," 中绑定了 DB 变量作为数据库的快捷访问方式，因此我们可以在代码中通过 ",[32,3945,3948],{"href":3946,"rel":3947},"https://developers.cloudflare.com/d1/worker-api/",[36],"D1 数据库的 Workers Binding API"," 来实现针对数据库的快捷操作，如",[70,3951,3953],{"className":322,"code":3952,"language":324,"meta":53,"style":53},"const res = await env.DB.prepare(\"SELECT * FROM DATA ORDER BY check_time DESC LIMIT 4\").run();\n",[76,3954,3955],{"__ignoreMap":53},[79,3956,3957,3959,3962,3964,3966,3969,3971,3974,3976,3979,3981,3984,3987,3990],{"class":81,"line":82},[79,3958,342],{"class":103},[79,3960,3961],{"class":345}," res",[79,3963,350],{"class":349},[79,3965,2878],{"class":103},[79,3967,3968],{"class":353}," env",[79,3970,357],{"class":89},[79,3972,3973],{"class":401},"DB",[79,3975,357],{"class":89},[79,3977,3978],{"class":360},"prepare",[79,3980,364],{"class":89},[79,3982,3983],{"class":367},"\"SELECT * FROM DATA ORDER BY check_time DESC LIMIT 4\"",[79,3985,3986],{"class":89},").",[79,3988,3989],{"class":360},"run",[79,3991,538],{"class":89},[19,3993,3994],{},"需要注意的是，workers 不存在上下文，每一次访问的处理都是前后独立的，如果你需要临时存储一些数据，不要使用变量，一定要存入持久化存储的数据库。",[19,3996,3997],{},"预览:",[70,3999,4001],{"className":2155,"code":4000,"language":2157,"meta":53,"style":53},"wrangler dev\n",[76,4002,4003],{"__ignoreMap":53},[79,4004,4005,4007],{"class":81,"line":82},[79,4006,3648],{"class":360},[79,4008,4009],{"class":367}," dev\n",[19,4011,4012],{},"部署:",[70,4014,4016],{"className":2155,"code":4015,"language":2157,"meta":53,"style":53},"wrangler deploy\n",[76,4017,4018],{"__ignoreMap":53},[79,4019,4020,4022],{"class":81,"line":82},[79,4021,3648],{"class":360},[79,4023,4024],{"class":367}," deploy\n",[118,4026,4027],{"id":4027},"小插曲",[19,4029,4030,4031,4034],{},"由于我对后端经验的缺乏，我在编写 sql 语句时没有意识到建立索引的重要性。我在查询时使用了 ",[76,4032,4033],{},"ORDER BY \u003C未建立索引字段> LIMIT 5"," 的方式来查询最近五次的记录，这导致数据库不得不在我每次查询时都完整遍历一遍整张表。随着 cronjob 每分钟运行时插入一条新数据，记录的行数随时间增加，每次查询的成本也逐渐增加，最终造成了单日访问八百多万行的记录，超出了 Cloudflare 的免费额度，一度造成了项目被迫下线的风险。",[19,4036,4037],{},[25,4038],{"alt":53,"src":4039},"https://static.031130.xyz/uploads/2025/01/20/fb463f45038ac.webp",[19,4041,4042],{},"所幸 Cloudflare 没有给我停机，而我也及时定位到了问题并补建了索引，使每日的读取量回到了正常的状态。",[19,4044,4045],{},[25,4046],{"alt":4047,"src":4048},"蓝色线条为读取，黄色线条为写入","https://static.031130.xyz/uploads/2025/01/19/83f69aff3a7b4.webp",[118,4050,225],{"id":225},[19,4052,4053],{},[32,4054,4057],{"href":4055,"rel":4056},"https://developers.cloudflare.com/d1/",[36],"Cloudflare D1 · Cloudflare D1 docs",[19,4059,4060],{},[32,4061,4064],{"href":4062,"rel":4063},"https://developers.cloudflare.com/workers/configuration/cron-triggers/",[36],"Cron Triggers · Cloudflare Workers docs",[19,4066,4067],{},[32,4068,4071],{"href":4069,"rel":4070},"https://blog.sww.moe/post/cloudflare-d1/",[36],"Cloudflare D1 使用记录",[264,4073,4074],{},"html pre.shiki code .sAdtL, html code.shiki .sAdtL{--shiki-default:#4078F2;--shiki-dark:#61AFEF}html pre.shiki code .sDhpE, html code.shiki .sDhpE{--shiki-default:#50A14F;--shiki-dark:#98C379}html .default .shiki span {color: var(--shiki-default);background: var(--shiki-default-bg);font-style: var(--shiki-default-font-style);font-weight: var(--shiki-default-font-weight);text-decoration: var(--shiki-default-text-decoration);}html .shiki span {color: var(--shiki-default);background: var(--shiki-default-bg);font-style: var(--shiki-default-font-style);font-weight: var(--shiki-default-font-weight);text-decoration: var(--shiki-default-text-decoration);}html .dark .shiki span {color: var(--shiki-dark);background: var(--shiki-dark-bg);font-style: var(--shiki-dark-font-style);font-weight: var(--shiki-dark-font-weight);text-decoration: var(--shiki-dark-text-decoration);}html.dark .shiki span {color: var(--shiki-dark);background: var(--shiki-dark-bg);font-style: var(--shiki-dark-font-style);font-weight: var(--shiki-dark-font-weight);text-decoration: var(--shiki-dark-text-decoration);}html pre.shiki code .sAGMh, html code.shiki .sAGMh{--shiki-default:#986801;--shiki-dark:#D19A66}html pre.shiki code .sLKXg, html code.shiki .sLKXg{--shiki-default:#A626A4;--shiki-dark:#C678DD}html pre.shiki code .sNmU0, html code.shiki .sNmU0{--shiki-default:#986801;--shiki-dark:#E5C07B}html pre.shiki code .s_Sar, html code.shiki .s_Sar{--shiki-default:#0184BC;--shiki-dark:#56B6C2}html pre.shiki code .s7GmK, html code.shiki .s7GmK{--shiki-default:#383A42;--shiki-dark:#E5C07B}html pre.shiki code .s5ixo, html code.shiki .s5ixo{--shiki-default:#383A42;--shiki-dark:#ABB2BF}html pre.shiki code .s2QsP, html code.shiki .s2QsP{--shiki-default:#E45649;--shiki-dark:#E5C07B}",{"title":53,"searchDepth":93,"depth":93,"links":4076},[4077,4078,4079,4080,4081,4082,4083,4084,4085],{"id":3551,"depth":93,"text":3551},{"id":3561,"depth":93,"text":3561},{"id":3603,"depth":93,"text":3603},{"id":3637,"depth":93,"text":3638},{"id":3654,"depth":93,"text":3654},{"id":3708,"depth":93,"text":3708},{"id":3906,"depth":93,"text":3906},{"id":4027,"depth":93,"text":4027},{"id":225,"depth":93,"text":225},{"title":4087,"date":4088,"path":4089,"tags":4090,"body":4092},"构建部署在 Cloudflare Workers 上的 TG Bot","2024-12-30 19:45:43","/2024/12/30/tg-bot-hosted-on-cloudflare-workers",[4091,2686],"Bot",{"type":16,"value":4093,"toc":5366},[4094,4096,4107,4119,4122,4126,4134,4142,4145,4147,4150,4153,4156,4159,4166,4213,4216,4219,4448,4451,4454,4917,4920,5340,5344,5347,5350,5355,5358,5363],[118,4095,3551],{"id":3551},[19,4097,4098,4099,4103,4104],{},"早在去年 10 月，我就写过一篇",[32,4100,4102],{"href":4101},"/2023/10/29/create-b23tv-remover-bot/","《创建 b23.tv 追踪参数移除 bot》","。记录了部署 b23.tv 的追踪参数移除 Bot 的部署方案。其中提到的 TG Bot 随着服务器到期不再续费也一同落灰了——",[135,4105,4106],{},"公益服务总是这样，开始时满腔热血，随着时间散去没有多少人能坚持投入成本，徒留下一地鸡毛。",[19,4108,4109,4110,4115,4116],{},"大概半个月前，我在群里看见 ",[32,4111,4114],{"href":4112,"rel":4113},"https://asukaminato.eu.org/",[36],"Asuka Minato"," 开发的群消息总结 Bot，整体部署在 Cloudflare Workers 上，在保证零运营成本的情况下有着相当非常不错的在线率保证，因此便考虑将这个 Bot 迁移到 Cloudflare Workers 上。",[135,4117,4118],{},"选用免费的 serverless 能够有效延长服务的可持续性，它不需要额外投入时间精力和财力进行维护，通常可以活很久。",[19,4120,4121],{},"之所以可以把 TG Bot 部署到 Cloudflare Workers 上，主要是得益于 TG 平台支持 webhook 的方式让 Bot 程序提供服务。我们所需要提供的是一个公网能访问的 http 地址，在成功注册 webhook 服务后，TG 的官方服务器会将所有 Bot 所在群或者和所有对个人的对话以 http 请求的方式打到这个 url 上，而 Cloudflare Workers 平台就能提供一个 workers.dev 结尾的公网 url 作为 webhook 提供给 TG 服务器。",[118,4123,4125],{"id":4124},"怎么做","怎么做？",[19,4127,4128,4133],{},[32,4129,4132],{"href":4130,"rel":4131},"https://github.com/cvzi/telegram-bot-cloudflare",[36],"在这个 Github 仓库中","，给出了不少例子，用以讲述如何利用 Cloudflare Workers 构建 TG Bot。",[19,4135,3930,4136,4141],{},[32,4137,4140],{"href":4138,"rel":4139},"https://github.com/cvzi/telegram-bot-cloudflare/blob/main/bot.js",[36],"bot.js"," 这个文件中编写了一个最简单的 TG Bot，其功能是: 将受到的所有消息在头部添加「Echo:」字符串，并发送回刚才的对话。",[19,4143,4144],{},"例: 用户发送 「Hello」，bot 回复 「Echo: Hello」",[2394,4146],{},[118,4148,4149],{"id":4149},"代码分析",[19,4151,4152],{},"代码整体分为四个部分",[189,4154,4155],{"id":4155},"顶部变量",[19,4157,4158],{},"文件顶部定义了 Bot 的 token、webhook 的 url 路径以及一个简易的 webhook 密码。",[19,4160,4161,4162,4165],{},"TOKEN 是从 botfather 那里获得的 bot token，SECRET 是自己设置的 webhook 密码，TG 的 webhook 服务器会通过把这个字段添加到名为 ",[76,4163,4164],{},"X-Telegram-Bot-Api-Secret-Token"," 的请求头中来证明自己的官方身份。",[70,4167,4169],{"className":322,"code":4168,"language":324,"meta":53,"style":53},"const TOKEN = ENV_BOT_TOKEN // Get it from @BotFather https://core.telegram.org/bots#6-botfather\nconst WEBHOOK = '/endpoint'\nconst SECRET = ENV_BOT_SECRET // A-Z, a-z, 0-9, _ and -\n",[76,4170,4171,4186,4198],{"__ignoreMap":53},[79,4172,4173,4175,4178,4180,4183],{"class":81,"line":82},[79,4174,342],{"class":103},[79,4176,4177],{"class":345}," TOKEN",[79,4179,350],{"class":349},[79,4181,4182],{"class":345}," ENV_BOT_TOKEN",[79,4184,4185],{"class":331}," // Get it from @BotFather https://core.telegram.org/bots#6-botfather\n",[79,4187,4188,4190,4193,4195],{"class":81,"line":93},[79,4189,342],{"class":103},[79,4191,4192],{"class":345}," WEBHOOK",[79,4194,350],{"class":349},[79,4196,4197],{"class":367}," '/endpoint'\n",[79,4199,4200,4202,4205,4207,4210],{"class":81,"line":110},[79,4201,342],{"class":103},[79,4203,4204],{"class":345}," SECRET",[79,4206,350],{"class":349},[79,4208,4209],{"class":345}," ENV_BOT_SECRET",[79,4211,4212],{"class":331}," // A-Z, a-z, 0-9, _ and -\n",[189,4214,4215],{"id":4215},"简易路由",[19,4217,4218],{},"紧接着定义了一个简易的路由",[70,4220,4222],{"className":322,"code":4221,"language":324,"meta":53,"style":53},"addEventListener('fetch', event => {\n  const url = new URL(event.request.url)\n  if (url.pathname === WEBHOOK) {\n    event.respondWith(handleWebhook(event))\n  } else if (url.pathname === '/registerWebhook') {\n    event.respondWith(registerWebhook(event, url, WEBHOOK, SECRET))\n  } else if (url.pathname === '/unRegisterWebhook') {\n    event.respondWith(unRegisterWebhook(event))\n  } else {\n    event.respondWith(new Response('No handler for this request'))\n  }\n})\n",[76,4223,4224,4242,4268,4288,4310,4334,4367,4390,4409,4417,4439,4443],{"__ignoreMap":53},[79,4225,4226,4229,4231,4234,4236,4238,4240],{"class":81,"line":82},[79,4227,4228],{"class":360},"addEventListener",[79,4230,364],{"class":89},[79,4232,4233],{"class":367},"'fetch'",[79,4235,494],{"class":89},[79,4237,3238],{"class":715},[79,4239,718],{"class":103},[79,4241,90],{"class":89},[79,4243,4244,4246,4248,4250,4252,4254,4256,4258,4260,4262,4264,4266],{"class":81,"line":93},[79,4245,1617],{"class":103},[79,4247,2800],{"class":345},[79,4249,350],{"class":349},[79,4251,2805],{"class":103},[79,4253,2808],{"class":360},[79,4255,364],{"class":89},[79,4257,3238],{"class":353},[79,4259,357],{"class":89},[79,4261,3188],{"class":401},[79,4263,357],{"class":89},[79,4265,2886],{"class":382},[79,4267,1099],{"class":89},[79,4269,4270,4272,4274,4276,4278,4281,4284,4286],{"class":81,"line":110},[79,4271,725],{"class":103},[79,4273,728],{"class":89},[79,4275,2886],{"class":353},[79,4277,357],{"class":89},[79,4279,4280],{"class":382},"pathname",[79,4282,4283],{"class":349}," ===",[79,4285,4192],{"class":345},[79,4287,750],{"class":89},[79,4289,4290,4293,4295,4298,4300,4303,4305,4307],{"class":81,"line":374},[79,4291,4292],{"class":353},"    event",[79,4294,357],{"class":89},[79,4296,4297],{"class":360},"respondWith",[79,4299,364],{"class":89},[79,4301,4302],{"class":360},"handleWebhook",[79,4304,364],{"class":89},[79,4306,3238],{"class":388},[79,4308,4309],{"class":89},"))\n",[79,4311,4312,4314,4316,4319,4321,4323,4325,4327,4329,4332],{"class":81,"line":394},[79,4313,778],{"class":89},[79,4315,781],{"class":103},[79,4317,4318],{"class":103}," if",[79,4320,728],{"class":89},[79,4322,2886],{"class":353},[79,4324,357],{"class":89},[79,4326,4280],{"class":382},[79,4328,4283],{"class":349},[79,4330,4331],{"class":367}," '/registerWebhook'",[79,4333,750],{"class":89},[79,4335,4336,4338,4340,4342,4344,4347,4349,4351,4353,4355,4357,4360,4362,4365],{"class":81,"line":416},[79,4337,4292],{"class":353},[79,4339,357],{"class":89},[79,4341,4297],{"class":360},[79,4343,364],{"class":89},[79,4345,4346],{"class":360},"registerWebhook",[79,4348,364],{"class":89},[79,4350,3238],{"class":388},[79,4352,494],{"class":89},[79,4354,2886],{"class":388},[79,4356,494],{"class":89},[79,4358,4359],{"class":345},"WEBHOOK",[79,4361,494],{"class":89},[79,4363,4364],{"class":345},"SECRET",[79,4366,4309],{"class":89},[79,4368,4369,4371,4373,4375,4377,4379,4381,4383,4385,4388],{"class":81,"line":437},[79,4370,778],{"class":89},[79,4372,781],{"class":103},[79,4374,4318],{"class":103},[79,4376,728],{"class":89},[79,4378,2886],{"class":353},[79,4380,357],{"class":89},[79,4382,4280],{"class":382},[79,4384,4283],{"class":349},[79,4386,4387],{"class":367}," '/unRegisterWebhook'",[79,4389,750],{"class":89},[79,4391,4392,4394,4396,4398,4400,4403,4405,4407],{"class":81,"line":458},[79,4393,4292],{"class":353},[79,4395,357],{"class":89},[79,4397,4297],{"class":360},[79,4399,364],{"class":89},[79,4401,4402],{"class":360},"unRegisterWebhook",[79,4404,364],{"class":89},[79,4406,3238],{"class":388},[79,4408,4309],{"class":89},[79,4410,4411,4413,4415],{"class":81,"line":479},[79,4412,778],{"class":89},[79,4414,781],{"class":103},[79,4416,90],{"class":89},[79,4418,4419,4421,4423,4425,4427,4430,4432,4434,4437],{"class":81,"line":501},[79,4420,4292],{"class":353},[79,4422,357],{"class":89},[79,4424,4297],{"class":360},[79,4426,364],{"class":89},[79,4428,4429],{"class":103},"new",[79,4431,3210],{"class":360},[79,4433,364],{"class":89},[79,4435,4436],{"class":367},"'No handler for this request'",[79,4438,4309],{"class":89},[79,4440,4441],{"class":81,"line":523},[79,4442,984],{"class":89},[79,4444,4445],{"class":81,"line":528},[79,4446,4447],{"class":89},"})\n",[189,4449,4450],{"id":4450},"核心功能",[19,4452,4453],{},"随后的三个函数，会先进行 SECRET 的校验，并将 message 类型消息从 TG 的所有消息类型中分离开单独处理",[70,4455,4457],{"className":322,"code":4456,"language":324,"meta":53,"style":53},"/**\n * Handle requests to WEBHOOK\n * https://core.telegram.org/bots/api#update\n */\nasync function handleWebhook (event) {\n  // Check secret\n  if (event.request.headers.get('X-Telegram-Bot-Api-Secret-Token') !== SECRET) {\n    return new Response('Unauthorized', { status: 403 })\n  }\n\n  // Read request body synchronously\n  const update = await event.request.json()\n  // Deal with response asynchronously\n  event.waitUntil(onUpdate(update))\n\n  return new Response('Ok')\n}\n\n/**\n * Handle incoming Update\n * https://core.telegram.org/bots/api#update\n */\nasync function onUpdate (update) {\n  if ('message' in update) {\n    await onMessage(update.message)\n  }\n}\n\n/**\n * Handle incoming Message\n * https://core.telegram.org/bots/api#message\n */\nfunction onMessage (message) {\n  return sendPlainText(message.chat.id, 'Echo:\\n' + message.text)\n}\n\n/**\n * Send plain text message\n * https://core.telegram.org/bots/api#sendmessage\n */\nasync function sendPlainText (chatId, text) {\n  return (await fetch(apiUrl('sendMessage', {\n    chat_id: chatId,\n    text\n  }))).json()\n",[76,4458,4459,4464,4469,4474,4479,4494,4499,4536,4563,4567,4571,4576,4600,4605,4627,4631,4646,4650,4654,4658,4663,4667,4671,4686,4701,4718,4723,4727,4732,4737,4743,4749,4754,4768,4812,4817,4822,4827,4833,4839,4844,4864,4888,4901,4907],{"__ignoreMap":53},[79,4460,4461],{"class":81,"line":82},[79,4462,4463],{"class":331},"/**\n",[79,4465,4466],{"class":81,"line":93},[79,4467,4468],{"class":331}," * Handle requests to WEBHOOK\n",[79,4470,4471],{"class":81,"line":110},[79,4472,4473],{"class":331}," * https://core.telegram.org/bots/api#update\n",[79,4475,4476],{"class":81,"line":374},[79,4477,4478],{"class":331}," */\n",[79,4480,4481,4483,4485,4488,4490,4492],{"class":81,"line":394},[79,4482,2752],{"class":103},[79,4484,2755],{"class":103},[79,4486,4487],{"class":360}," handleWebhook",[79,4489,728],{"class":89},[79,4491,3238],{"class":715},[79,4493,750],{"class":89},[79,4495,4496],{"class":81,"line":416},[79,4497,4498],{"class":331},"  // Check secret\n",[79,4500,4501,4503,4505,4507,4509,4511,4513,4516,4518,4521,4523,4526,4529,4532,4534],{"class":81,"line":437},[79,4502,725],{"class":103},[79,4504,728],{"class":89},[79,4506,3238],{"class":353},[79,4508,357],{"class":89},[79,4510,3188],{"class":401},[79,4512,357],{"class":89},[79,4514,4515],{"class":401},"headers",[79,4517,357],{"class":89},[79,4519,4520],{"class":360},"get",[79,4522,364],{"class":89},[79,4524,4525],{"class":367},"'X-Telegram-Bot-Api-Secret-Token'",[79,4527,4528],{"class":89},") ",[79,4530,4531],{"class":349},"!==",[79,4533,4204],{"class":345},[79,4535,750],{"class":89},[79,4537,4538,4540,4542,4544,4546,4549,4552,4555,4557,4560],{"class":81,"line":458},[79,4539,2958],{"class":103},[79,4541,2805],{"class":103},[79,4543,3210],{"class":360},[79,4545,364],{"class":89},[79,4547,4548],{"class":367},"'Unauthorized'",[79,4550,4551],{"class":89},", { ",[79,4553,4554],{"class":382},"status",[79,4556,3020],{"class":3019},[79,4558,4559],{"class":85}," 403",[79,4561,4562],{"class":89}," })\n",[79,4564,4565],{"class":81,"line":479},[79,4566,984],{"class":89},[79,4568,4569],{"class":81,"line":501},[79,4570,337],{"emptyLinePlaceholder":44},[79,4572,4573],{"class":81,"line":523},[79,4574,4575],{"class":331},"  // Read request body synchronously\n",[79,4577,4578,4580,4583,4585,4587,4590,4592,4594,4596,4598],{"class":81,"line":528},[79,4579,1617],{"class":103},[79,4581,4582],{"class":345}," update",[79,4584,350],{"class":349},[79,4586,2878],{"class":103},[79,4588,4589],{"class":353}," event",[79,4591,357],{"class":89},[79,4593,3188],{"class":401},[79,4595,357],{"class":89},[79,4597,2906],{"class":360},[79,4599,2909],{"class":89},[79,4601,4602],{"class":81,"line":541},[79,4603,4604],{"class":331},"  // Deal with response asynchronously\n",[79,4606,4607,4610,4612,4615,4617,4620,4622,4625],{"class":81,"line":558},[79,4608,4609],{"class":353},"  event",[79,4611,357],{"class":89},[79,4613,4614],{"class":360},"waitUntil",[79,4616,364],{"class":89},[79,4618,4619],{"class":360},"onUpdate",[79,4621,364],{"class":89},[79,4623,4624],{"class":388},"update",[79,4626,4309],{"class":89},[79,4628,4629],{"class":81,"line":931},[79,4630,337],{"emptyLinePlaceholder":44},[79,4632,4633,4635,4637,4639,4641,4644],{"class":81,"line":936},[79,4634,1680],{"class":103},[79,4636,2805],{"class":103},[79,4638,3210],{"class":360},[79,4640,364],{"class":89},[79,4642,4643],{"class":367},"'Ok'",[79,4645,1099],{"class":89},[79,4647,4648],{"class":81,"line":947},[79,4649,113],{"class":89},[79,4651,4652],{"class":81,"line":962},[79,4653,337],{"emptyLinePlaceholder":44},[79,4655,4656],{"class":81,"line":981},[79,4657,4463],{"class":331},[79,4659,4660],{"class":81,"line":987},[79,4661,4662],{"class":331}," * Handle incoming Update\n",[79,4664,4665],{"class":81,"line":3478},[79,4666,4473],{"class":331},[79,4668,4669],{"class":81,"line":3488},[79,4670,4478],{"class":331},[79,4672,4673,4675,4677,4680,4682,4684],{"class":81,"line":3505},[79,4674,2752],{"class":103},[79,4676,2755],{"class":103},[79,4678,4679],{"class":360}," onUpdate",[79,4681,728],{"class":89},[79,4683,4624],{"class":715},[79,4685,750],{"class":89},[79,4687,4688,4690,4692,4695,4697,4699],{"class":81,"line":3510},[79,4689,725],{"class":103},[79,4691,728],{"class":89},[79,4693,4694],{"class":367},"'message'",[79,4696,1435],{"class":103},[79,4698,4582],{"class":388},[79,4700,750],{"class":89},[79,4702,4703,4705,4708,4710,4712,4714,4716],{"class":81,"line":3515},[79,4704,755],{"class":103},[79,4706,4707],{"class":360}," onMessage",[79,4709,364],{"class":89},[79,4711,4624],{"class":353},[79,4713,357],{"class":89},[79,4715,1827],{"class":382},[79,4717,1099],{"class":89},[79,4719,4721],{"class":81,"line":4720},26,[79,4722,984],{"class":89},[79,4724,4725],{"class":81,"line":3},[79,4726,113],{"class":89},[79,4728,4730],{"class":81,"line":4729},28,[79,4731,337],{"emptyLinePlaceholder":44},[79,4733,4735],{"class":81,"line":4734},29,[79,4736,4463],{"class":331},[79,4738,4740],{"class":81,"line":4739},30,[79,4741,4742],{"class":331}," * Handle incoming Message\n",[79,4744,4746],{"class":81,"line":4745},31,[79,4747,4748],{"class":331}," * https://core.telegram.org/bots/api#message\n",[79,4750,4752],{"class":81,"line":4751},32,[79,4753,4478],{"class":331},[79,4755,4757,4760,4762,4764,4766],{"class":81,"line":4756},33,[79,4758,4759],{"class":103},"function",[79,4761,4707],{"class":360},[79,4763,728],{"class":89},[79,4765,1827],{"class":715},[79,4767,750],{"class":89},[79,4769,4771,4773,4776,4778,4780,4782,4785,4787,4790,4792,4795,4797,4800,4803,4806,4808,4810],{"class":81,"line":4770},34,[79,4772,1680],{"class":103},[79,4774,4775],{"class":360}," sendPlainText",[79,4777,364],{"class":89},[79,4779,1827],{"class":353},[79,4781,357],{"class":89},[79,4783,4784],{"class":401},"chat",[79,4786,357],{"class":89},[79,4788,4789],{"class":382},"id",[79,4791,494],{"class":89},[79,4793,4794],{"class":367},"'Echo:",[79,4796,3445],{"class":349},[79,4798,4799],{"class":367},"'",[79,4801,4802],{"class":349}," +",[79,4804,4805],{"class":353}," message",[79,4807,357],{"class":89},[79,4809,1623],{"class":382},[79,4811,1099],{"class":89},[79,4813,4815],{"class":81,"line":4814},35,[79,4816,113],{"class":89},[79,4818,4820],{"class":81,"line":4819},36,[79,4821,337],{"emptyLinePlaceholder":44},[79,4823,4825],{"class":81,"line":4824},37,[79,4826,4463],{"class":331},[79,4828,4830],{"class":81,"line":4829},38,[79,4831,4832],{"class":331}," * Send plain text message\n",[79,4834,4836],{"class":81,"line":4835},39,[79,4837,4838],{"class":331}," * https://core.telegram.org/bots/api#sendmessage\n",[79,4840,4842],{"class":81,"line":4841},40,[79,4843,4478],{"class":331},[79,4845,4847,4849,4851,4853,4855,4858,4860,4862],{"class":81,"line":4846},41,[79,4848,2752],{"class":103},[79,4850,2755],{"class":103},[79,4852,4775],{"class":360},[79,4854,728],{"class":89},[79,4856,4857],{"class":715},"chatId",[79,4859,494],{"class":89},[79,4861,1623],{"class":715},[79,4863,750],{"class":89},[79,4865,4867,4869,4871,4874,4876,4878,4881,4883,4886],{"class":81,"line":4866},42,[79,4868,1680],{"class":103},[79,4870,728],{"class":89},[79,4872,4873],{"class":103},"await",[79,4875,2881],{"class":360},[79,4877,364],{"class":89},[79,4879,4880],{"class":360},"apiUrl",[79,4882,364],{"class":89},[79,4884,4885],{"class":367},"'sendMessage'",[79,4887,3074],{"class":89},[79,4889,4891,4894,4896,4899],{"class":81,"line":4890},43,[79,4892,4893],{"class":382},"    chat_id",[79,4895,3020],{"class":3019},[79,4897,4898],{"class":388}," chatId",[79,4900,3026],{"class":89},[79,4902,4904],{"class":81,"line":4903},44,[79,4905,4906],{"class":388},"    text\n",[79,4908,4910,4913,4915],{"class":81,"line":4909},45,[79,4911,4912],{"class":89},"  }))).",[79,4914,2906],{"class":360},[79,4916,2909],{"class":89},[19,4918,4919],{},"我们需要更改的就是这个 onMessage 函数，用户输入的文本信息通过 message.text 获取，我们可以很轻易的把 b23 remover 的逻辑用 js 实现",[70,4921,4923],{"className":322,"code":4922,"language":324,"meta":53,"style":53},"async function onMessage(message) {\n    if (!message.text) {\n        return;\n    }\n    const b23Reg = /b23\\.tv\\/[a-zA-Z0-9]+/g;\n    if (!b23Reg.test(message.text)) {\n        console.log('No match found');\n    }\n    const b23Links = message.text.match(b23Reg);\n    const cleanLinks = [];\n    await Promise.all(\n        b23Links.map(link => b23Remover('https://' + link))\n    ).then(result => {\n        cleanLinks.push(...result);\n    });\n\n    const text2Send = \"Track ID removed:\\n\" + cleanLinks.join(\"\\n\");\n    return sendPlainText(message.chat.id, text2Send);\n}\n\nasync function b23Remover (url) {\n    const r = await fetch(url)\n    const v = r.url\n    const u = new URL(v)\n    return u.origin + u.pathname\n}\n",[76,4924,4925,4939,4956,4963,4967,5004,5030,5046,5050,5076,5088,5104,5136,5153,5171,5176,5180,5214,5239,5243,5247,5261,5280,5296,5316,5336],{"__ignoreMap":53},[79,4926,4927,4929,4931,4933,4935,4937],{"class":81,"line":82},[79,4928,2752],{"class":103},[79,4930,2755],{"class":103},[79,4932,4707],{"class":360},[79,4934,364],{"class":89},[79,4936,1827],{"class":715},[79,4938,750],{"class":89},[79,4940,4941,4943,4945,4948,4950,4952,4954],{"class":81,"line":93},[79,4942,2914],{"class":103},[79,4944,728],{"class":89},[79,4946,4947],{"class":349},"!",[79,4949,1827],{"class":353},[79,4951,357],{"class":89},[79,4953,1623],{"class":382},[79,4955,750],{"class":89},[79,4957,4958,4961],{"class":81,"line":110},[79,4959,4960],{"class":103},"        return",[79,4962,107],{"class":89},[79,4964,4965],{"class":81,"line":374},[79,4966,2145],{"class":89},[79,4968,4969,4971,4974,4976,4980,4983,4986,4989,4992,4996,4999,5002],{"class":81,"line":394},[79,4970,788],{"class":103},[79,4972,4973],{"class":345}," b23Reg",[79,4975,350],{"class":349},[79,4977,4979],{"class":4978},"sDaw7"," /b23",[79,4981,4982],{"class":349},"\\.",[79,4984,4985],{"class":4978},"tv",[79,4987,4988],{"class":349},"\\/",[79,4990,4991],{"class":85},"[a-zA-Z0-9]",[79,4993,4995],{"class":4994},"sYoRg","+",[79,4997,4998],{"class":4978},"/",[79,5000,5001],{"class":103},"g",[79,5003,107],{"class":89},[79,5005,5006,5008,5010,5012,5015,5017,5020,5022,5024,5026,5028],{"class":81,"line":416},[79,5007,2914],{"class":103},[79,5009,728],{"class":89},[79,5011,4947],{"class":349},[79,5013,5014],{"class":353},"b23Reg",[79,5016,357],{"class":89},[79,5018,5019],{"class":360},"test",[79,5021,364],{"class":89},[79,5023,1827],{"class":353},[79,5025,357],{"class":89},[79,5027,1623],{"class":382},[79,5029,3342],{"class":89},[79,5031,5032,5035,5037,5039,5041,5044],{"class":81,"line":437},[79,5033,5034],{"class":353},"        console",[79,5036,357],{"class":89},[79,5038,3146],{"class":360},[79,5040,364],{"class":89},[79,5042,5043],{"class":367},"'No match found'",[79,5045,371],{"class":89},[79,5047,5048],{"class":81,"line":458},[79,5049,2145],{"class":89},[79,5051,5052,5054,5057,5059,5061,5063,5065,5067,5070,5072,5074],{"class":81,"line":479},[79,5053,788],{"class":103},[79,5055,5056],{"class":345}," b23Links",[79,5058,350],{"class":349},[79,5060,4805],{"class":353},[79,5062,357],{"class":89},[79,5064,1623],{"class":401},[79,5066,357],{"class":89},[79,5068,5069],{"class":360},"match",[79,5071,364],{"class":89},[79,5073,5014],{"class":388},[79,5075,371],{"class":89},[79,5077,5078,5080,5083,5085],{"class":81,"line":501},[79,5079,788],{"class":103},[79,5081,5082],{"class":345}," cleanLinks",[79,5084,350],{"class":349},[79,5086,5087],{"class":89}," [];\n",[79,5089,5090,5092,5096,5098,5101],{"class":81,"line":523},[79,5091,755],{"class":103},[79,5093,5095],{"class":5094},"sC09Y"," Promise",[79,5097,357],{"class":89},[79,5099,5100],{"class":360},"all",[79,5102,5103],{"class":89},"(\n",[79,5105,5106,5109,5111,5114,5116,5119,5121,5124,5126,5129,5131,5134],{"class":81,"line":528},[79,5107,5108],{"class":353},"        b23Links",[79,5110,357],{"class":89},[79,5112,5113],{"class":360},"map",[79,5115,364],{"class":89},[79,5117,5118],{"class":715},"link",[79,5120,718],{"class":103},[79,5122,5123],{"class":360}," b23Remover",[79,5125,364],{"class":89},[79,5127,5128],{"class":367},"'https://'",[79,5130,4802],{"class":349},[79,5132,5133],{"class":388}," link",[79,5135,4309],{"class":89},[79,5137,5138,5141,5144,5146,5149,5151],{"class":81,"line":541},[79,5139,5140],{"class":89},"    ).",[79,5142,5143],{"class":360},"then",[79,5145,364],{"class":89},[79,5147,5148],{"class":715},"result",[79,5150,718],{"class":103},[79,5152,90],{"class":89},[79,5154,5155,5158,5160,5162,5164,5167,5169],{"class":81,"line":558},[79,5156,5157],{"class":353},"        cleanLinks",[79,5159,357],{"class":89},[79,5161,3374],{"class":360},[79,5163,364],{"class":89},[79,5165,5166],{"class":3019},"...",[79,5168,5148],{"class":388},[79,5170,371],{"class":89},[79,5172,5173],{"class":81,"line":931},[79,5174,5175],{"class":89},"    });\n",[79,5177,5178],{"class":81,"line":936},[79,5179,337],{"emptyLinePlaceholder":44},[79,5181,5182,5184,5187,5189,5192,5194,5196,5198,5200,5202,5204,5206,5208,5210,5212],{"class":81,"line":947},[79,5183,788],{"class":103},[79,5185,5186],{"class":345}," text2Send",[79,5188,350],{"class":349},[79,5190,5191],{"class":367}," \"Track ID removed:",[79,5193,3445],{"class":349},[79,5195,3462],{"class":367},[79,5197,4802],{"class":349},[79,5199,5082],{"class":353},[79,5201,357],{"class":89},[79,5203,3456],{"class":360},[79,5205,364],{"class":89},[79,5207,3462],{"class":367},[79,5209,3445],{"class":349},[79,5211,3462],{"class":367},[79,5213,371],{"class":89},[79,5215,5216,5218,5220,5222,5224,5226,5228,5230,5232,5234,5237],{"class":81,"line":962},[79,5217,2958],{"class":103},[79,5219,4775],{"class":360},[79,5221,364],{"class":89},[79,5223,1827],{"class":353},[79,5225,357],{"class":89},[79,5227,4784],{"class":401},[79,5229,357],{"class":89},[79,5231,4789],{"class":382},[79,5233,494],{"class":89},[79,5235,5236],{"class":388},"text2Send",[79,5238,371],{"class":89},[79,5240,5241],{"class":81,"line":981},[79,5242,113],{"class":89},[79,5244,5245],{"class":81,"line":987},[79,5246,337],{"emptyLinePlaceholder":44},[79,5248,5249,5251,5253,5255,5257,5259],{"class":81,"line":3478},[79,5250,2752],{"class":103},[79,5252,2755],{"class":103},[79,5254,5123],{"class":360},[79,5256,728],{"class":89},[79,5258,2886],{"class":715},[79,5260,750],{"class":89},[79,5262,5263,5265,5268,5270,5272,5274,5276,5278],{"class":81,"line":3488},[79,5264,788],{"class":103},[79,5266,5267],{"class":345}," r",[79,5269,350],{"class":349},[79,5271,2878],{"class":103},[79,5273,2881],{"class":360},[79,5275,364],{"class":89},[79,5277,2886],{"class":388},[79,5279,1099],{"class":89},[79,5281,5282,5284,5287,5289,5291,5293],{"class":81,"line":3505},[79,5283,788],{"class":103},[79,5285,5286],{"class":345}," v",[79,5288,350],{"class":349},[79,5290,5267],{"class":353},[79,5292,357],{"class":89},[79,5294,5295],{"class":382},"url\n",[79,5297,5298,5300,5303,5305,5307,5309,5311,5314],{"class":81,"line":3510},[79,5299,788],{"class":103},[79,5301,5302],{"class":345}," u",[79,5304,350],{"class":349},[79,5306,2805],{"class":103},[79,5308,2808],{"class":360},[79,5310,364],{"class":89},[79,5312,5313],{"class":388},"v",[79,5315,1099],{"class":89},[79,5317,5318,5320,5322,5324,5327,5329,5331,5333],{"class":81,"line":3515},[79,5319,2958],{"class":103},[79,5321,5302],{"class":353},[79,5323,357],{"class":89},[79,5325,5326],{"class":382},"origin",[79,5328,4802],{"class":349},[79,5330,5302],{"class":353},[79,5332,357],{"class":89},[79,5334,5335],{"class":382},"pathname\n",[79,5337,5338],{"class":81,"line":4720},[79,5339,113],{"class":89},[189,5341,5343],{"id":5342},"webhook-注册相关","webhook 注册相关",[19,5345,5346],{},"后面的 registerWebhook、unRegisterWebhook、apiUrl 在没有特定需求的情况下不需要变动。",[19,5348,5349],{},"在 Cloudflare 部署后，就可以访问 aaa.bbb.workers.dev/registerWebhook 这个 url 注册 TG 的 webhook 服务。收到 Ok 就代表注册好了。",[19,5351,5352],{},[25,5353],{"alt":53,"src":5354},"https://static.031130.xyz/uploads/2024/12/30/5fd442bb18064.webp",[118,5356,5357],{"id":5357},"成果展示",[19,5359,5360],{},[25,5361],{"alt":53,"src":5362},"https://static.031130.xyz/uploads/2024/12/30/3b0b929960840.webp",[264,5364,5365],{},"html pre.shiki code .sLKXg, html code.shiki .sLKXg{--shiki-default:#A626A4;--shiki-dark:#C678DD}html pre.shiki code .sNmU0, html code.shiki .sNmU0{--shiki-default:#986801;--shiki-dark:#E5C07B}html pre.shiki code .s_Sar, html code.shiki .s_Sar{--shiki-default:#0184BC;--shiki-dark:#56B6C2}html pre.shiki code .sW2Sy, html code.shiki .sW2Sy{--shiki-default:#A0A1A7;--shiki-default-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic}html pre.shiki code .sDhpE, html code.shiki .sDhpE{--shiki-default:#50A14F;--shiki-dark:#98C379}html .default .shiki span {color: var(--shiki-default);background: var(--shiki-default-bg);font-style: var(--shiki-default-font-style);font-weight: var(--shiki-default-font-weight);text-decoration: var(--shiki-default-text-decoration);}html .shiki span {color: var(--shiki-default);background: var(--shiki-default-bg);font-style: var(--shiki-default-font-style);font-weight: var(--shiki-default-font-weight);text-decoration: var(--shiki-default-text-decoration);}html .dark .shiki span {color: var(--shiki-dark);background: var(--shiki-dark-bg);font-style: var(--shiki-dark-font-style);font-weight: var(--shiki-dark-font-weight);text-decoration: var(--shiki-dark-text-decoration);}html.dark .shiki span {color: var(--shiki-dark);background: var(--shiki-dark-bg);font-style: var(--shiki-dark-font-style);font-weight: var(--shiki-dark-font-weight);text-decoration: var(--shiki-dark-text-decoration);}html pre.shiki code .sAdtL, html code.shiki .sAdtL{--shiki-default:#4078F2;--shiki-dark:#61AFEF}html pre.shiki code .s5ixo, html code.shiki .s5ixo{--shiki-default:#383A42;--shiki-dark:#ABB2BF}html pre.shiki code .s8iYz, html code.shiki .s8iYz{--shiki-default:#383A42;--shiki-default-font-style:inherit;--shiki-dark:#E06C75;--shiki-dark-font-style:italic}html pre.shiki code .s7GmK, html code.shiki .s7GmK{--shiki-default:#383A42;--shiki-dark:#E5C07B}html pre.shiki code .s2QsP, html code.shiki .s2QsP{--shiki-default:#E45649;--shiki-dark:#E5C07B}html pre.shiki code .sJa8x, html code.shiki .sJa8x{--shiki-default:#E45649;--shiki-dark:#E06C75}html pre.shiki code .sz0mV, html code.shiki .sz0mV{--shiki-default:#383A42;--shiki-dark:#E06C75}html pre.shiki code .st7oF, html code.shiki .st7oF{--shiki-default:#0184BC;--shiki-dark:#ABB2BF}html pre.shiki code .sAGMh, html code.shiki .sAGMh{--shiki-default:#986801;--shiki-dark:#D19A66}html pre.shiki code .sDaw7, html code.shiki .sDaw7{--shiki-default:#0184BC;--shiki-dark:#E06C75}html pre.shiki code .sYoRg, html code.shiki .sYoRg{--shiki-default:#0184BC;--shiki-dark:#D19A66}html pre.shiki code .sC09Y, html code.shiki .sC09Y{--shiki-default:#C18401;--shiki-dark:#E5C07B}",{"title":53,"searchDepth":93,"depth":93,"links":5367},[5368,5369,5370,5376],{"id":3551,"depth":93,"text":3551},{"id":4124,"depth":93,"text":4125},{"id":4149,"depth":93,"text":4149,"children":5371},[5372,5373,5374,5375],{"id":4155,"depth":110,"text":4155},{"id":4215,"depth":110,"text":4215},{"id":4450,"depth":110,"text":4450},{"id":5342,"depth":110,"text":5343},{"id":5357,"depth":93,"text":5357},{"title":5378,"date":5379,"path":5380,"tags":5381,"body":5385},"2024年，Firefox 是唯一还在坚持执行在线的 SSL 证书吊销状态检查的主流浏览器","2024-11-19 17:58:14","/2024/11/19/firefox-is-the-only-mainstream-brower-doing-online-certificate-revocation-checks",[5382,5383,5384],"Firefox","SSL","OpenSSL",{"type":16,"value":5386,"toc":5884},[5387,5391,5394,5408,5415,5418,5423,5426,5433,5445,5453,5458,5461,5466,5470,5479,5483,5486,5490,5493,5496,5535,5540,5546,5549,5552,5563,5566,5572,5576,5583,5628,5638,5641,5657,5661,5664,5667,5670,5688,5691,5696,5700,5717,5720,5737,5740,5743,5746,5752,5755,5758,5767,5769,5881],[118,5388,5390],{"id":5389},"小试一下","小试一下？",[19,5392,5393],{},"在开始阅读后面的内容之前，或许你可以试试看你正在使用的浏览器能不能访问下面两个链接:",[129,5395,5396,5402],{},[132,5397,5398],{},[32,5399,5400],{"href":5400,"rel":5401},"https://digicert-tls-ecc-p384-root-g5-revoked.chain-demos.digicert.com/",[36],[132,5403,5404],{},[32,5405,5406],{"href":5406,"rel":5407},"https://revoked-isrgrootx1.letsencrypt.org/",[36],[19,5409,5410,5411,5414],{},"这两个链接分别是由 digicert 和 Let's Encrypt 维护的，特意维持了一个",[135,5412,5413],{},"证书没过期，但被 CA 吊销","的状态。",[19,5416,5417],{},"在我的 Firefox for Linux 上，两个链接我都无法打开。",[19,5419,5420],{},[25,5421],{"alt":53,"src":5422},"https://static.031130.xyz/uploads/2024/11/19/f7785db60b2c8.webp",[19,5424,5425],{},"这是预期行为。Firefox 在与目标站点建立 https 链接之前，先向 CA 提供的 OCSP 服务器打了一个 http 请求来判断目标站点的 ssl 证书是否有效（是否没有被 CA 主动吊销）。",[19,5427,5428,5429],{},"在 Firefox for Android 上，我无法打开第一个链接，但可以打开第二个，这是因为 Mozilla 给 Android 用户设置的策略为「只对 EV 证书进行 ocsp 校验，跳过 DV 证书和 OV 证书」，",[5430,5431,5432],"em",{},"似乎在竞争更加激烈的移动端，Firefox 为了加载速度做出了安全性上的妥协。",[1386,5434,5435,5439,5442],{},[25,5436],{"src":5437,"style":5438},"https://static.031130.xyz/uploads/2024/11/19/b097e954f766f.webp","zoom:33%;",[79,5440],{"style":5441},"width: 20%;",[25,5443],{"src":5444,"style":5438},"https://static.031130.xyz/uploads/2024/11/19/a5f58dbb50cfe.webp",[19,5446,5447,5448,2269],{},"而在 Google Chrome / Microsoft Edge 上，OCSP 是不被支持的，chromium 团队在 2014 年就禁用了 OCSP 校验，且目前没有设置项允许用户手动开启，目前它只支持",[32,5449,5452],{"href":5450,"rel":5451},"https://www.chromium.org/Home/chromium-security/crlsets/",[36],"本地的 CRLSets 规则集",[19,5454,5455],{},[25,5456],{"alt":53,"src":5457},"https://static.031130.xyz/uploads/2024/11/19/bd84e9aff71d0.webp",[19,5459,5460],{},"Safari 经我本人测试默认只对 EV 证书进行有效性检验。",[19,5462,5463],{},[25,5464],{"alt":53,"src":5465},"https://static.031130.xyz/uploads/2024/11/19/50352339f7473.webp",[118,5467,5469],{"id":5468},"ssl-证书被吊销是怎么回事","SSL 证书被吊销是怎么回事？",[19,5471,5472,5473,5478],{},"在某些情况下（比如用户告知 CA 颁发给自己的证书私钥不慎被泄漏了，或者 ",[32,5474,5477],{"href":5475,"rel":5476},"https://www.trustasia.com/view-security-lets-encrypt/",[36],"CA 的颁发程序出现漏洞被人滥用，需要吊销在此期间发出去的所有证书","），CA 需要吊销一些证书，并通过自己的渠道将被吊销的证书尽快告知所有用户——需要被吊销的证书和正常的证书在外观上没有任何区别，用户的浏览器必须依赖 CA 的外部消息通知才能知道哪些证书是被吊销的。",[118,5480,5482],{"id":5481},"firefox-是如何接收来自-ca-的吊销信息的","Firefox 是如何接收来自 CA 的吊销信息的？",[19,5484,5485],{},"Firefox 通过提供了两种方案，以便用户从 CA 处得知目标站点的证书是否被吊销。",[189,5487,5489],{"id":5488},"ocsp","OCSP",[19,5491,5492],{},"正如我前文所说的，Firefox 的 PC 端在与目标站点建立 https 连接之前，会先通过 http 协议向 CA 的 OCSP 服务器打一个 POST 请求来确认证书是否被吊销。",[19,5494,5495],{},"我们可以通过 openssl 拿到目标站点的 ssl 公钥，查看 CA 指定的 OCSP Server",[70,5497,5499],{"className":2155,"code":5498,"language":2157,"meta":53,"style":53},"openssl s_client -connect example.com:443 -servername example.com | openssl x509 -text -noout\n\n",[76,5500,5501],{"__ignoreMap":53},[79,5502,5503,5506,5509,5512,5515,5518,5521,5524,5526,5529,5532],{"class":81,"line":82},[79,5504,5505],{"class":360},"openssl",[79,5507,5508],{"class":367}," s_client",[79,5510,5511],{"class":85}," -connect",[79,5513,5514],{"class":367}," example.com:443",[79,5516,5517],{"class":85}," -servername",[79,5519,5520],{"class":367}," example.com",[79,5522,5523],{"class":89}," | ",[79,5525,5505],{"class":360},[79,5527,5528],{"class":367}," x509",[79,5530,5531],{"class":85}," -text",[79,5533,5534],{"class":85}," -noout\n",[19,5536,5537],{},[25,5538],{"alt":53,"src":5539},"https://static.031130.xyz/uploads/2024/11/19/32579fb56b77b.webp",[19,5541,5542],{},[25,5543],{"alt":5544,"src":5545},"访问第二个链接时的抓包结果","https://static.031130.xyz/uploads/2024/11/19/244704705924f.webp",[1030,5547,5548],{"id":5548},"软失败",[19,5550,5551],{},"这个请求一共有三种结果:",[154,5553,5554,5557,5560],{},[132,5555,5556],{},"请求结果正常，证书没有被吊销：Firefox 继续和目标站点建立 https 连接",[132,5558,5559],{},"请求结果正常，证书被吊销：Firefox 拒绝和目标站点建立 https 连接，如同我在博客开头贴的图",[132,5561,5562],{},"请求结果异常（请求超时）：Firefox 继续和目标站点建立 https 连接",[19,5564,5565],{},"透过在第三种情况，我们可以发现，Firefox 对 OCSP 检查的结果是软失败 (soft fail) 态度——即如果在 OCSP 过程中发生异常，Firefox 将不得不放弃 OCSP 检查并放行。根据 Mozilla Blog 的说法，如今有 9.9% 的 OCSP 检查都是超时的。",[19,5567,5568],{},[25,5569],{"alt":5570,"src":5571},"https://blog.mozilla.org/security/files/2020/01/figure4-ocsp_results.png","https://static.031130.xyz/uploads/2024/11/19/4a6c899a41128.webp",[1030,5573,5575],{"id":5574},"firefox-中的相关配置项","Firefox 中的相关配置项",[19,5577,5578,5579,5582],{},"在 Firefox 的 ",[76,5580,5581],{},"about:config"," 配置中搜索，我们可以看到一些关于 OCSP 的配置项",[129,5584,5585,5602,5616,5622],{},[132,5586,5587,5590,5591],{},[76,5588,5589],{},"security.OCSP.enabled",": 是否开启 OCSP 检查，默认为 1",[129,5592,5593,5596,5599],{},[132,5594,5595],{},"0: 关闭 OCSP 检查",[132,5597,5598],{},"1: 开启 OCSP 检查",[132,5600,5601],{},"2: 只对 EV 证书进行 OCSP 检查",[132,5603,5604,5607,5608],{},[76,5605,5606],{},"security.OCSP.required",": 是否一定要通过 OCSP 才允许建立连接（即是否不允许“软失败”），默认为 false",[129,5609,5610,5613],{},[132,5611,5612],{},"false: 允许软失败",[132,5614,5615],{},"true: 不允许软失败",[132,5617,5618,5621],{},[76,5619,5620],{},"security.OCSP.timeoutMilliseconds.hard",": 针对 EV 证书，OCSP 检查的超时时间，默认为 10000 (10 秒)",[132,5623,5624,5627],{},[76,5625,5626],{},"security.OCSP.timeoutMilliseconds.soft",": 针对 DV 和 OV 证书，OCSP 检查的超时时间，默认为 2000（2 秒），移动端为 1 秒。",[19,5629,5630],{},[5430,5631,5632,5633],{},"EV 证书相比 DV 和 OV 有更严苛的申请条件，区别可以参考",[32,5634,5637],{"href":5635,"rel":5636},"https://www.digicert.com/cn/difference-between-dv-ov-and-ev-ssl-certificates",[36],"DV、OV和EV SSL证书之间有什么区别？",[1030,5639,5640],{"id":5640},"弊端",[129,5642,5643,5646,5654],{},[132,5644,5645],{},"ocsp 不能在不增加用户负担的情况下使用硬失败(hard fail)，对于无响应或者超时的 ocsp 验证只能直接放行，这意味着攻击者可以直接屏蔽浏览器和 CA 之间的连接，拖到 ocsp 超时，并不能有效保障用户免受攻击。",[132,5647,5648,5649,2269],{},"在 ocsp server 响应或者连接超时前，与目标站点的 https 连接会被阻塞，这带来了更大的访问延迟。有时还会出现",[32,5650,5653],{"href":5651,"rel":5652},"https://blog.wolfogre.com/posts/letsencrypt-ocsp-breakdown/",[36],"用户与 ocsp server 无法连接的情况",[132,5655,5656],{},"ocsp 是由用户浏览器主动向 CA 发起 http 请求，可能会导致用户隐私泄漏（IP 地址、位置、用户的部分浏览历史记录等）。即使 CA 故意不保留这些信息，地区法律也可能强制 CA 收集这些信息。",[1030,5658,5660],{"id":5659},"ocsp-装订-ocsp-stapling","OCSP 装订 (OCSP stapling)",[19,5662,5663],{},"这是一种新的方式，由目标站点的服务器主动向 CA 的 ocsp 服务器缓存 ocsp 信息（有效期最长为 7 天），并将其在用户访问时将相关信息一起提供给用户，避免用户直接向 CA 的服务器发起查询请求，能够规避部分弊端（避免 CA 收集用户信息，规避用户与 CA OCSP 服务器连接性不好等问题）。",[19,5665,5666],{},"目前，caddy 是默认开启 OCSP 装订的，而 nginx 可以在配置后手动开启。",[19,5668,5669],{},"可以采用 openssl 来查询目标站点是否开启了 OCSP 装订：",[70,5671,5673],{"className":2155,"code":5672,"language":2157,"meta":53,"style":53},"openssl s_client -connect example.com:443 -status\n",[76,5674,5675],{"__ignoreMap":53},[79,5676,5677,5679,5681,5683,5685],{"class":81,"line":82},[79,5678,5505],{"class":360},[79,5680,5508],{"class":367},[79,5682,5511],{"class":85},[79,5684,5514],{"class":367},[79,5686,5687],{"class":85}," -status\n",[19,5689,5690],{},"如果开启了 OCSP 装订，那么返回的数据中会有 OCSP Response Data 相关的描述",[19,5692,5693],{},[25,5694],{"alt":53,"src":5695},"https://static.031130.xyz/uploads/2024/11/19/71f252c97e96e.webp",[189,5697,5699],{"id":5698},"crlite-wip","CRLite (WIP)",[19,5701,5702,5707,5708,5713,5714],{},[32,5703,5706],{"href":5704,"rel":5705},"https://obj.umiacs.umd.edu/papers_for_stories/crlite_oakland17.pdf",[36],"CRLite"," 是 ",[32,5709,5712],{"href":5710,"rel":5711},"https://www.ieee-security.org/TC/SP2017/",[36],"2017 年 IEEE 安全和隐私研讨会","上一组研究人员提出的一项技术，该技术可以有效地压缩吊销信息，使 300 兆字节的吊销数据可以变成 1 兆字节。CRLite 数据由 Mozilla 收集处理后推送给浏览器实现证书状态的本地查找，",[5430,5715,5716],{},"这项技术仍然处于开发阶段。",[19,5718,5719],{},"当浏览器使用 CRLite 查询对应站点的 ssl 证书的有效状态时，一般会有 5 种查询结果",[154,5721,5722,5725,5728,5731,5734],{},[132,5723,5724],{},"Certificate Valid，表示 CRLite 权威返回证书有效。",[132,5726,5727],{},"Certificate Revoked，表示 CRLite 权威返回证书已被吊销。",[132,5729,5730],{},"Issuer Not Enrolled, 这意味着正在评估的证书未包含在 CRLite 筛选器集中，可能是因为颁发证书的证书颁发机构 （CA） 未发布 CRL。",[132,5732,5733],{},"Certificate Too New，表示正在评估的证书比 CRLite 筛选器新。",[132,5735,5736],{},"Filter Not Available，这意味着 CRLite 过滤器要么尚未从 Remote Settings 下载，要么已经过时以至于停止服务。",[19,5738,5739],{},"Mozilla 计划每天发布 4 次 CRLite 的更新，以减少第 4 种情况。",[1030,5741,5742],{"id":5742},"速度优势",[19,5744,5745],{},"CRLite 的本地数据查询相比起 OCSP 的在线查询拥有天然的优势，99% 的情况下，CRLite 会比 OCSP 快，其中 56% 的情况下，CRLite 会比 OCSP 快 100 毫秒以上。",[19,5747,5748],{},[25,5749],{"alt":5750,"src":5751},"https://blog.mozilla.org/security/files/2020/01/figure3-speedup_vs_ocsp.png","https://static.031130.xyz/uploads/2024/11/19/bfba9ba3515ca.webp",[19,5753,5754],{},"此外，当 CRLite 不可用时，Firefox 仍然可以回退到传统的 OCSP 检测机制。",[118,5756,5757],{"id":5757},"其他",[19,5759,5760,5761,5766],{},"Let's Encrypt 在 2024 年 7 月",[32,5762,5765],{"href":5763,"rel":5764},"https://letsencrypt.org/2024/07/23/replacing-ocsp-with-crls/",[36],"发布博客","，CA/Browser Forum在上一年 8 月通过了一向投票允许 Let's Encrypt 等公开信任的 CA 将设立 OCSP server 作为可选选项。他们计划在未来 6~12 月内宣布关闭 OCSP 服务的时间表。",[118,5768,225],{"id":225},[129,5770,5771,5778,5785,5792,5799,5806,5813,5820,5831,5838,5845,5851,5858,5864,5870,5876],{},[132,5772,5773],{},[32,5774,5777],{"href":5775,"rel":5776},"https://wiki.mozilla.org/CA/Revocation_Checking_in_Firefox",[36],"CA/Revocation Checking in Firefox - MozillaWiki",[132,5779,5780],{},[32,5781,5784],{"href":5782,"rel":5783},"https://discourse.mozilla.org/t/firefox-ocsp-policy/83150",[36],"Firefox OCSP policy - Firefox Development - Mozilla Discourse",[132,5786,5787],{},[32,5788,5791],{"href":5789,"rel":5790},"https://knowledge.digicert.com/nl/nl/quovadis/ssl-certificates/ssl-general-topics/in-which-browsers-is-ocsp-online-certificates-status-protocol-supported-in",[36],"In which browsers is OCSP (Online Certificates Status Protocol) supported in?",[132,5793,5794],{},[32,5795,5798],{"href":5796,"rel":5797},"https://blog.mozilla.org/security/2020/01/09/crlite-part-1-all-web-pki-revocations-compressed/",[36],"Introducing CRLite: All of the Web PKI’s revocations, compressed - Mozilla Security Blog",[132,5800,5801],{},[32,5802,5805],{"href":5803,"rel":5804},"https://blog.mozilla.org/security/2020/01/21/crlite-part-3-speeding-up-secure-browsing/",[36],"CRLite: Speeding Up Secure Browsing - Mozilla Security Blog",[132,5807,5808],{},[32,5809,5812],{"href":5810,"rel":5811},"https://blog.cloudflare.com/high-reliability-ocsp-stapling/",[36],"High-reliability OCSP stapling and why it matters - The Cloudflare Blog",[132,5814,5815],{},[32,5816,5819],{"href":5817,"rel":5818},"https://en.wikipedia.org/wiki/Online_Certificate_Status_Protocol",[36],"Online Certificate Status Protocol - Wikipedia",[132,5821,5822],{},[32,5823,5826,5827,5830],{"href":5824,"rel":5825},"https://bugzilla.mozilla.org/show_bug.cgi?id=1429800",[36],"1429800 - (crlite) ",[79,5828,5829],{},"meta"," Implement a CRLite based revocation mechanism",[132,5832,5833],{},[32,5834,5837],{"href":5835,"rel":5836},"https://bugzilla.mozilla.org/show_bug.cgi?id=1761109",[36],"1761109 - Make check-revocations mode the default CRLite mode",[132,5839,5840],{},[32,5841,5844],{"href":5842,"rel":5843},"https://www.reddit.com/r/browsers/comments/1bb81y8/firefox_the_only_browser_doing_certificate/",[36],"Firefox - The only browser doing certificate revocation checks right : r/browsers",[132,5846,5847],{},[32,5848,5850],{"href":5763,"rel":5849},[36],"Intent to End OCSP Service - Let's Encrypt",[132,5852,5853],{},[32,5854,5857],{"href":5855,"rel":5856},"https://groups.google.com/a/mozilla.org/g/dev-security-policy/c/S6A14e_X-T0/m/T4WxWgajAAAJ",[36],"Revocation checking for EV server certificates in Chrome - Google Groups",[132,5859,5860],{},[32,5861,5863],{"href":5450,"rel":5862},[36],"CRLSets - The Chromium Projects",[132,5865,5866],{},[32,5867,5869],{"href":5475,"rel":5868},[36],"由于Bug，Let's Encrypt决定吊销300多万张证书！",[132,5871,5872],{},[32,5873,5875],{"href":5651,"rel":5874},[36],"Let’s Encrypt OCSP 域名被封",[132,5877,5878],{},[32,5879,5637],{"href":5635,"rel":5880},[36],[264,5882,5883],{},"html pre.shiki code .sAdtL, html code.shiki .sAdtL{--shiki-default:#4078F2;--shiki-dark:#61AFEF}html pre.shiki code .sDhpE, html code.shiki .sDhpE{--shiki-default:#50A14F;--shiki-dark:#98C379}html pre.shiki code .sAGMh, html code.shiki .sAGMh{--shiki-default:#986801;--shiki-dark:#D19A66}html pre.shiki code .s5ixo, html code.shiki .s5ixo{--shiki-default:#383A42;--shiki-dark:#ABB2BF}html .default .shiki span {color: var(--shiki-default);background: var(--shiki-default-bg);font-style: var(--shiki-default-font-style);font-weight: var(--shiki-default-font-weight);text-decoration: var(--shiki-default-text-decoration);}html .shiki span {color: var(--shiki-default);background: var(--shiki-default-bg);font-style: var(--shiki-default-font-style);font-weight: var(--shiki-default-font-weight);text-decoration: var(--shiki-default-text-decoration);}html .dark .shiki span {color: var(--shiki-dark);background: var(--shiki-dark-bg);font-style: var(--shiki-dark-font-style);font-weight: var(--shiki-dark-font-weight);text-decoration: var(--shiki-dark-text-decoration);}html.dark .shiki span {color: var(--shiki-dark);background: var(--shiki-dark-bg);font-style: var(--shiki-dark-font-style);font-weight: var(--shiki-dark-font-weight);text-decoration: var(--shiki-dark-text-decoration);}",{"title":53,"searchDepth":93,"depth":93,"links":5885},[5886,5887,5888,5892,5893],{"id":5389,"depth":93,"text":5390},{"id":5468,"depth":93,"text":5469},{"id":5481,"depth":93,"text":5482,"children":5889},[5890,5891],{"id":5488,"depth":110,"text":5489},{"id":5698,"depth":110,"text":5699},{"id":5757,"depth":93,"text":5757},{"id":225,"depth":93,"text":225},{"title":5895,"date":5896,"path":5897,"tags":5898,"body":5901},"小爱课程表适配不完全指北——以 ZJUT 本科正方教务系统为例","2024-11-18 21:13:56","/2024/11/18/mi-ai-class-schedule-adapter-for-zjut",[11,5899,5900],"MiAI","Fun",{"type":16,"value":5902,"toc":7951},[5903,5906,5909,5912,5915,5923,5931,5934,5937,5948,5961,5968,5980,5983,5986,5995,5998,6001,6006,6009,6014,6017,6020,6023,6026,6031,6034,6037,6042,6048,6052,6055,6060,6063,6214,6217,6228,6231,6265,6268,6271,6370,6373,6376,6379,6386,6391,6395,6401,6404,6410,6429,6436,6791,6794,6990,6993,7075,7079,7082,7306,7309,7360,7363,7370,7373,7449,7452,7567,7574,7578,7587,7911,7914,7921,7924,7929,7932,7937,7940,7945,7948],[118,5904,5905],{"id":5905},"写在前面",[19,5907,5908],{},"一个月前，我发现小爱课程表中针对我学校的教务系统导入系统年久失修，因此我便决定自己另立门户、独立维护一版针对 ZJUT 教务系统课表信息导入的适配项目。",[19,5910,5911],{},"整个流程不难，如果你对于 js 代码和爬虫技术有简单的了解，那么很快就可以上手，我大概只花了 2 小时就完成了 阅读文档-编写代码-自测通过-提交审核 的过程，并在一周内正式上架，得到了身边同学的认可。",[19,5913,5914],{},"在适配过程中，一定要仔细阅读官方文档，所有技术性问题几乎都能通过官方文档解决。这篇博客我尽量详细记录了使用 fetch 打请求获取 json 的正方教务系统适配方案，仅供参考。",[19,5916,5917,5918],{},"官方文档地址: ",[32,5919,5922],{"href":5920,"rel":5921},"https://open-schedule-prod.ai.xiaomi.com/docs/#/help/",[36],"小爱课程表开发者工具使用教程",[19,5924,5925,5926],{},"我的代码: ",[32,5927,5930],{"href":5928,"rel":5929},"https://github.com/zhullyb/ZJUT-Mi-Schedule-Adapter/",[36],"Github",[118,5932,5933],{"id":5933},"运行原理",[19,5935,5936],{},"小爱课表获取课表信息的大致流程如下",[154,5938,5939,5942,5945],{},[132,5940,5941],{},"在你的手机上调用系统 webview 进入你指定的教务系统，让你手动输入账号密码并完成登陆流程",[132,5943,5944],{},"获取含有课表信息的字符串（可以是直接获取页面展示的 html 代码，也可以是利用登陆时获取的 cookie/session 信息直接向后端发送请求拿响应）",[132,5946,5947],{},"解析获取到的字符串，按照小米预先定义好的 json 格式输出",[19,5949,5950,5951,5954,5955,632,5958],{},"作为适配者，我们需要提供三个代码文件，分别是 ",[76,5952,5953],{},"Provider","、",[76,5956,5957],{},"Parser",[76,5959,5960],{},"Timer",[19,5962,5963,632,5965,5967],{},[76,5964,5953],{},[76,5966,5960],{}," 都在本地登陆好教务系统后的 webview 环境中执行，前者需要返回步骤 2 中描述的带有课表信息的字符串，Timer 则返回课程时间、学期周数等信息。",[19,5969,5970,5972,5973,5975,5976,2103],{},[76,5971,5953],{}," 获取到的字符串将会成为 ",[76,5974,5957],{}," 的函数参数，这个函数将会上传到小米的服务器中运行，根据文档所说是为了满足部分开发者保护自己的代码防止被抓包而刻意设计的（虽然我不理解这种东西有什么好闭源的，",[79,5977,5979],{"className":5978},[292],"可能是为了防止友商批量抓包获取解析算法以后直接推出竞品",[118,5981,5982],{"id":5982},"适配实战",[189,5984,5985],{"id":5985},"安装浏览器插件",[19,5987,5988,5989,5994],{},"首先下载小米提供给我们的资源包，目前我拿到的最新的版本是 v0.3.8，",[32,5990,5993],{"href":5991,"rel":5992},"https://open-schedule-prod.ai.xiaomi.com/docs/#/help/?id=%e4%b8%8b%e8%bd%bd",[36],"下载链接","。注意不要被后缀骗了，这不是个 rar 包，我这里后缀改成 tar 后可以被 ark 正确解压，后缀名是 rar 可能是开发者希望 Windows 用户能用 winrar 进行解压？",[19,5996,5997],{},"这里需要一个 Chromium-based 的浏览器安装小米提供的浏览器插件。",[19,5999,6000],{},"然后使用 Chrome 的「加载已解压的扩展程序」安装整个被解压的目录。Chrome 安装后提示 Manifest version 2 将会在 2024 年被弃用，不知道小米能不能在 Chrome 弃用前支持 Manifest version 3，趁着能用我先不管它。",[19,6002,6003],{},[25,6004],{"alt":53,"src":6005},"https://static.031130.xyz/uploads/2024/11/18/f2a063c982a42.webp",[19,6007,6008],{},"随后打开自己学校的教务网站，F12 打开开发者工具，可以看到多了一栏叫「AISchedule」的选项",[19,6010,6011],{},[25,6012],{"alt":53,"src":6013},"https://static.031130.xyz/uploads/2024/11/18/800054d7f4ff8.webp",[19,6015,6016],{},"随后正常登陆自己的小米账号，放一旁备用。",[189,6018,6019],{"id":6019},"抓数据包",[19,6021,6022],{},"随后，登陆自己的教务网站，打开课表页面，查看 F12 开发者工具的网络一览，刷新页面加载自己的课表，查看开发者页面中显示的数据流，找到含有课表信息的那一个。",[19,6024,6025],{},"这个流程我个人用惯了 Firefox 浏览器，因此数据分析这一块的截图都是 Firefox 的截图。",[19,6027,6028],{},[25,6029],{"alt":53,"src":6030},"https://static.031130.xyz/uploads/2024/11/18/7ea6e1e0bbfcf.webp",[19,6032,6033],{},"在我的例子中，第一个请求的响应是一个 html 页面，勾勒出了这个页面的大致轮廓，不过没有样式。这是一个好的迹象，说明这大概率是一个前后端分离的站点，授课数据很可能是通过 json 的数据单独传递给前端的，我们就不需要从 html 中解析我们的课表。",[19,6035,6036],{},"如果能确定是前后端分离的站点，我们可以尝试勾选这里的「XHR」选项，XHR 的全名是 XMLHttpRequest，是一种前端向后端发起请求的方式，前后端的数据一般都会在这里展示。",[19,6038,6039],{},[25,6040],{"alt":53,"src":6041},"https://static.031130.xyz/uploads/2024/11/18/36880519d2109.webp",[19,6043,6044,6045,6047],{},"我在第三个请求中发现了我的课表信息，在已经登陆的情况下，小米的课程表允许我通过 fetch 函数打一个相同的请求给后端，获取这个响应结果作为 ",[76,6046,5953],{}," 部分的输出字符串。",[189,6049,6051],{"id":6050},"调试-fetch-参数","调试 fetch 参数",[19,6053,6054],{},"这个请求的 fetch 函数如何构建？可以直接右键这个请求，在菜单中选择「复制为 Fetch 语句」",[19,6056,6057],{},[25,6058],{"alt":53,"src":6059},"https://static.031130.xyz/uploads/2024/11/18/ff498f0a0957e.webp",[19,6061,6062],{},"复制下来的语句长下面这个样子",[70,6064,6066],{"className":322,"code":6065,"language":324,"meta":53,"style":53},"await fetch(\"http://www.gdjw.zjut.edu.cn/jwglxt/kbcx/xskbcx_cxXsgrkb.html?gnmkdm=N2151\", {\n    \"credentials\": \"include\",\n    \"headers\": {\n        \"User-Agent\": \"Mozilla/5.0 (X11; Linux x86_64; rv:133.0) Gecko/20100101 Firefox/133.0\",\n        \"Accept\": \"*/*\",\n        \"Accept-Language\": \"zh-CN,zh;q=0.8,zh-TW;q=0.7,zh-HK;q=0.5,en-US;q=0.3,en;q=0.2\",\n        \"Content-Type\": \"application/x-www-form-urlencoded;charset=utf-8\",\n        \"X-Requested-With\": \"XMLHttpRequest\"\n    },\n    \"referrer\": \"http://www.gdjw.zjut.edu.cn/jwglxt/kbcx/xskbcx_cxXskbcxIndex.html?gnmkdm=N2151&layout=default\",\n    \"body\": \"xnm=2024&xqm=3&kzlx=ck&xsdm=\",\n    \"method\": \"POST\",\n    \"mode\": \"cors\"\n});\n",[76,6067,6068,6081,6093,6102,6114,6126,6138,6150,6160,6164,6176,6188,6199,6209],{"__ignoreMap":53},[79,6069,6070,6072,6074,6076,6079],{"class":81,"line":82},[79,6071,4873],{"class":103},[79,6073,2881],{"class":360},[79,6075,364],{"class":89},[79,6077,6078],{"class":367},"\"http://www.gdjw.zjut.edu.cn/jwglxt/kbcx/xskbcx_cxXsgrkb.html?gnmkdm=N2151\"",[79,6080,3074],{"class":89},[79,6082,6083,6086,6088,6091],{"class":81,"line":93},[79,6084,6085],{"class":367},"    \"credentials\"",[79,6087,3020],{"class":3019},[79,6089,6090],{"class":367}," \"include\"",[79,6092,3026],{"class":89},[79,6094,6095,6098,6100],{"class":81,"line":110},[79,6096,6097],{"class":367},"    \"headers\"",[79,6099,3020],{"class":3019},[79,6101,90],{"class":89},[79,6103,6104,6107,6109,6112],{"class":81,"line":374},[79,6105,6106],{"class":367},"        \"User-Agent\"",[79,6108,3020],{"class":3019},[79,6110,6111],{"class":367}," \"Mozilla/5.0 (X11; Linux x86_64; rv:133.0) Gecko/20100101 Firefox/133.0\"",[79,6113,3026],{"class":89},[79,6115,6116,6119,6121,6124],{"class":81,"line":394},[79,6117,6118],{"class":367},"        \"Accept\"",[79,6120,3020],{"class":3019},[79,6122,6123],{"class":367}," \"*/*\"",[79,6125,3026],{"class":89},[79,6127,6128,6131,6133,6136],{"class":81,"line":416},[79,6129,6130],{"class":367},"        \"Accept-Language\"",[79,6132,3020],{"class":3019},[79,6134,6135],{"class":367}," \"zh-CN,zh;q=0.8,zh-TW;q=0.7,zh-HK;q=0.5,en-US;q=0.3,en;q=0.2\"",[79,6137,3026],{"class":89},[79,6139,6140,6143,6145,6148],{"class":81,"line":437},[79,6141,6142],{"class":367},"        \"Content-Type\"",[79,6144,3020],{"class":3019},[79,6146,6147],{"class":367}," \"application/x-www-form-urlencoded;charset=utf-8\"",[79,6149,3026],{"class":89},[79,6151,6152,6155,6157],{"class":81,"line":458},[79,6153,6154],{"class":367},"        \"X-Requested-With\"",[79,6156,3020],{"class":3019},[79,6158,6159],{"class":367}," \"XMLHttpRequest\"\n",[79,6161,6162],{"class":81,"line":479},[79,6163,3222],{"class":89},[79,6165,6166,6169,6171,6174],{"class":81,"line":501},[79,6167,6168],{"class":367},"    \"referrer\"",[79,6170,3020],{"class":3019},[79,6172,6173],{"class":367}," \"http://www.gdjw.zjut.edu.cn/jwglxt/kbcx/xskbcx_cxXskbcxIndex.html?gnmkdm=N2151&layout=default\"",[79,6175,3026],{"class":89},[79,6177,6178,6181,6183,6186],{"class":81,"line":523},[79,6179,6180],{"class":367},"    \"body\"",[79,6182,3020],{"class":3019},[79,6184,6185],{"class":367}," \"xnm=2024&xqm=3&kzlx=ck&xsdm=\"",[79,6187,3026],{"class":89},[79,6189,6190,6193,6195,6197],{"class":81,"line":528},[79,6191,6192],{"class":367},"    \"method\"",[79,6194,3020],{"class":3019},[79,6196,3084],{"class":367},[79,6198,3026],{"class":89},[79,6200,6201,6204,6206],{"class":81,"line":541},[79,6202,6203],{"class":367},"    \"mode\"",[79,6205,3020],{"class":3019},[79,6207,6208],{"class":367}," \"cors\"\n",[79,6210,6211],{"class":81,"line":558},[79,6212,6213],{"class":89},"});\n",[19,6215,6216],{},"先看 body 部分",[129,6218,6219,6222,6225],{},[132,6220,6221],{},"xnm=2024 很明显是年份的意思",[132,6223,6224],{},"xqm 表示学期，这个通过多次尝试获取不同学期的课表可以得出结果，3 表示第一学期，12 表示第二学期，16 表示第三学期（短学期）",[132,6226,6227],{},"其余的参数我不关心，一模一样带上就行",[19,6229,6230],{},"这个函数是可以直接放在 F12 开发者工具的控制台中运行的，通过在 fetch 函数的尾部（分号前）添加一个回调函数就可以打印出函数获取的结果。",[70,6232,6234],{"className":322,"code":6233,"language":324,"meta":53,"style":53},"await fetch(...).then(response => response.json())\n",[76,6235,6236],{"__ignoreMap":53},[79,6237,6238,6240,6242,6244,6246,6248,6250,6252,6254,6256,6258,6260,6262],{"class":81,"line":82},[79,6239,4873],{"class":103},[79,6241,2881],{"class":360},[79,6243,364],{"class":89},[79,6245,5166],{"class":3019},[79,6247,3986],{"class":89},[79,6249,5143],{"class":360},[79,6251,364],{"class":89},[79,6253,3151],{"class":715},[79,6255,718],{"class":103},[79,6257,2873],{"class":353},[79,6259,357],{"class":89},[79,6261,2906],{"class":360},[79,6263,6264],{"class":89},"())\n",[19,6266,6267],{},"这就允许我们去尝试是否可以删减一些 fetch 函数的参数，获得相同的结果。",[19,6269,6270],{},"如删除 headers 中的 User-Agent、删除 referer 等等，我最后精简了一些参数，fetch 函数长这个样子。",[70,6272,6274],{"className":322,"code":6273,"language":324,"meta":53,"style":53},"await fetch(\"http://www.gdjw.zjut.edu.cn/jwglxt/kbcx/xskbcx_cxXsgrkb.html?gnmkdm=N2151\", {\n    \"credentials\": \"include\",\n    \"headers\": {\n        \"Accept\": \"*/*\",\n        \"Content-Type\": \"application/x-www-form-urlencoded;charset=utf-8\",\n        \"X-Requested-With\": \"XMLHttpRequest\"\n    },\n    \"body\": \"xnm=2024&xqm=3&kzlx=ck&xsdm=\",\n    \"method\": \"POST\",\n    \"mode\": \"cors\"\n});\n",[76,6275,6276,6288,6298,6306,6316,6326,6334,6338,6348,6358,6366],{"__ignoreMap":53},[79,6277,6278,6280,6282,6284,6286],{"class":81,"line":82},[79,6279,4873],{"class":103},[79,6281,2881],{"class":360},[79,6283,364],{"class":89},[79,6285,6078],{"class":367},[79,6287,3074],{"class":89},[79,6289,6290,6292,6294,6296],{"class":81,"line":93},[79,6291,6085],{"class":367},[79,6293,3020],{"class":3019},[79,6295,6090],{"class":367},[79,6297,3026],{"class":89},[79,6299,6300,6302,6304],{"class":81,"line":110},[79,6301,6097],{"class":367},[79,6303,3020],{"class":3019},[79,6305,90],{"class":89},[79,6307,6308,6310,6312,6314],{"class":81,"line":374},[79,6309,6118],{"class":367},[79,6311,3020],{"class":3019},[79,6313,6123],{"class":367},[79,6315,3026],{"class":89},[79,6317,6318,6320,6322,6324],{"class":81,"line":394},[79,6319,6142],{"class":367},[79,6321,3020],{"class":3019},[79,6323,6147],{"class":367},[79,6325,3026],{"class":89},[79,6327,6328,6330,6332],{"class":81,"line":416},[79,6329,6154],{"class":367},[79,6331,3020],{"class":3019},[79,6333,6159],{"class":367},[79,6335,6336],{"class":81,"line":437},[79,6337,3222],{"class":89},[79,6339,6340,6342,6344,6346],{"class":81,"line":458},[79,6341,6180],{"class":367},[79,6343,3020],{"class":3019},[79,6345,6185],{"class":367},[79,6347,3026],{"class":89},[79,6349,6350,6352,6354,6356],{"class":81,"line":479},[79,6351,6192],{"class":367},[79,6353,3020],{"class":3019},[79,6355,3084],{"class":367},[79,6357,3026],{"class":89},[79,6359,6360,6362,6364],{"class":81,"line":501},[79,6361,6203],{"class":367},[79,6363,3020],{"class":3019},[79,6365,6208],{"class":367},[79,6367,6368],{"class":81,"line":523},[79,6369,6213],{"class":89},[19,6371,6372],{},"现在，将 fetch 函数自身和其执行后获取的结果复制下来保存到本地备用，我们就可以开始写代码了。",[189,6374,6375],{"id":6375},"安装依赖",[19,6377,6378],{},"在刚刚的压缩包解压出来的目录中，有一个叫 localTools 的文件夹，我们可以把它复制到自己的工作目录下，我们的代码工作主要就是在那里进行。",[19,6380,6381,6382,6385],{},"打开 VSCode，命令行运行 ",[76,6383,6384],{},"pnpm i"," 安装其运行时的依赖，顺便截图给你们看一眼目录结构。",[19,6387,6388],{},[25,6389],{"alt":53,"src":6390},"https://static.031130.xyz/uploads/2024/11/18/d8316deee7e50.webp",[189,6392,6394],{"id":6393},"编写-provider","编写 provider",[19,6396,6397,6398],{},"首先编写 ",[76,6399,6400],{},"code/provider.js",[19,6402,6403],{},"在这个文件中，我们需要执行 fetch 函数，return 其获取到的 json 数据。",[19,6405,6406,6407],{},"按照官方文档，先 ",[76,6408,6409],{},"loadTool",[70,6411,6413],{"className":322,"code":6412,"language":324,"meta":53,"style":53},"await loadTool('AIScheduleTools')\n",[76,6414,6415],{"__ignoreMap":53},[79,6416,6417,6419,6422,6424,6427],{"class":81,"line":82},[79,6418,4873],{"class":103},[79,6420,6421],{"class":360}," loadTool",[79,6423,364],{"class":89},[79,6425,6426],{"class":367},"'AIScheduleTools'",[79,6428,1099],{"class":89},[19,6430,6431,6432,6435],{},"随后，我选择使用 ",[76,6433,6434],{},"AISchedulePrompt"," 这个小米封装的工具让用户手动输入需要导入课表的学年和学期信息，并对输入数据进行简单校验。",[70,6437,6439],{"className":322,"code":6438,"language":324,"meta":53,"style":53},"const year = await AISchedulePrompt({\n  titleText: '学年',\n  tipText: '请输入本学年开始的年份',\n  defaultText: '2024',\n  validator: value => {\n    try {\n      const v = parseInt(value)\n      if (v \u003C 2000 || v > 2100) {\n        return '请输入正确的学年'\n      }\n      return false\n    } catch (error) {\n      return '请输入正确的学年'\n    }\n  }\n})\n\nconst term = await AISchedulePrompt({\n  titleText: '学期',\n  tipText: '请输入本学期的学期(1,2,3 分别表示上、下、短学期)',\n  defaultText: '1',\n  validator: value => {\n    if (value === '1' || value === '2' || value === '3') {\n      return false\n    }\n    return '请输入正确的学期'\n  }\n})\n\nconst xqm = {\n  '1': '3',\n  '2': '12',\n  '3': '16',\n}[term]\n",[76,6440,6441,6458,6470,6482,6494,6507,6514,6532,6558,6565,6570,6577,6591,6597,6601,6605,6609,6613,6628,6639,6650,6661,6673,6705,6711,6715,6722,6726,6730,6734,6745,6756,6768,6780],{"__ignoreMap":53},[79,6442,6443,6445,6448,6450,6452,6455],{"class":81,"line":82},[79,6444,342],{"class":103},[79,6446,6447],{"class":345}," year",[79,6449,350],{"class":349},[79,6451,2878],{"class":103},[79,6453,6454],{"class":360}," AISchedulePrompt",[79,6456,6457],{"class":89},"({\n",[79,6459,6460,6463,6465,6468],{"class":81,"line":93},[79,6461,6462],{"class":382},"  titleText",[79,6464,3020],{"class":3019},[79,6466,6467],{"class":367}," '学年'",[79,6469,3026],{"class":89},[79,6471,6472,6475,6477,6480],{"class":81,"line":110},[79,6473,6474],{"class":382},"  tipText",[79,6476,3020],{"class":3019},[79,6478,6479],{"class":367}," '请输入本学年开始的年份'",[79,6481,3026],{"class":89},[79,6483,6484,6487,6489,6492],{"class":81,"line":374},[79,6485,6486],{"class":382},"  defaultText",[79,6488,3020],{"class":3019},[79,6490,6491],{"class":367}," '2024'",[79,6493,3026],{"class":89},[79,6495,6496,6499,6501,6503,6505],{"class":81,"line":394},[79,6497,6498],{"class":360},"  validator",[79,6500,3020],{"class":3019},[79,6502,1169],{"class":715},[79,6504,718],{"class":103},[79,6506,90],{"class":89},[79,6508,6509,6512],{"class":81,"line":416},[79,6510,6511],{"class":103},"    try",[79,6513,90],{"class":89},[79,6515,6516,6519,6521,6523,6526,6528,6530],{"class":81,"line":437},[79,6517,6518],{"class":103},"      const",[79,6520,5286],{"class":345},[79,6522,350],{"class":349},[79,6524,6525],{"class":360}," parseInt",[79,6527,364],{"class":89},[79,6529,383],{"class":388},[79,6531,1099],{"class":89},[79,6533,6534,6537,6539,6541,6543,6546,6549,6551,6553,6556],{"class":81,"line":458},[79,6535,6536],{"class":103},"      if",[79,6538,728],{"class":89},[79,6540,5313],{"class":388},[79,6542,1808],{"class":349},[79,6544,6545],{"class":85}," 2000",[79,6547,6548],{"class":349}," ||",[79,6550,5286],{"class":388},[79,6552,3426],{"class":349},[79,6554,6555],{"class":85}," 2100",[79,6557,750],{"class":89},[79,6559,6560,6562],{"class":81,"line":479},[79,6561,4960],{"class":103},[79,6563,6564],{"class":367}," '请输入正确的学年'\n",[79,6566,6567],{"class":81,"line":501},[79,6568,6569],{"class":89},"      }\n",[79,6571,6572,6574],{"class":81,"line":523},[79,6573,3205],{"class":103},[79,6575,6576],{"class":85}," false\n",[79,6578,6579,6582,6585,6587,6589],{"class":81,"line":528},[79,6580,6581],{"class":89},"    } ",[79,6583,6584],{"class":103},"catch",[79,6586,728],{"class":89},[79,6588,1822],{"class":388},[79,6590,750],{"class":89},[79,6592,6593,6595],{"class":81,"line":541},[79,6594,3205],{"class":103},[79,6596,6564],{"class":367},[79,6598,6599],{"class":81,"line":558},[79,6600,2145],{"class":89},[79,6602,6603],{"class":81,"line":931},[79,6604,984],{"class":89},[79,6606,6607],{"class":81,"line":936},[79,6608,4447],{"class":89},[79,6610,6611],{"class":81,"line":947},[79,6612,337],{"emptyLinePlaceholder":44},[79,6614,6615,6617,6620,6622,6624,6626],{"class":81,"line":962},[79,6616,342],{"class":103},[79,6618,6619],{"class":345}," term",[79,6621,350],{"class":349},[79,6623,2878],{"class":103},[79,6625,6454],{"class":360},[79,6627,6457],{"class":89},[79,6629,6630,6632,6634,6637],{"class":81,"line":981},[79,6631,6462],{"class":382},[79,6633,3020],{"class":3019},[79,6635,6636],{"class":367}," '学期'",[79,6638,3026],{"class":89},[79,6640,6641,6643,6645,6648],{"class":81,"line":987},[79,6642,6474],{"class":382},[79,6644,3020],{"class":3019},[79,6646,6647],{"class":367}," '请输入本学期的学期(1,2,3 分别表示上、下、短学期)'",[79,6649,3026],{"class":89},[79,6651,6652,6654,6656,6659],{"class":81,"line":3478},[79,6653,6486],{"class":382},[79,6655,3020],{"class":3019},[79,6657,6658],{"class":367}," '1'",[79,6660,3026],{"class":89},[79,6662,6663,6665,6667,6669,6671],{"class":81,"line":3488},[79,6664,6498],{"class":360},[79,6666,3020],{"class":3019},[79,6668,1169],{"class":715},[79,6670,718],{"class":103},[79,6672,90],{"class":89},[79,6674,6675,6677,6679,6681,6683,6685,6687,6689,6691,6694,6696,6698,6700,6703],{"class":81,"line":3505},[79,6676,2914],{"class":103},[79,6678,728],{"class":89},[79,6680,383],{"class":388},[79,6682,4283],{"class":349},[79,6684,6658],{"class":367},[79,6686,6548],{"class":349},[79,6688,1169],{"class":388},[79,6690,4283],{"class":349},[79,6692,6693],{"class":367}," '2'",[79,6695,6548],{"class":349},[79,6697,1169],{"class":388},[79,6699,4283],{"class":349},[79,6701,6702],{"class":367}," '3'",[79,6704,750],{"class":89},[79,6706,6707,6709],{"class":81,"line":3510},[79,6708,3205],{"class":103},[79,6710,6576],{"class":85},[79,6712,6713],{"class":81,"line":3515},[79,6714,2145],{"class":89},[79,6716,6717,6719],{"class":81,"line":4720},[79,6718,2958],{"class":103},[79,6720,6721],{"class":367}," '请输入正确的学期'\n",[79,6723,6724],{"class":81,"line":3},[79,6725,984],{"class":89},[79,6727,6728],{"class":81,"line":4729},[79,6729,4447],{"class":89},[79,6731,6732],{"class":81,"line":4734},[79,6733,337],{"emptyLinePlaceholder":44},[79,6735,6736,6738,6741,6743],{"class":81,"line":4739},[79,6737,342],{"class":103},[79,6739,6740],{"class":345}," xqm",[79,6742,350],{"class":349},[79,6744,90],{"class":89},[79,6746,6747,6750,6752,6754],{"class":81,"line":4745},[79,6748,6749],{"class":367},"  '1'",[79,6751,3020],{"class":3019},[79,6753,6702],{"class":367},[79,6755,3026],{"class":89},[79,6757,6758,6761,6763,6766],{"class":81,"line":4751},[79,6759,6760],{"class":367},"  '2'",[79,6762,3020],{"class":3019},[79,6764,6765],{"class":367}," '12'",[79,6767,3026],{"class":89},[79,6769,6770,6773,6775,6778],{"class":81,"line":4756},[79,6771,6772],{"class":367},"  '3'",[79,6774,3020],{"class":3019},[79,6776,6777],{"class":367}," '16'",[79,6779,3026],{"class":89},[79,6781,6782,6785,6788],{"class":81,"line":4770},[79,6783,6784],{"class":89},"}[",[79,6786,6787],{"class":388},"term",[79,6789,6790],{"class":89},"]\n",[19,6792,6793],{},"随后将学年和学期信息拼入 fetch 函数，打出请求，并将返回的 json 数据转为 string 作为函数的返回值",[70,6795,6797],{"className":322,"code":6796,"language":324,"meta":53,"style":53},"const res = await fetch(\"http://www.gdjw.zjut.edu.cn/jwglxt/kbcx/xskbcx_cxXsgrkb.html?gnmkdm=N2151\", {\n  \"headers\": {\n    \"accept\": \"*/*\",\n    \"content-type\": \"application/x-www-form-urlencoded;charset=UTF-8\",\n    \"x-requested-with\": \"XMLHttpRequest\"\n  },\n  \"referrerPolicy\": \"strict-origin-when-cross-origin\",\n  \"body\": `xnm=${year}&xqm=${xqm}&kzlx=ck&xsdm=`,\n  \"method\": \"POST\",\n  \"mode\": \"cors\",\n  \"credentials\": \"include\"\n})\n\nconst ret = await res.json()\nreturn JSON.stringify(ret.kbList)\n",[76,6798,6799,6817,6826,6837,6849,6858,6863,6875,6907,6918,6930,6940,6944,6948,6967],{"__ignoreMap":53},[79,6800,6801,6803,6805,6807,6809,6811,6813,6815],{"class":81,"line":82},[79,6802,342],{"class":103},[79,6804,3961],{"class":345},[79,6806,350],{"class":349},[79,6808,2878],{"class":103},[79,6810,2881],{"class":360},[79,6812,364],{"class":89},[79,6814,6078],{"class":367},[79,6816,3074],{"class":89},[79,6818,6819,6822,6824],{"class":81,"line":93},[79,6820,6821],{"class":367},"  \"headers\"",[79,6823,3020],{"class":3019},[79,6825,90],{"class":89},[79,6827,6828,6831,6833,6835],{"class":81,"line":110},[79,6829,6830],{"class":367},"    \"accept\"",[79,6832,3020],{"class":3019},[79,6834,6123],{"class":367},[79,6836,3026],{"class":89},[79,6838,6839,6842,6844,6847],{"class":81,"line":374},[79,6840,6841],{"class":367},"    \"content-type\"",[79,6843,3020],{"class":3019},[79,6845,6846],{"class":367}," \"application/x-www-form-urlencoded;charset=UTF-8\"",[79,6848,3026],{"class":89},[79,6850,6851,6854,6856],{"class":81,"line":394},[79,6852,6853],{"class":367},"    \"x-requested-with\"",[79,6855,3020],{"class":3019},[79,6857,6159],{"class":367},[79,6859,6860],{"class":81,"line":416},[79,6861,6862],{"class":89},"  },\n",[79,6864,6865,6868,6870,6873],{"class":81,"line":437},[79,6866,6867],{"class":367},"  \"referrerPolicy\"",[79,6869,3020],{"class":3019},[79,6871,6872],{"class":367}," \"strict-origin-when-cross-origin\"",[79,6874,3026],{"class":89},[79,6876,6877,6880,6882,6885,6887,6890,6892,6895,6897,6900,6902,6905],{"class":81,"line":458},[79,6878,6879],{"class":367},"  \"body\"",[79,6881,3020],{"class":3019},[79,6883,6884],{"class":367}," `xnm=",[79,6886,3448],{"class":1503},[79,6888,6889],{"class":388},"year",[79,6891,1516],{"class":1503},[79,6893,6894],{"class":367},"&xqm=",[79,6896,3448],{"class":1503},[79,6898,6899],{"class":388},"xqm",[79,6901,1516],{"class":1503},[79,6903,6904],{"class":367},"&kzlx=ck&xsdm=`",[79,6906,3026],{"class":89},[79,6908,6909,6912,6914,6916],{"class":81,"line":479},[79,6910,6911],{"class":367},"  \"method\"",[79,6913,3020],{"class":3019},[79,6915,3084],{"class":367},[79,6917,3026],{"class":89},[79,6919,6920,6923,6925,6928],{"class":81,"line":501},[79,6921,6922],{"class":367},"  \"mode\"",[79,6924,3020],{"class":3019},[79,6926,6927],{"class":367}," \"cors\"",[79,6929,3026],{"class":89},[79,6931,6932,6935,6937],{"class":81,"line":523},[79,6933,6934],{"class":367},"  \"credentials\"",[79,6936,3020],{"class":3019},[79,6938,6939],{"class":367}," \"include\"\n",[79,6941,6942],{"class":81,"line":528},[79,6943,4447],{"class":89},[79,6945,6946],{"class":81,"line":541},[79,6947,337],{"emptyLinePlaceholder":44},[79,6949,6950,6952,6955,6957,6959,6961,6963,6965],{"class":81,"line":558},[79,6951,342],{"class":103},[79,6953,6954],{"class":345}," ret",[79,6956,350],{"class":349},[79,6958,2878],{"class":103},[79,6960,3961],{"class":353},[79,6962,357],{"class":89},[79,6964,2906],{"class":360},[79,6966,2909],{"class":89},[79,6968,6969,6972,6974,6976,6978,6980,6983,6985,6988],{"class":81,"line":931},[79,6970,6971],{"class":103},"return",[79,6973,3120],{"class":345},[79,6975,357],{"class":89},[79,6977,3125],{"class":360},[79,6979,364],{"class":89},[79,6981,6982],{"class":353},"ret",[79,6984,357],{"class":89},[79,6986,6987],{"class":382},"kbList",[79,6989,1099],{"class":89},[19,6991,6992],{},"最外层使用 try-catch 做简单的异常处理，如果出错就让用户确认是否正确登陆了教务系统",[70,6994,6996],{"className":322,"code":6995,"language":324,"meta":53,"style":53},"async function scheduleHtmlProvider() {\n  await loadTool('AIScheduleTools')\n  try {\n    //...\n  } catch (error) {\n    await AIScheduleAlert('请确定你已经登陆了教务系统')\n    return 'do not continue'\n  }\n}\n",[76,6997,6998,7009,7022,7029,7034,7046,7060,7067,7071],{"__ignoreMap":53},[79,6999,7000,7002,7004,7007],{"class":81,"line":82},[79,7001,2752],{"class":103},[79,7003,2755],{"class":103},[79,7005,7006],{"class":360}," scheduleHtmlProvider",[79,7008,2761],{"class":89},[79,7010,7011,7014,7016,7018,7020],{"class":81,"line":93},[79,7012,7013],{"class":103},"  await",[79,7015,6421],{"class":360},[79,7017,364],{"class":89},[79,7019,6426],{"class":367},[79,7021,1099],{"class":89},[79,7023,7024,7027],{"class":81,"line":110},[79,7025,7026],{"class":103},"  try",[79,7028,90],{"class":89},[79,7030,7031],{"class":81,"line":374},[79,7032,7033],{"class":331},"    //...\n",[79,7035,7036,7038,7040,7042,7044],{"class":81,"line":394},[79,7037,778],{"class":89},[79,7039,6584],{"class":103},[79,7041,728],{"class":89},[79,7043,1822],{"class":388},[79,7045,750],{"class":89},[79,7047,7048,7050,7053,7055,7058],{"class":81,"line":416},[79,7049,755],{"class":103},[79,7051,7052],{"class":360}," AIScheduleAlert",[79,7054,364],{"class":89},[79,7056,7057],{"class":367},"'请确定你已经登陆了教务系统'",[79,7059,1099],{"class":89},[79,7061,7062,7064],{"class":81,"line":437},[79,7063,2958],{"class":103},[79,7065,7066],{"class":367}," 'do not continue'\n",[79,7068,7069],{"class":81,"line":458},[79,7070,984],{"class":89},[79,7072,7073],{"class":81,"line":479},[79,7074,113],{"class":89},[189,7076,7078],{"id":7077},"编写-parser","编写 parser",[19,7080,7081],{},"官方文档对 parser 函数做了明确的规范，格式如下",[70,7083,7086],{"className":7084,"code":7085,"language":2906,"meta":53,"style":53},"language-json shiki shiki-themes one-light one-dark-pro","[\n  {\n    name: \"数学\", // 课程名称\n    position: \"教学楼1\", // 上课地点\n    teacher: \"张三\", // 教师名称\n    weeks: [1, 2, 3, 4], // 周数\n    day: 3, // 星期\n    sections: [1, 2, 3], // 节次\n  },{\n    name: \"数学\",\n    position: \"教学楼1\",\n    teacher: \"张三\",\n    weeks: [1, 2, 3, 4],\n    day: 1,\n    sections: [1, 2, 3],\n  },\n]\n",[76,7087,7088,7093,7098,7114,7129,7144,7176,7190,7212,7217,7227,7237,7247,7270,7280,7298,7302],{"__ignoreMap":53},[79,7089,7090],{"class":81,"line":82},[79,7091,7092],{"class":89},"[\n",[79,7094,7095],{"class":81,"line":93},[79,7096,7097],{"class":89},"  {\n",[79,7099,7100,7103,7106,7109,7111],{"class":81,"line":110},[79,7101,7102],{"class":1408},"    name",[79,7104,7105],{"class":89},": ",[79,7107,7108],{"class":367},"\"数学\"",[79,7110,494],{"class":89},[79,7112,7113],{"class":331},"// 课程名称\n",[79,7115,7116,7119,7121,7124,7126],{"class":81,"line":374},[79,7117,7118],{"class":1408},"    position",[79,7120,7105],{"class":89},[79,7122,7123],{"class":367},"\"教学楼1\"",[79,7125,494],{"class":89},[79,7127,7128],{"class":331},"// 上课地点\n",[79,7130,7131,7134,7136,7139,7141],{"class":81,"line":394},[79,7132,7133],{"class":1408},"    teacher",[79,7135,7105],{"class":89},[79,7137,7138],{"class":367},"\"张三\"",[79,7140,494],{"class":89},[79,7142,7143],{"class":331},"// 教师名称\n",[79,7145,7146,7149,7152,7155,7157,7160,7162,7165,7167,7170,7173],{"class":81,"line":416},[79,7147,7148],{"class":1408},"    weeks",[79,7150,7151],{"class":89},": [",[79,7153,7154],{"class":85},"1",[79,7156,494],{"class":89},[79,7158,7159],{"class":85},"2",[79,7161,494],{"class":89},[79,7163,7164],{"class":85},"3",[79,7166,494],{"class":89},[79,7168,7169],{"class":85},"4",[79,7171,7172],{"class":89},"], ",[79,7174,7175],{"class":331},"// 周数\n",[79,7177,7178,7181,7183,7185,7187],{"class":81,"line":437},[79,7179,7180],{"class":1408},"    day",[79,7182,7105],{"class":89},[79,7184,7164],{"class":85},[79,7186,494],{"class":89},[79,7188,7189],{"class":331},"// 星期\n",[79,7191,7192,7195,7197,7199,7201,7203,7205,7207,7209],{"class":81,"line":458},[79,7193,7194],{"class":1408},"    sections",[79,7196,7151],{"class":89},[79,7198,7154],{"class":85},[79,7200,494],{"class":89},[79,7202,7159],{"class":85},[79,7204,494],{"class":89},[79,7206,7164],{"class":85},[79,7208,7172],{"class":89},[79,7210,7211],{"class":331},"// 节次\n",[79,7213,7214],{"class":81,"line":479},[79,7215,7216],{"class":89},"  },{\n",[79,7218,7219,7221,7223,7225],{"class":81,"line":501},[79,7220,7102],{"class":1408},[79,7222,7105],{"class":89},[79,7224,7108],{"class":367},[79,7226,3026],{"class":89},[79,7228,7229,7231,7233,7235],{"class":81,"line":523},[79,7230,7118],{"class":1408},[79,7232,7105],{"class":89},[79,7234,7123],{"class":367},[79,7236,3026],{"class":89},[79,7238,7239,7241,7243,7245],{"class":81,"line":528},[79,7240,7133],{"class":1408},[79,7242,7105],{"class":89},[79,7244,7138],{"class":367},[79,7246,3026],{"class":89},[79,7248,7249,7251,7253,7255,7257,7259,7261,7263,7265,7267],{"class":81,"line":541},[79,7250,7148],{"class":1408},[79,7252,7151],{"class":89},[79,7254,7154],{"class":85},[79,7256,494],{"class":89},[79,7258,7159],{"class":85},[79,7260,494],{"class":89},[79,7262,7164],{"class":85},[79,7264,494],{"class":89},[79,7266,7169],{"class":85},[79,7268,7269],{"class":89},"],\n",[79,7271,7272,7274,7276,7278],{"class":81,"line":558},[79,7273,7180],{"class":1408},[79,7275,7105],{"class":89},[79,7277,7154],{"class":85},[79,7279,3026],{"class":89},[79,7281,7282,7284,7286,7288,7290,7292,7294,7296],{"class":81,"line":931},[79,7283,7194],{"class":1408},[79,7285,7151],{"class":89},[79,7287,7154],{"class":85},[79,7289,494],{"class":89},[79,7291,7159],{"class":85},[79,7293,494],{"class":89},[79,7295,7164],{"class":85},[79,7297,7269],{"class":89},[79,7299,7300],{"class":81,"line":936},[79,7301,6862],{"class":89},[79,7303,7304],{"class":81,"line":947},[79,7305,6790],{"class":89},[19,7307,7308],{},"最外层是一个 array，里面包含若干个 object，每个 object 表示一节课",[64,7310,7311,7318,7323,7328,7338,7348],{},[19,7312,7313,7314,7317],{},"课程名称：",[76,7315,7316],{},"String"," 长度50字节（一汉字两字节）",[19,7319,7320,7321,7317],{},"上课地点：",[76,7322,7316],{},[19,7324,7325,7326,7317],{},"教师名称：",[76,7327,7316],{},[19,7329,7330,7331,649,7334,7337],{},"周数：",[76,7332,7333],{},"Number[]",[79,7335,7336],{},"1，30"," 之间的整数 超出会被裁掉",[19,7339,7340,7341,649,7344,7347],{},"星期：",[76,7342,7343],{},"Number",[79,7345,7346],{},"1，7"," 之间的整数",[19,7349,7350,7351,649,7353,7355,7356,7359],{},"节次：",[76,7352,7343],{},[79,7354,7336],{}," 之间的整数 (默认",[79,7357,7358],{},"1，12",") 根据后续时间设置自动裁剪",[19,7361,7362],{},"（只有这节课的星期几、上课地点、上课时间都一致才算一节课。比如我一周上两节算法课，周一 34 节和周三 56，那么这应该分成两个 object 来写）",[19,7364,7365,7366,7369],{},"这部分代码没什么好说的，就是对 ",[76,7367,7368],{},"provider"," 传过来的 string 用 js 做字符串解析，最后把整个 array 作为返回值返回就行，需要注意处理数组越界、空数组等等的低级错误。",[19,7371,7372],{},"第一步是将刚才的字符串转成 json 格式（如果你采用的是解析 html 的方式，请参考官方文档）",[70,7374,7376],{"className":322,"code":7375,"language":324,"meta":53,"style":53},"function scheduleHtmlParser(json_str) {\n  courses_json = JSON.parse(json_str)\n  const courseInfos = []\n\n  //...\n  \n  return courseInfos\n}\n",[76,7377,7378,7392,7412,7424,7428,7433,7438,7445],{"__ignoreMap":53},[79,7379,7380,7382,7385,7387,7390],{"class":81,"line":82},[79,7381,4759],{"class":103},[79,7383,7384],{"class":360}," scheduleHtmlParser",[79,7386,364],{"class":89},[79,7388,7389],{"class":715},"json_str",[79,7391,750],{"class":89},[79,7393,7394,7397,7399,7401,7403,7406,7408,7410],{"class":81,"line":93},[79,7395,7396],{"class":388},"  courses_json",[79,7398,350],{"class":349},[79,7400,3120],{"class":345},[79,7402,357],{"class":89},[79,7404,7405],{"class":360},"parse",[79,7407,364],{"class":89},[79,7409,7389],{"class":388},[79,7411,1099],{"class":89},[79,7413,7414,7416,7419,7421],{"class":81,"line":110},[79,7415,1617],{"class":103},[79,7417,7418],{"class":345}," courseInfos",[79,7420,350],{"class":349},[79,7422,7423],{"class":89}," []\n",[79,7425,7426],{"class":81,"line":374},[79,7427,337],{"emptyLinePlaceholder":44},[79,7429,7430],{"class":81,"line":394},[79,7431,7432],{"class":331},"  //...\n",[79,7434,7435],{"class":81,"line":416},[79,7436,7437],{"class":89},"  \n",[79,7439,7440,7442],{"class":81,"line":437},[79,7441,1680],{"class":103},[79,7443,7444],{"class":388}," courseInfos\n",[79,7446,7447],{"class":81,"line":458},[79,7448,113],{"class":89},[19,7450,7451],{},"如果需要一个临时的测试方案，可以用以下的测试结构",[70,7453,7455],{"className":322,"code":7454,"language":324,"meta":53,"style":53},"function scheduleHtmlParser(json_str) {\n  courses_json = JSON.parse(json_str)\n  const courseInfos = []\n\n  //...\n  \n  return courseInfos\n}\n\ninput_text = `\n// 这里是我在上文中复制的 fetch 函数输出的 json 结果\n`\n\nconsole.log(scheduleHtmlParser(input_text))\n",[76,7456,7457,7469,7487,7497,7501,7505,7509,7515,7519,7523,7533,7538,7543,7547],{"__ignoreMap":53},[79,7458,7459,7461,7463,7465,7467],{"class":81,"line":82},[79,7460,4759],{"class":103},[79,7462,7384],{"class":360},[79,7464,364],{"class":89},[79,7466,7389],{"class":715},[79,7468,750],{"class":89},[79,7470,7471,7473,7475,7477,7479,7481,7483,7485],{"class":81,"line":93},[79,7472,7396],{"class":388},[79,7474,350],{"class":349},[79,7476,3120],{"class":345},[79,7478,357],{"class":89},[79,7480,7405],{"class":360},[79,7482,364],{"class":89},[79,7484,7389],{"class":388},[79,7486,1099],{"class":89},[79,7488,7489,7491,7493,7495],{"class":81,"line":110},[79,7490,1617],{"class":103},[79,7492,7418],{"class":345},[79,7494,350],{"class":349},[79,7496,7423],{"class":89},[79,7498,7499],{"class":81,"line":374},[79,7500,337],{"emptyLinePlaceholder":44},[79,7502,7503],{"class":81,"line":394},[79,7504,7432],{"class":331},[79,7506,7507],{"class":81,"line":416},[79,7508,7437],{"class":89},[79,7510,7511,7513],{"class":81,"line":437},[79,7512,1680],{"class":103},[79,7514,7444],{"class":388},[79,7516,7517],{"class":81,"line":458},[79,7518,113],{"class":89},[79,7520,7521],{"class":81,"line":479},[79,7522,337],{"emptyLinePlaceholder":44},[79,7524,7525,7528,7530],{"class":81,"line":501},[79,7526,7527],{"class":388},"input_text",[79,7529,350],{"class":349},[79,7531,7532],{"class":367}," `\n",[79,7534,7535],{"class":81,"line":523},[79,7536,7537],{"class":367},"// 这里是我在上文中复制的 fetch 函数输出的 json 结果\n",[79,7539,7540],{"class":81,"line":528},[79,7541,7542],{"class":367},"`\n",[79,7544,7545],{"class":81,"line":541},[79,7546,337],{"emptyLinePlaceholder":44},[79,7548,7549,7552,7554,7556,7558,7561,7563,7565],{"class":81,"line":558},[79,7550,7551],{"class":353},"console",[79,7553,357],{"class":89},[79,7555,3146],{"class":360},[79,7557,364],{"class":89},[79,7559,7560],{"class":360},"scheduleHtmlParser",[79,7562,364],{"class":89},[79,7564,7527],{"class":388},[79,7566,4309],{"class":89},[19,7568,7569,7570,7573],{},"执行 ",[76,7571,7572],{},"node code/parser.js"," ，观察输出结果是否和官方要求的结构严格一致。",[189,7575,7577],{"id":7576},"编写-timer","编写 timer",[19,7579,7580,7583,7584,7586],{},[76,7581,7582],{},"timer"," 函数的运行环境和 ",[76,7585,7368],{}," 一致，都允许你使用 fetch 向教务系统打请求，或者解析页面的 html 函数，但我们学校的教务系统一不写第一周的周一是几号，二不写每节课具体的上下课时间，所以我把我校的相关数据都进行了硬编码，这里直接放个官方文档的示例文件。",[70,7588,7590],{"className":322,"code":7589,"language":324,"meta":53,"style":53},"/**\n * 时间配置函数，此为入口函数，不要改动函数名\n */\nasync function scheduleTimer({\n  providerRes,\n  parserRes\n} = {}) {\n  // 支持异步操作 推荐await写法\n\n  // 这是一个示例函数，用于演示，正常用不到可以删掉\n  const someAsyncFunc = () => new Promise(resolve => {\n    setTimeout(() => resolve(), 1)\n  })\n  await someAsyncFunc()\n\n  // 这个函数中也支持使用 AIScheduleTools 譬如给出多条时间配置让用户选择之类的\n\n  // 返回时间配置JSON，所有项都为可选项，如果不进行时间配置，请返回空对象\n  return {\n    totalWeek: 20, // 总周数：[1, 30]之间的整数\n    startSemester: '', // 开学时间：时间戳，13位长度字符串，推荐用代码生成\n    startWithSunday: false, // 是否是周日为起始日，该选项为true时，会开启显示周末选项\n    showWeekend: false, // 是否显示周末\n    forenoon: 1, // 上午课程节数：[1, 10]之间的整数\n    afternoon: 0, // 下午课程节数：[0, 10]之间的整数\n    night: 0, // 晚间课程节数：[0, 10]之间的整数\n    sections: [{\n      section: 1, // 节次：[1, 30]之间的整数\n      startTime: '08:00', // 开始时间：参照这个标准格式5位长度字符串\n      endTime: '08:50', // 结束时间：同上\n    }], // 课程时间表，注意：总长度要和上边配置的节数加和对齐\n  }\n  // PS: 夏令时什么的还是让用户在夏令时的时候重新导入一遍吧，在这个函数里边适配吧！奥里给！————不愿意透露姓名的嘤某人\n}\n",[76,7591,7592,7596,7601,7605,7616,7623,7628,7638,7643,7647,7652,7678,7698,7703,7711,7715,7720,7724,7729,7735,7750,7765,7780,7794,7809,7823,7837,7846,7860,7875,7890,7898,7902,7907],{"__ignoreMap":53},[79,7593,7594],{"class":81,"line":82},[79,7595,4463],{"class":331},[79,7597,7598],{"class":81,"line":93},[79,7599,7600],{"class":331}," * 时间配置函数，此为入口函数，不要改动函数名\n",[79,7602,7603],{"class":81,"line":110},[79,7604,4478],{"class":331},[79,7606,7607,7609,7611,7614],{"class":81,"line":374},[79,7608,2752],{"class":103},[79,7610,2755],{"class":103},[79,7612,7613],{"class":360}," scheduleTimer",[79,7615,6457],{"class":89},[79,7617,7618,7621],{"class":81,"line":394},[79,7619,7620],{"class":715},"  providerRes",[79,7622,3026],{"class":89},[79,7624,7625],{"class":81,"line":416},[79,7626,7627],{"class":715},"  parserRes\n",[79,7629,7630,7633,7635],{"class":81,"line":437},[79,7631,7632],{"class":89},"} ",[79,7634,1163],{"class":349},[79,7636,7637],{"class":89}," {}) {\n",[79,7639,7640],{"class":81,"line":458},[79,7641,7642],{"class":331},"  // 支持异步操作 推荐await写法\n",[79,7644,7645],{"class":81,"line":479},[79,7646,337],{"emptyLinePlaceholder":44},[79,7648,7649],{"class":81,"line":501},[79,7650,7651],{"class":331},"  // 这是一个示例函数，用于演示，正常用不到可以删掉\n",[79,7653,7654,7656,7659,7661,7663,7665,7667,7669,7671,7674,7676],{"class":81,"line":523},[79,7655,1617],{"class":103},[79,7657,7658],{"class":360}," someAsyncFunc",[79,7660,350],{"class":349},[79,7662,1607],{"class":89},[79,7664,1610],{"class":103},[79,7666,2805],{"class":103},[79,7668,5095],{"class":5094},[79,7670,364],{"class":89},[79,7672,7673],{"class":715},"resolve",[79,7675,718],{"class":103},[79,7677,90],{"class":89},[79,7679,7680,7683,7686,7688,7691,7694,7696],{"class":81,"line":528},[79,7681,7682],{"class":360},"    setTimeout",[79,7684,7685],{"class":89},"(() ",[79,7687,1610],{"class":103},[79,7689,7690],{"class":360}," resolve",[79,7692,7693],{"class":89},"(), ",[79,7695,7154],{"class":85},[79,7697,1099],{"class":89},[79,7699,7700],{"class":81,"line":541},[79,7701,7702],{"class":89},"  })\n",[79,7704,7705,7707,7709],{"class":81,"line":558},[79,7706,7013],{"class":103},[79,7708,7658],{"class":360},[79,7710,2909],{"class":89},[79,7712,7713],{"class":81,"line":931},[79,7714,337],{"emptyLinePlaceholder":44},[79,7716,7717],{"class":81,"line":936},[79,7718,7719],{"class":331},"  // 这个函数中也支持使用 AIScheduleTools 譬如给出多条时间配置让用户选择之类的\n",[79,7721,7722],{"class":81,"line":947},[79,7723,337],{"emptyLinePlaceholder":44},[79,7725,7726],{"class":81,"line":962},[79,7727,7728],{"class":331},"  // 返回时间配置JSON，所有项都为可选项，如果不进行时间配置，请返回空对象\n",[79,7730,7731,7733],{"class":81,"line":981},[79,7732,1680],{"class":103},[79,7734,90],{"class":89},[79,7736,7737,7740,7742,7745,7747],{"class":81,"line":987},[79,7738,7739],{"class":382},"    totalWeek",[79,7741,3020],{"class":3019},[79,7743,7744],{"class":85}," 20",[79,7746,494],{"class":89},[79,7748,7749],{"class":331},"// 总周数：[1, 30]之间的整数\n",[79,7751,7752,7755,7757,7760,7762],{"class":81,"line":3478},[79,7753,7754],{"class":382},"    startSemester",[79,7756,3020],{"class":3019},[79,7758,7759],{"class":367}," ''",[79,7761,494],{"class":89},[79,7763,7764],{"class":331},"// 开学时间：时间戳，13位长度字符串，推荐用代码生成\n",[79,7766,7767,7770,7772,7775,7777],{"class":81,"line":3488},[79,7768,7769],{"class":382},"    startWithSunday",[79,7771,3020],{"class":3019},[79,7773,7774],{"class":85}," false",[79,7776,494],{"class":89},[79,7778,7779],{"class":331},"// 是否是周日为起始日，该选项为true时，会开启显示周末选项\n",[79,7781,7782,7785,7787,7789,7791],{"class":81,"line":3505},[79,7783,7784],{"class":382},"    showWeekend",[79,7786,3020],{"class":3019},[79,7788,7774],{"class":85},[79,7790,494],{"class":89},[79,7792,7793],{"class":331},"// 是否显示周末\n",[79,7795,7796,7799,7801,7804,7806],{"class":81,"line":3510},[79,7797,7798],{"class":382},"    forenoon",[79,7800,3020],{"class":3019},[79,7802,7803],{"class":85}," 1",[79,7805,494],{"class":89},[79,7807,7808],{"class":331},"// 上午课程节数：[1, 10]之间的整数\n",[79,7810,7811,7814,7816,7818,7820],{"class":81,"line":3515},[79,7812,7813],{"class":382},"    afternoon",[79,7815,3020],{"class":3019},[79,7817,411],{"class":85},[79,7819,494],{"class":89},[79,7821,7822],{"class":331},"// 下午课程节数：[0, 10]之间的整数\n",[79,7824,7825,7828,7830,7832,7834],{"class":81,"line":4720},[79,7826,7827],{"class":382},"    night",[79,7829,3020],{"class":3019},[79,7831,411],{"class":85},[79,7833,494],{"class":89},[79,7835,7836],{"class":331},"// 晚间课程节数：[0, 10]之间的整数\n",[79,7838,7839,7841,7843],{"class":81,"line":3},[79,7840,7194],{"class":382},[79,7842,3020],{"class":3019},[79,7844,7845],{"class":89}," [{\n",[79,7847,7848,7851,7853,7855,7857],{"class":81,"line":4729},[79,7849,7850],{"class":382},"      section",[79,7852,3020],{"class":3019},[79,7854,7803],{"class":85},[79,7856,494],{"class":89},[79,7858,7859],{"class":331},"// 节次：[1, 30]之间的整数\n",[79,7861,7862,7865,7867,7870,7872],{"class":81,"line":4734},[79,7863,7864],{"class":382},"      startTime",[79,7866,3020],{"class":3019},[79,7868,7869],{"class":367}," '08:00'",[79,7871,494],{"class":89},[79,7873,7874],{"class":331},"// 开始时间：参照这个标准格式5位长度字符串\n",[79,7876,7877,7880,7882,7885,7887],{"class":81,"line":4739},[79,7878,7879],{"class":382},"      endTime",[79,7881,3020],{"class":3019},[79,7883,7884],{"class":367}," '08:50'",[79,7886,494],{"class":89},[79,7888,7889],{"class":331},"// 结束时间：同上\n",[79,7891,7892,7895],{"class":81,"line":4745},[79,7893,7894],{"class":89},"    }], ",[79,7896,7897],{"class":331},"// 课程时间表，注意：总长度要和上边配置的节数加和对齐\n",[79,7899,7900],{"class":81,"line":4751},[79,7901,984],{"class":89},[79,7903,7904],{"class":81,"line":4756},[79,7905,7906],{"class":331},"  // PS: 夏令时什么的还是让用户在夏令时的时候重新导入一遍吧，在这个函数里边适配吧！奥里给！————不愿意透露姓名的嘤某人\n",[79,7908,7909],{"class":81,"line":4770},[79,7910,113],{"class":89},[189,7912,7913],{"id":7913},"调试阶段",[19,7915,7916,7917,7920],{},"运行 ",[76,7918,7919],{},"pnpm main"," 能调起一个临时的服务器和浏览器插件进行互动，将编辑器的代码实时同步到浏览器插件。",[19,7922,7923],{},"在浏览器插件中，先创建一个新项目",[19,7925,7926],{},[25,7927],{"alt":53,"src":7928},"https://static.031130.xyz/uploads/2024/11/18/d1ebba67ddc83.webp",[19,7930,7931],{},"保存后再次打开，选择「编写代码」按钮",[19,7933,7934],{},[25,7935],{"alt":53,"src":7936},"https://static.031130.xyz/uploads/2024/11/18/e697bcf2a7a1f.webp",[19,7938,7939],{},"检查自己的代码是不是被实时同步到了浏览器插件中，然后可以点击右上角的「本地测试」按钮",[19,7941,7942],{},[25,7943],{"alt":53,"src":7944},"https://static.031130.xyz/uploads/2024/11/18/eb563904a64a1.webp",[19,7946,7947],{},"如果本机测试出现了问题，可以使用 console.log 语句进行 debug ，问题可能会出现在 F12 开发者工具的控制台，也可能会出现在 vscode 的终端中。确认本机测试无问题后，点击右上角蓝色的「上传」按钮，就可以在上传到云端，在登陆了自己小米账号的手机中找到自己适配的教务导入测试项目，顺利完成导入后给自己的满意度打满分，就可以在浏览器插件中点击上传审核，审核通过后你的适配工作就会公开啦。",[264,7949,7950],{},"html pre.shiki code .sLKXg, html code.shiki .sLKXg{--shiki-default:#A626A4;--shiki-dark:#C678DD}html pre.shiki code .sAdtL, html code.shiki .sAdtL{--shiki-default:#4078F2;--shiki-dark:#61AFEF}html pre.shiki code .s5ixo, html code.shiki .s5ixo{--shiki-default:#383A42;--shiki-dark:#ABB2BF}html pre.shiki code .sDhpE, html code.shiki .sDhpE{--shiki-default:#50A14F;--shiki-dark:#98C379}html pre.shiki code .st7oF, html code.shiki .st7oF{--shiki-default:#0184BC;--shiki-dark:#ABB2BF}html .default .shiki span {color: var(--shiki-default);background: var(--shiki-default-bg);font-style: var(--shiki-default-font-style);font-weight: var(--shiki-default-font-weight);text-decoration: var(--shiki-default-text-decoration);}html .shiki span {color: var(--shiki-default);background: var(--shiki-default-bg);font-style: var(--shiki-default-font-style);font-weight: var(--shiki-default-font-weight);text-decoration: var(--shiki-default-text-decoration);}html .dark .shiki span {color: var(--shiki-dark);background: var(--shiki-dark-bg);font-style: var(--shiki-dark-font-style);font-weight: var(--shiki-dark-font-weight);text-decoration: var(--shiki-dark-text-decoration);}html.dark .shiki span {color: var(--shiki-dark);background: var(--shiki-dark-bg);font-style: var(--shiki-dark-font-style);font-weight: var(--shiki-dark-font-weight);text-decoration: var(--shiki-dark-text-decoration);}html pre.shiki code .s8iYz, html code.shiki .s8iYz{--shiki-default:#383A42;--shiki-default-font-style:inherit;--shiki-dark:#E06C75;--shiki-dark-font-style:italic}html pre.shiki code .s7GmK, html code.shiki .s7GmK{--shiki-default:#383A42;--shiki-dark:#E5C07B}html pre.shiki code .sNmU0, html code.shiki .sNmU0{--shiki-default:#986801;--shiki-dark:#E5C07B}html pre.shiki code .s_Sar, html code.shiki .s_Sar{--shiki-default:#0184BC;--shiki-dark:#56B6C2}html pre.shiki code .sJa8x, html code.shiki .sJa8x{--shiki-default:#E45649;--shiki-dark:#E06C75}html pre.shiki code .sz0mV, html code.shiki .sz0mV{--shiki-default:#383A42;--shiki-dark:#E06C75}html pre.shiki code .sAGMh, html code.shiki .sAGMh{--shiki-default:#986801;--shiki-dark:#D19A66}html pre.shiki code .sAOjX, html code.shiki .sAOjX{--shiki-default:#CA1243;--shiki-dark:#C678DD}html pre.shiki code .sW2Sy, html code.shiki .sW2Sy{--shiki-default:#A0A1A7;--shiki-default-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic}html pre.shiki code .sUNH4, html code.shiki .sUNH4{--shiki-default:white;--shiki-dark:#FFFFFF}html pre.shiki code .sC09Y, html code.shiki .sC09Y{--shiki-default:#C18401;--shiki-dark:#E5C07B}",{"title":53,"searchDepth":93,"depth":93,"links":7952},[7953,7954,7955],{"id":5905,"depth":93,"text":5905},{"id":5933,"depth":93,"text":5933},{"id":5982,"depth":93,"text":5982,"children":7956},[7957,7958,7959,7960,7961,7962,7963,7964],{"id":5985,"depth":110,"text":5985},{"id":6019,"depth":110,"text":6019},{"id":6050,"depth":110,"text":6051},{"id":6375,"depth":110,"text":6375},{"id":6393,"depth":110,"text":6394},{"id":7077,"depth":110,"text":7078},{"id":7576,"depth":110,"text":7577},{"id":7913,"depth":110,"text":7913},{"title":7966,"date":7967,"path":7968,"tags":7969,"body":7973},"将博客从 waline v2 更新到 waline v3","2024-11-15 23:49:43","/2024/11/15/upgrade-waline-from-v2-to-v3",[7970,7971,7972],"Python","waline","Hexo",{"type":16,"value":7974,"toc":8260},[7975,7980,7987,8004,8008,8011,8017,8022,8030,8046,8054,8057,8063,8067,8070,8075,8084,8089,8092,8095,8100,8103,8106,8111,8114,8117,8131,8134,8141,8148,8155,8158,8240,8247,8252,8257],[64,7976,7977],{},[19,7978,7979],{},"waline 更新到 V3 版本已经是九个月前的事情了，眼瞅着 hexo fluid 主题并没有带我更新的意思，我就打算自己更新到最新版，结果遇到了两个坑，写文供大家参考。",[19,7981,7982,7983,7986],{},"在 Hexo 目录下的 ",[76,7984,7985],{},"_config.fluid.yml"," 文件中找到 waline 的 cdn，将版本号指向最新版。",[70,7988,7992],{"className":7989,"code":7990,"language":7991,"meta":53,"style":53},"language-diff shiki shiki-themes one-light one-dark-pro","-  waline: https://registry.npmmirror.com/@waline/client/2.15.8/files/dist/\n+  waline: https://registry.npmmirror.com/@waline/client/^3/files/dist/\n","diff",[76,7993,7994,7999],{"__ignoreMap":53},[79,7995,7996],{"class":81,"line":82},[79,7997,7998],{},"-  waline: https://registry.npmmirror.com/@waline/client/2.15.8/files/dist/\n",[79,8000,8001],{"class":81,"line":93},[79,8002,8003],{},"+  waline: https://registry.npmmirror.com/@waline/client/^3/files/dist/\n",[118,8005,8007],{"id":8006},"插曲一waline-不加载","插曲一——waline 不加载",[19,8009,8010],{},"再次部署博客，我遇到了第一个坑：waline 没有在页面上正常加载。",[19,8012,8013,8014],{},"打开控制台一看，报错给得很明白：",[76,8015,8016],{},"Waline is not defined",[19,8018,8019],{},[25,8020],{"alt":53,"src":8021},"https://static.031130.xyz/uploads/2024/11/16/663e910db29b7.webp",[19,8023,8024,8025,2727],{},"根据 ",[32,8026,8029],{"href":8027,"rel":8028},"https://github.com/walinejs/waline/issues/2483",[36],"issue#2483",[64,8031,8032,8039],{},[19,8033,8034,8038],{},[32,8035,8036],{"href":8036,"rel":8037},"https://unpkg.com/@waline/client@3.1.3/dist/waline.umd.js",[36]," 用这个地址",[19,8040,8041,8042,8045],{},"本质是 ...... 没有使用 ES Module 的加载方式 ",[76,8043,8044],{},"\u003Cscript type=\"module\">","，所以需要使用 UMD 的模块",[19,8047,8048,8049],{},"那么按照正常的脑回路，我们应该修改主题中的引入 waline 部分的 js 文件，把针对 waline.js 的引用改成 waline.umd.js，具体的修改处",[32,8050,8053],{"href":8051,"rel":8052},"https://github.com/fluid-dev/hexo-theme-fluid/blob/94049b2e6da5ae865f5cf7088f0c53917a6dc8bc/layout/_partials/comments/waline.ejs#L5-L6",[36],"在这里",[19,8055,8056],{},"但是，我是使用 npm 安装的主题，方便在主题更新时直接同步上游的更改，如果使用这种修改源文件引用的方式将会导致我不得不放弃原有的主题安装方式，改用下载主题源码的方式。",[19,8058,8059,8060,8062],{},"那么有没有办法，既能够成功加载带 umd 的 js，又不用改动主题源码呢？还真有，我自己部署 cdn 就好了。从 npmjs 下载带 umd 的 waline.umd.js，重命名成 waline.js，和 waline.css 一起放在同一路径下，在把自己的 cdn 链接前缀填入 ",[76,8061,7985],{}," 中，就可以实现移花接木——表面上访问的是 waline.js，实际上内容是 waline.umd.js 。",[118,8064,8066],{"id":8065},"插曲二重复显示的","插曲二——重复显示的 @",[19,8068,8069],{},"更新到 v3 版本以后，我发现所有的评论都出现了重复两遍的 @",[19,8071,8072],{},[25,8073],{"alt":53,"src":8074},"https://static.031130.xyz/uploads/2024/11/16/f6fbaa99a784e.webp",[19,8076,8077,8078,8083],{},"我去群里提问，管理员 ",[32,8079,8082],{"href":8080,"rel":8081},"https://imnerd.org/",[36],"li zheming"," 给出了这样的答复:",[64,8085,8086],{},[19,8087,8088],{},"这个是 feature 了，早版本 @ 是渲染在评论内容里的，这块后来重构了下，@ 是 Waline 自己渲染了。不过历史数据我们并没有处理，所以会出现这种情况。如果比较介意的话可以手动去数据库里删除下。",[19,8090,8091],{},"那么很显然，我很介意这点，我需要删除数据库中的 @ 信息。",[19,8093,8094],{},"打开 waline 的后台管理站点，我发现我有整整 30 页的评论——很显然我是 waline 的牢用户了，我不太可能一个一个手动去掉评论中的 @",[19,8096,8097],{},[25,8098],{"alt":53,"src":8099},"https://static.031130.xyz/uploads/2024/11/16/c4487502542e5.webp",[19,8101,8102],{},"我的 waline 数据库是 leancloud，对方的 webui 没办法帮助我批量去除 html 或者 markdown 形式的内容（就算对方支持 sql 语句，处理这个问题都够呛），我需要一个脚本来直接处理数据库中的信息。",[19,8104,8105],{},"首先，我们需要导出数据库数据，自然是登陆 leancloud，然后找到 数据存储 - 导入导出 - 数据导出，选择 Comment 单个 Class，单击导出按钮。",[19,8107,8108],{},[25,8109],{"alt":53,"src":8110},"https://static.031130.xyz/uploads/2024/11/16/d2cd564739120.webp",[19,8112,8113],{},"err，我寻思凌晨 1 点应该是 16 点前吧，怎么导出不了，而我昨晚 23 点反而可以导出，leancloud 到底是哪门子时区。所以我直接拿了 23 点时导出的数据进行处理。",[19,8115,8116],{},"leancloud 导出的数据是 jsonl 格式的，我们对需要去除的 @ 信息进行归纳总结，发现一共有两种 @ 的渲染方式",[129,8118,8119,8125],{},[132,8120,8121,8124],{},[76,8122,8123],{},"\u003Ca class=\"at\" href=\"#id\">@username\u003C/a>","  的 html 风格（有时 class 和 href 顺序还会反过来）",[132,8126,8127,8130],{},[76,8128,8129],{},"[@username](#id)"," 的 markdown 风格",[19,8132,8133],{},"而 html 风格还有两种结尾方式，",[19,8135,8136,8137,8140],{},"一种是如 ",[76,8138,8139],{},"\u003Ca class=\"at\" href=\"#id\">@username\u003C/a> , "," 这样以 空格 + 半角逗号 + 空格 结尾的形式，",[19,8142,8143,8144,8147],{},"令一种是如 ",[76,8145,8146],{},"\u003Ca class=\"at\" href=\"#id\">@username\u003C/a>: "," 这样以 半角冒号 + 空格结尾的形式。",[19,8149,8150,8151,8154],{},"markdown 风格的结尾方式我就只看到一种，如 ",[76,8152,8153],{},"[@username](#id): ","这样以 半角冒号 + 空格结尾的形式。",[19,8156,8157],{},"因此，我们需要对三种形式分别编写正则表达式进行匹配并删除，参考代码如下",[70,8159,8163],{"className":8160,"code":8161,"language":8162,"meta":53,"style":53},"language-python shiki shiki-themes one-light one-dark-pro","import re\n\nwith open('Comment.0.jsonl', 'r') as f:\n    s = f.read()\n\npatterns = [\n    r'\u003Ca class=\\\\\"at\\\\\" href=\\\\\"#(?:.*?)\\\\\">@(?:.*?)\u003C/a>: ',\n    r'\u003Ca class=\\\\\"at\\\\\" href=\\\\\"#(?:.*?)\\\\\">@(?:.*?)\u003C/a> , ',\n    r'\\[@(?:.*?)\\]\\(#(?:.*?)\\):'\n]\n\nfor pattern in patterns:\n    s = re.sub(pattern, \"\", s)\n\nwith open('Comment.1.jsonl', 'w') as f:\n    f.write(s)\n","python",[76,8164,8165,8170,8174,8179,8184,8188,8193,8198,8203,8208,8212,8216,8221,8226,8230,8235],{"__ignoreMap":53},[79,8166,8167],{"class":81,"line":82},[79,8168,8169],{},"import re\n",[79,8171,8172],{"class":81,"line":93},[79,8173,337],{"emptyLinePlaceholder":44},[79,8175,8176],{"class":81,"line":110},[79,8177,8178],{},"with open('Comment.0.jsonl', 'r') as f:\n",[79,8180,8181],{"class":81,"line":374},[79,8182,8183],{},"    s = f.read()\n",[79,8185,8186],{"class":81,"line":394},[79,8187,337],{"emptyLinePlaceholder":44},[79,8189,8190],{"class":81,"line":416},[79,8191,8192],{},"patterns = [\n",[79,8194,8195],{"class":81,"line":437},[79,8196,8197],{},"    r'\u003Ca class=\\\\\"at\\\\\" href=\\\\\"#(?:.*?)\\\\\">@(?:.*?)\u003C/a>: ',\n",[79,8199,8200],{"class":81,"line":458},[79,8201,8202],{},"    r'\u003Ca class=\\\\\"at\\\\\" href=\\\\\"#(?:.*?)\\\\\">@(?:.*?)\u003C/a> , ',\n",[79,8204,8205],{"class":81,"line":479},[79,8206,8207],{},"    r'\\[@(?:.*?)\\]\\(#(?:.*?)\\):'\n",[79,8209,8210],{"class":81,"line":501},[79,8211,6790],{},[79,8213,8214],{"class":81,"line":523},[79,8215,337],{"emptyLinePlaceholder":44},[79,8217,8218],{"class":81,"line":528},[79,8219,8220],{},"for pattern in patterns:\n",[79,8222,8223],{"class":81,"line":541},[79,8224,8225],{},"    s = re.sub(pattern, \"\", s)\n",[79,8227,8228],{"class":81,"line":558},[79,8229,337],{"emptyLinePlaceholder":44},[79,8231,8232],{"class":81,"line":931},[79,8233,8234],{},"with open('Comment.1.jsonl', 'w') as f:\n",[79,8236,8237],{"class":81,"line":936},[79,8238,8239],{},"    f.write(s)\n",[19,8241,8242,8243,8246],{},"随后删除 Comment 表中所有数据，把生成的 ",[76,8244,8245],{},"Comment.1.jsonl"," 导入 leancloud，就算是大功告成了。",[19,8248,8249],{},[25,8250],{"alt":53,"src":8251},"https://static.031130.xyz/uploads/2024/11/16/d248ae2eac74c.webp",[19,8253,8254],{},[25,8255],{"alt":53,"src":8256},"https://static.031130.xyz/uploads/2024/11/16/c3875dcde1d97.webp",[264,8258,8259],{},"html .default .shiki span {color: var(--shiki-default);background: var(--shiki-default-bg);font-style: var(--shiki-default-font-style);font-weight: var(--shiki-default-font-weight);text-decoration: var(--shiki-default-text-decoration);}html .shiki span {color: var(--shiki-default);background: var(--shiki-default-bg);font-style: var(--shiki-default-font-style);font-weight: var(--shiki-default-font-weight);text-decoration: var(--shiki-default-text-decoration);}html .dark .shiki span {color: var(--shiki-dark);background: var(--shiki-dark-bg);font-style: var(--shiki-dark-font-style);font-weight: var(--shiki-dark-font-weight);text-decoration: var(--shiki-dark-text-decoration);}html.dark .shiki span {color: var(--shiki-dark);background: var(--shiki-dark-bg);font-style: var(--shiki-dark-font-style);font-weight: var(--shiki-dark-font-weight);text-decoration: var(--shiki-dark-text-decoration);}",{"title":53,"searchDepth":93,"depth":93,"links":8261},[8262,8263],{"id":8006,"depth":93,"text":8007},{"id":8065,"depth":93,"text":8066},128,1762284706825]