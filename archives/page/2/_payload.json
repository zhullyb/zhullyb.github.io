[{"data":1,"prerenderedAt":7457},["ShallowReactive",2],{"randomIndex/archives/page/2/":3,"index-page-2-zh":4,"language-switch-/archives/page/2/-en":7455,"posts-nums-total-zh":7456},2,[5,951,1566,2283,2514,4020,4310,4643,5498,6161],{"title":6,"date":7,"path":8,"tags":9,"body":15},"node-sass 迁移至 dart-sass 踩坑实录","2025-07-05 17:57:02","/2025/07/05/node-sass-migration-to-dart-sass",[10,11,12,13,14],"Web","Vue.js","Sass","CSS","JavaScript",{"type":16,"value":17,"toc":929},"minimark",[18,22,35,39,56,59,92,95,100,104,108,117,120,129,195,198,201,204,236,245,248,252,256,285,289,422,426,435,476,480,483,551,554,558,561,564,591,594,637,646,651,655,664,672,724,727,784,787,811,814,817,925],[19,20,21],"h2",{"id":21},"更新目标",[23,24,25,29,32],"ul",{},[26,27,28],"li",{},"node-sass -> sass ( dart-sass )",[26,30,31],{},"减少影响面，非必要不更新其他依赖的版本",[26,33,34],{},"在前两条基础上，看看能否提升 node.js 的版本",[19,36,38],{"id":37},"抛弃-node-sass-的理由","抛弃 node-sass 的理由",[23,40,41,50,53],{},[26,42,43],{},[44,45,49],"a",{"href":46,"rel":47},"https://sass-lang.com/blog/libsass-is-deprecated/",[48],"nofollow","node-sass 已经停止维护，dart-sass 是 sass 官方主推的继任者",[26,51,52],{},"node-sass 在 windows 下的安装非常麻烦，npm 安装时需要开发机上同时装有 python2 和 Microsoft Visual C++",[26,54,55],{},"在安装 node-sass 时，需要从 Github 拉取资源，在特定网络环境下成功率并不高",[19,57,58],{"id":58},"项目依赖版本现状",[23,60,61,67,72,77,82,87],{},[26,62,63],{},[64,65,66],"code",{},"node@^12",[26,68,69],{},[64,70,71],{},"vue@^2",[26,73,74],{},[64,75,76],{},"webpack@^3",[26,78,79],{},[64,80,81],{},"vue-loader@^14",[26,83,84],{},[64,85,86],{},"sass-loader@^7.0.3",[26,88,89],{},[64,90,91],{},"node-sass@^4",[19,93,94],{"id":94},"更新思路",[96,97,99],"h3",{"id":98},"nodejs","node.js",[101,102,103],"p",{},"webpack 官方并没有提供 webpack 3 支持的最高 node 版本，且即使 webpack 官方支持，webpack 的相关插件也未必支持。因此 node 版本能否更新就只能自己试。好在尽管这个项目的 CI/CD 跑在 node 12，但我日常都在用 node 14 开发，因此顺势将 node 版本提升至 14。",[96,105,107],{"id":106},"webpacksass-loader","webpack、sass-loader",[101,109,110,111,116],{},"webpack 的版本目前处于非必要不更新的定时炸弹状态，基于现有的 webpack 3 限制，所支持的最高 sass-loader 版本就是 ^7 （ sass-loader 在 ",[44,112,115],{"href":113,"rel":114},"https://github.com/webpack-contrib/sass-loader/blob/v8.0.0/CHANGELOG.md",[48],"8.0.0 版本的更新日志","中明确指出 8.0.0 版本需要 webpack 4.36.0）。",[101,118,119],{},"如果项目中 sass-loader@^7 支持使用 dart-sass 就可以不更新 sass-loader，也就不必更新 webpack 版本；反之，就需要同步更新 webpack 至 4，再视情况定下 sass-loader 的版本。",[101,121,122,123,128],{},"那么到底支不支持呢？我在 ",[44,124,127],{"href":125,"rel":126},"https://www.webpackjs.com/loaders/sass-loader/",[48],"webpack 官方文档介绍 sass-loader 的页面","找到了这样一段 package.json 片段",[130,131,136],"pre",{"className":132,"code":133,"language":134,"meta":135,"style":135},"language-json shiki shiki-themes one-light one-dark-pro","{\n  \"devDependencies\": {\n    \"sass-loader\": \"^7.2.0\",\n    \"sass\": \"^1.22.10\"\n  }\n}\n","json","",[64,137,138,147,156,172,183,189],{"__ignoreMap":135},[139,140,143],"span",{"class":141,"line":142},"line",1,[139,144,146],{"class":145},"s5ixo","{\n",[139,148,149,153],{"class":141,"line":3},[139,150,152],{"class":151},"sJa8x","  \"devDependencies\"",[139,154,155],{"class":145},": {\n",[139,157,159,162,165,169],{"class":141,"line":158},3,[139,160,161],{"class":151},"    \"sass-loader\"",[139,163,164],{"class":145},": ",[139,166,168],{"class":167},"sDhpE","\"^7.2.0\"",[139,170,171],{"class":145},",\n",[139,173,175,178,180],{"class":141,"line":174},4,[139,176,177],{"class":151},"    \"sass\"",[139,179,164],{"class":145},[139,181,182],{"class":167},"\"^1.22.10\"\n",[139,184,186],{"class":141,"line":185},5,[139,187,188],{"class":145},"  }\n",[139,190,192],{"class":141,"line":191},6,[139,193,194],{"class":145},"}\n",[101,196,197],{},"这证明起码在 sass-loader@7.2.0 这一版本就已经支持 dart-sass 了，因此 webpack 版本可以停留在 ^3，而 sass-loader 暂时停留在 7.0.3 版本，如果后续有问题可以更新到 ^7 版本中最新的 7.3.1 版本。",[96,199,200],{"id":200},"dart-sass",[101,202,203],{},"sass-loader@^7 所支持的最高 sass 我并没有查到，Github Copilot 信誓旦旦地告诉我",[205,206,207,213,218,223],"blockquote",{},[101,208,209],{},[210,211,212],"strong",{},"官方文档引用：",[205,214,215],{},[101,216,217],{},"sass-loader@^7.0.0 requires node-sass >=4.0.0 or sass >=1.3.0, \u003C=1.26.5.",[101,219,220],{},[210,221,222],{},"建议：",[23,224,225],{},[26,226,227,228,231,232,235],{},"如果需要使用更高版本的 ",[64,229,230],{},"sass","，请升级到 ",[64,233,234],{},"sass-loader"," 8 或更高版本。",[101,237,238,239,244],{},"但事实上，我并没有在互联网上找到这段文本的蛛丝马迹。并且在 sass 的 ~1.26 版本中最后一个版本是 1.26.11 而非 1.26.5，",[44,240,243],{"href":241,"rel":242},"https://docs.npmjs.com/about-semantic-versioning",[48],"根据常见的 npm 版本号原则","，major version 和 minor version 不变，只改变了 patch version 的发版一般只有 bugfix 而没有 breaking change，不至于从 1.26.5 更新到 1.26.11 就突然不支持 sass-loader 7 了，因此更可能是 AI 幻觉或者是训练数据受限。",[101,246,247],{},"出于谨慎考虑，最终决定采用 webpack 官方文档中提到的 sass 1.22 的最后一个版本，也就是 1.22.12。",[19,249,251],{"id":250},"分析完成动手更新","分析完成，动手更新",[96,253,255],{"id":254},"第一步卸载-node-sass安装-sass12212","第一步，卸载 node-sass，安装 sass@^1.22.12",[130,257,261],{"className":258,"code":259,"language":260,"meta":135,"style":135},"language-bash shiki shiki-themes one-light one-dark-pro","npm uninstall node-sass\nnpm install sass@^1.22.12\n","bash",[64,262,263,275],{"__ignoreMap":135},[139,264,265,269,272],{"class":141,"line":142},[139,266,268],{"class":267},"sAdtL","npm",[139,270,271],{"class":167}," uninstall",[139,273,274],{"class":167}," node-sass\n",[139,276,277,279,282],{"class":141,"line":3},[139,278,268],{"class":267},[139,280,281],{"class":167}," install",[139,283,284],{"class":167}," sass@^1.22.12\n",[96,286,288],{"id":287},"第二步更新-webpack-配置非必须","第二步，更新 webpack 配置（非必须）",[130,290,294],{"className":291,"code":292,"language":293,"meta":135,"style":135},"language-diff shiki shiki-themes one-light one-dark-pro","module.exports = {\n  // ...\n  module: {\n    rules: [\n      {\n        test: /\\.(scss|sass)$/,\n        use: [\n          'style-loader',\n          'css-loader',\n          {\n            loader: 'sass-loader',\n+            options: {\n+                // 事实上，这一行在大部分 sass-loader 版本中不用加，sass-loader 能自动检测本地是 sass 还是 node-sass\n+                implementation: require('sass')\n+              },\n            },\n          },\n        ],\n      },\n    ],\n  },\n};\n","diff",[64,295,296,301,306,311,316,321,326,332,338,344,350,356,362,368,374,380,386,392,398,404,410,416],{"__ignoreMap":135},[139,297,298],{"class":141,"line":142},[139,299,300],{"class":145},"module.exports = {\n",[139,302,303],{"class":141,"line":3},[139,304,305],{"class":145},"  // ...\n",[139,307,308],{"class":141,"line":158},[139,309,310],{"class":145},"  module: {\n",[139,312,313],{"class":141,"line":174},[139,314,315],{"class":145},"    rules: [\n",[139,317,318],{"class":141,"line":185},[139,319,320],{"class":145},"      {\n",[139,322,323],{"class":141,"line":191},[139,324,325],{"class":145},"        test: /\\.(scss|sass)$/,\n",[139,327,329],{"class":141,"line":328},7,[139,330,331],{"class":145},"        use: [\n",[139,333,335],{"class":141,"line":334},8,[139,336,337],{"class":145},"          'style-loader',\n",[139,339,341],{"class":141,"line":340},9,[139,342,343],{"class":145},"          'css-loader',\n",[139,345,347],{"class":141,"line":346},10,[139,348,349],{"class":145},"          {\n",[139,351,353],{"class":141,"line":352},11,[139,354,355],{"class":145},"            loader: 'sass-loader',\n",[139,357,359],{"class":141,"line":358},12,[139,360,361],{"class":167},"+            options: {\n",[139,363,365],{"class":141,"line":364},13,[139,366,367],{"class":167},"+                // 事实上，这一行在大部分 sass-loader 版本中不用加，sass-loader 能自动检测本地是 sass 还是 node-sass\n",[139,369,371],{"class":141,"line":370},14,[139,372,373],{"class":167},"+                implementation: require('sass')\n",[139,375,377],{"class":141,"line":376},15,[139,378,379],{"class":167},"+              },\n",[139,381,383],{"class":141,"line":382},16,[139,384,385],{"class":145},"            },\n",[139,387,389],{"class":141,"line":388},17,[139,390,391],{"class":145},"          },\n",[139,393,395],{"class":141,"line":394},18,[139,396,397],{"class":145},"        ],\n",[139,399,401],{"class":141,"line":400},19,[139,402,403],{"class":145},"      },\n",[139,405,407],{"class":141,"line":406},20,[139,408,409],{"class":145},"    ],\n",[139,411,413],{"class":141,"line":412},21,[139,414,415],{"class":145},"  },\n",[139,417,419],{"class":141,"line":418},22,[139,420,421],{"class":145},"};\n",[96,423,425],{"id":424},"第三步批量替换-deep-语法为-v-deep","第三步，批量替换 /deep/ 语法为 ::v-deep",[101,427,428,429,434],{},"因为 ",[44,430,433],{"href":431,"rel":432},"https://chromestatus.com/feature/4964279606312960",[48],"/deep/ 写法在 2017 年被弃用"," ，/deep/ 变成了不受支持的深度作用选择器，node-sass 凭借其出色的容错性能够继续提供兼容，但 dart-sass 则不支持这种写法。于是需要将 /deep/ 语法批量替换成 ::v-deep 写法，这种写法虽然在 vue 的后续 rfc 被放弃了，但直至今日依然在事实上被支持。",[130,436,438],{"className":258,"code":437,"language":260,"meta":135,"style":135},"# 大概就是这么个意思，用 vscode 的批量替换其实也行\nsed -i 's#\\s*/deep/\\s*# ::v-deep #g' $(grep -rl '/deep/' .)\n",[64,439,440,446],{"__ignoreMap":135},[139,441,442],{"class":141,"line":142},[139,443,445],{"class":444},"sW2Sy","# 大概就是这么个意思，用 vscode 的批量替换其实也行\n",[139,447,448,451,455,458,461,464,467,470,473],{"class":141,"line":3},[139,449,450],{"class":267},"sed",[139,452,454],{"class":453},"sAGMh"," -i",[139,456,457],{"class":167}," 's#\\s*/deep/\\s*# ::v-deep #g'",[139,459,460],{"class":145}," $(",[139,462,463],{"class":267},"grep",[139,465,466],{"class":453}," -rl",[139,468,469],{"class":167}," '/deep/'",[139,471,472],{"class":167}," .",[139,474,475],{"class":145},")\n",[96,477,479],{"id":478},"第四步修复其他-sass-语法错误","第四步，修复其他 sass 语法错误",[101,481,482],{},"在迁移的过程中，我发现项目中有一些不规范的写法，node-sass 凭借出色的鲁棒性不吭一声强行解析，而 dart-sass 则干不了这粗活。因此需要根据编译时的报错手动修复一下这些语法错误，我这里一共遇到两种。",[130,484,486],{"className":291,"code":485,"language":293,"meta":135,"style":135},"// 多打了一个冒号\n.foo {\n-  color:: #fff;\n+  color: #fff;\n}\n\n// :nth-last-child 没指定数字\n.bar {\n-  &:nth-last-child() {\n+  &:nth-last-child(1) {\n      margin-bottom: 0;\n  }\n}\n",[64,487,488,493,498,503,508,512,518,523,528,533,538,543,547],{"__ignoreMap":135},[139,489,490],{"class":141,"line":142},[139,491,492],{"class":145},"// 多打了一个冒号\n",[139,494,495],{"class":141,"line":3},[139,496,497],{"class":145},".foo {\n",[139,499,500],{"class":141,"line":158},[139,501,502],{"class":151},"-  color:: #fff;\n",[139,504,505],{"class":141,"line":174},[139,506,507],{"class":167},"+  color: #fff;\n",[139,509,510],{"class":141,"line":185},[139,511,194],{"class":145},[139,513,514],{"class":141,"line":191},[139,515,517],{"emptyLinePlaceholder":516},true,"\n",[139,519,520],{"class":141,"line":328},[139,521,522],{"class":145},"// :nth-last-child 没指定数字\n",[139,524,525],{"class":141,"line":334},[139,526,527],{"class":145},".bar {\n",[139,529,530],{"class":141,"line":340},[139,531,532],{"class":151},"-  &:nth-last-child() {\n",[139,534,535],{"class":141,"line":346},[139,536,537],{"class":167},"+  &:nth-last-child(1) {\n",[139,539,540],{"class":141,"line":352},[139,541,542],{"class":145},"      margin-bottom: 0;\n",[139,544,545],{"class":141,"line":358},[139,546,188],{"class":145},[139,548,549],{"class":141,"line":364},[139,550,194],{"class":145},[19,552,553],{"id":553},"踩坑",[96,555,557],{"id":556},"v-deep-样式不生效","::v-deep 样式不生效",[101,559,560],{},"依赖更新完后看了两眼好像是没问题，就推测试环境了。结果一天没到就被同事 call 了，::v-deep 这种深度作用选择器居然没有生效？",[101,562,563],{},"抱着试一试的态度，GPT 给了如下回答",[205,565,566],{},[101,567,568,569,572,573,576,577,583,584,587,588,590],{},"在 ",[210,570,571],{},"Vue 2 + vue-loader + Sass"," 的组合下，",[210,574,575],{},"这种写法是正确的","，",[210,578,579,580],{},"前提是你的构建工具链支持 ",[64,581,582],{},"::v-deep"," 语法（如 ",[64,585,586],{},"vue-loader@15"," 及以上版本 + ",[64,589,234],{},"）。",[101,592,593],{},"虽说我依然没有查证到为什么更新 vue-loader@15 才能使用 ::v-deep 语法，但对 vue-loader 进行更新后，::v-deep 语法确实生效了。在撰写本文时，我找到了些许蛛丝马迹，可能能解释这一问题。",[595,596,597,612],"ol",{},[26,598,599,600,605,606,611],{},"vue-loader 在 ",[44,601,604],{"href":602,"rel":603},"https://vue-loader-v14.vuejs.org/en/features/scoped-css.html#deep-selectors",[48],"14 版本的官方文档","就是没有 ::v-deep 写法的示例，",[44,607,610],{"href":608,"rel":609},"https://github.com/vuejs/vue-loader/commit/2585d254fc774386a898887467fbdd30eb864b53",[48],"这一示例一直在 vue-loader 15.7.0 版本发布后才被加入","。",[26,613,614,615,622,625,626,631,632],{},"vue-cli 的 Github Issue 评论区中有人提到",[205,616,617],{},[101,618,619,621],{},[64,620,582],{}," implemented in @vue/component-compiler-utils v2.6.0, should work after you reinstall the deps.",[623,624],"br",{},"而 vue-loader 在 15.0.0-beta.1 版本才",[44,627,630],{"href":628,"rel":629},"https://github.com/vuejs/vue-loader/commit/e32cd0e4372fcc6f13b6c307402713807516d71c#diff-7ae45ad102eab3b6d7e7896acd08c427a9b25b346470d7bc6507b6481575d519",[48],"将 @vue/component-compiler-utils 加入到自己的 dependencies 中","，并直到 vue-loader 15.7.1 中才",[44,633,636],{"href":634,"rel":635},"https://github.com/vuejs/vue-loader/commit/c359a38db0fbb4135fc97114baec3cd557d4123a",[48],"将其 @vue/component-compiler-utils 的版本号更新到满足要求的 ^3.0.0",[101,638,639,640,645],{},"那能否升级到 vue-loader 16 甚至 17 版本呢？不行，在 ",[44,641,644],{"href":642,"rel":643},"https://github.com/vuejs/vue-loader/releases/tag/v16.1.2",[48],"vue-loader v16.1.2 的更新日志","中明确写道",[205,647,648],{},[101,649,650],{},"Note: vue-loader v16 is for Vue 3 only.",[96,652,654],{"id":653},"vue-loader-14-15-breaking-change","vue-loader 14 -> 15 breaking change",[101,656,657,658,663],{},"vue-loader 从 14 往上迁移时，不修改 webpack 配置直接跑会遇到 vue 语法不识别的问题。具体表现为 .vue 文件命名都是正确有效的语法，但构建开发时编译器就是不认，报语法错误。vue-loader 官方有一份",[44,659,662],{"href":660,"rel":661},"https://vue-loader.vuejs.org/migrating.html",[48],"迁移文档","，需要注意一下。",[130,665,670],{"className":666,"code":668,"language":669},[667],"language-text","ERROR in ./src/......\nModule parse failed: Unexpected token(1:0)\nYou may need an appropriate loader to handle this file type.\n","text",[64,671,668],{"__ignoreMap":135},[130,673,675],{"className":291,"code":674,"language":293,"meta":135,"style":135},"// ...\nimport path from 'path'\n+const VueLoaderPlugin = require('vue-loader/lib/plugin')\n\n// ...\n\n  plugins: [\n+    new VueLoaderPlugin()\n    // ...\n  ]\n",[64,676,677,682,687,692,696,700,704,709,714,719],{"__ignoreMap":135},[139,678,679],{"class":141,"line":142},[139,680,681],{"class":145},"// ...\n",[139,683,684],{"class":141,"line":3},[139,685,686],{"class":145},"import path from 'path'\n",[139,688,689],{"class":141,"line":158},[139,690,691],{"class":167},"+const VueLoaderPlugin = require('vue-loader/lib/plugin')\n",[139,693,694],{"class":141,"line":174},[139,695,517],{"emptyLinePlaceholder":516},[139,697,698],{"class":141,"line":185},[139,699,681],{"class":145},[139,701,702],{"class":141,"line":191},[139,703,517],{"emptyLinePlaceholder":516},[139,705,706],{"class":141,"line":328},[139,707,708],{"class":145},"  plugins: [\n",[139,710,711],{"class":141,"line":334},[139,712,713],{"class":167},"+    new VueLoaderPlugin()\n",[139,715,716],{"class":141,"line":340},[139,717,718],{"class":145},"    // ...\n",[139,720,721],{"class":141,"line":346},[139,722,723],{"class":145},"  ]\n",[101,725,726],{},"除此之外，在我这个项目中需要额外移除 webpack 配置中针对 .vue 文件的 babel-loader",[130,728,730],{"className":291,"code":729,"language":293,"meta":135,"style":135},"{\n  test: /\\.vue$/,\n  use: [\n-    {\n-      loader: 'babel-loader'\n-    },\n    {\n      loader: 'vue-loader',\n    }\n  ]\n}\n",[64,731,732,736,741,746,751,756,761,766,771,776,780],{"__ignoreMap":135},[139,733,734],{"class":141,"line":142},[139,735,146],{"class":145},[139,737,738],{"class":141,"line":3},[139,739,740],{"class":145},"  test: /\\.vue$/,\n",[139,742,743],{"class":141,"line":158},[139,744,745],{"class":145},"  use: [\n",[139,747,748],{"class":141,"line":174},[139,749,750],{"class":151},"-    {\n",[139,752,753],{"class":141,"line":185},[139,754,755],{"class":151},"-      loader: 'babel-loader'\n",[139,757,758],{"class":141,"line":191},[139,759,760],{"class":151},"-    },\n",[139,762,763],{"class":141,"line":328},[139,764,765],{"class":145},"    {\n",[139,767,768],{"class":141,"line":334},[139,769,770],{"class":145},"      loader: 'vue-loader',\n",[139,772,773],{"class":141,"line":340},[139,774,775],{"class":145},"    }\n",[139,777,778],{"class":141,"line":346},[139,779,723],{"class":145},[139,781,782],{"class":141,"line":352},[139,783,194],{"class":145},[19,785,786],{"id":786},"最终更新情况",[23,788,789,797,804],{},[26,790,791,793,794],{},[64,792,66],{}," -> ",[64,795,796],{},"node@^14",[26,798,799,793,801],{},[64,800,81],{},[64,802,803],{},"vue-loader@^15",[26,805,806,793,808],{},[64,807,91],{},[64,809,810],{},"sass@^1.22.12",[101,812,813],{},"其余依赖版本维持不变",[19,815,816],{"id":816},"参见",[23,818,819,836,843,849,855,862,869,875,881,887,893,899,905,912,919],{},[26,820,821],{},[44,822,825,826,828,829,832,833,835],{"href":823,"rel":824},"https://juejin.cn/post/7327094228350500914",[48],"node-sass更换为dart-sass",[64,827,200],{}," 和 ",[64,830,831],{},"node-sass","都是用来将",[64,834,230],{},"编译成 - 掘金",[26,837,838],{},[44,839,842],{"href":840,"rel":841},"https://sunchenggit.github.io/2021/01/13/node-sass%E8%BF%81%E7%A7%BBdart-sass/",[48],"node-sass迁移dart-sass | Bolg",[26,844,845],{},[44,846,848],{"href":125,"rel":847},[48],"sass-loader | webpack 中文文档 | webpack中文文档 | webpack中文网",[26,850,851],{},[44,852,854],{"href":46,"rel":853},[48],"Sass: LibSass is Deprecated",[26,856,857],{},[44,858,861],{"href":859,"rel":860},"https://www.npmjs.com/package/sass?activeTab=versions",[48],"sass - npm",[26,863,864],{},[44,865,868],{"href":866,"rel":867},"https://www.npmjs.com/package/node-sass",[48],"node-sass - npm",[26,870,871],{},[44,872,874],{"href":241,"rel":873},[48],"About semantic versioning | npm Docs",[26,876,877],{},[44,878,880],{"href":431,"rel":879},[48],"Make /deep/ behave like the descendant combinator \" \" in CSS live profile (in css file or inside of \u003Cstyle>) - Chrome Platform Status",[26,882,883],{},[44,884,886],{"href":113,"rel":885},[48],"sass-loader/CHANGELOG.md at v8.0.0 · webpack-contrib/sass-loader",[26,888,889],{},[44,890,892],{"href":642,"rel":891},[48],"Release v16.1.2 · vuejs/vue-loader",[26,894,895],{},[44,896,898],{"href":628,"rel":897},[48],"refactor: use @vue/component-compiler-utils · vuejs/vue-loader@e32cd0e",[26,900,901],{},[44,902,904],{"href":634,"rel":903},[48],"chore: update @vue/component-compiler-utils to v3 · vuejs/vue-loader@c359a38",[26,906,907],{},[44,908,911],{"href":909,"rel":910},"https://github.com/vuejs/vue-cli/issues/3399#issuecomment-466319019",[48],"dart-sass does not support /deep/ selector · Issue #3399 · vuejs/vue-cli",[26,913,914],{},[44,915,918],{"href":916,"rel":917},"https://vue-loader-v14.vuejs.org/en/features/scoped-css.html",[48],"Scoped CSS · vue-loader v14",[26,920,921],{},[44,922,924],{"href":660,"rel":923},[48],"Migrating from v14 | Vue Loader",[926,927,928],"style",{},"html pre.shiki code .s5ixo, html code.shiki .s5ixo{--shiki-default:#383A42;--shiki-dark:#ABB2BF}html pre.shiki code .sJa8x, html code.shiki .sJa8x{--shiki-default:#E45649;--shiki-dark:#E06C75}html pre.shiki code .sDhpE, html code.shiki .sDhpE{--shiki-default:#50A14F;--shiki-dark:#98C379}html .default .shiki span {color: var(--shiki-default);background: var(--shiki-default-bg);font-style: var(--shiki-default-font-style);font-weight: var(--shiki-default-font-weight);text-decoration: var(--shiki-default-text-decoration);}html .shiki span {color: var(--shiki-default);background: var(--shiki-default-bg);font-style: var(--shiki-default-font-style);font-weight: var(--shiki-default-font-weight);text-decoration: var(--shiki-default-text-decoration);}html .dark .shiki span {color: var(--shiki-dark);background: var(--shiki-dark-bg);font-style: var(--shiki-dark-font-style);font-weight: var(--shiki-dark-font-weight);text-decoration: var(--shiki-dark-text-decoration);}html.dark .shiki span {color: var(--shiki-dark);background: var(--shiki-dark-bg);font-style: var(--shiki-dark-font-style);font-weight: var(--shiki-dark-font-weight);text-decoration: var(--shiki-dark-text-decoration);}html pre.shiki code .sAdtL, html code.shiki .sAdtL{--shiki-default:#4078F2;--shiki-dark:#61AFEF}html pre.shiki code .sW2Sy, html code.shiki .sW2Sy{--shiki-default:#A0A1A7;--shiki-default-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic}html pre.shiki code .sAGMh, html code.shiki .sAGMh{--shiki-default:#986801;--shiki-dark:#D19A66}",{"title":135,"searchDepth":3,"depth":3,"links":930},[931,932,933,934,939,945,949,950],{"id":21,"depth":3,"text":21},{"id":37,"depth":3,"text":38},{"id":58,"depth":3,"text":58},{"id":94,"depth":3,"text":94,"children":935},[936,937,938],{"id":98,"depth":158,"text":99},{"id":106,"depth":158,"text":107},{"id":200,"depth":158,"text":200},{"id":250,"depth":3,"text":251,"children":940},[941,942,943,944],{"id":254,"depth":158,"text":255},{"id":287,"depth":158,"text":288},{"id":424,"depth":158,"text":425},{"id":478,"depth":158,"text":479},{"id":553,"depth":3,"text":553,"children":946},[947,948],{"id":556,"depth":158,"text":557},{"id":653,"depth":158,"text":654},{"id":786,"depth":3,"text":786},{"id":816,"depth":3,"text":816},{"title":952,"date":953,"path":954,"tags":955,"body":958},"前端中的量子力学——一打开 F12 就消失的 Bug","2025-06-08 01:22:13","/2025/06/08/front-end-bug-gone-when-open-devtool",[10,956,13,14,957],"HTML","Debug",{"type":16,"value":959,"toc":1559},[960,964,967,975,981,988,991,1005,1009,1012,1188,1191,1194,1197,1200,1206,1209,1243,1247,1260,1263,1330,1333,1495,1498,1501,1505,1512,1523,1526,1531,1533,1556],[19,961,963],{"id":962},"前端量子态现象的首次观测","前端「量子态」现象的首次观测",[101,965,966],{},"这事说来也邪乎，半个月前吃着火锅唱着歌，在工位上嘎嘎写码，发现一个诡异的 bug。作为如假包换的人类程序员，写出 bug 是再正常不过的事情了，但这 bug 邪门就邪门在我一打开 F12 的 DevTools 观察相关的 dom 结构，这 bug 就自动消失了；再把 DevTools 一关，Ctrl + F5 一刷新页面，Bug 又出现了。",[101,968,969,970],{},"下面是使用 iframe 引入的 ",[44,971,974],{"href":972,"rel":973},"https://static.031130.xyz/demo/scroll-jump-bug.html",[48],"demo",[976,977],"iframe",{"src":972,"width":978,"height":979,"allowFullScreen":516,"loading":980},"100%",500,"lazy",[101,982,983],{},[984,985],"img",{"alt":986,"src":987},"“观测”指南","https://static.031130.xyz/uploads/2025/06/08/65620d31fce6f.webp",[101,989,990],{},"这 Bug 给我整得脑瓜子嗡嗡的，我又不是物理学家，写个前端怎么量子力学的观察者效应都给我整出来了（？",[205,992,993,999,1002],{},[101,994,995,998],{},[210,996,997],{},"观测者效应","（Observer effect），是指“观测”这种行为对被观测对象造成一定影响的效应。",[101,1000,1001],{},"在量子力学实验中，如果要测算一个电子所处的速度，就要用两个光子隔一段时间去撞击这个电子，但第一个光子就已经把这个电子撞飞了，便改变了电子的原有速度，我们便无法测出真正准确的速度（不确定原理）。时间流逝的快慢也会受到观测者的影响，用很高的频率去观测粒子的衰变，反而使得粒子长时间不衰变。",[101,1003,1004],{},"——wikipedia",[19,1006,1008],{"id":1007},"量子迷雾浏览器机制","量子迷雾❌浏览器机制✅",[101,1010,1011],{},"这里先稍微解释一下 demo 中的代码片段:",[130,1013,1017],{"className":1014,"code":1015,"language":1016,"meta":135,"style":135},"language-javascript shiki shiki-themes one-light one-dark-pro","if (scrollIndex >= groupLength) {\n  setTimeout(() => {\n    wrapper.style.transition = \"none\";\n    scrollIndex = 0;\n    wrapper.style.transform = `translateY(-${crollIndex * itemHeight}px)`;\n\n    requestAnimationFrame(() => {\n      wrapper.style.transition = \"transform 0.5s cubic-bezier(0.25, 0.1, 0.25, 1)\";\n    });\n  }, 500);\n}\n","javascript",[64,1018,1019,1042,1056,1082,1094,1133,1137,1148,1168,1173,1184],{"__ignoreMap":135},[139,1020,1021,1025,1028,1032,1036,1039],{"class":141,"line":142},[139,1022,1024],{"class":1023},"sLKXg","if",[139,1026,1027],{"class":145}," (",[139,1029,1031],{"class":1030},"sz0mV","scrollIndex",[139,1033,1035],{"class":1034},"s_Sar"," >=",[139,1037,1038],{"class":1030}," groupLength",[139,1040,1041],{"class":145},") {\n",[139,1043,1044,1047,1050,1053],{"class":141,"line":3},[139,1045,1046],{"class":267},"  setTimeout",[139,1048,1049],{"class":145},"(() ",[139,1051,1052],{"class":1023},"=>",[139,1054,1055],{"class":145}," {\n",[139,1057,1058,1062,1065,1068,1070,1073,1076,1079],{"class":141,"line":158},[139,1059,1061],{"class":1060},"s7GmK","    wrapper",[139,1063,1064],{"class":145},".",[139,1066,926],{"class":1067},"s2QsP",[139,1069,1064],{"class":145},[139,1071,1072],{"class":151},"transition",[139,1074,1075],{"class":1034}," =",[139,1077,1078],{"class":167}," \"none\"",[139,1080,1081],{"class":145},";\n",[139,1083,1084,1087,1089,1092],{"class":141,"line":174},[139,1085,1086],{"class":1030},"    scrollIndex",[139,1088,1075],{"class":1034},[139,1090,1091],{"class":453}," 0",[139,1093,1081],{"class":145},[139,1095,1096,1098,1100,1102,1104,1107,1109,1112,1116,1119,1122,1125,1128,1131],{"class":141,"line":185},[139,1097,1061],{"class":1060},[139,1099,1064],{"class":145},[139,1101,926],{"class":1067},[139,1103,1064],{"class":145},[139,1105,1106],{"class":151},"transform",[139,1108,1075],{"class":1034},[139,1110,1111],{"class":167}," `translateY(-",[139,1113,1115],{"class":1114},"sAOjX","${",[139,1117,1118],{"class":1030},"crollIndex",[139,1120,1121],{"class":1034}," *",[139,1123,1124],{"class":1030}," itemHeight",[139,1126,1127],{"class":1114},"}",[139,1129,1130],{"class":167},"px)`",[139,1132,1081],{"class":145},[139,1134,1135],{"class":141,"line":191},[139,1136,517],{"emptyLinePlaceholder":516},[139,1138,1139,1142,1144,1146],{"class":141,"line":328},[139,1140,1141],{"class":267},"    requestAnimationFrame",[139,1143,1049],{"class":145},[139,1145,1052],{"class":1023},[139,1147,1055],{"class":145},[139,1149,1150,1153,1155,1157,1159,1161,1163,1166],{"class":141,"line":334},[139,1151,1152],{"class":1060},"      wrapper",[139,1154,1064],{"class":145},[139,1156,926],{"class":1067},[139,1158,1064],{"class":145},[139,1160,1072],{"class":151},[139,1162,1075],{"class":1034},[139,1164,1165],{"class":167}," \"transform 0.5s cubic-bezier(0.25, 0.1, 0.25, 1)\"",[139,1167,1081],{"class":145},[139,1169,1170],{"class":141,"line":340},[139,1171,1172],{"class":145},"    });\n",[139,1174,1175,1178,1181],{"class":141,"line":346},[139,1176,1177],{"class":145},"  }, ",[139,1179,1180],{"class":453},"500",[139,1182,1183],{"class":145},");\n",[139,1185,1186],{"class":141,"line":352},[139,1187,194],{"class":145},[101,1189,1190],{},"我这边拿到的需求是需要写一个无限滚动的轮播标题列表，每次展示三个，2 秒后标题列表整体上移，原本的第一个标题就移出可视范围了，下面会新补充一个新的标题列表。（可能解释的不清楚，但各位应该都看过上面的 demo 了）",[101,1192,1193],{},"当列表滚动到最底部的时候，我先取消 transition 过渡动画效果，趁机将整体列表平移到上一次可视范围内出现相同的三个标题的位置，再把 transition 过渡动画的效果加回来，这样就能在视觉上造成无限滚动的效果。",[101,1195,1196],{},"但问题就出在明明把 transition 属性取消了，但这一次平移仍然触发了过渡动画效果。",[101,1198,1199],{},"说实话，这是我短暂的码农生涯当中最绝望的一次，一方面是遇到的 bug 过于逆天以至于说出去都可能没人信，一方面是遇上这种问题是完全不能指望搜索引擎能给出什么解决方案的——毕竟我自己都不知道该怎么组织关键词进行搜索。",[101,1201,1202],{},[984,1203],{"alt":1204,"src":1205},"这是小麦茶，带我入坑前端的学长","https://static.031130.xyz/uploads/2025/06/08/475a61b332454.webp",[101,1207,1208],{},"于是抱着试一试的心态，把相关代码喂给 ChatGPT-4o 看看能不能问出个所以然来。",[205,1210,1211,1225],{},[101,1212,1213,1214,1217,1218,1221,1222,611],{},"你描述的现象——“",[210,1215,1216],{},"滚动第九次时列表出现突兀的自下而上跳动","，而",[210,1219,1220],{},"打开 F12 时不会出现问题","”——",[210,1223,1224],{},"几乎可以确定是由于浏览器在某些渲染状态下跳过了某些帧（帧率波动）或者定时器精度的问题导致动画突变",[101,1226,1227,1228,1231,1232,1235,1236,1239,1240,611],{},"这种问题多半发生在“使用 ",[64,1229,1230],{},"setInterval"," 控制动画”和“切换样式（transition）时机不当”所引起的 ",[210,1233,1234],{},"过渡跳帧问题","，而打开 DevTools 会 ",[210,1237,1238],{},"强制刷新帧或提高定时器精度","，从而",[210,1241,1242],{},"掩盖了这个问题",[19,1244,1246],{"id":1245},"太好了是-requestanimationframe我们有救了","太好了，是 requestAnimationFrame，我们有救了",[205,1248,1249,1257],{},[101,1250,1251,1256],{},[210,1252,1253],{},[64,1254,1255],{},"window.requestAnimationFrame()"," 方法会告诉浏览器你希望执行一个动画。它要求浏览器在下一次重绘之前，调用用户提供的回调函数。",[101,1258,1259],{},"——MDN",[101,1261,1262],{},"这是 GPT 给出的方案，非常有效",[130,1264,1266],{"className":291,"code":1265,"language":293,"meta":135,"style":135},"if (scrollIndex >= groupLength) {\n  setTimeout(() => {\n    wrapper.style.transition = \"none\";\n    scrollIndex = 0;\n    wrapper.style.transform = `translateY(-${crollIndex * itemHeight}px)`;\n\n    requestAnimationFrame(() => {\n+      requestAnimationFrame(() => {\n         wrapper.style.transition = \"transform 0.5s cubic-bezier(0.25, 0.1, 0.25, 1)\";\n+      });\n    });\n  }, 500);\n}\n",[64,1267,1268,1273,1278,1283,1288,1293,1297,1302,1307,1312,1317,1321,1326],{"__ignoreMap":135},[139,1269,1270],{"class":141,"line":142},[139,1271,1272],{"class":145},"if (scrollIndex >= groupLength) {\n",[139,1274,1275],{"class":141,"line":3},[139,1276,1277],{"class":145},"  setTimeout(() => {\n",[139,1279,1280],{"class":141,"line":158},[139,1281,1282],{"class":145},"    wrapper.style.transition = \"none\";\n",[139,1284,1285],{"class":141,"line":174},[139,1286,1287],{"class":145},"    scrollIndex = 0;\n",[139,1289,1290],{"class":141,"line":185},[139,1291,1292],{"class":145},"    wrapper.style.transform = `translateY(-${crollIndex * itemHeight}px)`;\n",[139,1294,1295],{"class":141,"line":191},[139,1296,517],{"emptyLinePlaceholder":516},[139,1298,1299],{"class":141,"line":328},[139,1300,1301],{"class":145},"    requestAnimationFrame(() => {\n",[139,1303,1304],{"class":141,"line":334},[139,1305,1306],{"class":167},"+      requestAnimationFrame(() => {\n",[139,1308,1309],{"class":141,"line":340},[139,1310,1311],{"class":145},"         wrapper.style.transition = \"transform 0.5s cubic-bezier(0.25, 0.1, 0.25, 1)\";\n",[139,1313,1314],{"class":141,"line":346},[139,1315,1316],{"class":167},"+      });\n",[139,1318,1319],{"class":141,"line":352},[139,1320,1172],{"class":145},[139,1322,1323],{"class":141,"line":358},[139,1324,1325],{"class":145},"  }, 500);\n",[139,1327,1328],{"class":141,"line":364},[139,1329,194],{"class":145},[101,1331,1332],{},"如果觉得嵌套两层 requestAnimationFrame 比较难理解，那下面的代码是等效的",[130,1334,1336],{"className":1014,"code":1335,"language":1016,"meta":135,"style":135},"if (scrollIndex >= groupLength) {\n  setTimeout(() => {\n    scrollIndex = 0;\n\n    requestAnimationFrame(() => {\n      // 第一帧\n      wrapper.style.transition = \"none\";\n      wrapper.style.transform = `translateY(-${crollIndex * itemHeight}px)`;\n      // 第二帧\n      requestAnimationFrame(() => {\n        wrapper.style.transition = \"transform 0.5s cubic-bezier(0.25, 0.1, 0.25, 1)\";\n      });\n    });\n  }, 500);\n}\n",[64,1337,1338,1352,1362,1372,1376,1386,1391,1409,1439,1444,1455,1474,1479,1483,1491],{"__ignoreMap":135},[139,1339,1340,1342,1344,1346,1348,1350],{"class":141,"line":142},[139,1341,1024],{"class":1023},[139,1343,1027],{"class":145},[139,1345,1031],{"class":1030},[139,1347,1035],{"class":1034},[139,1349,1038],{"class":1030},[139,1351,1041],{"class":145},[139,1353,1354,1356,1358,1360],{"class":141,"line":3},[139,1355,1046],{"class":267},[139,1357,1049],{"class":145},[139,1359,1052],{"class":1023},[139,1361,1055],{"class":145},[139,1363,1364,1366,1368,1370],{"class":141,"line":158},[139,1365,1086],{"class":1030},[139,1367,1075],{"class":1034},[139,1369,1091],{"class":453},[139,1371,1081],{"class":145},[139,1373,1374],{"class":141,"line":174},[139,1375,517],{"emptyLinePlaceholder":516},[139,1377,1378,1380,1382,1384],{"class":141,"line":185},[139,1379,1141],{"class":267},[139,1381,1049],{"class":145},[139,1383,1052],{"class":1023},[139,1385,1055],{"class":145},[139,1387,1388],{"class":141,"line":191},[139,1389,1390],{"class":444},"      // 第一帧\n",[139,1392,1393,1395,1397,1399,1401,1403,1405,1407],{"class":141,"line":328},[139,1394,1152],{"class":1060},[139,1396,1064],{"class":145},[139,1398,926],{"class":1067},[139,1400,1064],{"class":145},[139,1402,1072],{"class":151},[139,1404,1075],{"class":1034},[139,1406,1078],{"class":167},[139,1408,1081],{"class":145},[139,1410,1411,1413,1415,1417,1419,1421,1423,1425,1427,1429,1431,1433,1435,1437],{"class":141,"line":334},[139,1412,1152],{"class":1060},[139,1414,1064],{"class":145},[139,1416,926],{"class":1067},[139,1418,1064],{"class":145},[139,1420,1106],{"class":151},[139,1422,1075],{"class":1034},[139,1424,1111],{"class":167},[139,1426,1115],{"class":1114},[139,1428,1118],{"class":1030},[139,1430,1121],{"class":1034},[139,1432,1124],{"class":1030},[139,1434,1127],{"class":1114},[139,1436,1130],{"class":167},[139,1438,1081],{"class":145},[139,1440,1441],{"class":141,"line":340},[139,1442,1443],{"class":444},"      // 第二帧\n",[139,1445,1446,1449,1451,1453],{"class":141,"line":346},[139,1447,1448],{"class":267},"      requestAnimationFrame",[139,1450,1049],{"class":145},[139,1452,1052],{"class":1023},[139,1454,1055],{"class":145},[139,1456,1457,1460,1462,1464,1466,1468,1470,1472],{"class":141,"line":352},[139,1458,1459],{"class":1060},"        wrapper",[139,1461,1064],{"class":145},[139,1463,926],{"class":1067},[139,1465,1064],{"class":145},[139,1467,1072],{"class":151},[139,1469,1075],{"class":1034},[139,1471,1165],{"class":167},[139,1473,1081],{"class":145},[139,1475,1476],{"class":141,"line":358},[139,1477,1478],{"class":145},"      });\n",[139,1480,1481],{"class":141,"line":364},[139,1482,1172],{"class":145},[139,1484,1485,1487,1489],{"class":141,"line":370},[139,1486,1177],{"class":145},[139,1488,1180],{"class":453},[139,1490,1183],{"class":145},[139,1492,1493],{"class":141,"line":376},[139,1494,194],{"class":145},[101,1496,1497],{},"总之，我们需要杜绝浏览器将设置 transform 偏移值（瞬移列表位置）与恢复 transition 动画两件事合并到同一帧里去，而两层嵌套的 requestAnimationFrame 方法能很好的解决这个问题",[976,1499],{"src":1500,"width":978,"height":979,"allowFullScreen":516,"loading":980},"https://static.031130.xyz/demo/scroll-jump-bug-fixed.html",[19,1502,1504],{"id":1503},"驯服量子态前端开发者的新技能","驯服量子态：前端开发者的新技能",[101,1506,1507,1508,1511],{},"就这样，通过使用两层",[64,1509,1510],{},"requestAnimationFrame","，我们成功驯服了这个\"量子态\"的bug。现在无论是否打开F12，它都会乖乖地按照我们的预期滚动，不再玩消失的把戏。",[101,1513,1514,1515,1519,1520,1522],{},"看来，在前端的世界里，我们不仅要懂JavaScript，",[1516,1517,1518],"del",{},"还得懂点量子力学","。下次再遇到这种\"一观测就消失\"的bug，不妨试试这个\"量子纠缠解决方案\"——双重",[64,1521,1510],{},"，没准就能让bug从\"量子态\"坍缩成\"稳定态\"呢！",[101,1524,1525],{},"当然，如果你有更神奇的 debug 经历，欢迎分享你的经历——毕竟，在代码的宇宙里，我们永远不知道下一个bug会以怎样的形态出现。也许，这就是编程的乐趣（？）所在吧！",[205,1527,1528],{},[101,1529,1530],{},"本文由 ChatGPT 与 DeepSeek 协助撰写，但 bug 是真人真事（泪）。",[19,1532,816],{"id":816},[23,1534,1535,1542,1549],{},[26,1536,1537],{},[44,1538,1541],{"href":1539,"rel":1540},"https://zh.wikipedia.org/wiki/%E8%A7%82%E6%B5%8B%E8%80%85%E6%95%88%E5%BA%94",[48],"观测者效应 - 维基百科，自由的百科全书",[26,1543,1544],{},[44,1545,1548],{"href":1546,"rel":1547},"https://developer.mozilla.org/zh-CN/docs/Web/API/Window/requestAnimationFrame",[48],"Window：requestAnimationFrame() 方法 - Web API | MDN",[26,1550,1551],{},[44,1552,1555],{"href":1553,"rel":1554},"https://www.ruanyifeng.com/blog/2015/09/web-page-performance-in-depth.html",[48],"网页性能管理详解 - 阮一峰的网络日志",[926,1557,1558],{},"html pre.shiki code .sLKXg, html code.shiki .sLKXg{--shiki-default:#A626A4;--shiki-dark:#C678DD}html pre.shiki code .s5ixo, html code.shiki .s5ixo{--shiki-default:#383A42;--shiki-dark:#ABB2BF}html pre.shiki code .sz0mV, html code.shiki .sz0mV{--shiki-default:#383A42;--shiki-dark:#E06C75}html pre.shiki code .s_Sar, html code.shiki .s_Sar{--shiki-default:#0184BC;--shiki-dark:#56B6C2}html pre.shiki code .sAdtL, html code.shiki .sAdtL{--shiki-default:#4078F2;--shiki-dark:#61AFEF}html pre.shiki code .s7GmK, html code.shiki .s7GmK{--shiki-default:#383A42;--shiki-dark:#E5C07B}html pre.shiki code .s2QsP, html code.shiki .s2QsP{--shiki-default:#E45649;--shiki-dark:#E5C07B}html pre.shiki code .sJa8x, html code.shiki .sJa8x{--shiki-default:#E45649;--shiki-dark:#E06C75}html pre.shiki code .sDhpE, html code.shiki .sDhpE{--shiki-default:#50A14F;--shiki-dark:#98C379}html pre.shiki code .sAGMh, html code.shiki .sAGMh{--shiki-default:#986801;--shiki-dark:#D19A66}html pre.shiki code .sAOjX, html code.shiki .sAOjX{--shiki-default:#CA1243;--shiki-dark:#C678DD}html .default .shiki span {color: var(--shiki-default);background: var(--shiki-default-bg);font-style: var(--shiki-default-font-style);font-weight: var(--shiki-default-font-weight);text-decoration: var(--shiki-default-text-decoration);}html .shiki span {color: var(--shiki-default);background: var(--shiki-default-bg);font-style: var(--shiki-default-font-style);font-weight: var(--shiki-default-font-weight);text-decoration: var(--shiki-default-text-decoration);}html .dark .shiki span {color: var(--shiki-dark);background: var(--shiki-dark-bg);font-style: var(--shiki-dark-font-style);font-weight: var(--shiki-dark-font-weight);text-decoration: var(--shiki-dark-text-decoration);}html.dark .shiki span {color: var(--shiki-dark);background: var(--shiki-dark-bg);font-style: var(--shiki-dark-font-style);font-weight: var(--shiki-dark-font-weight);text-decoration: var(--shiki-dark-text-decoration);}html pre.shiki code .sW2Sy, html code.shiki .sW2Sy{--shiki-default:#A0A1A7;--shiki-default-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic}",{"title":135,"searchDepth":3,"depth":3,"links":1560},[1561,1562,1563,1564,1565],{"id":962,"depth":3,"text":963},{"id":1007,"depth":3,"text":1008},{"id":1245,"depth":3,"text":1246},{"id":1503,"depth":3,"text":1504},{"id":816,"depth":3,"text":816},{"title":1567,"date":1568,"path":1569,"tags":1570,"body":1572},"2025 年，如何为 web 页面上展示的视频选择合适的压缩算法？","2025-06-02 20:59:10","/2025/06/02/choosing-the-right-video-compression-format-for-web-in-2025",[956,10,1571],"Network",{"type":16,"value":1573,"toc":2267},[1574,1577,1581,1585,1588,1593,1598,1604,1610,1613,1618,1622,1625,1632,1635,1641,1645,1655,1660,1663,1666,1669,1673,1676,1683,1686,1689,1692,1695,1698,1935,1939,1942,1948,1955,1959,1970,2063,2069,2072,2076,2083,2089,2095,2099,2102,2108,2111,2114,2117,2120,2129,2131,2264],[101,1575,1576],{},"事情的起因是需要在网页上展示一个时长约为 5 分钟的产品展示视频，拿到的 H264 编码的原文件有 60MB 大。高达 1646 Kbps 码率的视频文件通过网络传输，烧 cdn 流量费用不说，对于弱网环境下的用户体验也绝对不会好。因此必须在兼顾浏览器兼容性（太好了不用管 IE）的情况下，使用更现代的视频压缩算法进行压缩。",[19,1578,1580],{"id":1579},"哪些压缩算法是目前的主流","哪些压缩算法是目前的主流？",[96,1582,1584],{"id":1583},"av1","AV1",[101,1586,1587],{},"AV1 作为目前压缩效率最高的主流视频编码格式，在 2025 年的今天已经在 YouTube、Netflix、Bilibili 等视频网站全面铺开，毫无疑问是最值得优先考虑的选择；除了优异的压缩效率以外，AV1 免版税的优势使得各硬件厂商和浏览器内核开发者可以无所顾忌的将 AV1 编码的支持添加到自己的产品中。",[101,1589,1590],{},[984,1591],{"alt":135,"src":1592},"https://static.031130.xyz/uploads/2025/06/02/aec1af1718064.webp",[101,1594,1595],{},[984,1596],{"alt":135,"src":1597},"https://static.031130.xyz/uploads/2025/06/02/76a312b5a668b.webp",[101,1599,1600,1601],{},"可惜的是，Safari 并没有对 AV1 编码添加软解支持，只有在搭载 Apple M3 及后续生产的 Mac 和 iPhone 15 Pro 后续的机型才拥有硬解 AV1 的能力，在此之前生产的产品均无法使用 Safari 播放 AV1 编码的视频。",[1516,1602,1603],{},"我宣布 Safari 已经成为当代 IE，妥妥阻碍 Web 发展的绊脚石",[101,1605,1606],{},[984,1607],{"alt":1608,"src":1609},"Safari 在搭载 M2Pro 处理器的 Macbook Pro 上直接罢工了","https://static.031130.xyz/uploads/2025/06/02/01ddcc3948406.webp",[101,1611,1612],{},"除此之外，AV1 在压制视频时对设备的要求较高。在桌面端的消费级显卡中，目前只有 NVIDIA RTX 40 系、AMD Radeon RX 7000 系、IntelArc A380 及后续的产品拥有 AV1 的编码（encode）支持。而 Apple M 系列芯片至今没有任何一款产品拥有对 AV1 编码的硬件支持。这也导致我在我搭载 Intel Core i7-1165G7 的 ThinkPad 上使用 AV1 编码压缩视频时被迫使用 libaom-av1 进行软件编码，1080p 的视频压缩效率为 0.0025x 的速率，五分钟的视频要压一天多的时间。",[101,1614,1615],{},[984,1616],{"alt":135,"src":1617},"https://static.031130.xyz/uploads/2025/06/02/923ca02e1d835.webp",[96,1619,1621],{"id":1620},"h265-hevc","H.265 / HEVC",[101,1623,1624],{},"作为 H.264 / AVC 的下一代继任者，H.265（又称 HEVC）的表现可谓是一手好牌打得稀巴烂。HEVC 由多个专利池（如 MPEG LA、HEVC Advance 和 Velos Media）管理，授权费用高且分散，昂贵的专利授权费用严重限制了它的普及速度和范围，尤其是在开放生态和网页端应用中。",[101,1626,1627,1628,1631],{},"Chromium / Firefox 不愿意当承担专利授权费的冤大头，拒绝在当今世界最大的两个开源浏览器内核中添加默认的 H.265 软解支持，目前主流浏览器普遍采用",[210,1629,1630],{},"能硬解就硬解，硬解不了就摆烂","的支持策略。Firefox on Linux 倒是另辟蹊径，不仅会尝试使用硬解，还会尝试使用用户在电脑上装的 ffmpeg 软解曲线救国。不过好在毕竟是 2013 年就确定的标准，现在大部分硬件厂商都集体被摁着脖子交了专利授权费以保证产品竞争力，Apple 更是 HEVC 的一等公民，保证了全系产品的 HEVC 解码能力。",[101,1633,1634],{},"目前未覆盖到的场景主要是 Chromium / Firefox on Windows 7 和 Chromium on Linux（包括 UOS、麒麟等一众国产 Linux 发行版）。",[101,1636,1637],{},[984,1638],{"alt":1639,"src":1640},"在 Linux 上不支持硬解 H.265 的 Chrome 直接把视频当作音频播放了","https://static.031130.xyz/uploads/2025/06/02/2e8e5100f645a.webp",[96,1642,1644],{"id":1643},"vp9","VP9",[101,1646,1647,1648,1651,1652],{},"VP9 是 Google 于 2013 年推出的视频编码格式，作为 H.264 的继任者之一，在压缩效率上接近 H.265（HEVC），但最大的杀手锏是——",[210,1649,1650],{},"彻底免专利费","。这也让 VP9 成为 Google 对 HEVC 高额授权费用的掀桌式回应：",[210,1653,1654],{},"你们慢慢吃，我开一桌免费的。",[101,1656,1657],{},[984,1658],{"alt":135,"src":1659},"https://static.031130.xyz/uploads/2025/06/03/a9b473a3bd120.webp",[101,1661,1662],{},"借着免专利的东风和 Google 自家产品矩阵的强推，VP9 在 YouTube、WebRTC 乃至 Chrome 浏览器中迅速站稳了脚跟。特别是在 AV1 普及之前，VP9 几乎是网页视频播放领域的事实标准，甚至逼得苹果这个“编解码俱乐部元老”在 macOS 11 Big Sur 和 iOS 14 上的 Safari 破天荒地加入了 VP9 支持（尽管 VP9 in webm 的支持稍晚一些，具体见上表）。",[101,1664,1665],{},"VP9 的软解码支持基本无死角：Chromium、Firefox、Edge 都原生支持，Safari 也一反常态地“从了”。硬件解码方面，从 Intel Skylake（第六代酷睿）开始，NVIDIA GTX 950 及以上、AMD Vega 和 RDNA 系显卡基本都具备完整的 VP9 解码能力——总之，只要不是博物馆级别的老电脑，就能愉快播放 VP9 视频。",[101,1667,1668],{},"当然，编码仍是 VP9 的短板。Google 官方提供的开源实现 libvpx，速度比不上 x264/x265 等老牌选手，在缺乏硬件加速的场景下，仍然属于“关机前压一宿”的那种体验。不过相比 AV1 的 libaom-av1，VP9 至少还能算“可用”，适合轻量化应用、实时通信或是对压制速度敏感的用户，而早在 7 代 Intel 的 Kaby Lake 系列产品就已经引入了 VP9 的硬件编码支持，各家硬件厂商对 VP9 硬件编码的支持发展到今天还算不错。",[96,1670,1672],{"id":1671},"h264-avc","H.264 / AVC",[101,1674,1675],{},"作为“老将出马一个顶俩”的代表，H.264 / AVC 无疑是过去二十年视频编码领域的霸主。自 2003 年标准确定以来，凭借良好的压缩效率、广泛的硬件支持和相对合理的专利授权策略，H.264 迅速成为从网络视频、蓝光光盘到直播、监控乃至手机录像的默认选择。如果你打开一个视频网站的视频流、下载一个在线视频、剪辑一个 vlog，大概率都绕不开 H.264 的身影。",[101,1677,1678,1679,1682],{},"H.264 的最大优势在于——",[210,1680,1681],{},"兼容性无敌","。不夸张地说，只要是带屏幕的设备，就能播放 H.264 视频。软解？早在十几年前的浏览器和媒体播放器中就已普及；硬解？从 Intel Sandy Bridge、NVIDIA Fermi、AMD VLIW4 这些“史前”架构开始就已加入对 H.264 的完整支持——你甚至可以在树莓派、智能冰箱上流畅播放 H.264 视频。",[101,1684,1685],{},"虽然 H.264 同样存在和 H.265 相同的专利问题，但其授权策略明显更温和——MPEG LA 提供的专利池授权门槛较低，且不向免费网络视频收取费用，使得包括 Chromium、Firefox 在内的浏览器都默认集成了 H.264 的软解功能。Apple 和 Microsoft 更是早早将其作为视频编码和解码的第一公民，Safari 和 Edge 天生支持 H.264，不存在任何兼容性烦恼。",[101,1687,1688],{},"当然，作为一项 20 多年前的技术，H.264 在压缩效率上已经明显落后于 VP9、HEVC 和 AV1。相同画质下，H.264 的码率要比 AV1 高出 30～50%，在追求极致带宽利用或存储节省的应用场景中就显得有些力不从心。然而在今天这个“能播比好看更重要”的现实环境中，H.264 依然是默认方案，是“稳健老哥”的代名词。",[101,1690,1691],{},"所以，即便 AV1、HEVC、VP9 各有亮点，H.264 依旧凭借“老、稳、全”三大核心竞争力，在 2025 年依然牢牢占据着视频生态链的中枢地位——只要这个世界还有浏览器不支持 AV1（可恶的 Safari 不支持软解），服务器不想烧钱转码视频，或用户设备太老，H.264 就不会退场。",[96,1693,1694],{"id":1694},"小结",[101,1696,1697],{},"在视频编码方面，浏览器不再是那个能靠一己之力抹平硬件和系统差异的超人，所以总有一些特殊情况是表格中无法涵盖的。",[1699,1700,1701,1726],"table",{},[1702,1703,1704],"thead",{},[1705,1706,1707,1711,1714,1717,1720,1723],"tr",{},[1708,1709,1710],"th",{},"编解码器",[1708,1712,1713],{},"压缩效率",[1708,1715,1716],{},"浏览器",[1708,1718,1719],{},"桌面端支持",[1708,1721,1722],{},"移动端支持",[1708,1724,1725],{},"备注",[1727,1728,1729,1748,1765,1788,1809,1826,1843,1859,1873,1890,1907,1921],"tbody",{},[1705,1730,1731,1734,1737,1740,1743,1745],{},[1732,1733,1584],"td",{},[1732,1735,1736],{},"★★★",[1732,1738,1739],{},"Chrome / Chromium",[1732,1741,1742],{},"是 (v70+，发布于 2018 年 10 月)",[1732,1744,1742],{},[1732,1746,1747],{},"硬解优先，软解后备",[1705,1749,1750,1752,1754,1757,1760,1763],{},[1732,1751],{},[1732,1753],{},[1732,1755,1756],{},"Firefox",[1732,1758,1759],{},"是 (v67+，发布于 2019 年 5 月)",[1732,1761,1762],{},"是 (v113+，发布于 2023 年 5 月)",[1732,1764,1747],{},[1705,1766,1767,1769,1771,1774,1777,1779],{},[1732,1768],{},[1732,1770],{},[1732,1772,1773],{},"Safari",[1732,1775,1776],{},"不完全支持 (仅近两年的产品支持)",[1732,1778,1776],{},[1732,1780,1781,1784,1785],{},[210,1782,1783],{},"仅支持硬解"," (M3, A17 Pro 系芯片后开始支持)，",[210,1786,1787],{},"无软解支持",[1705,1789,1790,1793,1796,1798,1801,1803],{},[1732,1791,1792],{},"HEVC (H.265)",[1732,1794,1795],{},"★★☆",[1732,1797,1739],{},[1732,1799,1800],{},"不完全支持",[1732,1802,1800],{},[1732,1804,1805,1808],{},[210,1806,1807],{},"仅支持硬解，无软解支持","（Windows 可从微软商店安装付费的软解插件）",[1705,1810,1811,1813,1815,1817,1819,1821],{},[1732,1812],{},[1732,1814],{},[1732,1816,1756],{},[1732,1818,1800],{},[1732,1820,1800],{},[1732,1822,1823,1825],{},[210,1824,1807],{},"（Linux 可依赖系统 ffmpeg 实现软解）",[1705,1827,1828,1830,1832,1834,1837,1840],{},[1732,1829],{},[1732,1831],{},[1732,1833,1773],{},[1732,1835,1836],{},"近期设备全部支持 (macOS High Sierra+，发布于 2017 年 6 月)",[1732,1838,1839],{},"近期设备全部支持 (iOS 11+，发布于 2017 年 10 月)",[1732,1841,1842],{},"苹果是 H.265 一等公民",[1705,1844,1845,1847,1849,1851,1854,1856],{},[1732,1846,1644],{},[1732,1848,1795],{},[1732,1850,1739],{},[1732,1852,1853],{},"是",[1732,1855,1853],{},[1732,1857,1858],{},"支持良好",[1705,1860,1861,1863,1865,1867,1869,1871],{},[1732,1862],{},[1732,1864],{},[1732,1866,1756],{},[1732,1868,1853],{},[1732,1870,1853],{},[1732,1872,1858],{},[1705,1874,1875,1877,1879,1881,1884,1887],{},[1732,1876],{},[1732,1878],{},[1732,1880,1773],{},[1732,1882,1883],{},"是 (v14.1+，发布于 2021 年 4 月)",[1732,1885,1886],{},"是 (iOS 17.4+，发布于 2024 年 3 月)",[1732,1888,1889],{},"支持稍晚（此处指兼容 vp9 的 webm 时间，vp9 in WebRTC 的兼容时间更早）",[1705,1891,1892,1895,1898,1900,1902,1904],{},[1732,1893,1894],{},"H.264 (AVC)",[1732,1896,1897],{},"★☆☆",[1732,1899,1739],{},[1732,1901,1853],{},[1732,1903,1853],{},[1732,1905,1906],{},"通用",[1705,1908,1909,1911,1913,1915,1917,1919],{},[1732,1910],{},[1732,1912],{},[1732,1914,1756],{},[1732,1916,1853],{},[1732,1918,1853],{},[1732,1920,1906],{},[1705,1922,1923,1925,1927,1929,1931,1933],{},[1732,1924],{},[1732,1926],{},[1732,1928,1773],{},[1732,1930,1853],{},[1732,1932,1853],{},[1732,1934,1906],{},[19,1936,1938],{"id":1937},"怎么选","怎么选？",[101,1940,1941],{},"我们不是专业的视频托管平台，不像 YouTube、Bilibili 那样专业到可以向用户提供多种分辨率、压缩算法的选择。",[101,1943,1944],{},[984,1945],{"alt":1946,"src":1947},"Bilibili 为用户提供了三种压缩算法的视频源","https://static.031130.xyz/uploads/2025/06/03/096484dbc0f3a.webp",[101,1949,1950,1951,1954],{},"最终的选择策略，必须在",[210,1952,1953],{},"压缩效率、播放兼容性、编码耗时","等维度之间做出权衡。",[96,1956,1958],{"id":1957},"选择一av1-挑大梁h264-保兼容","选择一：AV1 挑大梁，H.264 保兼容",[101,1960,1961,1962,1965,1966,1969],{},"现代浏览器支持在 ",[64,1963,1964],{},"\u003Cvideo>"," 标签中使用 ",[64,1967,1968],{},"\u003Csource>"," 标签和 MIME type 让浏览器按需播放",[130,1971,1975],{"className":1972,"code":1973,"language":1974,"meta":135,"style":135},"language-html shiki shiki-themes one-light one-dark-pro","\u003Cvideo controls poster=\"preview.jpg\">\n  \u003Csource src=\"video.av1.webm\" type='video/webm; codecs=\"av01\"' />\n  \u003Csource src=\"video.h264.mp4\" type='video/mp4' />\n  当前浏览器不支持视频播放\n\u003C/video>\n","html",[64,1976,1977,2000,2027,2049,2054],{"__ignoreMap":135},[139,1978,1979,1982,1985,1988,1991,1994,1997],{"class":141,"line":142},[139,1980,1981],{"class":145},"\u003C",[139,1983,1984],{"class":151},"video",[139,1986,1987],{"class":453}," controls",[139,1989,1990],{"class":453}," poster",[139,1992,1993],{"class":145},"=",[139,1995,1996],{"class":167},"\"preview.jpg\"",[139,1998,1999],{"class":145},">\n",[139,2001,2002,2005,2008,2011,2013,2016,2019,2021,2024],{"class":141,"line":3},[139,2003,2004],{"class":145},"  \u003C",[139,2006,2007],{"class":151},"source",[139,2009,2010],{"class":453}," src",[139,2012,1993],{"class":145},[139,2014,2015],{"class":167},"\"video.av1.webm\"",[139,2017,2018],{"class":453}," type",[139,2020,1993],{"class":145},[139,2022,2023],{"class":167},"'video/webm; codecs=\"av01\"'",[139,2025,2026],{"class":145}," />\n",[139,2028,2029,2031,2033,2035,2037,2040,2042,2044,2047],{"class":141,"line":158},[139,2030,2004],{"class":145},[139,2032,2007],{"class":151},[139,2034,2010],{"class":453},[139,2036,1993],{"class":145},[139,2038,2039],{"class":167},"\"video.h264.mp4\"",[139,2041,2018],{"class":453},[139,2043,1993],{"class":145},[139,2045,2046],{"class":167},"'video/mp4'",[139,2048,2026],{"class":145},[139,2050,2051],{"class":141,"line":174},[139,2052,2053],{"class":145},"  当前浏览器不支持视频播放\n",[139,2055,2056,2059,2061],{"class":141,"line":185},[139,2057,2058],{"class":145},"\u003C/",[139,2060,1984],{"class":151},[139,2062,1999],{"class":145},[101,2064,2065,2066,2068],{},"通过这样的写法，浏览器会自动选择最先能解码的 ",[64,2067,2007],{},"，无需写复杂的判断逻辑或使用 JavaScript 动态切换。默认的 AV1 编码在最大程度上减少了传输流量降低成本，享受现代浏览器与设备的压缩红利；而 H.264 则作为兜底方案，保证了在不支持 AV1 的 Safari 等老旧设备上的回放兼容性。",[101,2070,2071],{},"然而这个选择可能并不是太合适，一方面我手上最先进的处理器 Apple M4 并不支持硬件编码 AV1 视频，5 分钟的视频压完需要整整 3 个小时，如果还需要视压缩质量来回调整压缩参数重新压上几次，那可真是遭老罪了；另一方面，即使 Chromium / Firefox 等主流浏览器内核现在都支持 AV1 的软解，但在一些硬件较老的设备上播放 AV1 编码的视频可能让用户的电脑风扇原地起飞，这一点在 YouTube 大力推广 AV1 的时候就曾遭到不少用户的诟病。",[96,2073,2075],{"id":2074},"选择二vp9-独挑大梁","选择二：VP9 独挑大梁",[101,2077,2078,2079,2082],{},"考虑到 AV1 编码的高昂成本和",[1516,2080,2081],{},"用户电脑风扇原地起飞的风险","，VP9 也是一个非常具有竞争力的选择。VP9 在主流浏览器中得到了非常好的兼容，因此可以考虑放弃 H.264 的 fallback 方案独挑大梁。而 VP9 硬件编码在近几年的硬件设备上的普遍支持也给足了我勇气，让我可以多次调整压缩质量重新压缩，找一个在文件体积和画面清晰度之间的 sweet point。",[101,2084,2085],{},[2086,2087,2088],"em",{},"由于是 VP9 独挑大梁，因此大多数人可能会考虑使用与 VP9 最为适配的 webm 格式封装视频。但目前在 webm 中最广泛使用的音频编码 opus 在 Safari 上的兼容性并不是太好（在 2024 年 3 月发布的 Safari 17.4 才开始支持），建议斟酌一下是不是继续用回 AAC 编码，并将视频封装在 mp4 中。",[101,2090,2091],{},[984,2092],{"alt":2093,"src":2094},"https://caniuse.com/opus","https://static.031130.xyz/uploads/2025/06/03/ec3b5dbcbcc29.webp",[19,2096,2098],{"id":2097},"音频码率太高再砍一刀","音频码率太高？再砍一刀",[101,2100,2101],{},"上面说了那么多的视频压缩算法，其实只是局限于视频画面的压缩，音频这一块其实还能再压一点出来。",[130,2103,2106],{"className":2104,"code":2105,"language":669},[667],"Stream #0:1[0x2](und): Audio: aac (LC) (mp4a / 0x6134706D), 48000 Hz, stereo, fltp, 128 kb/s (default)\n",[64,2107,2105],{"__ignoreMap":135},[101,2109,2110],{},"一个介绍产品的视频，在音频部分采用了 48000 Hz 双声道采样，码率高达 128 kbps，说实话有点奢侈。我直接砍成 64 kbps 单声道，又省下 2MB 的文件大小。",[19,2112,2113],{"id":2113},"写在最后",[101,2115,2116],{},"对于前端开发者来说，视频压缩算法的选择早已不是单纯的“压得小不小”问题，而是一场在设备能力、浏览器兼容性、用户体验与开发成本之间的博弈。我们既要跟上技术演进的节奏，拥抱 AV1、VP9 等更高效的编解码器，也要在实际项目中照顾到现实中的设备分布和播放环境。",[101,2118,2119],{},"在理想与落地之间，我们所能做的，就是充分利用 HTML5 提供的容错机制，搭配好合适的编码策略和封装格式，让网页上的每一段视频都能在合适的设备上、以合理的代价播放出来。",[101,2121,2122,2123,2125,2126,2128],{},"毕竟，Web 从来不缺“能不能做”，缺的是“做得优雅”。如果说编码器是硬件工程师和视频平台的战场，那 ",[64,2124,1964],{}," 标签下的这几行 ",[64,2127,1968],{},"，才是属于我们前端工程师的战壕。",[19,2130,816],{"id":816},[23,2132,2133,2140,2147,2154,2161,2168,2175,2182,2188,2195,2202,2209,2216,2223,2230,2237,2247,2254,2261],{},[26,2134,2135],{},[44,2136,2139],{"href":2137,"rel":2138},"https://developer.mozilla.org/zh-CN/docs/Web/Media/Guides/Formats/Video_codecs",[48],"网页视频编码指南 - Web 媒体技术 | MDN",[26,2141,2142],{},[44,2143,2146],{"href":2144,"rel":2145},"https://research.netflix.com/research-area/video-encoding-and-quality",[48],"Encoding & Quality - Netflix Research",[26,2148,2149],{},[44,2150,2153],{"href":2151,"rel":2152},"https://optiview.dolby.com/resources/blog/playback/how-the-vp9-codec-supports-now-streaming-to-apple-devices-more/",[48],"How the VP9 Codec Supports Now Streaming to Apple Devices & More | dolby.io",[26,2155,2156],{},[44,2157,2160],{"href":2158,"rel":2159},"https://www.chromium.org/audio-video/",[48],"Audio/Video | The Chromium Project",[26,2162,2163],{},[44,2164,2167],{"href":2165,"rel":2166},"https://caniuse.com/av1",[48],"AV1 video format | Can I use... Support tables for HTML5, CSS3, etc",[26,2169,2170],{},[44,2171,2174],{"href":2172,"rel":2173},"https://caniuse.com/webm",[48],"WebM video format | Can I use... Support tables for HTML5, CSS3, etc",[26,2176,2177],{},[44,2178,2181],{"href":2179,"rel":2180},"https://caniuse.com/hevc",[48],"HEVC/H.265 video format | Can I use... Support tables for HTML5, CSS3, etc",[26,2183,2184],{},[44,2185,2187],{"href":2093,"rel":2186},[48],"Opus audio format | Can I use... Support tables for HTML5, CSS3, etc",[26,2189,2190],{},[44,2191,2194],{"href":2192,"rel":2193},"https://caniuse.com/mpeg4",[48],"MPEG-4/H.264 video format | Can I use... Support tables for HTML5, CSS3, etc",[26,2196,2197],{},[44,2198,2201],{"href":2199,"rel":2200},"https://en.wikipedia.org/wiki/AV1",[48],"AV1 - Wikipedia",[26,2203,2204],{},[44,2205,2208],{"href":2206,"rel":2207},"https://en.wikipedia.org/wiki/High_Efficiency_Video_Coding",[48],"High Efficiency Video Coding - Wikipedia",[26,2210,2211],{},[44,2212,2215],{"href":2213,"rel":2214},"https://en.wikipedia.org/wiki/VP9",[48],"VP9 - Wikipedia",[26,2217,2218],{},[44,2219,2222],{"href":2220,"rel":2221},"https://en.wikipedia.org/wiki/Advanced_Video_Coding",[48],"Advanced Video Coding - Wikipedia",[26,2224,2225],{},[44,2226,2229],{"href":2227,"rel":2228},"https://www.intel.com/content/www/us/en/developer/articles/technical/encode-and-decode-capabilities-for-7th-generation-intel-core-processors-and-newer.html",[48],"Encode and Decode Capabilities for 7th Generation Intel® Core™...",[26,2231,2232],{},[44,2233,2236],{"href":2234,"rel":2235},"https://zh.wikipedia.org/zh-cn/MacOS_High_Sierra",[48],"macOS High Sierra - 维基百科，自由的百科全书",[26,2238,2239],{},[44,2240,2243,2244],{"href":2241,"rel":2242},"https://www.androidpolice.com/2018/10/17/chrome-70-adds-av1-video-support-improves-pwas-windows-apk-download/",[48],"Chrome 70 adds AV1 video support, improves PWAs on Windows, and more ",[139,2245,2246],{},"APK Download",[26,2248,2249],{},[44,2250,2253],{"href":2251,"rel":2252},"https://www.mozilla.org/en-US/firefox/android/113.0/releasenotes/",[48],"Firefox for Android 113.0, See All New Features, Updates and Fixes",[26,2255,2256],{},[44,2257,2260],{"href":2258,"rel":2259},"https://www.bilibili.com/video/BV1nW4y1V7kR/",[48],"视频网站的“蓝光”是怎么骗你的？——视频画质全解析【柴知道】_哔哩哔哩_bilibili",[26,2262,2263],{},"《4K 清晰度不如4年前，视频变糊是你的错觉吗》- 原视频已 404",[926,2265,2266],{},"html pre.shiki code .s5ixo, html code.shiki .s5ixo{--shiki-default:#383A42;--shiki-dark:#ABB2BF}html pre.shiki code .sJa8x, html code.shiki .sJa8x{--shiki-default:#E45649;--shiki-dark:#E06C75}html pre.shiki code .sAGMh, html code.shiki .sAGMh{--shiki-default:#986801;--shiki-dark:#D19A66}html pre.shiki code .sDhpE, html code.shiki .sDhpE{--shiki-default:#50A14F;--shiki-dark:#98C379}html .default .shiki span {color: var(--shiki-default);background: var(--shiki-default-bg);font-style: var(--shiki-default-font-style);font-weight: var(--shiki-default-font-weight);text-decoration: var(--shiki-default-text-decoration);}html .shiki span {color: var(--shiki-default);background: var(--shiki-default-bg);font-style: var(--shiki-default-font-style);font-weight: var(--shiki-default-font-weight);text-decoration: var(--shiki-default-text-decoration);}html .dark .shiki span {color: var(--shiki-dark);background: var(--shiki-dark-bg);font-style: var(--shiki-dark-font-style);font-weight: var(--shiki-dark-font-weight);text-decoration: var(--shiki-dark-text-decoration);}html.dark .shiki span {color: var(--shiki-dark);background: var(--shiki-dark-bg);font-style: var(--shiki-dark-font-style);font-weight: var(--shiki-dark-font-weight);text-decoration: var(--shiki-dark-text-decoration);}",{"title":135,"searchDepth":3,"depth":3,"links":2268},[2269,2276,2280,2281,2282],{"id":1579,"depth":3,"text":1580,"children":2270},[2271,2272,2273,2274,2275],{"id":1583,"depth":158,"text":1584},{"id":1620,"depth":158,"text":1621},{"id":1643,"depth":158,"text":1644},{"id":1671,"depth":158,"text":1672},{"id":1694,"depth":158,"text":1694},{"id":1937,"depth":3,"text":1938,"children":2277},[2278,2279],{"id":1957,"depth":158,"text":1958},{"id":2074,"depth":158,"text":2075},{"id":2097,"depth":3,"text":2098},{"id":2113,"depth":3,"text":2113},{"id":816,"depth":3,"text":816},{"title":2284,"date":2285,"path":2286,"tags":2287,"body":2288},"el-image 和 el-table 怎么就打架了？Stacking Context 是什么？","2025-05-31 00:29:40","/2025/05/31/el-image-and-el-table-why-the-fight-and-what-is-a-stacking-context",[11,14,13,956,10],{"type":16,"value":2289,"toc":2505},[2290,2293,2299,2306,2308,2311,2316,2319,2324,2361,2364,2368,2371,2374,2386,2389,2393,2396,2425,2429,2433,2436,2439,2442,2445,2456,2463,2465,2502],[101,2291,2292],{},"这是精弘内部的图床开发时遇到的事情，大一的小朋友反馈说 el-image 和 el-table 打架了。",[101,2294,2295],{},[984,2296],{"alt":2297,"src":2298},"截图","https://static.031130.xyz/uploads/2025/05/31/c6674f6f13955.webp",[101,2300,2301,2305],{},[44,2302,974],{"href":2303,"rel":2304},"https://static.031130.xyz/demo/el-image-el-table-conflict.html",[48]," 的 iframe 引入",[976,2307],{"src":2303,"width":978,"height":979,"allowFullScreen":516,"loading":980},[101,2309,2310],{},"看到后面的表格透出 el-image 的预览层，我的第一反应是叫小朋友去检查 z-index 是否正确，el-image 的 mask 遮罩的 z-index 是否大于表格。",[101,2312,2313],{},[984,2314],{"alt":135,"src":2315},"https://static.031130.xyz/uploads/2025/05/31/1c20b4ea0b37e.webp",[101,2317,2318],{},"经过我本地调试，发现 z-index 的设置确实没问题，但后面的元素为什么会透出来？谷歌搜索一番，找到了这篇文章",[101,2320,2321],{},[984,2322],{"alt":135,"src":2323},"https://static.031130.xyz/uploads/2025/05/31/99845899e3524.webp",[205,2325,2326,2329],{},[101,2327,2328],{},"给 el-table 加一行如下代码即可",[130,2330,2334],{"className":2331,"code":2332,"language":2333,"meta":135,"style":135},"language-css shiki shiki-themes one-light one-dark-pro",".el-table__cell {\n    position: static !important;\n}\n","css",[64,2335,2336,2343,2357],{"__ignoreMap":135},[139,2337,2338,2341],{"class":141,"line":142},[139,2339,2340],{"class":453},".el-table__cell",[139,2342,1055],{"class":145},[139,2344,2345,2348,2352,2355],{"class":141,"line":3},[139,2346,2347],{"class":145},"    position: ",[139,2349,2351],{"class":2350},"sYebD","static",[139,2353,2354],{"class":1023}," !important",[139,2356,1081],{"class":145},[139,2358,2359],{"class":141,"line":158},[139,2360,194],{"class":145},[101,2362,2363],{},"经本地调试确认，这一方案确实能解决问题，但为什么呢？这就涉及到 Stacking Context （层叠上下文）了。",[19,2365,2367],{"id":2366},"stacking-context层叠上下文究竟是什么","Stacking Context（层叠上下文）究竟是什么？",[101,2369,2370],{},"简单来说，Stacking Context 可以被类比成画布。在同一块画布上，z-index 值越高的元素就处于越上方，会覆盖掉 z-index 较低的元素，这也是为什么我最开始让检查 z-index 的设置是否有问题。但问题出在 Stacking Context 也是有上下顺序之分的。",[101,2372,2373],{},"现在假设我们有 A、B 两块画布，在 A 上有一个设置了 z-index 为 1145141919810 的元素。那这个元素具备非常高的优先级，理应出现在浏览器窗口的最上方。但如果 B 画布的优先级高于 A 画布，那么 B 元素上的所有元素都会优先显示（当了躺赢狗）。那么画布靠什么来决定优先级呢？",[23,2375,2376,2381],{},[26,2377,2378],{},[210,2379,2380],{},"处于同级的 Stacking Context 之间靠 z-index 值来区分优先级",[26,2382,2383],{},[210,2384,2385],{},"对于 z-index 值相同的 Stacking Context，在 html 文档中位置靠后的元素拥有更高的优先级",[101,2387,2388],{},"第二条规则也能解释为什么在上面的 demo 中，只有在表格中位置排在图片元素后面的元素出现了透出来的情况。",[19,2390,2392],{"id":2391},"所以为什么-el-image-和-el-table-打架了","所以为什么 el-image 和 el-table 打架了？",[101,2394,2395],{},"这次的冲突主要是下面两个因素引起的",[595,2397,2398,2414],{},[26,2399,2400,2401,2404,2405,2407,2411,2413],{},"el-table 给每个 cell 都设置了 ",[64,2402,2403],{},"position: relative"," 的 css 属性，而 position 被设为 relative 时，当前元素就会生成一个 Stacking Context。",[623,2406],{},[984,2408],{"alt":2409,"src":2410},"image-20250531013029154","https://static.031130.xyz/uploads/2025/05/31/9df43b865b3c6.webp",[623,2412],{},"所以我们这么一个有十个格子的表格，其实就生成了十个画布。而这其中每个画布 z-index 都为 1。根据刚才的规则，在图片格子后面的那些格子对应的 html 代码片段在整体的 html 文档中更靠后，所以他们的优先级都高于图片格子。",[26,2415,2416,2417,2419,2422,2424],{},"el-image 的预览功能所展开的遮罩层处于 el-image 标签内部",[623,2418],{},[984,2420],{"alt":135,"src":2421},"https://static.031130.xyz/uploads/2025/05/31/f18a2b54afd63.webp",[623,2423],{},"上图中橙色部分是 el-image 在预览时提供的遮罩，可以看到 element-plus 组件的 image 预览的默认行为是将预览时所需要的遮罩层直接放在 \u003Cel-image> \u003C/el-image> 标签内部，这导致 el-image 的遮罩层被困在一个低优先级的 Stacking Context 中，后面的格子里的内容就是能凭借高优先级透过来。",[19,2426,2428],{"id":2427},"所以解决方案是什么","所以解决方案是什么？",[96,2430,2432],{"id":2431},"更改-position-值在这里确实是可行的","更改 position 值在这里确实是可行的",[101,2434,2435],{},"上面我谷歌搜到的将 el-table 中 cell 的 position 值强制设为 static 确实是有效的，因为 static 不会创建新的 Stacking Context，这样就不会有现在的问题。",[96,2437,2438],{"id":2438},"将需要出现在最顶层的代码放置在优先级最大的位置是更常见的方案",[101,2440,2441],{},"但别的组件库在处理这个需求时，一般会将预览时提供的遮罩的 html 代码片段直接插入到 body 标签内部的最尾部，并设置一个相对比较大的 z-index 值，以确保这个遮罩层能够获得最高的优先级，以此能出现在屏幕的最上方。（像一些 dialog 对话框、popover 悬浮框也都是这个原理）。",[101,2443,2444],{},"事实上，element-plus 组件库也提供了这个功能",[205,2446,2447],{},[101,2448,2449,2452,2453],{},[210,2450,2451],{},"preview-teleported:"," image-viewer 是否插入至 body 元素上。嵌套的父元素属性会发生修改时应该将此属性设置为 ",[64,2454,2455],{},"true",[101,2457,2458,2459,2462],{},"所以在使用 el-image 时传入一个 ",[64,2460,2461],{},":preview-teleported=\"true\""," 是一个更普适的方案，因为我们并不能确保 el-image 的父元素除了 el-table 的 cell 以外还有什么其他的父元素会创建新的 Stacking Context。",[19,2464,816],{"id":816},[23,2466,2467,2474,2481,2488,2495],{},[26,2468,2469],{},[44,2470,2473],{"href":2471,"rel":2472},"https://developer.mozilla.org/en-US/docs/Web/CSS/CSS_positioned_layout/Stacking_context",[48],"层叠上下文 - CSS：层叠样式表 | MDN",[26,2475,2476],{},[44,2477,2480],{"href":2478,"rel":2479},"https://juejin.cn/post/6844903667175260174",[48],"彻底搞懂CSS层叠上下文、层叠等级、层叠顺序、z-index最近，在项目中遇到一个关于CSS中元素z-index属性的问 - 掘金",[26,2482,2483],{},[44,2484,2487],{"href":2485,"rel":2486},"https://www.zhangxinxu.com/wordpress/2016/01/understand-css-stacking-context-order-z-index/",[48],"深入理解CSS中的层叠上下文和层叠顺序 «  张鑫旭-鑫空间-鑫生活",[26,2489,2490],{},[44,2491,2494],{"href":2492,"rel":2493},"https://element-plus.org/zh-CN/component/image.html",[48],"Image 图片 | Element Plus",[26,2496,2497],{},[44,2498,2501],{"href":2499,"rel":2500},"https://blog.csdn.net/qq_61402485/article/details/131202117",[48],"element ui e-image 和e-table一起使用显示问题_el-table el-image-CSDN博客",[926,2503,2504],{},"html pre.shiki code .sAGMh, html code.shiki .sAGMh{--shiki-default:#986801;--shiki-dark:#D19A66}html pre.shiki code .s5ixo, html code.shiki .s5ixo{--shiki-default:#383A42;--shiki-dark:#ABB2BF}html pre.shiki code .sYebD, html code.shiki .sYebD{--shiki-default:#383A42;--shiki-dark:#D19A66}html pre.shiki code .sLKXg, html code.shiki .sLKXg{--shiki-default:#A626A4;--shiki-dark:#C678DD}html .default .shiki span {color: var(--shiki-default);background: var(--shiki-default-bg);font-style: var(--shiki-default-font-style);font-weight: var(--shiki-default-font-weight);text-decoration: var(--shiki-default-text-decoration);}html .shiki span {color: var(--shiki-default);background: var(--shiki-default-bg);font-style: var(--shiki-default-font-style);font-weight: var(--shiki-default-font-weight);text-decoration: var(--shiki-default-text-decoration);}html .dark .shiki span {color: var(--shiki-dark);background: var(--shiki-dark-bg);font-style: var(--shiki-dark-font-style);font-weight: var(--shiki-dark-font-weight);text-decoration: var(--shiki-dark-text-decoration);}html.dark .shiki span {color: var(--shiki-dark);background: var(--shiki-dark-bg);font-style: var(--shiki-dark-font-style);font-weight: var(--shiki-dark-font-weight);text-decoration: var(--shiki-dark-text-decoration);}",{"title":135,"searchDepth":3,"depth":3,"links":2506},[2507,2508,2509,2513],{"id":2366,"depth":3,"text":2367},{"id":2391,"depth":3,"text":2392},{"id":2427,"depth":3,"text":2428,"children":2510},[2511,2512],{"id":2431,"depth":158,"text":2432},{"id":2438,"depth":158,"text":2438},{"id":816,"depth":3,"text":816},{"title":2515,"date":2516,"path":2517,"tags":2518,"body":2519},"2025年，前端如何使用 JS 将文本复制到剪切板？","2025-04-21 19:48:05","/2025/04/21/how-we-copy-text-to-clipboard-with-js-in-2025",[14],{"type":16,"value":2520,"toc":4003},[2521,2524,2532,2540,2555,2558,2788,2811,2814,2822,2825,2830,2851,2872,2877,2888,2899,3192,3204,3207,3216,3223,3226,3229,3234,3237,3269,3273,3276,3299,3304,3307,3310,3318,3321,3334,3337,3447,3450,3453,3460,3472,3475,3512,3515,3523,3538,3756,3760,3763,3771,3778,3853,3861,3874,3882,3888,3896,3906,3909,3912,3915,3918,3920,4000],[19,2522,2523],{"id":2523},"基础原理",[101,2525,2526,2527],{},"如果你尝试在搜索引擎上检索本文的标题，你搜到的文章大概会让你使用下面两个 API。",[139,2528,2531],{"className":2529},[2530],"heimu","我希望你用的搜索引擎不至于像某度一样灵车到 2025 年还在让你使用基于 Flash 的 ZeroClipboard 方案",[96,2533,2535],{"id":2534},"documentexeccommand",[44,2536,2539],{"href":2537,"rel":2538},"https://developer.mozilla.org/zh-CN/docs/Web/API/Document/execCommand",[48],"document.execCommand",[101,2541,2542,2543,2548,2549,2554],{},"2012 年不止有世界末日，还有 IE 10。随着 IE 10 在当年 9 月 4 日发布，execCommand 家族迎来了两个新的成员—— copy/cut 命令（此说法来自 ",[44,2544,2547],{"href":2545,"rel":2546},"https://developer.chrome.com/blog/cut-and-copy-commands",[48],"Chrome 的博客","，而 ",[44,2550,2553],{"href":2551,"rel":2552},"https://web.archive.org/web/20160315042044/https://developer.mozilla.org/zh-CN/docs/Web/API/Document/execCommand",[48],"MDN 认为 IE 9 就已经支持了","）。三年之后，随着 Google Chrome 在 2015 年 4 月 14 日的发布的 42 版本对 execCommand 的 copy/cut 跟进，越来越多的浏览器厂商开始在自家的浏览器中跟进这个实现标准。最终在 2016 年 9 月 13 日发布的 Safari 10 on IOS 后，WEB 开发者们总算获得了历史上第一个非 Flash 实现的 js 复制到剪切板的方案。",[101,2556,2557],{},"当 document.execCommand 的第一个参数为 copy 时，可以将用户选中的文本复制到剪切板。基于这个 API 实现，很快便有人研究出了当今 web 下最常见的 js 实现——先创建一个不可见的 dom，用 js 操作模拟用户选中文本，并调用 execCommand('copy') 将文本复制到用户的剪切板。大致的代码实现如下：",[130,2559,2561],{"className":1014,"code":2560,"language":1016,"meta":135,"style":135},"// 来自「JS复制文字到剪贴板的坑及完整方案。」一文，本文结尾有跳转链接\n\nconst textArea = document.createElement(\"textArea\");\ntextArea.value = val;\ntextArea.style.width = 0;\ntextArea.style.position = \"fixed\";\ntextArea.style.left = \"-999px\";\ntextArea.style.top = \"10px\";\ntextArea.setAttribute(\"readonly\", \"readonly\");\ndocument.body.appendChild(textArea);\n\ntextArea.select();\ndocument.execCommand(\"copy\");\ndocument.body.removeChild(textArea);\n",[64,2562,2563,2568,2572,2599,2616,2635,2655,2675,2695,2716,2737,2741,2753,2769],{"__ignoreMap":135},[139,2564,2565],{"class":141,"line":142},[139,2566,2567],{"class":444},"// 来自「JS复制文字到剪贴板的坑及完整方案。」一文，本文结尾有跳转链接\n",[139,2569,2570],{"class":141,"line":3},[139,2571,517],{"emptyLinePlaceholder":516},[139,2573,2574,2577,2581,2583,2586,2588,2591,2594,2597],{"class":141,"line":158},[139,2575,2576],{"class":1023},"const",[139,2578,2580],{"class":2579},"sNmU0"," textArea",[139,2582,1075],{"class":1034},[139,2584,2585],{"class":1060}," document",[139,2587,1064],{"class":145},[139,2589,2590],{"class":267},"createElement",[139,2592,2593],{"class":145},"(",[139,2595,2596],{"class":167},"\"textArea\"",[139,2598,1183],{"class":145},[139,2600,2601,2604,2606,2609,2611,2614],{"class":141,"line":174},[139,2602,2603],{"class":1060},"textArea",[139,2605,1064],{"class":145},[139,2607,2608],{"class":151},"value",[139,2610,1075],{"class":1034},[139,2612,2613],{"class":1030}," val",[139,2615,1081],{"class":145},[139,2617,2618,2620,2622,2624,2626,2629,2631,2633],{"class":141,"line":185},[139,2619,2603],{"class":1060},[139,2621,1064],{"class":145},[139,2623,926],{"class":1067},[139,2625,1064],{"class":145},[139,2627,2628],{"class":151},"width",[139,2630,1075],{"class":1034},[139,2632,1091],{"class":453},[139,2634,1081],{"class":145},[139,2636,2637,2639,2641,2643,2645,2648,2650,2653],{"class":141,"line":191},[139,2638,2603],{"class":1060},[139,2640,1064],{"class":145},[139,2642,926],{"class":1067},[139,2644,1064],{"class":145},[139,2646,2647],{"class":151},"position",[139,2649,1075],{"class":1034},[139,2651,2652],{"class":167}," \"fixed\"",[139,2654,1081],{"class":145},[139,2656,2657,2659,2661,2663,2665,2668,2670,2673],{"class":141,"line":328},[139,2658,2603],{"class":1060},[139,2660,1064],{"class":145},[139,2662,926],{"class":1067},[139,2664,1064],{"class":145},[139,2666,2667],{"class":151},"left",[139,2669,1075],{"class":1034},[139,2671,2672],{"class":167}," \"-999px\"",[139,2674,1081],{"class":145},[139,2676,2677,2679,2681,2683,2685,2688,2690,2693],{"class":141,"line":334},[139,2678,2603],{"class":1060},[139,2680,1064],{"class":145},[139,2682,926],{"class":1067},[139,2684,1064],{"class":145},[139,2686,2687],{"class":151},"top",[139,2689,1075],{"class":1034},[139,2691,2692],{"class":167}," \"10px\"",[139,2694,1081],{"class":145},[139,2696,2697,2699,2701,2704,2706,2709,2712,2714],{"class":141,"line":340},[139,2698,2603],{"class":1060},[139,2700,1064],{"class":145},[139,2702,2703],{"class":267},"setAttribute",[139,2705,2593],{"class":145},[139,2707,2708],{"class":167},"\"readonly\"",[139,2710,2711],{"class":145},", ",[139,2713,2708],{"class":167},[139,2715,1183],{"class":145},[139,2717,2718,2721,2723,2726,2728,2731,2733,2735],{"class":141,"line":346},[139,2719,2720],{"class":1060},"document",[139,2722,1064],{"class":145},[139,2724,2725],{"class":1067},"body",[139,2727,1064],{"class":145},[139,2729,2730],{"class":267},"appendChild",[139,2732,2593],{"class":145},[139,2734,2603],{"class":1030},[139,2736,1183],{"class":145},[139,2738,2739],{"class":141,"line":352},[139,2740,517],{"emptyLinePlaceholder":516},[139,2742,2743,2745,2747,2750],{"class":141,"line":358},[139,2744,2603],{"class":1060},[139,2746,1064],{"class":145},[139,2748,2749],{"class":267},"select",[139,2751,2752],{"class":145},"();\n",[139,2754,2755,2757,2759,2762,2764,2767],{"class":141,"line":364},[139,2756,2720],{"class":1060},[139,2758,1064],{"class":145},[139,2760,2761],{"class":267},"execCommand",[139,2763,2593],{"class":145},[139,2765,2766],{"class":167},"\"copy\"",[139,2768,1183],{"class":145},[139,2770,2771,2773,2775,2777,2779,2782,2784,2786],{"class":141,"line":370},[139,2772,2720],{"class":1060},[139,2774,1064],{"class":145},[139,2776,2725],{"class":1067},[139,2778,1064],{"class":145},[139,2780,2781],{"class":267},"removeChild",[139,2783,2593],{"class":145},[139,2785,2603],{"class":1030},[139,2787,1183],{"class":145},[101,2789,2790,2791,2794,2795,2800,2801,2806,2807,2810],{},"尽管",[210,2792,2793],{},"这个 API 早已被 w3c 弃用","，在 MDN 被标注为 Deprecated，但这仍然是市面上最常见的方案。在编写本文的时候，我扒了扒 MDN 的英文原始页面在 archive.org 的存档及其在 Github 的变更记录，这个 API 在 ",[44,2796,2799],{"href":2797,"rel":2798},"https://web.archive.org/web/20200221235207/https://developer.mozilla.org/en-US/docs/Web/API/Document/execCommand",[48],"2020 年 1~2 月","被首次标记为 Obsolete（过时的），在 ",[44,2802,2805],{"href":2803,"rel":2804},"https://github.com/mdn/content/commit/0c31e2bc4d6601a079bc57521e79529539c8cf68#diff-85ef9d1e72565f0ae2ffd8199d10b34c11c615aec5d116057ac2a33c21cc072f",[48],"2021 年 1 月","被首次标记为 Deprecated（已弃用），并附上了红色 Section Background Color 提示开发者该 API 可能",[210,2808,2809],{},"随时无法正常工作","。但截至本文发布，所有的常用浏览器都保留着对该 API 的兼容，起码在 copy 命令下是这样的。",[101,2812,2813],{},"这个 API 被广泛应用在了太多站点，以至于移除对该 API 的支持将会导致大量的站点异常，我想各家浏览器内核在短期内恐怕都没有动力以丢失兼容性为代价去移除这个 API，这也意味着这个创建一个不可见的 dom 代替用户选中文本并执行 execCommand 复制到用户剪切板的（看似奇葩的）曲线救国方案已然在前端开发的历史上留下了浓墨重彩的一笔。",[96,2815,2817],{"id":2816},"clipboardwritetext",[44,2818,2821],{"href":2819,"rel":2820},"https://developer.mozilla.org/zh-CN/docs/Web/API/Clipboard/writeText",[48],"Clipboard.writeText()",[101,2823,2824],{},"随着原生 JS 一步步被增强，开发者们总算补上了 Clipboard 这一块的拼图。2018 年 4 月 17 日，Chrome 66 率先迈出了这一步；同年 10 月 23 日，Firefox 跟进了 ClipBoard API 的实现。最终在 2020 年 3 月 24 日，随着 Apple 自家 Safari 13.4 的姗姗来迟，前端开发者门总算喘了口气，再一次得到了一个主流浏览器通用的复制方案。",[101,2826,2827],{},[210,2828,2829],{},"那么 execCommand 明明已经实现了纯 js 实现的复制文本到剪切板了，为什么我们还需要 Clipboard API ？或者说，这个特意去实现的 Clipboard API 到底有什么优势？",[595,2831,2832,2835,2838,2848],{},[26,2833,2834],{},"传统的 execCommand 方案在使用的时候通常需要创建一个临时的不可见的 DOM，放入文本、用 JS 选中文本、执行 copy 命令。我们暂且不说这种 hacky 的方式在代码编写时是多么不优雅，但一个使用 JS 去选中文本这个操作就会修改用户当前的文本选择状态，在某些时候导致一些用户体验的下降。",[26,2836,2837],{},"Clipboard API 是异步的，这意味着其在复制大量文本时不会阻塞主线程。",[26,2839,2840,2841,828,2844,2847],{},"Clipboard API 提供了更多的能力，比如 ",[64,2842,2843],{},"write()",[64,2845,2846],{},"read()"," 允许对剪切板读写更复杂的数据，比如富文本或图片。",[26,2849,2850],{},"Clipboard API 具有更现代、更明确的权限控制—— write 操作需要由用户的主动操作来调用，read 操作则需要用户在浏览器 UI 上明确授予权限。这些权限控制给予了用户更大的控制权，因此，当 execCommand 退出历史的舞台后，WEB 的安全性将得到进一步提升。",[101,2852,2853,2854,2856,2857,2860,2861,2864,2865,2867,2868,2871],{},"不过在现阶段，",[64,2855,2821],{}," 未必就能解决所有的问题。抛开旧版浏览器的兼容性问题不谈，",[64,2858,2859],{},"navigator.clipboard"," ",[210,2862,2863],{},"仅在通过 https 访问的页面中可用","（或是 localhost），如果你的项目部署在局域网，你试图通过 192.18.1.x 的 ip + port 直接访问，那么 ",[64,2866,2859],{}," 将会是 ",[64,2869,2870],{},"undefined"," 状态。",[101,2873,2874],{},[984,2875],{"alt":135,"src":2876},"https://static.031130.xyz/uploads/2025/04/19/3437b1c022853.webp",[101,2878,2879,2880,2883,2884,2887],{},"除此之外，",[210,2881,2882],{},"安卓原生的 Webview"," 还有因为 Permissions API 没实现而",[210,2885,2886],{},"用不了"," Clipboard API 的问题。",[101,2889,2890,2891,2894,2895,2898],{},"基于以上原因，很多网站现在都会优先尝试使用 ",[64,2892,2893],{},"navigator.clipboard.writeText()","，失败后再转去使用 ",[64,2896,2897],{},"execCommand('copy')","。大致的代码实现如下：",[130,2900,2902],{"className":1014,"code":2901,"language":1016,"meta":135,"style":135},"// 来自「JS复制文字到剪贴板的坑及完整方案。」一文，本文结尾有跳转链接\n\nconst copyText = async val => {\n  if (navigator.clipboard && navigator.permissions) {\n    await navigator.clipboard.writeText(val);\n  } else {\n    const textArea = document.createElement(\"textArea\");\n    textArea.value = val;\n    textArea.style.width = 0;\n    textArea.style.position = \"fixed\";\n    textArea.style.left = \"-999px\";\n    textArea.style.top = \"10px\";\n    textArea.setAttribute(\"readonly\", \"readonly\");\n    document.body.appendChild(textArea);\n\n    textArea.select();\n    document.execCommand(\"copy\");\n    document.body.removeChild(textArea);\n  }\n};\n",[64,2903,2904,2908,2912,2932,2960,2983,2993,3014,3029,3047,3065,3083,3101,3119,3138,3142,3152,3166,3184,3188],{"__ignoreMap":135},[139,2905,2906],{"class":141,"line":142},[139,2907,2567],{"class":444},[139,2909,2910],{"class":141,"line":3},[139,2911,517],{"emptyLinePlaceholder":516},[139,2913,2914,2916,2919,2921,2924,2927,2930],{"class":141,"line":158},[139,2915,2576],{"class":1023},[139,2917,2918],{"class":267}," copyText",[139,2920,1075],{"class":1034},[139,2922,2923],{"class":1023}," async",[139,2925,2613],{"class":2926},"s8iYz",[139,2928,2929],{"class":1023}," =>",[139,2931,1055],{"class":145},[139,2933,2934,2937,2939,2942,2944,2947,2950,2953,2955,2958],{"class":141,"line":174},[139,2935,2936],{"class":1023},"  if",[139,2938,1027],{"class":145},[139,2940,2941],{"class":1060},"navigator",[139,2943,1064],{"class":145},[139,2945,2946],{"class":151},"clipboard",[139,2948,2949],{"class":1034}," &&",[139,2951,2952],{"class":1060}," navigator",[139,2954,1064],{"class":145},[139,2956,2957],{"class":151},"permissions",[139,2959,1041],{"class":145},[139,2961,2962,2965,2967,2969,2971,2973,2976,2978,2981],{"class":141,"line":185},[139,2963,2964],{"class":1023},"    await",[139,2966,2952],{"class":1060},[139,2968,1064],{"class":145},[139,2970,2946],{"class":1067},[139,2972,1064],{"class":145},[139,2974,2975],{"class":267},"writeText",[139,2977,2593],{"class":145},[139,2979,2980],{"class":1030},"val",[139,2982,1183],{"class":145},[139,2984,2985,2988,2991],{"class":141,"line":191},[139,2986,2987],{"class":145},"  } ",[139,2989,2990],{"class":1023},"else",[139,2992,1055],{"class":145},[139,2994,2995,2998,3000,3002,3004,3006,3008,3010,3012],{"class":141,"line":328},[139,2996,2997],{"class":1023},"    const",[139,2999,2580],{"class":2579},[139,3001,1075],{"class":1034},[139,3003,2585],{"class":1060},[139,3005,1064],{"class":145},[139,3007,2590],{"class":267},[139,3009,2593],{"class":145},[139,3011,2596],{"class":167},[139,3013,1183],{"class":145},[139,3015,3016,3019,3021,3023,3025,3027],{"class":141,"line":334},[139,3017,3018],{"class":1060},"    textArea",[139,3020,1064],{"class":145},[139,3022,2608],{"class":151},[139,3024,1075],{"class":1034},[139,3026,2613],{"class":1030},[139,3028,1081],{"class":145},[139,3030,3031,3033,3035,3037,3039,3041,3043,3045],{"class":141,"line":340},[139,3032,3018],{"class":1060},[139,3034,1064],{"class":145},[139,3036,926],{"class":1067},[139,3038,1064],{"class":145},[139,3040,2628],{"class":151},[139,3042,1075],{"class":1034},[139,3044,1091],{"class":453},[139,3046,1081],{"class":145},[139,3048,3049,3051,3053,3055,3057,3059,3061,3063],{"class":141,"line":346},[139,3050,3018],{"class":1060},[139,3052,1064],{"class":145},[139,3054,926],{"class":1067},[139,3056,1064],{"class":145},[139,3058,2647],{"class":151},[139,3060,1075],{"class":1034},[139,3062,2652],{"class":167},[139,3064,1081],{"class":145},[139,3066,3067,3069,3071,3073,3075,3077,3079,3081],{"class":141,"line":352},[139,3068,3018],{"class":1060},[139,3070,1064],{"class":145},[139,3072,926],{"class":1067},[139,3074,1064],{"class":145},[139,3076,2667],{"class":151},[139,3078,1075],{"class":1034},[139,3080,2672],{"class":167},[139,3082,1081],{"class":145},[139,3084,3085,3087,3089,3091,3093,3095,3097,3099],{"class":141,"line":358},[139,3086,3018],{"class":1060},[139,3088,1064],{"class":145},[139,3090,926],{"class":1067},[139,3092,1064],{"class":145},[139,3094,2687],{"class":151},[139,3096,1075],{"class":1034},[139,3098,2692],{"class":167},[139,3100,1081],{"class":145},[139,3102,3103,3105,3107,3109,3111,3113,3115,3117],{"class":141,"line":364},[139,3104,3018],{"class":1060},[139,3106,1064],{"class":145},[139,3108,2703],{"class":267},[139,3110,2593],{"class":145},[139,3112,2708],{"class":167},[139,3114,2711],{"class":145},[139,3116,2708],{"class":167},[139,3118,1183],{"class":145},[139,3120,3121,3124,3126,3128,3130,3132,3134,3136],{"class":141,"line":370},[139,3122,3123],{"class":1060},"    document",[139,3125,1064],{"class":145},[139,3127,2725],{"class":1067},[139,3129,1064],{"class":145},[139,3131,2730],{"class":267},[139,3133,2593],{"class":145},[139,3135,2603],{"class":1030},[139,3137,1183],{"class":145},[139,3139,3140],{"class":141,"line":376},[139,3141,517],{"emptyLinePlaceholder":516},[139,3143,3144,3146,3148,3150],{"class":141,"line":382},[139,3145,3018],{"class":1060},[139,3147,1064],{"class":145},[139,3149,2749],{"class":267},[139,3151,2752],{"class":145},[139,3153,3154,3156,3158,3160,3162,3164],{"class":141,"line":388},[139,3155,3123],{"class":1060},[139,3157,1064],{"class":145},[139,3159,2761],{"class":267},[139,3161,2593],{"class":145},[139,3163,2766],{"class":167},[139,3165,1183],{"class":145},[139,3167,3168,3170,3172,3174,3176,3178,3180,3182],{"class":141,"line":394},[139,3169,3123],{"class":1060},[139,3171,1064],{"class":145},[139,3173,2725],{"class":1067},[139,3175,1064],{"class":145},[139,3177,2781],{"class":267},[139,3179,2593],{"class":145},[139,3181,2603],{"class":1030},[139,3183,1183],{"class":145},[139,3185,3186],{"class":141,"line":400},[139,3187,188],{"class":145},[139,3189,3190],{"class":141,"line":406},[139,3191,421],{"class":145},[96,3193,3195],{"id":3194},"flash-方案zeroclipboard",[1516,3196,3197,3198,3203],{},"Flash 方案（",[44,3199,3202],{"href":3200,"rel":3201},"https://github.com/zeroclipboard/zeroclipboard",[48],"ZeroClipboard","）",[101,3205,3206],{},"其实上面两个 API 差不多就把基础原理讲完了，不过我在查资料的时候发现，在 execCommand 方案之前，前端居然大多是依靠 Flash 来实现复制文本到剪切板的，这不得拿出来讲讲？",[101,3208,3209,3210,3215],{},"目前在 ZeroClipboard 的 Github 仓库能找到的最老的 tag 是 ",[44,3211,3214],{"href":3212,"rel":3213},"https://github.com/zeroclipboard/zeroclipboard/releases/tag/v1.0.7",[48],"v1.0.7","，发布于 2012 年 6 月 9 日。我打赌这个项目不是第一个通过 Flash 实现复制文本到剪切板的，在此之前肯定有人使用 Flash 实现过这个功能，只是没单独拎出来作为一个库开源出来。",[101,3217,3218,3219,3222],{},"ZeroClipboard 通过创建一个透明的 Flash Movie 覆盖在触发按钮上，当用户点击按钮时，实际上点到的是 Flash Movie，随后 JavaScript 与 Flash Movie 通过 ",[64,3220,3221],{},"ExternalInterface"," 进行通信，将需要复制的文本传递给 Flash，再经 Flash 的 API 将文本写入用户的剪切板。",[101,3224,3225],{},"在当时的时代背景下，这是唯一一个能够跨浏览器实现复制文本到剪切板的方案（尽管并不是每台电脑都装有 Flash，尽管 IOS 并不支持 Flash），6.6k star 的 Github 仓库见证了那个各家浏览器抱着各家私有 API 的混沌时代，最终随着 execCommand 方案的崛起，ZeroClipboard 与 Flash 一同落幕。",[96,3227,3228],{"id":3228},"其他不完美的方案",[3230,3231,3233],"h4",{"id":3232},"windowclipboarddatasetdata","window.clipboardData.setData",[101,3235,3236],{},"该 API 主要在 2000 年 —2010 年前后被使用，仅适用于 IE 浏览器。Firefox 在这段时间里还不支持纯 js 实现的复制文本至浏览器的操作；Chrome 第一个版本在 2008 年才发布，尚未成为主流。",[130,3238,3240],{"className":1014,"code":3239,"language":1016,"meta":135,"style":135},"window.clipboardData.setData(\"Text\", text2copy);\n",[64,3241,3242],{"__ignoreMap":135},[139,3243,3244,3247,3249,3252,3254,3257,3259,3262,3264,3267],{"class":141,"line":142},[139,3245,3246],{"class":1060},"window",[139,3248,1064],{"class":145},[139,3250,3251],{"class":1067},"clipboardData",[139,3253,1064],{"class":145},[139,3255,3256],{"class":267},"setData",[139,3258,2593],{"class":145},[139,3260,3261],{"class":167},"\"Text\"",[139,3263,2711],{"class":145},[139,3265,3266],{"class":1030},"text2copy",[139,3268,1183],{"class":145},[3230,3270,3272],{"id":3271},"摆烂prompt","摆烂（prompt）",[101,3274,3275],{},"调 prompt 弹窗让用户自己复制。",[130,3277,3279],{"className":1014,"code":3278,"language":1016,"meta":135,"style":135},"prompt('Press Ctrl + C, then Enter to copy to clipboard','copy me')\n",[64,3280,3281],{"__ignoreMap":135},[139,3282,3283,3286,3288,3291,3294,3297],{"class":141,"line":142},[139,3284,3285],{"class":267},"prompt",[139,3287,2593],{"class":145},[139,3289,3290],{"class":167},"'Press Ctrl + C, then Enter to copy to clipboard'",[139,3292,3293],{"class":145},",",[139,3295,3296],{"class":167},"'copy me'",[139,3298,475],{"class":145},[101,3300,3301],{},[984,3302],{"alt":135,"src":3303},"https://static.031130.xyz/uploads/2025/04/19/7f5310ca03c80.webp",[19,3305,3306],{"id":3306},"第三方库封装",[101,3308,3309],{},"由于 execCommand 的方案过于抽象，不够优雅，所以我们有一些现成的第三方库对复制到剪切板的代码进行了封装。",[96,3311,3313],{"id":3312},"clipboardjs",[44,3314,3317],{"href":3315,"rel":3316},"https://github.com/zenorocha/clipboard.js/",[48],"clipboard.js",[101,3319,3320],{},"clipboard.js 是最负盛名的一款第三方库，截至本文完成时间，在 Github 共收获 34.1k 的 star。最早的一个 tag 版本发布于 2015 年 10 月 28 日，也就是 Firefox 支持 execCommand、PC 端三大浏览器巨头全面兼容的一个月后。",[101,3322,3323,3324,3329,3330,3333],{},"clipboard.js ",[44,3325,3328],{"href":3326,"rel":3327},"https://github.com/zenorocha/clipboard.js/blob/master/src/common/command.js",[48],"仅使用 execCommand"," 实现复制到剪切板的操作，项目的 owner 希望开发者自行使用 ",[64,3331,3332],{},"ClipboardJS.isSupported()"," 来判断用户的浏览器是否支持 execCommand 方案，并根据命令执行的返回值自行安排成功/失败后的动作。。",[101,3335,3336],{},"不过让我感到奇怪的是，clipboard.js 在实例化时会要求开发者传入一个 DOM 选择（或者是 HTML 元素/元素列表）。它一定要有一个实体的 html 元素，用设置事件监听器来触发复制操作，而不是提供一个 js 函数让开发者来调用——尽管这不是来自 execCommand 的限制。示例如下",[130,3338,3340],{"className":1972,"code":3339,"language":1974,"meta":135,"style":135},"\u003C!-- Target -->\n\u003Cinput id=\"foo\" value=\"text2copy\" />\n\n\u003C!-- Trigger -->\n\u003Cbutton class=\"btn\" data-clipboard-target=\"#foo\">\u003C/button>\n\n\u003Cscript>\n    new ClipboardJS('.btn');\n\u003C/script>\n",[64,3341,3342,3347,3372,3376,3381,3411,3415,3424,3439],{"__ignoreMap":135},[139,3343,3344],{"class":141,"line":142},[139,3345,3346],{"class":444},"\u003C!-- Target -->\n",[139,3348,3349,3351,3354,3357,3359,3362,3365,3367,3370],{"class":141,"line":3},[139,3350,1981],{"class":145},[139,3352,3353],{"class":151},"input",[139,3355,3356],{"class":453}," id",[139,3358,1993],{"class":145},[139,3360,3361],{"class":167},"\"foo\"",[139,3363,3364],{"class":453}," value",[139,3366,1993],{"class":145},[139,3368,3369],{"class":167},"\"text2copy\"",[139,3371,2026],{"class":145},[139,3373,3374],{"class":141,"line":158},[139,3375,517],{"emptyLinePlaceholder":516},[139,3377,3378],{"class":141,"line":174},[139,3379,3380],{"class":444},"\u003C!-- Trigger -->\n",[139,3382,3383,3385,3388,3391,3393,3396,3399,3401,3404,3407,3409],{"class":141,"line":185},[139,3384,1981],{"class":145},[139,3386,3387],{"class":151},"button",[139,3389,3390],{"class":453}," class",[139,3392,1993],{"class":145},[139,3394,3395],{"class":167},"\"btn\"",[139,3397,3398],{"class":453}," data-clipboard-target",[139,3400,1993],{"class":145},[139,3402,3403],{"class":167},"\"#foo\"",[139,3405,3406],{"class":145},">\u003C/",[139,3408,3387],{"class":151},[139,3410,1999],{"class":145},[139,3412,3413],{"class":141,"line":191},[139,3414,517],{"emptyLinePlaceholder":516},[139,3416,3417,3419,3422],{"class":141,"line":328},[139,3418,1981],{"class":145},[139,3420,3421],{"class":151},"script",[139,3423,1999],{"class":145},[139,3425,3426,3429,3432,3434,3437],{"class":141,"line":334},[139,3427,3428],{"class":1023},"    new",[139,3430,3431],{"class":267}," ClipboardJS",[139,3433,2593],{"class":145},[139,3435,3436],{"class":167},"'.btn'",[139,3438,1183],{"class":145},[139,3440,3441,3443,3445],{"class":141,"line":340},[139,3442,2058],{"class":145},[139,3444,3421],{"class":151},[139,3446,1999],{"class":145},[101,3448,3449],{},"对，就一行 js 就能给所有带有 btn class 的 dom 加上监听器。或许这就是为什么这个仓库能获得 34.1k star 的原因，在 2015 年那个大多数人还在用三件套写前端的时代，clipboard.js 能够降低代码量，不用开发者自行设置监听器。",[101,3451,3452],{},"clipboard.js 当然也提供了很多高级选项来满足不同开发者的需求，比如允许你通过传入一个 function 来获取你需要让用户复制的文本而，或是通过 Event 监听器来反馈是否复制成功，总之灵活性是够用的。",[96,3454,3456],{"id":3455},"copy-to-clipboard",[44,3457,3455],{"href":3458,"rel":3459},"https://github.com/sudodoki/copy-to-clipboard",[48],[101,3461,3462,3463,3468,3469,3471],{},"同样是一款",[44,3464,3467],{"href":3465,"rel":3466},"https://github.com/sudodoki/copy-to-clipboard/blob/main/index.js#L79",[48],"利用 execCommand"," 的第三方库，虽然只有 1.3k star。第一个 tag 版本发布于 2015 年的 5 月 24 日，比 clipboard.js 还要早。相比起 clipboard.js，copy-to-clipboard 不依赖 html 元素，可以直接在 js 中被调用，我个人是比较喜欢这个的。在 vue/react 等现代化的前端框架中，我们一般不直接操作 dom，因此并不是很适合使用 clipboard.js，这个 copy-to-clipboard 就挺好的。此外，除了 execCommand 与方案，copy-to-clipboard 还对老版本的 IE 浏览器针对性的适配了 ",[64,3470,3233],{}," 的方案，并且在两者都失败时会调用 prompt 窗口让用户自主复制实现最终的兜底。",[101,3473,3474],{},"示例如下:",[130,3476,3478],{"className":1014,"code":3477,"language":1016,"meta":135,"style":135},"import copy from 'copy-to-clipboard';\n\ncopy('Text');\n",[64,3479,3480,3496,3500],{"__ignoreMap":135},[139,3481,3482,3485,3488,3491,3494],{"class":141,"line":142},[139,3483,3484],{"class":1023},"import",[139,3486,3487],{"class":151}," copy",[139,3489,3490],{"class":1023}," from",[139,3492,3493],{"class":167}," 'copy-to-clipboard'",[139,3495,1081],{"class":145},[139,3497,3498],{"class":141,"line":3},[139,3499,517],{"emptyLinePlaceholder":516},[139,3501,3502,3505,3507,3510],{"class":141,"line":158},[139,3503,3504],{"class":267},"copy",[139,3506,2593],{"class":145},[139,3508,3509],{"class":167},"'Text'",[139,3511,1183],{"class":145},[101,3513,3514],{},"相比起 clipboard.js 的使用思路是更加直观了，可惜生不逢时，不如 clipboard.js 出名（也可能有取名的原因在里面）。",[96,3516,3518],{"id":3517},"vueuse-useclipboard",[44,3519,3522],{"href":3520,"rel":3521},"https://vueuse.org/core/useClipboard/",[48],"VueUse - useClipboard",[101,3524,3525,3526,3531,3532,2860,3534,3537],{},"VueUse 实现的这个 useClipboard 是令我最为满意的一个。useClipboard 充分考虑了浏览器的兼容性，在检测到满足 navigator.clipboard 的使用条件时",[210,3527,3528,3529],{},"优先使用 ",[64,3530,2893],{}," ，在不支持 navigator.clipboard 或者 ",[64,3533,2893],{},[210,3535,3536],{},"复制失败时转去使用 execCommand 实现的 legacyCopy","，并且借助 Vue3 中的 Composables 实现了一个 1.5 秒后自动恢复初始状态的 copied 变量，算是很有心了。",[130,3539,3543],{"className":3540,"code":3541,"language":3542,"meta":135,"style":135},"language-vue shiki shiki-themes one-light one-dark-pro","const { text, copy, copied, isSupported } = useClipboard({ source })\n\u003C/script>\n\n\u003Ctemplate>\n  \u003Cdiv v-if=\"isSupported\">\n    \u003Cbutton @click=\"copy(source)\">\n      \u003C!-- by default, `copied` will be reset in 1.5s -->\n      \u003Cspan v-if=\"!copied\">Copy\u003C/span>\n      \u003Cspan v-else>Copied!\u003C/span>\n    \u003C/button>\n    \u003Cp>Current copied: \u003Ccode>{{ text || 'none' }}\u003C/code>\u003C/p>\n  \u003C/div>\n  \u003Cp v-else>\n    Your browser does not support Clipboard API\n  \u003C/p>\n\u003C/template>\n","vue",[64,3544,3545,3550,3558,3562,3571,3590,3601,3633,3652,3669,3678,3716,3725,3735,3740,3748],{"__ignoreMap":135},[139,3546,3547],{"class":141,"line":142},[139,3548,3549],{"class":145},"const { text, copy, copied, isSupported } = useClipboard({ source })\n",[139,3551,3552,3554,3556],{"class":141,"line":3},[139,3553,2058],{"class":145},[139,3555,3421],{"class":151},[139,3557,1999],{"class":145},[139,3559,3560],{"class":141,"line":158},[139,3561,517],{"emptyLinePlaceholder":516},[139,3563,3564,3566,3569],{"class":141,"line":174},[139,3565,1981],{"class":145},[139,3567,3568],{"class":151},"template",[139,3570,1999],{"class":145},[139,3572,3573,3575,3578,3582,3585,3588],{"class":141,"line":185},[139,3574,2004],{"class":145},[139,3576,3577],{"class":151},"div",[139,3579,3581],{"class":3580},"so_Uh"," v-if",[139,3583,1993],{"class":3584},"sknuh",[139,3586,3587],{"class":167},"\"isSupported\"",[139,3589,1999],{"class":145},[139,3591,3592,3595,3597],{"class":141,"line":191},[139,3593,3594],{"class":145},"    \u003C",[139,3596,3387],{"class":151},[139,3598,3600],{"class":3599},"sUNH4"," @click=\"copy(source)\">\n",[139,3602,3603,3606,3609,3612,3615,3618,3621,3624,3627,3630],{"class":141,"line":328},[139,3604,3605],{"class":3599},"      \u003C!--",[139,3607,3608],{"class":3580}," by",[139,3610,3611],{"class":3599}," default,",[139,3613,3614],{"class":3599}," `copied`",[139,3616,3617],{"class":3580}," will",[139,3619,3620],{"class":3580}," be",[139,3622,3623],{"class":3580}," reset",[139,3625,3626],{"class":3580}," in",[139,3628,3629],{"class":3599}," 1.5s",[139,3631,3632],{"class":3599}," -->\n",[139,3634,3635,3638,3640,3642,3645,3648,3650],{"class":141,"line":334},[139,3636,3637],{"class":3599},"      \u003Cspan",[139,3639,3581],{"class":3580},[139,3641,1993],{"class":3584},[139,3643,3644],{"class":167},"\"!copied\"",[139,3646,3647],{"class":145},">Copy\u003C/",[139,3649,139],{"class":151},[139,3651,1999],{"class":145},[139,3653,3654,3657,3659,3662,3665,3667],{"class":141,"line":340},[139,3655,3656],{"class":145},"      \u003C",[139,3658,139],{"class":151},[139,3660,3661],{"class":3580}," v-else",[139,3663,3664],{"class":145},">Copied!\u003C/",[139,3666,139],{"class":151},[139,3668,1999],{"class":145},[139,3670,3671,3674,3676],{"class":141,"line":346},[139,3672,3673],{"class":145},"    \u003C/",[139,3675,3387],{"class":151},[139,3677,1999],{"class":145},[139,3679,3680,3682,3684,3687,3689,3692,3695,3698,3701,3704,3706,3708,3710,3712,3714],{"class":141,"line":352},[139,3681,3594],{"class":145},[139,3683,101],{"class":151},[139,3685,3686],{"class":145},">Current copied: \u003C",[139,3688,64],{"class":151},[139,3690,3691],{"class":145},">",[139,3693,3694],{"class":1114},"{",[139,3696,3697],{"class":145},"{ text || ",[139,3699,3700],{"class":167},"'none'",[139,3702,3703],{"class":145}," }",[139,3705,1127],{"class":1114},[139,3707,2058],{"class":145},[139,3709,64],{"class":151},[139,3711,3406],{"class":145},[139,3713,101],{"class":151},[139,3715,1999],{"class":145},[139,3717,3718,3721,3723],{"class":141,"line":358},[139,3719,3720],{"class":145},"  \u003C/",[139,3722,3577],{"class":151},[139,3724,1999],{"class":145},[139,3726,3727,3729,3731,3733],{"class":141,"line":364},[139,3728,2004],{"class":145},[139,3730,101],{"class":151},[139,3732,3661],{"class":3580},[139,3734,1999],{"class":145},[139,3736,3737],{"class":141,"line":370},[139,3738,3739],{"class":145},"    Your browser does not support Clipboard API\n",[139,3741,3742,3744,3746],{"class":141,"line":376},[139,3743,3720],{"class":145},[139,3745,101],{"class":151},[139,3747,1999],{"class":145},[139,3749,3750,3752,3754],{"class":141,"line":382},[139,3751,2058],{"class":1034},[139,3753,3568],{"class":1030},[139,3755,1999],{"class":1034},[96,3757,3759],{"id":3758},"react-相关生态","React 相关生态",[101,3761,3762],{},"React 这边不像 VueUse 一家独大，出现了很多可用的 hooks 库，那就全都过一遍",[3230,3764,3766],{"id":3765},"react-use-usecopytoclipboard",[44,3767,3770],{"href":3768,"rel":3769},"https://github.com/streamich/react-use",[48],"react-use - useCopyToClipboard",[101,3772,3773,3774,3777],{},"react-use 是我能搜到的目前最大的 React Hooks 库，42.9k star。采用的复制方案是直接依赖上面介绍过的 ",[44,3775,3455],{"href":3458,"rel":3776},[48],"，也就是 execCommand 方案。",[130,3779,3783],{"className":3780,"code":3781,"language":3782,"meta":135,"style":135},"language-jsx shiki shiki-themes one-light one-dark-pro","const Demo = () => {\n  const [text, setText] = React.useState('');\n  const [state, copyToClipboard] = useCopyToClipboard();\n\n  return (\n    \u003Cdiv>\n      \u003Cinput value={text} onChange={e => setText(e.target.value)} />\n      \u003Cbutton type=\"button\" onClick={() => copyToClipboard(text)}>copy text\u003C/button>\n      {state.error\n        ? \u003Cp>Unable to copy value: {state.error.message}\u003C/p>\n        : state.value && \u003Cp>Copied {state.value}\u003C/p>}\n    \u003C/div>\n  )\n}\n","jsx",[64,3784,3785,3790,3795,3800,3804,3809,3814,3819,3824,3829,3834,3839,3844,3849],{"__ignoreMap":135},[139,3786,3787],{"class":141,"line":142},[139,3788,3789],{},"const Demo = () => {\n",[139,3791,3792],{"class":141,"line":3},[139,3793,3794],{},"  const [text, setText] = React.useState('');\n",[139,3796,3797],{"class":141,"line":158},[139,3798,3799],{},"  const [state, copyToClipboard] = useCopyToClipboard();\n",[139,3801,3802],{"class":141,"line":174},[139,3803,517],{"emptyLinePlaceholder":516},[139,3805,3806],{"class":141,"line":185},[139,3807,3808],{},"  return (\n",[139,3810,3811],{"class":141,"line":191},[139,3812,3813],{},"    \u003Cdiv>\n",[139,3815,3816],{"class":141,"line":328},[139,3817,3818],{},"      \u003Cinput value={text} onChange={e => setText(e.target.value)} />\n",[139,3820,3821],{"class":141,"line":334},[139,3822,3823],{},"      \u003Cbutton type=\"button\" onClick={() => copyToClipboard(text)}>copy text\u003C/button>\n",[139,3825,3826],{"class":141,"line":340},[139,3827,3828],{},"      {state.error\n",[139,3830,3831],{"class":141,"line":346},[139,3832,3833],{},"        ? \u003Cp>Unable to copy value: {state.error.message}\u003C/p>\n",[139,3835,3836],{"class":141,"line":352},[139,3837,3838],{},"        : state.value && \u003Cp>Copied {state.value}\u003C/p>}\n",[139,3840,3841],{"class":141,"line":358},[139,3842,3843],{},"    \u003C/div>\n",[139,3845,3846],{"class":141,"line":364},[139,3847,3848],{},"  )\n",[139,3850,3851],{"class":141,"line":370},[139,3852,194],{},[3230,3854,3856],{"id":3855},"ant-design-typography",[44,3857,3860],{"href":3858,"rel":3859},"https://ant.design/components/typography-cn#typography-demo-copyable",[48],"Ant Design - Typography",[101,3862,3863,3864,3869,3870,3873],{},"ahooks 是",[44,3865,3868],{"href":3866,"rel":3867},"https://site.j10ccc.xyz/",[48],"小麦茶","第一个报出来的 react hooks 库，由 Ant Design 原班人马维护。不过其在仓库中并没有对剪贴板的封装，因此在小麦茶的建议下我跑去翻了 Ant Design 中的 Typography 对复制能力的实现。和上面的 react-use 一样，都是直接用 ",[44,3871,3455],{"href":3458,"rel":3872},[48],"，属于 execCommand 方案。",[3230,3875,3877],{"id":3876},"usehooks-usecopytoclipboard",[44,3878,3881],{"href":3879,"rel":3880},"https://usehooks.com/usecopytoclipboard",[48],"usehooks - useCopyToClipboard",[101,3883,3884,3885,3887],{},"这个库是我问 llm 知道的，现在有 10.5k star。非常逆天的一点在于它的所有逻辑代码都是在 index.js 这样一个单文件里实现的，属实是看不懂了。会先采用 ",[64,3886,2893],{}," 尝试写入，失败后再换用 execCommand 的方案。hooks 的用法和上面的 react-use 大差不差。",[3230,3889,3891],{"id":3890},"usehooks-ts-usecopytoclipboard",[44,3892,3895],{"href":3893,"rel":3894},"https://usehooks-ts.com/react-hook/use-copy-to-clipboard",[48],"usehooks-ts - useCopyToClipboard",[101,3897,3898,3899,3901,3902,3905],{},"不知道是不是为了解决上面那玩意儿不支持 ts 才开的库。只使用 ",[64,3900,2893],{}," 尝试写入剪切板，失败后直接 ",[64,3903,3904],{},"console.warn"," 报错，没有 fallback 方案。",[19,3907,3908],{"id":3908},"结语",[101,3910,3911],{},"从结果上来看，VueUse 的封装无疑是最令我满意的。优先尝试性能最好的 Clipboard API，再尝试 execCommand 作为回落，同时辅以多个响应式变量帮助开发，但又不擅作主张地使用 prompt 作为保底，最大程度地把操作空间留给开发者。",[101,3913,3914],{},"站在 2025 年的节点回望，前端剪切板操作技术的演进轨迹清晰可见：从早期依赖 Flash 的脆弱方案，到 execCommand 的曲线救国，最终迈向标准化 Clipboard API 的优雅实现。这段历程不仅是技术迭代的缩影，更折射出前端开发中独特的「妥协艺术」。",[101,3916,3917],{},"在未来的很长一段时间里，或许我们还是会在「优雅实现」与「向下兼容」之间寻找平衡点、在浏览器沙箱里戴着镣铐跳芭蕾，但那些为兼容性而生的临时方案，终将成为见证前端进化史的珍贵注脚。",[19,3919,816],{"id":816},[23,3921,3922,3929,3936,3942,3949,3955,3961,3967,3974,3980,3986,3993],{},[26,3923,3924],{},[44,3925,3928],{"href":3926,"rel":3927},"https://liruifengv.com/posts/copy-text/",[48],"JS复制文字到剪贴板的坑及完整方案。",[26,3930,3931],{},[44,3932,3935],{"href":3933,"rel":3934},"https://jiongks.name/blog/zeroclipboard-intro",[48],"ZeroClipboard 学习笔记 | 囧克斯",[26,3937,3938],{},[44,3939,3941],{"href":2545,"rel":3940},[48],"Cut and copy commands  |  Blog  |  Chrome for Developers",[26,3943,3944],{},[44,3945,3948],{"href":3946,"rel":3947},"https://learn.microsoft.com/en-us/previous-versions/windows/internet-explorer/ie-developer/platform-apis/ms536419(v=vs.85)",[48],"execCommand method (Internet Explorer) | Microsoft Learn",[26,3950,3951],{},[44,3952,3954],{"href":3458,"rel":3953},[48],"sudodoki/copy-to-clipboard",[26,3956,3957],{},[44,3958,3960],{"href":3315,"rel":3959},[48],"zenorocha/clipboard.js",[26,3962,3963],{},[44,3964,3966],{"href":3520,"rel":3965},[48],"useClipboard | VueUse",[26,3968,3969],{},[44,3970,3973],{"href":3971,"rel":3972},"https://streamich.github.io/react-use/?path=/story/side-effects-usecopytoclipboard--docs",[48],"Side-effects / useCopyToClipboard - Docs ⋅ Storybook",[26,3975,3976],{},[44,3977,3979],{"href":2537,"rel":3978},[48],"document.execCommand - Web API | MDN",[26,3981,3982],{},[44,3983,3985],{"href":2819,"rel":3984},[48],"Clipboard.writeText() - Web API | MDN",[26,3987,3988],{},[44,3989,3992],{"href":3990,"rel":3991},"https://www.sitepoint.com/community/t/onclick-select-all-and-copy-to-clipboard/3837/2",[48],"Onclick Select All and Copy to Clipboard? - JavaScript - SitePoint Forums | Web Development & Design Community",[26,3994,3995],{},[44,3996,3999],{"href":3997,"rel":3998},"https://stackoverflow.com/questions/16526814/how-would-i-implement-copy-url-to-clipboard-from-a-link-or-button-using-javasc",[48],"How would I implement 'copy url to clipboard' from a link or button using javascript or dojo without flash - Stack Overflow",[926,4001,4002],{},"html pre.shiki code .sW2Sy, html code.shiki .sW2Sy{--shiki-default:#A0A1A7;--shiki-default-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic}html pre.shiki code .sLKXg, html code.shiki .sLKXg{--shiki-default:#A626A4;--shiki-dark:#C678DD}html pre.shiki code .sNmU0, html code.shiki .sNmU0{--shiki-default:#986801;--shiki-dark:#E5C07B}html pre.shiki code .s_Sar, html code.shiki .s_Sar{--shiki-default:#0184BC;--shiki-dark:#56B6C2}html pre.shiki code .s7GmK, html code.shiki .s7GmK{--shiki-default:#383A42;--shiki-dark:#E5C07B}html pre.shiki code .s5ixo, html code.shiki .s5ixo{--shiki-default:#383A42;--shiki-dark:#ABB2BF}html pre.shiki code .sAdtL, html code.shiki .sAdtL{--shiki-default:#4078F2;--shiki-dark:#61AFEF}html pre.shiki code .sDhpE, html code.shiki .sDhpE{--shiki-default:#50A14F;--shiki-dark:#98C379}html pre.shiki code .sJa8x, html code.shiki .sJa8x{--shiki-default:#E45649;--shiki-dark:#E06C75}html pre.shiki code .sz0mV, html code.shiki .sz0mV{--shiki-default:#383A42;--shiki-dark:#E06C75}html pre.shiki code .s2QsP, html code.shiki .s2QsP{--shiki-default:#E45649;--shiki-dark:#E5C07B}html pre.shiki code .sAGMh, html code.shiki .sAGMh{--shiki-default:#986801;--shiki-dark:#D19A66}html .default .shiki span {color: var(--shiki-default);background: var(--shiki-default-bg);font-style: var(--shiki-default-font-style);font-weight: var(--shiki-default-font-weight);text-decoration: var(--shiki-default-text-decoration);}html .shiki span {color: var(--shiki-default);background: var(--shiki-default-bg);font-style: var(--shiki-default-font-style);font-weight: var(--shiki-default-font-weight);text-decoration: var(--shiki-default-text-decoration);}html .dark .shiki span {color: var(--shiki-dark);background: var(--shiki-dark-bg);font-style: var(--shiki-dark-font-style);font-weight: var(--shiki-dark-font-weight);text-decoration: var(--shiki-dark-text-decoration);}html.dark .shiki span {color: var(--shiki-dark);background: var(--shiki-dark-bg);font-style: var(--shiki-dark-font-style);font-weight: var(--shiki-dark-font-weight);text-decoration: var(--shiki-dark-text-decoration);}html pre.shiki code .s8iYz, html code.shiki .s8iYz{--shiki-default:#383A42;--shiki-default-font-style:inherit;--shiki-dark:#E06C75;--shiki-dark-font-style:italic}html pre.shiki code .so_Uh, html code.shiki .so_Uh{--shiki-default:#986801;--shiki-default-font-style:inherit;--shiki-dark:#D19A66;--shiki-dark-font-style:italic}html pre.shiki code .sknuh, html code.shiki .sknuh{--shiki-default:#383A42;--shiki-dark:#56B6C2}html pre.shiki code .sUNH4, html code.shiki .sUNH4{--shiki-default:white;--shiki-dark:#FFFFFF}html pre.shiki code .sAOjX, html code.shiki .sAOjX{--shiki-default:#CA1243;--shiki-dark:#C678DD}",{"title":135,"searchDepth":3,"depth":3,"links":4004},[4005,4012,4018,4019],{"id":2523,"depth":3,"text":2523,"children":4006},[4007,4008,4009,4011],{"id":2534,"depth":158,"text":2539},{"id":2816,"depth":158,"text":2821},{"id":3194,"depth":158,"text":4010},"Flash 方案（ZeroClipboard）",{"id":3228,"depth":158,"text":3228},{"id":3306,"depth":3,"text":3306,"children":4013},[4014,4015,4016,4017],{"id":3312,"depth":158,"text":3317},{"id":3455,"depth":158,"text":3455},{"id":3517,"depth":158,"text":3522},{"id":3758,"depth":158,"text":3759},{"id":3908,"depth":3,"text":3908},{"id":816,"depth":3,"text":816},{"title":4021,"date":4022,"path":4023,"tags":4024,"body":4030},"ssh 拯救世界——通过 ssh 隧道在内网服务器执行 APT 更新","2025-03-30 21:45:24","/2025/03/30/apt-upgrade-on-internal-server-via-ssh-tunnel-and-reverse-proxy",[4025,1571,4026,4027,4028,4029],"Apt","OpenSSH","Caddy","Linux","Debian",{"type":16,"value":4031,"toc":4304},[4032,4041,4046,4049,4052,4063,4066,4075,4078,4119,4122,4141,4146,4149,4154,4159,4163,4166,4185,4194,4197,4200,4213,4218,4221,4224,4236,4241,4253,4278,4284,4290,4293,4298,4301],[101,4033,4034,4035,4040],{},"事情的起因是因为精弘的",[44,4036,4039],{"href":4037,"rel":4038},"https://blog.cnpatrickstar.com/",[48],"前技术总监","抱怨学校的内网服务器无法连接外网，从而导致 apt 安装与更新异常困难，需要手动从源中下载软件包、软件包的依赖及其依赖的依赖。。。然后将这些包通过 sftp/rsync 一类的手段传到服务器上手动安装。",[101,4042,4043],{},[984,4044],{"alt":135,"src":4045},"https://static.031130.xyz/uploads/2025/03/30/0447b7d64886a.webp",[101,4047,4048],{},"于是本文应运而生，我们可以在本机使用 Caddy （Nginx 当然也行）反代一个 APT 源镜像站，通过 ssh 隧道建立端口转发，这样就可以在内网服务器上访问到本地的 Caddy 服务器，进而访问到外网的镜像站。",[19,4050,4051],{"id":4051},"前提条件",[23,4053,4054,4057],{},[26,4055,4056],{},"主控机（你自己的电脑）能够通过 ssh 直接连接电脑（可以是使用一些网络工具），而不是先通过 ssh 登陆到一台中转机，再从中转机登陆到目标服务器。后面这种情况当然也可以使用类似的手段实现我们的目标，但会更复杂一些。",[26,4058,4059,4060,590],{},"主控机（你自己的电脑）在连接内网服务器的同时，能够连接公网镜像站（",[1516,4061,4062],{},"不行的话要不然你提前本地同步一份镜像做离线镜像站",[19,4064,4065],{"id":4065},"反代镜像站",[101,4067,4068,4069,4074],{},"我这里选择了 Caddy 而非 Nginx，一方面是 Caddy 的配置文件写起来简单，另一方面 Caddy 是 Golang 编写，一个二进制走天下，Windows 也能直接",[44,4070,4073],{"href":4071,"rel":4072},"https://caddyserver.com/download",[48],"下载","运行。",[101,4076,4077],{},"我们以最常见的清华 tuna 镜像站为例，一个简单的 caddy 配置文件是这样的",[130,4079,4083],{"className":4080,"code":4081,"language":4082,"meta":135,"style":135},"language-nginx shiki shiki-themes one-light one-dark-pro",":8080 {\n    reverse_proxy https://mirrors.tuna.tsinghua.edu.cn {\n        header_up Host {http.reverse_proxy.upstream.hostport}\n    }\n}\n","nginx",[64,4084,4085,4095,4103,4111,4115],{"__ignoreMap":135},[139,4086,4087,4090,4093],{"class":141,"line":142},[139,4088,4089],{"class":145},":",[139,4091,4092],{"class":1023},"8080",[139,4094,1055],{"class":145},[139,4096,4097,4100],{"class":141,"line":3},[139,4098,4099],{"class":1023},"    reverse_proxy",[139,4101,4102],{"class":145}," https://mirrors.tuna.tsinghua.edu.cn {\n",[139,4104,4105,4108],{"class":141,"line":158},[139,4106,4107],{"class":1023},"        header_up",[139,4109,4110],{"class":145}," Host {http.reverse_proxy.upstream.hostport}\n",[139,4112,4113],{"class":141,"line":174},[139,4114,775],{"class":145},[139,4116,4117],{"class":141,"line":185},[139,4118,194],{"class":145},[101,4120,4121],{},"将上面这段代码保存为 Caddyfile 文件名，随后使用 caddy 命令在保存路径运行",[130,4123,4125],{"className":258,"code":4124,"language":260,"meta":135,"style":135},"caddy run --config ./Caddyfile\n",[64,4126,4127],{"__ignoreMap":135},[139,4128,4129,4132,4135,4138],{"class":141,"line":142},[139,4130,4131],{"class":267},"caddy",[139,4133,4134],{"class":167}," run",[139,4136,4137],{"class":453}," --config",[139,4139,4140],{"class":167}," ./Caddyfile\n",[101,4142,4143],{},[984,4144],{"alt":135,"src":4145},"https://static.031130.xyz/uploads/2025/03/30/8ef15a08e4852.webp",[101,4147,4148],{},"如果没有报错，那你应该能在本地的 8080 端口看到清华的镜像站",[101,4150,4151],{},[984,4152],{"alt":135,"src":4153},"https://static.031130.xyz/uploads/2025/03/30/a9083c95c07a2.webp",[205,4155,4156],{},[101,4157,4158],{},"你可能注意到，反代后的页面和清华的镜像站有些许差异，没有清华的 logo，这大概是因为页面的 js 对 host 进行了判断，如果不是清华或者北外的页面，就不会添加学校的名称，但这不影响我们从这些镜像站获取更新。",[19,4160,4162],{"id":4161},"建立-ssh-隧道","建立 ssh 隧道",[101,4164,4165],{},"建立隧道时，需要使用如下的命令",[130,4167,4169],{"className":258,"code":4168,"language":260,"meta":135,"style":135},"ssh -R 8085:localhost:8080 root@remote.example.com\n",[64,4170,4171],{"__ignoreMap":135},[139,4172,4173,4176,4179,4182],{"class":141,"line":142},[139,4174,4175],{"class":267},"ssh",[139,4177,4178],{"class":453}," -R",[139,4180,4181],{"class":167}," 8085:localhost:8080",[139,4183,4184],{"class":167}," root@remote.example.com\n",[101,4186,4187,4188,4193],{},"-R 表示建立反向隧道，其他的参数选项可以参考这一篇博客「",[44,4189,4192],{"href":4190,"rel":4191},"https://www.entropy-tree.top/2024/04/18/ssh-tunneling-techniques/",[48],"SSH 隧道技术","」，也是精弘的学长写的。",[101,4195,4196],{},"此时，我们建立了一个内网服务器 8085 端口到本机 8080 端口的 ssh 端口转发。（使用 8085 端口是我为了区分其和 8080 端口，实际上可以使用任何空余端口）",[101,4198,4199],{},"我们可以在服务器上使用 curl 来测试一下是否能够正常访问，我这里简单访问了下 Debian 源根目录下的一个 README 文件。",[130,4201,4203],{"className":258,"code":4202,"language":260,"meta":135,"style":135},"curl http://localhost:8085/debian/README\n",[64,4204,4205],{"__ignoreMap":135},[139,4206,4207,4210],{"class":141,"line":142},[139,4208,4209],{"class":267},"curl",[139,4211,4212],{"class":167}," http://localhost:8085/debian/README\n",[101,4214,4215],{},[984,4216],{"alt":135,"src":4217},"https://static.031130.xyz/uploads/2025/03/30/597c4af0d398d.webp",[19,4219,4220],{"id":4220},"换源",[101,4222,4223],{},"所以现在我们在内网服务器的 8085 端口上有一个清华开源镜像站的反代，我们可以通过 8085 端口访问镜像站中的所有内容。",[101,4225,4226,4227,4232,4233,611],{},"先遵循",[44,4228,4231],{"href":4229,"rel":4230},"https://mirrors.tuna.tsinghua.edu.cn/help/debian/",[48],"清华开源镜像站的指示","，进行换源，",[210,4234,4235],{},"记得一定要勾选「强制安全更新使用镜像」",[101,4237,4238],{},[984,4239],{"alt":135,"src":4240},"https://static.031130.xyz/uploads/2025/03/30/46e3c7030ded4.webp",[101,4242,4243,4244,4248,4249],{},"随后，我们将源中的所有 ",[44,4245,4246],{"href":4246,"rel":4247},"https://mirrors.tuna.tsinghua.edu.cn",[48]," 替换成 ",[44,4250,4251],{"href":4251,"rel":4252},"http://localhost:8085",[48],[130,4254,4256],{"className":258,"code":4255,"language":260,"meta":135,"style":135},"sed -i 's|https\\?://mirrors\\.tuna\\.tsinghua\\.edu\\.cn|http://localhost:8085|g' `grep -rlE 'http(s)?://mirrors\\.tuna\\.tsinghua\\.edu\\.cn' /etc/apt/`\n",[64,4257,4258],{"__ignoreMap":135},[139,4259,4260,4262,4264,4267,4270,4272,4275],{"class":141,"line":142},[139,4261,450],{"class":267},[139,4263,454],{"class":453},[139,4265,4266],{"class":167}," 's|https\\?://mirrors\\.tuna\\.tsinghua\\.edu\\.cn|http://localhost:8085|g'",[139,4268,4269],{"class":167}," `",[139,4271,463],{"class":267},[139,4273,4274],{"class":453}," -rlE",[139,4276,4277],{"class":167}," 'http(s)?://mirrors\\.tuna\\.tsinghua\\.edu\\.cn' /etc/apt/`\n",[101,4279,4280],{},[984,4281],{"alt":4282,"src":4283},"执行 apt update","https://static.031130.xyz/uploads/2025/03/30/a8f0c70d48f5b.webp",[101,4285,4286],{},[984,4287],{"alt":4288,"src":4289},"使用 apt 安装 unzip","https://static.031130.xyz/uploads/2025/03/30/07919bf939e92.webp",[101,4291,4292],{},"可以看到，我们通过 ssh 隧道实现了在内网服务器执行 APT 更新及安装软件。",[205,4294,4295],{},[101,4296,4297],{},"温馨提示，ssh 隧道在本世纪 10 年代初经常被用来进行搭建一些跨境访问，但因为其独特的流量特征很快淡出了历史舞台，因此不要使用 ssh 进行大量的跨境网络传输，容易被封禁。",[101,4299,4300],{},"当然，实现这一目标的方法是很多的，其他一些例如 frp 的工具同样能做到这种效果，只不过 ssh 隧道这种方案随开随用，随关随停，不需要更多的配置，因此我主要推荐。",[926,4302,4303],{},"html pre.shiki code .s5ixo, html code.shiki .s5ixo{--shiki-default:#383A42;--shiki-dark:#ABB2BF}html pre.shiki code .sLKXg, html code.shiki .sLKXg{--shiki-default:#A626A4;--shiki-dark:#C678DD}html .default .shiki span {color: var(--shiki-default);background: var(--shiki-default-bg);font-style: var(--shiki-default-font-style);font-weight: var(--shiki-default-font-weight);text-decoration: var(--shiki-default-text-decoration);}html .shiki span {color: var(--shiki-default);background: var(--shiki-default-bg);font-style: var(--shiki-default-font-style);font-weight: var(--shiki-default-font-weight);text-decoration: var(--shiki-default-text-decoration);}html .dark .shiki span {color: var(--shiki-dark);background: var(--shiki-dark-bg);font-style: var(--shiki-dark-font-style);font-weight: var(--shiki-dark-font-weight);text-decoration: var(--shiki-dark-text-decoration);}html.dark .shiki span {color: var(--shiki-dark);background: var(--shiki-dark-bg);font-style: var(--shiki-dark-font-style);font-weight: var(--shiki-dark-font-weight);text-decoration: var(--shiki-dark-text-decoration);}html pre.shiki code .sAdtL, html code.shiki .sAdtL{--shiki-default:#4078F2;--shiki-dark:#61AFEF}html pre.shiki code .sDhpE, html code.shiki .sDhpE{--shiki-default:#50A14F;--shiki-dark:#98C379}html pre.shiki code .sAGMh, html code.shiki .sAGMh{--shiki-default:#986801;--shiki-dark:#D19A66}",{"title":135,"searchDepth":3,"depth":3,"links":4305},[4306,4307,4308,4309],{"id":4051,"depth":3,"text":4051},{"id":4065,"depth":3,"text":4065},{"id":4161,"depth":3,"text":4162},{"id":4220,"depth":3,"text":4220},{"title":4311,"date":4312,"path":4313,"tags":4314,"body":4320},"Cudy TR3000 吃鹅(daed)记","2025-02-28 21:18:34","/2025/02/28/cudy-tr3000-daed-install-record",[4315,4316,1571,4317,4318,4319],"OpenSource Project","Hardware","Router","OpenWRT","ImmortalWRT",{"type":16,"value":4321,"toc":4632},[4322,4325,4333,4338,4341,4347,4356,4359,4362,4369,4374,4377,4380,4383,4389,4392,4397,4401,4404,4409,4412,4417,4420,4426,4429,4434,4439,4443,4449,4454,4460,4466,4471,4474,4493,4498,4502,4505,4512,4518,4523,4526,4531,4542,4547,4550,4555,4558,4563,4569,4575,4578,4584,4590,4592,4629],[19,4323,4324],{"id":4324},"缘起",[101,4326,4327,4328,4332],{},"前不久在京东自营看到我馋了很久的 Cudy TR3000 有 ￥153 的折扣价，虽然比起 ￥130 的史低价（甚至 ￥110 的凑单史低价）还有些距离，但已经到我的可接受范围内了，于是果断下单剁手了这台我心心念念的 Cudy TR3000 迷你路由器，以此来缓解我的",[139,4329,4331],{"className":4330},[2530],"开学前综合症","（一种精神性疾病）",[101,4334,4335],{},[984,4336],{"alt":135,"src":4337},"https://static.031130.xyz/uploads/2025/02/23/8b0a4d5812179.webp",[101,4339,4340],{},"这台路由器使用 Type-C 供电，拥有一个 2.5Gbps 的 WAN 口和一个 1Gbps 的 LAN 口，在此基础上还有一个 USB 口可用于打印机共享、挂载外接存储、安卓手机 USB 共享网络等多种用途。更让我心动的地方在于其小巧的体型，非常适合出差、旅行、短期租房等场景。考虑到接下来一段实习可能会有租房需求，于是便趁此机会果断下单了。",[101,4342,4343],{},[984,4344],{"alt":4345,"src":4346},"与一台小米8的宽高对比","https://static.031130.xyz/uploads/2025/02/23/ef2b394e6fc0d.webp",[101,4348,4349,4350,4355],{},"官方系统是基于 openwrt 定制的，功能比较单一，因此考虑刷入 openwrt 原版系统增加可玩性。在恩山无限论坛上发现已经有人编译了",[44,4351,4354],{"href":4352,"rel":4353},"https://www.right.com.cn/forum/forum.php?mod=viewthread&tid=8418091",[48],"基于 Linux 6.6 版本的 OpenWRT 系统","，这已经满足了 dae 的 Bind to LAN 功能的内核版本要求（ >= 5.17 ），且 512MB 的内存大小刚好达到了推荐的最小内存大小，于是这 dae 肯定是要试着吃一吃的。如果成功了，这就是我手上第一台吃上大鹅的硬路由。",[4357,4358],"hr",{},[19,4360,4361],{"id":4361},"开始刷机",[101,4363,4364,4365,4368],{},"路由器官方系统的后台管理地址是 192.168.10.1，初次进入会要求你设置密码，然后就是一路随便点，完成初始化，随后就进入到主页。我手上这台的 FW 版本号是 ",[64,4366,4367],{},"2.3.2-20241226","，不清楚后续的版本能不能仍然使用这套方案。",[101,4370,4371],{},[984,4372],{"alt":135,"src":4373},"https://static.031130.xyz/uploads/2025/02/28/1c066cb1dab3f.webp",[96,4375,4376],{"id":4376},"过渡固件",[101,4378,4379],{},"首先我们需要先刷入所谓的「过渡固件」。刷入过渡固件的意义在于，这个过渡固件能被官方系统的升级程序所承认，这样就允许我们进行后续的操作。",[101,4381,4382],{},"过渡固件的文件名和 md5 值如下:",[130,4384,4387],{"className":4385,"code":4386,"language":669},[667],"b8333d8eebd067fcb43bec855ac22364  cudy_tr3000-v1-sysupgrade.bin\n",[64,4388,4386],{"__ignoreMap":135},[101,4390,4391],{},"随后我们可以在路由器的管理页面的基本设置中找到固件升级的地方，在本地更新一栏中选择过渡固件上传更新即可。",[101,4393,4394],{},[984,4395],{"alt":135,"src":4396},"https://static.031130.xyz/uploads/2025/02/28/3582e569954a6.webp",[96,4398,4400],{"id":4399},"刷入解锁-fip-分区写入权限的固件","刷入解锁 FIP 分区写入权限的固件",[101,4402,4403],{},"刷入过渡固件后稍等大约一分钟，路由器的 DHCP 重新工作，我们就可以通过 192.168.1.1 进入过渡固件的管理页面。",[101,4405,4406],{},[984,4407],{"alt":135,"src":4408},"https://static.031130.xyz/uploads/2025/02/28/6fe8107a87e87.webp",[101,4410,4411],{},"初次登陆时没有密码，随便输就能登陆成功。考虑到后续可能会有恢复出厂的需求，建议在这一步对 FIP 分区进行备份。",[101,4413,4414],{},[984,4415],{"alt":135,"src":4416},"https://static.031130.xyz/uploads/2025/02/28/79caf5f643689.webp",[101,4418,4419],{},"这次我们需要刷入下面这个 LEDE 固件来解锁 FIP 分区的写入权限，文件名和 md5 仍然放在下面",[130,4421,4424],{"className":4422,"code":4423,"language":669},[667],"4af5129368cbf0d556061f682b1614f2  openwrt-mediatek-filogic-cudy_tr3000-v1-squashfs-sysupgrade.bin\n",[64,4425,4423],{"__ignoreMap":135},[101,4427,4428],{},"在下方选择刷入固件，上传我们本次需要刷入的固件，刷入。",[101,4430,4431],{},[984,4432],{"alt":135,"src":4433},"https://static.031130.xyz/uploads/2025/02/28/79d300bb33d21.webp",[101,4435,4436],{},[984,4437],{"alt":135,"src":4438},"https://static.031130.xyz/uploads/2025/02/28/bc29dc9cad24a.webp",[96,4440,4442],{"id":4441},"刷入-uboot","刷入 uboot",[101,4444,4445,4446],{},"再等待一分钟左右，电脑重新连接上路由器后，我们可以进入到这个解锁了 FIP 分区写入权限的固件，默认密码是 ",[64,4447,4448],{},"password",[101,4450,4451],{},[984,4452],{"alt":135,"src":4453},"https://static.031130.xyz/uploads/2025/02/28/f98051faba608.webp",[101,4455,4456,4457],{},"在侧栏选择文件传输，将本次要刷入的 uboot 上传，文件名和 md5 还是放在下面。",[210,4458,4459],{},"注意 zip 包要解压",[130,4461,4464],{"className":4462,"code":4463,"language":669},[667],"e5ff31bac07108b6ac6cd63189b4d113  dhcp-mt7981_cudy_tr3000-fip-fixed-parts-multi-layout.bin\n",[64,4465,4463],{"__ignoreMap":135},[101,4467,4468],{},[984,4469],{"alt":135,"src":4470},"https://static.031130.xyz/uploads/2025/02/28/547c5d324f0a0.webp",[101,4472,4473],{},"随后侧栏进入 TTYD 终端，输入默认的用户名密码 root / password，执行命令刷入 uboot",[130,4475,4477],{"className":258,"code":4476,"language":260,"meta":135,"style":135},"mtd write /tmp/upload/dhcp-mt7981_cudy_tr3000-fip-fixed-parts-multi-layout.bin FIP\n",[64,4478,4479],{"__ignoreMap":135},[139,4480,4481,4484,4487,4490],{"class":141,"line":142},[139,4482,4483],{"class":267},"mtd",[139,4485,4486],{"class":167}," write",[139,4488,4489],{"class":167}," /tmp/upload/dhcp-mt7981_cudy_tr3000-fip-fixed-parts-multi-layout.bin",[139,4491,4492],{"class":167}," FIP\n",[101,4494,4495],{},[984,4496],{"alt":135,"src":4497},"https://static.031130.xyz/uploads/2025/02/28/46b4fc5be8c82.webp",[96,4499,4501],{"id":4500},"刷入自编译的-immortalwrt","刷入自编译的 immortalwrt",[101,4503,4504],{},"刷入 uboot 以后，给路由器断电，确保网线分别连接电脑和路由器 LAN 口后，按住 reset 键再插入电源键，直至白灯闪烁四次后转为红灯后松开 reset 键，即可进入 uboot。",[101,4506,4507,4508,4511],{},"我编译的是 112m 的布局，因此需要选择 ",[64,4509,4510],{},"mod-112m"," 这个 mtd 布局后上传固件刷入。",[130,4513,4516],{"className":4514,"code":4515,"language":669},[667],"8c9a44f29c8c5a0617e61d49bf8ad45d  112m-immortalwrt-cudy_tr3000-ebpf_by_zhullyb_20250325-squashfs-sysupgrade.bin\n",[64,4517,4515],{"__ignoreMap":135},[101,4519,4520],{},[984,4521],{"alt":135,"src":4522},"https://static.031130.xyz/uploads/2025/02/28/41c250db91756.webp",[101,4524,4525],{},"再次等待电脑重新连接路由器，这是最终吃上 daed 的系统了，依然是没有默认密码，随便输入即可进入。在连接上网络后，在系统 - 软件包页面，更新软件包列表。",[101,4527,4528],{},[984,4529],{"alt":135,"src":4530},"https://static.031130.xyz/uploads/2025/02/28/e56084ff09a5d.webp",[101,4532,4533,4534,4537,4538,4541],{},"随后就可以安装 dae / daed 相关软件了，可视需求选择 ",[64,4535,4536],{},"luci-i18n-dae-zh-cn"," 或者 ",[64,4539,4540],{},"luci-i18n-daed-zh-cn","，其他包会作为依赖一同被安装。我这里安装的是 daed。",[101,4543,4544],{},[984,4545],{"alt":135,"src":4546},"https://static.031130.xyz/uploads/2025/02/28/dc4fa4a688cf5.webp",[101,4548,4549],{},"安装后刷新界面，我们就可以在顶栏的服务板块看到 daed。",[101,4551,4552],{},[984,4553],{"alt":135,"src":4554},"https://static.031130.xyz/uploads/2025/02/28/551f1f2eb9ab4.webp",[101,4556,4557],{},"daed 正常运行，能正常跑满我家的 300Mbps 宽带下行（单线程实测 250Mbps），速度峰值时 CPU 占用图如下。",[101,4559,4560],{},[984,4561],{"alt":135,"src":4562},"https://static.031130.xyz/uploads/2025/02/28/651bed7ad4aba.webp",[101,4564,4565],{},[984,4566],{"alt":4567,"src":4568},"多线程测速","https://static.031130.xyz/uploads/2025/03/01/9fcee79afa63b.png",[101,4570,4571],{},[984,4572],{"alt":4573,"src":4574},"单线程测速","https://static.031130.xyz/uploads/2025/03/01/6716d723a2b0d.png",[19,4576,4577],{"id":4577},"文章中提到的文件",[101,4579,4580],{},[44,4581,4582],{"href":4582,"rel":4583},"https://www.123684.com/s/gfprVv-wEQ8d",[48],[101,4585,4586],{},[44,4587,4588],{"href":4588,"rel":4589},"https://www.123912.com/s/gfprVv-wEQ8d",[48],[19,4591,816],{"id":816},[23,4593,4594,4601,4608,4615,4622],{},[26,4595,4596],{},[44,4597,4600],{"href":4598,"rel":4599},"https://www.right.com.cn/forum/forum.php?mod=viewthread&tid=8410353",[48],"Cudy TR3000 刷机教程指北",[26,4602,4603],{},[44,4604,4607],{"href":4605,"rel":4606},"https://abxy.fun/post/immortalwrt-dae/",[48],"使用 ImmortalWrt+Dae 为 Windows 配置透明代理",[26,4609,4610],{},[44,4611,4614],{"href":4612,"rel":4613},"https://www.right.com.cn/forum/forum.php?mod=viewthread&tid=8415351",[48],"cudy tr3000 v1中文三分区DHCP uboot第二版",[26,4616,4617],{},[44,4618,4621],{"href":4619,"rel":4620},"https://blog.imouto.in/#/posts/10",[48],"使用 hanwckf/bl-mt798x 引导主线 OpenWrt 固件",[26,4623,4624],{},[44,4625,4628],{"href":4626,"rel":4627},"https://github.com/QiuSimons/luci-app-daed",[48],"QiuSimons/luci-app-daed",[926,4630,4631],{},"html pre.shiki code .sAdtL, html code.shiki .sAdtL{--shiki-default:#4078F2;--shiki-dark:#61AFEF}html pre.shiki code .sDhpE, html code.shiki .sDhpE{--shiki-default:#50A14F;--shiki-dark:#98C379}html .default .shiki span {color: var(--shiki-default);background: var(--shiki-default-bg);font-style: var(--shiki-default-font-style);font-weight: var(--shiki-default-font-weight);text-decoration: var(--shiki-default-text-decoration);}html .shiki span {color: var(--shiki-default);background: var(--shiki-default-bg);font-style: var(--shiki-default-font-style);font-weight: var(--shiki-default-font-weight);text-decoration: var(--shiki-default-text-decoration);}html .dark .shiki span {color: var(--shiki-dark);background: var(--shiki-dark-bg);font-style: var(--shiki-dark-font-style);font-weight: var(--shiki-dark-font-weight);text-decoration: var(--shiki-dark-text-decoration);}html.dark .shiki span {color: var(--shiki-dark);background: var(--shiki-dark-bg);font-style: var(--shiki-dark-font-style);font-weight: var(--shiki-dark-font-weight);text-decoration: var(--shiki-dark-text-decoration);}",{"title":135,"searchDepth":3,"depth":3,"links":4633},[4634,4635,4641,4642],{"id":4324,"depth":3,"text":4324},{"id":4361,"depth":3,"text":4361,"children":4636},[4637,4638,4639,4640],{"id":4376,"depth":158,"text":4376},{"id":4399,"depth":158,"text":4400},{"id":4441,"depth":158,"text":4442},{"id":4500,"depth":158,"text":4501},{"id":4577,"depth":3,"text":4577},{"id":816,"depth":3,"text":816},{"title":4644,"date":4645,"path":4646,"tags":4647,"body":4650},"使用 Cloudflare Workers 监控 Fedora Copr 构建状态","2025-02-23 12:12:53","/2025/02/23/monitor-copr-build-state-with-cloudflare-workers",[14,4648,4649],"Cloudflare","Fedora",{"type":16,"value":4651,"toc":5496},[4652,4659,4667,4681,4693,4698,4701,4704,4926,4929,5116,5119,5475,5478,5483,5493],[205,4653,4654],{},[101,4655,4656],{},[1516,4657,4658],{},"确信，是 cloudflare workers 用上瘾了",[101,4660,4661,4662,4666],{},"在",[44,4663,4665],{"href":4664},"/2024/04/29/update-a-rpm-spec-by-github-action/","「使用 Github Action 更新用于 rpm 打包的 spec 文件」","一文中，我利用 Github Action 实现了自动化的 spec 版本号更新，配合 Fedora Copr 的 webhook 就可以实现 Copr 软件包更新的自动化构建。看似很完美，但缺少了一个构建状态的监控机制，这导致出现构建错误的时候我不能及时得到通知（无论构建错误是 spec 本身的问题或者是构建时的网络环境问题）。",[101,4668,4669,4674,4675,4680],{},[44,4670,4673],{"href":4671,"rel":4672},"https://yanqiyu.info",[48],"西木野羰基"," 提出 ",[44,4676,4679],{"href":4677,"rel":4678},"https://notifications.fedoraproject.org/",[48],"notifications.fedoraproject.org"," 可以配置通知，Filters 的 Applications 选项中有 copr，但很可惜，实测没有效果。这里的通知配置的似乎只是邮件的过滤规则——如果 copr 本来就没打算构建失败的时候给你发邮件，那即使建立了过滤规则，依然是不可能收到邮件的。",[101,4682,4683,4684,576,4689,4692],{},"不过好在 Fedora Copr 本身有非常完备的 ",[44,4685,4688],{"href":4686,"rel":4687},"https://copr.fedorainfracloud.org/api_3/docs",[48],"api 文档",[64,4690,4691],{},"/monitor"," 这个 API 能用来获取软件包最新的构建情况。",[101,4694,4695],{},[984,4696],{"alt":135,"src":4697},"https://static.031130.xyz/uploads/2025/02/23/637811d2d85f6.webp",[101,4699,4700],{},"因此，我们就可以通过 Cloudflare 的 cronjob 定时请求这个接口，查询是否有软件包构建失败。",[101,4702,4703],{},"先来编写打请求的部分",[130,4705,4707],{"className":1014,"code":4706,"language":1016,"meta":135,"style":135},"async function fetchCopr() {\n    const ownername = \"zhullyb\";\n    const projectname = \"v2rayA\";\n\n    const url = new URL(\"https://copr.fedorainfracloud.org/api_3/monitor\")\n    url.searchParams.set(\"ownername\", ownername)\n    url.searchParams.set(\"projectname\", projectname)\n    const response = await fetch(url)\n    const data = await response.json()\n    if (data.output !== \"ok\") {\n        throw new Error(\"Failed to fetch COPR data\")\n    }\n    return data\n}\n",[64,4708,4709,4723,4737,4751,4755,4777,4804,4828,4850,4870,4893,4910,4914,4922],{"__ignoreMap":135},[139,4710,4711,4714,4717,4720],{"class":141,"line":142},[139,4712,4713],{"class":1023},"async",[139,4715,4716],{"class":1023}," function",[139,4718,4719],{"class":267}," fetchCopr",[139,4721,4722],{"class":145},"() {\n",[139,4724,4725,4727,4730,4732,4735],{"class":141,"line":3},[139,4726,2997],{"class":1023},[139,4728,4729],{"class":2579}," ownername",[139,4731,1075],{"class":1034},[139,4733,4734],{"class":167}," \"zhullyb\"",[139,4736,1081],{"class":145},[139,4738,4739,4741,4744,4746,4749],{"class":141,"line":158},[139,4740,2997],{"class":1023},[139,4742,4743],{"class":2579}," projectname",[139,4745,1075],{"class":1034},[139,4747,4748],{"class":167}," \"v2rayA\"",[139,4750,1081],{"class":145},[139,4752,4753],{"class":141,"line":174},[139,4754,517],{"emptyLinePlaceholder":516},[139,4756,4757,4759,4762,4764,4767,4770,4772,4775],{"class":141,"line":185},[139,4758,2997],{"class":1023},[139,4760,4761],{"class":2579}," url",[139,4763,1075],{"class":1034},[139,4765,4766],{"class":1023}," new",[139,4768,4769],{"class":267}," URL",[139,4771,2593],{"class":145},[139,4773,4774],{"class":167},"\"https://copr.fedorainfracloud.org/api_3/monitor\"",[139,4776,475],{"class":145},[139,4778,4779,4782,4784,4787,4789,4792,4794,4797,4799,4802],{"class":141,"line":191},[139,4780,4781],{"class":1060},"    url",[139,4783,1064],{"class":145},[139,4785,4786],{"class":1067},"searchParams",[139,4788,1064],{"class":145},[139,4790,4791],{"class":267},"set",[139,4793,2593],{"class":145},[139,4795,4796],{"class":167},"\"ownername\"",[139,4798,2711],{"class":145},[139,4800,4801],{"class":1030},"ownername",[139,4803,475],{"class":145},[139,4805,4806,4808,4810,4812,4814,4816,4818,4821,4823,4826],{"class":141,"line":328},[139,4807,4781],{"class":1060},[139,4809,1064],{"class":145},[139,4811,4786],{"class":1067},[139,4813,1064],{"class":145},[139,4815,4791],{"class":267},[139,4817,2593],{"class":145},[139,4819,4820],{"class":167},"\"projectname\"",[139,4822,2711],{"class":145},[139,4824,4825],{"class":1030},"projectname",[139,4827,475],{"class":145},[139,4829,4830,4832,4835,4837,4840,4843,4845,4848],{"class":141,"line":334},[139,4831,2997],{"class":1023},[139,4833,4834],{"class":2579}," response",[139,4836,1075],{"class":1034},[139,4838,4839],{"class":1023}," await",[139,4841,4842],{"class":267}," fetch",[139,4844,2593],{"class":145},[139,4846,4847],{"class":1030},"url",[139,4849,475],{"class":145},[139,4851,4852,4854,4857,4859,4861,4863,4865,4867],{"class":141,"line":340},[139,4853,2997],{"class":1023},[139,4855,4856],{"class":2579}," data",[139,4858,1075],{"class":1034},[139,4860,4839],{"class":1023},[139,4862,4834],{"class":1060},[139,4864,1064],{"class":145},[139,4866,134],{"class":267},[139,4868,4869],{"class":145},"()\n",[139,4871,4872,4875,4877,4880,4882,4885,4888,4891],{"class":141,"line":346},[139,4873,4874],{"class":1023},"    if",[139,4876,1027],{"class":145},[139,4878,4879],{"class":1060},"data",[139,4881,1064],{"class":145},[139,4883,4884],{"class":151},"output",[139,4886,4887],{"class":1034}," !==",[139,4889,4890],{"class":167}," \"ok\"",[139,4892,1041],{"class":145},[139,4894,4895,4898,4900,4903,4905,4908],{"class":141,"line":352},[139,4896,4897],{"class":1023},"        throw",[139,4899,4766],{"class":1023},[139,4901,4902],{"class":267}," Error",[139,4904,2593],{"class":145},[139,4906,4907],{"class":167},"\"Failed to fetch COPR data\"",[139,4909,475],{"class":145},[139,4911,4912],{"class":141,"line":358},[139,4913,775],{"class":145},[139,4915,4916,4919],{"class":141,"line":364},[139,4917,4918],{"class":1023},"    return",[139,4920,4921],{"class":1030}," data\n",[139,4923,4924],{"class":141,"line":370},[139,4925,194],{"class":145},[101,4927,4928],{},"随后编写通知部分，我这里采用的是飞书的 webhook 机器人",[130,4930,4932],{"className":1014,"code":4931,"language":1016,"meta":135,"style":135},"async function notify(text) {\n    const webhook = \"https://open.feishu.cn/open-apis/bot/v2/hook/ffffffff-ffff-ffff-ffff-ffffffffffff\"\n    const body = {\n        msg_type: \"text\",\n        content: {\n            text: text\n        }\n    }\n    const response = await fetch(webhook, {\n        method: \"POST\",\n        headers: {\n            \"Content-Type\": \"application/json\"\n        },\n        body: JSON.stringify(body)\n    })\n    console.log(response)\n}\n",[64,4933,4934,4949,4961,4972,4985,4994,5004,5009,5013,5033,5045,5054,5064,5069,5090,5095,5112],{"__ignoreMap":135},[139,4935,4936,4938,4940,4943,4945,4947],{"class":141,"line":142},[139,4937,4713],{"class":1023},[139,4939,4716],{"class":1023},[139,4941,4942],{"class":267}," notify",[139,4944,2593],{"class":145},[139,4946,669],{"class":2926},[139,4948,1041],{"class":145},[139,4950,4951,4953,4956,4958],{"class":141,"line":3},[139,4952,2997],{"class":1023},[139,4954,4955],{"class":2579}," webhook",[139,4957,1075],{"class":1034},[139,4959,4960],{"class":167}," \"https://open.feishu.cn/open-apis/bot/v2/hook/ffffffff-ffff-ffff-ffff-ffffffffffff\"\n",[139,4962,4963,4965,4968,4970],{"class":141,"line":158},[139,4964,2997],{"class":1023},[139,4966,4967],{"class":2579}," body",[139,4969,1075],{"class":1034},[139,4971,1055],{"class":145},[139,4973,4974,4977,4980,4983],{"class":141,"line":174},[139,4975,4976],{"class":151},"        msg_type",[139,4978,4089],{"class":4979},"st7oF",[139,4981,4982],{"class":167}," \"text\"",[139,4984,171],{"class":145},[139,4986,4987,4990,4992],{"class":141,"line":185},[139,4988,4989],{"class":151},"        content",[139,4991,4089],{"class":4979},[139,4993,1055],{"class":145},[139,4995,4996,4999,5001],{"class":141,"line":191},[139,4997,4998],{"class":151},"            text",[139,5000,4089],{"class":4979},[139,5002,5003],{"class":1030}," text\n",[139,5005,5006],{"class":141,"line":328},[139,5007,5008],{"class":145},"        }\n",[139,5010,5011],{"class":141,"line":334},[139,5012,775],{"class":145},[139,5014,5015,5017,5019,5021,5023,5025,5027,5030],{"class":141,"line":340},[139,5016,2997],{"class":1023},[139,5018,4834],{"class":2579},[139,5020,1075],{"class":1034},[139,5022,4839],{"class":1023},[139,5024,4842],{"class":267},[139,5026,2593],{"class":145},[139,5028,5029],{"class":1030},"webhook",[139,5031,5032],{"class":145},", {\n",[139,5034,5035,5038,5040,5043],{"class":141,"line":346},[139,5036,5037],{"class":151},"        method",[139,5039,4089],{"class":4979},[139,5041,5042],{"class":167}," \"POST\"",[139,5044,171],{"class":145},[139,5046,5047,5050,5052],{"class":141,"line":352},[139,5048,5049],{"class":151},"        headers",[139,5051,4089],{"class":4979},[139,5053,1055],{"class":145},[139,5055,5056,5059,5061],{"class":141,"line":358},[139,5057,5058],{"class":167},"            \"Content-Type\"",[139,5060,4089],{"class":4979},[139,5062,5063],{"class":167}," \"application/json\"\n",[139,5065,5066],{"class":141,"line":364},[139,5067,5068],{"class":145},"        },\n",[139,5070,5071,5074,5076,5079,5081,5084,5086,5088],{"class":141,"line":370},[139,5072,5073],{"class":151},"        body",[139,5075,4089],{"class":4979},[139,5077,5078],{"class":2579}," JSON",[139,5080,1064],{"class":145},[139,5082,5083],{"class":267},"stringify",[139,5085,2593],{"class":145},[139,5087,2725],{"class":1030},[139,5089,475],{"class":145},[139,5091,5092],{"class":141,"line":376},[139,5093,5094],{"class":145},"    })\n",[139,5096,5097,5100,5102,5105,5107,5110],{"class":141,"line":382},[139,5098,5099],{"class":1060},"    console",[139,5101,1064],{"class":145},[139,5103,5104],{"class":267},"log",[139,5106,2593],{"class":145},[139,5108,5109],{"class":1030},"response",[139,5111,475],{"class":145},[139,5113,5114],{"class":141,"line":388},[139,5115,194],{"class":145},[101,5117,5118],{},"最后就是 cronjob 的调用部分和构建状态解析部分",[130,5120,5122],{"className":1014,"code":5121,"language":1016,"meta":135,"style":135},"export default {\n    async fetch(request, env, ctx) {\n      return new Response('Hello World!');\n    },\n\n    async scheduled(event, env, ctx) {\n        const data = await fetchCopr()\n        const errorPackages = new Array()\n\n        for (const pkg of data.packages) {\n            for (const chroot of Object.values(pkg.chroots)) {\n                if (chroot.state == \"failed\") {\n                    errorPackages.push(pkg.name)\n                    break\n                }\n            }\n        }\n\n        if (errorPackages.length > 0) {\n            await notify(`COPR 以下包发生构建失败:\\n${errorPackages.join(\"\\n\")}`)\n        } else {\n            console.log(\"COPR 所有包构建成功\")\n        }\n    }\n};\n",[64,5123,5124,5135,5159,5176,5181,5185,5207,5222,5238,5242,5266,5301,5324,5345,5350,5355,5360,5364,5368,5390,5435,5444,5460,5465,5470],{"__ignoreMap":135},[139,5125,5126,5129,5133],{"class":141,"line":142},[139,5127,5128],{"class":1023},"export",[139,5130,5132],{"class":5131},"sq3v1"," default",[139,5134,1055],{"class":145},[139,5136,5137,5140,5142,5144,5147,5149,5152,5154,5157],{"class":141,"line":3},[139,5138,5139],{"class":1023},"    async",[139,5141,4842],{"class":267},[139,5143,2593],{"class":145},[139,5145,5146],{"class":2926},"request",[139,5148,2711],{"class":145},[139,5150,5151],{"class":2926},"env",[139,5153,2711],{"class":145},[139,5155,5156],{"class":2926},"ctx",[139,5158,1041],{"class":145},[139,5160,5161,5164,5166,5169,5171,5174],{"class":141,"line":158},[139,5162,5163],{"class":1023},"      return",[139,5165,4766],{"class":1023},[139,5167,5168],{"class":267}," Response",[139,5170,2593],{"class":145},[139,5172,5173],{"class":167},"'Hello World!'",[139,5175,1183],{"class":145},[139,5177,5178],{"class":141,"line":174},[139,5179,5180],{"class":145},"    },\n",[139,5182,5183],{"class":141,"line":185},[139,5184,517],{"emptyLinePlaceholder":516},[139,5186,5187,5189,5192,5194,5197,5199,5201,5203,5205],{"class":141,"line":191},[139,5188,5139],{"class":1023},[139,5190,5191],{"class":267}," scheduled",[139,5193,2593],{"class":145},[139,5195,5196],{"class":2926},"event",[139,5198,2711],{"class":145},[139,5200,5151],{"class":2926},[139,5202,2711],{"class":145},[139,5204,5156],{"class":2926},[139,5206,1041],{"class":145},[139,5208,5209,5212,5214,5216,5218,5220],{"class":141,"line":328},[139,5210,5211],{"class":1023},"        const",[139,5213,4856],{"class":2579},[139,5215,1075],{"class":1034},[139,5217,4839],{"class":1023},[139,5219,4719],{"class":267},[139,5221,4869],{"class":145},[139,5223,5224,5226,5229,5231,5233,5236],{"class":141,"line":334},[139,5225,5211],{"class":1023},[139,5227,5228],{"class":2579}," errorPackages",[139,5230,1075],{"class":1034},[139,5232,4766],{"class":1023},[139,5234,5235],{"class":267}," Array",[139,5237,4869],{"class":145},[139,5239,5240],{"class":141,"line":340},[139,5241,517],{"emptyLinePlaceholder":516},[139,5243,5244,5247,5249,5251,5254,5257,5259,5261,5264],{"class":141,"line":346},[139,5245,5246],{"class":1023},"        for",[139,5248,1027],{"class":145},[139,5250,2576],{"class":1023},[139,5252,5253],{"class":2579}," pkg",[139,5255,5256],{"class":1023}," of",[139,5258,4856],{"class":1060},[139,5260,1064],{"class":145},[139,5262,5263],{"class":151},"packages",[139,5265,1041],{"class":145},[139,5267,5268,5271,5273,5275,5278,5280,5283,5285,5288,5290,5293,5295,5298],{"class":141,"line":352},[139,5269,5270],{"class":1023},"            for",[139,5272,1027],{"class":145},[139,5274,2576],{"class":1023},[139,5276,5277],{"class":2579}," chroot",[139,5279,5256],{"class":1023},[139,5281,5282],{"class":1060}," Object",[139,5284,1064],{"class":145},[139,5286,5287],{"class":267},"values",[139,5289,2593],{"class":145},[139,5291,5292],{"class":1060},"pkg",[139,5294,1064],{"class":145},[139,5296,5297],{"class":151},"chroots",[139,5299,5300],{"class":145},")) {\n",[139,5302,5303,5306,5308,5311,5313,5316,5319,5322],{"class":141,"line":358},[139,5304,5305],{"class":1023},"                if",[139,5307,1027],{"class":145},[139,5309,5310],{"class":1060},"chroot",[139,5312,1064],{"class":145},[139,5314,5315],{"class":151},"state",[139,5317,5318],{"class":1034}," ==",[139,5320,5321],{"class":167}," \"failed\"",[139,5323,1041],{"class":145},[139,5325,5326,5329,5331,5334,5336,5338,5340,5343],{"class":141,"line":364},[139,5327,5328],{"class":1060},"                    errorPackages",[139,5330,1064],{"class":145},[139,5332,5333],{"class":267},"push",[139,5335,2593],{"class":145},[139,5337,5292],{"class":1060},[139,5339,1064],{"class":145},[139,5341,5342],{"class":151},"name",[139,5344,475],{"class":145},[139,5346,5347],{"class":141,"line":370},[139,5348,5349],{"class":1023},"                    break\n",[139,5351,5352],{"class":141,"line":376},[139,5353,5354],{"class":145},"                }\n",[139,5356,5357],{"class":141,"line":382},[139,5358,5359],{"class":145},"            }\n",[139,5361,5362],{"class":141,"line":388},[139,5363,5008],{"class":145},[139,5365,5366],{"class":141,"line":394},[139,5367,517],{"emptyLinePlaceholder":516},[139,5369,5370,5373,5375,5378,5380,5383,5386,5388],{"class":141,"line":400},[139,5371,5372],{"class":1023},"        if",[139,5374,1027],{"class":145},[139,5376,5377],{"class":1060},"errorPackages",[139,5379,1064],{"class":145},[139,5381,5382],{"class":151},"length",[139,5384,5385],{"class":1034}," >",[139,5387,1091],{"class":453},[139,5389,1041],{"class":145},[139,5391,5392,5395,5397,5399,5402,5405,5407,5409,5412,5415,5417,5421,5423,5425,5428,5430,5433],{"class":141,"line":406},[139,5393,5394],{"class":1023},"            await",[139,5396,4942],{"class":267},[139,5398,2593],{"class":145},[139,5400,5401],{"class":167},"`COPR 以下包发生构建失败:",[139,5403,5404],{"class":1034},"\\n",[139,5406,1115],{"class":1114},[139,5408,5377],{"class":1060},[139,5410,1064],{"class":5411},"sMj0N",[139,5413,5414],{"class":267},"join",[139,5416,2593],{"class":145},[139,5418,5420],{"class":5419},"sWwuK","\"",[139,5422,5404],{"class":1034},[139,5424,5420],{"class":5419},[139,5426,5427],{"class":145},")",[139,5429,1127],{"class":1114},[139,5431,5432],{"class":167},"`",[139,5434,475],{"class":145},[139,5436,5437,5440,5442],{"class":141,"line":412},[139,5438,5439],{"class":145},"        } ",[139,5441,2990],{"class":1023},[139,5443,1055],{"class":145},[139,5445,5446,5449,5451,5453,5455,5458],{"class":141,"line":418},[139,5447,5448],{"class":1060},"            console",[139,5450,1064],{"class":145},[139,5452,5104],{"class":267},[139,5454,2593],{"class":145},[139,5456,5457],{"class":167},"\"COPR 所有包构建成功\"",[139,5459,475],{"class":145},[139,5461,5463],{"class":141,"line":5462},23,[139,5464,5008],{"class":145},[139,5466,5468],{"class":141,"line":5467},24,[139,5469,775],{"class":145},[139,5471,5473],{"class":141,"line":5472},25,[139,5474,421],{"class":145},[101,5476,5477],{},"随后在 Cloudflare Workers 的 Settings 部分设置好 Cron 表达式即可，我这里选择在每小时的 55 分进行一次检测，这样下来一天只会消耗 24 次 workers 次数，简直毫无压力。",[101,5479,5480],{},[984,5481],{"alt":135,"src":5482},"https://static.031130.xyz/uploads/2025/02/23/c38edfd637934.webp",[101,5484,5485,5488,5489,5492],{},[210,5486,5487],{},"缺点:"," 我懒得使用持久化数据库记录软件包构建的成功状态，这会导致出现一个包构建失败后，每隔 1 小时都会有一条提醒，",[1516,5490,5491],{},"什么夺命连环 call","。我目前不想修复这个问题，要不然还是降低 cron 的触发频率好了。",[926,5494,5495],{},"html pre.shiki code .sLKXg, html code.shiki .sLKXg{--shiki-default:#A626A4;--shiki-dark:#C678DD}html pre.shiki code .sAdtL, html code.shiki .sAdtL{--shiki-default:#4078F2;--shiki-dark:#61AFEF}html pre.shiki code .s5ixo, html code.shiki .s5ixo{--shiki-default:#383A42;--shiki-dark:#ABB2BF}html pre.shiki code .sNmU0, html code.shiki .sNmU0{--shiki-default:#986801;--shiki-dark:#E5C07B}html pre.shiki code .s_Sar, html code.shiki .s_Sar{--shiki-default:#0184BC;--shiki-dark:#56B6C2}html pre.shiki code .sDhpE, html code.shiki .sDhpE{--shiki-default:#50A14F;--shiki-dark:#98C379}html pre.shiki code .s7GmK, html code.shiki .s7GmK{--shiki-default:#383A42;--shiki-dark:#E5C07B}html pre.shiki code .s2QsP, html code.shiki .s2QsP{--shiki-default:#E45649;--shiki-dark:#E5C07B}html pre.shiki code .sz0mV, html code.shiki .sz0mV{--shiki-default:#383A42;--shiki-dark:#E06C75}html pre.shiki code .sJa8x, html code.shiki .sJa8x{--shiki-default:#E45649;--shiki-dark:#E06C75}html .default .shiki span {color: var(--shiki-default);background: var(--shiki-default-bg);font-style: var(--shiki-default-font-style);font-weight: var(--shiki-default-font-weight);text-decoration: var(--shiki-default-text-decoration);}html .shiki span {color: var(--shiki-default);background: var(--shiki-default-bg);font-style: var(--shiki-default-font-style);font-weight: var(--shiki-default-font-weight);text-decoration: var(--shiki-default-text-decoration);}html .dark .shiki span {color: var(--shiki-dark);background: var(--shiki-dark-bg);font-style: var(--shiki-dark-font-style);font-weight: var(--shiki-dark-font-weight);text-decoration: var(--shiki-dark-text-decoration);}html.dark .shiki span {color: var(--shiki-dark);background: var(--shiki-dark-bg);font-style: var(--shiki-dark-font-style);font-weight: var(--shiki-dark-font-weight);text-decoration: var(--shiki-dark-text-decoration);}html pre.shiki code .s8iYz, html code.shiki .s8iYz{--shiki-default:#383A42;--shiki-default-font-style:inherit;--shiki-dark:#E06C75;--shiki-dark-font-style:italic}html pre.shiki code .st7oF, html code.shiki .st7oF{--shiki-default:#0184BC;--shiki-dark:#ABB2BF}html pre.shiki code .sq3v1, html code.shiki .sq3v1{--shiki-default:#E45649;--shiki-dark:#C678DD}html pre.shiki code .sAGMh, html code.shiki .sAGMh{--shiki-default:#986801;--shiki-dark:#D19A66}html pre.shiki code .sAOjX, html code.shiki .sAOjX{--shiki-default:#CA1243;--shiki-dark:#C678DD}html pre.shiki code .sMj0N, html code.shiki .sMj0N{--shiki-default:#50A14F;--shiki-dark:#ABB2BF}html pre.shiki code .sWwuK, html code.shiki .sWwuK{--shiki-default:#CA1243;--shiki-dark:#98C379}",{"title":135,"searchDepth":3,"depth":3,"links":5497},[],{"title":5499,"date":5500,"path":5501,"tags":5502,"body":5504},"基于 Cloudflare Workers 实现的在线服务状态检测告警系统","2025-01-18 02:00:08","/2025/01/18/service-status-monitor-based-on-cloudflare-workers",[4648,14,5503,1571],"crontab",{"type":16,"value":5505,"toc":6150},[5506,5509,5516,5519,5525,5541,5544,5558,5561,5572,5579,5586,5592,5596,5609,5612,5620,5638,5649,5655,5662,5665,5682,5689,5716,5719,5945,5948,5971,5974,5980,5983,5992,6067,6070,6073,6085,6088,6100,6103,6110,6115,6118,6124,6126,6133,6140,6147],[19,5507,5508],{"id":5508},"起因",[101,5510,5511,5512,5515],{},"受一些客观因素的影响，微精弘前一阵子针对学校教务系统的数据爬取服务状态出现了非常不稳定的状态，而后端在设计初并没有考虑到异常告警机制，恰逢现任员工都身陷期末周的痛苦之中，我这种计院 Lite 专业的精弘老人就打算实现一个针对「",[210,5513,5514],{},"微精弘主后端 \u003C->  funnel 爬虫服务 \u003C-> 教务系统","」这一条链路的告警机制。旨在短期内（即期末周结束之前）填补微精弘的后端服务告警机制的空白，让运维人员能够及时收到并处理排查后端网络链路的异常情况，尽最大努力保证服务在线率，保障工大本科生在期末周内使用体验。",[19,5517,5518],{"id":5518},"需求分析",[101,5520,5521],{},[984,5522],{"alt":5523,"src":5524},"微精弘的技术架构图","https://static.031130.xyz/uploads/2025/01/19/74362573e371d.webp",[205,5526,5527],{},[101,5528,5529,5530,5535,5536,611],{},"如果你不知道微精弘的具体架构实现，这里有一篇由前技术总监提笔并由现任技术总监完善的架构杂谈「",[44,5531,5534],{"href":5532,"rel":5533},"https://mp.weixin.qq.com/s/8d6JAPsLa4TzLr50uDG8uw",[48],"微精弘 | 架构杂谈","」，原文最初发表于前者的",[44,5537,5540],{"href":5538,"rel":5539},"https://blog.cnpatrickstar.com/posts/wejh-architecture/",[48],"博客",[101,5542,5543],{},"基于上述客观条件以及我个人在服务监控告警领域近乎为 0 的经验，我一拍脑袋提出了以下几点需求：",[595,5545,5546,5549,5552,5555],{},[26,5547,5548],{},"稳定性。告警服务本身必须要比我们的主后端更加稳定，这是告警服务的基础。",[26,5550,5551],{},"针对现有服务的侵入性低。告警服务不能影响到现有服务，最好能够完全分离开来，不应当部署在同一台服务器上。",[26,5553,5554],{},"开发快速。整个服务需要尽快落地，因为现有的服务在一周内出现了三次故障，且由于主动的监控告警机制的缺失，我们每次都要等服务 down 机的两小时后才意识到服务挂掉了，如果真在考试周这个使用高峰期内再出现这样的故障不容允许的（用户需要查询考场信息）。",[26,5556,5557],{},"尽可能低的运维成本。没什么好解释的，谁也不希望一个告警服务占用太多的运维成本，无论是人力上的还是资源上的。",[19,5559,5560],{"id":5560},"技术选型",[101,5562,5563,5564,5567,5568,5571],{},"结合我已有的经验，我选用了 ",[210,5565,5566],{},"Cloudflare Worker"," 来完成这个任务。Cloudflare Workers 本身是支持 ",[210,5569,5570],{},"cron job"," 的，能够以分钟级为单位的间隔对服务进行主动探测。Cloudflare 每天都有 10w 次免费的 Workers 调用额度，本身的服务在线率也过硬，唯一的缺点可能就是海外节点访问国内服务器的延迟过高了。不过考虑到我们探测的是在线情况而非延迟情况，倒也不是不能接受。",[101,5573,5574,5575,5578],{},"由于服务特性的关系，我们容许一定的访问失败概率。比如五次访问中如果有两三次失败，我们也认为线路是通的，",[1516,5576,5577],{},"可能只是教务系统的土豆快熟了","。因此并不是每一次失败的探测都需要进行告警。另外，我们还需要记录当前的服务状态，一旦服务被认定为下线状态，后续探测失败我们就不再进行告警，直到我们重新判定服务状态为上线（即每段连续的下线时间都只触发一次告警）。Cloudflare Worker 是一种 serverless 服务，且每次执行探测任务的可能都不是同一个 Cloudflare 的边缘节点，因此我们没法使用变量在内存中记录目前的服务状态，需要引入外部数据库来完成短期内的数据存储。",[101,5580,5581,5582,5585],{},"在数据库上，我们必须选择 Cloudflare 自家的在线数据库服务，通过 Cloudflare 自己内部的网络传输数据库查询结果才能得到尽可能低的延迟。在一番考量过后，KV 数据库和 SQL 数据库中，我果断选择了 ",[210,5583,5584],{},"Cloudflare D1"," 这个 SQL 数据库（本质是 SQLite），D1 数据库以更长的查询时间换取数据的实时性。Cloudflare 为免费用户提供了每天 500w 行读取和 10w 行写入的免费额度，只要好好加以利用，就不太可能超出限额。后续我还考虑通过这些数据库的数据使用 Cloudflare Worker 构建 uptime status 的后端 API，实现一个类似 status.openai.com 的在线服务状态可视化界面。",[101,5587,5588],{},[984,5589],{"alt":5590,"src":5591},"OpenAI 的 uptime status","https://static.031130.xyz/uploads/2025/01/19/f817539504140.webp",[19,5593,5595],{"id":5594},"登陆-wrangler","登陆 wrangler",[130,5597,5599],{"className":258,"code":5598,"language":260,"meta":135,"style":135},"wrangler login\n",[64,5600,5601],{"__ignoreMap":135},[139,5602,5603,5606],{"class":141,"line":142},[139,5604,5605],{"class":267},"wrangler",[139,5607,5608],{"class":167}," login\n",[19,5610,5611],{"id":5611},"项目初始化",[101,5613,5614,5615,5619],{},"由于之前有过一些编写 Cloudflare Workers 的经验，我深知在 Cloudflare 网页的 code server 编辑器上编辑单文件的 worker.js 的不便，选择使用 Cloudflare 官方推出的工具 ",[44,5616,5605],{"href":5617,"rel":5618},"https://developers.cloudflare.com/workers/wrangler/",[48]," 进行项目的初始化。",[130,5621,5623],{"className":258,"code":5622,"language":260,"meta":135,"style":135},"npm create cloudflare@latest wjh-monitor\n",[64,5624,5625],{"__ignoreMap":135},[139,5626,5627,5629,5632,5635],{"class":141,"line":142},[139,5628,268],{"class":267},[139,5630,5631],{"class":167}," create",[139,5633,5634],{"class":167}," cloudflare@latest",[139,5636,5637],{"class":167}," wjh-monitor\n",[205,5639,5640,5643,5646],{},[101,5641,5642],{},"Q: What would you like to start with?\nA: Hello World example",[101,5644,5645],{},"Q: Which template would you like to use?\nA: Hello World Worker",[101,5647,5648],{},"Q: Which language do you want to use?\nA: TypeScript",[101,5650,5651],{},[984,5652],{"alt":5653,"src":5654},"得到的项目结构","https://static.031130.xyz/uploads/2025/01/20/bf105c9fc18a3.webp",[101,5656,5657,5658,5661],{},"我们只需要在 ",[64,5659,5660],{},"index.ts"," 中编写我们的主要逻辑即可。",[19,5663,5664],{"id":5664},"数据库初始化",[130,5666,5668],{"className":258,"code":5667,"language":260,"meta":135,"style":135},"wrangler d1 create wjh-monitor-db\n",[64,5669,5670],{"__ignoreMap":135},[139,5671,5672,5674,5677,5679],{"class":141,"line":142},[139,5673,5605],{"class":267},[139,5675,5676],{"class":167}," d1",[139,5678,5631],{"class":167},[139,5680,5681],{"class":167}," wjh-monitor-db\n",[101,5683,5684,5685,5688],{},"随后会输出这些内容，我们需要把这些配置文件写入项目的 ",[64,5686,5687],{},"wrangler.toml"," 文件中",[130,5690,5694],{"className":5691,"code":5692,"language":5693,"meta":135,"style":135},"language-toml shiki shiki-themes one-light one-dark-pro","[[d1_databases]]\nbinding = \"DB\"\ndatabase_name = \"wjh-monitor-db\"\ndatabase_id = \"ffffffff-ffff-ffff-ffff-ffffffffffff\"\n","toml",[64,5695,5696,5701,5706,5711],{"__ignoreMap":135},[139,5697,5698],{"class":141,"line":142},[139,5699,5700],{},"[[d1_databases]]\n",[139,5702,5703],{"class":141,"line":3},[139,5704,5705],{},"binding = \"DB\"\n",[139,5707,5708],{"class":141,"line":158},[139,5709,5710],{},"database_name = \"wjh-monitor-db\"\n",[139,5712,5713],{"class":141,"line":174},[139,5714,5715],{},"database_id = \"ffffffff-ffff-ffff-ffff-ffffffffffff\"\n",[101,5717,5718],{},"编写一个 sql 文件创建数据表，并通过 wrangler 创建它",[130,5720,5724],{"className":5721,"code":5722,"language":5723,"meta":135,"style":135},"language-sql shiki shiki-themes one-light one-dark-pro","// schema.sql\nCREATE TABLE IF NOT EXISTS DATA (\n    id INTEGER PRIMARY KEY AUTOINCREMENT,\n    check_time TIMESTAMP DEFAULT CURRENT_TIMESTAMP,\n    check_item VARCHAR(10),\n    response_time INTEGER NOT NULL,\n    success BOOLEAN NOT NULL,\n    online_status BOOLEAN NOT NULL,\n    notify BOOLEAN DEFAULT FALSE,\n    other TEXT,\n    INDEX check_time_idx (check_time)\n);\nINSERT INTO DATA (\n        response_time,\n        success,\n        online_status,\n        notify,\n        other\n    )\nVALUES (100, 1, 1, 0, 'initial');\n","sql",[64,5725,5726,5739,5762,5776,5790,5806,5818,5830,5841,5853,5863,5871,5875,5884,5889,5894,5899,5904,5909,5914],{"__ignoreMap":135},[139,5727,5728,5731,5734,5736],{"class":141,"line":142},[139,5729,5730],{"class":145},"// ",[139,5732,5733],{"class":453},"schema",[139,5735,1064],{"class":145},[139,5737,5738],{"class":453},"sql\n",[139,5740,5741,5744,5747,5750,5753,5756,5759],{"class":141,"line":3},[139,5742,5743],{"class":1023},"CREATE",[139,5745,5746],{"class":1023}," TABLE",[139,5748,5749],{"class":267}," IF",[139,5751,5752],{"class":1023}," NOT",[139,5754,5755],{"class":1023}," EXISTS",[139,5757,5758],{"class":1023}," DATA",[139,5760,5761],{"class":145}," (\n",[139,5763,5764,5767,5770,5773],{"class":141,"line":158},[139,5765,5766],{"class":145},"    id ",[139,5768,5769],{"class":1023},"INTEGER",[139,5771,5772],{"class":1023}," PRIMARY KEY",[139,5774,5775],{"class":145}," AUTOINCREMENT,\n",[139,5777,5778,5781,5784,5787],{"class":141,"line":174},[139,5779,5780],{"class":145},"    check_time ",[139,5782,5783],{"class":1023},"TIMESTAMP",[139,5785,5786],{"class":1023}," DEFAULT",[139,5788,5789],{"class":145}," CURRENT_TIMESTAMP,\n",[139,5791,5792,5795,5798,5800,5803],{"class":141,"line":185},[139,5793,5794],{"class":145},"    check_item ",[139,5796,5797],{"class":1023},"VARCHAR",[139,5799,2593],{"class":145},[139,5801,5802],{"class":453},"10",[139,5804,5805],{"class":145},"),\n",[139,5807,5808,5811,5813,5816],{"class":141,"line":191},[139,5809,5810],{"class":145},"    response_time ",[139,5812,5769],{"class":1023},[139,5814,5815],{"class":1023}," NOT NULL",[139,5817,171],{"class":145},[139,5819,5820,5823,5826,5828],{"class":141,"line":328},[139,5821,5822],{"class":145},"    success ",[139,5824,5825],{"class":1023},"BOOLEAN",[139,5827,5815],{"class":1023},[139,5829,171],{"class":145},[139,5831,5832,5835,5837,5839],{"class":141,"line":334},[139,5833,5834],{"class":145},"    online_status ",[139,5836,5825],{"class":1023},[139,5838,5815],{"class":1023},[139,5840,171],{"class":145},[139,5842,5843,5846,5848,5850],{"class":141,"line":340},[139,5844,5845],{"class":145},"    notify ",[139,5847,5825],{"class":1023},[139,5849,5786],{"class":1023},[139,5851,5852],{"class":145}," FALSE,\n",[139,5854,5855,5858,5861],{"class":141,"line":346},[139,5856,5857],{"class":145},"    other ",[139,5859,5860],{"class":1023},"TEXT",[139,5862,171],{"class":145},[139,5864,5865,5868],{"class":141,"line":352},[139,5866,5867],{"class":1023},"    INDEX",[139,5869,5870],{"class":145}," check_time_idx (check_time)\n",[139,5872,5873],{"class":141,"line":358},[139,5874,1183],{"class":145},[139,5876,5877,5880,5882],{"class":141,"line":364},[139,5878,5879],{"class":1023},"INSERT INTO",[139,5881,5758],{"class":1023},[139,5883,5761],{"class":145},[139,5885,5886],{"class":141,"line":370},[139,5887,5888],{"class":145},"        response_time,\n",[139,5890,5891],{"class":141,"line":376},[139,5892,5893],{"class":145},"        success,\n",[139,5895,5896],{"class":141,"line":382},[139,5897,5898],{"class":145},"        online_status,\n",[139,5900,5901],{"class":141,"line":388},[139,5902,5903],{"class":145},"        notify,\n",[139,5905,5906],{"class":141,"line":394},[139,5907,5908],{"class":145},"        other\n",[139,5910,5911],{"class":141,"line":400},[139,5912,5913],{"class":145},"    )\n",[139,5915,5916,5919,5921,5924,5926,5929,5931,5933,5935,5938,5940,5943],{"class":141,"line":406},[139,5917,5918],{"class":1023},"VALUES",[139,5920,1027],{"class":145},[139,5922,5923],{"class":453},"100",[139,5925,2711],{"class":145},[139,5927,5928],{"class":453},"1",[139,5930,2711],{"class":145},[139,5932,5928],{"class":453},[139,5934,2711],{"class":145},[139,5936,5937],{"class":453},"0",[139,5939,2711],{"class":145},[139,5941,5942],{"class":167},"'initial'",[139,5944,1183],{"class":145},[101,5946,5947],{},"使用 sql 文件创建远程数据表",[130,5949,5951],{"className":258,"code":5950,"language":260,"meta":135,"style":135},"wrangler d1 execute wjh-monitor-db --remote --file=./schema.sql\n",[64,5952,5953],{"__ignoreMap":135},[139,5954,5955,5957,5959,5962,5965,5968],{"class":141,"line":142},[139,5956,5605],{"class":267},[139,5958,5676],{"class":167},[139,5960,5961],{"class":167}," execute",[139,5963,5964],{"class":167}," wjh-monitor-db",[139,5966,5967],{"class":453}," --remote",[139,5969,5970],{"class":453}," --file=./schema.sql\n",[101,5972,5973],{},"随后我们可以使用 wrangler 在远程数据库上执行 query 命令，并获得相应的结果",[130,5975,5978],{"className":5976,"code":5977,"language":669},[667],"wrangler d1 execute wjh-monitor-db --remote --command='SELECT * FROM DATA'\n",[64,5979,5977],{"__ignoreMap":135},[19,5981,5982],{"id":5982},"主体逻辑编写",[101,5984,5985,5986,5991],{},"说实话，代码部分没什么太多好说的，正要了解思路直接去看",[44,5987,5990],{"href":5988,"rel":5989},"https://github.com/zhullyb/wjh-monitor",[48],"源码","就好。我在这里简单提两点。",[595,5993,5994,6004,6013],{},[26,5995,5996,5997,6000,6001,6003],{},"目录下的 ",[64,5998,5999],{},"worker-configuration.d.ts"," 定义了 env 变量的类型定义，如果我们在项目中绑定了一些变量（比如我们在 ",[64,6002,5687],{}," 中绑定了 d1 数据库，变量名为 DB），需要在这里声明以防止后续 TypeScript 的报错。",[26,6005,568,6006,6009,6010,6012],{},[64,6007,6008],{},"export default {}"," 中是将会被导出的主要函数，Hello World 项目编写了 fetch 函数，这是在 workers 被通过 http 方式访问时所调用的，如果要使用 cron job 功能，我们需要编写 scheduled 函数来被 workers 调用，并在 ",[64,6011,5687],{}," 中配置好 crontab 触发器。",[26,6014,6015,6016,6018,6019,6024,6025],{},"我们在 ",[64,6017,5687],{}," 中绑定了 DB 变量作为数据库的快捷访问方式，因此我们可以在代码中通过 ",[44,6020,6023],{"href":6021,"rel":6022},"https://developers.cloudflare.com/d1/worker-api/",[48],"D1 数据库的 Workers Binding API"," 来实现针对数据库的快捷操作，如",[130,6026,6028],{"className":1014,"code":6027,"language":1016,"meta":135,"style":135},"const res = await env.DB.prepare(\"SELECT * FROM DATA ORDER BY check_time DESC LIMIT 4\").run();\n",[64,6029,6030],{"__ignoreMap":135},[139,6031,6032,6034,6037,6039,6041,6044,6046,6049,6051,6054,6056,6059,6062,6065],{"class":141,"line":142},[139,6033,2576],{"class":1023},[139,6035,6036],{"class":2579}," res",[139,6038,1075],{"class":1034},[139,6040,4839],{"class":1023},[139,6042,6043],{"class":1060}," env",[139,6045,1064],{"class":145},[139,6047,6048],{"class":1067},"DB",[139,6050,1064],{"class":145},[139,6052,6053],{"class":267},"prepare",[139,6055,2593],{"class":145},[139,6057,6058],{"class":167},"\"SELECT * FROM DATA ORDER BY check_time DESC LIMIT 4\"",[139,6060,6061],{"class":145},").",[139,6063,6064],{"class":267},"run",[139,6066,2752],{"class":145},[101,6068,6069],{},"需要注意的是，workers 不存在上下文，每一次访问的处理都是前后独立的，如果你需要临时存储一些数据，不要使用变量，一定要存入持久化存储的数据库。",[101,6071,6072],{},"预览:",[130,6074,6076],{"className":258,"code":6075,"language":260,"meta":135,"style":135},"wrangler dev\n",[64,6077,6078],{"__ignoreMap":135},[139,6079,6080,6082],{"class":141,"line":142},[139,6081,5605],{"class":267},[139,6083,6084],{"class":167}," dev\n",[101,6086,6087],{},"部署:",[130,6089,6091],{"className":258,"code":6090,"language":260,"meta":135,"style":135},"wrangler deploy\n",[64,6092,6093],{"__ignoreMap":135},[139,6094,6095,6097],{"class":141,"line":142},[139,6096,5605],{"class":267},[139,6098,6099],{"class":167}," deploy\n",[19,6101,6102],{"id":6102},"小插曲",[101,6104,6105,6106,6109],{},"由于我对后端经验的缺乏，我在编写 sql 语句时没有意识到建立索引的重要性。我在查询时使用了 ",[64,6107,6108],{},"ORDER BY \u003C未建立索引字段> LIMIT 5"," 的方式来查询最近五次的记录，这导致数据库不得不在我每次查询时都完整遍历一遍整张表。随着 cronjob 每分钟运行时插入一条新数据，记录的行数随时间增加，每次查询的成本也逐渐增加，最终造成了单日访问八百多万行的记录，超出了 Cloudflare 的免费额度，一度造成了项目被迫下线的风险。",[101,6111,6112],{},[984,6113],{"alt":135,"src":6114},"https://static.031130.xyz/uploads/2025/01/20/fb463f45038ac.webp",[101,6116,6117],{},"所幸 Cloudflare 没有给我停机，而我也及时定位到了问题并补建了索引，使每日的读取量回到了正常的状态。",[101,6119,6120],{},[984,6121],{"alt":6122,"src":6123},"蓝色线条为读取，黄色线条为写入","https://static.031130.xyz/uploads/2025/01/19/83f69aff3a7b4.webp",[19,6125,816],{"id":816},[101,6127,6128],{},[44,6129,6132],{"href":6130,"rel":6131},"https://developers.cloudflare.com/d1/",[48],"Cloudflare D1 · Cloudflare D1 docs",[101,6134,6135],{},[44,6136,6139],{"href":6137,"rel":6138},"https://developers.cloudflare.com/workers/configuration/cron-triggers/",[48],"Cron Triggers · Cloudflare Workers docs",[101,6141,6142],{},[44,6143,6146],{"href":6144,"rel":6145},"https://blog.sww.moe/post/cloudflare-d1/",[48],"Cloudflare D1 使用记录",[926,6148,6149],{},"html pre.shiki code .sAdtL, html code.shiki .sAdtL{--shiki-default:#4078F2;--shiki-dark:#61AFEF}html pre.shiki code .sDhpE, html code.shiki .sDhpE{--shiki-default:#50A14F;--shiki-dark:#98C379}html .default .shiki span {color: var(--shiki-default);background: var(--shiki-default-bg);font-style: var(--shiki-default-font-style);font-weight: var(--shiki-default-font-weight);text-decoration: var(--shiki-default-text-decoration);}html .shiki span {color: var(--shiki-default);background: var(--shiki-default-bg);font-style: var(--shiki-default-font-style);font-weight: var(--shiki-default-font-weight);text-decoration: var(--shiki-default-text-decoration);}html .dark .shiki span {color: var(--shiki-dark);background: var(--shiki-dark-bg);font-style: var(--shiki-dark-font-style);font-weight: var(--shiki-dark-font-weight);text-decoration: var(--shiki-dark-text-decoration);}html.dark .shiki span {color: var(--shiki-dark);background: var(--shiki-dark-bg);font-style: var(--shiki-dark-font-style);font-weight: var(--shiki-dark-font-weight);text-decoration: var(--shiki-dark-text-decoration);}html pre.shiki code .s5ixo, html code.shiki .s5ixo{--shiki-default:#383A42;--shiki-dark:#ABB2BF}html pre.shiki code .sAGMh, html code.shiki .sAGMh{--shiki-default:#986801;--shiki-dark:#D19A66}html pre.shiki code .sLKXg, html code.shiki .sLKXg{--shiki-default:#A626A4;--shiki-dark:#C678DD}html pre.shiki code .sNmU0, html code.shiki .sNmU0{--shiki-default:#986801;--shiki-dark:#E5C07B}html pre.shiki code .s_Sar, html code.shiki .s_Sar{--shiki-default:#0184BC;--shiki-dark:#56B6C2}html pre.shiki code .s7GmK, html code.shiki .s7GmK{--shiki-default:#383A42;--shiki-dark:#E5C07B}html pre.shiki code .s2QsP, html code.shiki .s2QsP{--shiki-default:#E45649;--shiki-dark:#E5C07B}",{"title":135,"searchDepth":3,"depth":3,"links":6151},[6152,6153,6154,6155,6156,6157,6158,6159,6160],{"id":5508,"depth":3,"text":5508},{"id":5518,"depth":3,"text":5518},{"id":5560,"depth":3,"text":5560},{"id":5594,"depth":3,"text":5595},{"id":5611,"depth":3,"text":5611},{"id":5664,"depth":3,"text":5664},{"id":5982,"depth":3,"text":5982},{"id":6102,"depth":3,"text":6102},{"id":816,"depth":3,"text":816},{"title":6162,"date":6163,"path":6164,"tags":6165,"body":6167},"构建部署在 Cloudflare Workers 上的 TG Bot","2024-12-30 19:45:43","/2024/12/30/tg-bot-hosted-on-cloudflare-workers",[6166,4648],"Bot",{"type":16,"value":6168,"toc":7444},[6169,6171,6182,6194,6197,6201,6209,6217,6220,6222,6225,6228,6231,6234,6241,6288,6291,6294,6524,6527,6530,6996,6999,7418,7422,7425,7428,7433,7436,7441],[19,6170,5508],{"id":5508},[101,6172,6173,6174,6178,6179],{},"早在去年 10 月，我就写过一篇",[44,6175,6177],{"href":6176},"/2023/10/29/create-b23tv-remover-bot/","《创建 b23.tv 追踪参数移除 bot》","。记录了部署 b23.tv 的追踪参数移除 Bot 的部署方案。其中提到的 TG Bot 随着服务器到期不再续费也一同落灰了——",[210,6180,6181],{},"公益服务总是这样，开始时满腔热血，随着时间散去没有多少人能坚持投入成本，徒留下一地鸡毛。",[101,6183,6184,6185,6190,6191],{},"大概半个月前，我在群里看见 ",[44,6186,6189],{"href":6187,"rel":6188},"https://asukaminato.eu.org/",[48],"Asuka Minato"," 开发的群消息总结 Bot，整体部署在 Cloudflare Workers 上，在保证零运营成本的情况下有着相当非常不错的在线率保证，因此便考虑将这个 Bot 迁移到 Cloudflare Workers 上。",[210,6192,6193],{},"选用免费的 serverless 能够有效延长服务的可持续性，它不需要额外投入时间精力和财力进行维护，通常可以活很久。",[101,6195,6196],{},"之所以可以把 TG Bot 部署到 Cloudflare Workers 上，主要是得益于 TG 平台支持 webhook 的方式让 Bot 程序提供服务。我们所需要提供的是一个公网能访问的 http 地址，在成功注册 webhook 服务后，TG 的官方服务器会将所有 Bot 所在群或者和所有对个人的对话以 http 请求的方式打到这个 url 上，而 Cloudflare Workers 平台就能提供一个 workers.dev 结尾的公网 url 作为 webhook 提供给 TG 服务器。",[19,6198,6200],{"id":6199},"怎么做","怎么做？",[101,6202,6203,6208],{},[44,6204,6207],{"href":6205,"rel":6206},"https://github.com/cvzi/telegram-bot-cloudflare",[48],"在这个 Github 仓库中","，给出了不少例子，用以讲述如何利用 Cloudflare Workers 构建 TG Bot。",[101,6210,568,6211,6216],{},[44,6212,6215],{"href":6213,"rel":6214},"https://github.com/cvzi/telegram-bot-cloudflare/blob/main/bot.js",[48],"bot.js"," 这个文件中编写了一个最简单的 TG Bot，其功能是: 将受到的所有消息在头部添加「Echo:」字符串，并发送回刚才的对话。",[101,6218,6219],{},"例: 用户发送 「Hello」，bot 回复 「Echo: Hello」",[4357,6221],{},[19,6223,6224],{"id":6224},"代码分析",[101,6226,6227],{},"代码整体分为四个部分",[96,6229,6230],{"id":6230},"顶部变量",[101,6232,6233],{},"文件顶部定义了 Bot 的 token、webhook 的 url 路径以及一个简易的 webhook 密码。",[101,6235,6236,6237,6240],{},"TOKEN 是从 botfather 那里获得的 bot token，SECRET 是自己设置的 webhook 密码，TG 的 webhook 服务器会通过把这个字段添加到名为 ",[64,6238,6239],{},"X-Telegram-Bot-Api-Secret-Token"," 的请求头中来证明自己的官方身份。",[130,6242,6244],{"className":1014,"code":6243,"language":1016,"meta":135,"style":135},"const TOKEN = ENV_BOT_TOKEN // Get it from @BotFather https://core.telegram.org/bots#6-botfather\nconst WEBHOOK = '/endpoint'\nconst SECRET = ENV_BOT_SECRET // A-Z, a-z, 0-9, _ and -\n",[64,6245,6246,6261,6273],{"__ignoreMap":135},[139,6247,6248,6250,6253,6255,6258],{"class":141,"line":142},[139,6249,2576],{"class":1023},[139,6251,6252],{"class":2579}," TOKEN",[139,6254,1075],{"class":1034},[139,6256,6257],{"class":2579}," ENV_BOT_TOKEN",[139,6259,6260],{"class":444}," // Get it from @BotFather https://core.telegram.org/bots#6-botfather\n",[139,6262,6263,6265,6268,6270],{"class":141,"line":3},[139,6264,2576],{"class":1023},[139,6266,6267],{"class":2579}," WEBHOOK",[139,6269,1075],{"class":1034},[139,6271,6272],{"class":167}," '/endpoint'\n",[139,6274,6275,6277,6280,6282,6285],{"class":141,"line":158},[139,6276,2576],{"class":1023},[139,6278,6279],{"class":2579}," SECRET",[139,6281,1075],{"class":1034},[139,6283,6284],{"class":2579}," ENV_BOT_SECRET",[139,6286,6287],{"class":444}," // A-Z, a-z, 0-9, _ and -\n",[96,6289,6290],{"id":6290},"简易路由",[101,6292,6293],{},"紧接着定义了一个简易的路由",[130,6295,6297],{"className":1014,"code":6296,"language":1016,"meta":135,"style":135},"addEventListener('fetch', event => {\n  const url = new URL(event.request.url)\n  if (url.pathname === WEBHOOK) {\n    event.respondWith(handleWebhook(event))\n  } else if (url.pathname === '/registerWebhook') {\n    event.respondWith(registerWebhook(event, url, WEBHOOK, SECRET))\n  } else if (url.pathname === '/unRegisterWebhook') {\n    event.respondWith(unRegisterWebhook(event))\n  } else {\n    event.respondWith(new Response('No handler for this request'))\n  }\n})\n",[64,6298,6299,6317,6344,6364,6386,6410,6443,6466,6485,6493,6515,6519],{"__ignoreMap":135},[139,6300,6301,6304,6306,6309,6311,6313,6315],{"class":141,"line":142},[139,6302,6303],{"class":267},"addEventListener",[139,6305,2593],{"class":145},[139,6307,6308],{"class":167},"'fetch'",[139,6310,2711],{"class":145},[139,6312,5196],{"class":2926},[139,6314,2929],{"class":1023},[139,6316,1055],{"class":145},[139,6318,6319,6322,6324,6326,6328,6330,6332,6334,6336,6338,6340,6342],{"class":141,"line":3},[139,6320,6321],{"class":1023},"  const",[139,6323,4761],{"class":2579},[139,6325,1075],{"class":1034},[139,6327,4766],{"class":1023},[139,6329,4769],{"class":267},[139,6331,2593],{"class":145},[139,6333,5196],{"class":1060},[139,6335,1064],{"class":145},[139,6337,5146],{"class":1067},[139,6339,1064],{"class":145},[139,6341,4847],{"class":151},[139,6343,475],{"class":145},[139,6345,6346,6348,6350,6352,6354,6357,6360,6362],{"class":141,"line":158},[139,6347,2936],{"class":1023},[139,6349,1027],{"class":145},[139,6351,4847],{"class":1060},[139,6353,1064],{"class":145},[139,6355,6356],{"class":151},"pathname",[139,6358,6359],{"class":1034}," ===",[139,6361,6267],{"class":2579},[139,6363,1041],{"class":145},[139,6365,6366,6369,6371,6374,6376,6379,6381,6383],{"class":141,"line":174},[139,6367,6368],{"class":1060},"    event",[139,6370,1064],{"class":145},[139,6372,6373],{"class":267},"respondWith",[139,6375,2593],{"class":145},[139,6377,6378],{"class":267},"handleWebhook",[139,6380,2593],{"class":145},[139,6382,5196],{"class":1030},[139,6384,6385],{"class":145},"))\n",[139,6387,6388,6390,6392,6395,6397,6399,6401,6403,6405,6408],{"class":141,"line":185},[139,6389,2987],{"class":145},[139,6391,2990],{"class":1023},[139,6393,6394],{"class":1023}," if",[139,6396,1027],{"class":145},[139,6398,4847],{"class":1060},[139,6400,1064],{"class":145},[139,6402,6356],{"class":151},[139,6404,6359],{"class":1034},[139,6406,6407],{"class":167}," '/registerWebhook'",[139,6409,1041],{"class":145},[139,6411,6412,6414,6416,6418,6420,6423,6425,6427,6429,6431,6433,6436,6438,6441],{"class":141,"line":191},[139,6413,6368],{"class":1060},[139,6415,1064],{"class":145},[139,6417,6373],{"class":267},[139,6419,2593],{"class":145},[139,6421,6422],{"class":267},"registerWebhook",[139,6424,2593],{"class":145},[139,6426,5196],{"class":1030},[139,6428,2711],{"class":145},[139,6430,4847],{"class":1030},[139,6432,2711],{"class":145},[139,6434,6435],{"class":2579},"WEBHOOK",[139,6437,2711],{"class":145},[139,6439,6440],{"class":2579},"SECRET",[139,6442,6385],{"class":145},[139,6444,6445,6447,6449,6451,6453,6455,6457,6459,6461,6464],{"class":141,"line":328},[139,6446,2987],{"class":145},[139,6448,2990],{"class":1023},[139,6450,6394],{"class":1023},[139,6452,1027],{"class":145},[139,6454,4847],{"class":1060},[139,6456,1064],{"class":145},[139,6458,6356],{"class":151},[139,6460,6359],{"class":1034},[139,6462,6463],{"class":167}," '/unRegisterWebhook'",[139,6465,1041],{"class":145},[139,6467,6468,6470,6472,6474,6476,6479,6481,6483],{"class":141,"line":334},[139,6469,6368],{"class":1060},[139,6471,1064],{"class":145},[139,6473,6373],{"class":267},[139,6475,2593],{"class":145},[139,6477,6478],{"class":267},"unRegisterWebhook",[139,6480,2593],{"class":145},[139,6482,5196],{"class":1030},[139,6484,6385],{"class":145},[139,6486,6487,6489,6491],{"class":141,"line":340},[139,6488,2987],{"class":145},[139,6490,2990],{"class":1023},[139,6492,1055],{"class":145},[139,6494,6495,6497,6499,6501,6503,6506,6508,6510,6513],{"class":141,"line":346},[139,6496,6368],{"class":1060},[139,6498,1064],{"class":145},[139,6500,6373],{"class":267},[139,6502,2593],{"class":145},[139,6504,6505],{"class":1023},"new",[139,6507,5168],{"class":267},[139,6509,2593],{"class":145},[139,6511,6512],{"class":167},"'No handler for this request'",[139,6514,6385],{"class":145},[139,6516,6517],{"class":141,"line":352},[139,6518,188],{"class":145},[139,6520,6521],{"class":141,"line":358},[139,6522,6523],{"class":145},"})\n",[96,6525,6526],{"id":6526},"核心功能",[101,6528,6529],{},"随后的三个函数，会先进行 SECRET 的校验，并将 message 类型消息从 TG 的所有消息类型中分离开单独处理",[130,6531,6533],{"className":1014,"code":6532,"language":1016,"meta":135,"style":135},"/**\n * Handle requests to WEBHOOK\n * https://core.telegram.org/bots/api#update\n */\nasync function handleWebhook (event) {\n  // Check secret\n  if (event.request.headers.get('X-Telegram-Bot-Api-Secret-Token') !== SECRET) {\n    return new Response('Unauthorized', { status: 403 })\n  }\n\n  // Read request body synchronously\n  const update = await event.request.json()\n  // Deal with response asynchronously\n  event.waitUntil(onUpdate(update))\n\n  return new Response('Ok')\n}\n\n/**\n * Handle incoming Update\n * https://core.telegram.org/bots/api#update\n */\nasync function onUpdate (update) {\n  if ('message' in update) {\n    await onMessage(update.message)\n  }\n}\n\n/**\n * Handle incoming Message\n * https://core.telegram.org/bots/api#message\n */\nfunction onMessage (message) {\n  return sendPlainText(message.chat.id, 'Echo:\\n' + message.text)\n}\n\n/**\n * Send plain text message\n * https://core.telegram.org/bots/api#sendmessage\n */\nasync function sendPlainText (chatId, text) {\n  return (await fetch(apiUrl('sendMessage', {\n    chat_id: chatId,\n    text\n  }))).json()\n",[64,6534,6535,6540,6545,6550,6555,6570,6575,6612,6639,6643,6647,6652,6676,6681,6703,6707,6723,6727,6731,6735,6740,6744,6748,6763,6778,6796,6801,6806,6811,6816,6822,6828,6833,6847,6891,6896,6901,6906,6912,6918,6923,6943,6967,6980,6986],{"__ignoreMap":135},[139,6536,6537],{"class":141,"line":142},[139,6538,6539],{"class":444},"/**\n",[139,6541,6542],{"class":141,"line":3},[139,6543,6544],{"class":444}," * Handle requests to WEBHOOK\n",[139,6546,6547],{"class":141,"line":158},[139,6548,6549],{"class":444}," * https://core.telegram.org/bots/api#update\n",[139,6551,6552],{"class":141,"line":174},[139,6553,6554],{"class":444}," */\n",[139,6556,6557,6559,6561,6564,6566,6568],{"class":141,"line":185},[139,6558,4713],{"class":1023},[139,6560,4716],{"class":1023},[139,6562,6563],{"class":267}," handleWebhook",[139,6565,1027],{"class":145},[139,6567,5196],{"class":2926},[139,6569,1041],{"class":145},[139,6571,6572],{"class":141,"line":191},[139,6573,6574],{"class":444},"  // Check secret\n",[139,6576,6577,6579,6581,6583,6585,6587,6589,6592,6594,6597,6599,6602,6605,6608,6610],{"class":141,"line":328},[139,6578,2936],{"class":1023},[139,6580,1027],{"class":145},[139,6582,5196],{"class":1060},[139,6584,1064],{"class":145},[139,6586,5146],{"class":1067},[139,6588,1064],{"class":145},[139,6590,6591],{"class":1067},"headers",[139,6593,1064],{"class":145},[139,6595,6596],{"class":267},"get",[139,6598,2593],{"class":145},[139,6600,6601],{"class":167},"'X-Telegram-Bot-Api-Secret-Token'",[139,6603,6604],{"class":145},") ",[139,6606,6607],{"class":1034},"!==",[139,6609,6279],{"class":2579},[139,6611,1041],{"class":145},[139,6613,6614,6616,6618,6620,6622,6625,6628,6631,6633,6636],{"class":141,"line":334},[139,6615,4918],{"class":1023},[139,6617,4766],{"class":1023},[139,6619,5168],{"class":267},[139,6621,2593],{"class":145},[139,6623,6624],{"class":167},"'Unauthorized'",[139,6626,6627],{"class":145},", { ",[139,6629,6630],{"class":151},"status",[139,6632,4089],{"class":4979},[139,6634,6635],{"class":453}," 403",[139,6637,6638],{"class":145}," })\n",[139,6640,6641],{"class":141,"line":340},[139,6642,188],{"class":145},[139,6644,6645],{"class":141,"line":346},[139,6646,517],{"emptyLinePlaceholder":516},[139,6648,6649],{"class":141,"line":352},[139,6650,6651],{"class":444},"  // Read request body synchronously\n",[139,6653,6654,6656,6659,6661,6663,6666,6668,6670,6672,6674],{"class":141,"line":358},[139,6655,6321],{"class":1023},[139,6657,6658],{"class":2579}," update",[139,6660,1075],{"class":1034},[139,6662,4839],{"class":1023},[139,6664,6665],{"class":1060}," event",[139,6667,1064],{"class":145},[139,6669,5146],{"class":1067},[139,6671,1064],{"class":145},[139,6673,134],{"class":267},[139,6675,4869],{"class":145},[139,6677,6678],{"class":141,"line":364},[139,6679,6680],{"class":444},"  // Deal with response asynchronously\n",[139,6682,6683,6686,6688,6691,6693,6696,6698,6701],{"class":141,"line":370},[139,6684,6685],{"class":1060},"  event",[139,6687,1064],{"class":145},[139,6689,6690],{"class":267},"waitUntil",[139,6692,2593],{"class":145},[139,6694,6695],{"class":267},"onUpdate",[139,6697,2593],{"class":145},[139,6699,6700],{"class":1030},"update",[139,6702,6385],{"class":145},[139,6704,6705],{"class":141,"line":376},[139,6706,517],{"emptyLinePlaceholder":516},[139,6708,6709,6712,6714,6716,6718,6721],{"class":141,"line":382},[139,6710,6711],{"class":1023},"  return",[139,6713,4766],{"class":1023},[139,6715,5168],{"class":267},[139,6717,2593],{"class":145},[139,6719,6720],{"class":167},"'Ok'",[139,6722,475],{"class":145},[139,6724,6725],{"class":141,"line":388},[139,6726,194],{"class":145},[139,6728,6729],{"class":141,"line":394},[139,6730,517],{"emptyLinePlaceholder":516},[139,6732,6733],{"class":141,"line":400},[139,6734,6539],{"class":444},[139,6736,6737],{"class":141,"line":406},[139,6738,6739],{"class":444}," * Handle incoming Update\n",[139,6741,6742],{"class":141,"line":412},[139,6743,6549],{"class":444},[139,6745,6746],{"class":141,"line":418},[139,6747,6554],{"class":444},[139,6749,6750,6752,6754,6757,6759,6761],{"class":141,"line":5462},[139,6751,4713],{"class":1023},[139,6753,4716],{"class":1023},[139,6755,6756],{"class":267}," onUpdate",[139,6758,1027],{"class":145},[139,6760,6700],{"class":2926},[139,6762,1041],{"class":145},[139,6764,6765,6767,6769,6772,6774,6776],{"class":141,"line":5467},[139,6766,2936],{"class":1023},[139,6768,1027],{"class":145},[139,6770,6771],{"class":167},"'message'",[139,6773,3626],{"class":1023},[139,6775,6658],{"class":1030},[139,6777,1041],{"class":145},[139,6779,6780,6782,6785,6787,6789,6791,6794],{"class":141,"line":5472},[139,6781,2964],{"class":1023},[139,6783,6784],{"class":267}," onMessage",[139,6786,2593],{"class":145},[139,6788,6700],{"class":1060},[139,6790,1064],{"class":145},[139,6792,6793],{"class":151},"message",[139,6795,475],{"class":145},[139,6797,6799],{"class":141,"line":6798},26,[139,6800,188],{"class":145},[139,6802,6804],{"class":141,"line":6803},27,[139,6805,194],{"class":145},[139,6807,6809],{"class":141,"line":6808},28,[139,6810,517],{"emptyLinePlaceholder":516},[139,6812,6814],{"class":141,"line":6813},29,[139,6815,6539],{"class":444},[139,6817,6819],{"class":141,"line":6818},30,[139,6820,6821],{"class":444}," * Handle incoming Message\n",[139,6823,6825],{"class":141,"line":6824},31,[139,6826,6827],{"class":444}," * https://core.telegram.org/bots/api#message\n",[139,6829,6831],{"class":141,"line":6830},32,[139,6832,6554],{"class":444},[139,6834,6836,6839,6841,6843,6845],{"class":141,"line":6835},33,[139,6837,6838],{"class":1023},"function",[139,6840,6784],{"class":267},[139,6842,1027],{"class":145},[139,6844,6793],{"class":2926},[139,6846,1041],{"class":145},[139,6848,6850,6852,6855,6857,6859,6861,6864,6866,6869,6871,6874,6876,6879,6882,6885,6887,6889],{"class":141,"line":6849},34,[139,6851,6711],{"class":1023},[139,6853,6854],{"class":267}," sendPlainText",[139,6856,2593],{"class":145},[139,6858,6793],{"class":1060},[139,6860,1064],{"class":145},[139,6862,6863],{"class":1067},"chat",[139,6865,1064],{"class":145},[139,6867,6868],{"class":151},"id",[139,6870,2711],{"class":145},[139,6872,6873],{"class":167},"'Echo:",[139,6875,5404],{"class":1034},[139,6877,6878],{"class":167},"'",[139,6880,6881],{"class":1034}," +",[139,6883,6884],{"class":1060}," message",[139,6886,1064],{"class":145},[139,6888,669],{"class":151},[139,6890,475],{"class":145},[139,6892,6894],{"class":141,"line":6893},35,[139,6895,194],{"class":145},[139,6897,6899],{"class":141,"line":6898},36,[139,6900,517],{"emptyLinePlaceholder":516},[139,6902,6904],{"class":141,"line":6903},37,[139,6905,6539],{"class":444},[139,6907,6909],{"class":141,"line":6908},38,[139,6910,6911],{"class":444}," * Send plain text message\n",[139,6913,6915],{"class":141,"line":6914},39,[139,6916,6917],{"class":444}," * https://core.telegram.org/bots/api#sendmessage\n",[139,6919,6921],{"class":141,"line":6920},40,[139,6922,6554],{"class":444},[139,6924,6926,6928,6930,6932,6934,6937,6939,6941],{"class":141,"line":6925},41,[139,6927,4713],{"class":1023},[139,6929,4716],{"class":1023},[139,6931,6854],{"class":267},[139,6933,1027],{"class":145},[139,6935,6936],{"class":2926},"chatId",[139,6938,2711],{"class":145},[139,6940,669],{"class":2926},[139,6942,1041],{"class":145},[139,6944,6946,6948,6950,6953,6955,6957,6960,6962,6965],{"class":141,"line":6945},42,[139,6947,6711],{"class":1023},[139,6949,1027],{"class":145},[139,6951,6952],{"class":1023},"await",[139,6954,4842],{"class":267},[139,6956,2593],{"class":145},[139,6958,6959],{"class":267},"apiUrl",[139,6961,2593],{"class":145},[139,6963,6964],{"class":167},"'sendMessage'",[139,6966,5032],{"class":145},[139,6968,6970,6973,6975,6978],{"class":141,"line":6969},43,[139,6971,6972],{"class":151},"    chat_id",[139,6974,4089],{"class":4979},[139,6976,6977],{"class":1030}," chatId",[139,6979,171],{"class":145},[139,6981,6983],{"class":141,"line":6982},44,[139,6984,6985],{"class":1030},"    text\n",[139,6987,6989,6992,6994],{"class":141,"line":6988},45,[139,6990,6991],{"class":145},"  }))).",[139,6993,134],{"class":267},[139,6995,4869],{"class":145},[101,6997,6998],{},"我们需要更改的就是这个 onMessage 函数，用户输入的文本信息通过 message.text 获取，我们可以很轻易的把 b23 remover 的逻辑用 js 实现",[130,7000,7002],{"className":1014,"code":7001,"language":1016,"meta":135,"style":135},"async function onMessage(message) {\n    if (!message.text) {\n        return;\n    }\n    const b23Reg = /b23\\.tv\\/[a-zA-Z0-9]+/g;\n    if (!b23Reg.test(message.text)) {\n        console.log('No match found');\n    }\n    const b23Links = message.text.match(b23Reg);\n    const cleanLinks = [];\n    await Promise.all(\n        b23Links.map(link => b23Remover('https://' + link))\n    ).then(result => {\n        cleanLinks.push(...result);\n    });\n\n    const text2Send = \"Track ID removed:\\n\" + cleanLinks.join(\"\\n\");\n    return sendPlainText(message.chat.id, text2Send);\n}\n\nasync function b23Remover (url) {\n    const r = await fetch(url)\n    const v = r.url\n    const u = new URL(v)\n    return u.origin + u.pathname\n}\n",[64,7003,7004,7018,7035,7042,7046,7083,7109,7125,7129,7155,7167,7183,7215,7232,7250,7254,7258,7292,7317,7321,7325,7339,7358,7374,7394,7414],{"__ignoreMap":135},[139,7005,7006,7008,7010,7012,7014,7016],{"class":141,"line":142},[139,7007,4713],{"class":1023},[139,7009,4716],{"class":1023},[139,7011,6784],{"class":267},[139,7013,2593],{"class":145},[139,7015,6793],{"class":2926},[139,7017,1041],{"class":145},[139,7019,7020,7022,7024,7027,7029,7031,7033],{"class":141,"line":3},[139,7021,4874],{"class":1023},[139,7023,1027],{"class":145},[139,7025,7026],{"class":1034},"!",[139,7028,6793],{"class":1060},[139,7030,1064],{"class":145},[139,7032,669],{"class":151},[139,7034,1041],{"class":145},[139,7036,7037,7040],{"class":141,"line":158},[139,7038,7039],{"class":1023},"        return",[139,7041,1081],{"class":145},[139,7043,7044],{"class":141,"line":174},[139,7045,775],{"class":145},[139,7047,7048,7050,7053,7055,7059,7062,7065,7068,7071,7075,7078,7081],{"class":141,"line":185},[139,7049,2997],{"class":1023},[139,7051,7052],{"class":2579}," b23Reg",[139,7054,1075],{"class":1034},[139,7056,7058],{"class":7057},"sDaw7"," /b23",[139,7060,7061],{"class":1034},"\\.",[139,7063,7064],{"class":7057},"tv",[139,7066,7067],{"class":1034},"\\/",[139,7069,7070],{"class":453},"[a-zA-Z0-9]",[139,7072,7074],{"class":7073},"sYoRg","+",[139,7076,7077],{"class":7057},"/",[139,7079,7080],{"class":1023},"g",[139,7082,1081],{"class":145},[139,7084,7085,7087,7089,7091,7094,7096,7099,7101,7103,7105,7107],{"class":141,"line":191},[139,7086,4874],{"class":1023},[139,7088,1027],{"class":145},[139,7090,7026],{"class":1034},[139,7092,7093],{"class":1060},"b23Reg",[139,7095,1064],{"class":145},[139,7097,7098],{"class":267},"test",[139,7100,2593],{"class":145},[139,7102,6793],{"class":1060},[139,7104,1064],{"class":145},[139,7106,669],{"class":151},[139,7108,5300],{"class":145},[139,7110,7111,7114,7116,7118,7120,7123],{"class":141,"line":328},[139,7112,7113],{"class":1060},"        console",[139,7115,1064],{"class":145},[139,7117,5104],{"class":267},[139,7119,2593],{"class":145},[139,7121,7122],{"class":167},"'No match found'",[139,7124,1183],{"class":145},[139,7126,7127],{"class":141,"line":334},[139,7128,775],{"class":145},[139,7130,7131,7133,7136,7138,7140,7142,7144,7146,7149,7151,7153],{"class":141,"line":340},[139,7132,2997],{"class":1023},[139,7134,7135],{"class":2579}," b23Links",[139,7137,1075],{"class":1034},[139,7139,6884],{"class":1060},[139,7141,1064],{"class":145},[139,7143,669],{"class":1067},[139,7145,1064],{"class":145},[139,7147,7148],{"class":267},"match",[139,7150,2593],{"class":145},[139,7152,7093],{"class":1030},[139,7154,1183],{"class":145},[139,7156,7157,7159,7162,7164],{"class":141,"line":346},[139,7158,2997],{"class":1023},[139,7160,7161],{"class":2579}," cleanLinks",[139,7163,1075],{"class":1034},[139,7165,7166],{"class":145}," [];\n",[139,7168,7169,7171,7175,7177,7180],{"class":141,"line":352},[139,7170,2964],{"class":1023},[139,7172,7174],{"class":7173},"sC09Y"," Promise",[139,7176,1064],{"class":145},[139,7178,7179],{"class":267},"all",[139,7181,7182],{"class":145},"(\n",[139,7184,7185,7188,7190,7193,7195,7198,7200,7203,7205,7208,7210,7213],{"class":141,"line":358},[139,7186,7187],{"class":1060},"        b23Links",[139,7189,1064],{"class":145},[139,7191,7192],{"class":267},"map",[139,7194,2593],{"class":145},[139,7196,7197],{"class":2926},"link",[139,7199,2929],{"class":1023},[139,7201,7202],{"class":267}," b23Remover",[139,7204,2593],{"class":145},[139,7206,7207],{"class":167},"'https://'",[139,7209,6881],{"class":1034},[139,7211,7212],{"class":1030}," link",[139,7214,6385],{"class":145},[139,7216,7217,7220,7223,7225,7228,7230],{"class":141,"line":364},[139,7218,7219],{"class":145},"    ).",[139,7221,7222],{"class":267},"then",[139,7224,2593],{"class":145},[139,7226,7227],{"class":2926},"result",[139,7229,2929],{"class":1023},[139,7231,1055],{"class":145},[139,7233,7234,7237,7239,7241,7243,7246,7248],{"class":141,"line":370},[139,7235,7236],{"class":1060},"        cleanLinks",[139,7238,1064],{"class":145},[139,7240,5333],{"class":267},[139,7242,2593],{"class":145},[139,7244,7245],{"class":4979},"...",[139,7247,7227],{"class":1030},[139,7249,1183],{"class":145},[139,7251,7252],{"class":141,"line":376},[139,7253,1172],{"class":145},[139,7255,7256],{"class":141,"line":382},[139,7257,517],{"emptyLinePlaceholder":516},[139,7259,7260,7262,7265,7267,7270,7272,7274,7276,7278,7280,7282,7284,7286,7288,7290],{"class":141,"line":388},[139,7261,2997],{"class":1023},[139,7263,7264],{"class":2579}," text2Send",[139,7266,1075],{"class":1034},[139,7268,7269],{"class":167}," \"Track ID removed:",[139,7271,5404],{"class":1034},[139,7273,5420],{"class":167},[139,7275,6881],{"class":1034},[139,7277,7161],{"class":1060},[139,7279,1064],{"class":145},[139,7281,5414],{"class":267},[139,7283,2593],{"class":145},[139,7285,5420],{"class":167},[139,7287,5404],{"class":1034},[139,7289,5420],{"class":167},[139,7291,1183],{"class":145},[139,7293,7294,7296,7298,7300,7302,7304,7306,7308,7310,7312,7315],{"class":141,"line":394},[139,7295,4918],{"class":1023},[139,7297,6854],{"class":267},[139,7299,2593],{"class":145},[139,7301,6793],{"class":1060},[139,7303,1064],{"class":145},[139,7305,6863],{"class":1067},[139,7307,1064],{"class":145},[139,7309,6868],{"class":151},[139,7311,2711],{"class":145},[139,7313,7314],{"class":1030},"text2Send",[139,7316,1183],{"class":145},[139,7318,7319],{"class":141,"line":400},[139,7320,194],{"class":145},[139,7322,7323],{"class":141,"line":406},[139,7324,517],{"emptyLinePlaceholder":516},[139,7326,7327,7329,7331,7333,7335,7337],{"class":141,"line":412},[139,7328,4713],{"class":1023},[139,7330,4716],{"class":1023},[139,7332,7202],{"class":267},[139,7334,1027],{"class":145},[139,7336,4847],{"class":2926},[139,7338,1041],{"class":145},[139,7340,7341,7343,7346,7348,7350,7352,7354,7356],{"class":141,"line":418},[139,7342,2997],{"class":1023},[139,7344,7345],{"class":2579}," r",[139,7347,1075],{"class":1034},[139,7349,4839],{"class":1023},[139,7351,4842],{"class":267},[139,7353,2593],{"class":145},[139,7355,4847],{"class":1030},[139,7357,475],{"class":145},[139,7359,7360,7362,7365,7367,7369,7371],{"class":141,"line":5462},[139,7361,2997],{"class":1023},[139,7363,7364],{"class":2579}," v",[139,7366,1075],{"class":1034},[139,7368,7345],{"class":1060},[139,7370,1064],{"class":145},[139,7372,7373],{"class":151},"url\n",[139,7375,7376,7378,7381,7383,7385,7387,7389,7392],{"class":141,"line":5467},[139,7377,2997],{"class":1023},[139,7379,7380],{"class":2579}," u",[139,7382,1075],{"class":1034},[139,7384,4766],{"class":1023},[139,7386,4769],{"class":267},[139,7388,2593],{"class":145},[139,7390,7391],{"class":1030},"v",[139,7393,475],{"class":145},[139,7395,7396,7398,7400,7402,7405,7407,7409,7411],{"class":141,"line":5472},[139,7397,4918],{"class":1023},[139,7399,7380],{"class":1060},[139,7401,1064],{"class":145},[139,7403,7404],{"class":151},"origin",[139,7406,6881],{"class":1034},[139,7408,7380],{"class":1060},[139,7410,1064],{"class":145},[139,7412,7413],{"class":151},"pathname\n",[139,7415,7416],{"class":141,"line":6798},[139,7417,194],{"class":145},[96,7419,7421],{"id":7420},"webhook-注册相关","webhook 注册相关",[101,7423,7424],{},"后面的 registerWebhook、unRegisterWebhook、apiUrl 在没有特定需求的情况下不需要变动。",[101,7426,7427],{},"在 Cloudflare 部署后，就可以访问 aaa.bbb.workers.dev/registerWebhook 这个 url 注册 TG 的 webhook 服务。收到 Ok 就代表注册好了。",[101,7429,7430],{},[984,7431],{"alt":135,"src":7432},"https://static.031130.xyz/uploads/2024/12/30/5fd442bb18064.webp",[19,7434,7435],{"id":7435},"成果展示",[101,7437,7438],{},[984,7439],{"alt":135,"src":7440},"https://static.031130.xyz/uploads/2024/12/30/3b0b929960840.webp",[926,7442,7443],{},"html pre.shiki code .sLKXg, html code.shiki .sLKXg{--shiki-default:#A626A4;--shiki-dark:#C678DD}html pre.shiki code .sNmU0, html code.shiki .sNmU0{--shiki-default:#986801;--shiki-dark:#E5C07B}html pre.shiki code .s_Sar, html code.shiki .s_Sar{--shiki-default:#0184BC;--shiki-dark:#56B6C2}html pre.shiki code .sW2Sy, html code.shiki .sW2Sy{--shiki-default:#A0A1A7;--shiki-default-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic}html pre.shiki code .sDhpE, html code.shiki .sDhpE{--shiki-default:#50A14F;--shiki-dark:#98C379}html .default .shiki span {color: var(--shiki-default);background: var(--shiki-default-bg);font-style: var(--shiki-default-font-style);font-weight: var(--shiki-default-font-weight);text-decoration: var(--shiki-default-text-decoration);}html .shiki span {color: var(--shiki-default);background: var(--shiki-default-bg);font-style: var(--shiki-default-font-style);font-weight: var(--shiki-default-font-weight);text-decoration: var(--shiki-default-text-decoration);}html .dark .shiki span {color: var(--shiki-dark);background: var(--shiki-dark-bg);font-style: var(--shiki-dark-font-style);font-weight: var(--shiki-dark-font-weight);text-decoration: var(--shiki-dark-text-decoration);}html.dark .shiki span {color: var(--shiki-dark);background: var(--shiki-dark-bg);font-style: var(--shiki-dark-font-style);font-weight: var(--shiki-dark-font-weight);text-decoration: var(--shiki-dark-text-decoration);}html pre.shiki code .sAdtL, html code.shiki .sAdtL{--shiki-default:#4078F2;--shiki-dark:#61AFEF}html pre.shiki code .s5ixo, html code.shiki .s5ixo{--shiki-default:#383A42;--shiki-dark:#ABB2BF}html pre.shiki code .s8iYz, html code.shiki .s8iYz{--shiki-default:#383A42;--shiki-default-font-style:inherit;--shiki-dark:#E06C75;--shiki-dark-font-style:italic}html pre.shiki code .s7GmK, html code.shiki .s7GmK{--shiki-default:#383A42;--shiki-dark:#E5C07B}html pre.shiki code .s2QsP, html code.shiki .s2QsP{--shiki-default:#E45649;--shiki-dark:#E5C07B}html pre.shiki code .sJa8x, html code.shiki .sJa8x{--shiki-default:#E45649;--shiki-dark:#E06C75}html pre.shiki code .sz0mV, html code.shiki .sz0mV{--shiki-default:#383A42;--shiki-dark:#E06C75}html pre.shiki code .st7oF, html code.shiki .st7oF{--shiki-default:#0184BC;--shiki-dark:#ABB2BF}html pre.shiki code .sAGMh, html code.shiki .sAGMh{--shiki-default:#986801;--shiki-dark:#D19A66}html pre.shiki code .sDaw7, html code.shiki .sDaw7{--shiki-default:#0184BC;--shiki-dark:#E06C75}html pre.shiki code .sYoRg, html code.shiki .sYoRg{--shiki-default:#0184BC;--shiki-dark:#D19A66}html pre.shiki code .sC09Y, html code.shiki .sC09Y{--shiki-default:#C18401;--shiki-dark:#E5C07B}",{"title":135,"searchDepth":3,"depth":3,"links":7445},[7446,7447,7448,7454],{"id":5508,"depth":3,"text":5508},{"id":6199,"depth":3,"text":6200},{"id":6224,"depth":3,"text":6224,"children":7449},[7450,7451,7452,7453],{"id":6230,"depth":158,"text":6230},{"id":6290,"depth":158,"text":6290},{"id":6526,"depth":158,"text":6526},{"id":7420,"depth":158,"text":7421},{"id":7435,"depth":3,"text":7435},"/en/archives/",131,1765392891806]