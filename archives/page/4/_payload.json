[{"data":1,"prerenderedAt":5901},["ShallowReactive",2],{"randomIndex/archives/page/4/":3,"index-page-4-zh":4,"language-switch-/archives/page/4/-en":5899,"posts-nums-total-zh":5900},5,[5,517,827,1253,1311,3358,3922,5355,5537,5855],{"title":6,"date":7,"path":8,"tags":9,"body":14},"使用向日葵智能插座 C2 用电记录推算宿舍上次烧水时间","2024-09-24 05:17:47","/2024/09/24/log-last-water-boiling-water-with-sunlogin-adapter-power-consumption",[10,11,12,13],"IoT","Python","Hardware","Bot",{"type":15,"value":16,"toc":515},"minimark",[17,25,32,39,56,63,70,76,99,102,108,111,202,218,221,499,502,505,511],[18,19,20,21],"p",{},"我宿舍里入口处有一张公用的桌子，上面有一个烧水壶。根据生活经验，当用手摸烧水壶外壳能感受到明显热量时，水壶内的水大概是两小时内烧的，绝对能喝；但如果用手摸烧水壶外壳感受不到明显热量时，水壶内的水就不知道是什么时候烧的了，可能是三小时前，也可能是三天前。此时，在不寻求外部科学仪器介入的情况下，唯一能做的是询问寝室成员上一次水是谁烧的，是什么时候烧的。但寝室成员并不总是能够及时回答，可能在睡觉，也可能不在寝室里，",[22,23,24],"del",{},"还有可能出现记忆错乱。",[18,26,27,28],{},"因此，",[29,30,31],"strong",{},"我们需要一种可靠的方案获取上一次烧水时间。",[18,33,34,35,38],{},"前两天陪黄老板出门吃宵夜的时候和他提到了这个难题，我提出在烧水壶附近加装物理按钮，按动时向局域网内的 HomeServer 发送请求记录准确的烧水时间。他提出可以在烧水壶前加装智能插座，使用智能插座的耗电量来推算上一次烧水时间。这是一个可行方案，上次烧水时间不需要分钟级的精准度，",[29,36,37],{},"小时级的精准度在这个需求上完全够用","，这是一个更好的方案。",[18,40,41,42,47,48,51,52,55],{},"在「",[43,44,46],"a",{"href":45},"/2023/11/01/unveiling-sunflower-smart-adapter-api-intercepting-utilizing-api-android-packet-sniffing/","使用 Root 后的安卓手机获取向日葵智能插座 C2 的开关 api","」这篇文章中，我有过抓包向日葵官方 app 的流量数据的经验，这一次直接故技重施。很可惜，我发现",[29,49,50],{},"用电量数据","并不能直接从局域网内向智能插座获取，",[29,53,54],{},"必须要从向日葵官方的服务器拉下来","。其实想想也知道，用电数据一旦精确到小时级，日积月累下来会对硬件的存储提出一定的挑战，而比较合理的方案就是由硬件向官方的服务器每小时通信一次记录下来。",[18,57,58],{},[59,60],"img",{"alt":61,"src":62},"抓包","https://static.031130.xyz/uploads/2024/09/24/bd6b0bdbab1da.webp",[18,64,65,66,69],{},"不过好消息是，",[29,67,68],{},"官方服务器的这个接口并没有进行鉴权","，不需要进行额外的操作，一条 curl 命令都能下载下来。",[18,71,72],{},[59,73],{"alt":74,"src":75},"curl 命令下载用电量数据","https://static.031130.xyz/uploads/2024/09/24/bf4ad72e00044.webp",[77,78,83],"pre",{"className":79,"code":80,"language":81,"meta":82,"style":82},"language-shell shiki shiki-themes one-light one-dark-pro","https://sl-api.oray.com/smartplug/powerconsumes/${SN}\n","shell","",[84,85,86],"code",{"__ignoreMap":82},[87,88,91,95],"span",{"class":89,"line":90},"line",1,[87,92,94],{"class":93},"sAdtL","https://sl-api.oray.com/smartplug/powerconsumes/$",[87,96,98],{"class":97},"sDhpE","{SN}\n",[18,100,101],{},"SN 码也不需要自己去抓包，直接在官方应用的设备关于页面就能看到。",[18,103,104],{},[59,105],{"alt":106,"src":107},"关于页面","https://static.031130.xyz/uploads/2024/09/24/edca671f53571.webp",[18,109,110],{},"json 数据的结构很明显，最外层是一个 Array，里面有若干个 object",[77,112,116],{"className":113,"code":114,"language":115,"meta":82,"style":82},"language-json shiki shiki-themes one-light one-dark-pro","[\n  {\n    \"consume\": 0,\n    \"starttime\": 1727125200,\n    \"endtime\": 1727128740,\n    \"index\": 0\n  },\n...\n]\n","json",[84,117,118,124,130,147,160,172,183,189,196],{"__ignoreMap":82},[87,119,120],{"class":89,"line":90},[87,121,123],{"class":122},"s5ixo","[\n",[87,125,127],{"class":89,"line":126},2,[87,128,129],{"class":122},"  {\n",[87,131,133,137,140,144],{"class":89,"line":132},3,[87,134,136],{"class":135},"sJa8x","    \"consume\"",[87,138,139],{"class":122},": ",[87,141,143],{"class":142},"sAGMh","0",[87,145,146],{"class":122},",\n",[87,148,150,153,155,158],{"class":89,"line":149},4,[87,151,152],{"class":135},"    \"starttime\"",[87,154,139],{"class":122},[87,156,157],{"class":142},"1727125200",[87,159,146],{"class":122},[87,161,162,165,167,170],{"class":89,"line":3},[87,163,164],{"class":135},"    \"endtime\"",[87,166,139],{"class":122},[87,168,169],{"class":142},"1727128740",[87,171,146],{"class":122},[87,173,175,178,180],{"class":89,"line":174},6,[87,176,177],{"class":135},"    \"index\"",[87,179,139],{"class":122},[87,181,182],{"class":142},"0\n",[87,184,186],{"class":89,"line":185},7,[87,187,188],{"class":122},"  },\n",[87,190,192],{"class":89,"line":191},8,[87,193,195],{"class":194},"sUNH4","...\n",[87,197,199],{"class":89,"line":198},9,[87,200,201],{"class":122},"]\n",[203,204,205,209,212,215],"ul",{},[206,207,208],"li",{},"consume: 这段时间消耗的用电量，单位 Wh",[206,210,211],{},"starttime: 开始时间，unix 时间戳",[206,213,214],{},"endtime: 结束时间，unix 时间戳",[206,216,217],{},"index: 智能插座的第几个孔位（为插排预留的参数，智能插座只有 0 这一个位置）",[18,219,220],{},"所以我们要做的就是每小时下载一次这个 json 文件，需要时从 json 中寻找上一次用电量较高的小时，取那个小时的 starttime 时间戳转换为东八区人类可读的时间即可。",[77,222,226],{"className":223,"code":224,"language":225,"meta":82,"style":82},"language-python shiki shiki-themes one-light one-dark-pro","def last_water():\n    with open('power.json', 'r') as f:\n        powers = json.load(f)\n    for i in powers:\n        if i.get('consume') >= 30:\n            t = i.get('starttime')\n            break\n    last_water_time = datetime.datetime.fromtimestamp(t)\n    now = datetime.datetime.now()\n    time_delta = now - last_water_time\n    sec = time_delta.total_seconds()\n    hours = sec / 3600\n    lwt_str = last_water_time.strftime('%m月%d日%H点')\n    return f\"上次烧水时间为「{lwt_str}」，距离现在「{hours:.2f}」小时\"\n","python",[84,227,228,240,270,289,303,330,349,354,370,385,402,418,435,462],{"__ignoreMap":82},[87,229,230,234,237],{"class":89,"line":90},[87,231,233],{"class":232},"sLKXg","def",[87,235,236],{"class":93}," last_water",[87,238,239],{"class":122},"():\n",[87,241,242,245,249,252,255,258,261,264,267],{"class":89,"line":126},[87,243,244],{"class":232},"    with",[87,246,248],{"class":247},"s_Sar"," open",[87,250,251],{"class":122},"(",[87,253,254],{"class":97},"'power.json'",[87,256,257],{"class":122},", ",[87,259,260],{"class":97},"'r'",[87,262,263],{"class":122},") ",[87,265,266],{"class":232},"as",[87,268,269],{"class":122}," f:\n",[87,271,272,275,279,282,286],{"class":89,"line":132},[87,273,274],{"class":122},"        powers ",[87,276,278],{"class":277},"sknuh","=",[87,280,281],{"class":122}," json.",[87,283,285],{"class":284},"slOjB","load",[87,287,288],{"class":122},"(f)\n",[87,290,291,294,297,300],{"class":89,"line":149},[87,292,293],{"class":232},"    for",[87,295,296],{"class":122}," i ",[87,298,299],{"class":232},"in",[87,301,302],{"class":122}," powers:\n",[87,304,305,308,311,314,316,319,321,324,327],{"class":89,"line":3},[87,306,307],{"class":232},"        if",[87,309,310],{"class":122}," i.",[87,312,313],{"class":284},"get",[87,315,251],{"class":122},[87,317,318],{"class":97},"'consume'",[87,320,263],{"class":122},[87,322,323],{"class":277},">=",[87,325,326],{"class":142}," 30",[87,328,329],{"class":122},":\n",[87,331,332,335,337,339,341,343,346],{"class":89,"line":174},[87,333,334],{"class":122},"            t ",[87,336,278],{"class":277},[87,338,310],{"class":122},[87,340,313],{"class":284},[87,342,251],{"class":122},[87,344,345],{"class":97},"'starttime'",[87,347,348],{"class":122},")\n",[87,350,351],{"class":89,"line":185},[87,352,353],{"class":232},"            break\n",[87,355,356,359,361,364,367],{"class":89,"line":191},[87,357,358],{"class":122},"    last_water_time ",[87,360,278],{"class":277},[87,362,363],{"class":122}," datetime.datetime.",[87,365,366],{"class":284},"fromtimestamp",[87,368,369],{"class":122},"(t)\n",[87,371,372,375,377,379,382],{"class":89,"line":198},[87,373,374],{"class":122},"    now ",[87,376,278],{"class":277},[87,378,363],{"class":122},[87,380,381],{"class":284},"now",[87,383,384],{"class":122},"()\n",[87,386,388,391,393,396,399],{"class":89,"line":387},10,[87,389,390],{"class":122},"    time_delta ",[87,392,278],{"class":277},[87,394,395],{"class":122}," now ",[87,397,398],{"class":277},"-",[87,400,401],{"class":122}," last_water_time\n",[87,403,405,408,410,413,416],{"class":89,"line":404},11,[87,406,407],{"class":122},"    sec ",[87,409,278],{"class":277},[87,411,412],{"class":122}," time_delta.",[87,414,415],{"class":284},"total_seconds",[87,417,384],{"class":122},[87,419,421,424,426,429,432],{"class":89,"line":420},12,[87,422,423],{"class":122},"    hours ",[87,425,278],{"class":277},[87,427,428],{"class":122}," sec ",[87,430,431],{"class":277},"/",[87,433,434],{"class":142}," 3600\n",[87,436,438,441,443,446,449,451,454,457,460],{"class":89,"line":437},13,[87,439,440],{"class":122},"    lwt_str ",[87,442,278],{"class":277},[87,444,445],{"class":122}," last_water_time.",[87,447,448],{"class":284},"strftime",[87,450,251],{"class":122},[87,452,453],{"class":97},"'%m月",[87,455,456],{"class":142},"%d",[87,458,459],{"class":97},"日%H点'",[87,461,348],{"class":122},[87,463,465,468,471,474,477,480,483,486,488,491,494,496],{"class":89,"line":464},14,[87,466,467],{"class":232},"    return",[87,469,470],{"class":232}," f",[87,472,473],{"class":97},"\"上次烧水时间为「",[87,475,476],{"class":142},"{",[87,478,479],{"class":122},"lwt_str",[87,481,482],{"class":142},"}",[87,484,485],{"class":97},"」，距离现在「",[87,487,476],{"class":142},[87,489,490],{"class":122},"hours",[87,492,493],{"class":232},":.2f",[87,495,482],{"class":142},[87,497,498],{"class":97},"」小时\"\n",[18,500,501],{},"至于每小时下载的任务，我这里是使用 crontab + curl 命令实现的，用 python 写个死循环跑也可以。",[18,503,504],{},"那么数据都取到了，剩下的就是人机交互的部分，这部分夸张点的可以写 web，写小程序，甚至写个安卓应用挂个桌面插件，想怎么做都可以。我这里就单纯将数据接入 qqbot 扔到了宿舍群，简单写了个关键词触发。",[18,506,507],{},[59,508],{"alt":509,"src":510},"宿舍群","https://static.031130.xyz/uploads/2024/09/24/1a0637d61471f.webp",[512,513,514],"style",{},"html pre.shiki code .sAdtL, html code.shiki .sAdtL{--shiki-default:#4078F2;--shiki-dark:#61AFEF}html pre.shiki code .sDhpE, html code.shiki .sDhpE{--shiki-default:#50A14F;--shiki-dark:#98C379}html .default .shiki span {color: var(--shiki-default);background: var(--shiki-default-bg);font-style: var(--shiki-default-font-style);font-weight: var(--shiki-default-font-weight);text-decoration: var(--shiki-default-text-decoration);}html .shiki span {color: var(--shiki-default);background: var(--shiki-default-bg);font-style: var(--shiki-default-font-style);font-weight: var(--shiki-default-font-weight);text-decoration: var(--shiki-default-text-decoration);}html .dark .shiki span {color: var(--shiki-dark);background: var(--shiki-dark-bg);font-style: var(--shiki-dark-font-style);font-weight: var(--shiki-dark-font-weight);text-decoration: var(--shiki-dark-text-decoration);}html.dark .shiki span {color: var(--shiki-dark);background: var(--shiki-dark-bg);font-style: var(--shiki-dark-font-style);font-weight: var(--shiki-dark-font-weight);text-decoration: var(--shiki-dark-text-decoration);}html pre.shiki code .s5ixo, html code.shiki .s5ixo{--shiki-default:#383A42;--shiki-dark:#ABB2BF}html pre.shiki code .sJa8x, html code.shiki .sJa8x{--shiki-default:#E45649;--shiki-dark:#E06C75}html pre.shiki code .sAGMh, html code.shiki .sAGMh{--shiki-default:#986801;--shiki-dark:#D19A66}html pre.shiki code .sUNH4, html code.shiki .sUNH4{--shiki-default:white;--shiki-dark:#FFFFFF}html pre.shiki code .sLKXg, html code.shiki .sLKXg{--shiki-default:#A626A4;--shiki-dark:#C678DD}html pre.shiki code .s_Sar, html code.shiki .s_Sar{--shiki-default:#0184BC;--shiki-dark:#56B6C2}html pre.shiki code .sknuh, html code.shiki .sknuh{--shiki-default:#383A42;--shiki-dark:#56B6C2}html pre.shiki code .slOjB, html code.shiki .slOjB{--shiki-default:#383A42;--shiki-dark:#61AFEF}",{"title":82,"searchDepth":126,"depth":126,"links":516},[],{"title":518,"date":519,"path":520,"tags":521,"body":528},"使用 Caddy 反向代理 dockerhub 需要几步？","2024-09-21 01:29:17","/2024/09/21/how-to-reverse-proxy-dockerhub-with-caddy",[522,523,524,525,526,527],"Caddy","Docker","mitmproxy","Network","Linux","Mirror Site",{"type":15,"value":529,"toc":819},[530,533,536,539,543,551,554,564,612,615,631,637,655,658,664,667,673,677,683,688,693,699,704,707,713,716,724,727,731,742,757,760,774,777,780,787,793,796,799,802,809,816],[18,531,532],{},"几个月前，由于众所周知的原因，中国大陆境内失去了所有公共的 dockerhub 镜像（或者说是反代）。网上随即涌现了一批自建 dockerhub 反代的，有用 Cloudflare Workers 的，也有用 nginx 的，甚至还有自建 registry 的。",[18,534,535],{},"我使用 caddy 去反代 dockerhub 的原因很简单，一是配置简单，二是通过一台国内访问质量良好的境外服务器进行反向代理的访问质量会比 Cloudflare 减速器好很多。",[18,537,538],{},"在网上一阵搜索后，并没有发现任何使用 caddy 去反向代理 dockerhub 的文章， 于是本文应运而生。",[540,541,542],"h2",{"id":542},"遇事不决先抓包",[18,544,545,546,550],{},"为了弄清楚 docker 从 dockerhub 拉取镜像的过程，需要先对网络请求进行抓包。具体的抓包方案我使用的是 mitmproxy，手动信任 ssl 证书的操作在「",[43,547,549],{"href":548},"/2024/02/29/capture-https-traffic-on-linux-with-mitmproxy/","在 Linux 下使用 mitmproxy 抓取 HTTPS 流量","」这篇文章中已经讲过了，只需要配置 dockerd 使用本机的 8080 端口进行代理即可。",[18,552,553],{},"docker pull 时，是调用 dockerd 进行镜像拉取，而 dockerd 在绝大多数发行版上都是由 systemd 进程直接启用了，在 shell 中直接设置环境变量的方式并不能进行代理，而透明代理的方案会引入大量无关请求，增加流量分析的难度。",[18,555,556,557,563],{},"比较好的方案是直接在 systemd 服务这一层设置好代理的环境变量，我这里参考的是「",[43,558,562],{"href":559,"rel":560},"https://yeasy.gitbook.io/docker_practice/advanced_network/http_https_proxy",[561],"nofollow","配置 HTTP/HTTPS 网络代理 | Docker — 从入门到实践","」这篇文章。",[77,565,569],{"className":566,"code":567,"language":568,"meta":82,"style":82},"language-bash shiki shiki-themes one-light one-dark-pro","$ cat /etc/systemd/system/docker.service.d/http-proxy.conf\n\n[Service]\nEnvironment=\"HTTP_PROXY=http://127.0.0.1:8080\"\nEnvironment=\"HTTPS_PROXY=http://127.0.0.1:8080\"\n","bash",[84,570,571,582,588,593,603],{"__ignoreMap":82},[87,572,573,576,579],{"class":89,"line":90},[87,574,575],{"class":93},"$",[87,577,578],{"class":97}," cat",[87,580,581],{"class":97}," /etc/systemd/system/docker.service.d/http-proxy.conf\n",[87,583,584],{"class":89,"line":126},[87,585,587],{"emptyLinePlaceholder":586},true,"\n",[87,589,590],{"class":89,"line":132},[87,591,592],{"class":122},"[Service]\n",[87,594,595,598,600],{"class":89,"line":149},[87,596,597],{"class":135},"Environment",[87,599,278],{"class":277},[87,601,602],{"class":97},"\"HTTP_PROXY=http://127.0.0.1:8080\"\n",[87,604,605,607,609],{"class":89,"line":3},[87,606,597],{"class":135},[87,608,278],{"class":277},[87,610,611],{"class":97},"\"HTTPS_PROXY=http://127.0.0.1:8080\"\n",[18,613,614],{},"重启完 systemd 服务，万事俱备，我拉取了一个较小的 docker 镜像，顺利得到了预期的结果。",[77,616,618],{"className":566,"code":617,"language":568,"meta":82,"style":82},"docker pull svenstaro/miniserve:latest\n",[84,619,620],{"__ignoreMap":82},[87,621,622,625,628],{"class":89,"line":90},[87,623,624],{"class":93},"docker",[87,626,627],{"class":97}," pull",[87,629,630],{"class":97}," svenstaro/miniserve:latest\n",[18,632,633],{},[59,634],{"alt":635,"src":636},"抓包结果","https://static.031130.xyz/uploads/2024/09/21/acbee0959be78.webp",[18,638,639,640,643,644,647,648,650,651,654],{},"docker 先请求了 ",[84,641,642],{},"registry-1.docker.io"," 得到了 401 的 http 状态码后转去访问了 ",[84,645,646],{},"auth.docker.io","，得到了 Authorization 字段以后重新请求 ",[84,649,642],{},"，获取源数据后被 307 转发到了 ",[84,652,653],{},"production.cloudflare.docker.com"," 上。",[18,656,657],{},"其中，第一个 401 响应的响应头中，用 WWW-Authenticate 字段标注了 auth 鉴权的域",[18,659,660],{},[59,661],{"alt":662,"src":663},"WWW-Authenticate","https://static.031130.xyz/uploads/2024/09/21/e905c55e76a25.webp",[18,665,666],{},"而 307 响应的响应头中，使用 Location 字段标注了被转发到的 url",[18,668,669],{},[59,670],{"alt":671,"src":672},"Location","https://static.031130.xyz/uploads/2024/09/21/6a2e0bf6a8284.webp",[540,674,676],{"id":675},"三个域名都需要反向代理嘛","三个域名都需要反向代理嘛？",[18,678,679,680,682],{},"首先，作为我们提供反代服务的入口，",[84,681,642],{}," 一定是需要代理的，否则就无法提供反代后的服务。",[18,684,685,687],{},[84,686,646],{}," 只出现了一次，需要反代嘛？根据它在境内的访问质量，恐怕是需要反代的。",[18,689,690],{},[59,691],{"alt":646,"src":692},"https://static.031130.xyz/uploads/2024/09/21/4a70c8cac6a4c.webp",[18,694,695,696,698],{},"最后就是 ",[84,697,653],{}," ，这也是我们最终下载镜像文件的地方，99% 以上的流量都是打到这里去的，而 cloudflare 在境内的访问质量是知名的减速器，完全不可以信赖。",[18,700,701],{},[29,702,703],{},"因此，三个域名都需要反代。",[540,705,706],{"id":706},"如何反代",[18,708,709,710,712],{},"分三个域名各自代理，在 ",[84,711,642],{}," 那一块进行特殊处理，将响应头中的 WWW-Authenticate 和 location 字段进行关键词替换，将原域名替换为反代域名。",[18,714,715],{},"最后的成果大概就是这个样子:",[77,717,722],{"className":718,"code":720,"language":721},[719],"language-text","dockerhub.example.com {\n    reverse_proxy https://registry-1.docker.io {\n        header_up Host {http.reverse_proxy.upstream.hostport}\n        header_down WWW-Authenticate \"https://auth.docker.io\" \"https://auth.dockerhub.example.com\"\n        header_down Location \"https://production.cloudflare.docker.com\" \"https://production.dockerhub.example.com\"\n    }\n}\n\nauth.dockerhub.example.com {\n    reverse_proxy https://auth.docker.io {\n        header_up Host {http.reverse_proxy.upstream.hostport}\n    }\n}\n\nproduction.dockerhub.example.com {\n    reverse_proxy https://production.cloudflare.docker.com {\n        header_up Host {http.reverse_proxy.upstream.hostport}\n    }\n}\n","text",[84,723,720],{"__ignoreMap":82},[18,725,726],{},"PS: 推荐后两个域名使用 CNAME 解析到第一个域名，这样后面更改解析的时候更方便一些。",[540,728,730],{"id":729},"如何设置-docker-使用反代","如何设置 docker 使用反代",[18,732,733,734,737,738,741],{},"可以直接在 ",[84,735,736],{},"docker pull"," 和 ",[84,739,740],{},"docker run"," 的命令前加上域名，比如原本的",[77,743,745],{"className":566,"code":744,"language":568,"meta":82,"style":82},"docker run hello-world\n",[84,746,747],{"__ignoreMap":82},[87,748,749,751,754],{"class":89,"line":90},[87,750,624],{"class":93},[87,752,753],{"class":97}," run",[87,755,756],{"class":97}," hello-world\n",[18,758,759],{},"改成",[77,761,763],{"className":566,"code":762,"language":568,"meta":82,"style":82},"docker run dockerhub.example.com/library/hello-world\n",[84,764,765],{"__ignoreMap":82},[87,766,767,769,771],{"class":89,"line":90},[87,768,624],{"class":93},[87,770,753],{"class":97},[87,772,773],{"class":97}," dockerhub.example.com/library/hello-world\n",[18,775,776],{},"（如果原本的镜像由 dockerhub 官方提供，没有用户名，路径需要加上 “library”）",[778,779],"hr",{},[18,781,782,783,786],{},"也可以选择以前的方案，创建或修改 ",[84,784,785],{},"/etc/docker/daemon.json","：",[77,788,791],{"className":789,"code":790,"language":721},[719],"sudo mkdir -p /etc/docker\nsudo tee /etc/docker/daemon.json \u003C\u003C-'EOF'\n{\n    \"registry-mirrors\": [\n        \"https://dockerhub.example.com\"\n    ]\n}\nEOF\nsudo systemctl daemon-reload\nsudo systemctl restart docker\n",[84,792,790],{"__ignoreMap":82},[540,794,795],{"id":795},"验证",[18,797,798],{},"一般来说，能够在中国大陆境内的网络质量下较快地下拉镜像本身就代表反代成功了，但保险起见可以像本文的第一部分一样抓个包，看看是不是都走了自己的域名了。",[540,800,801],{"id":801},"参见",[18,803,804],{},[43,805,808],{"href":806,"rel":807},"https://gist.github.com/y0ngb1n/7e8f16af3242c7815e7ca2f0833d3ea6",[561],"国内的 Docker Hub 镜像加速器，由国内教育机构与各大云服务商提供的镜像加速服务",[18,810,811],{},[43,812,815],{"href":813,"rel":814},"https://blog.hentioe.dev/posts/unhindered-accesss-dockerhub.html",[561],"无障碍访问 Docker Hub 的各种方法（自建 registry、Cloudflare 加速、Nginx 反代、代理 Docker 网络） | 绅士喵",[512,817,818],{},"html pre.shiki code .sAdtL, html code.shiki .sAdtL{--shiki-default:#4078F2;--shiki-dark:#61AFEF}html pre.shiki code .sDhpE, html code.shiki .sDhpE{--shiki-default:#50A14F;--shiki-dark:#98C379}html pre.shiki code .s5ixo, html code.shiki .s5ixo{--shiki-default:#383A42;--shiki-dark:#ABB2BF}html pre.shiki code .sJa8x, html code.shiki .sJa8x{--shiki-default:#E45649;--shiki-dark:#E06C75}html pre.shiki code .sknuh, html code.shiki .sknuh{--shiki-default:#383A42;--shiki-dark:#56B6C2}html .default .shiki span {color: var(--shiki-default);background: var(--shiki-default-bg);font-style: var(--shiki-default-font-style);font-weight: var(--shiki-default-font-weight);text-decoration: var(--shiki-default-text-decoration);}html .shiki span {color: var(--shiki-default);background: var(--shiki-default-bg);font-style: var(--shiki-default-font-style);font-weight: var(--shiki-default-font-weight);text-decoration: var(--shiki-default-text-decoration);}html .dark .shiki span {color: var(--shiki-dark);background: var(--shiki-dark-bg);font-style: var(--shiki-dark-font-style);font-weight: var(--shiki-dark-font-weight);text-decoration: var(--shiki-dark-text-decoration);}html.dark .shiki span {color: var(--shiki-dark);background: var(--shiki-dark-bg);font-style: var(--shiki-dark-font-style);font-weight: var(--shiki-dark-font-weight);text-decoration: var(--shiki-dark-text-decoration);}",{"title":82,"searchDepth":126,"depth":126,"links":820},[821,822,823,824,825,826],{"id":542,"depth":126,"text":542},{"id":675,"depth":126,"text":676},{"id":706,"depth":126,"text":706},{"id":729,"depth":126,"text":730},{"id":795,"depth":126,"text":795},{"id":801,"depth":126,"text":801},{"title":828,"date":829,"path":830,"tags":831,"body":835},"将 Rustdesk 中继服务从 Arch Linux 迁移至 Debian","2024-09-20 03:20:38","/2024/09/20/migrate-rustdesk-server-from-arch-to-debian",[832,833,834,526],"Rustdesk","Archlinux","Debian",{"type":15,"value":836,"toc":1244},[837,840,856,859,863,877,883,887,1135,1138,1141,1144,1147,1154,1160,1163,1169,1172,1175,1190,1193,1196,1202,1207,1210,1213,1218,1220,1241],[18,838,839],{},"这次迁移主要是两方面原因，一来是我安装了 Arch Linux 的 VPS 要过期了，续费价格过高，没有续费的动力；二来是手上的 VPS 越来越多，逐渐意识到 Arch Linux 作为滚动发行版，每次安装新的软件都要 Syu 甚至重启系统，实在没有太多的精力去维护，这也是为什么 Arch Linux 仅适合桌面发行版。",[18,841,842,843,848,849,737,852,855],{},"原本在 Arch Linux 上部署的 rustdesk server 我是按照这篇文章「",[43,844,847],{"href":845,"rel":846},"https://www.liyp.cc/archives/1698241638248",[561],"(水文)在archlinux上部署rustdesk服务端","」部署的。本身没什么技巧，直接从 AUR 安装现成的 rustdesk-server-bin，使用 systemctl 启用 ",[84,850,851],{},"rustdesk-server-hbbr.service",[84,853,854],{},"rustdesk-server-hbbs.service"," 两个服务即可。",[18,857,858],{},"Rustdesk 现在为 Debian 提供了官方的中继服务器的 deb 包，而谷歌搜了一圈都是下载 zip 包使用 pm2 管理进程，故写下此文。",[540,860,862],{"id":861},"备份原服务器的-rustdesk-密钥","备份原服务器的 rustdesk 密钥",[18,864,865,866,869,870,737,873,876],{},"AUR 上的安装方案将密钥放在 ",[84,867,868],{},"/opt/rustdesk-server/data"," 直接用 sftp 获取 ",[84,871,872],{},"id_ed25519",[84,874,875],{},"id_ed25519.pub"," 两个文件就行。如果是新部署的没有这两个文件也没事，rustdesk 服务在启动时可以自动创建，只不过需要在客户端重新输入公钥。",[77,878,881],{"className":879,"code":880,"language":721},[719],"sftp> get /opt/rustdesk-server/data/id_ed25519\nsftp> get /opt/rustdesk-server/data/id_ed25519.pub\n",[84,882,880],{"__ignoreMap":82},[540,884,886],{"id":885},"在新服务器上下载-deb-包进行安装","在新服务器上下载 deb 包，进行安装",[77,888,890],{"className":566,"code":889,"language":568,"meta":82,"style":82},"apt install -y curl jq\nversion=$(curl -s https://api.github.com/repos/rustdesk/rustdesk-server/releases/latest | jq .tag_name)\n\nhbbr_deb=rustdesk-server-hbbr_${version:1:-1}_amd64.deb\nhbbs_deb=rustdesk-server-hbbs_${version:1:-1}_amd64.deb\nutils_deb=rustdesk-server-utils_${version:1:-1}_amd64.deb\n\nfor deb in $hbbr_deb $hbbs_deb $utils_deb\ndo\n    curl -L https://github.com/rustdesk/rustdesk-server/releases/download/${version:1:-1}/${deb} -o ${deb}\ndone\n\ndpkg -i $hbbr_deb $hbbs_deb $utils_deb\nrm $hbbr_deb $hbbs_deb $utils_deb\n",[84,891,892,909,939,943,975,1001,1027,1031,1051,1056,1101,1106,1110,1124],{"__ignoreMap":82},[87,893,894,897,900,903,906],{"class":89,"line":90},[87,895,896],{"class":93},"apt",[87,898,899],{"class":97}," install",[87,901,902],{"class":142}," -y",[87,904,905],{"class":97}," curl",[87,907,908],{"class":97}," jq\n",[87,910,911,914,916,919,922,925,928,931,934,937],{"class":89,"line":126},[87,912,913],{"class":135},"version",[87,915,278],{"class":277},[87,917,918],{"class":122},"$(",[87,920,921],{"class":93},"curl",[87,923,924],{"class":142}," -s",[87,926,927],{"class":97}," https://api.github.com/repos/rustdesk/rustdesk-server/releases/latest",[87,929,930],{"class":122}," | ",[87,932,933],{"class":93},"jq",[87,935,936],{"class":97}," .tag_name",[87,938,348],{"class":122},[87,940,941],{"class":89,"line":132},[87,942,587],{"emptyLinePlaceholder":586},[87,944,945,948,950,953,957,959,962,965,968,970,972],{"class":89,"line":149},[87,946,947],{"class":135},"hbbr_deb",[87,949,278],{"class":277},[87,951,952],{"class":97},"rustdesk-server-hbbr_",[87,954,956],{"class":955},"sr1Ac","${",[87,958,913],{"class":135},[87,960,961],{"class":122},":",[87,963,964],{"class":135},"1",[87,966,967],{"class":122},":-",[87,969,964],{"class":135},[87,971,482],{"class":955},[87,973,974],{"class":97},"_amd64.deb\n",[87,976,977,980,982,985,987,989,991,993,995,997,999],{"class":89,"line":3},[87,978,979],{"class":135},"hbbs_deb",[87,981,278],{"class":277},[87,983,984],{"class":97},"rustdesk-server-hbbs_",[87,986,956],{"class":955},[87,988,913],{"class":135},[87,990,961],{"class":122},[87,992,964],{"class":135},[87,994,967],{"class":122},[87,996,964],{"class":135},[87,998,482],{"class":955},[87,1000,974],{"class":97},[87,1002,1003,1006,1008,1011,1013,1015,1017,1019,1021,1023,1025],{"class":89,"line":174},[87,1004,1005],{"class":135},"utils_deb",[87,1007,278],{"class":277},[87,1009,1010],{"class":97},"rustdesk-server-utils_",[87,1012,956],{"class":955},[87,1014,913],{"class":135},[87,1016,961],{"class":122},[87,1018,964],{"class":135},[87,1020,967],{"class":122},[87,1022,964],{"class":135},[87,1024,482],{"class":955},[87,1026,974],{"class":97},[87,1028,1029],{"class":89,"line":185},[87,1030,587],{"emptyLinePlaceholder":586},[87,1032,1033,1036,1039,1042,1045,1048],{"class":89,"line":191},[87,1034,1035],{"class":232},"for",[87,1037,1038],{"class":135}," deb",[87,1040,1041],{"class":232}," in",[87,1043,1044],{"class":135}," $hbbr_deb",[87,1046,1047],{"class":135}," $hbbs_deb",[87,1049,1050],{"class":135}," $utils_deb\n",[87,1052,1053],{"class":89,"line":198},[87,1054,1055],{"class":232},"do\n",[87,1057,1058,1061,1064,1067,1069,1071,1073,1075,1077,1079,1081,1083,1085,1088,1090,1093,1096,1098],{"class":89,"line":387},[87,1059,1060],{"class":93},"    curl",[87,1062,1063],{"class":142}," -L",[87,1065,1066],{"class":97}," https://github.com/rustdesk/rustdesk-server/releases/download/",[87,1068,956],{"class":955},[87,1070,913],{"class":135},[87,1072,961],{"class":122},[87,1074,964],{"class":135},[87,1076,967],{"class":122},[87,1078,964],{"class":135},[87,1080,482],{"class":955},[87,1082,431],{"class":97},[87,1084,956],{"class":955},[87,1086,1087],{"class":135},"deb",[87,1089,482],{"class":955},[87,1091,1092],{"class":142}," -o",[87,1094,1095],{"class":955}," ${",[87,1097,1087],{"class":135},[87,1099,1100],{"class":955},"}\n",[87,1102,1103],{"class":89,"line":404},[87,1104,1105],{"class":232},"done\n",[87,1107,1108],{"class":89,"line":420},[87,1109,587],{"emptyLinePlaceholder":586},[87,1111,1112,1115,1118,1120,1122],{"class":89,"line":437},[87,1113,1114],{"class":93},"dpkg",[87,1116,1117],{"class":142}," -i",[87,1119,1044],{"class":135},[87,1121,1047],{"class":135},[87,1123,1050],{"class":135},[87,1125,1126,1129,1131,1133],{"class":89,"line":464},[87,1127,1128],{"class":93},"rm",[87,1130,1044],{"class":135},[87,1132,1047],{"class":135},[87,1134,1050],{"class":135},[18,1136,1137],{},"简单写了个脚本，仅适用 amd64，也没做异常处理，如果服务器在大陆境内需要自行解决 github 下载时可能出现的网络波动问题。",[18,1139,1140],{},"dpkg 安装结束后默认会启用两个 systemd 服务并开机自启，所以不需要使用 systemctl 手动启用。",[540,1142,1143],{"id":1143},"替换密钥",[18,1145,1146],{},"将刚刚备份的一个公钥和一个私钥放在 Debian 服务器的相应路径，问题是这个路径在哪里呢？",[18,1148,1149,1150,1153],{},"通过翻看 rustdesk 的 service 文件，我们大概可以定位到是在 ",[84,1151,1152],{},"/var/lib/rustdesk-server/"," 路径下的",[18,1155,1156],{},[59,1157],{"alt":1158,"src":1159},"service 问价你","https://static.031130.xyz/uploads/2024/09/20/59d08477f8a0b.webp",[18,1161,1162],{},"直接对两个密钥文件进行替换，重启 rustdesk 相关的两个 service 服务即可。",[18,1164,1165],{},[59,1166],{"alt":1167,"src":1168},"密钥文件","https://static.031130.xyz/uploads/2024/09/20/527c5b1151a57.webp",[540,1170,1171],{"id":1171},"开放服务器防火墙",[18,1173,1174],{},"需要开放如下端口，记得 Linux 的防火墙和云服务供应商面板（如果有的话）上都要开放",[203,1176,1177,1184],{},[206,1178,1179,1180,1183],{},"TCP(",[29,1181,1182],{},"21115, 21116, 21117, 21118, 21119",")",[206,1185,1186,1187,1183],{},"UDP(",[29,1188,1189],{},"21116",[540,1191,1192],{"id":1192},"客户端设置",[18,1194,1195],{},"id_ed25519.pub 对应客户端中需要输入的 Key，大概长成下面这个样子",[77,1197,1200],{"className":1198,"code":1199,"language":721},[719],"rdtxujYccRLXwXOu2KR3V9cGgP51lEdSmE0HJHGNkn4=\n",[84,1201,1199],{"__ignoreMap":82},[18,1203,1204],{},[59,1205],{"alt":82,"src":1206},"https://static.031130.xyz/uploads/2024/09/20/cc715265b8b37.webp",[18,1208,1209],{},"ID 服务器直接输入中继服务器的 ip 或者解析到对应 ip 的域名即可，另外两个地址可以不填，RustDesk会自动推导（如果没有特别设定）",[540,1211,1212],{"id":1212},"成果展示",[18,1214,1215],{},[59,1216],{"alt":1212,"src":1217},"https://static.031130.xyz/uploads/2024/09/20/3108bac773390.webp",[540,1219,801],{"id":801},[203,1221,1222,1229,1236],{},[206,1223,1224],{},[43,1225,1228],{"href":1226,"rel":1227},"https://rustdesk.com/docs/en/self-host/rustdesk-server-oss/install/",[561],"Installation :: Documentation for RustDesk",[206,1230,1231],{},[43,1232,1235],{"href":1233,"rel":1234},"https://catcat.blog/rustdesk-debian-%E8%87%AA%E5%BB%BA%E4%B8%AD%E7%BB%A7%E6%9C%8D%E5%8A%A1%E5%99%A8.html",[561],"RustDesk Debian 自建中继服务器",[206,1237,1238],{},[43,1239,847],{"href":845,"rel":1240},[561],[512,1242,1243],{},"html pre.shiki code .sAdtL, html code.shiki .sAdtL{--shiki-default:#4078F2;--shiki-dark:#61AFEF}html pre.shiki code .sDhpE, html code.shiki .sDhpE{--shiki-default:#50A14F;--shiki-dark:#98C379}html pre.shiki code .sAGMh, html code.shiki .sAGMh{--shiki-default:#986801;--shiki-dark:#D19A66}html pre.shiki code .sJa8x, html code.shiki .sJa8x{--shiki-default:#E45649;--shiki-dark:#E06C75}html pre.shiki code .sknuh, html code.shiki .sknuh{--shiki-default:#383A42;--shiki-dark:#56B6C2}html pre.shiki code .s5ixo, html code.shiki .s5ixo{--shiki-default:#383A42;--shiki-dark:#ABB2BF}html pre.shiki code .sr1Ac, html code.shiki .sr1Ac{--shiki-default:#E45649;--shiki-dark:#ABB2BF}html pre.shiki code .sLKXg, html code.shiki .sLKXg{--shiki-default:#A626A4;--shiki-dark:#C678DD}html .default .shiki span {color: var(--shiki-default);background: var(--shiki-default-bg);font-style: var(--shiki-default-font-style);font-weight: var(--shiki-default-font-weight);text-decoration: var(--shiki-default-text-decoration);}html .shiki span {color: var(--shiki-default);background: var(--shiki-default-bg);font-style: var(--shiki-default-font-style);font-weight: var(--shiki-default-font-weight);text-decoration: var(--shiki-default-text-decoration);}html .dark .shiki span {color: var(--shiki-dark);background: var(--shiki-dark-bg);font-style: var(--shiki-dark-font-style);font-weight: var(--shiki-dark-font-weight);text-decoration: var(--shiki-dark-text-decoration);}html.dark .shiki span {color: var(--shiki-dark);background: var(--shiki-dark-bg);font-style: var(--shiki-dark-font-style);font-weight: var(--shiki-dark-font-weight);text-decoration: var(--shiki-dark-text-decoration);}",{"title":82,"searchDepth":126,"depth":126,"links":1245},[1246,1247,1248,1249,1250,1251,1252],{"id":861,"depth":126,"text":862},{"id":885,"depth":126,"text":886},{"id":1143,"depth":126,"text":1143},{"id":1171,"depth":126,"text":1171},{"id":1192,"depth":126,"text":1192},{"id":1212,"depth":126,"text":1212},{"id":801,"depth":126,"text":801},{"title":1254,"date":1255,"path":1256,"tags":1257,"body":1260},"自建图床小记五——费用","2024-08-21 00:05:15","/2024/08/21/self-host-cdn-expense",[1258,1259],"Image Hosting","CDN",{"type":15,"value":1261,"toc":1309},[1262,1265,1271,1274,1277,1283,1289,1295,1298,1304],[18,1263,1264],{},"自建的图床自 8 月 13 日正式启用以来，已经过去一周多了，具体的费用是多少呢？原先设计的 0 额外投入有没有实现呢？",[18,1266,1267],{},[59,1268],{"alt":1269,"src":1270},"博客访问统计","https://static.031130.xyz/uploads/2024/08/21/74605f0ef84a9.webp",[18,1272,1273],{},"这是我的博客访问统计，在这一周多的时间内，一共有 1.27k 次页面访问，被 671 个访客访问了 769 次，平均下来每天也有一百多次的页面访问。",[18,1275,1276],{},"Cloudflare Workers 和 Cloudflare R2 的免费额度全部够用，用量全部小于免费额度的 1%。",[18,1278,1279],{},[59,1280],{"alt":1281,"src":1282},"R2 的免费额度","https://static.031130.xyz/uploads/2024/08/21/96ec475817b8f.webp",[18,1284,1285],{},[59,1286],{"alt":1287,"src":1288},"R2 的用量","https://static.031130.xyz/uploads/2024/08/21/7a26d392e6c90.webp",[18,1290,1291],{},[59,1292],{"alt":1293,"src":1294},"Cloudflare Workers 过去 24 小时内的请求次数","https://static.031130.xyz/uploads/2024/08/21/31a7f3c316b47.webp",[18,1296,1297],{},"又拍云联盟每年可以领取 67 元的代金券，平均每天控制在 0.18 元内即可实现白嫖。",[18,1299,1300],{},[59,1301],{"alt":1302,"src":1303},"又拍云账单","https://static.031130.xyz/uploads/2024/08/21/1c4eeac63a2fb.webp",[18,1305,1306],{},[29,1307,1308],{},"可以看到，这一套图床在我博客当前和可见的未来的访客情况下，在不被人恶意刷流量的情况下，是不需要投入除域名续费以外的其他成本的。",{"title":82,"searchDepth":126,"depth":126,"links":1310},[],{"title":1312,"date":1313,"path":1314,"tags":1315,"body":1317},"自建图床小记四——上传脚本编写与图片迁移","2024-08-20 23:12:30","/2024/08/20/picbed-upload-script-and-image-migration",[11,1258,526,525,1316],"Shell Script",{"type":15,"value":1318,"toc":3354},[1319,1336,1339,1342,1348,2400,2427,2463,2473,2476,2576,2597,2605,2608,2611,2614,3351],[18,1320,1321,1322,1326,1327,737,1331,1335],{},"前面三篇小记分别讲述了",[43,1323,1325],{"href":1324},"/2024/08/12/new-picbed-based-on-cloudflare-and-upyun/","图床的整体架构","、",[43,1328,1330],{"href":1329},"/2024/08/13/build-restful-api-for-cloudflare-r2-with-cloudflare-workers/","用 Workers 构建 Restful API",[43,1332,1334],{"href":1333},"/2024/08/14/auto-renew-ssl-certificate-and-deploy-to-upyun-with-github-action/","自动更新部署 SSL 证书","，这一篇c处理由此带来的图片上传问题，主要是要为 Typora 编写自动上传脚本，并为博客原有的图片进行迁移。",[540,1337,1338],{"id":1338},"自动上传脚本",[18,1340,1341],{},"主要还是给 Typora 用，实现这种效果",[18,1343,1344],{},[59,1345],{"alt":1346,"src":1347},"Typora 自动上传","https://static.031130.xyz/uploads/2024/08/12/62f3b881e3c4c.gif",[77,1349,1351],{"className":566,"code":1350,"language":568,"meta":82,"style":82},"#!/bin/bash\n\nHOST=\"upload.example.com\"\nCDN_HOST=\"cdn.example.com\"\nUPLOAD_PATH=\"uploads/$(date +%Y/%m/%d)\"\n\nAUTH_TOKEN=\"1145141919810\"\n\nwebp=false\nmarkdown=false\nforce=false\nkeep=false\n\nwhile getopts \":mwfkp:\" opt; do\n    case $opt in\n        m|markdown) markdown=true ;;\n        w|webp) webp=true ;;\n        f|force) force=true ;;\n        k|keep) keep=true ;;\n        p|path) UPLOAD_PATH=$OPTARG ;;\n        \\?) echo \"Invalid option: -$OPTARG\" ;;\n    esac\ndone\nshift $((OPTIND - 1))\n\nUPLOAD_URL=\"https://$HOST/$UPLOAD_PATH\"\nif [[ \"$UPLOAD_URL\" == */ ]]; then\n    UPLOAD_URL=\"${UPLOAD_URL%?}\"\nfi\n\nfor image in \"$@\"; do\n    if [ \"$webp\" = true ]; then\n        cwebp -quiet \"$image\" -o \"${image%.*}.webp\"\n        image=\"${image%.*}.webp\"\n    fi\n\n    if [ \"$keep\" = true ]; then\n        FILENAME=$(basename \"$image\")\n    else\n        FILENAME=\"$(md5sum $image | cut -c 1-13).$(basename $image | cut -d. -f2)\"\n    fi\n\n    if [ \"$force\" = true ]; then\n        UPLOAD_RESPONSE=$(curl -s -X PUT \"${UPLOAD_URL}/$FILENAME\" \\\n            -w \"%{http_code}\" \\\n            --data-binary @\"$image\" \\\n            -H \"X-Custom-Auth-Key: $AUTH_TOKEN\" \\\n            -H \"Overwrite: true\" \\\n        )\n    else\n        UPLOAD_RESPONSE=$(curl -s -X PUT \"${UPLOAD_URL}/$FILENAME\" \\\n            -w \"%{http_code}\" \\\n            --data-binary @\"$image\" \\\n            -H \"X-Custom-Auth-Key: $AUTH_TOKEN\" \\\n        )\n    fi\n\n    UPLOAD_HTTP_CODE=$(echo \"$UPLOAD_RESPONSE\" | tail -n1)\n\n    if [ -n \"$UPLOAD_PATH\" ]; then\n        CDN_URL=\"https://$CDN_HOST/$UPLOAD_PATH/$FILENAME\"\n    else\n        CDN_URL=\"https://$CDN_HOST/$FILENAME\"\n    fi\n\n    if [ \"$UPLOAD_HTTP_CODE\" != \"200\" ]; then\n        echo \"上传失败: $UPLOAD_RESPONSE\"\n        continue\n    fi\n\n    if [ \"$markdown\" = true ]; then\n        echo \"![](${CDN_URL})\"\n    else\n        echo \"${CDN_URL}\"\n    fi\ndone\n",[84,1352,1353,1359,1363,1373,1383,1399,1403,1413,1417,1427,1436,1445,1454,1458,1477,1489,1513,1533,1553,1573,1595,1616,1622,1627,1648,1653,1675,1700,1725,1731,1736,1759,1786,1824,1848,1854,1859,1881,1902,1908,1953,1958,1963,1985,2023,2034,2049,2065,2075,2081,2086,2119,2128,2141,2154,2159,2164,2169,2198,2203,2223,2246,2251,2268,2273,2278,2302,2315,2321,2326,2331,2353,2370,2375,2390,2395],{"__ignoreMap":82},[87,1354,1355],{"class":89,"line":90},[87,1356,1358],{"class":1357},"sW2Sy","#!/bin/bash\n",[87,1360,1361],{"class":89,"line":126},[87,1362,587],{"emptyLinePlaceholder":586},[87,1364,1365,1368,1370],{"class":89,"line":132},[87,1366,1367],{"class":135},"HOST",[87,1369,278],{"class":277},[87,1371,1372],{"class":97},"\"upload.example.com\"\n",[87,1374,1375,1378,1380],{"class":89,"line":149},[87,1376,1377],{"class":135},"CDN_HOST",[87,1379,278],{"class":277},[87,1381,1382],{"class":97},"\"cdn.example.com\"\n",[87,1384,1385,1388,1390,1393,1396],{"class":89,"line":3},[87,1386,1387],{"class":135},"UPLOAD_PATH",[87,1389,278],{"class":277},[87,1391,1392],{"class":97},"\"uploads/$(",[87,1394,1395],{"class":93},"date",[87,1397,1398],{"class":97}," +%Y/%m/%d)\"\n",[87,1400,1401],{"class":89,"line":174},[87,1402,587],{"emptyLinePlaceholder":586},[87,1404,1405,1408,1410],{"class":89,"line":185},[87,1406,1407],{"class":135},"AUTH_TOKEN",[87,1409,278],{"class":277},[87,1411,1412],{"class":97},"\"1145141919810\"\n",[87,1414,1415],{"class":89,"line":191},[87,1416,587],{"emptyLinePlaceholder":586},[87,1418,1419,1422,1424],{"class":89,"line":198},[87,1420,1421],{"class":135},"webp",[87,1423,278],{"class":277},[87,1425,1426],{"class":97},"false\n",[87,1428,1429,1432,1434],{"class":89,"line":387},[87,1430,1431],{"class":135},"markdown",[87,1433,278],{"class":277},[87,1435,1426],{"class":97},[87,1437,1438,1441,1443],{"class":89,"line":404},[87,1439,1440],{"class":135},"force",[87,1442,278],{"class":277},[87,1444,1426],{"class":97},[87,1446,1447,1450,1452],{"class":89,"line":420},[87,1448,1449],{"class":135},"keep",[87,1451,278],{"class":277},[87,1453,1426],{"class":97},[87,1455,1456],{"class":89,"line":437},[87,1457,587],{"emptyLinePlaceholder":586},[87,1459,1460,1463,1466,1469,1472,1475],{"class":89,"line":464},[87,1461,1462],{"class":232},"while",[87,1464,1465],{"class":247}," getopts",[87,1467,1468],{"class":97}," \":mwfkp:\"",[87,1470,1471],{"class":97}," opt",[87,1473,1474],{"class":122},"; ",[87,1476,1055],{"class":232},[87,1478,1480,1483,1486],{"class":89,"line":1479},15,[87,1481,1482],{"class":232},"    case",[87,1484,1485],{"class":135}," $opt",[87,1487,1488],{"class":232}," in\n",[87,1490,1492,1496,1499,1501,1503,1505,1507,1510],{"class":89,"line":1491},16,[87,1493,1495],{"class":1494},"sDaw7","        m",[87,1497,1498],{"class":122},"|",[87,1500,1431],{"class":1494},[87,1502,263],{"class":122},[87,1504,1431],{"class":135},[87,1506,278],{"class":277},[87,1508,1509],{"class":97},"true",[87,1511,1512],{"class":122}," ;;\n",[87,1514,1516,1519,1521,1523,1525,1527,1529,1531],{"class":89,"line":1515},17,[87,1517,1518],{"class":1494},"        w",[87,1520,1498],{"class":122},[87,1522,1421],{"class":1494},[87,1524,263],{"class":122},[87,1526,1421],{"class":135},[87,1528,278],{"class":277},[87,1530,1509],{"class":97},[87,1532,1512],{"class":122},[87,1534,1536,1539,1541,1543,1545,1547,1549,1551],{"class":89,"line":1535},18,[87,1537,1538],{"class":1494},"        f",[87,1540,1498],{"class":122},[87,1542,1440],{"class":1494},[87,1544,263],{"class":122},[87,1546,1440],{"class":135},[87,1548,278],{"class":277},[87,1550,1509],{"class":97},[87,1552,1512],{"class":122},[87,1554,1556,1559,1561,1563,1565,1567,1569,1571],{"class":89,"line":1555},19,[87,1557,1558],{"class":1494},"        k",[87,1560,1498],{"class":122},[87,1562,1449],{"class":1494},[87,1564,263],{"class":122},[87,1566,1449],{"class":135},[87,1568,278],{"class":277},[87,1570,1509],{"class":97},[87,1572,1512],{"class":122},[87,1574,1576,1579,1581,1584,1586,1588,1590,1593],{"class":89,"line":1575},20,[87,1577,1578],{"class":1494},"        p",[87,1580,1498],{"class":122},[87,1582,1583],{"class":1494},"path",[87,1585,263],{"class":122},[87,1587,1387],{"class":135},[87,1589,278],{"class":277},[87,1591,1592],{"class":135},"$OPTARG",[87,1594,1512],{"class":122},[87,1596,1598,1601,1603,1606,1609,1611,1614],{"class":89,"line":1597},21,[87,1599,1600],{"class":247},"        \\?",[87,1602,263],{"class":122},[87,1604,1605],{"class":247},"echo",[87,1607,1608],{"class":97}," \"Invalid option: -",[87,1610,1592],{"class":135},[87,1612,1613],{"class":97},"\"",[87,1615,1512],{"class":122},[87,1617,1619],{"class":89,"line":1618},22,[87,1620,1621],{"class":232},"    esac\n",[87,1623,1625],{"class":89,"line":1624},23,[87,1626,1105],{"class":232},[87,1628,1630,1633,1636,1639,1642,1645],{"class":89,"line":1629},24,[87,1631,1632],{"class":247},"shift",[87,1634,1635],{"class":122}," $((",[87,1637,1638],{"class":93},"OPTIND",[87,1640,1641],{"class":97}," -",[87,1643,1644],{"class":142}," 1",[87,1646,1647],{"class":122},"))\n",[87,1649,1651],{"class":89,"line":1650},25,[87,1652,587],{"emptyLinePlaceholder":586},[87,1654,1656,1659,1661,1664,1667,1669,1672],{"class":89,"line":1655},26,[87,1657,1658],{"class":135},"UPLOAD_URL",[87,1660,278],{"class":277},[87,1662,1663],{"class":97},"\"https://",[87,1665,1666],{"class":135},"$HOST",[87,1668,431],{"class":97},[87,1670,1671],{"class":135},"$UPLOAD_PATH",[87,1673,1674],{"class":97},"\"\n",[87,1676,1678,1681,1684,1686,1689,1691,1694,1697],{"class":89,"line":1677},27,[87,1679,1680],{"class":232},"if",[87,1682,1683],{"class":122}," [[ ",[87,1685,1613],{"class":97},[87,1687,1688],{"class":135},"$UPLOAD_URL",[87,1690,1613],{"class":97},[87,1692,1693],{"class":277}," ==",[87,1695,1696],{"class":122}," */ ]]; ",[87,1698,1699],{"class":232},"then\n",[87,1701,1703,1706,1708,1710,1713,1715,1718,1721,1723],{"class":89,"line":1702},28,[87,1704,1705],{"class":135},"    UPLOAD_URL",[87,1707,278],{"class":277},[87,1709,1613],{"class":97},[87,1711,956],{"class":1712},"sTIpt",[87,1714,1658],{"class":135},[87,1716,1717],{"class":122},"%",[87,1719,1720],{"class":97},"?",[87,1722,482],{"class":1712},[87,1724,1674],{"class":97},[87,1726,1728],{"class":89,"line":1727},29,[87,1729,1730],{"class":232},"fi\n",[87,1732,1734],{"class":89,"line":1733},30,[87,1735,587],{"emptyLinePlaceholder":586},[87,1737,1739,1741,1744,1746,1749,1753,1755,1757],{"class":89,"line":1738},31,[87,1740,1035],{"class":232},[87,1742,1743],{"class":135}," image",[87,1745,1041],{"class":232},[87,1747,1748],{"class":97}," \"",[87,1750,1752],{"class":1751},"s8iYz","$@",[87,1754,1613],{"class":97},[87,1756,1474],{"class":122},[87,1758,1055],{"class":232},[87,1760,1762,1765,1768,1770,1773,1775,1778,1781,1784],{"class":89,"line":1761},32,[87,1763,1764],{"class":232},"    if",[87,1766,1767],{"class":122}," [ ",[87,1769,1613],{"class":97},[87,1771,1772],{"class":135},"$webp",[87,1774,1613],{"class":97},[87,1776,1777],{"class":277}," =",[87,1779,1780],{"class":142}," true",[87,1782,1783],{"class":122}," ]; ",[87,1785,1699],{"class":232},[87,1787,1789,1792,1795,1797,1800,1802,1804,1806,1808,1811,1813,1816,1819,1821],{"class":89,"line":1788},33,[87,1790,1791],{"class":93},"        cwebp",[87,1793,1794],{"class":142}," -quiet",[87,1796,1748],{"class":97},[87,1798,1799],{"class":135},"$image",[87,1801,1613],{"class":97},[87,1803,1092],{"class":142},[87,1805,1748],{"class":97},[87,1807,956],{"class":1712},[87,1809,1810],{"class":135},"image",[87,1812,1717],{"class":122},[87,1814,1815],{"class":97},".",[87,1817,1818],{"class":122},"*",[87,1820,482],{"class":1712},[87,1822,1823],{"class":97},".webp\"\n",[87,1825,1827,1830,1832,1834,1836,1838,1840,1842,1844,1846],{"class":89,"line":1826},34,[87,1828,1829],{"class":135},"        image",[87,1831,278],{"class":277},[87,1833,1613],{"class":97},[87,1835,956],{"class":1712},[87,1837,1810],{"class":135},[87,1839,1717],{"class":122},[87,1841,1815],{"class":97},[87,1843,1818],{"class":122},[87,1845,482],{"class":1712},[87,1847,1823],{"class":97},[87,1849,1851],{"class":89,"line":1850},35,[87,1852,1853],{"class":232},"    fi\n",[87,1855,1857],{"class":89,"line":1856},36,[87,1858,587],{"emptyLinePlaceholder":586},[87,1860,1862,1864,1866,1868,1871,1873,1875,1877,1879],{"class":89,"line":1861},37,[87,1863,1764],{"class":232},[87,1865,1767],{"class":122},[87,1867,1613],{"class":97},[87,1869,1870],{"class":135},"$keep",[87,1872,1613],{"class":97},[87,1874,1777],{"class":277},[87,1876,1780],{"class":142},[87,1878,1783],{"class":122},[87,1880,1699],{"class":232},[87,1882,1884,1887,1889,1891,1894,1896,1898,1900],{"class":89,"line":1883},38,[87,1885,1886],{"class":135},"        FILENAME",[87,1888,278],{"class":277},[87,1890,918],{"class":122},[87,1892,1893],{"class":93},"basename",[87,1895,1748],{"class":97},[87,1897,1799],{"class":135},[87,1899,1613],{"class":97},[87,1901,348],{"class":122},[87,1903,1905],{"class":89,"line":1904},39,[87,1906,1907],{"class":232},"    else\n",[87,1909,1911,1913,1915,1918,1921,1924,1927,1930,1933,1936,1938,1940,1942,1944,1947,1950],{"class":89,"line":1910},40,[87,1912,1886],{"class":135},[87,1914,278],{"class":277},[87,1916,1917],{"class":97},"\"$(",[87,1919,1920],{"class":93},"md5sum",[87,1922,1923],{"class":135}," $image",[87,1925,1926],{"class":122}," |",[87,1928,1929],{"class":93}," cut",[87,1931,1932],{"class":142}," -c",[87,1934,1935],{"class":97}," 1-13).$(",[87,1937,1893],{"class":93},[87,1939,1923],{"class":135},[87,1941,1926],{"class":122},[87,1943,1929],{"class":93},[87,1945,1946],{"class":142}," -d.",[87,1948,1949],{"class":142}," -f2",[87,1951,1952],{"class":97},")\"\n",[87,1954,1956],{"class":89,"line":1955},41,[87,1957,1853],{"class":232},[87,1959,1961],{"class":89,"line":1960},42,[87,1962,587],{"emptyLinePlaceholder":586},[87,1964,1966,1968,1970,1972,1975,1977,1979,1981,1983],{"class":89,"line":1965},43,[87,1967,1764],{"class":232},[87,1969,1767],{"class":122},[87,1971,1613],{"class":97},[87,1973,1974],{"class":135},"$force",[87,1976,1613],{"class":97},[87,1978,1777],{"class":277},[87,1980,1780],{"class":142},[87,1982,1783],{"class":122},[87,1984,1699],{"class":232},[87,1986,1988,1991,1993,1995,1997,1999,2002,2005,2007,2009,2011,2013,2015,2018,2020],{"class":89,"line":1987},44,[87,1989,1990],{"class":135},"        UPLOAD_RESPONSE",[87,1992,278],{"class":277},[87,1994,918],{"class":122},[87,1996,921],{"class":93},[87,1998,924],{"class":142},[87,2000,2001],{"class":142}," -X",[87,2003,2004],{"class":97}," PUT",[87,2006,1748],{"class":97},[87,2008,956],{"class":1712},[87,2010,1658],{"class":135},[87,2012,482],{"class":1712},[87,2014,431],{"class":97},[87,2016,2017],{"class":135},"$FILENAME",[87,2019,1613],{"class":97},[87,2021,2022],{"class":247}," \\\n",[87,2024,2026,2029,2032],{"class":89,"line":2025},45,[87,2027,2028],{"class":142},"            -w",[87,2030,2031],{"class":97}," \"%{http_code}\"",[87,2033,2022],{"class":247},[87,2035,2037,2040,2043,2045,2047],{"class":89,"line":2036},46,[87,2038,2039],{"class":142},"            --data-binary",[87,2041,2042],{"class":97}," @\"",[87,2044,1799],{"class":135},[87,2046,1613],{"class":97},[87,2048,2022],{"class":247},[87,2050,2052,2055,2058,2061,2063],{"class":89,"line":2051},47,[87,2053,2054],{"class":142},"            -H",[87,2056,2057],{"class":97}," \"X-Custom-Auth-Key: ",[87,2059,2060],{"class":135},"$AUTH_TOKEN",[87,2062,1613],{"class":97},[87,2064,2022],{"class":247},[87,2066,2068,2070,2073],{"class":89,"line":2067},48,[87,2069,2054],{"class":142},[87,2071,2072],{"class":97}," \"Overwrite: true\"",[87,2074,2022],{"class":247},[87,2076,2078],{"class":89,"line":2077},49,[87,2079,2080],{"class":122},"        )\n",[87,2082,2084],{"class":89,"line":2083},50,[87,2085,1907],{"class":232},[87,2087,2089,2091,2093,2095,2097,2099,2101,2103,2105,2107,2109,2111,2113,2115,2117],{"class":89,"line":2088},51,[87,2090,1990],{"class":135},[87,2092,278],{"class":277},[87,2094,918],{"class":122},[87,2096,921],{"class":93},[87,2098,924],{"class":142},[87,2100,2001],{"class":142},[87,2102,2004],{"class":97},[87,2104,1748],{"class":97},[87,2106,956],{"class":1712},[87,2108,1658],{"class":135},[87,2110,482],{"class":1712},[87,2112,431],{"class":97},[87,2114,2017],{"class":135},[87,2116,1613],{"class":97},[87,2118,2022],{"class":247},[87,2120,2122,2124,2126],{"class":89,"line":2121},52,[87,2123,2028],{"class":142},[87,2125,2031],{"class":97},[87,2127,2022],{"class":247},[87,2129,2131,2133,2135,2137,2139],{"class":89,"line":2130},53,[87,2132,2039],{"class":142},[87,2134,2042],{"class":97},[87,2136,1799],{"class":135},[87,2138,1613],{"class":97},[87,2140,2022],{"class":247},[87,2142,2144,2146,2148,2150,2152],{"class":89,"line":2143},54,[87,2145,2054],{"class":142},[87,2147,2057],{"class":97},[87,2149,2060],{"class":135},[87,2151,1613],{"class":97},[87,2153,2022],{"class":247},[87,2155,2157],{"class":89,"line":2156},55,[87,2158,2080],{"class":122},[87,2160,2162],{"class":89,"line":2161},56,[87,2163,1853],{"class":232},[87,2165,2167],{"class":89,"line":2166},57,[87,2168,587],{"emptyLinePlaceholder":586},[87,2170,2172,2175,2177,2179,2181,2183,2186,2188,2190,2193,2196],{"class":89,"line":2171},58,[87,2173,2174],{"class":135},"    UPLOAD_HTTP_CODE",[87,2176,278],{"class":277},[87,2178,918],{"class":122},[87,2180,1605],{"class":247},[87,2182,1748],{"class":97},[87,2184,2185],{"class":135},"$UPLOAD_RESPONSE",[87,2187,1613],{"class":97},[87,2189,930],{"class":122},[87,2191,2192],{"class":93},"tail",[87,2194,2195],{"class":142}," -n1",[87,2197,348],{"class":122},[87,2199,2201],{"class":89,"line":2200},59,[87,2202,587],{"emptyLinePlaceholder":586},[87,2204,2206,2208,2210,2213,2215,2217,2219,2221],{"class":89,"line":2205},60,[87,2207,1764],{"class":232},[87,2209,1767],{"class":122},[87,2211,2212],{"class":277},"-n",[87,2214,1748],{"class":97},[87,2216,1671],{"class":135},[87,2218,1613],{"class":97},[87,2220,1783],{"class":122},[87,2222,1699],{"class":232},[87,2224,2226,2229,2231,2233,2236,2238,2240,2242,2244],{"class":89,"line":2225},61,[87,2227,2228],{"class":135},"        CDN_URL",[87,2230,278],{"class":277},[87,2232,1663],{"class":97},[87,2234,2235],{"class":135},"$CDN_HOST",[87,2237,431],{"class":97},[87,2239,1671],{"class":135},[87,2241,431],{"class":97},[87,2243,2017],{"class":135},[87,2245,1674],{"class":97},[87,2247,2249],{"class":89,"line":2248},62,[87,2250,1907],{"class":232},[87,2252,2254,2256,2258,2260,2262,2264,2266],{"class":89,"line":2253},63,[87,2255,2228],{"class":135},[87,2257,278],{"class":277},[87,2259,1663],{"class":97},[87,2261,2235],{"class":135},[87,2263,431],{"class":97},[87,2265,2017],{"class":135},[87,2267,1674],{"class":97},[87,2269,2271],{"class":89,"line":2270},64,[87,2272,1853],{"class":232},[87,2274,2276],{"class":89,"line":2275},65,[87,2277,587],{"emptyLinePlaceholder":586},[87,2279,2281,2283,2285,2287,2290,2292,2295,2298,2300],{"class":89,"line":2280},66,[87,2282,1764],{"class":232},[87,2284,1767],{"class":122},[87,2286,1613],{"class":97},[87,2288,2289],{"class":135},"$UPLOAD_HTTP_CODE",[87,2291,1613],{"class":97},[87,2293,2294],{"class":277}," !=",[87,2296,2297],{"class":97}," \"200\"",[87,2299,1783],{"class":122},[87,2301,1699],{"class":232},[87,2303,2305,2308,2311,2313],{"class":89,"line":2304},67,[87,2306,2307],{"class":247},"        echo",[87,2309,2310],{"class":97}," \"上传失败: ",[87,2312,2185],{"class":135},[87,2314,1674],{"class":97},[87,2316,2318],{"class":89,"line":2317},68,[87,2319,2320],{"class":232},"        continue\n",[87,2322,2324],{"class":89,"line":2323},69,[87,2325,1853],{"class":232},[87,2327,2329],{"class":89,"line":2328},70,[87,2330,587],{"emptyLinePlaceholder":586},[87,2332,2334,2336,2338,2340,2343,2345,2347,2349,2351],{"class":89,"line":2333},71,[87,2335,1764],{"class":232},[87,2337,1767],{"class":122},[87,2339,1613],{"class":97},[87,2341,2342],{"class":135},"$markdown",[87,2344,1613],{"class":97},[87,2346,1777],{"class":277},[87,2348,1780],{"class":142},[87,2350,1783],{"class":122},[87,2352,1699],{"class":232},[87,2354,2356,2358,2361,2363,2366,2368],{"class":89,"line":2355},72,[87,2357,2307],{"class":247},[87,2359,2360],{"class":97}," \"![](",[87,2362,956],{"class":1712},[87,2364,2365],{"class":135},"CDN_URL",[87,2367,482],{"class":1712},[87,2369,1952],{"class":97},[87,2371,2373],{"class":89,"line":2372},73,[87,2374,1907],{"class":232},[87,2376,2378,2380,2382,2384,2386,2388],{"class":89,"line":2377},74,[87,2379,2307],{"class":247},[87,2381,1748],{"class":97},[87,2383,956],{"class":1712},[87,2385,2365],{"class":135},[87,2387,482],{"class":1712},[87,2389,1674],{"class":97},[87,2391,2393],{"class":89,"line":2392},75,[87,2394,1853],{"class":232},[87,2396,2398],{"class":89,"line":2397},76,[87,2399,1105],{"class":232},[18,2401,2402,2403,1326,2406,737,2409,2412,2413,2415,2416,737,2418,2420,2421,737,2423,2426],{},"这一次使用 Cloudflare Workers 构建的 Restful API 很有意思，使用了 ",[84,2404,2405],{},"GET",[84,2407,2408],{},"PUT",[84,2410,2411],{},"DELETE"," 三个请求类型。",[84,2414,2405],{}," 请求很常见，是用来获取图片的，",[84,2417,2408],{},[84,2419,2411],{}," 在 web 开发就不如 ",[84,2422,2405],{},[84,2424,2425],{},"POST"," 常见了，这一次也是让我体会到了这两个 http verb 在 Storage Bucket 操作中是有多么形象了。",[203,2428,2429,2452],{},[206,2430,2431,2433,2434,2437,2438,2441,2442,2445,2446,2448,2449,2451],{},[84,2432,2408],{}," - 从直观上来讲，就是将某个文件放到目标位置",[2435,2436],"br",{},"打个比方，我向 ",[84,2439,2440],{},"https://cdn.example.com/img/avatar.webp"," 打了一个请求，并带上了要上传的文件，那就意味着我将这个文件放到了 Storage Bucket 的 ",[84,2443,2444],{},"/img/avatar.webp"," 这个位置，所以我在上传后，应该就能用 ",[84,2447,2405],{}," 请求我刚才 ",[84,2450,2408],{}," 的那个 URL 获取我刚才上传的东西。如果那个路径存在文件，那么默认行为是直接覆盖。",[206,2453,2454,2456,2457,2459,2460,2462],{},[84,2455,2411],{}," - 删除目标路径的文件",[2435,2458],{},"和 ",[84,2461,2408],{}," 一样，我在请求对应 URL 后，Storage Bucket 中对应 URL 路径的资源应该被删除。",[18,2464,2465,737,2467,2469,2470,2472],{},[84,2466,2408],{},[84,2468,2411],{}," 这两个 Http Verb 让我们更像是在对一个真实的文件系统进行操作，而非那种传统的使用 ",[84,2471,2425],{}," 上传的图床那样，我们并不通过 POST 请求上传一个文件，然后获取资源最终被放置位置的 URL —— 我们自己决定资源被存放的位置。",[18,2474,2475],{},"在这个 Shell 脚本中，引入了四个可选选项",[77,2477,2479],{"className":566,"code":2478,"language":568,"meta":82,"style":82},"    m|markdown) markdown=true ;;\n    w|webp) webp=true ;;\n    f|force) force=true ;;\n    k|keep) keep=true ;;\n    p|path) UPLOAD_PATH=$OPTARG ;;\n",[84,2480,2481,2500,2519,2538,2557],{"__ignoreMap":82},[87,2482,2483,2486,2488,2490,2492,2494,2496,2498],{"class":89,"line":90},[87,2484,2485],{"class":93},"    m",[87,2487,1498],{"class":122},[87,2489,1431],{"class":93},[87,2491,263],{"class":122},[87,2493,1431],{"class":135},[87,2495,278],{"class":277},[87,2497,1509],{"class":97},[87,2499,1512],{"class":122},[87,2501,2502,2505,2507,2509,2511,2513,2515,2517],{"class":89,"line":126},[87,2503,2504],{"class":93},"    w",[87,2506,1498],{"class":122},[87,2508,1421],{"class":93},[87,2510,263],{"class":122},[87,2512,1421],{"class":135},[87,2514,278],{"class":277},[87,2516,1509],{"class":97},[87,2518,1512],{"class":122},[87,2520,2521,2524,2526,2528,2530,2532,2534,2536],{"class":89,"line":132},[87,2522,2523],{"class":93},"    f",[87,2525,1498],{"class":122},[87,2527,1440],{"class":93},[87,2529,263],{"class":122},[87,2531,1440],{"class":135},[87,2533,278],{"class":277},[87,2535,1509],{"class":97},[87,2537,1512],{"class":122},[87,2539,2540,2543,2545,2547,2549,2551,2553,2555],{"class":89,"line":149},[87,2541,2542],{"class":93},"    k",[87,2544,1498],{"class":122},[87,2546,1449],{"class":93},[87,2548,263],{"class":122},[87,2550,1449],{"class":135},[87,2552,278],{"class":277},[87,2554,1509],{"class":97},[87,2556,1512],{"class":122},[87,2558,2559,2562,2564,2566,2568,2570,2572,2574],{"class":89,"line":3},[87,2560,2561],{"class":93},"    p",[87,2563,1498],{"class":122},[87,2565,1583],{"class":93},[87,2567,263],{"class":122},[87,2569,1387],{"class":135},[87,2571,278],{"class":277},[87,2573,1592],{"class":135},[87,2575,1512],{"class":122},[203,2577,2578,2585,2588,2591,2594],{},[206,2579,2580,2581,2584],{},"markdown 选项决定返回值是否以 ",[84,2582,2583],{},"![]()"," 这种 URL 格式返回",[206,2586,2587],{},"webp 决定上传过程中是否将图片转为 webp 后再上传",[206,2589,2590],{},"force 决定如果遇到文件路径冲突，是否强制覆盖云端的文件",[206,2592,2593],{},"keep 决定是否保留文件原有的文件名进行上传",[206,2595,2596],{},"path 决定文件具体被存放的路径（或者使用默认的路径）",[18,2598,2599,2601,2602,2604],{},[84,2600,1367],{}," 是图床用于上传的地址，",[84,2603,1377],{}," 是图床用于被方可访问的地址。",[18,2606,2607],{},"由于急着用，也没考虑协程的处理方式，等等看后期有没有时间用 Python 重写吧。",[540,2609,2610],{"id":2610},"博客图床迁移脚本",[18,2612,2613],{},"因为只用一次，所以也没使用协程或者多线程的方式去上传文件——毕竟图片不多，也就两三百张。",[77,2615,2617],{"className":223,"code":2616,"language":225,"meta":82,"style":82},"import os\nimport re\nimport requests\n\n# 哪些后缀的文件需要检测是否存在老图床的 URL 并进行迁移？\nfile_extension = [\n    '.md',\n    '.yml',\n    '.html'\n]\n\npic_urls = []\n\n_files = []\n\n# 用于匹配老图床的正则表达式，这里是按照 lsky pro 的格式编写的\npattern = r'https://cdn.example.com/\\d{4}/\\d{2}/\\d{2}/[a-z0-9]{13}\\.[a-z]{3,4}'\n\n# 图片的上传部分，需要先从原 url 中下载图片，在上传到新图床中，如果需要的话可以在中途转换为 webp 格式\ndef upload(url):\n    \"\"\"\n    此处的返回值应该是新的 url\n    \"\"\"\n\n# 遍历目标后缀文件名的文件，如果存在老图床的 url，则将 url 加入到 pic_urls 列表中，并将这个文件的文件名（相对路径）添加到 _files 列表中\nfor root, dirs, files in os.walk(\".\"):\n    for file in files:\n        if file.endswith(tuple(file_extension)):\n            file_name = os.path.join(root, file)\n            with open(file_name, 'r') as f:\n                content = f.read()\n            urls = re.findall(pattern, content)\n            if urls:\n                pic_urls.extend(urls)\n                _files.append(file_name)\n\n# 先转为集合，再转回列表，进行去重\npic_urls = list(set(pic_urls))\nprint(\"共找到图片：\", len(pic_urls))\n\nurl_dict = {}\n\n# 将列表中的图片进行上传，每张图片最多尝试三次上传，如果三次都失败，则保留原连接\nfor i,u in enumerate(pci_urls, start=1):\n    for t in range(1,4):\n        try:\n            new_u = upload(u)\n            continue\n        except:\n            if t == 3:\n                new_u = u\n                print(f\"{u} 无法上传：{e}\")\n    url_dict[u] = new_u\n    print(f\"{i} / {len(pic_urls)}\")\n\n# 对 _files 列表中的文件一一完成替换\nfor file in _files:\n    with open(file, 'r') as f:\n        content = f.read()\n    for k, v in url_dict.items():\n        content = content.replace(k, v)\n    with open(file, 'w') as f:\n        f.write(content)\n    print(\"完成替换：\", file)\n",[84,2618,2619,2627,2634,2641,2645,2650,2660,2667,2674,2679,2683,2687,2697,2701,2710,2714,2719,2771,2775,2780,2796,2801,2806,2810,2814,2819,2841,2853,2872,2893,2911,2926,2942,2950,2961,2972,2976,2981,2998,3015,3019,3029,3033,3038,3063,3087,3094,3106,3111,3118,3132,3142,3175,3185,3219,3223,3228,3239,3259,3272,3289,3304,3325,3336],{"__ignoreMap":82},[87,2620,2621,2624],{"class":89,"line":90},[87,2622,2623],{"class":232},"import",[87,2625,2626],{"class":122}," os\n",[87,2628,2629,2631],{"class":89,"line":126},[87,2630,2623],{"class":232},[87,2632,2633],{"class":122}," re\n",[87,2635,2636,2638],{"class":89,"line":132},[87,2637,2623],{"class":232},[87,2639,2640],{"class":122}," requests\n",[87,2642,2643],{"class":89,"line":149},[87,2644,587],{"emptyLinePlaceholder":586},[87,2646,2647],{"class":89,"line":3},[87,2648,2649],{"class":1357},"# 哪些后缀的文件需要检测是否存在老图床的 URL 并进行迁移？\n",[87,2651,2652,2655,2657],{"class":89,"line":174},[87,2653,2654],{"class":122},"file_extension ",[87,2656,278],{"class":277},[87,2658,2659],{"class":122}," [\n",[87,2661,2662,2665],{"class":89,"line":185},[87,2663,2664],{"class":97},"    '.md'",[87,2666,146],{"class":122},[87,2668,2669,2672],{"class":89,"line":191},[87,2670,2671],{"class":97},"    '.yml'",[87,2673,146],{"class":122},[87,2675,2676],{"class":89,"line":198},[87,2677,2678],{"class":97},"    '.html'\n",[87,2680,2681],{"class":89,"line":387},[87,2682,201],{"class":122},[87,2684,2685],{"class":89,"line":404},[87,2686,587],{"emptyLinePlaceholder":586},[87,2688,2689,2692,2694],{"class":89,"line":420},[87,2690,2691],{"class":122},"pic_urls ",[87,2693,278],{"class":277},[87,2695,2696],{"class":122}," []\n",[87,2698,2699],{"class":89,"line":437},[87,2700,587],{"emptyLinePlaceholder":586},[87,2702,2703,2706,2708],{"class":89,"line":464},[87,2704,2705],{"class":122},"_files ",[87,2707,278],{"class":277},[87,2709,2696],{"class":122},[87,2711,2712],{"class":89,"line":1479},[87,2713,587],{"emptyLinePlaceholder":586},[87,2715,2716],{"class":89,"line":1491},[87,2717,2718],{"class":1357},"# 用于匹配老图床的正则表达式，这里是按照 lsky pro 的格式编写的\n",[87,2720,2721,2724,2726,2729,2732,2736,2739,2742,2744,2746,2748,2751,2754,2757,2760,2762,2765,2768],{"class":89,"line":1515},[87,2722,2723],{"class":122},"pattern ",[87,2725,278],{"class":277},[87,2727,2728],{"class":232}," r",[87,2730,2731],{"class":1494},"'https://cdn.example.com/\\d",[87,2733,2735],{"class":2734},"sYebD","{4}",[87,2737,2738],{"class":1494},"/\\d",[87,2740,2741],{"class":2734},"{2}",[87,2743,2738],{"class":1494},[87,2745,2741],{"class":2734},[87,2747,431],{"class":1494},[87,2749,2750],{"class":2734},"[",[87,2752,2753],{"class":142},"a-z0-9",[87,2755,2756],{"class":2734},"]{13}",[87,2758,2759],{"class":247},"\\.",[87,2761,2750],{"class":2734},[87,2763,2764],{"class":142},"a-z",[87,2766,2767],{"class":2734},"]{3,4}",[87,2769,2770],{"class":1494},"'\n",[87,2772,2773],{"class":89,"line":1535},[87,2774,587],{"emptyLinePlaceholder":586},[87,2776,2777],{"class":89,"line":1555},[87,2778,2779],{"class":1357},"# 图片的上传部分，需要先从原 url 中下载图片，在上传到新图床中，如果需要的话可以在中途转换为 webp 格式\n",[87,2781,2782,2784,2787,2789,2793],{"class":89,"line":1575},[87,2783,233],{"class":232},[87,2785,2786],{"class":93}," upload",[87,2788,251],{"class":122},[87,2790,2792],{"class":2791},"so_Uh","url",[87,2794,2795],{"class":122},"):\n",[87,2797,2798],{"class":89,"line":1597},[87,2799,2800],{"class":97},"    \"\"\"\n",[87,2802,2803],{"class":89,"line":1618},[87,2804,2805],{"class":97},"    此处的返回值应该是新的 url\n",[87,2807,2808],{"class":89,"line":1624},[87,2809,2800],{"class":97},[87,2811,2812],{"class":89,"line":1629},[87,2813,587],{"emptyLinePlaceholder":586},[87,2815,2816],{"class":89,"line":1650},[87,2817,2818],{"class":1357},"# 遍历目标后缀文件名的文件，如果存在老图床的 url，则将 url 加入到 pic_urls 列表中，并将这个文件的文件名（相对路径）添加到 _files 列表中\n",[87,2820,2821,2823,2826,2828,2831,2834,2836,2839],{"class":89,"line":1655},[87,2822,1035],{"class":232},[87,2824,2825],{"class":122}," root, dirs, files ",[87,2827,299],{"class":232},[87,2829,2830],{"class":122}," os.",[87,2832,2833],{"class":284},"walk",[87,2835,251],{"class":122},[87,2837,2838],{"class":97},"\".\"",[87,2840,2795],{"class":122},[87,2842,2843,2845,2848,2850],{"class":89,"line":1677},[87,2844,293],{"class":232},[87,2846,2847],{"class":135}," file",[87,2849,1041],{"class":232},[87,2851,2852],{"class":122}," files:\n",[87,2854,2855,2857,2859,2861,2864,2866,2869],{"class":89,"line":1702},[87,2856,307],{"class":232},[87,2858,2847],{"class":135},[87,2860,1815],{"class":122},[87,2862,2863],{"class":284},"endswith",[87,2865,251],{"class":122},[87,2867,2868],{"class":247},"tuple",[87,2870,2871],{"class":122},"(file_extension)):\n",[87,2873,2874,2877,2879,2882,2885,2888,2891],{"class":89,"line":1727},[87,2875,2876],{"class":122},"            file_name ",[87,2878,278],{"class":277},[87,2880,2881],{"class":122}," os.path.",[87,2883,2884],{"class":284},"join",[87,2886,2887],{"class":122},"(root, ",[87,2889,2890],{"class":135},"file",[87,2892,348],{"class":122},[87,2894,2895,2898,2900,2903,2905,2907,2909],{"class":89,"line":1733},[87,2896,2897],{"class":232},"            with",[87,2899,248],{"class":247},[87,2901,2902],{"class":122},"(file_name, ",[87,2904,260],{"class":97},[87,2906,263],{"class":122},[87,2908,266],{"class":232},[87,2910,269],{"class":122},[87,2912,2913,2916,2918,2921,2924],{"class":89,"line":1738},[87,2914,2915],{"class":122},"                content ",[87,2917,278],{"class":277},[87,2919,2920],{"class":122}," f.",[87,2922,2923],{"class":284},"read",[87,2925,384],{"class":122},[87,2927,2928,2931,2933,2936,2939],{"class":89,"line":1761},[87,2929,2930],{"class":122},"            urls ",[87,2932,278],{"class":277},[87,2934,2935],{"class":122}," re.",[87,2937,2938],{"class":284},"findall",[87,2940,2941],{"class":122},"(pattern, content)\n",[87,2943,2944,2947],{"class":89,"line":1788},[87,2945,2946],{"class":232},"            if",[87,2948,2949],{"class":122}," urls:\n",[87,2951,2952,2955,2958],{"class":89,"line":1826},[87,2953,2954],{"class":122},"                pic_urls.",[87,2956,2957],{"class":284},"extend",[87,2959,2960],{"class":122},"(urls)\n",[87,2962,2963,2966,2969],{"class":89,"line":1850},[87,2964,2965],{"class":122},"                _files.",[87,2967,2968],{"class":284},"append",[87,2970,2971],{"class":122},"(file_name)\n",[87,2973,2974],{"class":89,"line":1856},[87,2975,587],{"emptyLinePlaceholder":586},[87,2977,2978],{"class":89,"line":1861},[87,2979,2980],{"class":1357},"# 先转为集合，再转回列表，进行去重\n",[87,2982,2983,2985,2987,2990,2992,2995],{"class":89,"line":1883},[87,2984,2691],{"class":122},[87,2986,278],{"class":277},[87,2988,2989],{"class":247}," list",[87,2991,251],{"class":122},[87,2993,2994],{"class":247},"set",[87,2996,2997],{"class":122},"(pic_urls))\n",[87,2999,3000,3003,3005,3008,3010,3013],{"class":89,"line":1904},[87,3001,3002],{"class":247},"print",[87,3004,251],{"class":122},[87,3006,3007],{"class":97},"\"共找到图片：\"",[87,3009,257],{"class":122},[87,3011,3012],{"class":247},"len",[87,3014,2997],{"class":122},[87,3016,3017],{"class":89,"line":1910},[87,3018,587],{"emptyLinePlaceholder":586},[87,3020,3021,3024,3026],{"class":89,"line":1955},[87,3022,3023],{"class":122},"url_dict ",[87,3025,278],{"class":277},[87,3027,3028],{"class":122}," {}\n",[87,3030,3031],{"class":89,"line":1960},[87,3032,587],{"emptyLinePlaceholder":586},[87,3034,3035],{"class":89,"line":1965},[87,3036,3037],{"class":1357},"# 将列表中的图片进行上传，每张图片最多尝试三次上传，如果三次都失败，则保留原连接\n",[87,3039,3040,3042,3045,3047,3050,3053,3057,3059,3061],{"class":89,"line":1987},[87,3041,1035],{"class":232},[87,3043,3044],{"class":122}," i,u ",[87,3046,299],{"class":232},[87,3048,3049],{"class":247}," enumerate",[87,3051,3052],{"class":122},"(pci_urls, ",[87,3054,3056],{"class":3055},"sp7wS","start",[87,3058,278],{"class":277},[87,3060,964],{"class":142},[87,3062,2795],{"class":122},[87,3064,3065,3067,3070,3072,3075,3077,3079,3082,3085],{"class":89,"line":2025},[87,3066,293],{"class":232},[87,3068,3069],{"class":122}," t ",[87,3071,299],{"class":232},[87,3073,3074],{"class":247}," range",[87,3076,251],{"class":122},[87,3078,964],{"class":142},[87,3080,3081],{"class":122},",",[87,3083,3084],{"class":142},"4",[87,3086,2795],{"class":122},[87,3088,3089,3092],{"class":89,"line":2036},[87,3090,3091],{"class":232},"        try",[87,3093,329],{"class":122},[87,3095,3096,3099,3101,3103],{"class":89,"line":2051},[87,3097,3098],{"class":122},"            new_u ",[87,3100,278],{"class":277},[87,3102,2786],{"class":284},[87,3104,3105],{"class":122},"(u)\n",[87,3107,3108],{"class":89,"line":2067},[87,3109,3110],{"class":232},"            continue\n",[87,3112,3113,3116],{"class":89,"line":2077},[87,3114,3115],{"class":232},"        except",[87,3117,329],{"class":122},[87,3119,3120,3122,3124,3127,3130],{"class":89,"line":2083},[87,3121,2946],{"class":232},[87,3123,3069],{"class":122},[87,3125,3126],{"class":277},"==",[87,3128,3129],{"class":142}," 3",[87,3131,329],{"class":122},[87,3133,3134,3137,3139],{"class":89,"line":2088},[87,3135,3136],{"class":122},"                new_u ",[87,3138,278],{"class":277},[87,3140,3141],{"class":122}," u\n",[87,3143,3144,3147,3149,3152,3154,3156,3159,3161,3164,3166,3169,3171,3173],{"class":89,"line":2121},[87,3145,3146],{"class":247},"                print",[87,3148,251],{"class":122},[87,3150,3151],{"class":232},"f",[87,3153,1613],{"class":97},[87,3155,476],{"class":142},[87,3157,3158],{"class":122},"u",[87,3160,482],{"class":142},[87,3162,3163],{"class":97}," 无法上传：",[87,3165,476],{"class":142},[87,3167,3168],{"class":122},"e",[87,3170,482],{"class":142},[87,3172,1613],{"class":97},[87,3174,348],{"class":122},[87,3176,3177,3180,3182],{"class":89,"line":2130},[87,3178,3179],{"class":122},"    url_dict[u] ",[87,3181,278],{"class":277},[87,3183,3184],{"class":122}," new_u\n",[87,3186,3187,3190,3192,3194,3196,3198,3201,3203,3206,3208,3210,3213,3215,3217],{"class":89,"line":2143},[87,3188,3189],{"class":247},"    print",[87,3191,251],{"class":122},[87,3193,3151],{"class":232},[87,3195,1613],{"class":97},[87,3197,476],{"class":142},[87,3199,3200],{"class":122},"i",[87,3202,482],{"class":142},[87,3204,3205],{"class":97}," / ",[87,3207,476],{"class":142},[87,3209,3012],{"class":247},[87,3211,3212],{"class":122},"(pic_urls)",[87,3214,482],{"class":142},[87,3216,1613],{"class":97},[87,3218,348],{"class":122},[87,3220,3221],{"class":89,"line":2156},[87,3222,587],{"emptyLinePlaceholder":586},[87,3224,3225],{"class":89,"line":2161},[87,3226,3227],{"class":1357},"# 对 _files 列表中的文件一一完成替换\n",[87,3229,3230,3232,3234,3236],{"class":89,"line":2166},[87,3231,1035],{"class":232},[87,3233,2847],{"class":135},[87,3235,1041],{"class":232},[87,3237,3238],{"class":122}," _files:\n",[87,3240,3241,3243,3245,3247,3249,3251,3253,3255,3257],{"class":89,"line":2171},[87,3242,244],{"class":232},[87,3244,248],{"class":247},[87,3246,251],{"class":122},[87,3248,2890],{"class":135},[87,3250,257],{"class":122},[87,3252,260],{"class":97},[87,3254,263],{"class":122},[87,3256,266],{"class":232},[87,3258,269],{"class":122},[87,3260,3261,3264,3266,3268,3270],{"class":89,"line":2200},[87,3262,3263],{"class":122},"        content ",[87,3265,278],{"class":277},[87,3267,2920],{"class":122},[87,3269,2923],{"class":284},[87,3271,384],{"class":122},[87,3273,3274,3276,3279,3281,3284,3287],{"class":89,"line":2205},[87,3275,293],{"class":232},[87,3277,3278],{"class":122}," k, v ",[87,3280,299],{"class":232},[87,3282,3283],{"class":122}," url_dict.",[87,3285,3286],{"class":284},"items",[87,3288,239],{"class":122},[87,3290,3291,3293,3295,3298,3301],{"class":89,"line":2225},[87,3292,3263],{"class":122},[87,3294,278],{"class":277},[87,3296,3297],{"class":122}," content.",[87,3299,3300],{"class":284},"replace",[87,3302,3303],{"class":122},"(k, v)\n",[87,3305,3306,3308,3310,3312,3314,3316,3319,3321,3323],{"class":89,"line":2248},[87,3307,244],{"class":232},[87,3309,248],{"class":247},[87,3311,251],{"class":122},[87,3313,2890],{"class":135},[87,3315,257],{"class":122},[87,3317,3318],{"class":97},"'w'",[87,3320,263],{"class":122},[87,3322,266],{"class":232},[87,3324,269],{"class":122},[87,3326,3327,3330,3333],{"class":89,"line":2253},[87,3328,3329],{"class":122},"        f.",[87,3331,3332],{"class":284},"write",[87,3334,3335],{"class":122},"(content)\n",[87,3337,3338,3340,3342,3345,3347,3349],{"class":89,"line":2270},[87,3339,3189],{"class":247},[87,3341,251],{"class":122},[87,3343,3344],{"class":97},"\"完成替换：\"",[87,3346,257],{"class":122},[87,3348,2890],{"class":135},[87,3350,348],{"class":122},[512,3352,3353],{},"html pre.shiki code .sW2Sy, html code.shiki .sW2Sy{--shiki-default:#A0A1A7;--shiki-default-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic}html pre.shiki code .sJa8x, html code.shiki .sJa8x{--shiki-default:#E45649;--shiki-dark:#E06C75}html pre.shiki code .sknuh, html code.shiki .sknuh{--shiki-default:#383A42;--shiki-dark:#56B6C2}html pre.shiki code .sDhpE, html code.shiki .sDhpE{--shiki-default:#50A14F;--shiki-dark:#98C379}html pre.shiki code .sAdtL, html code.shiki .sAdtL{--shiki-default:#4078F2;--shiki-dark:#61AFEF}html pre.shiki code .sLKXg, html code.shiki .sLKXg{--shiki-default:#A626A4;--shiki-dark:#C678DD}html pre.shiki code .s_Sar, html code.shiki .s_Sar{--shiki-default:#0184BC;--shiki-dark:#56B6C2}html pre.shiki code .s5ixo, html code.shiki .s5ixo{--shiki-default:#383A42;--shiki-dark:#ABB2BF}html pre.shiki code .sDaw7, html code.shiki .sDaw7{--shiki-default:#0184BC;--shiki-dark:#E06C75}html pre.shiki code .sAGMh, html code.shiki .sAGMh{--shiki-default:#986801;--shiki-dark:#D19A66}html pre.shiki code .sTIpt, html code.shiki .sTIpt{--shiki-default:#E45649;--shiki-dark:#98C379}html pre.shiki code .s8iYz, html code.shiki .s8iYz{--shiki-default:#383A42;--shiki-default-font-style:inherit;--shiki-dark:#E06C75;--shiki-dark-font-style:italic}html .default .shiki span {color: var(--shiki-default);background: var(--shiki-default-bg);font-style: var(--shiki-default-font-style);font-weight: var(--shiki-default-font-weight);text-decoration: var(--shiki-default-text-decoration);}html .shiki span {color: var(--shiki-default);background: var(--shiki-default-bg);font-style: var(--shiki-default-font-style);font-weight: var(--shiki-default-font-weight);text-decoration: var(--shiki-default-text-decoration);}html .dark .shiki span {color: var(--shiki-dark);background: var(--shiki-dark-bg);font-style: var(--shiki-dark-font-style);font-weight: var(--shiki-dark-font-weight);text-decoration: var(--shiki-dark-text-decoration);}html.dark .shiki span {color: var(--shiki-dark);background: var(--shiki-dark-bg);font-style: var(--shiki-dark-font-style);font-weight: var(--shiki-dark-font-weight);text-decoration: var(--shiki-dark-text-decoration);}html pre.shiki code .sYebD, html code.shiki .sYebD{--shiki-default:#383A42;--shiki-dark:#D19A66}html pre.shiki code .so_Uh, html code.shiki .so_Uh{--shiki-default:#986801;--shiki-default-font-style:inherit;--shiki-dark:#D19A66;--shiki-dark-font-style:italic}html pre.shiki code .slOjB, html code.shiki .slOjB{--shiki-default:#383A42;--shiki-dark:#61AFEF}html pre.shiki code .sp7wS, html code.shiki .sp7wS{--shiki-default:#986801;--shiki-default-font-style:inherit;--shiki-dark:#E06C75;--shiki-dark-font-style:italic}",{"title":82,"searchDepth":126,"depth":126,"links":3355},[3356,3357],{"id":1338,"depth":126,"text":1338},{"id":2610,"depth":126,"text":2610},{"title":3359,"date":3360,"path":3361,"tags":3362,"body":3365},"自建图床小记三—— SSL 证书的自动更新与部署","2024-08-14 10:35:18","/2024/08/14/auto-renew-ssl-certificate-and-deploy-to-upyun-with-github-action",[13,1259,3363,525,526,3364,1258],"Github Action","SSL",{"type":15,"value":3366,"toc":3910},[3367,3371,3374,3377,3381,3385,3388,3394,3397,3400,3406,3409,3413,3416,3425,3428,3431,3437,3443,3446,3452,3455,3495,3498,3504,3510,3514,3523,3530,3535,3571,3575,3605,3609,3639,3643,3692,3695,3724,3728,3767,3770,3779,3876,3882,3884,3907],[540,3368,3370],{"id":3369},"为什么要自动更新","为什么要自动更新？",[18,3372,3373],{},"众所周知，为站点开启 https 访问需要获得对应 host 的 ssl 证书，而如果希望证书被访客的浏览器所信任，需要拿到由 Certificate Authority (CA) 签发的 ssl 证书。在前一阵子那波 BAT 等大厂提供的云服务停止发放免费的由 TrustAsia/DigiCert 签发的一年有效期免费 ssl 证书之后，市面上已经没有被广泛信任的 CA 签发的免费的一年有效期的 ssl 证书了，于是不得不用回由 Let's Encrypt/ZeroSSL 等 CA 签发三个月免费证书。",[18,3375,3376],{},"但话又说回来，三个月有效期确实不太够，一年有效期的证书就一年一更，手动申请部署也不麻烦；三个月有效期的证书手动就有点麻烦了——我一般会在证书到期的前 15 天进行更新，防止最后几天自己太忙了没时间管。",[540,3378,3380],{"id":3379},"这套图床架构的自动更新有没有困难","这套图床架构的自动更新有没有困难？",[3382,3383,3384],"h3",{"id":3384},"境外",[18,3386,3387],{},"通过 Cloudflare SaaS 接入的域名通过验证后会自动获得由 Cloudflare 提供的由 Google Trust Services 签发的证书，不需要我们操心。",[18,3389,3390],{},[59,3391],{"alt":3392,"src":3393},"SSL Certificate provided by Cloudflare","https://static.031130.xyz/uploads/2024/08/14/831d714565906.webp",[3382,3395,3396],{"id":3396},"境内",[18,3398,3399],{},"咱选用的又拍云 CDN 提供了免费的 Let's Encrypt 证书及其自动续期服务，但需要我们把图床访问域名的 DNS CNAME 解析到他们家。",[18,3401,3402],{},[59,3403],{"alt":3404,"src":3405},"SSL Certificate provided by upyun","https://static.031130.xyz/uploads/2024/08/14/b16f7752ef522.webp",[18,3407,3408],{},"这里有个问题，我们这套图床架构在境外的解析是解析到 Cloudflare 的，不可能通过 Let's Encrypt 的 acme challenge。如果使用 upyun 申请 ssl 证书，则意味着每次更新都要我们手动将境外的 dns 解析记录暂时解析到又拍云，待证书更新成功后再解析回 Cloudflare，非常麻烦。",[540,3410,3412],{"id":3411},"使用-github-action-跑-acmesh-获取-ssl-证书","使用 Github Action 跑 acme.sh 获取 ssl 证书",[18,3414,3415],{},"本着「能使用长期免费稳定服务就使用长期免费稳定服务」的思想，决定使用 Github Action 申请 ssl 证书。",[18,3417,3418,3419,3424],{},"在 Github Action 跑 acme.sh 获取 ssl 证书意味着不能使用 http 文件检验的方式检验域名所有权，需要使用 dns 检验。截至本文写作时间，acme.sh 已经支持了 150+ 个主流的 DNS 解析商（Managed DNS providers）的 api，针对不支持 api 修改 dns 解析记录的，还可以使用 ",[43,3420,3423],{"href":3421,"rel":3422},"https://github.com/acmesh-official/acme.sh/wiki/DNS-alias-mode",[561],"DNS alias 模式","——即将需要申请 ssl 证书的域名先 cname 到一个工具人域名上，将工具人域名通过 NS 解析到 acme.sh 支持的 DNS 解析商，进而实现 CA 对域名所有权的验证。",[3382,3426,3427],{"id":3427},"先在本地跑起来",[18,3429,3430],{},"我采用的是 Cloudflare，直接在个人资料页创建一个具有编辑 DNS 权限的 API 令牌",[18,3432,3433],{},[59,3434],{"alt":3435,"src":3436},"创建令牌","https://static.031130.xyz/uploads/2024/08/14/c0262d4aea708.webp",[18,3438,3439],{},[59,3440],{"alt":3441,"src":3442},"获得令牌","https://static.031130.xyz/uploads/2024/08/14/f30bfc93970bc.webp",[18,3444,3445],{},"随后在自己的域名页面，找到区域 ID 和 账户 ID",[18,3447,3448],{},[59,3449],{"alt":3450,"src":3451},"区域 ID 和 账户 ID","https://static.031130.xyz/uploads/2024/08/14/4c8d4a2019812.webp",[18,3453,3454],{},"在自己的本机安装 acme.sh,设置好 Cloudflare DNS 的几个变量",[77,3456,3458],{"className":566,"code":3457,"language":568,"meta":82,"style":82},"export CF_Token=\"\"\nexport CF_Account_ID=\"\"\nexport CF_Zone_ID=\"\"\n",[84,3459,3460,3473,3484],{"__ignoreMap":82},[87,3461,3462,3465,3468,3470],{"class":89,"line":90},[87,3463,3464],{"class":232},"export",[87,3466,3467],{"class":135}," CF_Token",[87,3469,278],{"class":277},[87,3471,3472],{"class":97},"\"\"\n",[87,3474,3475,3477,3480,3482],{"class":89,"line":126},[87,3476,3464],{"class":232},[87,3478,3479],{"class":135}," CF_Account_ID",[87,3481,278],{"class":277},[87,3483,3472],{"class":97},[87,3485,3486,3488,3491,3493],{"class":89,"line":132},[87,3487,3464],{"class":232},[87,3489,3490],{"class":135}," CF_Zone_ID",[87,3492,278],{"class":277},[87,3494,3472],{"class":97},[18,3496,3497],{},"随后可以尝试使用 acme.sh 签发 ssl 证书",[77,3499,3502],{"className":3500,"code":3501,"language":721},[719],"acme.sh --issue --dns dns_cf -d cdn.example.com\n",[84,3503,3501],{"__ignoreMap":82},[18,3505,3506],{},[59,3507],{"alt":3508,"src":3509},"ssl 证书到手","https://static.031130.xyz/uploads/2024/08/14/c78bc5afa3641.webp",[3382,3511,3513],{"id":3512},"上-github-action","上 Github Action",[18,3515,3516,3517,3522],{},"原本是打算直接用 ",[43,3518,3521],{"href":3519,"rel":3520},"https://github.com/Menci/acme",[561],"Menci/acme"," 这个 Action的，可惜遇到了点问题。",[18,3524,3525,3526,3529],{},"在我本地，Cloudflare 相关的 Token 和 ID 并没有被写入到 account.conf，而是被写在 ",[84,3527,3528],{},"cdn.example.com_ecc/cdn.exampe.com.conf","，大概就没办法直接用这个 Action 了，不得不转去手搓。不过好在 Menci/acme 中还是能抄到不少的。",[3531,3532,3534],"h4",{"id":3533},"压缩本地的-ca-文件夹","压缩本地的 ca 文件夹",[77,3536,3538],{"className":566,"code":3537,"language":568,"meta":82,"style":82},"cd $HOME/.acme.sh/ && tar cz ca | base64 -w0\n",[84,3539,3540],{"__ignoreMap":82},[87,3541,3542,3545,3548,3551,3554,3557,3560,3563,3565,3568],{"class":89,"line":90},[87,3543,3544],{"class":247},"cd",[87,3546,3547],{"class":135}," $HOME",[87,3549,3550],{"class":97},"/.acme.sh/",[87,3552,3553],{"class":122}," && ",[87,3555,3556],{"class":93},"tar",[87,3558,3559],{"class":97}," cz",[87,3561,3562],{"class":97}," ca",[87,3564,930],{"class":122},[87,3566,3567],{"class":93},"base64",[87,3569,3570],{"class":142}," -w0\n",[3531,3572,3574],{"id":3573},"安装-acmesh","安装 acme.sh",[77,3576,3580],{"className":3577,"code":3578,"language":3579,"meta":82,"style":82},"language-yaml shiki shiki-themes one-light one-dark-pro","- name: Install acme.sh\n  run: curl https://get.acme.sh | sh\n","yaml",[84,3581,3582,3595],{"__ignoreMap":82},[87,3583,3584,3587,3590,3592],{"class":89,"line":90},[87,3585,3586],{"class":122},"- ",[87,3588,3589],{"class":135},"name",[87,3591,139],{"class":122},[87,3593,3594],{"class":97},"Install acme.sh\n",[87,3596,3597,3600,3602],{"class":89,"line":126},[87,3598,3599],{"class":135},"  run",[87,3601,139],{"class":122},[87,3603,3604],{"class":97},"curl https://get.acme.sh | sh\n",[3531,3606,3608],{"id":3607},"解压-ca-文件夹","解压 ca 文件夹",[77,3610,3612],{"className":3577,"code":3611,"language":3579,"meta":82,"style":82},"- name: Extract account files for acme.sh\n  run: |\n    echo \"${{ secrets.ACME_SH_ACCOUNT_TAR }}\" | base64 -d | tar -C ~/.acme.sh -xz\n",[84,3613,3614,3625,3634],{"__ignoreMap":82},[87,3615,3616,3618,3620,3622],{"class":89,"line":90},[87,3617,3586],{"class":122},[87,3619,3589],{"class":135},[87,3621,139],{"class":122},[87,3623,3624],{"class":97},"Extract account files for acme.sh\n",[87,3626,3627,3629,3631],{"class":89,"line":126},[87,3628,3599],{"class":135},[87,3630,139],{"class":122},[87,3632,3633],{"class":232},"|\n",[87,3635,3636],{"class":89,"line":132},[87,3637,3638],{"class":97},"    echo \"${{ secrets.ACME_SH_ACCOUNT_TAR }}\" | base64 -d | tar -C ~/.acme.sh -xz\n",[3531,3640,3642],{"id":3641},"执行-acmesh-申请证书","执行 acme.sh 申请证书",[77,3644,3646],{"className":3577,"code":3645,"language":3579,"meta":82,"style":82},"- name: Issue Certificate\n  run: |\n    export CF_Token=\"${{ secrets.CF_TOKEN }}\"\n    export CF_Zone_ID=\"${{ secrets.CF_ZONE_ID }}\"\n    export CF_Account_ID=\"${{ secrets.CF_ACCOUNT_ID }}\"\n    mkdir -p output\n    ~/.acme.sh/acme.sh --issue --dns dns_cf --force -d ${{ env.domain }} --fullchain-file output/fullchain.pem --key-file output/key.pem\n",[84,3647,3648,3659,3667,3672,3677,3682,3687],{"__ignoreMap":82},[87,3649,3650,3652,3654,3656],{"class":89,"line":90},[87,3651,3586],{"class":122},[87,3653,3589],{"class":135},[87,3655,139],{"class":122},[87,3657,3658],{"class":97},"Issue Certificate\n",[87,3660,3661,3663,3665],{"class":89,"line":126},[87,3662,3599],{"class":135},[87,3664,139],{"class":122},[87,3666,3633],{"class":232},[87,3668,3669],{"class":89,"line":132},[87,3670,3671],{"class":97},"    export CF_Token=\"${{ secrets.CF_TOKEN }}\"\n",[87,3673,3674],{"class":89,"line":149},[87,3675,3676],{"class":97},"    export CF_Zone_ID=\"${{ secrets.CF_ZONE_ID }}\"\n",[87,3678,3679],{"class":89,"line":3},[87,3680,3681],{"class":97},"    export CF_Account_ID=\"${{ secrets.CF_ACCOUNT_ID }}\"\n",[87,3683,3684],{"class":89,"line":174},[87,3685,3686],{"class":97},"    mkdir -p output\n",[87,3688,3689],{"class":89,"line":185},[87,3690,3691],{"class":97},"    ~/.acme.sh/acme.sh --issue --dns dns_cf --force -d ${{ env.domain }} --fullchain-file output/fullchain.pem --key-file output/key.pem\n",[3531,3693,3694],{"id":3694},"压缩证书",[77,3696,3698],{"className":3577,"code":3697,"language":3579,"meta":82,"style":82},"- name: zip Certificate\n  run: |\n    zip -j output/${{ env.domain }}_$(date +%Y%m%d).zip output/fullchain.pem output/key.pem\n",[84,3699,3700,3711,3719],{"__ignoreMap":82},[87,3701,3702,3704,3706,3708],{"class":89,"line":90},[87,3703,3586],{"class":122},[87,3705,3589],{"class":135},[87,3707,139],{"class":122},[87,3709,3710],{"class":97},"zip Certificate\n",[87,3712,3713,3715,3717],{"class":89,"line":126},[87,3714,3599],{"class":135},[87,3716,139],{"class":122},[87,3718,3633],{"class":232},[87,3720,3721],{"class":89,"line":132},[87,3722,3723],{"class":97},"    zip -j output/${{ env.domain }}_$(date +%Y%m%d).zip output/fullchain.pem output/key.pem\n",[3531,3725,3727],{"id":3726},"通过-tg-bot-发送压缩包给自己","通过 tg bot 发送压缩包给自己",[77,3729,3731],{"className":3577,"code":3730,"language":3579,"meta":82,"style":82},"- name: Push Certificate\n  run: |\n    TG_BOT_TOKEN=\"${{ secrets.TG_BOT_TOKEN }}\"\n    TG_CHAT_ID=\"${{ secrets.TG_CHAT_ID }}\"\n    curl -s -X POST https://api.telegram.org/bot${TG_BOT_TOKEN}/sendDocument -F chat_id=${TG_CHAT_ID} -F document=\"@output/${{ env.domain }}_$(date +%Y%m%d).zip\"\n",[84,3732,3733,3744,3752,3757,3762],{"__ignoreMap":82},[87,3734,3735,3737,3739,3741],{"class":89,"line":90},[87,3736,3586],{"class":122},[87,3738,3589],{"class":135},[87,3740,139],{"class":122},[87,3742,3743],{"class":97},"Push Certificate\n",[87,3745,3746,3748,3750],{"class":89,"line":126},[87,3747,3599],{"class":135},[87,3749,139],{"class":122},[87,3751,3633],{"class":232},[87,3753,3754],{"class":89,"line":132},[87,3755,3756],{"class":97},"    TG_BOT_TOKEN=\"${{ secrets.TG_BOT_TOKEN }}\"\n",[87,3758,3759],{"class":89,"line":149},[87,3760,3761],{"class":97},"    TG_CHAT_ID=\"${{ secrets.TG_CHAT_ID }}\"\n",[87,3763,3764],{"class":89,"line":3},[87,3765,3766],{"class":97},"    curl -s -X POST https://api.telegram.org/bot${TG_BOT_TOKEN}/sendDocument -F chat_id=${TG_CHAT_ID} -F document=\"@output/${{ env.domain }}_$(date +%Y%m%d).zip\"\n",[3531,3768,3769],{"id":3769},"部署到又拍云",[18,3771,3772,3773,3778],{},"这里使用的是 ",[43,3774,3777],{"href":3775,"rel":3776},"https://github.com/Menci/deploy-certificate-to-upyun/",[561],"menci/deploy-certificate-to-upyun","。由于又拍云没有提供上传 ssl 证书的 api，因此只能通过模拟用户登陆的方式实现。",[77,3780,3782],{"className":3577,"code":3781,"language":3579,"meta":82,"style":82},"- name: Deploy To Upyun\n  uses: Menci/deploy-certificate-to-upyun@beta-v2\n  with:\n    subaccount-username: ${{ secrets.UPYUN_SUBACCOUNT_USERNAME }}\n    subaccount-password: ${{ secrets.UPYUN_SUBACCOUNT_PASSWORD }}\n    fullchain-file: output/fullchain.pem\n    key-file: output/key.pem\n    domains: |\n      ${{ env.domain }}\n    delete-unused-certificates: true\n",[84,3783,3784,3795,3805,3812,3822,3832,3842,3852,3861,3866],{"__ignoreMap":82},[87,3785,3786,3788,3790,3792],{"class":89,"line":90},[87,3787,3586],{"class":122},[87,3789,3589],{"class":135},[87,3791,139],{"class":122},[87,3793,3794],{"class":97},"Deploy To Upyun\n",[87,3796,3797,3800,3802],{"class":89,"line":126},[87,3798,3799],{"class":135},"  uses",[87,3801,139],{"class":122},[87,3803,3804],{"class":97},"Menci/deploy-certificate-to-upyun@beta-v2\n",[87,3806,3807,3810],{"class":89,"line":132},[87,3808,3809],{"class":135},"  with",[87,3811,329],{"class":122},[87,3813,3814,3817,3819],{"class":89,"line":149},[87,3815,3816],{"class":135},"    subaccount-username",[87,3818,139],{"class":122},[87,3820,3821],{"class":97},"${{ secrets.UPYUN_SUBACCOUNT_USERNAME }}\n",[87,3823,3824,3827,3829],{"class":89,"line":3},[87,3825,3826],{"class":135},"    subaccount-password",[87,3828,139],{"class":122},[87,3830,3831],{"class":97},"${{ secrets.UPYUN_SUBACCOUNT_PASSWORD }}\n",[87,3833,3834,3837,3839],{"class":89,"line":174},[87,3835,3836],{"class":135},"    fullchain-file",[87,3838,139],{"class":122},[87,3840,3841],{"class":97},"output/fullchain.pem\n",[87,3843,3844,3847,3849],{"class":89,"line":185},[87,3845,3846],{"class":135},"    key-file",[87,3848,139],{"class":122},[87,3850,3851],{"class":97},"output/key.pem\n",[87,3853,3854,3857,3859],{"class":89,"line":191},[87,3855,3856],{"class":135},"    domains",[87,3858,139],{"class":122},[87,3860,3633],{"class":232},[87,3862,3863],{"class":89,"line":198},[87,3864,3865],{"class":97},"      ${{ env.domain }}\n",[87,3867,3868,3871,3873],{"class":89,"line":387},[87,3869,3870],{"class":135},"    delete-unused-certificates",[87,3872,139],{"class":122},[87,3874,3875],{"class":142},"true\n",[18,3877,3878],{},[59,3879],{"alt":3880,"src":3881},"SSL 证书成功部署到又拍云","https://static.031130.xyz/uploads/2024/08/14/222a754d25c97.webp",[540,3883,801],{"id":801},[203,3885,3886,3893,3900],{},[206,3887,3888],{},[43,3889,3892],{"href":3890,"rel":3891},"https://blog.men.ci/ssl-with-github-actions/",[561],"使用 GitHub Actions 自动申请与部署 ACME SSL 证书",[206,3894,3895],{},[43,3896,3899],{"href":3897,"rel":3898},"https://shiping.date/82.html",[561],"（续）acme.sh脚本使用新cloudflare api令牌申请证书",[206,3901,3902],{},[43,3903,3906],{"href":3904,"rel":3905},"https://github.com/acmesh-official/acme.sh",[561],"acmesh-official/acme.sh",[512,3908,3909],{},"html pre.shiki code .sLKXg, html code.shiki .sLKXg{--shiki-default:#A626A4;--shiki-dark:#C678DD}html pre.shiki code .sJa8x, html code.shiki .sJa8x{--shiki-default:#E45649;--shiki-dark:#E06C75}html pre.shiki code .sknuh, html code.shiki .sknuh{--shiki-default:#383A42;--shiki-dark:#56B6C2}html pre.shiki code .sDhpE, html code.shiki .sDhpE{--shiki-default:#50A14F;--shiki-dark:#98C379}html .default .shiki span {color: var(--shiki-default);background: var(--shiki-default-bg);font-style: var(--shiki-default-font-style);font-weight: var(--shiki-default-font-weight);text-decoration: var(--shiki-default-text-decoration);}html .shiki span {color: var(--shiki-default);background: var(--shiki-default-bg);font-style: var(--shiki-default-font-style);font-weight: var(--shiki-default-font-weight);text-decoration: var(--shiki-default-text-decoration);}html .dark .shiki span {color: var(--shiki-dark);background: var(--shiki-dark-bg);font-style: var(--shiki-dark-font-style);font-weight: var(--shiki-dark-font-weight);text-decoration: var(--shiki-dark-text-decoration);}html.dark .shiki span {color: var(--shiki-dark);background: var(--shiki-dark-bg);font-style: var(--shiki-dark-font-style);font-weight: var(--shiki-dark-font-weight);text-decoration: var(--shiki-dark-text-decoration);}html pre.shiki code .s_Sar, html code.shiki .s_Sar{--shiki-default:#0184BC;--shiki-dark:#56B6C2}html pre.shiki code .s5ixo, html code.shiki .s5ixo{--shiki-default:#383A42;--shiki-dark:#ABB2BF}html pre.shiki code .sAdtL, html code.shiki .sAdtL{--shiki-default:#4078F2;--shiki-dark:#61AFEF}html pre.shiki code .sAGMh, html code.shiki .sAGMh{--shiki-default:#986801;--shiki-dark:#D19A66}",{"title":82,"searchDepth":126,"depth":126,"links":3911},[3912,3913,3917,3921],{"id":3369,"depth":126,"text":3370},{"id":3379,"depth":126,"text":3380,"children":3914},[3915,3916],{"id":3384,"depth":132,"text":3384},{"id":3396,"depth":132,"text":3396},{"id":3411,"depth":126,"text":3412,"children":3918},[3919,3920],{"id":3427,"depth":132,"text":3427},{"id":3512,"depth":132,"text":3513},{"id":801,"depth":126,"text":801},{"title":3923,"date":3924,"path":3925,"tags":3926,"body":3929},"自建图床小记二——使用 Workers 为 R2 构建 Restful API","2024-08-13 22:58:26","/2024/08/13/build-restful-api-for-cloudflare-r2-with-cloudflare-workers",[1258,3927,3928,11],"Cloudflare","JavaScript",{"type":15,"value":3930,"toc":5337},[3931,3935,3938,3942,3948,3952,3958,3960,3965,3969,3972,3975,3982,3988,3991,3998,4000,4005,4009,4012,4015,4021,4025,4030,4045,4050,4054,4057,4061,4075,4081,4083,4088,4092,4095,4103,4107,4110,5016,5019,5033,5036,5040,5043,5048,5052,5055,5058,5186,5189,5196,5199,5202,5304,5306,5334],[540,3932,3934],{"id":3933},"访问-r2-的两种方式","访问 R2 的两种方式",[18,3936,3937],{},"一般来说，想要访问 Cloudflare R2 中的文件，会有两种方式。",[3382,3939,3941],{"id":3940},"一种是在-r2-的设置界面设置自定义域","一种是在 R2 的设置界面设置自定义域",[18,3943,3944],{},[59,3945],{"alt":3946,"src":3947},"设置自定义域","https://static.031130.xyz/uploads/2024/08/13/61fe9ede194af.webp",[3382,3949,3951],{"id":3950},"另一种是通过-cloudflare-workers-进行访问","另一种是通过 Cloudflare Workers 进行访问",[18,3953,3954],{},[59,3955],{"alt":3956,"src":3957},"通过 Cloudflare Workers","https://static.031130.xyz/uploads/2024/08/13/846164273571d.webp",[778,3959],{},[18,3961,3962],{},[29,3963,3964],{},"那么应该选择哪种？选择 Cloudflare Workers！",[540,3966,3968],{"id":3967},"为什么是-cloudflare-workers","为什么是 Cloudflare Workers？",[18,3970,3971],{},"要回答这个问题比较困难，但可以回答另一个问题——「为什么不设置自定义域实现直接访问？」",[3382,3973,3974],{"id":3974},"自定义域的访问存在限制",[18,3976,3977,3978,3981],{},"设置自定义域的访问方式存在较多的限制，让我们先来复习一下",[43,3979,3980],{"href":1324},"上一篇博客中","提到的 DNS 解析方案 1",[18,3983,3984],{},[59,3985],{"alt":3986,"src":3987},"DNS 解析方案 1","https://static.031130.xyz/uploads/2024/08/13/03d8243b67593.webp",[18,3989,3990],{},"在这里，我们需要将图床访问域名通过 NS 接入 DnsPod 实现境内外的分流，但 R2 所允许设置的自定义域必须是通过 NS 接入 Cloudflare 的，这存在冲突。那如果我们先将自定义域设置为通过 NS 接入 Cloudflare 的工具人域名，再将图床访问域名通过 CNAME 解析到工具人域名会不会有问题呢？恭喜你获得 403 Forbidden。",[18,3992,3993,3994,3997],{},"如果通过",[43,3995,3996],{"href":1324},"上一篇文章","中的 DNS 解析方案 2 来进行 DNS 解析，能不能成功设置为 Cloudflare R2 的自定义域呢？也不行，Cloudflare R2 的自定义域会占用域名的解析，这意味着你无法将图床访问域名解析到用于分流的工具人域名。",[778,3999],{},[18,4001,4002],{},[29,4003,4004],{},"结论：截至本文写作时间，设置自定义域的方案不适用于 DNS 分流的图床架构。",[3382,4006,4008],{"id":4007},"如何上传文件到-cloudflare-r2","如何上传文件到 Cloudflare R2？",[3531,4010,4011],{"id":4011},"网页端直接上传",[18,4013,4014],{},"最简单的上传方式是直接在 Cloudflare 进行网页上传，但这种方案不适合自动化脚本，也没法接入 Typora",[18,4016,4017],{},[59,4018],{"alt":4019,"src":4020},"直接在网页端进行上传","https://static.031130.xyz/uploads/2024/08/13/b4d1b5b3edfae.webp",[3531,4022,4024],{"id":4023},"使用-amazon-s3-的兼容-api","使用 Amazon S3 的兼容 API",[4026,4027,4029],"h5",{"id":4028},"手动调用-s3-api","手动调用 S3 API",[18,4031,4032,4033,4038,4039,4044],{},"Cloudflare R2 被设计为兼容 Amazon S3 的存储方案，自然兼容 Amazon S3 的上传 API，在 ",[43,4034,4037],{"href":4035,"rel":4036},"https://developers.cloudflare.com/r2/api/s3/api/",[561],"Cloudflare Docs 中有关于 S3 API 的实现情况","记载，大部分接口功能都是实现了的。但。。。但 S3 使用的是 ",[43,4040,4043],{"href":4041,"rel":4042},"https://docs.aws.amazon.com/zh_cn/IAM/latest/UserGuide/create-signed-request.html",[561],"AWS Signature"," 作为鉴权，你不会希望在每个自动化程序中都自己实现一次的。。。",[18,4046,4047],{},[59,4048],{"alt":4049,"src":4049},"https://docs.aws.amazon.com/zh_cn/IAM/latest/UserGuide/images/sigV4-using-auth-header.png",[4026,4051,4053],{"id":4052},"使用-aws-cli-等-sdk","使用 aws-cli 等 SDK",[18,4055,4056],{},"使用 aws-cli 可以自动实现计算 AWS Signature，这是一种可行的方案，但我可能会在别的服务中使用到我的图床，不是所有的服务所处的环境都能够执行 shell 命令，也不是所有的编程语言都有现成的 SDK 可用。",[3531,4058,4060],{"id":4059},"使用-cloudflare-workers-构建-restful-api","使用 Cloudflare Workers 构建 Restful API",[18,4062,4063,4068,4069,4074],{},[43,4064,4067],{"href":4065,"rel":4066},"https://developers.cloudflare.com/r2/api/workers/workers-api-usage/#5-access-your-r2-bucket-from-your-worker",[561],"在 Cloudflare Docs 中明确提出可以使用 Cloudflare Workers 访问 Cloudflare R2 Bucket，","通过 Workers 设置界面的按钮，可以非常方便的将 R2 Bucket 作为一个 R2Object 绑定到 JavaScript 的一个变量中，",[43,4070,4073],{"href":4071,"rel":4072},"https://developers.cloudflare.com/r2/api/workers/workers-api-reference/",[561],"这里有相关的开发文档","。",[18,4076,4077],{},[59,4078],{"alt":4079,"src":4080},"绑定为变量","https://static.031130.xyz/uploads/2024/08/13/45e58b47f3aeb.webp",[778,4082],{},[18,4084,4085],{},[29,4086,4087],{},"结论: 从易用性上来看，使用 Cloudflare Workers 构建 Restful API 这种上传文件的方案是最为合适的。",[540,4089,4091],{"id":4090},"使用-cloudflare-workers-构建-restful-api-的方案有没有什么缺点","使用 Cloudflare Workers 构建 Restful API 的方案有没有什么缺点？",[18,4093,4094],{},"有。",[203,4096,4097,4100],{},[206,4098,4099],{},"Cloudflare Workers 的每日额度是有限的，在极端的流量下可能会用完（应该不会吧？）",[206,4101,4102],{},"Cloudflare Workers 的内存限制为 128MB，在上传下载 > 100MB 的文件时可能会出错。有这种体积上传需求的场景建议使用别的上传方案。",[540,4104,4106],{"id":4105},"如何构建","如何构建？",[18,4108,4109],{},"直接贴代码",[77,4111,4115],{"className":4112,"code":4113,"language":4114,"meta":82,"style":82},"language-javascript shiki shiki-themes one-light one-dark-pro","const hasValidHeader = (request, env) => {\n    return request.headers.get('X-Custom-Auth-Key') === env.AUTH_KEY_SECRET;\n};\n\nfunction authorizeRequest(request, env, key) {\n    switch (request.method) {\n        case 'PUT':\n        case 'DELETE':\n            return hasValidHeader(request, env);\n        case 'GET':\n            return true;\n        default:\n            return false;\n    }\n}\n\nexport default {\n    async fetch(request, env) {\n        const url = new URL(request.url);\n        const key = decodeURI(url.pathname.slice(1));\n\n        if (!authorizeRequest(request, env, key)) {\n            return new Response('Forbidden\\n', { status: 403 });\n        }\n\n        switch (request.method) {\n            case 'PUT':\n                const objectExists = await env.MY_BUCKET.get(key);\n\n                if (objectExists !== null) {\n                    if (request.headers.get('Overwrite') !== 'true') {\n                        return new Response('Object Already Exists\\n', { status: 409 });\n                    }\n                }\n\n                await env.MY_BUCKET.put(key, request.body);\n                return new Response(`Put ${key} successfully!\\n`);\n\n            case 'GET':\n                const object = await env.MY_BUCKET.get(key);\n\n                if (object === null) {\n                    return new Response('Object Not Found\\n', { status: 404 });\n                }\n\n                const headers = new Headers();\n                object.writeHttpMetadata(headers);\n                headers.set('etag', object.httpEtag);\n\n                return new Response(object.body, {\n                    headers,\n                });\n            case 'DELETE':\n                await env.MY_BUCKET.delete(key);\n                return new Response('Deleted!\\n');\n\n            default:\n                return new Response('Method Not Allowed\\n', {\n                    status: 405,\n                    headers: {\n                        Allow: 'PUT, GET, DELETE',\n                    },\n                });\n        }\n    },\n};\n","javascript",[84,4116,4117,4146,4186,4191,4195,4219,4235,4245,4254,4273,4282,4290,4297,4306,4311,4315,4319,4329,4347,4374,4407,4411,4438,4473,4478,4482,4497,4506,4536,4540,4558,4590,4619,4624,4629,4633,4664,4695,4699,4707,4734,4738,4754,4783,4787,4791,4808,4824,4849,4853,4872,4879,4884,4892,4913,4932,4936,4943,4962,4974,4982,4994,4999,5003,5007,5012],{"__ignoreMap":82},[87,4118,4119,4122,4125,4127,4130,4133,4135,4138,4140,4143],{"class":89,"line":90},[87,4120,4121],{"class":232},"const",[87,4123,4124],{"class":93}," hasValidHeader",[87,4126,1777],{"class":247},[87,4128,4129],{"class":122}," (",[87,4131,4132],{"class":1751},"request",[87,4134,257],{"class":122},[87,4136,4137],{"class":1751},"env",[87,4139,263],{"class":122},[87,4141,4142],{"class":232},"=>",[87,4144,4145],{"class":122}," {\n",[87,4147,4148,4150,4154,4156,4160,4162,4164,4166,4169,4171,4174,4177,4179,4183],{"class":89,"line":126},[87,4149,467],{"class":232},[87,4151,4153],{"class":4152},"s7GmK"," request",[87,4155,1815],{"class":122},[87,4157,4159],{"class":4158},"s2QsP","headers",[87,4161,1815],{"class":122},[87,4163,313],{"class":93},[87,4165,251],{"class":122},[87,4167,4168],{"class":97},"'X-Custom-Auth-Key'",[87,4170,263],{"class":122},[87,4172,4173],{"class":247},"===",[87,4175,4176],{"class":4152}," env",[87,4178,1815],{"class":122},[87,4180,4182],{"class":4181},"sRZ4U","AUTH_KEY_SECRET",[87,4184,4185],{"class":122},";\n",[87,4187,4188],{"class":89,"line":132},[87,4189,4190],{"class":122},"};\n",[87,4192,4193],{"class":89,"line":149},[87,4194,587],{"emptyLinePlaceholder":586},[87,4196,4197,4200,4203,4205,4207,4209,4211,4213,4216],{"class":89,"line":3},[87,4198,4199],{"class":232},"function",[87,4201,4202],{"class":93}," authorizeRequest",[87,4204,251],{"class":122},[87,4206,4132],{"class":1751},[87,4208,257],{"class":122},[87,4210,4137],{"class":1751},[87,4212,257],{"class":122},[87,4214,4215],{"class":1751},"key",[87,4217,4218],{"class":122},") {\n",[87,4220,4221,4224,4226,4228,4230,4233],{"class":89,"line":174},[87,4222,4223],{"class":232},"    switch",[87,4225,4129],{"class":122},[87,4227,4132],{"class":4152},[87,4229,1815],{"class":122},[87,4231,4232],{"class":135},"method",[87,4234,4218],{"class":122},[87,4236,4237,4240,4243],{"class":89,"line":185},[87,4238,4239],{"class":232},"        case",[87,4241,4242],{"class":97}," 'PUT'",[87,4244,329],{"class":122},[87,4246,4247,4249,4252],{"class":89,"line":191},[87,4248,4239],{"class":232},[87,4250,4251],{"class":97}," 'DELETE'",[87,4253,329],{"class":122},[87,4255,4256,4259,4261,4263,4266,4268,4270],{"class":89,"line":198},[87,4257,4258],{"class":232},"            return",[87,4260,4124],{"class":93},[87,4262,251],{"class":122},[87,4264,4132],{"class":4265},"sz0mV",[87,4267,257],{"class":122},[87,4269,4137],{"class":4265},[87,4271,4272],{"class":122},");\n",[87,4274,4275,4277,4280],{"class":89,"line":387},[87,4276,4239],{"class":232},[87,4278,4279],{"class":97}," 'GET'",[87,4281,329],{"class":122},[87,4283,4284,4286,4288],{"class":89,"line":404},[87,4285,4258],{"class":232},[87,4287,1780],{"class":142},[87,4289,4185],{"class":122},[87,4291,4292,4295],{"class":89,"line":420},[87,4293,4294],{"class":232},"        default",[87,4296,329],{"class":122},[87,4298,4299,4301,4304],{"class":89,"line":437},[87,4300,4258],{"class":232},[87,4302,4303],{"class":142}," false",[87,4305,4185],{"class":122},[87,4307,4308],{"class":89,"line":464},[87,4309,4310],{"class":122},"    }\n",[87,4312,4313],{"class":89,"line":1479},[87,4314,1100],{"class":122},[87,4316,4317],{"class":89,"line":1491},[87,4318,587],{"emptyLinePlaceholder":586},[87,4320,4321,4323,4327],{"class":89,"line":1515},[87,4322,3464],{"class":232},[87,4324,4326],{"class":4325},"sq3v1"," default",[87,4328,4145],{"class":122},[87,4330,4331,4334,4337,4339,4341,4343,4345],{"class":89,"line":1535},[87,4332,4333],{"class":232},"    async",[87,4335,4336],{"class":93}," fetch",[87,4338,251],{"class":122},[87,4340,4132],{"class":1751},[87,4342,257],{"class":122},[87,4344,4137],{"class":1751},[87,4346,4218],{"class":122},[87,4348,4349,4352,4356,4358,4361,4364,4366,4368,4370,4372],{"class":89,"line":1555},[87,4350,4351],{"class":232},"        const",[87,4353,4355],{"class":4354},"sNmU0"," url",[87,4357,1777],{"class":247},[87,4359,4360],{"class":232}," new",[87,4362,4363],{"class":93}," URL",[87,4365,251],{"class":122},[87,4367,4132],{"class":4152},[87,4369,1815],{"class":122},[87,4371,2792],{"class":135},[87,4373,4272],{"class":122},[87,4375,4376,4378,4381,4383,4386,4388,4390,4392,4395,4397,4400,4402,4404],{"class":89,"line":1575},[87,4377,4351],{"class":232},[87,4379,4380],{"class":4354}," key",[87,4382,1777],{"class":247},[87,4384,4385],{"class":93}," decodeURI",[87,4387,251],{"class":122},[87,4389,2792],{"class":4152},[87,4391,1815],{"class":122},[87,4393,4394],{"class":4158},"pathname",[87,4396,1815],{"class":122},[87,4398,4399],{"class":93},"slice",[87,4401,251],{"class":122},[87,4403,964],{"class":142},[87,4405,4406],{"class":122},"));\n",[87,4408,4409],{"class":89,"line":1597},[87,4410,587],{"emptyLinePlaceholder":586},[87,4412,4413,4415,4417,4420,4423,4425,4427,4429,4431,4433,4435],{"class":89,"line":1618},[87,4414,307],{"class":232},[87,4416,4129],{"class":122},[87,4418,4419],{"class":247},"!",[87,4421,4422],{"class":93},"authorizeRequest",[87,4424,251],{"class":122},[87,4426,4132],{"class":135},[87,4428,257],{"class":122},[87,4430,4137],{"class":135},[87,4432,257],{"class":122},[87,4434,4215],{"class":135},[87,4436,4437],{"class":122},")) {\n",[87,4439,4440,4442,4444,4447,4449,4452,4455,4458,4461,4464,4467,4470],{"class":89,"line":1624},[87,4441,4258],{"class":232},[87,4443,4360],{"class":232},[87,4445,4446],{"class":93}," Response",[87,4448,251],{"class":122},[87,4450,4451],{"class":97},"'Forbidden",[87,4453,4454],{"class":247},"\\n",[87,4456,4457],{"class":97},"'",[87,4459,4460],{"class":122},", { ",[87,4462,4463],{"class":135},"status",[87,4465,961],{"class":4466},"st7oF",[87,4468,4469],{"class":142}," 403",[87,4471,4472],{"class":122}," });\n",[87,4474,4475],{"class":89,"line":1629},[87,4476,4477],{"class":122},"        }\n",[87,4479,4480],{"class":89,"line":1650},[87,4481,587],{"emptyLinePlaceholder":586},[87,4483,4484,4487,4489,4491,4493,4495],{"class":89,"line":1655},[87,4485,4486],{"class":232},"        switch",[87,4488,4129],{"class":122},[87,4490,4132],{"class":4152},[87,4492,1815],{"class":122},[87,4494,4232],{"class":135},[87,4496,4218],{"class":122},[87,4498,4499,4502,4504],{"class":89,"line":1677},[87,4500,4501],{"class":232},"            case",[87,4503,4242],{"class":97},[87,4505,329],{"class":122},[87,4507,4508,4511,4514,4516,4519,4521,4523,4526,4528,4530,4532,4534],{"class":89,"line":1702},[87,4509,4510],{"class":232},"                const",[87,4512,4513],{"class":4354}," objectExists",[87,4515,1777],{"class":247},[87,4517,4518],{"class":232}," await",[87,4520,4176],{"class":4152},[87,4522,1815],{"class":122},[87,4524,4525],{"class":4158},"MY_BUCKET",[87,4527,1815],{"class":122},[87,4529,313],{"class":93},[87,4531,251],{"class":122},[87,4533,4215],{"class":135},[87,4535,4272],{"class":122},[87,4537,4538],{"class":89,"line":1727},[87,4539,587],{"emptyLinePlaceholder":586},[87,4541,4542,4545,4547,4550,4553,4556],{"class":89,"line":1733},[87,4543,4544],{"class":232},"                if",[87,4546,4129],{"class":122},[87,4548,4549],{"class":135},"objectExists",[87,4551,4552],{"class":247}," !==",[87,4554,4555],{"class":142}," null",[87,4557,4218],{"class":122},[87,4559,4560,4563,4565,4567,4569,4571,4573,4575,4577,4580,4582,4585,4588],{"class":89,"line":1738},[87,4561,4562],{"class":232},"                    if",[87,4564,4129],{"class":122},[87,4566,4132],{"class":4152},[87,4568,1815],{"class":122},[87,4570,4159],{"class":4158},[87,4572,1815],{"class":122},[87,4574,313],{"class":93},[87,4576,251],{"class":122},[87,4578,4579],{"class":97},"'Overwrite'",[87,4581,263],{"class":122},[87,4583,4584],{"class":247},"!==",[87,4586,4587],{"class":97}," 'true'",[87,4589,4218],{"class":122},[87,4591,4592,4595,4597,4599,4601,4604,4606,4608,4610,4612,4614,4617],{"class":89,"line":1761},[87,4593,4594],{"class":232},"                        return",[87,4596,4360],{"class":232},[87,4598,4446],{"class":93},[87,4600,251],{"class":122},[87,4602,4603],{"class":97},"'Object Already Exists",[87,4605,4454],{"class":247},[87,4607,4457],{"class":97},[87,4609,4460],{"class":122},[87,4611,4463],{"class":135},[87,4613,961],{"class":4466},[87,4615,4616],{"class":142}," 409",[87,4618,4472],{"class":122},[87,4620,4621],{"class":89,"line":1788},[87,4622,4623],{"class":122},"                    }\n",[87,4625,4626],{"class":89,"line":1826},[87,4627,4628],{"class":122},"                }\n",[87,4630,4631],{"class":89,"line":1850},[87,4632,587],{"emptyLinePlaceholder":586},[87,4634,4635,4638,4640,4642,4644,4646,4649,4651,4653,4655,4657,4659,4662],{"class":89,"line":1856},[87,4636,4637],{"class":232},"                await",[87,4639,4176],{"class":4152},[87,4641,1815],{"class":122},[87,4643,4525],{"class":4158},[87,4645,1815],{"class":122},[87,4647,4648],{"class":93},"put",[87,4650,251],{"class":122},[87,4652,4215],{"class":135},[87,4654,257],{"class":122},[87,4656,4132],{"class":4152},[87,4658,1815],{"class":122},[87,4660,4661],{"class":135},"body",[87,4663,4272],{"class":122},[87,4665,4666,4669,4671,4673,4675,4678,4681,4683,4685,4688,4690,4693],{"class":89,"line":1861},[87,4667,4668],{"class":232},"                return",[87,4670,4360],{"class":232},[87,4672,4446],{"class":93},[87,4674,251],{"class":122},[87,4676,4677],{"class":97},"`Put ",[87,4679,956],{"class":4680},"sAOjX",[87,4682,4215],{"class":135},[87,4684,482],{"class":4680},[87,4686,4687],{"class":97}," successfully!",[87,4689,4454],{"class":247},[87,4691,4692],{"class":97},"`",[87,4694,4272],{"class":122},[87,4696,4697],{"class":89,"line":1883},[87,4698,587],{"emptyLinePlaceholder":586},[87,4700,4701,4703,4705],{"class":89,"line":1904},[87,4702,4501],{"class":232},[87,4704,4279],{"class":97},[87,4706,329],{"class":122},[87,4708,4709,4711,4714,4716,4718,4720,4722,4724,4726,4728,4730,4732],{"class":89,"line":1910},[87,4710,4510],{"class":232},[87,4712,4713],{"class":4354}," object",[87,4715,1777],{"class":247},[87,4717,4518],{"class":232},[87,4719,4176],{"class":4152},[87,4721,1815],{"class":122},[87,4723,4525],{"class":4158},[87,4725,1815],{"class":122},[87,4727,313],{"class":93},[87,4729,251],{"class":122},[87,4731,4215],{"class":135},[87,4733,4272],{"class":122},[87,4735,4736],{"class":89,"line":1955},[87,4737,587],{"emptyLinePlaceholder":586},[87,4739,4740,4742,4744,4747,4750,4752],{"class":89,"line":1960},[87,4741,4544],{"class":232},[87,4743,4129],{"class":122},[87,4745,4746],{"class":135},"object",[87,4748,4749],{"class":247}," ===",[87,4751,4555],{"class":142},[87,4753,4218],{"class":122},[87,4755,4756,4759,4761,4763,4765,4768,4770,4772,4774,4776,4778,4781],{"class":89,"line":1965},[87,4757,4758],{"class":232},"                    return",[87,4760,4360],{"class":232},[87,4762,4446],{"class":93},[87,4764,251],{"class":122},[87,4766,4767],{"class":97},"'Object Not Found",[87,4769,4454],{"class":247},[87,4771,4457],{"class":97},[87,4773,4460],{"class":122},[87,4775,4463],{"class":135},[87,4777,961],{"class":4466},[87,4779,4780],{"class":142}," 404",[87,4782,4472],{"class":122},[87,4784,4785],{"class":89,"line":1987},[87,4786,4628],{"class":122},[87,4788,4789],{"class":89,"line":2025},[87,4790,587],{"emptyLinePlaceholder":586},[87,4792,4793,4795,4798,4800,4802,4805],{"class":89,"line":2036},[87,4794,4510],{"class":232},[87,4796,4797],{"class":4354}," headers",[87,4799,1777],{"class":247},[87,4801,4360],{"class":232},[87,4803,4804],{"class":93}," Headers",[87,4806,4807],{"class":122},"();\n",[87,4809,4810,4813,4815,4818,4820,4822],{"class":89,"line":2051},[87,4811,4812],{"class":4152},"                object",[87,4814,1815],{"class":122},[87,4816,4817],{"class":93},"writeHttpMetadata",[87,4819,251],{"class":122},[87,4821,4159],{"class":135},[87,4823,4272],{"class":122},[87,4825,4826,4829,4831,4833,4835,4838,4840,4842,4844,4847],{"class":89,"line":2067},[87,4827,4828],{"class":4152},"                headers",[87,4830,1815],{"class":122},[87,4832,2994],{"class":93},[87,4834,251],{"class":122},[87,4836,4837],{"class":97},"'etag'",[87,4839,257],{"class":122},[87,4841,4746],{"class":4152},[87,4843,1815],{"class":122},[87,4845,4846],{"class":135},"httpEtag",[87,4848,4272],{"class":122},[87,4850,4851],{"class":89,"line":2077},[87,4852,587],{"emptyLinePlaceholder":586},[87,4854,4855,4857,4859,4861,4863,4865,4867,4869],{"class":89,"line":2083},[87,4856,4668],{"class":232},[87,4858,4360],{"class":232},[87,4860,4446],{"class":93},[87,4862,251],{"class":122},[87,4864,4746],{"class":4152},[87,4866,1815],{"class":122},[87,4868,4661],{"class":135},[87,4870,4871],{"class":122},", {\n",[87,4873,4874,4877],{"class":89,"line":2088},[87,4875,4876],{"class":135},"                    headers",[87,4878,146],{"class":122},[87,4880,4881],{"class":89,"line":2121},[87,4882,4883],{"class":122},"                });\n",[87,4885,4886,4888,4890],{"class":89,"line":2130},[87,4887,4501],{"class":232},[87,4889,4251],{"class":97},[87,4891,329],{"class":122},[87,4893,4894,4896,4898,4900,4902,4904,4907,4909,4911],{"class":89,"line":2143},[87,4895,4637],{"class":232},[87,4897,4176],{"class":4152},[87,4899,1815],{"class":122},[87,4901,4525],{"class":4158},[87,4903,1815],{"class":122},[87,4905,4906],{"class":93},"delete",[87,4908,251],{"class":122},[87,4910,4215],{"class":135},[87,4912,4272],{"class":122},[87,4914,4915,4917,4919,4921,4923,4926,4928,4930],{"class":89,"line":2156},[87,4916,4668],{"class":232},[87,4918,4360],{"class":232},[87,4920,4446],{"class":93},[87,4922,251],{"class":122},[87,4924,4925],{"class":97},"'Deleted!",[87,4927,4454],{"class":247},[87,4929,4457],{"class":97},[87,4931,4272],{"class":122},[87,4933,4934],{"class":89,"line":2161},[87,4935,587],{"emptyLinePlaceholder":586},[87,4937,4938,4941],{"class":89,"line":2166},[87,4939,4940],{"class":232},"            default",[87,4942,329],{"class":122},[87,4944,4945,4947,4949,4951,4953,4956,4958,4960],{"class":89,"line":2171},[87,4946,4668],{"class":232},[87,4948,4360],{"class":232},[87,4950,4446],{"class":93},[87,4952,251],{"class":122},[87,4954,4955],{"class":97},"'Method Not Allowed",[87,4957,4454],{"class":247},[87,4959,4457],{"class":97},[87,4961,4871],{"class":122},[87,4963,4964,4967,4969,4972],{"class":89,"line":2200},[87,4965,4966],{"class":135},"                    status",[87,4968,961],{"class":4466},[87,4970,4971],{"class":142}," 405",[87,4973,146],{"class":122},[87,4975,4976,4978,4980],{"class":89,"line":2205},[87,4977,4876],{"class":135},[87,4979,961],{"class":4466},[87,4981,4145],{"class":122},[87,4983,4984,4987,4989,4992],{"class":89,"line":2225},[87,4985,4986],{"class":135},"                        Allow",[87,4988,961],{"class":4466},[87,4990,4991],{"class":97}," 'PUT, GET, DELETE'",[87,4993,146],{"class":122},[87,4995,4996],{"class":89,"line":2248},[87,4997,4998],{"class":122},"                    },\n",[87,5000,5001],{"class":89,"line":2253},[87,5002,4883],{"class":122},[87,5004,5005],{"class":89,"line":2270},[87,5006,4477],{"class":122},[87,5008,5009],{"class":89,"line":2275},[87,5010,5011],{"class":122},"    },\n",[87,5013,5014],{"class":89,"line":2280},[87,5015,4190],{"class":122},[18,5017,5018],{},"代码的大部分都是基于 Cloudflare Docs 中给出的样例，修改了几个小的优化点",[203,5020,5021,5024,5030],{},[206,5022,5023],{},"删除了 ALLOW_LIST 部分代码，默认所有文件都是可以被访问的",[206,5025,5026,5027],{},"在上传一个文件时，如果目标路径存在同名文件，则不直接覆盖，而是返回 409 的异常 HTTP 相应，如果想要强制覆盖，则需要在 Http Header 中加入 ",[84,5028,5029],{},"Overwrite: true",[206,5031,5032],{},"解出请求路径时，使用 decodeURI( ) 方法先进行解码，解决文件路径中含有中文时会导致请求失败的问题。",[18,5034,5035],{},"填入代码后，还需要绑定两个变量，一个是 R2 Bucket",[18,5037,5038],{},[59,5039],{"alt":82,"src":4080},[18,5041,5042],{},"另一个是自己的管理密码",[18,5044,5045],{},[59,5046],{"alt":82,"src":5047},"https://static.031130.xyz/uploads/2024/08/14/96da1f62f5fe7.webp",[540,5049,5051],{"id":5050},"如何使用-cloudflare-workers-构建的-restful-api-进行文件操作","如何使用 Cloudflare Workers 构建的 Restful API 进行文件操作？",[3382,5053,5054],{"id":5054},"上传",[18,5056,5057],{},"以 python 为例，上传一个文件 1MB.bin 到 /example/ 目录下，上传的 url 就是文件最终的存在路径。",[77,5059,5061],{"className":223,"code":5060,"language":225,"meta":82,"style":82},"import requests\n\nAUTH_KEY_SECRET='1145141919810'\n\nwith open('1MB.bin', ''rb) as f:\n    file_content = f.read()\n\nrequests.put(\n    'https://r2.example.workers.dev/example/1MB.bin',\n    headers={\n        'X-Custom-Auth-Key': AUTH_KEY_SECRET,\n        'Overwrite': True   # 如果不需要强制覆盖可以删除这一行\n    }\n)\n",[84,5062,5063,5069,5073,5082,5086,5110,5123,5127,5137,5144,5154,5165,5178,5182],{"__ignoreMap":82},[87,5064,5065,5067],{"class":89,"line":90},[87,5066,2623],{"class":232},[87,5068,2640],{"class":122},[87,5070,5071],{"class":89,"line":126},[87,5072,587],{"emptyLinePlaceholder":586},[87,5074,5075,5077,5079],{"class":89,"line":132},[87,5076,4182],{"class":2734},[87,5078,278],{"class":277},[87,5080,5081],{"class":97},"'1145141919810'\n",[87,5083,5084],{"class":89,"line":149},[87,5085,587],{"emptyLinePlaceholder":586},[87,5087,5088,5091,5093,5095,5098,5100,5103,5106,5108],{"class":89,"line":3},[87,5089,5090],{"class":232},"with",[87,5092,248],{"class":247},[87,5094,251],{"class":122},[87,5096,5097],{"class":97},"'1MB.bin'",[87,5099,257],{"class":122},[87,5101,5102],{"class":97},"''",[87,5104,5105],{"class":122},"rb) ",[87,5107,266],{"class":232},[87,5109,269],{"class":122},[87,5111,5112,5115,5117,5119,5121],{"class":89,"line":174},[87,5113,5114],{"class":122},"    file_content ",[87,5116,278],{"class":277},[87,5118,2920],{"class":122},[87,5120,2923],{"class":284},[87,5122,384],{"class":122},[87,5124,5125],{"class":89,"line":185},[87,5126,587],{"emptyLinePlaceholder":586},[87,5128,5129,5132,5134],{"class":89,"line":191},[87,5130,5131],{"class":122},"requests.",[87,5133,4648],{"class":284},[87,5135,5136],{"class":122},"(\n",[87,5138,5139,5142],{"class":89,"line":198},[87,5140,5141],{"class":97},"    'https://r2.example.workers.dev/example/1MB.bin'",[87,5143,146],{"class":122},[87,5145,5146,5149,5151],{"class":89,"line":387},[87,5147,5148],{"class":3055},"    headers",[87,5150,278],{"class":277},[87,5152,5153],{"class":122},"{\n",[87,5155,5156,5159,5161,5163],{"class":89,"line":404},[87,5157,5158],{"class":97},"        'X-Custom-Auth-Key'",[87,5160,139],{"class":122},[87,5162,4182],{"class":2734},[87,5164,146],{"class":122},[87,5166,5167,5170,5172,5175],{"class":89,"line":420},[87,5168,5169],{"class":97},"        'Overwrite'",[87,5171,139],{"class":122},[87,5173,5174],{"class":142},"True",[87,5176,5177],{"class":1357},"   # 如果不需要强制覆盖可以删除这一行\n",[87,5179,5180],{"class":89,"line":437},[87,5181,4310],{"class":122},[87,5183,5184],{"class":89,"line":464},[87,5185,348],{"class":122},[3382,5187,5188],{"id":5188},"访问",[18,5190,5191,5192,5195],{},"通过浏览器直接访问 ",[84,5193,5194],{},"https://r2.example.workers.dev/example/1MB.bin"," 应该就能访问到",[3382,5197,5198],{"id":5198},"删除",[18,5200,5201],{},"仍然以 python 为例，删除刚才的文件",[77,5203,5205],{"className":223,"code":5204,"language":225,"meta":82,"style":82},"import requests\n\nAUTH_KEY_SECRET='1145141919810'\n\nwith open('1MB.bin', ''rb) as f:\n    file_content = f.read()\n\nrequests.delete(\n    'https://r2.example.workers.dev/example/1MB.bin',\n    headers={\n        'X-Custom-Auth-Key': AUTH_KEY_SECRET\n    }\n)\n",[84,5206,5207,5213,5217,5225,5229,5249,5261,5265,5273,5279,5287,5296,5300],{"__ignoreMap":82},[87,5208,5209,5211],{"class":89,"line":90},[87,5210,2623],{"class":232},[87,5212,2640],{"class":122},[87,5214,5215],{"class":89,"line":126},[87,5216,587],{"emptyLinePlaceholder":586},[87,5218,5219,5221,5223],{"class":89,"line":132},[87,5220,4182],{"class":2734},[87,5222,278],{"class":277},[87,5224,5081],{"class":97},[87,5226,5227],{"class":89,"line":149},[87,5228,587],{"emptyLinePlaceholder":586},[87,5230,5231,5233,5235,5237,5239,5241,5243,5245,5247],{"class":89,"line":3},[87,5232,5090],{"class":232},[87,5234,248],{"class":247},[87,5236,251],{"class":122},[87,5238,5097],{"class":97},[87,5240,257],{"class":122},[87,5242,5102],{"class":97},[87,5244,5105],{"class":122},[87,5246,266],{"class":232},[87,5248,269],{"class":122},[87,5250,5251,5253,5255,5257,5259],{"class":89,"line":174},[87,5252,5114],{"class":122},[87,5254,278],{"class":277},[87,5256,2920],{"class":122},[87,5258,2923],{"class":284},[87,5260,384],{"class":122},[87,5262,5263],{"class":89,"line":185},[87,5264,587],{"emptyLinePlaceholder":586},[87,5266,5267,5269,5271],{"class":89,"line":191},[87,5268,5131],{"class":122},[87,5270,4906],{"class":284},[87,5272,5136],{"class":122},[87,5274,5275,5277],{"class":89,"line":198},[87,5276,5141],{"class":97},[87,5278,146],{"class":122},[87,5280,5281,5283,5285],{"class":89,"line":387},[87,5282,5148],{"class":3055},[87,5284,278],{"class":277},[87,5286,5153],{"class":122},[87,5288,5289,5291,5293],{"class":89,"line":404},[87,5290,5158],{"class":97},[87,5292,139],{"class":122},[87,5294,5295],{"class":2734},"AUTH_KEY_SECRET\n",[87,5297,5298],{"class":89,"line":420},[87,5299,4310],{"class":122},[87,5301,5302],{"class":89,"line":437},[87,5303,348],{"class":122},[540,5305,801],{"id":801},[203,5307,5308,5315,5321,5328],{},[206,5309,5310],{},[43,5311,5314],{"href":5312,"rel":5313},"https://blog.yswtrue.com/yong-cloudflare-de-r2-he-worker-lai-zuo-wen-jian-tuo-guan/",[561],"用 cloudflare 的 R2 和 worker 来做文件托管",[206,5316,5317],{},[43,5318,5320],{"href":4071,"rel":5319},[561],"Workers API reference",[206,5322,5323],{},[43,5324,5327],{"href":5325,"rel":5326},"https://developers.cloudflare.com/r2/api/workers/workers-api-usage/",[561],"Use R2 from Workers",[206,5329,5330],{},[43,5331,5333],{"href":4041,"rel":5332},[561],"创建已签名的 AWS API 请求",[512,5335,5336],{},"html pre.shiki code .sLKXg, html code.shiki .sLKXg{--shiki-default:#A626A4;--shiki-dark:#C678DD}html pre.shiki code .sAdtL, html code.shiki .sAdtL{--shiki-default:#4078F2;--shiki-dark:#61AFEF}html pre.shiki code .s_Sar, html code.shiki .s_Sar{--shiki-default:#0184BC;--shiki-dark:#56B6C2}html pre.shiki code .s5ixo, html code.shiki .s5ixo{--shiki-default:#383A42;--shiki-dark:#ABB2BF}html pre.shiki code .s8iYz, html code.shiki .s8iYz{--shiki-default:#383A42;--shiki-default-font-style:inherit;--shiki-dark:#E06C75;--shiki-dark-font-style:italic}html pre.shiki code .s7GmK, html code.shiki .s7GmK{--shiki-default:#383A42;--shiki-dark:#E5C07B}html pre.shiki code .s2QsP, html code.shiki .s2QsP{--shiki-default:#E45649;--shiki-dark:#E5C07B}html pre.shiki code .sDhpE, html code.shiki .sDhpE{--shiki-default:#50A14F;--shiki-dark:#98C379}html pre.shiki code .sRZ4U, html code.shiki .sRZ4U{--shiki-default:#986801;--shiki-dark:#E06C75}html pre.shiki code .sJa8x, html code.shiki .sJa8x{--shiki-default:#E45649;--shiki-dark:#E06C75}html pre.shiki code .sz0mV, html code.shiki .sz0mV{--shiki-default:#383A42;--shiki-dark:#E06C75}html pre.shiki code .sAGMh, html code.shiki .sAGMh{--shiki-default:#986801;--shiki-dark:#D19A66}html pre.shiki code .sq3v1, html code.shiki .sq3v1{--shiki-default:#E45649;--shiki-dark:#C678DD}html pre.shiki code .sNmU0, html code.shiki .sNmU0{--shiki-default:#986801;--shiki-dark:#E5C07B}html pre.shiki code .st7oF, html code.shiki .st7oF{--shiki-default:#0184BC;--shiki-dark:#ABB2BF}html pre.shiki code .sAOjX, html code.shiki .sAOjX{--shiki-default:#CA1243;--shiki-dark:#C678DD}html .default .shiki span {color: var(--shiki-default);background: var(--shiki-default-bg);font-style: var(--shiki-default-font-style);font-weight: var(--shiki-default-font-weight);text-decoration: var(--shiki-default-text-decoration);}html .shiki span {color: var(--shiki-default);background: var(--shiki-default-bg);font-style: var(--shiki-default-font-style);font-weight: var(--shiki-default-font-weight);text-decoration: var(--shiki-default-text-decoration);}html .dark .shiki span {color: var(--shiki-dark);background: var(--shiki-dark-bg);font-style: var(--shiki-dark-font-style);font-weight: var(--shiki-dark-font-weight);text-decoration: var(--shiki-dark-text-decoration);}html.dark .shiki span {color: var(--shiki-dark);background: var(--shiki-dark-bg);font-style: var(--shiki-dark-font-style);font-weight: var(--shiki-dark-font-weight);text-decoration: var(--shiki-dark-text-decoration);}html pre.shiki code .sYebD, html code.shiki .sYebD{--shiki-default:#383A42;--shiki-dark:#D19A66}html pre.shiki code .sknuh, html code.shiki .sknuh{--shiki-default:#383A42;--shiki-dark:#56B6C2}html pre.shiki code .slOjB, html code.shiki .slOjB{--shiki-default:#383A42;--shiki-dark:#61AFEF}html pre.shiki code .sp7wS, html code.shiki .sp7wS{--shiki-default:#986801;--shiki-default-font-style:inherit;--shiki-dark:#E06C75;--shiki-dark-font-style:italic}html pre.shiki code .sW2Sy, html code.shiki .sW2Sy{--shiki-default:#A0A1A7;--shiki-default-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic}",{"title":82,"searchDepth":126,"depth":126,"links":5338},[5339,5343,5347,5348,5349,5354],{"id":3933,"depth":126,"text":3934,"children":5340},[5341,5342],{"id":3940,"depth":132,"text":3941},{"id":3950,"depth":132,"text":3951},{"id":3967,"depth":126,"text":3968,"children":5344},[5345,5346],{"id":3974,"depth":132,"text":3974},{"id":4007,"depth":132,"text":4008},{"id":4090,"depth":126,"text":4091},{"id":4105,"depth":126,"text":4106},{"id":5050,"depth":126,"text":5051,"children":5350},[5351,5352,5353],{"id":5054,"depth":132,"text":5054},{"id":5188,"depth":132,"text":5188},{"id":5198,"depth":132,"text":5198},{"id":801,"depth":126,"text":801},{"title":5356,"date":5357,"path":5358,"tags":5359,"body":5360},"自建图床小记一——图床架构与 DNS 解析","2024-08-12 17:07:11","/2024/08/12/new-picbed-based-on-cloudflare-and-upyun",[1259,1258,525,3927],{"type":15,"value":5361,"toc":5528},[5362,5368,5371,5374,5380,5383,5386,5395,5409,5413,5416,5419,5439,5445,5449,5453,5456,5468,5474,5477,5483,5488,5491,5495,5501,5504,5510,5517,5519],[5363,5364,5365],"blockquote",{},[18,5366,5367],{},"一直以来，我使用的都是使用付费的第三方图床，可惜最近几年为了节省成本，境内的稳定性出现了一些问题。过去一年中光是我本人遇到的无法访问的情况就有三四次，其中两次持续时间超过 2 小时，甚至有网友特意来 at 我告知我博客使用的图床出问题了，还有两次是在我作品验收前 24 小时内出现，幸亏我及时切换了资源链接。此外，境外 CDN 也从原先的 Cloudflare 换掉了，目前海外的解析结果似乎只有一个在美国的节点，其余地区（尤其是日本香港新加坡等常用的落地地区）的访问质量不佳，Google 的 page speed test 甚至提示我的图片拖慢了网站加载速度。",[18,5369,5370],{},"基于上述种种原因，我开始选择自建图床，前前后后折腾了快一周后，新图床终于投入使用，目前我的博客已经完成了所有图片资源的切换。",[540,5372,5373],{"id":5373},"架构设计",[18,5375,5376],{},[59,5377],{"alt":5378,"src":5379},"图床架构设计图","https://static.031130.xyz/uploads/2024/08/12/80402e4da4ef7.webp",[18,5381,5382],{},"这一套架构使用 Dnspod 免费版实现在境内外的解析分流，将境内的流量导向又拍云 CDN 为境内的访客提供服务，在境外使用量大管饱的 Cloudflare CDN 节省成本，为全球提供加速访问。",[540,5384,5385],{"id":5385},"为什么是又拍云",[18,5387,5388,5389,5394],{},"如你所见，我的博客底部挂了又拍云的 logo。",[43,5390,5393],{"href":5391,"rel":5392},"https://www.upyun.com/league",[561],"又拍云联盟","为个人开发者提供了每个月 10GB 存储和 15GB 的免费 CDN 流量，在每年通过申请后会以 67 元无门槛代金券的形式发放到账号，也不用担心某个月超了一点点而付出额外的费用。",[18,5396,5397,5398,5403,5404],{},"相比之下，七牛云虽然控制台的前端 UI 不错，但出了这种事情导致其在我心里印象分极差: 「",[43,5399,5402],{"href":5400,"rel":5401},"https://blog.hanlin.press/2024/07/From-Shanxi-to-Qiniu/",[561],"从山西联通到组播IP：七牛云的奇怪视角（附分析和后日谈）","」",[43,5405,5408],{"href":5406,"rel":5407},"https://archive.md/ONeu3",[561],"Archived Here",[540,5410,5412],{"id":5411},"为什么是-cloudflare-r2","为什么是 Cloudflare R2",[18,5414,5415],{},"作为自己的图床，必须要保证稳定性，境内访问的稳定性可以先放到一边，最重要的就是保证源文件的稳定性。不同于在自己的 VPS 上存储图片的方案，使用 Cloudflare R2 作为储存不需要关注 VPS 到期以后的图片迁移问题。使用 Cloudflare R2 作为储存，免费用量对于个人站点来说绰绰有余，在 10GB 存储容量超出之前不用考虑别的问题，也不用担心资金支持不下去导致的麻烦。而不使用又拍云提供的 10GB 存储也可以节省这部分的代金券金额，让代金券尽可能多的抵扣境内 CDN 流量带来的费用。",[540,5417,5418],{"id":5418},"需要的东西",[203,5420,5421,5424,5427,5433],{},[206,5422,5423],{},"两个或两个以上的域名（其中一个需要备案）",[206,5425,5426],{},"Cloudflare 所支持的境外支付方式（PayPal 账号 / Visa Card / Master Card），用于开通 Cloudflare R2 和 Cloudflare SaaS 接入",[206,5428,5429,5432],{},[22,5430,5431],{},"很多很多钱","（其实没有很多，又拍云联盟每年的 67 元抵用券在我这里看来完全是够用的）",[206,5434,5435,5436],{},"聪明的大脑，能够快速敲击键盘的双手，",[22,5437,5438],{},"能够支持你熬夜的心脏",[18,5440,5441],{},[5442,5443,5444],"em",{},"* 在这一套架构中引入了香港 VPS 进行反向代理，一来是防止国内 CDN 与 Cloudflare 的网络连接质量过差导致的回源失败，二来也是方便我在没有国际联网的情况下进行图片的上传，但如果没有条件其实是可以去掉的。",[540,5446,5448],{"id":5447},"dns-解析","DNS 解析",[18,5450,5451],{},[59,5452],{"alt":3986,"src":3987},[18,5454,5455],{},"如上图，将图床域名 NS 接入 DnsPod，工具人域名 NS 接入 Cloudflare 即可实现境内外分流的效果。",[5457,5458,5459,5462,5465],"ol",{},[206,5460,5461],{},"图床访问域名在境外 CNAME 解析到工具人域名",[206,5463,5464],{},"图床访问域名在境内 CNAME 解析到境内 CDN 服务商",[206,5466,5467],{},"工具人域名在 Cloudflare 上解析到任何站点都行，只需点亮解析时 Cloudflare CDN 代理按钮即可生效。",[18,5469,5470],{},[59,5471],{"alt":5472,"src":5473},"代理按钮","https://static.031130.xyz/uploads/2024/08/13/a0387d2919850.webp",[18,5475,5476],{},"但如果你的备案域名已经通过 NS 接入了 Cloudflare，可以采用下面这套架构。",[18,5478,5479],{},[59,5480],{"alt":5481,"src":5482},"DNS 解析方案 2","https://static.031130.xyz/uploads/2024/08/13/d03d7b3155514.webp",[18,5484,5485],{},[5442,5486,5487],{},"* 解析方案 2 中的图床访问域名和工具人域名可以是同属于同一二级域名的不同子域名",[18,5489,5490],{},"这种方案要多一步，把图床访问域名 CNAME 解析到用于分流的工具人域名。",[540,5492,5494],{"id":5493},"cloudflare-saas-接入","Cloudflare SaaS 接入",[18,5496,5497],{},[59,5498],{"alt":5499,"src":5500},"SaaS 接入","https://static.031130.xyz/uploads/2024/08/13/eb7186205b380.webp",[18,5502,5503],{},"SaaS 接入大概就是如图所示，此外还要配置 Cloudflare Workers 的域名访问",[18,5505,5506],{},[59,5507],{"alt":5508,"src":5509},"Cloudflare Workers 域名访问","https://static.031130.xyz/uploads/2024/08/13/782a665cabe05.webp",[18,5511,5512,5513,5516],{},"这样就能保证在境外访问图床域名时将请求打到 Cloudflare Workers 上了，关于使用 Cloudflare Workers 构建图床 Restful API 相关的内容我放在",[43,5514,5515],{"href":1329},"下一篇博客","讲。",[540,5518,801],{"id":801},[203,5520,5521],{},[206,5522,5523],{},[43,5524,5527],{"href":5525,"rel":5526},"https://www.eallion.com/cdn-cname-cloudflare/",[561],"图床 CDN CNAME 接入 Cloudflare SaaS 实现分流",{"title":82,"searchDepth":126,"depth":126,"links":5529},[5530,5531,5532,5533,5534,5535,5536],{"id":5373,"depth":126,"text":5373},{"id":5385,"depth":126,"text":5385},{"id":5411,"depth":126,"text":5412},{"id":5418,"depth":126,"text":5418},{"id":5447,"depth":126,"text":5448},{"id":5493,"depth":126,"text":5494},{"id":801,"depth":126,"text":801},{"title":5538,"date":5539,"path":5540,"tags":5541,"body":5543},"在 Linux 下使用 mitmproxy 抓取安卓手机上的 HTTPS 流量","2024-07-31 16:02:28","/2024/07/31/capture-android-https-traffic-on-linux-with-mitmproxy",[524,525,526,833,5542],"Android",{"type":15,"value":5544,"toc":5849},[5545,5548,5551,5586,5597,5600,5603,5608,5612,5661,5667,5670,5701,5705,5708,5773,5781,5784,5789,5792,5795,5800,5803,5808,5810,5846],[18,5546,5547],{},"纵使安卓下有小黄鸟 HttpCanary 这种抓包神器，但手机一块 6 英寸的小屏实在是不方便分析流量情况，还得是 PC 的屏幕更大一些，处理起流量信息来更得心应手一些。",[18,5549,5550],{},"把话说在前面，目前的安卓抓包有不小的限制",[203,5552,5553,5556],{},[206,5554,5555],{},"Android 7 以下的版本: 直接以普通用户的权限安装 ssl 证书即可被信任",[206,5557,5558,5559],{},"Android 7 以上的版本:\n",[203,5560,5561,5572],{},[206,5562,5563,5564,5567,5568,5571],{},"安全性较低的应用: ",[29,5565,5566],{},"需要使用 root 权限","将证书移动至 ",[84,5569,5570],{},"/system/etc/security/cacerts","使证书被系统信任",[206,5573,5574,5575,5580,5581,4074],{},"安全性较高的应用（比如微信 7.0 以上的版本）: 在满足上一条条件的情况下，需要阻止第三方应用使用自带的 ssl 证书信任范围（绕过 SSL Pinning）。通常情况下需要额外的手段对目标应用进行篡改，比如使用 ",[43,5576,5579],{"href":5577,"rel":5578},"https://github.com/Fuzion24/JustTrustMe",[561],"justTrustMe"," 这个 xposed 模块，或者 ",[43,5582,5585],{"href":5583,"rel":5584},"https://github.com/frida/frida/",[561],"frida",[5363,5587,5588],{},[18,5589,5590,5591,5596],{},"除此之外，Linux 版本 >= 5.5 的安卓设备也可以使用 ",[43,5592,5595],{"href":5593,"rel":5594},"https://github.com/gojue/ecapture",[561],"eCapture"," 这款基于 eBPF Linux 内核模块实现的抓包软件，算是种奇技淫巧。",[18,5598,5599],{},"本文只讨论 Android 7 以上版本中安全性较低的应用，因为我当前的抓包目标局限于一款安全性不高的外包软件。",[540,5601,5602],{"id":5602},"基本操作",[18,5604,5605,5606,5403],{},"见「",[43,5607,549],{"href":548},[540,5609,5611],{"id":5610},"安装-ssl-证书","安装 ssl 证书",[77,5613,5615],{"className":566,"code":5614,"language":568,"meta":82,"style":82},"cp $HOME/.mitmproxy/mitmproxy-ca-cert.pem $(openssl x509 -subject_hash_old -in $HOME/.mitmproxy/mitmproxy-ca-cert.pem | head -n 1).0\n",[84,5616,5617],{"__ignoreMap":82},[87,5618,5619,5622,5624,5627,5630,5633,5636,5639,5642,5644,5646,5648,5651,5654,5656,5658],{"class":89,"line":90},[87,5620,5621],{"class":93},"cp",[87,5623,3547],{"class":135},[87,5625,5626],{"class":97},"/.mitmproxy/mitmproxy-ca-cert.pem",[87,5628,5629],{"class":122}," $(",[87,5631,5632],{"class":93},"openssl",[87,5634,5635],{"class":97}," x509",[87,5637,5638],{"class":142}," -subject_hash_old",[87,5640,5641],{"class":142}," -in",[87,5643,3547],{"class":135},[87,5645,5626],{"class":97},[87,5647,930],{"class":122},[87,5649,5650],{"class":93},"head",[87,5652,5653],{"class":142}," -n",[87,5655,1644],{"class":142},[87,5657,1183],{"class":122},[87,5659,5660],{"class":97},".0\n",[18,5662,5663,5664,5666],{},"此时我们就可以在家目录下找到一个以 .0 结尾的证书文件，我们的目标是将其放到手机的 ",[84,5665,5570],{}," 路径下。",[18,5668,5669],{},"对于一些出厂安卓版本较低、system 分区采用可变文件系统的手机，我们可以很轻松的使用带有 root 权限的文件管理器将证书文件移动到对应的目录（我这里就是）；而对于出厂版本较高的手机，system 分区可能是不可写的，需要采用额外的奇技淫巧。",[5363,5671,5672,5675,5678,5681,5684,5687],{},[18,5673,5674],{},"1、通过 ADB 将 HTTP Toolkit CA 证书推送到设备上。",[18,5676,5677],{},"2、从 /system/etc/security/cacerts/ 中复制所有系统证书到临时目录。",[18,5679,5680],{},"3、在 /system/etc/security/cacerts/ 上面挂载一个 tmpfs 内存文件系统。这实际上将一个可写的全新空文件系统放在了 /system 的一小部分上面。 将复制的系统证书移回到该挂载点。",[18,5682,5683],{},"4、将 HTTP Toolkit CA 证书也移动到该挂载点。",[18,5685,5686],{},"5、更新临时挂载点中所有文件的权限为 644，并将系统文件的 SELinux 标签设置为 system_file，以使其看起来像是合法的 Android 系统文件。",[18,5688,5689,5690,5695,5696,5403],{},"——",[43,5691,5694],{"href":5692,"rel":5693},"http://91fans.com.cn/post/certificate/",[561],"《安卓高版本安装系统证书 HTTPS 抓包 - 终极解决方案》"," 「",[43,5697,5700],{"href":5698,"rel":5699},"http://web.archive.org/web/20240801045307/http://91fans.com.cn/post/certificate/#gsc.tab=0",[561],"archived here",[540,5702,5704],{"id":5703},"让被抓包的应用流量经过-mitm-代理服务器","让被抓包的应用流量经过 mitm 代理服务器",[18,5706,5707],{},"mitmproxy 默认会在 pc 端的 8080 端口开启一个 http 代理服务器，我们要做的就是想办法让待抓包的应用流量被这个 http 代理服务器所代理。",[77,5709,5711],{"className":566,"code":5710,"language":568,"meta":82,"style":82},"[zhullyb@Archlinux ~]$ ip -br a\nlo               UNKNOWN        127.0.0.1/8 ::1/128\nenp0s31f6        UP             172.16.0.255/25 fe80::2df9:2927:cd44:65c/64\nwlp0s20f3        UP             192.168.20.212/24 fe80::a6bc:919:281e:dcab/64\ndocker0          DOWN           172.17.0.1/16 fe80::42:d1ff:febe:d513/64\n",[84,5712,5713,5718,5732,5746,5759],{"__ignoreMap":82},[87,5714,5715],{"class":89,"line":90},[87,5716,5717],{"class":122},"[zhullyb@Archlinux ~]$ ip -br a\n",[87,5719,5720,5723,5726,5729],{"class":89,"line":126},[87,5721,5722],{"class":93},"lo",[87,5724,5725],{"class":97},"               UNKNOWN",[87,5727,5728],{"class":97},"        127.0.0.1/8",[87,5730,5731],{"class":97}," ::1/128\n",[87,5733,5734,5737,5740,5743],{"class":89,"line":132},[87,5735,5736],{"class":93},"enp0s31f6",[87,5738,5739],{"class":97},"        UP",[87,5741,5742],{"class":97},"             172.16.0.255/25",[87,5744,5745],{"class":97}," fe80::2df9:2927:cd44:65c/64\n",[87,5747,5748,5751,5753,5756],{"class":89,"line":149},[87,5749,5750],{"class":93},"wlp0s20f3",[87,5752,5739],{"class":97},[87,5754,5755],{"class":97},"             192.168.20.212/24",[87,5757,5758],{"class":97}," fe80::a6bc:919:281e:dcab/64\n",[87,5760,5761,5764,5767,5770],{"class":89,"line":3},[87,5762,5763],{"class":93},"docker0",[87,5765,5766],{"class":97},"          DOWN",[87,5768,5769],{"class":97},"           172.17.0.1/16",[87,5771,5772],{"class":97}," fe80::42:d1ff:febe:d513/64\n",[18,5774,5775,5776,5780],{},"在这里我们能看到本机的无线网卡地址是 192.168.20.212，所以 http 代理服务器的地址就是 ",[43,5777,5778],{"href":5778,"rel":5779},"http://192.168.20.212:8080",[561]," 。（如果你的有线网卡和手机在同一局域网下，当然也可以用有线网卡的 ip 地址）",[18,5782,5783],{},"我们当然可以在安卓手机的 WIFI 连接页面填入 http 代理地址。",[18,5785,5786],{},[59,5787],{"alt":82,"src":5788},"https://static.031130.xyz/uploads/2024/08/12/66ab548080ed6.webp",[18,5790,5791],{},"但这对我来说似乎并不是一个好主意：一来并不是所有的应用都会默认使用 http 代理服务器，二来这回导致抓包目标不明确，非目标应用的流量也会经过代理服务器。",[18,5793,5794],{},"我选择了 Nekobox 这个常见的代理软件，它支持 http 代理服务器，且允许分应用代理。",[18,5796,5797],{},[59,5798],{"alt":82,"src":5799},"https://static.031130.xyz/uploads/2024/08/12/66ab54f08dfd6.webp",[18,5801,5802],{},"可以看到能正常抓取 https 流量",[18,5804,5805],{},[59,5806],{"alt":82,"src":5807},"https://static.031130.xyz/uploads/2024/08/12/66ab5970a6ac7.webp",[540,5809,801],{"id":801},[203,5811,5812,5819,5826,5833,5839],{},[206,5813,5814],{},[43,5815,5818],{"href":5816,"rel":5817},"https://ibukifalling.github.io/2023/06/07/Android-app-packet-capture/",[561],"安卓应用防抓包机制及一些绕过",[206,5820,5821],{},[43,5822,5825],{"href":5823,"rel":5824},"https://chorer.github.io/2022/05/19/A-%E5%AE%89%E5%8D%937.0%E7%B3%BB%E7%BB%9F%E6%8A%93%E5%8C%85%E6%96%B9%E6%A1%88/",[561],"安卓7.0+系统抓包方案",[206,5827,5828],{},[43,5829,5832],{"href":5830,"rel":5831},"https://www.cnblogs.com/snad/p/17449454.html",[561],"frida抓包",[206,5834,5835],{},[43,5836,5838],{"href":5593,"rel":5837},[561],"gojue/ecapture",[206,5840,5841],{},[43,5842,5845],{"href":5843,"rel":5844},"http://91fans.com.cn/post/certificate/#gsc.tab=0",[561],"安卓高版本安装系统证书 HTTPS 抓包 - 终极解决方案",[512,5847,5848],{},"html pre.shiki code .sAdtL, html code.shiki .sAdtL{--shiki-default:#4078F2;--shiki-dark:#61AFEF}html pre.shiki code .sJa8x, html code.shiki .sJa8x{--shiki-default:#E45649;--shiki-dark:#E06C75}html pre.shiki code .sDhpE, html code.shiki .sDhpE{--shiki-default:#50A14F;--shiki-dark:#98C379}html pre.shiki code .s5ixo, html code.shiki .s5ixo{--shiki-default:#383A42;--shiki-dark:#ABB2BF}html pre.shiki code .sAGMh, html code.shiki .sAGMh{--shiki-default:#986801;--shiki-dark:#D19A66}html .default .shiki span {color: var(--shiki-default);background: var(--shiki-default-bg);font-style: var(--shiki-default-font-style);font-weight: var(--shiki-default-font-weight);text-decoration: var(--shiki-default-text-decoration);}html .shiki span {color: var(--shiki-default);background: var(--shiki-default-bg);font-style: var(--shiki-default-font-style);font-weight: var(--shiki-default-font-weight);text-decoration: var(--shiki-default-text-decoration);}html .dark .shiki span {color: var(--shiki-dark);background: var(--shiki-dark-bg);font-style: var(--shiki-dark-font-style);font-weight: var(--shiki-dark-font-weight);text-decoration: var(--shiki-dark-text-decoration);}html.dark .shiki span {color: var(--shiki-dark);background: var(--shiki-dark-bg);font-style: var(--shiki-dark-font-style);font-weight: var(--shiki-dark-font-weight);text-decoration: var(--shiki-dark-text-decoration);}",{"title":82,"searchDepth":126,"depth":126,"links":5850},[5851,5852,5853,5854],{"id":5602,"depth":126,"text":5602},{"id":5610,"depth":126,"text":5611},{"id":5703,"depth":126,"text":5704},{"id":801,"depth":126,"text":801},{"title":5856,"date":5857,"path":5858,"tags":5859,"body":5862},"为中柏 N100 小主机开启来电自启","2024-07-22 23:31:51","/2024/07/22/enable-ac-power-loss-for-jumper-n100",[12,5860,5861],"HomeServer","Notes",{"type":15,"value":5863,"toc":5897},[5864,5867,5870,5873,5878,5881,5892],[18,5865,5866],{},"因为收到通知，寝室过两天要断电 20 分钟，所以需要打开 N100 家里云的来电自启功能。",[18,5868,5869],{},"正常关机短暂等待数秒后，开机，狂按 Delete 键进入 BIOS。",[18,5871,5872],{},"在 Advanced 选项中选择「OEM Configuration」",[18,5874,5875],{},[59,5876],{"alt":82,"src":5877},"https://static.031130.xyz/uploads/2024/08/12/669e7e6ae10a4.webp",[18,5879,5880],{},"可以在最后一行「AC Power Loss」中选择模式。",[203,5882,5883,5886,5889],{},[206,5884,5885],{},"Power Off: 关闭相关功能。",[206,5887,5888],{},"Power On: 传统意义上的来电自启，只要接通电源就会自启动。",[206,5890,5891],{},"Last State: 只有在上次关机是意外断电导致时，接通电源才会自启动。",[18,5893,5894],{},[59,5895],{"alt":82,"src":5896},"https://static.031130.xyz/uploads/2024/08/12/669e7e5ab7ad6.webp",{"title":82,"searchDepth":126,"depth":126,"links":5898},[],"/en/archives/",134,1771555476718]