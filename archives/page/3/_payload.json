[{"data":1,"prerenderedAt":9106},["ShallowReactive",2],{"randomIndex/archives/page/3/":3,"index-page-3-zh":4,"language-switch-/archives/page/3/-en":9104,"posts-nums-total-zh":9105},6,[5,938,1613,2917,3437,5519,6028,6860,7311,8647],{"title":6,"date":7,"path":8,"tags":9,"body":13},"使用 Cloudflare Workers 监控 Fedora Copr 构建状态","2025-02-23 12:12:53","/2025/02/23/monitor-copr-build-state-with-cloudflare-workers",[10,11,12],"JavaScript","Cloudflare","Fedora",{"type":14,"value":15,"toc":936},"minimark",[16,26,35,50,64,71,74,77,341,344,540,543,913,916,921,932],[17,18,19],"blockquote",{},[20,21,22],"p",{},[23,24,25],"del",{},"确信，是 cloudflare workers 用上瘾了",[20,27,28,29,34],{},"在",[30,31,33],"a",{"href":32},"/2024/04/29/update-a-rpm-spec-by-github-action/","「使用 Github Action 更新用于 rpm 打包的 spec 文件」","一文中，我利用 Github Action 实现了自动化的 spec 版本号更新，配合 Fedora Copr 的 webhook 就可以实现 Copr 软件包更新的自动化构建。看似很完美，但缺少了一个构建状态的监控机制，这导致出现构建错误的时候我不能及时得到通知（无论构建错误是 spec 本身的问题或者是构建时的网络环境问题）。",[20,36,37,43,44,49],{},[30,38,42],{"href":39,"rel":40},"https://yanqiyu.info",[41],"nofollow","西木野羰基"," 提出 ",[30,45,48],{"href":46,"rel":47},"https://notifications.fedoraproject.org/",[41],"notifications.fedoraproject.org"," 可以配置通知，Filters 的 Applications 选项中有 copr，但很可惜，实测没有效果。这里的通知配置的似乎只是邮件的过滤规则——如果 copr 本来就没打算构建失败的时候给你发邮件，那即使建立了过滤规则，依然是不可能收到邮件的。",[20,51,52,53,58,59,63],{},"不过好在 Fedora Copr 本身有非常完备的 ",[30,54,57],{"href":55,"rel":56},"https://copr.fedorainfracloud.org/api_3/docs",[41],"api 文档","，",[60,61,62],"code",{},"/monitor"," 这个 API 能用来获取软件包最新的构建情况。",[20,65,66],{},[67,68],"img",{"alt":69,"src":70},"","https://static.031130.xyz/uploads/2025/02/23/637811d2d85f6.webp",[20,72,73],{},"因此，我们就可以通过 Cloudflare 的 cronjob 定时请求这个接口，查询是否有软件包构建失败。",[20,75,76],{},"先来编写打请求的部分",[78,79,83],"pre",{"className":80,"code":81,"language":82,"meta":69,"style":69},"language-javascript shiki shiki-themes one-light one-dark-pro","async function fetchCopr() {\n    const ownername = \"zhullyb\";\n    const projectname = \"v2rayA\";\n\n    const url = new URL(\"https://copr.fedorainfracloud.org/api_3/monitor\")\n    url.searchParams.set(\"ownername\", ownername)\n    url.searchParams.set(\"projectname\", projectname)\n    const response = await fetch(url)\n    const data = await response.json()\n    if (data.output !== \"ok\") {\n        throw new Error(\"Failed to fetch COPR data\")\n    }\n    return data\n}\n","javascript",[60,84,85,105,126,141,148,173,205,230,253,275,302,320,326,335],{"__ignoreMap":69},[86,87,90,94,97,101],"span",{"class":88,"line":89},"line",1,[86,91,93],{"class":92},"sLKXg","async",[86,95,96],{"class":92}," function",[86,98,100],{"class":99},"sAdtL"," fetchCopr",[86,102,104],{"class":103},"s5ixo","() {\n",[86,106,108,111,115,119,123],{"class":88,"line":107},2,[86,109,110],{"class":92},"    const",[86,112,114],{"class":113},"sNmU0"," ownername",[86,116,118],{"class":117},"s_Sar"," =",[86,120,122],{"class":121},"sDhpE"," \"zhullyb\"",[86,124,125],{"class":103},";\n",[86,127,129,131,134,136,139],{"class":88,"line":128},3,[86,130,110],{"class":92},[86,132,133],{"class":113}," projectname",[86,135,118],{"class":117},[86,137,138],{"class":121}," \"v2rayA\"",[86,140,125],{"class":103},[86,142,144],{"class":88,"line":143},4,[86,145,147],{"emptyLinePlaceholder":146},true,"\n",[86,149,151,153,156,158,161,164,167,170],{"class":88,"line":150},5,[86,152,110],{"class":92},[86,154,155],{"class":113}," url",[86,157,118],{"class":117},[86,159,160],{"class":92}," new",[86,162,163],{"class":99}," URL",[86,165,166],{"class":103},"(",[86,168,169],{"class":121},"\"https://copr.fedorainfracloud.org/api_3/monitor\"",[86,171,172],{"class":103},")\n",[86,174,175,179,182,186,188,191,193,196,199,203],{"class":88,"line":3},[86,176,178],{"class":177},"s7GmK","    url",[86,180,181],{"class":103},".",[86,183,185],{"class":184},"s2QsP","searchParams",[86,187,181],{"class":103},[86,189,190],{"class":99},"set",[86,192,166],{"class":103},[86,194,195],{"class":121},"\"ownername\"",[86,197,198],{"class":103},", ",[86,200,202],{"class":201},"sz0mV","ownername",[86,204,172],{"class":103},[86,206,208,210,212,214,216,218,220,223,225,228],{"class":88,"line":207},7,[86,209,178],{"class":177},[86,211,181],{"class":103},[86,213,185],{"class":184},[86,215,181],{"class":103},[86,217,190],{"class":99},[86,219,166],{"class":103},[86,221,222],{"class":121},"\"projectname\"",[86,224,198],{"class":103},[86,226,227],{"class":201},"projectname",[86,229,172],{"class":103},[86,231,233,235,238,240,243,246,248,251],{"class":88,"line":232},8,[86,234,110],{"class":92},[86,236,237],{"class":113}," response",[86,239,118],{"class":117},[86,241,242],{"class":92}," await",[86,244,245],{"class":99}," fetch",[86,247,166],{"class":103},[86,249,250],{"class":201},"url",[86,252,172],{"class":103},[86,254,256,258,261,263,265,267,269,272],{"class":88,"line":255},9,[86,257,110],{"class":92},[86,259,260],{"class":113}," data",[86,262,118],{"class":117},[86,264,242],{"class":92},[86,266,237],{"class":177},[86,268,181],{"class":103},[86,270,271],{"class":99},"json",[86,273,274],{"class":103},"()\n",[86,276,278,281,284,287,289,293,296,299],{"class":88,"line":277},10,[86,279,280],{"class":92},"    if",[86,282,283],{"class":103}," (",[86,285,286],{"class":177},"data",[86,288,181],{"class":103},[86,290,292],{"class":291},"sJa8x","output",[86,294,295],{"class":117}," !==",[86,297,298],{"class":121}," \"ok\"",[86,300,301],{"class":103},") {\n",[86,303,305,308,310,313,315,318],{"class":88,"line":304},11,[86,306,307],{"class":92},"        throw",[86,309,160],{"class":92},[86,311,312],{"class":99}," Error",[86,314,166],{"class":103},[86,316,317],{"class":121},"\"Failed to fetch COPR data\"",[86,319,172],{"class":103},[86,321,323],{"class":88,"line":322},12,[86,324,325],{"class":103},"    }\n",[86,327,329,332],{"class":88,"line":328},13,[86,330,331],{"class":92},"    return",[86,333,334],{"class":201}," data\n",[86,336,338],{"class":88,"line":337},14,[86,339,340],{"class":103},"}\n",[20,342,343],{},"随后编写通知部分，我这里采用的是飞书的 webhook 机器人",[78,345,347],{"className":80,"code":346,"language":82,"meta":69,"style":69},"async function notify(text) {\n    const webhook = \"https://open.feishu.cn/open-apis/bot/v2/hook/ffffffff-ffff-ffff-ffff-ffffffffffff\"\n    const body = {\n        msg_type: \"text\",\n        content: {\n            text: text\n        }\n    }\n    const response = await fetch(webhook, {\n        method: \"POST\",\n        headers: {\n            \"Content-Type\": \"application/json\"\n        },\n        body: JSON.stringify(body)\n    })\n    console.log(response)\n}\n",[60,348,349,366,378,390,405,414,424,429,433,453,465,474,484,489,511,517,535],{"__ignoreMap":69},[86,350,351,353,355,358,360,364],{"class":88,"line":89},[86,352,93],{"class":92},[86,354,96],{"class":92},[86,356,357],{"class":99}," notify",[86,359,166],{"class":103},[86,361,363],{"class":362},"s8iYz","text",[86,365,301],{"class":103},[86,367,368,370,373,375],{"class":88,"line":107},[86,369,110],{"class":92},[86,371,372],{"class":113}," webhook",[86,374,118],{"class":117},[86,376,377],{"class":121}," \"https://open.feishu.cn/open-apis/bot/v2/hook/ffffffff-ffff-ffff-ffff-ffffffffffff\"\n",[86,379,380,382,385,387],{"class":88,"line":128},[86,381,110],{"class":92},[86,383,384],{"class":113}," body",[86,386,118],{"class":117},[86,388,389],{"class":103}," {\n",[86,391,392,395,399,402],{"class":88,"line":143},[86,393,394],{"class":291},"        msg_type",[86,396,398],{"class":397},"st7oF",":",[86,400,401],{"class":121}," \"text\"",[86,403,404],{"class":103},",\n",[86,406,407,410,412],{"class":88,"line":150},[86,408,409],{"class":291},"        content",[86,411,398],{"class":397},[86,413,389],{"class":103},[86,415,416,419,421],{"class":88,"line":3},[86,417,418],{"class":291},"            text",[86,420,398],{"class":397},[86,422,423],{"class":201}," text\n",[86,425,426],{"class":88,"line":207},[86,427,428],{"class":103},"        }\n",[86,430,431],{"class":88,"line":232},[86,432,325],{"class":103},[86,434,435,437,439,441,443,445,447,450],{"class":88,"line":255},[86,436,110],{"class":92},[86,438,237],{"class":113},[86,440,118],{"class":117},[86,442,242],{"class":92},[86,444,245],{"class":99},[86,446,166],{"class":103},[86,448,449],{"class":201},"webhook",[86,451,452],{"class":103},", {\n",[86,454,455,458,460,463],{"class":88,"line":277},[86,456,457],{"class":291},"        method",[86,459,398],{"class":397},[86,461,462],{"class":121}," \"POST\"",[86,464,404],{"class":103},[86,466,467,470,472],{"class":88,"line":304},[86,468,469],{"class":291},"        headers",[86,471,398],{"class":397},[86,473,389],{"class":103},[86,475,476,479,481],{"class":88,"line":322},[86,477,478],{"class":121},"            \"Content-Type\"",[86,480,398],{"class":397},[86,482,483],{"class":121}," \"application/json\"\n",[86,485,486],{"class":88,"line":328},[86,487,488],{"class":103},"        },\n",[86,490,491,494,496,499,501,504,506,509],{"class":88,"line":337},[86,492,493],{"class":291},"        body",[86,495,398],{"class":397},[86,497,498],{"class":113}," JSON",[86,500,181],{"class":103},[86,502,503],{"class":99},"stringify",[86,505,166],{"class":103},[86,507,508],{"class":201},"body",[86,510,172],{"class":103},[86,512,514],{"class":88,"line":513},15,[86,515,516],{"class":103},"    })\n",[86,518,520,523,525,528,530,533],{"class":88,"line":519},16,[86,521,522],{"class":177},"    console",[86,524,181],{"class":103},[86,526,527],{"class":99},"log",[86,529,166],{"class":103},[86,531,532],{"class":201},"response",[86,534,172],{"class":103},[86,536,538],{"class":88,"line":537},17,[86,539,340],{"class":103},[20,541,542],{},"最后就是 cronjob 的调用部分和构建状态解析部分",[78,544,546],{"className":80,"code":545,"language":82,"meta":69,"style":69},"export default {\n    async fetch(request, env, ctx) {\n      return new Response('Hello World!');\n    },\n\n    async scheduled(event, env, ctx) {\n        const data = await fetchCopr()\n        const errorPackages = new Array()\n\n        for (const pkg of data.packages) {\n            for (const chroot of Object.values(pkg.chroots)) {\n                if (chroot.state == \"failed\") {\n                    errorPackages.push(pkg.name)\n                    break\n                }\n            }\n        }\n\n        if (errorPackages.length > 0) {\n            await notify(`COPR 以下包发生构建失败:\\n${errorPackages.join(\"\\n\")}`)\n        } else {\n            console.log(\"COPR 所有包构建成功\")\n        }\n    }\n};\n",[60,547,548,559,583,601,606,610,632,647,663,667,692,727,750,771,776,781,786,790,795,820,869,880,897,902,907],{"__ignoreMap":69},[86,549,550,553,557],{"class":88,"line":89},[86,551,552],{"class":92},"export",[86,554,556],{"class":555},"sq3v1"," default",[86,558,389],{"class":103},[86,560,561,564,566,568,571,573,576,578,581],{"class":88,"line":107},[86,562,563],{"class":92},"    async",[86,565,245],{"class":99},[86,567,166],{"class":103},[86,569,570],{"class":362},"request",[86,572,198],{"class":103},[86,574,575],{"class":362},"env",[86,577,198],{"class":103},[86,579,580],{"class":362},"ctx",[86,582,301],{"class":103},[86,584,585,588,590,593,595,598],{"class":88,"line":128},[86,586,587],{"class":92},"      return",[86,589,160],{"class":92},[86,591,592],{"class":99}," Response",[86,594,166],{"class":103},[86,596,597],{"class":121},"'Hello World!'",[86,599,600],{"class":103},");\n",[86,602,603],{"class":88,"line":143},[86,604,605],{"class":103},"    },\n",[86,607,608],{"class":88,"line":150},[86,609,147],{"emptyLinePlaceholder":146},[86,611,612,614,617,619,622,624,626,628,630],{"class":88,"line":3},[86,613,563],{"class":92},[86,615,616],{"class":99}," scheduled",[86,618,166],{"class":103},[86,620,621],{"class":362},"event",[86,623,198],{"class":103},[86,625,575],{"class":362},[86,627,198],{"class":103},[86,629,580],{"class":362},[86,631,301],{"class":103},[86,633,634,637,639,641,643,645],{"class":88,"line":207},[86,635,636],{"class":92},"        const",[86,638,260],{"class":113},[86,640,118],{"class":117},[86,642,242],{"class":92},[86,644,100],{"class":99},[86,646,274],{"class":103},[86,648,649,651,654,656,658,661],{"class":88,"line":232},[86,650,636],{"class":92},[86,652,653],{"class":113}," errorPackages",[86,655,118],{"class":117},[86,657,160],{"class":92},[86,659,660],{"class":99}," Array",[86,662,274],{"class":103},[86,664,665],{"class":88,"line":255},[86,666,147],{"emptyLinePlaceholder":146},[86,668,669,672,674,677,680,683,685,687,690],{"class":88,"line":277},[86,670,671],{"class":92},"        for",[86,673,283],{"class":103},[86,675,676],{"class":92},"const",[86,678,679],{"class":113}," pkg",[86,681,682],{"class":92}," of",[86,684,260],{"class":177},[86,686,181],{"class":103},[86,688,689],{"class":291},"packages",[86,691,301],{"class":103},[86,693,694,697,699,701,704,706,709,711,714,716,719,721,724],{"class":88,"line":304},[86,695,696],{"class":92},"            for",[86,698,283],{"class":103},[86,700,676],{"class":92},[86,702,703],{"class":113}," chroot",[86,705,682],{"class":92},[86,707,708],{"class":177}," Object",[86,710,181],{"class":103},[86,712,713],{"class":99},"values",[86,715,166],{"class":103},[86,717,718],{"class":177},"pkg",[86,720,181],{"class":103},[86,722,723],{"class":291},"chroots",[86,725,726],{"class":103},")) {\n",[86,728,729,732,734,737,739,742,745,748],{"class":88,"line":322},[86,730,731],{"class":92},"                if",[86,733,283],{"class":103},[86,735,736],{"class":177},"chroot",[86,738,181],{"class":103},[86,740,741],{"class":291},"state",[86,743,744],{"class":117}," ==",[86,746,747],{"class":121}," \"failed\"",[86,749,301],{"class":103},[86,751,752,755,757,760,762,764,766,769],{"class":88,"line":328},[86,753,754],{"class":177},"                    errorPackages",[86,756,181],{"class":103},[86,758,759],{"class":99},"push",[86,761,166],{"class":103},[86,763,718],{"class":177},[86,765,181],{"class":103},[86,767,768],{"class":291},"name",[86,770,172],{"class":103},[86,772,773],{"class":88,"line":337},[86,774,775],{"class":92},"                    break\n",[86,777,778],{"class":88,"line":513},[86,779,780],{"class":103},"                }\n",[86,782,783],{"class":88,"line":519},[86,784,785],{"class":103},"            }\n",[86,787,788],{"class":88,"line":537},[86,789,428],{"class":103},[86,791,793],{"class":88,"line":792},18,[86,794,147],{"emptyLinePlaceholder":146},[86,796,798,801,803,806,808,811,814,818],{"class":88,"line":797},19,[86,799,800],{"class":92},"        if",[86,802,283],{"class":103},[86,804,805],{"class":177},"errorPackages",[86,807,181],{"class":103},[86,809,810],{"class":291},"length",[86,812,813],{"class":117}," >",[86,815,817],{"class":816},"sAGMh"," 0",[86,819,301],{"class":103},[86,821,823,826,828,830,833,836,840,842,845,848,850,854,856,858,861,864,867],{"class":88,"line":822},20,[86,824,825],{"class":92},"            await",[86,827,357],{"class":99},[86,829,166],{"class":103},[86,831,832],{"class":121},"`COPR 以下包发生构建失败:",[86,834,835],{"class":117},"\\n",[86,837,839],{"class":838},"sAOjX","${",[86,841,805],{"class":177},[86,843,181],{"class":844},"sMj0N",[86,846,847],{"class":99},"join",[86,849,166],{"class":103},[86,851,853],{"class":852},"sWwuK","\"",[86,855,835],{"class":117},[86,857,853],{"class":852},[86,859,860],{"class":103},")",[86,862,863],{"class":838},"}",[86,865,866],{"class":121},"`",[86,868,172],{"class":103},[86,870,872,875,878],{"class":88,"line":871},21,[86,873,874],{"class":103},"        } ",[86,876,877],{"class":92},"else",[86,879,389],{"class":103},[86,881,883,886,888,890,892,895],{"class":88,"line":882},22,[86,884,885],{"class":177},"            console",[86,887,181],{"class":103},[86,889,527],{"class":99},[86,891,166],{"class":103},[86,893,894],{"class":121},"\"COPR 所有包构建成功\"",[86,896,172],{"class":103},[86,898,900],{"class":88,"line":899},23,[86,901,428],{"class":103},[86,903,905],{"class":88,"line":904},24,[86,906,325],{"class":103},[86,908,910],{"class":88,"line":909},25,[86,911,912],{"class":103},"};\n",[20,914,915],{},"随后在 Cloudflare Workers 的 Settings 部分设置好 Cron 表达式即可，我这里选择在每小时的 55 分进行一次检测，这样下来一天只会消耗 24 次 workers 次数，简直毫无压力。",[20,917,918],{},[67,919],{"alt":69,"src":920},"https://static.031130.xyz/uploads/2025/02/23/c38edfd637934.webp",[20,922,923,927,928,931],{},[924,925,926],"strong",{},"缺点:"," 我懒得使用持久化数据库记录软件包构建的成功状态，这会导致出现一个包构建失败后，每隔 1 小时都会有一条提醒，",[23,929,930],{},"什么夺命连环 call","。我目前不想修复这个问题，要不然还是降低 cron 的触发频率好了。",[933,934,935],"style",{},"html pre.shiki code .sLKXg, html code.shiki .sLKXg{--shiki-default:#A626A4;--shiki-dark:#C678DD}html pre.shiki code .sAdtL, html code.shiki .sAdtL{--shiki-default:#4078F2;--shiki-dark:#61AFEF}html pre.shiki code .s5ixo, html code.shiki .s5ixo{--shiki-default:#383A42;--shiki-dark:#ABB2BF}html pre.shiki code .sNmU0, html code.shiki .sNmU0{--shiki-default:#986801;--shiki-dark:#E5C07B}html pre.shiki code .s_Sar, html code.shiki .s_Sar{--shiki-default:#0184BC;--shiki-dark:#56B6C2}html pre.shiki code .sDhpE, html code.shiki .sDhpE{--shiki-default:#50A14F;--shiki-dark:#98C379}html pre.shiki code .s7GmK, html code.shiki .s7GmK{--shiki-default:#383A42;--shiki-dark:#E5C07B}html pre.shiki code .s2QsP, html code.shiki .s2QsP{--shiki-default:#E45649;--shiki-dark:#E5C07B}html pre.shiki code .sz0mV, html code.shiki .sz0mV{--shiki-default:#383A42;--shiki-dark:#E06C75}html pre.shiki code .sJa8x, html code.shiki .sJa8x{--shiki-default:#E45649;--shiki-dark:#E06C75}html .default .shiki span {color: var(--shiki-default);background: var(--shiki-default-bg);font-style: var(--shiki-default-font-style);font-weight: var(--shiki-default-font-weight);text-decoration: var(--shiki-default-text-decoration);}html .shiki span {color: var(--shiki-default);background: var(--shiki-default-bg);font-style: var(--shiki-default-font-style);font-weight: var(--shiki-default-font-weight);text-decoration: var(--shiki-default-text-decoration);}html .dark .shiki span {color: var(--shiki-dark);background: var(--shiki-dark-bg);font-style: var(--shiki-dark-font-style);font-weight: var(--shiki-dark-font-weight);text-decoration: var(--shiki-dark-text-decoration);}html.dark .shiki span {color: var(--shiki-dark);background: var(--shiki-dark-bg);font-style: var(--shiki-dark-font-style);font-weight: var(--shiki-dark-font-weight);text-decoration: var(--shiki-dark-text-decoration);}html pre.shiki code .s8iYz, html code.shiki .s8iYz{--shiki-default:#383A42;--shiki-default-font-style:inherit;--shiki-dark:#E06C75;--shiki-dark-font-style:italic}html pre.shiki code .st7oF, html code.shiki .st7oF{--shiki-default:#0184BC;--shiki-dark:#ABB2BF}html pre.shiki code .sq3v1, html code.shiki .sq3v1{--shiki-default:#E45649;--shiki-dark:#C678DD}html pre.shiki code .sAGMh, html code.shiki .sAGMh{--shiki-default:#986801;--shiki-dark:#D19A66}html pre.shiki code .sAOjX, html code.shiki .sAOjX{--shiki-default:#CA1243;--shiki-dark:#C678DD}html pre.shiki code .sMj0N, html code.shiki .sMj0N{--shiki-default:#50A14F;--shiki-dark:#ABB2BF}html pre.shiki code .sWwuK, html code.shiki .sWwuK{--shiki-default:#CA1243;--shiki-dark:#98C379}",{"title":69,"searchDepth":107,"depth":107,"links":937},[],{"title":939,"date":940,"path":941,"tags":942,"body":945},"基于 Cloudflare Workers 实现的在线服务状态检测告警系统","2025-01-18 02:00:08","/2025/01/18/service-status-monitor-based-on-cloudflare-workers",[11,10,943,944],"crontab","Network",{"type":14,"value":946,"toc":1602},[947,951,958,961,967,984,987,1003,1006,1017,1024,1031,1037,1041,1056,1059,1067,1086,1097,1103,1110,1113,1130,1137,1164,1167,1393,1396,1419,1422,1429,1432,1441,1518,1521,1524,1536,1539,1551,1554,1561,1566,1569,1575,1578,1585,1592,1599],[948,949,950],"h2",{"id":950},"起因",[20,952,953,954,957],{},"受一些客观因素的影响，微精弘前一阵子针对学校教务系统的数据爬取服务状态出现了非常不稳定的状态，而后端在设计初并没有考虑到异常告警机制，恰逢现任员工都身陷期末周的痛苦之中，我这种计院 Lite 专业的精弘老人就打算实现一个针对「",[924,955,956],{},"微精弘主后端 \u003C->  funnel 爬虫服务 \u003C-> 教务系统","」这一条链路的告警机制。旨在短期内（即期末周结束之前）填补微精弘的后端服务告警机制的空白，让运维人员能够及时收到并处理排查后端网络链路的异常情况，尽最大努力保证服务在线率，保障工大本科生在期末周内使用体验。",[948,959,960],{"id":960},"需求分析",[20,962,963],{},[67,964],{"alt":965,"src":966},"微精弘的技术架构图","https://static.031130.xyz/uploads/2025/01/19/74362573e371d.webp",[17,968,969],{},[20,970,971,972,977,978,983],{},"如果你不知道微精弘的具体架构实现，这里有一篇由前技术总监提笔并由现任技术总监完善的架构杂谈「",[30,973,976],{"href":974,"rel":975},"https://mp.weixin.qq.com/s/8d6JAPsLa4TzLr50uDG8uw",[41],"微精弘 | 架构杂谈","」，原文最初发表于前者的",[30,979,982],{"href":980,"rel":981},"https://blog.cnpatrickstar.com/posts/wejh-architecture/",[41],"博客","。",[20,985,986],{},"基于上述客观条件以及我个人在服务监控告警领域近乎为 0 的经验，我一拍脑袋提出了以下几点需求：",[988,989,990,994,997,1000],"ol",{},[991,992,993],"li",{},"稳定性。告警服务本身必须要比我们的主后端更加稳定，这是告警服务的基础。",[991,995,996],{},"针对现有服务的侵入性低。告警服务不能影响到现有服务，最好能够完全分离开来，不应当部署在同一台服务器上。",[991,998,999],{},"开发快速。整个服务需要尽快落地，因为现有的服务在一周内出现了三次故障，且由于主动的监控告警机制的缺失，我们每次都要等服务 down 机的两小时后才意识到服务挂掉了，如果真在考试周这个使用高峰期内再出现这样的故障不容允许的（用户需要查询考场信息）。",[991,1001,1002],{},"尽可能低的运维成本。没什么好解释的，谁也不希望一个告警服务占用太多的运维成本，无论是人力上的还是资源上的。",[948,1004,1005],{"id":1005},"技术选型",[20,1007,1008,1009,1012,1013,1016],{},"结合我已有的经验，我选用了 ",[924,1010,1011],{},"Cloudflare Worker"," 来完成这个任务。Cloudflare Workers 本身是支持 ",[924,1014,1015],{},"cron job"," 的，能够以分钟级为单位的间隔对服务进行主动探测。Cloudflare 每天都有 10w 次免费的 Workers 调用额度，本身的服务在线率也过硬，唯一的缺点可能就是海外节点访问国内服务器的延迟过高了。不过考虑到我们探测的是在线情况而非延迟情况，倒也不是不能接受。",[20,1018,1019,1020,1023],{},"由于服务特性的关系，我们容许一定的访问失败概率。比如五次访问中如果有两三次失败，我们也认为线路是通的，",[23,1021,1022],{},"可能只是教务系统的土豆快熟了","。因此并不是每一次失败的探测都需要进行告警。另外，我们还需要记录当前的服务状态，一旦服务被认定为下线状态，后续探测失败我们就不再进行告警，直到我们重新判定服务状态为上线（即每段连续的下线时间都只触发一次告警）。Cloudflare Worker 是一种 serverless 服务，且每次执行探测任务的可能都不是同一个 Cloudflare 的边缘节点，因此我们没法使用变量在内存中记录目前的服务状态，需要引入外部数据库来完成短期内的数据存储。",[20,1025,1026,1027,1030],{},"在数据库上，我们必须选择 Cloudflare 自家的在线数据库服务，通过 Cloudflare 自己内部的网络传输数据库查询结果才能得到尽可能低的延迟。在一番考量过后，KV 数据库和 SQL 数据库中，我果断选择了 ",[924,1028,1029],{},"Cloudflare D1"," 这个 SQL 数据库（本质是 SQLite），D1 数据库以更长的查询时间换取数据的实时性。Cloudflare 为免费用户提供了每天 500w 行读取和 10w 行写入的免费额度，只要好好加以利用，就不太可能超出限额。后续我还考虑通过这些数据库的数据使用 Cloudflare Worker 构建 uptime status 的后端 API，实现一个类似 status.openai.com 的在线服务状态可视化界面。",[20,1032,1033],{},[67,1034],{"alt":1035,"src":1036},"OpenAI 的 uptime status","https://static.031130.xyz/uploads/2025/01/19/f817539504140.webp",[948,1038,1040],{"id":1039},"登陆-wrangler","登陆 wrangler",[78,1042,1046],{"className":1043,"code":1044,"language":1045,"meta":69,"style":69},"language-bash shiki shiki-themes one-light one-dark-pro","wrangler login\n","bash",[60,1047,1048],{"__ignoreMap":69},[86,1049,1050,1053],{"class":88,"line":89},[86,1051,1052],{"class":99},"wrangler",[86,1054,1055],{"class":121}," login\n",[948,1057,1058],{"id":1058},"项目初始化",[20,1060,1061,1062,1066],{},"由于之前有过一些编写 Cloudflare Workers 的经验，我深知在 Cloudflare 网页的 code server 编辑器上编辑单文件的 worker.js 的不便，选择使用 Cloudflare 官方推出的工具 ",[30,1063,1052],{"href":1064,"rel":1065},"https://developers.cloudflare.com/workers/wrangler/",[41]," 进行项目的初始化。",[78,1068,1070],{"className":1043,"code":1069,"language":1045,"meta":69,"style":69},"npm create cloudflare@latest wjh-monitor\n",[60,1071,1072],{"__ignoreMap":69},[86,1073,1074,1077,1080,1083],{"class":88,"line":89},[86,1075,1076],{"class":99},"npm",[86,1078,1079],{"class":121}," create",[86,1081,1082],{"class":121}," cloudflare@latest",[86,1084,1085],{"class":121}," wjh-monitor\n",[17,1087,1088,1091,1094],{},[20,1089,1090],{},"Q: What would you like to start with?\nA: Hello World example",[20,1092,1093],{},"Q: Which template would you like to use?\nA: Hello World Worker",[20,1095,1096],{},"Q: Which language do you want to use?\nA: TypeScript",[20,1098,1099],{},[67,1100],{"alt":1101,"src":1102},"得到的项目结构","https://static.031130.xyz/uploads/2025/01/20/bf105c9fc18a3.webp",[20,1104,1105,1106,1109],{},"我们只需要在 ",[60,1107,1108],{},"index.ts"," 中编写我们的主要逻辑即可。",[948,1111,1112],{"id":1112},"数据库初始化",[78,1114,1116],{"className":1043,"code":1115,"language":1045,"meta":69,"style":69},"wrangler d1 create wjh-monitor-db\n",[60,1117,1118],{"__ignoreMap":69},[86,1119,1120,1122,1125,1127],{"class":88,"line":89},[86,1121,1052],{"class":99},[86,1123,1124],{"class":121}," d1",[86,1126,1079],{"class":121},[86,1128,1129],{"class":121}," wjh-monitor-db\n",[20,1131,1132,1133,1136],{},"随后会输出这些内容，我们需要把这些配置文件写入项目的 ",[60,1134,1135],{},"wrangler.toml"," 文件中",[78,1138,1142],{"className":1139,"code":1140,"language":1141,"meta":69,"style":69},"language-toml shiki shiki-themes one-light one-dark-pro","[[d1_databases]]\nbinding = \"DB\"\ndatabase_name = \"wjh-monitor-db\"\ndatabase_id = \"ffffffff-ffff-ffff-ffff-ffffffffffff\"\n","toml",[60,1143,1144,1149,1154,1159],{"__ignoreMap":69},[86,1145,1146],{"class":88,"line":89},[86,1147,1148],{},"[[d1_databases]]\n",[86,1150,1151],{"class":88,"line":107},[86,1152,1153],{},"binding = \"DB\"\n",[86,1155,1156],{"class":88,"line":128},[86,1157,1158],{},"database_name = \"wjh-monitor-db\"\n",[86,1160,1161],{"class":88,"line":143},[86,1162,1163],{},"database_id = \"ffffffff-ffff-ffff-ffff-ffffffffffff\"\n",[20,1165,1166],{},"编写一个 sql 文件创建数据表，并通过 wrangler 创建它",[78,1168,1172],{"className":1169,"code":1170,"language":1171,"meta":69,"style":69},"language-sql shiki shiki-themes one-light one-dark-pro","// schema.sql\nCREATE TABLE IF NOT EXISTS DATA (\n    id INTEGER PRIMARY KEY AUTOINCREMENT,\n    check_time TIMESTAMP DEFAULT CURRENT_TIMESTAMP,\n    check_item VARCHAR(10),\n    response_time INTEGER NOT NULL,\n    success BOOLEAN NOT NULL,\n    online_status BOOLEAN NOT NULL,\n    notify BOOLEAN DEFAULT FALSE,\n    other TEXT,\n    INDEX check_time_idx (check_time)\n);\nINSERT INTO DATA (\n        response_time,\n        success,\n        online_status,\n        notify,\n        other\n    )\nVALUES (100, 1, 1, 0, 'initial');\n","sql",[60,1173,1174,1187,1210,1224,1238,1254,1266,1278,1289,1301,1311,1319,1323,1332,1337,1342,1347,1352,1357,1362],{"__ignoreMap":69},[86,1175,1176,1179,1182,1184],{"class":88,"line":89},[86,1177,1178],{"class":103},"// ",[86,1180,1181],{"class":816},"schema",[86,1183,181],{"class":103},[86,1185,1186],{"class":816},"sql\n",[86,1188,1189,1192,1195,1198,1201,1204,1207],{"class":88,"line":107},[86,1190,1191],{"class":92},"CREATE",[86,1193,1194],{"class":92}," TABLE",[86,1196,1197],{"class":99}," IF",[86,1199,1200],{"class":92}," NOT",[86,1202,1203],{"class":92}," EXISTS",[86,1205,1206],{"class":92}," DATA",[86,1208,1209],{"class":103}," (\n",[86,1211,1212,1215,1218,1221],{"class":88,"line":128},[86,1213,1214],{"class":103},"    id ",[86,1216,1217],{"class":92},"INTEGER",[86,1219,1220],{"class":92}," PRIMARY KEY",[86,1222,1223],{"class":103}," AUTOINCREMENT,\n",[86,1225,1226,1229,1232,1235],{"class":88,"line":143},[86,1227,1228],{"class":103},"    check_time ",[86,1230,1231],{"class":92},"TIMESTAMP",[86,1233,1234],{"class":92}," DEFAULT",[86,1236,1237],{"class":103}," CURRENT_TIMESTAMP,\n",[86,1239,1240,1243,1246,1248,1251],{"class":88,"line":150},[86,1241,1242],{"class":103},"    check_item ",[86,1244,1245],{"class":92},"VARCHAR",[86,1247,166],{"class":103},[86,1249,1250],{"class":816},"10",[86,1252,1253],{"class":103},"),\n",[86,1255,1256,1259,1261,1264],{"class":88,"line":3},[86,1257,1258],{"class":103},"    response_time ",[86,1260,1217],{"class":92},[86,1262,1263],{"class":92}," NOT NULL",[86,1265,404],{"class":103},[86,1267,1268,1271,1274,1276],{"class":88,"line":207},[86,1269,1270],{"class":103},"    success ",[86,1272,1273],{"class":92},"BOOLEAN",[86,1275,1263],{"class":92},[86,1277,404],{"class":103},[86,1279,1280,1283,1285,1287],{"class":88,"line":232},[86,1281,1282],{"class":103},"    online_status ",[86,1284,1273],{"class":92},[86,1286,1263],{"class":92},[86,1288,404],{"class":103},[86,1290,1291,1294,1296,1298],{"class":88,"line":255},[86,1292,1293],{"class":103},"    notify ",[86,1295,1273],{"class":92},[86,1297,1234],{"class":92},[86,1299,1300],{"class":103}," FALSE,\n",[86,1302,1303,1306,1309],{"class":88,"line":277},[86,1304,1305],{"class":103},"    other ",[86,1307,1308],{"class":92},"TEXT",[86,1310,404],{"class":103},[86,1312,1313,1316],{"class":88,"line":304},[86,1314,1315],{"class":92},"    INDEX",[86,1317,1318],{"class":103}," check_time_idx (check_time)\n",[86,1320,1321],{"class":88,"line":322},[86,1322,600],{"class":103},[86,1324,1325,1328,1330],{"class":88,"line":328},[86,1326,1327],{"class":92},"INSERT INTO",[86,1329,1206],{"class":92},[86,1331,1209],{"class":103},[86,1333,1334],{"class":88,"line":337},[86,1335,1336],{"class":103},"        response_time,\n",[86,1338,1339],{"class":88,"line":513},[86,1340,1341],{"class":103},"        success,\n",[86,1343,1344],{"class":88,"line":519},[86,1345,1346],{"class":103},"        online_status,\n",[86,1348,1349],{"class":88,"line":537},[86,1350,1351],{"class":103},"        notify,\n",[86,1353,1354],{"class":88,"line":792},[86,1355,1356],{"class":103},"        other\n",[86,1358,1359],{"class":88,"line":797},[86,1360,1361],{"class":103},"    )\n",[86,1363,1364,1367,1369,1372,1374,1377,1379,1381,1383,1386,1388,1391],{"class":88,"line":822},[86,1365,1366],{"class":92},"VALUES",[86,1368,283],{"class":103},[86,1370,1371],{"class":816},"100",[86,1373,198],{"class":103},[86,1375,1376],{"class":816},"1",[86,1378,198],{"class":103},[86,1380,1376],{"class":816},[86,1382,198],{"class":103},[86,1384,1385],{"class":816},"0",[86,1387,198],{"class":103},[86,1389,1390],{"class":121},"'initial'",[86,1392,600],{"class":103},[20,1394,1395],{},"使用 sql 文件创建远程数据表",[78,1397,1399],{"className":1043,"code":1398,"language":1045,"meta":69,"style":69},"wrangler d1 execute wjh-monitor-db --remote --file=./schema.sql\n",[60,1400,1401],{"__ignoreMap":69},[86,1402,1403,1405,1407,1410,1413,1416],{"class":88,"line":89},[86,1404,1052],{"class":99},[86,1406,1124],{"class":121},[86,1408,1409],{"class":121}," execute",[86,1411,1412],{"class":121}," wjh-monitor-db",[86,1414,1415],{"class":816}," --remote",[86,1417,1418],{"class":816}," --file=./schema.sql\n",[20,1420,1421],{},"随后我们可以使用 wrangler 在远程数据库上执行 query 命令，并获得相应的结果",[78,1423,1427],{"className":1424,"code":1426,"language":363},[1425],"language-text","wrangler d1 execute wjh-monitor-db --remote --command='SELECT * FROM DATA'\n",[60,1428,1426],{"__ignoreMap":69},[948,1430,1431],{"id":1431},"主体逻辑编写",[20,1433,1434,1435,1440],{},"说实话，代码部分没什么太多好说的，正要了解思路直接去看",[30,1436,1439],{"href":1437,"rel":1438},"https://github.com/zhullyb/wjh-monitor",[41],"源码","就好。我在这里简单提两点。",[988,1442,1443,1453,1463],{},[991,1444,1445,1446,1449,1450,1452],{},"目录下的 ",[60,1447,1448],{},"worker-configuration.d.ts"," 定义了 env 变量的类型定义，如果我们在项目中绑定了一些变量（比如我们在 ",[60,1451,1135],{}," 中绑定了 d1 数据库，变量名为 DB），需要在这里声明以防止后续 TypeScript 的报错。",[991,1454,1455,1456,1459,1460,1462],{},"在 ",[60,1457,1458],{},"export default {}"," 中是将会被导出的主要函数，Hello World 项目编写了 fetch 函数，这是在 workers 被通过 http 方式访问时所调用的，如果要使用 cron job 功能，我们需要编写 scheduled 函数来被 workers 调用，并在 ",[60,1461,1135],{}," 中配置好 crontab 触发器。",[991,1464,1465,1466,1468,1469,1474,1475],{},"我们在 ",[60,1467,1135],{}," 中绑定了 DB 变量作为数据库的快捷访问方式，因此我们可以在代码中通过 ",[30,1470,1473],{"href":1471,"rel":1472},"https://developers.cloudflare.com/d1/worker-api/",[41],"D1 数据库的 Workers Binding API"," 来实现针对数据库的快捷操作，如",[78,1476,1478],{"className":80,"code":1477,"language":82,"meta":69,"style":69},"const res = await env.DB.prepare(\"SELECT * FROM DATA ORDER BY check_time DESC LIMIT 4\").run();\n",[60,1479,1480],{"__ignoreMap":69},[86,1481,1482,1484,1487,1489,1491,1494,1496,1499,1501,1504,1506,1509,1512,1515],{"class":88,"line":89},[86,1483,676],{"class":92},[86,1485,1486],{"class":113}," res",[86,1488,118],{"class":117},[86,1490,242],{"class":92},[86,1492,1493],{"class":177}," env",[86,1495,181],{"class":103},[86,1497,1498],{"class":184},"DB",[86,1500,181],{"class":103},[86,1502,1503],{"class":99},"prepare",[86,1505,166],{"class":103},[86,1507,1508],{"class":121},"\"SELECT * FROM DATA ORDER BY check_time DESC LIMIT 4\"",[86,1510,1511],{"class":103},").",[86,1513,1514],{"class":99},"run",[86,1516,1517],{"class":103},"();\n",[20,1519,1520],{},"需要注意的是，workers 不存在上下文，每一次访问的处理都是前后独立的，如果你需要临时存储一些数据，不要使用变量，一定要存入持久化存储的数据库。",[20,1522,1523],{},"预览:",[78,1525,1527],{"className":1043,"code":1526,"language":1045,"meta":69,"style":69},"wrangler dev\n",[60,1528,1529],{"__ignoreMap":69},[86,1530,1531,1533],{"class":88,"line":89},[86,1532,1052],{"class":99},[86,1534,1535],{"class":121}," dev\n",[20,1537,1538],{},"部署:",[78,1540,1542],{"className":1043,"code":1541,"language":1045,"meta":69,"style":69},"wrangler deploy\n",[60,1543,1544],{"__ignoreMap":69},[86,1545,1546,1548],{"class":88,"line":89},[86,1547,1052],{"class":99},[86,1549,1550],{"class":121}," deploy\n",[948,1552,1553],{"id":1553},"小插曲",[20,1555,1556,1557,1560],{},"由于我对后端经验的缺乏，我在编写 sql 语句时没有意识到建立索引的重要性。我在查询时使用了 ",[60,1558,1559],{},"ORDER BY \u003C未建立索引字段> LIMIT 5"," 的方式来查询最近五次的记录，这导致数据库不得不在我每次查询时都完整遍历一遍整张表。随着 cronjob 每分钟运行时插入一条新数据，记录的行数随时间增加，每次查询的成本也逐渐增加，最终造成了单日访问八百多万行的记录，超出了 Cloudflare 的免费额度，一度造成了项目被迫下线的风险。",[20,1562,1563],{},[67,1564],{"alt":69,"src":1565},"https://static.031130.xyz/uploads/2025/01/20/fb463f45038ac.webp",[20,1567,1568],{},"所幸 Cloudflare 没有给我停机，而我也及时定位到了问题并补建了索引，使每日的读取量回到了正常的状态。",[20,1570,1571],{},[67,1572],{"alt":1573,"src":1574},"蓝色线条为读取，黄色线条为写入","https://static.031130.xyz/uploads/2025/01/19/83f69aff3a7b4.webp",[948,1576,1577],{"id":1577},"参见",[20,1579,1580],{},[30,1581,1584],{"href":1582,"rel":1583},"https://developers.cloudflare.com/d1/",[41],"Cloudflare D1 · Cloudflare D1 docs",[20,1586,1587],{},[30,1588,1591],{"href":1589,"rel":1590},"https://developers.cloudflare.com/workers/configuration/cron-triggers/",[41],"Cron Triggers · Cloudflare Workers docs",[20,1593,1594],{},[30,1595,1598],{"href":1596,"rel":1597},"https://blog.sww.moe/post/cloudflare-d1/",[41],"Cloudflare D1 使用记录",[933,1600,1601],{},"html pre.shiki code .sAdtL, html code.shiki .sAdtL{--shiki-default:#4078F2;--shiki-dark:#61AFEF}html pre.shiki code .sDhpE, html code.shiki .sDhpE{--shiki-default:#50A14F;--shiki-dark:#98C379}html .default .shiki span {color: var(--shiki-default);background: var(--shiki-default-bg);font-style: var(--shiki-default-font-style);font-weight: var(--shiki-default-font-weight);text-decoration: var(--shiki-default-text-decoration);}html .shiki span {color: var(--shiki-default);background: var(--shiki-default-bg);font-style: var(--shiki-default-font-style);font-weight: var(--shiki-default-font-weight);text-decoration: var(--shiki-default-text-decoration);}html .dark .shiki span {color: var(--shiki-dark);background: var(--shiki-dark-bg);font-style: var(--shiki-dark-font-style);font-weight: var(--shiki-dark-font-weight);text-decoration: var(--shiki-dark-text-decoration);}html.dark .shiki span {color: var(--shiki-dark);background: var(--shiki-dark-bg);font-style: var(--shiki-dark-font-style);font-weight: var(--shiki-dark-font-weight);text-decoration: var(--shiki-dark-text-decoration);}html pre.shiki code .s5ixo, html code.shiki .s5ixo{--shiki-default:#383A42;--shiki-dark:#ABB2BF}html pre.shiki code .sAGMh, html code.shiki .sAGMh{--shiki-default:#986801;--shiki-dark:#D19A66}html pre.shiki code .sLKXg, html code.shiki .sLKXg{--shiki-default:#A626A4;--shiki-dark:#C678DD}html pre.shiki code .sNmU0, html code.shiki .sNmU0{--shiki-default:#986801;--shiki-dark:#E5C07B}html pre.shiki code .s_Sar, html code.shiki .s_Sar{--shiki-default:#0184BC;--shiki-dark:#56B6C2}html pre.shiki code .s7GmK, html code.shiki .s7GmK{--shiki-default:#383A42;--shiki-dark:#E5C07B}html pre.shiki code .s2QsP, html code.shiki .s2QsP{--shiki-default:#E45649;--shiki-dark:#E5C07B}",{"title":69,"searchDepth":107,"depth":107,"links":1603},[1604,1605,1606,1607,1608,1609,1610,1611,1612],{"id":950,"depth":107,"text":950},{"id":960,"depth":107,"text":960},{"id":1005,"depth":107,"text":1005},{"id":1039,"depth":107,"text":1040},{"id":1058,"depth":107,"text":1058},{"id":1112,"depth":107,"text":1112},{"id":1431,"depth":107,"text":1431},{"id":1553,"depth":107,"text":1553},{"id":1577,"depth":107,"text":1577},{"title":1614,"date":1615,"path":1616,"tags":1617,"body":1619},"构建部署在 Cloudflare Workers 上的 TG Bot","2024-12-30 19:45:43","/2024/12/30/tg-bot-hosted-on-cloudflare-workers",[1618,11],"Bot",{"type":14,"value":1620,"toc":2906},[1621,1623,1634,1646,1649,1653,1661,1669,1672,1675,1678,1681,1685,1688,1695,1743,1746,1749,1983,1986,1989,2457,2460,2880,2884,2887,2890,2895,2898,2903],[948,1622,950],{"id":950},[20,1624,1625,1626,1630,1631],{},"早在去年 10 月，我就写过一篇",[30,1627,1629],{"href":1628},"/2023/10/29/create-b23tv-remover-bot/","《创建 b23.tv 追踪参数移除 bot》","。记录了部署 b23.tv 的追踪参数移除 Bot 的部署方案。其中提到的 TG Bot 随着服务器到期不再续费也一同落灰了——",[924,1632,1633],{},"公益服务总是这样，开始时满腔热血，随着时间散去没有多少人能坚持投入成本，徒留下一地鸡毛。",[20,1635,1636,1637,1642,1643],{},"大概半个月前，我在群里看见 ",[30,1638,1641],{"href":1639,"rel":1640},"https://asukaminato.eu.org/",[41],"Asuka Minato"," 开发的群消息总结 Bot，整体部署在 Cloudflare Workers 上，在保证零运营成本的情况下有着相当非常不错的在线率保证，因此便考虑将这个 Bot 迁移到 Cloudflare Workers 上。",[924,1644,1645],{},"选用免费的 serverless 能够有效延长服务的可持续性，它不需要额外投入时间精力和财力进行维护，通常可以活很久。",[20,1647,1648],{},"之所以可以把 TG Bot 部署到 Cloudflare Workers 上，主要是得益于 TG 平台支持 webhook 的方式让 Bot 程序提供服务。我们所需要提供的是一个公网能访问的 http 地址，在成功注册 webhook 服务后，TG 的官方服务器会将所有 Bot 所在群或者和所有对个人的对话以 http 请求的方式打到这个 url 上，而 Cloudflare Workers 平台就能提供一个 workers.dev 结尾的公网 url 作为 webhook 提供给 TG 服务器。",[948,1650,1652],{"id":1651},"怎么做","怎么做？",[20,1654,1655,1660],{},[30,1656,1659],{"href":1657,"rel":1658},"https://github.com/cvzi/telegram-bot-cloudflare",[41],"在这个 Github 仓库中","，给出了不少例子，用以讲述如何利用 Cloudflare Workers 构建 TG Bot。",[20,1662,1455,1663,1668],{},[30,1664,1667],{"href":1665,"rel":1666},"https://github.com/cvzi/telegram-bot-cloudflare/blob/main/bot.js",[41],"bot.js"," 这个文件中编写了一个最简单的 TG Bot，其功能是: 将受到的所有消息在头部添加「Echo:」字符串，并发送回刚才的对话。",[20,1670,1671],{},"例: 用户发送 「Hello」，bot 回复 「Echo: Hello」",[1673,1674],"hr",{},[948,1676,1677],{"id":1677},"代码分析",[20,1679,1680],{},"代码整体分为四个部分",[1682,1683,1684],"h3",{"id":1684},"顶部变量",[20,1686,1687],{},"文件顶部定义了 Bot 的 token、webhook 的 url 路径以及一个简易的 webhook 密码。",[20,1689,1690,1691,1694],{},"TOKEN 是从 botfather 那里获得的 bot token，SECRET 是自己设置的 webhook 密码，TG 的 webhook 服务器会通过把这个字段添加到名为 ",[60,1692,1693],{},"X-Telegram-Bot-Api-Secret-Token"," 的请求头中来证明自己的官方身份。",[78,1696,1698],{"className":80,"code":1697,"language":82,"meta":69,"style":69},"const TOKEN = ENV_BOT_TOKEN // Get it from @BotFather https://core.telegram.org/bots#6-botfather\nconst WEBHOOK = '/endpoint'\nconst SECRET = ENV_BOT_SECRET // A-Z, a-z, 0-9, _ and -\n",[60,1699,1700,1716,1728],{"__ignoreMap":69},[86,1701,1702,1704,1707,1709,1712],{"class":88,"line":89},[86,1703,676],{"class":92},[86,1705,1706],{"class":113}," TOKEN",[86,1708,118],{"class":117},[86,1710,1711],{"class":113}," ENV_BOT_TOKEN",[86,1713,1715],{"class":1714},"sW2Sy"," // Get it from @BotFather https://core.telegram.org/bots#6-botfather\n",[86,1717,1718,1720,1723,1725],{"class":88,"line":107},[86,1719,676],{"class":92},[86,1721,1722],{"class":113}," WEBHOOK",[86,1724,118],{"class":117},[86,1726,1727],{"class":121}," '/endpoint'\n",[86,1729,1730,1732,1735,1737,1740],{"class":88,"line":128},[86,1731,676],{"class":92},[86,1733,1734],{"class":113}," SECRET",[86,1736,118],{"class":117},[86,1738,1739],{"class":113}," ENV_BOT_SECRET",[86,1741,1742],{"class":1714}," // A-Z, a-z, 0-9, _ and -\n",[1682,1744,1745],{"id":1745},"简易路由",[20,1747,1748],{},"紧接着定义了一个简易的路由",[78,1750,1752],{"className":80,"code":1751,"language":82,"meta":69,"style":69},"addEventListener('fetch', event => {\n  const url = new URL(event.request.url)\n  if (url.pathname === WEBHOOK) {\n    event.respondWith(handleWebhook(event))\n  } else if (url.pathname === '/registerWebhook') {\n    event.respondWith(registerWebhook(event, url, WEBHOOK, SECRET))\n  } else if (url.pathname === '/unRegisterWebhook') {\n    event.respondWith(unRegisterWebhook(event))\n  } else {\n    event.respondWith(new Response('No handler for this request'))\n  }\n})\n",[60,1753,1754,1773,1800,1821,1843,1868,1901,1924,1943,1951,1973,1978],{"__ignoreMap":69},[86,1755,1756,1759,1761,1764,1766,1768,1771],{"class":88,"line":89},[86,1757,1758],{"class":99},"addEventListener",[86,1760,166],{"class":103},[86,1762,1763],{"class":121},"'fetch'",[86,1765,198],{"class":103},[86,1767,621],{"class":362},[86,1769,1770],{"class":92}," =>",[86,1772,389],{"class":103},[86,1774,1775,1778,1780,1782,1784,1786,1788,1790,1792,1794,1796,1798],{"class":88,"line":107},[86,1776,1777],{"class":92},"  const",[86,1779,155],{"class":113},[86,1781,118],{"class":117},[86,1783,160],{"class":92},[86,1785,163],{"class":99},[86,1787,166],{"class":103},[86,1789,621],{"class":177},[86,1791,181],{"class":103},[86,1793,570],{"class":184},[86,1795,181],{"class":103},[86,1797,250],{"class":291},[86,1799,172],{"class":103},[86,1801,1802,1805,1807,1809,1811,1814,1817,1819],{"class":88,"line":128},[86,1803,1804],{"class":92},"  if",[86,1806,283],{"class":103},[86,1808,250],{"class":177},[86,1810,181],{"class":103},[86,1812,1813],{"class":291},"pathname",[86,1815,1816],{"class":117}," ===",[86,1818,1722],{"class":113},[86,1820,301],{"class":103},[86,1822,1823,1826,1828,1831,1833,1836,1838,1840],{"class":88,"line":143},[86,1824,1825],{"class":177},"    event",[86,1827,181],{"class":103},[86,1829,1830],{"class":99},"respondWith",[86,1832,166],{"class":103},[86,1834,1835],{"class":99},"handleWebhook",[86,1837,166],{"class":103},[86,1839,621],{"class":201},[86,1841,1842],{"class":103},"))\n",[86,1844,1845,1848,1850,1853,1855,1857,1859,1861,1863,1866],{"class":88,"line":150},[86,1846,1847],{"class":103},"  } ",[86,1849,877],{"class":92},[86,1851,1852],{"class":92}," if",[86,1854,283],{"class":103},[86,1856,250],{"class":177},[86,1858,181],{"class":103},[86,1860,1813],{"class":291},[86,1862,1816],{"class":117},[86,1864,1865],{"class":121}," '/registerWebhook'",[86,1867,301],{"class":103},[86,1869,1870,1872,1874,1876,1878,1881,1883,1885,1887,1889,1891,1894,1896,1899],{"class":88,"line":3},[86,1871,1825],{"class":177},[86,1873,181],{"class":103},[86,1875,1830],{"class":99},[86,1877,166],{"class":103},[86,1879,1880],{"class":99},"registerWebhook",[86,1882,166],{"class":103},[86,1884,621],{"class":201},[86,1886,198],{"class":103},[86,1888,250],{"class":201},[86,1890,198],{"class":103},[86,1892,1893],{"class":113},"WEBHOOK",[86,1895,198],{"class":103},[86,1897,1898],{"class":113},"SECRET",[86,1900,1842],{"class":103},[86,1902,1903,1905,1907,1909,1911,1913,1915,1917,1919,1922],{"class":88,"line":207},[86,1904,1847],{"class":103},[86,1906,877],{"class":92},[86,1908,1852],{"class":92},[86,1910,283],{"class":103},[86,1912,250],{"class":177},[86,1914,181],{"class":103},[86,1916,1813],{"class":291},[86,1918,1816],{"class":117},[86,1920,1921],{"class":121}," '/unRegisterWebhook'",[86,1923,301],{"class":103},[86,1925,1926,1928,1930,1932,1934,1937,1939,1941],{"class":88,"line":232},[86,1927,1825],{"class":177},[86,1929,181],{"class":103},[86,1931,1830],{"class":99},[86,1933,166],{"class":103},[86,1935,1936],{"class":99},"unRegisterWebhook",[86,1938,166],{"class":103},[86,1940,621],{"class":201},[86,1942,1842],{"class":103},[86,1944,1945,1947,1949],{"class":88,"line":255},[86,1946,1847],{"class":103},[86,1948,877],{"class":92},[86,1950,389],{"class":103},[86,1952,1953,1955,1957,1959,1961,1964,1966,1968,1971],{"class":88,"line":277},[86,1954,1825],{"class":177},[86,1956,181],{"class":103},[86,1958,1830],{"class":99},[86,1960,166],{"class":103},[86,1962,1963],{"class":92},"new",[86,1965,592],{"class":99},[86,1967,166],{"class":103},[86,1969,1970],{"class":121},"'No handler for this request'",[86,1972,1842],{"class":103},[86,1974,1975],{"class":88,"line":304},[86,1976,1977],{"class":103},"  }\n",[86,1979,1980],{"class":88,"line":322},[86,1981,1982],{"class":103},"})\n",[1682,1984,1985],{"id":1985},"核心功能",[20,1987,1988],{},"随后的三个函数，会先进行 SECRET 的校验，并将 message 类型消息从 TG 的所有消息类型中分离开单独处理",[78,1990,1992],{"className":80,"code":1991,"language":82,"meta":69,"style":69},"/**\n * Handle requests to WEBHOOK\n * https://core.telegram.org/bots/api#update\n */\nasync function handleWebhook (event) {\n  // Check secret\n  if (event.request.headers.get('X-Telegram-Bot-Api-Secret-Token') !== SECRET) {\n    return new Response('Unauthorized', { status: 403 })\n  }\n\n  // Read request body synchronously\n  const update = await event.request.json()\n  // Deal with response asynchronously\n  event.waitUntil(onUpdate(update))\n\n  return new Response('Ok')\n}\n\n/**\n * Handle incoming Update\n * https://core.telegram.org/bots/api#update\n */\nasync function onUpdate (update) {\n  if ('message' in update) {\n    await onMessage(update.message)\n  }\n}\n\n/**\n * Handle incoming Message\n * https://core.telegram.org/bots/api#message\n */\nfunction onMessage (message) {\n  return sendPlainText(message.chat.id, 'Echo:\\n' + message.text)\n}\n\n/**\n * Send plain text message\n * https://core.telegram.org/bots/api#sendmessage\n */\nasync function sendPlainText (chatId, text) {\n  return (await fetch(apiUrl('sendMessage', {\n    chat_id: chatId,\n    text\n  }))).json()\n",[60,1993,1994,1999,2004,2009,2014,2029,2034,2071,2098,2102,2106,2111,2135,2140,2162,2166,2182,2186,2190,2194,2199,2203,2207,2222,2238,2257,2262,2267,2272,2277,2283,2289,2294,2308,2352,2357,2362,2367,2373,2379,2384,2404,2428,2441,2447],{"__ignoreMap":69},[86,1995,1996],{"class":88,"line":89},[86,1997,1998],{"class":1714},"/**\n",[86,2000,2001],{"class":88,"line":107},[86,2002,2003],{"class":1714}," * Handle requests to WEBHOOK\n",[86,2005,2006],{"class":88,"line":128},[86,2007,2008],{"class":1714}," * https://core.telegram.org/bots/api#update\n",[86,2010,2011],{"class":88,"line":143},[86,2012,2013],{"class":1714}," */\n",[86,2015,2016,2018,2020,2023,2025,2027],{"class":88,"line":150},[86,2017,93],{"class":92},[86,2019,96],{"class":92},[86,2021,2022],{"class":99}," handleWebhook",[86,2024,283],{"class":103},[86,2026,621],{"class":362},[86,2028,301],{"class":103},[86,2030,2031],{"class":88,"line":3},[86,2032,2033],{"class":1714},"  // Check secret\n",[86,2035,2036,2038,2040,2042,2044,2046,2048,2051,2053,2056,2058,2061,2064,2067,2069],{"class":88,"line":207},[86,2037,1804],{"class":92},[86,2039,283],{"class":103},[86,2041,621],{"class":177},[86,2043,181],{"class":103},[86,2045,570],{"class":184},[86,2047,181],{"class":103},[86,2049,2050],{"class":184},"headers",[86,2052,181],{"class":103},[86,2054,2055],{"class":99},"get",[86,2057,166],{"class":103},[86,2059,2060],{"class":121},"'X-Telegram-Bot-Api-Secret-Token'",[86,2062,2063],{"class":103},") ",[86,2065,2066],{"class":117},"!==",[86,2068,1734],{"class":113},[86,2070,301],{"class":103},[86,2072,2073,2075,2077,2079,2081,2084,2087,2090,2092,2095],{"class":88,"line":232},[86,2074,331],{"class":92},[86,2076,160],{"class":92},[86,2078,592],{"class":99},[86,2080,166],{"class":103},[86,2082,2083],{"class":121},"'Unauthorized'",[86,2085,2086],{"class":103},", { ",[86,2088,2089],{"class":291},"status",[86,2091,398],{"class":397},[86,2093,2094],{"class":816}," 403",[86,2096,2097],{"class":103}," })\n",[86,2099,2100],{"class":88,"line":255},[86,2101,1977],{"class":103},[86,2103,2104],{"class":88,"line":277},[86,2105,147],{"emptyLinePlaceholder":146},[86,2107,2108],{"class":88,"line":304},[86,2109,2110],{"class":1714},"  // Read request body synchronously\n",[86,2112,2113,2115,2118,2120,2122,2125,2127,2129,2131,2133],{"class":88,"line":322},[86,2114,1777],{"class":92},[86,2116,2117],{"class":113}," update",[86,2119,118],{"class":117},[86,2121,242],{"class":92},[86,2123,2124],{"class":177}," event",[86,2126,181],{"class":103},[86,2128,570],{"class":184},[86,2130,181],{"class":103},[86,2132,271],{"class":99},[86,2134,274],{"class":103},[86,2136,2137],{"class":88,"line":328},[86,2138,2139],{"class":1714},"  // Deal with response asynchronously\n",[86,2141,2142,2145,2147,2150,2152,2155,2157,2160],{"class":88,"line":337},[86,2143,2144],{"class":177},"  event",[86,2146,181],{"class":103},[86,2148,2149],{"class":99},"waitUntil",[86,2151,166],{"class":103},[86,2153,2154],{"class":99},"onUpdate",[86,2156,166],{"class":103},[86,2158,2159],{"class":201},"update",[86,2161,1842],{"class":103},[86,2163,2164],{"class":88,"line":513},[86,2165,147],{"emptyLinePlaceholder":146},[86,2167,2168,2171,2173,2175,2177,2180],{"class":88,"line":519},[86,2169,2170],{"class":92},"  return",[86,2172,160],{"class":92},[86,2174,592],{"class":99},[86,2176,166],{"class":103},[86,2178,2179],{"class":121},"'Ok'",[86,2181,172],{"class":103},[86,2183,2184],{"class":88,"line":537},[86,2185,340],{"class":103},[86,2187,2188],{"class":88,"line":792},[86,2189,147],{"emptyLinePlaceholder":146},[86,2191,2192],{"class":88,"line":797},[86,2193,1998],{"class":1714},[86,2195,2196],{"class":88,"line":822},[86,2197,2198],{"class":1714}," * Handle incoming Update\n",[86,2200,2201],{"class":88,"line":871},[86,2202,2008],{"class":1714},[86,2204,2205],{"class":88,"line":882},[86,2206,2013],{"class":1714},[86,2208,2209,2211,2213,2216,2218,2220],{"class":88,"line":899},[86,2210,93],{"class":92},[86,2212,96],{"class":92},[86,2214,2215],{"class":99}," onUpdate",[86,2217,283],{"class":103},[86,2219,2159],{"class":362},[86,2221,301],{"class":103},[86,2223,2224,2226,2228,2231,2234,2236],{"class":88,"line":904},[86,2225,1804],{"class":92},[86,2227,283],{"class":103},[86,2229,2230],{"class":121},"'message'",[86,2232,2233],{"class":92}," in",[86,2235,2117],{"class":201},[86,2237,301],{"class":103},[86,2239,2240,2243,2246,2248,2250,2252,2255],{"class":88,"line":909},[86,2241,2242],{"class":92},"    await",[86,2244,2245],{"class":99}," onMessage",[86,2247,166],{"class":103},[86,2249,2159],{"class":177},[86,2251,181],{"class":103},[86,2253,2254],{"class":291},"message",[86,2256,172],{"class":103},[86,2258,2260],{"class":88,"line":2259},26,[86,2261,1977],{"class":103},[86,2263,2265],{"class":88,"line":2264},27,[86,2266,340],{"class":103},[86,2268,2270],{"class":88,"line":2269},28,[86,2271,147],{"emptyLinePlaceholder":146},[86,2273,2275],{"class":88,"line":2274},29,[86,2276,1998],{"class":1714},[86,2278,2280],{"class":88,"line":2279},30,[86,2281,2282],{"class":1714}," * Handle incoming Message\n",[86,2284,2286],{"class":88,"line":2285},31,[86,2287,2288],{"class":1714}," * https://core.telegram.org/bots/api#message\n",[86,2290,2292],{"class":88,"line":2291},32,[86,2293,2013],{"class":1714},[86,2295,2297,2300,2302,2304,2306],{"class":88,"line":2296},33,[86,2298,2299],{"class":92},"function",[86,2301,2245],{"class":99},[86,2303,283],{"class":103},[86,2305,2254],{"class":362},[86,2307,301],{"class":103},[86,2309,2311,2313,2316,2318,2320,2322,2325,2327,2330,2332,2335,2337,2340,2343,2346,2348,2350],{"class":88,"line":2310},34,[86,2312,2170],{"class":92},[86,2314,2315],{"class":99}," sendPlainText",[86,2317,166],{"class":103},[86,2319,2254],{"class":177},[86,2321,181],{"class":103},[86,2323,2324],{"class":184},"chat",[86,2326,181],{"class":103},[86,2328,2329],{"class":291},"id",[86,2331,198],{"class":103},[86,2333,2334],{"class":121},"'Echo:",[86,2336,835],{"class":117},[86,2338,2339],{"class":121},"'",[86,2341,2342],{"class":117}," +",[86,2344,2345],{"class":177}," message",[86,2347,181],{"class":103},[86,2349,363],{"class":291},[86,2351,172],{"class":103},[86,2353,2355],{"class":88,"line":2354},35,[86,2356,340],{"class":103},[86,2358,2360],{"class":88,"line":2359},36,[86,2361,147],{"emptyLinePlaceholder":146},[86,2363,2365],{"class":88,"line":2364},37,[86,2366,1998],{"class":1714},[86,2368,2370],{"class":88,"line":2369},38,[86,2371,2372],{"class":1714}," * Send plain text message\n",[86,2374,2376],{"class":88,"line":2375},39,[86,2377,2378],{"class":1714}," * https://core.telegram.org/bots/api#sendmessage\n",[86,2380,2382],{"class":88,"line":2381},40,[86,2383,2013],{"class":1714},[86,2385,2387,2389,2391,2393,2395,2398,2400,2402],{"class":88,"line":2386},41,[86,2388,93],{"class":92},[86,2390,96],{"class":92},[86,2392,2315],{"class":99},[86,2394,283],{"class":103},[86,2396,2397],{"class":362},"chatId",[86,2399,198],{"class":103},[86,2401,363],{"class":362},[86,2403,301],{"class":103},[86,2405,2407,2409,2411,2414,2416,2418,2421,2423,2426],{"class":88,"line":2406},42,[86,2408,2170],{"class":92},[86,2410,283],{"class":103},[86,2412,2413],{"class":92},"await",[86,2415,245],{"class":99},[86,2417,166],{"class":103},[86,2419,2420],{"class":99},"apiUrl",[86,2422,166],{"class":103},[86,2424,2425],{"class":121},"'sendMessage'",[86,2427,452],{"class":103},[86,2429,2431,2434,2436,2439],{"class":88,"line":2430},43,[86,2432,2433],{"class":291},"    chat_id",[86,2435,398],{"class":397},[86,2437,2438],{"class":201}," chatId",[86,2440,404],{"class":103},[86,2442,2444],{"class":88,"line":2443},44,[86,2445,2446],{"class":201},"    text\n",[86,2448,2450,2453,2455],{"class":88,"line":2449},45,[86,2451,2452],{"class":103},"  }))).",[86,2454,271],{"class":99},[86,2456,274],{"class":103},[20,2458,2459],{},"我们需要更改的就是这个 onMessage 函数，用户输入的文本信息通过 message.text 获取，我们可以很轻易的把 b23 remover 的逻辑用 js 实现",[78,2461,2463],{"className":80,"code":2462,"language":82,"meta":69,"style":69},"async function onMessage(message) {\n    if (!message.text) {\n        return;\n    }\n    const b23Reg = /b23\\.tv\\/[a-zA-Z0-9]+/g;\n    if (!b23Reg.test(message.text)) {\n        console.log('No match found');\n    }\n    const b23Links = message.text.match(b23Reg);\n    const cleanLinks = [];\n    await Promise.all(\n        b23Links.map(link => b23Remover('https://' + link))\n    ).then(result => {\n        cleanLinks.push(...result);\n    });\n\n    const text2Send = \"Track ID removed:\\n\" + cleanLinks.join(\"\\n\");\n    return sendPlainText(message.chat.id, text2Send);\n}\n\nasync function b23Remover (url) {\n    const r = await fetch(url)\n    const v = r.url\n    const u = new URL(v)\n    return u.origin + u.pathname\n}\n",[60,2464,2465,2479,2496,2503,2507,2544,2570,2586,2590,2616,2628,2644,2676,2693,2711,2716,2720,2754,2779,2783,2787,2801,2820,2836,2856,2876],{"__ignoreMap":69},[86,2466,2467,2469,2471,2473,2475,2477],{"class":88,"line":89},[86,2468,93],{"class":92},[86,2470,96],{"class":92},[86,2472,2245],{"class":99},[86,2474,166],{"class":103},[86,2476,2254],{"class":362},[86,2478,301],{"class":103},[86,2480,2481,2483,2485,2488,2490,2492,2494],{"class":88,"line":107},[86,2482,280],{"class":92},[86,2484,283],{"class":103},[86,2486,2487],{"class":117},"!",[86,2489,2254],{"class":177},[86,2491,181],{"class":103},[86,2493,363],{"class":291},[86,2495,301],{"class":103},[86,2497,2498,2501],{"class":88,"line":128},[86,2499,2500],{"class":92},"        return",[86,2502,125],{"class":103},[86,2504,2505],{"class":88,"line":143},[86,2506,325],{"class":103},[86,2508,2509,2511,2514,2516,2520,2523,2526,2529,2532,2536,2539,2542],{"class":88,"line":150},[86,2510,110],{"class":92},[86,2512,2513],{"class":113}," b23Reg",[86,2515,118],{"class":117},[86,2517,2519],{"class":2518},"sDaw7"," /b23",[86,2521,2522],{"class":117},"\\.",[86,2524,2525],{"class":2518},"tv",[86,2527,2528],{"class":117},"\\/",[86,2530,2531],{"class":816},"[a-zA-Z0-9]",[86,2533,2535],{"class":2534},"sYoRg","+",[86,2537,2538],{"class":2518},"/",[86,2540,2541],{"class":92},"g",[86,2543,125],{"class":103},[86,2545,2546,2548,2550,2552,2555,2557,2560,2562,2564,2566,2568],{"class":88,"line":3},[86,2547,280],{"class":92},[86,2549,283],{"class":103},[86,2551,2487],{"class":117},[86,2553,2554],{"class":177},"b23Reg",[86,2556,181],{"class":103},[86,2558,2559],{"class":99},"test",[86,2561,166],{"class":103},[86,2563,2254],{"class":177},[86,2565,181],{"class":103},[86,2567,363],{"class":291},[86,2569,726],{"class":103},[86,2571,2572,2575,2577,2579,2581,2584],{"class":88,"line":207},[86,2573,2574],{"class":177},"        console",[86,2576,181],{"class":103},[86,2578,527],{"class":99},[86,2580,166],{"class":103},[86,2582,2583],{"class":121},"'No match found'",[86,2585,600],{"class":103},[86,2587,2588],{"class":88,"line":232},[86,2589,325],{"class":103},[86,2591,2592,2594,2597,2599,2601,2603,2605,2607,2610,2612,2614],{"class":88,"line":255},[86,2593,110],{"class":92},[86,2595,2596],{"class":113}," b23Links",[86,2598,118],{"class":117},[86,2600,2345],{"class":177},[86,2602,181],{"class":103},[86,2604,363],{"class":184},[86,2606,181],{"class":103},[86,2608,2609],{"class":99},"match",[86,2611,166],{"class":103},[86,2613,2554],{"class":201},[86,2615,600],{"class":103},[86,2617,2618,2620,2623,2625],{"class":88,"line":277},[86,2619,110],{"class":92},[86,2621,2622],{"class":113}," cleanLinks",[86,2624,118],{"class":117},[86,2626,2627],{"class":103}," [];\n",[86,2629,2630,2632,2636,2638,2641],{"class":88,"line":304},[86,2631,2242],{"class":92},[86,2633,2635],{"class":2634},"sC09Y"," Promise",[86,2637,181],{"class":103},[86,2639,2640],{"class":99},"all",[86,2642,2643],{"class":103},"(\n",[86,2645,2646,2649,2651,2654,2656,2659,2661,2664,2666,2669,2671,2674],{"class":88,"line":322},[86,2647,2648],{"class":177},"        b23Links",[86,2650,181],{"class":103},[86,2652,2653],{"class":99},"map",[86,2655,166],{"class":103},[86,2657,2658],{"class":362},"link",[86,2660,1770],{"class":92},[86,2662,2663],{"class":99}," b23Remover",[86,2665,166],{"class":103},[86,2667,2668],{"class":121},"'https://'",[86,2670,2342],{"class":117},[86,2672,2673],{"class":201}," link",[86,2675,1842],{"class":103},[86,2677,2678,2681,2684,2686,2689,2691],{"class":88,"line":328},[86,2679,2680],{"class":103},"    ).",[86,2682,2683],{"class":99},"then",[86,2685,166],{"class":103},[86,2687,2688],{"class":362},"result",[86,2690,1770],{"class":92},[86,2692,389],{"class":103},[86,2694,2695,2698,2700,2702,2704,2707,2709],{"class":88,"line":337},[86,2696,2697],{"class":177},"        cleanLinks",[86,2699,181],{"class":103},[86,2701,759],{"class":99},[86,2703,166],{"class":103},[86,2705,2706],{"class":397},"...",[86,2708,2688],{"class":201},[86,2710,600],{"class":103},[86,2712,2713],{"class":88,"line":513},[86,2714,2715],{"class":103},"    });\n",[86,2717,2718],{"class":88,"line":519},[86,2719,147],{"emptyLinePlaceholder":146},[86,2721,2722,2724,2727,2729,2732,2734,2736,2738,2740,2742,2744,2746,2748,2750,2752],{"class":88,"line":537},[86,2723,110],{"class":92},[86,2725,2726],{"class":113}," text2Send",[86,2728,118],{"class":117},[86,2730,2731],{"class":121}," \"Track ID removed:",[86,2733,835],{"class":117},[86,2735,853],{"class":121},[86,2737,2342],{"class":117},[86,2739,2622],{"class":177},[86,2741,181],{"class":103},[86,2743,847],{"class":99},[86,2745,166],{"class":103},[86,2747,853],{"class":121},[86,2749,835],{"class":117},[86,2751,853],{"class":121},[86,2753,600],{"class":103},[86,2755,2756,2758,2760,2762,2764,2766,2768,2770,2772,2774,2777],{"class":88,"line":792},[86,2757,331],{"class":92},[86,2759,2315],{"class":99},[86,2761,166],{"class":103},[86,2763,2254],{"class":177},[86,2765,181],{"class":103},[86,2767,2324],{"class":184},[86,2769,181],{"class":103},[86,2771,2329],{"class":291},[86,2773,198],{"class":103},[86,2775,2776],{"class":201},"text2Send",[86,2778,600],{"class":103},[86,2780,2781],{"class":88,"line":797},[86,2782,340],{"class":103},[86,2784,2785],{"class":88,"line":822},[86,2786,147],{"emptyLinePlaceholder":146},[86,2788,2789,2791,2793,2795,2797,2799],{"class":88,"line":871},[86,2790,93],{"class":92},[86,2792,96],{"class":92},[86,2794,2663],{"class":99},[86,2796,283],{"class":103},[86,2798,250],{"class":362},[86,2800,301],{"class":103},[86,2802,2803,2805,2808,2810,2812,2814,2816,2818],{"class":88,"line":882},[86,2804,110],{"class":92},[86,2806,2807],{"class":113}," r",[86,2809,118],{"class":117},[86,2811,242],{"class":92},[86,2813,245],{"class":99},[86,2815,166],{"class":103},[86,2817,250],{"class":201},[86,2819,172],{"class":103},[86,2821,2822,2824,2827,2829,2831,2833],{"class":88,"line":899},[86,2823,110],{"class":92},[86,2825,2826],{"class":113}," v",[86,2828,118],{"class":117},[86,2830,2807],{"class":177},[86,2832,181],{"class":103},[86,2834,2835],{"class":291},"url\n",[86,2837,2838,2840,2843,2845,2847,2849,2851,2854],{"class":88,"line":904},[86,2839,110],{"class":92},[86,2841,2842],{"class":113}," u",[86,2844,118],{"class":117},[86,2846,160],{"class":92},[86,2848,163],{"class":99},[86,2850,166],{"class":103},[86,2852,2853],{"class":201},"v",[86,2855,172],{"class":103},[86,2857,2858,2860,2862,2864,2867,2869,2871,2873],{"class":88,"line":909},[86,2859,331],{"class":92},[86,2861,2842],{"class":177},[86,2863,181],{"class":103},[86,2865,2866],{"class":291},"origin",[86,2868,2342],{"class":117},[86,2870,2842],{"class":177},[86,2872,181],{"class":103},[86,2874,2875],{"class":291},"pathname\n",[86,2877,2878],{"class":88,"line":2259},[86,2879,340],{"class":103},[1682,2881,2883],{"id":2882},"webhook-注册相关","webhook 注册相关",[20,2885,2886],{},"后面的 registerWebhook、unRegisterWebhook、apiUrl 在没有特定需求的情况下不需要变动。",[20,2888,2889],{},"在 Cloudflare 部署后，就可以访问 aaa.bbb.workers.dev/registerWebhook 这个 url 注册 TG 的 webhook 服务。收到 Ok 就代表注册好了。",[20,2891,2892],{},[67,2893],{"alt":69,"src":2894},"https://static.031130.xyz/uploads/2024/12/30/5fd442bb18064.webp",[948,2896,2897],{"id":2897},"成果展示",[20,2899,2900],{},[67,2901],{"alt":69,"src":2902},"https://static.031130.xyz/uploads/2024/12/30/3b0b929960840.webp",[933,2904,2905],{},"html pre.shiki code .sLKXg, html code.shiki .sLKXg{--shiki-default:#A626A4;--shiki-dark:#C678DD}html pre.shiki code .sNmU0, html code.shiki .sNmU0{--shiki-default:#986801;--shiki-dark:#E5C07B}html pre.shiki code .s_Sar, html code.shiki .s_Sar{--shiki-default:#0184BC;--shiki-dark:#56B6C2}html pre.shiki code .sW2Sy, html code.shiki .sW2Sy{--shiki-default:#A0A1A7;--shiki-default-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic}html pre.shiki code .sDhpE, html code.shiki .sDhpE{--shiki-default:#50A14F;--shiki-dark:#98C379}html .default .shiki span {color: var(--shiki-default);background: var(--shiki-default-bg);font-style: var(--shiki-default-font-style);font-weight: var(--shiki-default-font-weight);text-decoration: var(--shiki-default-text-decoration);}html .shiki span {color: var(--shiki-default);background: var(--shiki-default-bg);font-style: var(--shiki-default-font-style);font-weight: var(--shiki-default-font-weight);text-decoration: var(--shiki-default-text-decoration);}html .dark .shiki span {color: var(--shiki-dark);background: var(--shiki-dark-bg);font-style: var(--shiki-dark-font-style);font-weight: var(--shiki-dark-font-weight);text-decoration: var(--shiki-dark-text-decoration);}html.dark .shiki span {color: var(--shiki-dark);background: var(--shiki-dark-bg);font-style: var(--shiki-dark-font-style);font-weight: var(--shiki-dark-font-weight);text-decoration: var(--shiki-dark-text-decoration);}html pre.shiki code .sAdtL, html code.shiki .sAdtL{--shiki-default:#4078F2;--shiki-dark:#61AFEF}html pre.shiki code .s5ixo, html code.shiki .s5ixo{--shiki-default:#383A42;--shiki-dark:#ABB2BF}html pre.shiki code .s8iYz, html code.shiki .s8iYz{--shiki-default:#383A42;--shiki-default-font-style:inherit;--shiki-dark:#E06C75;--shiki-dark-font-style:italic}html pre.shiki code .s7GmK, html code.shiki .s7GmK{--shiki-default:#383A42;--shiki-dark:#E5C07B}html pre.shiki code .s2QsP, html code.shiki .s2QsP{--shiki-default:#E45649;--shiki-dark:#E5C07B}html pre.shiki code .sJa8x, html code.shiki .sJa8x{--shiki-default:#E45649;--shiki-dark:#E06C75}html pre.shiki code .sz0mV, html code.shiki .sz0mV{--shiki-default:#383A42;--shiki-dark:#E06C75}html pre.shiki code .st7oF, html code.shiki .st7oF{--shiki-default:#0184BC;--shiki-dark:#ABB2BF}html pre.shiki code .sAGMh, html code.shiki .sAGMh{--shiki-default:#986801;--shiki-dark:#D19A66}html pre.shiki code .sDaw7, html code.shiki .sDaw7{--shiki-default:#0184BC;--shiki-dark:#E06C75}html pre.shiki code .sYoRg, html code.shiki .sYoRg{--shiki-default:#0184BC;--shiki-dark:#D19A66}html pre.shiki code .sC09Y, html code.shiki .sC09Y{--shiki-default:#C18401;--shiki-dark:#E5C07B}",{"title":69,"searchDepth":107,"depth":107,"links":2907},[2908,2909,2910,2916],{"id":950,"depth":107,"text":950},{"id":1651,"depth":107,"text":1652},{"id":1677,"depth":107,"text":1677,"children":2911},[2912,2913,2914,2915],{"id":1684,"depth":128,"text":1684},{"id":1745,"depth":128,"text":1745},{"id":1985,"depth":128,"text":1985},{"id":2882,"depth":128,"text":2883},{"id":2897,"depth":107,"text":2897},{"title":2918,"date":2919,"path":2920,"tags":2921,"body":2925},"2024年，Firefox 是唯一还在坚持执行在线的 SSL 证书吊销状态检查的主流浏览器","2024-11-19 17:58:14","/2024/11/19/firefox-is-the-only-mainstream-brower-doing-online-certificate-revocation-checks",[2922,2923,2924],"Firefox","SSL","OpenSSL",{"type":14,"value":2926,"toc":3427},[2927,2931,2934,2949,2956,2959,2964,2967,2974,2987,2995,3000,3003,3008,3012,3021,3025,3028,3032,3035,3038,3077,3082,3088,3092,3095,3106,3109,3115,3119,3126,3171,3181,3184,3200,3204,3207,3210,3213,3231,3234,3239,3243,3260,3263,3280,3283,3286,3289,3295,3298,3301,3310,3312,3424],[948,2928,2930],{"id":2929},"小试一下","小试一下？",[20,2932,2933],{},"在开始阅读后面的内容之前，或许你可以试试看你正在使用的浏览器能不能访问下面两个链接:",[2935,2936,2937,2943],"ul",{},[991,2938,2939],{},[30,2940,2941],{"href":2941,"rel":2942},"https://digicert-tls-ecc-p384-root-g5-revoked.chain-demos.digicert.com/",[41],[991,2944,2945],{},[30,2946,2947],{"href":2947,"rel":2948},"https://revoked-isrgrootx1.letsencrypt.org/",[41],[20,2950,2951,2952,2955],{},"这两个链接分别是由 digicert 和 Let's Encrypt 维护的，特意维持了一个",[924,2953,2954],{},"证书没过期，但被 CA 吊销","的状态。",[20,2957,2958],{},"在我的 Firefox for Linux 上，两个链接我都无法打开。",[20,2960,2961],{},[67,2962],{"alt":69,"src":2963},"https://static.031130.xyz/uploads/2024/11/19/f7785db60b2c8.webp",[20,2965,2966],{},"这是预期行为。Firefox 在与目标站点建立 https 链接之前，先向 CA 提供的 OCSP 服务器打了一个 http 请求来判断目标站点的 ssl 证书是否有效（是否没有被 CA 主动吊销）。",[20,2968,2969,2970],{},"在 Firefox for Android 上，我无法打开第一个链接，但可以打开第二个，这是因为 Mozilla 给 Android 用户设置的策略为「只对 EV 证书进行 ocsp 校验，跳过 DV 证书和 OV 证书」，",[2971,2972,2973],"em",{},"似乎在竞争更加激烈的移动端，Firefox 为了加载速度做出了安全性上的妥协。",[2975,2976,2977,2981,2984],"div",{},[67,2978],{"src":2979,"style":2980},"https://static.031130.xyz/uploads/2024/11/19/b097e954f766f.webp","zoom:33%;",[86,2982],{"style":2983},"width: 20%;",[67,2985],{"src":2986,"style":2980},"https://static.031130.xyz/uploads/2024/11/19/a5f58dbb50cfe.webp",[20,2988,2989,2990,983],{},"而在 Google Chrome / Microsoft Edge 上，OCSP 是不被支持的，chromium 团队在 2014 年就禁用了 OCSP 校验，且目前没有设置项允许用户手动开启，目前它只支持",[30,2991,2994],{"href":2992,"rel":2993},"https://www.chromium.org/Home/chromium-security/crlsets/",[41],"本地的 CRLSets 规则集",[20,2996,2997],{},[67,2998],{"alt":69,"src":2999},"https://static.031130.xyz/uploads/2024/11/19/bd84e9aff71d0.webp",[20,3001,3002],{},"Safari 经我本人测试默认只对 EV 证书进行有效性检验。",[20,3004,3005],{},[67,3006],{"alt":69,"src":3007},"https://static.031130.xyz/uploads/2024/11/19/50352339f7473.webp",[948,3009,3011],{"id":3010},"ssl-证书被吊销是怎么回事","SSL 证书被吊销是怎么回事？",[20,3013,3014,3015,3020],{},"在某些情况下（比如用户告知 CA 颁发给自己的证书私钥不慎被泄漏了，或者 ",[30,3016,3019],{"href":3017,"rel":3018},"https://www.trustasia.com/view-security-lets-encrypt/",[41],"CA 的颁发程序出现漏洞被人滥用，需要吊销在此期间发出去的所有证书","），CA 需要吊销一些证书，并通过自己的渠道将被吊销的证书尽快告知所有用户——需要被吊销的证书和正常的证书在外观上没有任何区别，用户的浏览器必须依赖 CA 的外部消息通知才能知道哪些证书是被吊销的。",[948,3022,3024],{"id":3023},"firefox-是如何接收来自-ca-的吊销信息的","Firefox 是如何接收来自 CA 的吊销信息的？",[20,3026,3027],{},"Firefox 通过提供了两种方案，以便用户从 CA 处得知目标站点的证书是否被吊销。",[1682,3029,3031],{"id":3030},"ocsp","OCSP",[20,3033,3034],{},"正如我前文所说的，Firefox 的 PC 端在与目标站点建立 https 连接之前，会先通过 http 协议向 CA 的 OCSP 服务器打一个 POST 请求来确认证书是否被吊销。",[20,3036,3037],{},"我们可以通过 openssl 拿到目标站点的 ssl 公钥，查看 CA 指定的 OCSP Server",[78,3039,3041],{"className":1043,"code":3040,"language":1045,"meta":69,"style":69},"openssl s_client -connect example.com:443 -servername example.com | openssl x509 -text -noout\n\n",[60,3042,3043],{"__ignoreMap":69},[86,3044,3045,3048,3051,3054,3057,3060,3063,3066,3068,3071,3074],{"class":88,"line":89},[86,3046,3047],{"class":99},"openssl",[86,3049,3050],{"class":121}," s_client",[86,3052,3053],{"class":816}," -connect",[86,3055,3056],{"class":121}," example.com:443",[86,3058,3059],{"class":816}," -servername",[86,3061,3062],{"class":121}," example.com",[86,3064,3065],{"class":103}," | ",[86,3067,3047],{"class":99},[86,3069,3070],{"class":121}," x509",[86,3072,3073],{"class":816}," -text",[86,3075,3076],{"class":816}," -noout\n",[20,3078,3079],{},[67,3080],{"alt":69,"src":3081},"https://static.031130.xyz/uploads/2024/11/19/32579fb56b77b.webp",[20,3083,3084],{},[67,3085],{"alt":3086,"src":3087},"访问第二个链接时的抓包结果","https://static.031130.xyz/uploads/2024/11/19/244704705924f.webp",[3089,3090,3091],"h4",{"id":3091},"软失败",[20,3093,3094],{},"这个请求一共有三种结果:",[988,3096,3097,3100,3103],{},[991,3098,3099],{},"请求结果正常，证书没有被吊销：Firefox 继续和目标站点建立 https 连接",[991,3101,3102],{},"请求结果正常，证书被吊销：Firefox 拒绝和目标站点建立 https 连接，如同我在博客开头贴的图",[991,3104,3105],{},"请求结果异常（请求超时）：Firefox 继续和目标站点建立 https 连接",[20,3107,3108],{},"透过在第三种情况，我们可以发现，Firefox 对 OCSP 检查的结果是软失败 (soft fail) 态度——即如果在 OCSP 过程中发生异常，Firefox 将不得不放弃 OCSP 检查并放行。根据 Mozilla Blog 的说法，如今有 9.9% 的 OCSP 检查都是超时的。",[20,3110,3111],{},[67,3112],{"alt":3113,"src":3114},"https://blog.mozilla.org/security/files/2020/01/figure4-ocsp_results.png","https://static.031130.xyz/uploads/2024/11/19/4a6c899a41128.webp",[3089,3116,3118],{"id":3117},"firefox-中的相关配置项","Firefox 中的相关配置项",[20,3120,3121,3122,3125],{},"在 Firefox 的 ",[60,3123,3124],{},"about:config"," 配置中搜索，我们可以看到一些关于 OCSP 的配置项",[2935,3127,3128,3145,3159,3165],{},[991,3129,3130,3133,3134],{},[60,3131,3132],{},"security.OCSP.enabled",": 是否开启 OCSP 检查，默认为 1",[2935,3135,3136,3139,3142],{},[991,3137,3138],{},"0: 关闭 OCSP 检查",[991,3140,3141],{},"1: 开启 OCSP 检查",[991,3143,3144],{},"2: 只对 EV 证书进行 OCSP 检查",[991,3146,3147,3150,3151],{},[60,3148,3149],{},"security.OCSP.required",": 是否一定要通过 OCSP 才允许建立连接（即是否不允许“软失败”），默认为 false",[2935,3152,3153,3156],{},[991,3154,3155],{},"false: 允许软失败",[991,3157,3158],{},"true: 不允许软失败",[991,3160,3161,3164],{},[60,3162,3163],{},"security.OCSP.timeoutMilliseconds.hard",": 针对 EV 证书，OCSP 检查的超时时间，默认为 10000 (10 秒)",[991,3166,3167,3170],{},[60,3168,3169],{},"security.OCSP.timeoutMilliseconds.soft",": 针对 DV 和 OV 证书，OCSP 检查的超时时间，默认为 2000（2 秒），移动端为 1 秒。",[20,3172,3173],{},[2971,3174,3175,3176],{},"EV 证书相比 DV 和 OV 有更严苛的申请条件，区别可以参考",[30,3177,3180],{"href":3178,"rel":3179},"https://www.digicert.com/cn/difference-between-dv-ov-and-ev-ssl-certificates",[41],"DV、OV和EV SSL证书之间有什么区别？",[3089,3182,3183],{"id":3183},"弊端",[2935,3185,3186,3189,3197],{},[991,3187,3188],{},"ocsp 不能在不增加用户负担的情况下使用硬失败(hard fail)，对于无响应或者超时的 ocsp 验证只能直接放行，这意味着攻击者可以直接屏蔽浏览器和 CA 之间的连接，拖到 ocsp 超时，并不能有效保障用户免受攻击。",[991,3190,3191,3192,983],{},"在 ocsp server 响应或者连接超时前，与目标站点的 https 连接会被阻塞，这带来了更大的访问延迟。有时还会出现",[30,3193,3196],{"href":3194,"rel":3195},"https://blog.wolfogre.com/posts/letsencrypt-ocsp-breakdown/",[41],"用户与 ocsp server 无法连接的情况",[991,3198,3199],{},"ocsp 是由用户浏览器主动向 CA 发起 http 请求，可能会导致用户隐私泄漏（IP 地址、位置、用户的部分浏览历史记录等）。即使 CA 故意不保留这些信息，地区法律也可能强制 CA 收集这些信息。",[3089,3201,3203],{"id":3202},"ocsp-装订-ocsp-stapling","OCSP 装订 (OCSP stapling)",[20,3205,3206],{},"这是一种新的方式，由目标站点的服务器主动向 CA 的 ocsp 服务器缓存 ocsp 信息（有效期最长为 7 天），并将其在用户访问时将相关信息一起提供给用户，避免用户直接向 CA 的服务器发起查询请求，能够规避部分弊端（避免 CA 收集用户信息，规避用户与 CA OCSP 服务器连接性不好等问题）。",[20,3208,3209],{},"目前，caddy 是默认开启 OCSP 装订的，而 nginx 可以在配置后手动开启。",[20,3211,3212],{},"可以采用 openssl 来查询目标站点是否开启了 OCSP 装订：",[78,3214,3216],{"className":1043,"code":3215,"language":1045,"meta":69,"style":69},"openssl s_client -connect example.com:443 -status\n",[60,3217,3218],{"__ignoreMap":69},[86,3219,3220,3222,3224,3226,3228],{"class":88,"line":89},[86,3221,3047],{"class":99},[86,3223,3050],{"class":121},[86,3225,3053],{"class":816},[86,3227,3056],{"class":121},[86,3229,3230],{"class":816}," -status\n",[20,3232,3233],{},"如果开启了 OCSP 装订，那么返回的数据中会有 OCSP Response Data 相关的描述",[20,3235,3236],{},[67,3237],{"alt":69,"src":3238},"https://static.031130.xyz/uploads/2024/11/19/71f252c97e96e.webp",[1682,3240,3242],{"id":3241},"crlite-wip","CRLite (WIP)",[20,3244,3245,3250,3251,3256,3257],{},[30,3246,3249],{"href":3247,"rel":3248},"https://obj.umiacs.umd.edu/papers_for_stories/crlite_oakland17.pdf",[41],"CRLite"," 是 ",[30,3252,3255],{"href":3253,"rel":3254},"https://www.ieee-security.org/TC/SP2017/",[41],"2017 年 IEEE 安全和隐私研讨会","上一组研究人员提出的一项技术，该技术可以有效地压缩吊销信息，使 300 兆字节的吊销数据可以变成 1 兆字节。CRLite 数据由 Mozilla 收集处理后推送给浏览器实现证书状态的本地查找，",[2971,3258,3259],{},"这项技术仍然处于开发阶段。",[20,3261,3262],{},"当浏览器使用 CRLite 查询对应站点的 ssl 证书的有效状态时，一般会有 5 种查询结果",[988,3264,3265,3268,3271,3274,3277],{},[991,3266,3267],{},"Certificate Valid，表示 CRLite 权威返回证书有效。",[991,3269,3270],{},"Certificate Revoked，表示 CRLite 权威返回证书已被吊销。",[991,3272,3273],{},"Issuer Not Enrolled, 这意味着正在评估的证书未包含在 CRLite 筛选器集中，可能是因为颁发证书的证书颁发机构 （CA） 未发布 CRL。",[991,3275,3276],{},"Certificate Too New，表示正在评估的证书比 CRLite 筛选器新。",[991,3278,3279],{},"Filter Not Available，这意味着 CRLite 过滤器要么尚未从 Remote Settings 下载，要么已经过时以至于停止服务。",[20,3281,3282],{},"Mozilla 计划每天发布 4 次 CRLite 的更新，以减少第 4 种情况。",[3089,3284,3285],{"id":3285},"速度优势",[20,3287,3288],{},"CRLite 的本地数据查询相比起 OCSP 的在线查询拥有天然的优势，99% 的情况下，CRLite 会比 OCSP 快，其中 56% 的情况下，CRLite 会比 OCSP 快 100 毫秒以上。",[20,3290,3291],{},[67,3292],{"alt":3293,"src":3294},"https://blog.mozilla.org/security/files/2020/01/figure3-speedup_vs_ocsp.png","https://static.031130.xyz/uploads/2024/11/19/bfba9ba3515ca.webp",[20,3296,3297],{},"此外，当 CRLite 不可用时，Firefox 仍然可以回退到传统的 OCSP 检测机制。",[948,3299,3300],{"id":3300},"其他",[20,3302,3303,3304,3309],{},"Let's Encrypt 在 2024 年 7 月",[30,3305,3308],{"href":3306,"rel":3307},"https://letsencrypt.org/2024/07/23/replacing-ocsp-with-crls/",[41],"发布博客","，CA/Browser Forum在上一年 8 月通过了一向投票允许 Let's Encrypt 等公开信任的 CA 将设立 OCSP server 作为可选选项。他们计划在未来 6~12 月内宣布关闭 OCSP 服务的时间表。",[948,3311,1577],{"id":1577},[2935,3313,3314,3321,3328,3335,3342,3349,3356,3363,3374,3381,3388,3394,3401,3407,3413,3419],{},[991,3315,3316],{},[30,3317,3320],{"href":3318,"rel":3319},"https://wiki.mozilla.org/CA/Revocation_Checking_in_Firefox",[41],"CA/Revocation Checking in Firefox - MozillaWiki",[991,3322,3323],{},[30,3324,3327],{"href":3325,"rel":3326},"https://discourse.mozilla.org/t/firefox-ocsp-policy/83150",[41],"Firefox OCSP policy - Firefox Development - Mozilla Discourse",[991,3329,3330],{},[30,3331,3334],{"href":3332,"rel":3333},"https://knowledge.digicert.com/nl/nl/quovadis/ssl-certificates/ssl-general-topics/in-which-browsers-is-ocsp-online-certificates-status-protocol-supported-in",[41],"In which browsers is OCSP (Online Certificates Status Protocol) supported in?",[991,3336,3337],{},[30,3338,3341],{"href":3339,"rel":3340},"https://blog.mozilla.org/security/2020/01/09/crlite-part-1-all-web-pki-revocations-compressed/",[41],"Introducing CRLite: All of the Web PKI’s revocations, compressed - Mozilla Security Blog",[991,3343,3344],{},[30,3345,3348],{"href":3346,"rel":3347},"https://blog.mozilla.org/security/2020/01/21/crlite-part-3-speeding-up-secure-browsing/",[41],"CRLite: Speeding Up Secure Browsing - Mozilla Security Blog",[991,3350,3351],{},[30,3352,3355],{"href":3353,"rel":3354},"https://blog.cloudflare.com/high-reliability-ocsp-stapling/",[41],"High-reliability OCSP stapling and why it matters - The Cloudflare Blog",[991,3357,3358],{},[30,3359,3362],{"href":3360,"rel":3361},"https://en.wikipedia.org/wiki/Online_Certificate_Status_Protocol",[41],"Online Certificate Status Protocol - Wikipedia",[991,3364,3365],{},[30,3366,3369,3370,3373],{"href":3367,"rel":3368},"https://bugzilla.mozilla.org/show_bug.cgi?id=1429800",[41],"1429800 - (crlite) ",[86,3371,3372],{},"meta"," Implement a CRLite based revocation mechanism",[991,3375,3376],{},[30,3377,3380],{"href":3378,"rel":3379},"https://bugzilla.mozilla.org/show_bug.cgi?id=1761109",[41],"1761109 - Make check-revocations mode the default CRLite mode",[991,3382,3383],{},[30,3384,3387],{"href":3385,"rel":3386},"https://www.reddit.com/r/browsers/comments/1bb81y8/firefox_the_only_browser_doing_certificate/",[41],"Firefox - The only browser doing certificate revocation checks right : r/browsers",[991,3389,3390],{},[30,3391,3393],{"href":3306,"rel":3392},[41],"Intent to End OCSP Service - Let's Encrypt",[991,3395,3396],{},[30,3397,3400],{"href":3398,"rel":3399},"https://groups.google.com/a/mozilla.org/g/dev-security-policy/c/S6A14e_X-T0/m/T4WxWgajAAAJ",[41],"Revocation checking for EV server certificates in Chrome - Google Groups",[991,3402,3403],{},[30,3404,3406],{"href":2992,"rel":3405},[41],"CRLSets - The Chromium Projects",[991,3408,3409],{},[30,3410,3412],{"href":3017,"rel":3411},[41],"由于Bug，Let's Encrypt决定吊销300多万张证书！",[991,3414,3415],{},[30,3416,3418],{"href":3194,"rel":3417},[41],"Let’s Encrypt OCSP 域名被封",[991,3420,3421],{},[30,3422,3180],{"href":3178,"rel":3423},[41],[933,3425,3426],{},"html pre.shiki code .sAdtL, html code.shiki .sAdtL{--shiki-default:#4078F2;--shiki-dark:#61AFEF}html pre.shiki code .sDhpE, html code.shiki .sDhpE{--shiki-default:#50A14F;--shiki-dark:#98C379}html pre.shiki code .sAGMh, html code.shiki .sAGMh{--shiki-default:#986801;--shiki-dark:#D19A66}html pre.shiki code .s5ixo, html code.shiki .s5ixo{--shiki-default:#383A42;--shiki-dark:#ABB2BF}html .default .shiki span {color: var(--shiki-default);background: var(--shiki-default-bg);font-style: var(--shiki-default-font-style);font-weight: var(--shiki-default-font-weight);text-decoration: var(--shiki-default-text-decoration);}html .shiki span {color: var(--shiki-default);background: var(--shiki-default-bg);font-style: var(--shiki-default-font-style);font-weight: var(--shiki-default-font-weight);text-decoration: var(--shiki-default-text-decoration);}html .dark .shiki span {color: var(--shiki-dark);background: var(--shiki-dark-bg);font-style: var(--shiki-dark-font-style);font-weight: var(--shiki-dark-font-weight);text-decoration: var(--shiki-dark-text-decoration);}html.dark .shiki span {color: var(--shiki-dark);background: var(--shiki-dark-bg);font-style: var(--shiki-dark-font-style);font-weight: var(--shiki-dark-font-weight);text-decoration: var(--shiki-dark-text-decoration);}",{"title":69,"searchDepth":107,"depth":107,"links":3428},[3429,3430,3431,3435,3436],{"id":2929,"depth":107,"text":2930},{"id":3010,"depth":107,"text":3011},{"id":3023,"depth":107,"text":3024,"children":3432},[3433,3434],{"id":3030,"depth":128,"text":3031},{"id":3241,"depth":128,"text":3242},{"id":3300,"depth":107,"text":3300},{"id":1577,"depth":107,"text":1577},{"title":3438,"date":3439,"path":3440,"tags":3441,"body":3444},"小爱课程表适配不完全指北——以 ZJUT 本科正方教务系统为例","2024-11-18 21:13:56","/2024/11/18/mi-ai-class-schedule-adapter-for-zjut",[10,3442,3443],"MiAI","Fun",{"type":14,"value":3445,"toc":5505},[3446,3449,3452,3455,3458,3466,3474,3477,3480,3491,3505,3512,3526,3529,3532,3541,3544,3547,3552,3555,3560,3563,3566,3569,3572,3577,3580,3583,3588,3594,3598,3601,3606,3609,3760,3763,3774,3777,3811,3814,3817,3916,3919,3922,3925,3932,3937,3941,3947,3950,3956,3975,3982,4341,4344,4540,4543,4625,4629,4632,4856,4859,4911,4914,4921,4924,5000,5003,5118,5125,5129,5138,5465,5468,5475,5478,5483,5486,5491,5494,5499,5502],[948,3447,3448],{"id":3448},"写在前面",[20,3450,3451],{},"一个月前，我发现小爱课程表中针对我学校的教务系统导入系统年久失修，因此我便决定自己另立门户、独立维护一版针对 ZJUT 教务系统课表信息导入的适配项目。",[20,3453,3454],{},"整个流程不难，如果你对于 js 代码和爬虫技术有简单的了解，那么很快就可以上手，我大概只花了 2 小时就完成了 阅读文档-编写代码-自测通过-提交审核 的过程，并在一周内正式上架，得到了身边同学的认可。",[20,3456,3457],{},"在适配过程中，一定要仔细阅读官方文档，所有技术性问题几乎都能通过官方文档解决。这篇博客我尽量详细记录了使用 fetch 打请求获取 json 的正方教务系统适配方案，仅供参考。",[20,3459,3460,3461],{},"官方文档地址: ",[30,3462,3465],{"href":3463,"rel":3464},"https://open-schedule-prod.ai.xiaomi.com/docs/#/help/",[41],"小爱课程表开发者工具使用教程",[20,3467,3468,3469],{},"我的代码: ",[30,3470,3473],{"href":3471,"rel":3472},"https://github.com/zhullyb/ZJUT-Mi-Schedule-Adapter/",[41],"Github",[948,3475,3476],{"id":3476},"运行原理",[20,3478,3479],{},"小爱课表获取课表信息的大致流程如下",[988,3481,3482,3485,3488],{},[991,3483,3484],{},"在你的手机上调用系统 webview 进入你指定的教务系统，让你手动输入账号密码并完成登陆流程",[991,3486,3487],{},"获取含有课表信息的字符串（可以是直接获取页面展示的 html 代码，也可以是利用登陆时获取的 cookie/session 信息直接向后端发送请求拿响应）",[991,3489,3490],{},"解析获取到的字符串，按照小米预先定义好的 json 格式输出",[20,3492,3493,3494,3497,3498,3501,3502],{},"作为适配者，我们需要提供三个代码文件，分别是 ",[60,3495,3496],{},"Provider","、",[60,3499,3500],{},"Parser"," 和 ",[60,3503,3504],{},"Timer",[20,3506,3507,3501,3509,3511],{},[60,3508,3496],{},[60,3510,3504],{}," 都在本地登陆好教务系统后的 webview 环境中执行，前者需要返回步骤 2 中描述的带有课表信息的字符串，Timer 则返回课程时间、学期周数等信息。",[20,3513,3514,3516,3517,3519,3520,3525],{},[60,3515,3496],{}," 获取到的字符串将会成为 ",[60,3518,3500],{}," 的函数参数，这个函数将会上传到小米的服务器中运行，根据文档所说是为了满足部分开发者保护自己的代码防止被抓包而刻意设计的（虽然我不理解这种东西有什么好闭源的，",[86,3521,3524],{"className":3522},[3523],"heimu","可能是为了防止友商批量抓包获取解析算法以后直接推出竞品","）。",[948,3527,3528],{"id":3528},"适配实战",[1682,3530,3531],{"id":3531},"安装浏览器插件",[20,3533,3534,3535,3540],{},"首先下载小米提供给我们的资源包，目前我拿到的最新的版本是 v0.3.8，",[30,3536,3539],{"href":3537,"rel":3538},"https://open-schedule-prod.ai.xiaomi.com/docs/#/help/?id=%e4%b8%8b%e8%bd%bd",[41],"下载链接","。注意不要被后缀骗了，这不是个 rar 包，我这里后缀改成 tar 后可以被 ark 正确解压，后缀名是 rar 可能是开发者希望 Windows 用户能用 winrar 进行解压？",[20,3542,3543],{},"这里需要一个 Chromium-based 的浏览器安装小米提供的浏览器插件。",[20,3545,3546],{},"然后使用 Chrome 的「加载已解压的扩展程序」安装整个被解压的目录。Chrome 安装后提示 Manifest version 2 将会在 2024 年被弃用，不知道小米能不能在 Chrome 弃用前支持 Manifest version 3，趁着能用我先不管它。",[20,3548,3549],{},[67,3550],{"alt":69,"src":3551},"https://static.031130.xyz/uploads/2024/11/18/f2a063c982a42.webp",[20,3553,3554],{},"随后打开自己学校的教务网站，F12 打开开发者工具，可以看到多了一栏叫「AISchedule」的选项",[20,3556,3557],{},[67,3558],{"alt":69,"src":3559},"https://static.031130.xyz/uploads/2024/11/18/800054d7f4ff8.webp",[20,3561,3562],{},"随后正常登陆自己的小米账号，放一旁备用。",[1682,3564,3565],{"id":3565},"抓数据包",[20,3567,3568],{},"随后，登陆自己的教务网站，打开课表页面，查看 F12 开发者工具的网络一览，刷新页面加载自己的课表，查看开发者页面中显示的数据流，找到含有课表信息的那一个。",[20,3570,3571],{},"这个流程我个人用惯了 Firefox 浏览器，因此数据分析这一块的截图都是 Firefox 的截图。",[20,3573,3574],{},[67,3575],{"alt":69,"src":3576},"https://static.031130.xyz/uploads/2024/11/18/7ea6e1e0bbfcf.webp",[20,3578,3579],{},"在我的例子中，第一个请求的响应是一个 html 页面，勾勒出了这个页面的大致轮廓，不过没有样式。这是一个好的迹象，说明这大概率是一个前后端分离的站点，授课数据很可能是通过 json 的数据单独传递给前端的，我们就不需要从 html 中解析我们的课表。",[20,3581,3582],{},"如果能确定是前后端分离的站点，我们可以尝试勾选这里的「XHR」选项，XHR 的全名是 XMLHttpRequest，是一种前端向后端发起请求的方式，前后端的数据一般都会在这里展示。",[20,3584,3585],{},[67,3586],{"alt":69,"src":3587},"https://static.031130.xyz/uploads/2024/11/18/36880519d2109.webp",[20,3589,3590,3591,3593],{},"我在第三个请求中发现了我的课表信息，在已经登陆的情况下，小米的课程表允许我通过 fetch 函数打一个相同的请求给后端，获取这个响应结果作为 ",[60,3592,3496],{}," 部分的输出字符串。",[1682,3595,3597],{"id":3596},"调试-fetch-参数","调试 fetch 参数",[20,3599,3600],{},"这个请求的 fetch 函数如何构建？可以直接右键这个请求，在菜单中选择「复制为 Fetch 语句」",[20,3602,3603],{},[67,3604],{"alt":69,"src":3605},"https://static.031130.xyz/uploads/2024/11/18/ff498f0a0957e.webp",[20,3607,3608],{},"复制下来的语句长下面这个样子",[78,3610,3612],{"className":80,"code":3611,"language":82,"meta":69,"style":69},"await fetch(\"http://www.gdjw.zjut.edu.cn/jwglxt/kbcx/xskbcx_cxXsgrkb.html?gnmkdm=N2151\", {\n    \"credentials\": \"include\",\n    \"headers\": {\n        \"User-Agent\": \"Mozilla/5.0 (X11; Linux x86_64; rv:133.0) Gecko/20100101 Firefox/133.0\",\n        \"Accept\": \"*/*\",\n        \"Accept-Language\": \"zh-CN,zh;q=0.8,zh-TW;q=0.7,zh-HK;q=0.5,en-US;q=0.3,en;q=0.2\",\n        \"Content-Type\": \"application/x-www-form-urlencoded;charset=utf-8\",\n        \"X-Requested-With\": \"XMLHttpRequest\"\n    },\n    \"referrer\": \"http://www.gdjw.zjut.edu.cn/jwglxt/kbcx/xskbcx_cxXskbcxIndex.html?gnmkdm=N2151&layout=default\",\n    \"body\": \"xnm=2024&xqm=3&kzlx=ck&xsdm=\",\n    \"method\": \"POST\",\n    \"mode\": \"cors\"\n});\n",[60,3613,3614,3627,3639,3648,3660,3672,3684,3696,3706,3710,3722,3734,3745,3755],{"__ignoreMap":69},[86,3615,3616,3618,3620,3622,3625],{"class":88,"line":89},[86,3617,2413],{"class":92},[86,3619,245],{"class":99},[86,3621,166],{"class":103},[86,3623,3624],{"class":121},"\"http://www.gdjw.zjut.edu.cn/jwglxt/kbcx/xskbcx_cxXsgrkb.html?gnmkdm=N2151\"",[86,3626,452],{"class":103},[86,3628,3629,3632,3634,3637],{"class":88,"line":107},[86,3630,3631],{"class":121},"    \"credentials\"",[86,3633,398],{"class":397},[86,3635,3636],{"class":121}," \"include\"",[86,3638,404],{"class":103},[86,3640,3641,3644,3646],{"class":88,"line":128},[86,3642,3643],{"class":121},"    \"headers\"",[86,3645,398],{"class":397},[86,3647,389],{"class":103},[86,3649,3650,3653,3655,3658],{"class":88,"line":143},[86,3651,3652],{"class":121},"        \"User-Agent\"",[86,3654,398],{"class":397},[86,3656,3657],{"class":121}," \"Mozilla/5.0 (X11; Linux x86_64; rv:133.0) Gecko/20100101 Firefox/133.0\"",[86,3659,404],{"class":103},[86,3661,3662,3665,3667,3670],{"class":88,"line":150},[86,3663,3664],{"class":121},"        \"Accept\"",[86,3666,398],{"class":397},[86,3668,3669],{"class":121}," \"*/*\"",[86,3671,404],{"class":103},[86,3673,3674,3677,3679,3682],{"class":88,"line":3},[86,3675,3676],{"class":121},"        \"Accept-Language\"",[86,3678,398],{"class":397},[86,3680,3681],{"class":121}," \"zh-CN,zh;q=0.8,zh-TW;q=0.7,zh-HK;q=0.5,en-US;q=0.3,en;q=0.2\"",[86,3683,404],{"class":103},[86,3685,3686,3689,3691,3694],{"class":88,"line":207},[86,3687,3688],{"class":121},"        \"Content-Type\"",[86,3690,398],{"class":397},[86,3692,3693],{"class":121}," \"application/x-www-form-urlencoded;charset=utf-8\"",[86,3695,404],{"class":103},[86,3697,3698,3701,3703],{"class":88,"line":232},[86,3699,3700],{"class":121},"        \"X-Requested-With\"",[86,3702,398],{"class":397},[86,3704,3705],{"class":121}," \"XMLHttpRequest\"\n",[86,3707,3708],{"class":88,"line":255},[86,3709,605],{"class":103},[86,3711,3712,3715,3717,3720],{"class":88,"line":277},[86,3713,3714],{"class":121},"    \"referrer\"",[86,3716,398],{"class":397},[86,3718,3719],{"class":121}," \"http://www.gdjw.zjut.edu.cn/jwglxt/kbcx/xskbcx_cxXskbcxIndex.html?gnmkdm=N2151&layout=default\"",[86,3721,404],{"class":103},[86,3723,3724,3727,3729,3732],{"class":88,"line":304},[86,3725,3726],{"class":121},"    \"body\"",[86,3728,398],{"class":397},[86,3730,3731],{"class":121}," \"xnm=2024&xqm=3&kzlx=ck&xsdm=\"",[86,3733,404],{"class":103},[86,3735,3736,3739,3741,3743],{"class":88,"line":322},[86,3737,3738],{"class":121},"    \"method\"",[86,3740,398],{"class":397},[86,3742,462],{"class":121},[86,3744,404],{"class":103},[86,3746,3747,3750,3752],{"class":88,"line":328},[86,3748,3749],{"class":121},"    \"mode\"",[86,3751,398],{"class":397},[86,3753,3754],{"class":121}," \"cors\"\n",[86,3756,3757],{"class":88,"line":337},[86,3758,3759],{"class":103},"});\n",[20,3761,3762],{},"先看 body 部分",[2935,3764,3765,3768,3771],{},[991,3766,3767],{},"xnm=2024 很明显是年份的意思",[991,3769,3770],{},"xqm 表示学期，这个通过多次尝试获取不同学期的课表可以得出结果，3 表示第一学期，12 表示第二学期，16 表示第三学期（短学期）",[991,3772,3773],{},"其余的参数我不关心，一模一样带上就行",[20,3775,3776],{},"这个函数是可以直接放在 F12 开发者工具的控制台中运行的，通过在 fetch 函数的尾部（分号前）添加一个回调函数就可以打印出函数获取的结果。",[78,3778,3780],{"className":80,"code":3779,"language":82,"meta":69,"style":69},"await fetch(...).then(response => response.json())\n",[60,3781,3782],{"__ignoreMap":69},[86,3783,3784,3786,3788,3790,3792,3794,3796,3798,3800,3802,3804,3806,3808],{"class":88,"line":89},[86,3785,2413],{"class":92},[86,3787,245],{"class":99},[86,3789,166],{"class":103},[86,3791,2706],{"class":397},[86,3793,1511],{"class":103},[86,3795,2683],{"class":99},[86,3797,166],{"class":103},[86,3799,532],{"class":362},[86,3801,1770],{"class":92},[86,3803,237],{"class":177},[86,3805,181],{"class":103},[86,3807,271],{"class":99},[86,3809,3810],{"class":103},"())\n",[20,3812,3813],{},"这就允许我们去尝试是否可以删减一些 fetch 函数的参数，获得相同的结果。",[20,3815,3816],{},"如删除 headers 中的 User-Agent、删除 referer 等等，我最后精简了一些参数，fetch 函数长这个样子。",[78,3818,3820],{"className":80,"code":3819,"language":82,"meta":69,"style":69},"await fetch(\"http://www.gdjw.zjut.edu.cn/jwglxt/kbcx/xskbcx_cxXsgrkb.html?gnmkdm=N2151\", {\n    \"credentials\": \"include\",\n    \"headers\": {\n        \"Accept\": \"*/*\",\n        \"Content-Type\": \"application/x-www-form-urlencoded;charset=utf-8\",\n        \"X-Requested-With\": \"XMLHttpRequest\"\n    },\n    \"body\": \"xnm=2024&xqm=3&kzlx=ck&xsdm=\",\n    \"method\": \"POST\",\n    \"mode\": \"cors\"\n});\n",[60,3821,3822,3834,3844,3852,3862,3872,3880,3884,3894,3904,3912],{"__ignoreMap":69},[86,3823,3824,3826,3828,3830,3832],{"class":88,"line":89},[86,3825,2413],{"class":92},[86,3827,245],{"class":99},[86,3829,166],{"class":103},[86,3831,3624],{"class":121},[86,3833,452],{"class":103},[86,3835,3836,3838,3840,3842],{"class":88,"line":107},[86,3837,3631],{"class":121},[86,3839,398],{"class":397},[86,3841,3636],{"class":121},[86,3843,404],{"class":103},[86,3845,3846,3848,3850],{"class":88,"line":128},[86,3847,3643],{"class":121},[86,3849,398],{"class":397},[86,3851,389],{"class":103},[86,3853,3854,3856,3858,3860],{"class":88,"line":143},[86,3855,3664],{"class":121},[86,3857,398],{"class":397},[86,3859,3669],{"class":121},[86,3861,404],{"class":103},[86,3863,3864,3866,3868,3870],{"class":88,"line":150},[86,3865,3688],{"class":121},[86,3867,398],{"class":397},[86,3869,3693],{"class":121},[86,3871,404],{"class":103},[86,3873,3874,3876,3878],{"class":88,"line":3},[86,3875,3700],{"class":121},[86,3877,398],{"class":397},[86,3879,3705],{"class":121},[86,3881,3882],{"class":88,"line":207},[86,3883,605],{"class":103},[86,3885,3886,3888,3890,3892],{"class":88,"line":232},[86,3887,3726],{"class":121},[86,3889,398],{"class":397},[86,3891,3731],{"class":121},[86,3893,404],{"class":103},[86,3895,3896,3898,3900,3902],{"class":88,"line":255},[86,3897,3738],{"class":121},[86,3899,398],{"class":397},[86,3901,462],{"class":121},[86,3903,404],{"class":103},[86,3905,3906,3908,3910],{"class":88,"line":277},[86,3907,3749],{"class":121},[86,3909,398],{"class":397},[86,3911,3754],{"class":121},[86,3913,3914],{"class":88,"line":304},[86,3915,3759],{"class":103},[20,3917,3918],{},"现在，将 fetch 函数自身和其执行后获取的结果复制下来保存到本地备用，我们就可以开始写代码了。",[1682,3920,3921],{"id":3921},"安装依赖",[20,3923,3924],{},"在刚刚的压缩包解压出来的目录中，有一个叫 localTools 的文件夹，我们可以把它复制到自己的工作目录下，我们的代码工作主要就是在那里进行。",[20,3926,3927,3928,3931],{},"打开 VSCode，命令行运行 ",[60,3929,3930],{},"pnpm i"," 安装其运行时的依赖，顺便截图给你们看一眼目录结构。",[20,3933,3934],{},[67,3935],{"alt":69,"src":3936},"https://static.031130.xyz/uploads/2024/11/18/d8316deee7e50.webp",[1682,3938,3940],{"id":3939},"编写-provider","编写 provider",[20,3942,3943,3944],{},"首先编写 ",[60,3945,3946],{},"code/provider.js",[20,3948,3949],{},"在这个文件中，我们需要执行 fetch 函数，return 其获取到的 json 数据。",[20,3951,3952,3953],{},"按照官方文档，先 ",[60,3954,3955],{},"loadTool",[78,3957,3959],{"className":80,"code":3958,"language":82,"meta":69,"style":69},"await loadTool('AIScheduleTools')\n",[60,3960,3961],{"__ignoreMap":69},[86,3962,3963,3965,3968,3970,3973],{"class":88,"line":89},[86,3964,2413],{"class":92},[86,3966,3967],{"class":99}," loadTool",[86,3969,166],{"class":103},[86,3971,3972],{"class":121},"'AIScheduleTools'",[86,3974,172],{"class":103},[20,3976,3977,3978,3981],{},"随后，我选择使用 ",[60,3979,3980],{},"AISchedulePrompt"," 这个小米封装的工具让用户手动输入需要导入课表的学年和学期信息，并对输入数据进行简单校验。",[78,3983,3985],{"className":80,"code":3984,"language":82,"meta":69,"style":69},"const year = await AISchedulePrompt({\n  titleText: '学年',\n  tipText: '请输入本学年开始的年份',\n  defaultText: '2024',\n  validator: value => {\n    try {\n      const v = parseInt(value)\n      if (v \u003C 2000 || v > 2100) {\n        return '请输入正确的学年'\n      }\n      return false\n    } catch (error) {\n      return '请输入正确的学年'\n    }\n  }\n})\n\nconst term = await AISchedulePrompt({\n  titleText: '学期',\n  tipText: '请输入本学期的学期(1,2,3 分别表示上、下、短学期)',\n  defaultText: '1',\n  validator: value => {\n    if (value === '1' || value === '2' || value === '3') {\n      return false\n    }\n    return '请输入正确的学期'\n  }\n})\n\nconst xqm = {\n  '1': '3',\n  '2': '12',\n  '3': '16',\n}[term]\n",[60,3986,3987,4004,4016,4028,4040,4054,4061,4080,4107,4114,4119,4126,4141,4147,4151,4155,4159,4163,4178,4189,4200,4211,4223,4255,4261,4265,4272,4276,4280,4284,4295,4306,4318,4330],{"__ignoreMap":69},[86,3988,3989,3991,3994,3996,3998,4001],{"class":88,"line":89},[86,3990,676],{"class":92},[86,3992,3993],{"class":113}," year",[86,3995,118],{"class":117},[86,3997,242],{"class":92},[86,3999,4000],{"class":99}," AISchedulePrompt",[86,4002,4003],{"class":103},"({\n",[86,4005,4006,4009,4011,4014],{"class":88,"line":107},[86,4007,4008],{"class":291},"  titleText",[86,4010,398],{"class":397},[86,4012,4013],{"class":121}," '学年'",[86,4015,404],{"class":103},[86,4017,4018,4021,4023,4026],{"class":88,"line":128},[86,4019,4020],{"class":291},"  tipText",[86,4022,398],{"class":397},[86,4024,4025],{"class":121}," '请输入本学年开始的年份'",[86,4027,404],{"class":103},[86,4029,4030,4033,4035,4038],{"class":88,"line":143},[86,4031,4032],{"class":291},"  defaultText",[86,4034,398],{"class":397},[86,4036,4037],{"class":121}," '2024'",[86,4039,404],{"class":103},[86,4041,4042,4045,4047,4050,4052],{"class":88,"line":150},[86,4043,4044],{"class":99},"  validator",[86,4046,398],{"class":397},[86,4048,4049],{"class":362}," value",[86,4051,1770],{"class":92},[86,4053,389],{"class":103},[86,4055,4056,4059],{"class":88,"line":3},[86,4057,4058],{"class":92},"    try",[86,4060,389],{"class":103},[86,4062,4063,4066,4068,4070,4073,4075,4078],{"class":88,"line":207},[86,4064,4065],{"class":92},"      const",[86,4067,2826],{"class":113},[86,4069,118],{"class":117},[86,4071,4072],{"class":99}," parseInt",[86,4074,166],{"class":103},[86,4076,4077],{"class":201},"value",[86,4079,172],{"class":103},[86,4081,4082,4085,4087,4089,4092,4095,4098,4100,4102,4105],{"class":88,"line":232},[86,4083,4084],{"class":92},"      if",[86,4086,283],{"class":103},[86,4088,2853],{"class":201},[86,4090,4091],{"class":117}," \u003C",[86,4093,4094],{"class":816}," 2000",[86,4096,4097],{"class":117}," ||",[86,4099,2826],{"class":201},[86,4101,813],{"class":117},[86,4103,4104],{"class":816}," 2100",[86,4106,301],{"class":103},[86,4108,4109,4111],{"class":88,"line":255},[86,4110,2500],{"class":92},[86,4112,4113],{"class":121}," '请输入正确的学年'\n",[86,4115,4116],{"class":88,"line":277},[86,4117,4118],{"class":103},"      }\n",[86,4120,4121,4123],{"class":88,"line":304},[86,4122,587],{"class":92},[86,4124,4125],{"class":816}," false\n",[86,4127,4128,4131,4134,4136,4139],{"class":88,"line":322},[86,4129,4130],{"class":103},"    } ",[86,4132,4133],{"class":92},"catch",[86,4135,283],{"class":103},[86,4137,4138],{"class":201},"error",[86,4140,301],{"class":103},[86,4142,4143,4145],{"class":88,"line":328},[86,4144,587],{"class":92},[86,4146,4113],{"class":121},[86,4148,4149],{"class":88,"line":337},[86,4150,325],{"class":103},[86,4152,4153],{"class":88,"line":513},[86,4154,1977],{"class":103},[86,4156,4157],{"class":88,"line":519},[86,4158,1982],{"class":103},[86,4160,4161],{"class":88,"line":537},[86,4162,147],{"emptyLinePlaceholder":146},[86,4164,4165,4167,4170,4172,4174,4176],{"class":88,"line":792},[86,4166,676],{"class":92},[86,4168,4169],{"class":113}," term",[86,4171,118],{"class":117},[86,4173,242],{"class":92},[86,4175,4000],{"class":99},[86,4177,4003],{"class":103},[86,4179,4180,4182,4184,4187],{"class":88,"line":797},[86,4181,4008],{"class":291},[86,4183,398],{"class":397},[86,4185,4186],{"class":121}," '学期'",[86,4188,404],{"class":103},[86,4190,4191,4193,4195,4198],{"class":88,"line":822},[86,4192,4020],{"class":291},[86,4194,398],{"class":397},[86,4196,4197],{"class":121}," '请输入本学期的学期(1,2,3 分别表示上、下、短学期)'",[86,4199,404],{"class":103},[86,4201,4202,4204,4206,4209],{"class":88,"line":871},[86,4203,4032],{"class":291},[86,4205,398],{"class":397},[86,4207,4208],{"class":121}," '1'",[86,4210,404],{"class":103},[86,4212,4213,4215,4217,4219,4221],{"class":88,"line":882},[86,4214,4044],{"class":99},[86,4216,398],{"class":397},[86,4218,4049],{"class":362},[86,4220,1770],{"class":92},[86,4222,389],{"class":103},[86,4224,4225,4227,4229,4231,4233,4235,4237,4239,4241,4244,4246,4248,4250,4253],{"class":88,"line":899},[86,4226,280],{"class":92},[86,4228,283],{"class":103},[86,4230,4077],{"class":201},[86,4232,1816],{"class":117},[86,4234,4208],{"class":121},[86,4236,4097],{"class":117},[86,4238,4049],{"class":201},[86,4240,1816],{"class":117},[86,4242,4243],{"class":121}," '2'",[86,4245,4097],{"class":117},[86,4247,4049],{"class":201},[86,4249,1816],{"class":117},[86,4251,4252],{"class":121}," '3'",[86,4254,301],{"class":103},[86,4256,4257,4259],{"class":88,"line":904},[86,4258,587],{"class":92},[86,4260,4125],{"class":816},[86,4262,4263],{"class":88,"line":909},[86,4264,325],{"class":103},[86,4266,4267,4269],{"class":88,"line":2259},[86,4268,331],{"class":92},[86,4270,4271],{"class":121}," '请输入正确的学期'\n",[86,4273,4274],{"class":88,"line":2264},[86,4275,1977],{"class":103},[86,4277,4278],{"class":88,"line":2269},[86,4279,1982],{"class":103},[86,4281,4282],{"class":88,"line":2274},[86,4283,147],{"emptyLinePlaceholder":146},[86,4285,4286,4288,4291,4293],{"class":88,"line":2279},[86,4287,676],{"class":92},[86,4289,4290],{"class":113}," xqm",[86,4292,118],{"class":117},[86,4294,389],{"class":103},[86,4296,4297,4300,4302,4304],{"class":88,"line":2285},[86,4298,4299],{"class":121},"  '1'",[86,4301,398],{"class":397},[86,4303,4252],{"class":121},[86,4305,404],{"class":103},[86,4307,4308,4311,4313,4316],{"class":88,"line":2291},[86,4309,4310],{"class":121},"  '2'",[86,4312,398],{"class":397},[86,4314,4315],{"class":121}," '12'",[86,4317,404],{"class":103},[86,4319,4320,4323,4325,4328],{"class":88,"line":2296},[86,4321,4322],{"class":121},"  '3'",[86,4324,398],{"class":397},[86,4326,4327],{"class":121}," '16'",[86,4329,404],{"class":103},[86,4331,4332,4335,4338],{"class":88,"line":2310},[86,4333,4334],{"class":103},"}[",[86,4336,4337],{"class":201},"term",[86,4339,4340],{"class":103},"]\n",[20,4342,4343],{},"随后将学年和学期信息拼入 fetch 函数，打出请求，并将返回的 json 数据转为 string 作为函数的返回值",[78,4345,4347],{"className":80,"code":4346,"language":82,"meta":69,"style":69},"const res = await fetch(\"http://www.gdjw.zjut.edu.cn/jwglxt/kbcx/xskbcx_cxXsgrkb.html?gnmkdm=N2151\", {\n  \"headers\": {\n    \"accept\": \"*/*\",\n    \"content-type\": \"application/x-www-form-urlencoded;charset=UTF-8\",\n    \"x-requested-with\": \"XMLHttpRequest\"\n  },\n  \"referrerPolicy\": \"strict-origin-when-cross-origin\",\n  \"body\": `xnm=${year}&xqm=${xqm}&kzlx=ck&xsdm=`,\n  \"method\": \"POST\",\n  \"mode\": \"cors\",\n  \"credentials\": \"include\"\n})\n\nconst ret = await res.json()\nreturn JSON.stringify(ret.kbList)\n",[60,4348,4349,4367,4376,4387,4399,4408,4413,4425,4457,4468,4480,4490,4494,4498,4517],{"__ignoreMap":69},[86,4350,4351,4353,4355,4357,4359,4361,4363,4365],{"class":88,"line":89},[86,4352,676],{"class":92},[86,4354,1486],{"class":113},[86,4356,118],{"class":117},[86,4358,242],{"class":92},[86,4360,245],{"class":99},[86,4362,166],{"class":103},[86,4364,3624],{"class":121},[86,4366,452],{"class":103},[86,4368,4369,4372,4374],{"class":88,"line":107},[86,4370,4371],{"class":121},"  \"headers\"",[86,4373,398],{"class":397},[86,4375,389],{"class":103},[86,4377,4378,4381,4383,4385],{"class":88,"line":128},[86,4379,4380],{"class":121},"    \"accept\"",[86,4382,398],{"class":397},[86,4384,3669],{"class":121},[86,4386,404],{"class":103},[86,4388,4389,4392,4394,4397],{"class":88,"line":143},[86,4390,4391],{"class":121},"    \"content-type\"",[86,4393,398],{"class":397},[86,4395,4396],{"class":121}," \"application/x-www-form-urlencoded;charset=UTF-8\"",[86,4398,404],{"class":103},[86,4400,4401,4404,4406],{"class":88,"line":150},[86,4402,4403],{"class":121},"    \"x-requested-with\"",[86,4405,398],{"class":397},[86,4407,3705],{"class":121},[86,4409,4410],{"class":88,"line":3},[86,4411,4412],{"class":103},"  },\n",[86,4414,4415,4418,4420,4423],{"class":88,"line":207},[86,4416,4417],{"class":121},"  \"referrerPolicy\"",[86,4419,398],{"class":397},[86,4421,4422],{"class":121}," \"strict-origin-when-cross-origin\"",[86,4424,404],{"class":103},[86,4426,4427,4430,4432,4435,4437,4440,4442,4445,4447,4450,4452,4455],{"class":88,"line":232},[86,4428,4429],{"class":121},"  \"body\"",[86,4431,398],{"class":397},[86,4433,4434],{"class":121}," `xnm=",[86,4436,839],{"class":838},[86,4438,4439],{"class":201},"year",[86,4441,863],{"class":838},[86,4443,4444],{"class":121},"&xqm=",[86,4446,839],{"class":838},[86,4448,4449],{"class":201},"xqm",[86,4451,863],{"class":838},[86,4453,4454],{"class":121},"&kzlx=ck&xsdm=`",[86,4456,404],{"class":103},[86,4458,4459,4462,4464,4466],{"class":88,"line":255},[86,4460,4461],{"class":121},"  \"method\"",[86,4463,398],{"class":397},[86,4465,462],{"class":121},[86,4467,404],{"class":103},[86,4469,4470,4473,4475,4478],{"class":88,"line":277},[86,4471,4472],{"class":121},"  \"mode\"",[86,4474,398],{"class":397},[86,4476,4477],{"class":121}," \"cors\"",[86,4479,404],{"class":103},[86,4481,4482,4485,4487],{"class":88,"line":304},[86,4483,4484],{"class":121},"  \"credentials\"",[86,4486,398],{"class":397},[86,4488,4489],{"class":121}," \"include\"\n",[86,4491,4492],{"class":88,"line":322},[86,4493,1982],{"class":103},[86,4495,4496],{"class":88,"line":328},[86,4497,147],{"emptyLinePlaceholder":146},[86,4499,4500,4502,4505,4507,4509,4511,4513,4515],{"class":88,"line":337},[86,4501,676],{"class":92},[86,4503,4504],{"class":113}," ret",[86,4506,118],{"class":117},[86,4508,242],{"class":92},[86,4510,1486],{"class":177},[86,4512,181],{"class":103},[86,4514,271],{"class":99},[86,4516,274],{"class":103},[86,4518,4519,4522,4524,4526,4528,4530,4533,4535,4538],{"class":88,"line":513},[86,4520,4521],{"class":92},"return",[86,4523,498],{"class":113},[86,4525,181],{"class":103},[86,4527,503],{"class":99},[86,4529,166],{"class":103},[86,4531,4532],{"class":177},"ret",[86,4534,181],{"class":103},[86,4536,4537],{"class":291},"kbList",[86,4539,172],{"class":103},[20,4541,4542],{},"最外层使用 try-catch 做简单的异常处理，如果出错就让用户确认是否正确登陆了教务系统",[78,4544,4546],{"className":80,"code":4545,"language":82,"meta":69,"style":69},"async function scheduleHtmlProvider() {\n  await loadTool('AIScheduleTools')\n  try {\n    //...\n  } catch (error) {\n    await AIScheduleAlert('请确定你已经登陆了教务系统')\n    return 'do not continue'\n  }\n}\n",[60,4547,4548,4559,4572,4579,4584,4596,4610,4617,4621],{"__ignoreMap":69},[86,4549,4550,4552,4554,4557],{"class":88,"line":89},[86,4551,93],{"class":92},[86,4553,96],{"class":92},[86,4555,4556],{"class":99}," scheduleHtmlProvider",[86,4558,104],{"class":103},[86,4560,4561,4564,4566,4568,4570],{"class":88,"line":107},[86,4562,4563],{"class":92},"  await",[86,4565,3967],{"class":99},[86,4567,166],{"class":103},[86,4569,3972],{"class":121},[86,4571,172],{"class":103},[86,4573,4574,4577],{"class":88,"line":128},[86,4575,4576],{"class":92},"  try",[86,4578,389],{"class":103},[86,4580,4581],{"class":88,"line":143},[86,4582,4583],{"class":1714},"    //...\n",[86,4585,4586,4588,4590,4592,4594],{"class":88,"line":150},[86,4587,1847],{"class":103},[86,4589,4133],{"class":92},[86,4591,283],{"class":103},[86,4593,4138],{"class":201},[86,4595,301],{"class":103},[86,4597,4598,4600,4603,4605,4608],{"class":88,"line":3},[86,4599,2242],{"class":92},[86,4601,4602],{"class":99}," AIScheduleAlert",[86,4604,166],{"class":103},[86,4606,4607],{"class":121},"'请确定你已经登陆了教务系统'",[86,4609,172],{"class":103},[86,4611,4612,4614],{"class":88,"line":207},[86,4613,331],{"class":92},[86,4615,4616],{"class":121}," 'do not continue'\n",[86,4618,4619],{"class":88,"line":232},[86,4620,1977],{"class":103},[86,4622,4623],{"class":88,"line":255},[86,4624,340],{"class":103},[1682,4626,4628],{"id":4627},"编写-parser","编写 parser",[20,4630,4631],{},"官方文档对 parser 函数做了明确的规范，格式如下",[78,4633,4636],{"className":4634,"code":4635,"language":271,"meta":69,"style":69},"language-json shiki shiki-themes one-light one-dark-pro","[\n  {\n    name: \"数学\", // 课程名称\n    position: \"教学楼1\", // 上课地点\n    teacher: \"张三\", // 教师名称\n    weeks: [1, 2, 3, 4], // 周数\n    day: 3, // 星期\n    sections: [1, 2, 3], // 节次\n  },{\n    name: \"数学\",\n    position: \"教学楼1\",\n    teacher: \"张三\",\n    weeks: [1, 2, 3, 4],\n    day: 1,\n    sections: [1, 2, 3],\n  },\n]\n",[60,4637,4638,4643,4648,4665,4680,4695,4726,4740,4762,4767,4777,4787,4797,4820,4830,4848,4852],{"__ignoreMap":69},[86,4639,4640],{"class":88,"line":89},[86,4641,4642],{"class":103},"[\n",[86,4644,4645],{"class":88,"line":107},[86,4646,4647],{"class":103},"  {\n",[86,4649,4650,4654,4657,4660,4662],{"class":88,"line":128},[86,4651,4653],{"class":4652},"sUNH4","    name",[86,4655,4656],{"class":103},": ",[86,4658,4659],{"class":121},"\"数学\"",[86,4661,198],{"class":103},[86,4663,4664],{"class":1714},"// 课程名称\n",[86,4666,4667,4670,4672,4675,4677],{"class":88,"line":143},[86,4668,4669],{"class":4652},"    position",[86,4671,4656],{"class":103},[86,4673,4674],{"class":121},"\"教学楼1\"",[86,4676,198],{"class":103},[86,4678,4679],{"class":1714},"// 上课地点\n",[86,4681,4682,4685,4687,4690,4692],{"class":88,"line":150},[86,4683,4684],{"class":4652},"    teacher",[86,4686,4656],{"class":103},[86,4688,4689],{"class":121},"\"张三\"",[86,4691,198],{"class":103},[86,4693,4694],{"class":1714},"// 教师名称\n",[86,4696,4697,4700,4703,4705,4707,4710,4712,4715,4717,4720,4723],{"class":88,"line":3},[86,4698,4699],{"class":4652},"    weeks",[86,4701,4702],{"class":103},": [",[86,4704,1376],{"class":816},[86,4706,198],{"class":103},[86,4708,4709],{"class":816},"2",[86,4711,198],{"class":103},[86,4713,4714],{"class":816},"3",[86,4716,198],{"class":103},[86,4718,4719],{"class":816},"4",[86,4721,4722],{"class":103},"], ",[86,4724,4725],{"class":1714},"// 周数\n",[86,4727,4728,4731,4733,4735,4737],{"class":88,"line":207},[86,4729,4730],{"class":4652},"    day",[86,4732,4656],{"class":103},[86,4734,4714],{"class":816},[86,4736,198],{"class":103},[86,4738,4739],{"class":1714},"// 星期\n",[86,4741,4742,4745,4747,4749,4751,4753,4755,4757,4759],{"class":88,"line":232},[86,4743,4744],{"class":4652},"    sections",[86,4746,4702],{"class":103},[86,4748,1376],{"class":816},[86,4750,198],{"class":103},[86,4752,4709],{"class":816},[86,4754,198],{"class":103},[86,4756,4714],{"class":816},[86,4758,4722],{"class":103},[86,4760,4761],{"class":1714},"// 节次\n",[86,4763,4764],{"class":88,"line":255},[86,4765,4766],{"class":103},"  },{\n",[86,4768,4769,4771,4773,4775],{"class":88,"line":277},[86,4770,4653],{"class":4652},[86,4772,4656],{"class":103},[86,4774,4659],{"class":121},[86,4776,404],{"class":103},[86,4778,4779,4781,4783,4785],{"class":88,"line":304},[86,4780,4669],{"class":4652},[86,4782,4656],{"class":103},[86,4784,4674],{"class":121},[86,4786,404],{"class":103},[86,4788,4789,4791,4793,4795],{"class":88,"line":322},[86,4790,4684],{"class":4652},[86,4792,4656],{"class":103},[86,4794,4689],{"class":121},[86,4796,404],{"class":103},[86,4798,4799,4801,4803,4805,4807,4809,4811,4813,4815,4817],{"class":88,"line":328},[86,4800,4699],{"class":4652},[86,4802,4702],{"class":103},[86,4804,1376],{"class":816},[86,4806,198],{"class":103},[86,4808,4709],{"class":816},[86,4810,198],{"class":103},[86,4812,4714],{"class":816},[86,4814,198],{"class":103},[86,4816,4719],{"class":816},[86,4818,4819],{"class":103},"],\n",[86,4821,4822,4824,4826,4828],{"class":88,"line":337},[86,4823,4730],{"class":4652},[86,4825,4656],{"class":103},[86,4827,1376],{"class":816},[86,4829,404],{"class":103},[86,4831,4832,4834,4836,4838,4840,4842,4844,4846],{"class":88,"line":513},[86,4833,4744],{"class":4652},[86,4835,4702],{"class":103},[86,4837,1376],{"class":816},[86,4839,198],{"class":103},[86,4841,4709],{"class":816},[86,4843,198],{"class":103},[86,4845,4714],{"class":816},[86,4847,4819],{"class":103},[86,4849,4850],{"class":88,"line":519},[86,4851,4412],{"class":103},[86,4853,4854],{"class":88,"line":537},[86,4855,4340],{"class":103},[20,4857,4858],{},"最外层是一个 array，里面包含若干个 object，每个 object 表示一节课",[17,4860,4861,4868,4873,4878,4889,4899],{},[20,4862,4863,4864,4867],{},"课程名称：",[60,4865,4866],{},"String"," 长度50字节（一汉字两字节）",[20,4869,4870,4871,4867],{},"上课地点：",[60,4872,4866],{},[20,4874,4875,4876,4867],{},"教师名称：",[60,4877,4866],{},[20,4879,4880,4881,4884,4885,4888],{},"周数：",[60,4882,4883],{},"Number[]"," ",[86,4886,4887],{},"1，30"," 之间的整数 超出会被裁掉",[20,4890,4891,4892,4884,4895,4898],{},"星期：",[60,4893,4894],{},"Number",[86,4896,4897],{},"1，7"," 之间的整数",[20,4900,4901,4902,4884,4904,4906,4907,4910],{},"节次：",[60,4903,4894],{},[86,4905,4887],{}," 之间的整数 (默认",[86,4908,4909],{},"1，12",") 根据后续时间设置自动裁剪",[20,4912,4913],{},"（只有这节课的星期几、上课地点、上课时间都一致才算一节课。比如我一周上两节算法课，周一 34 节和周三 56，那么这应该分成两个 object 来写）",[20,4915,4916,4917,4920],{},"这部分代码没什么好说的，就是对 ",[60,4918,4919],{},"provider"," 传过来的 string 用 js 做字符串解析，最后把整个 array 作为返回值返回就行，需要注意处理数组越界、空数组等等的低级错误。",[20,4922,4923],{},"第一步是将刚才的字符串转成 json 格式（如果你采用的是解析 html 的方式，请参考官方文档）",[78,4925,4927],{"className":80,"code":4926,"language":82,"meta":69,"style":69},"function scheduleHtmlParser(json_str) {\n  courses_json = JSON.parse(json_str)\n  const courseInfos = []\n\n  //...\n  \n  return courseInfos\n}\n",[60,4928,4929,4943,4963,4975,4979,4984,4989,4996],{"__ignoreMap":69},[86,4930,4931,4933,4936,4938,4941],{"class":88,"line":89},[86,4932,2299],{"class":92},[86,4934,4935],{"class":99}," scheduleHtmlParser",[86,4937,166],{"class":103},[86,4939,4940],{"class":362},"json_str",[86,4942,301],{"class":103},[86,4944,4945,4948,4950,4952,4954,4957,4959,4961],{"class":88,"line":107},[86,4946,4947],{"class":201},"  courses_json",[86,4949,118],{"class":117},[86,4951,498],{"class":113},[86,4953,181],{"class":103},[86,4955,4956],{"class":99},"parse",[86,4958,166],{"class":103},[86,4960,4940],{"class":201},[86,4962,172],{"class":103},[86,4964,4965,4967,4970,4972],{"class":88,"line":128},[86,4966,1777],{"class":92},[86,4968,4969],{"class":113}," courseInfos",[86,4971,118],{"class":117},[86,4973,4974],{"class":103}," []\n",[86,4976,4977],{"class":88,"line":143},[86,4978,147],{"emptyLinePlaceholder":146},[86,4980,4981],{"class":88,"line":150},[86,4982,4983],{"class":1714},"  //...\n",[86,4985,4986],{"class":88,"line":3},[86,4987,4988],{"class":103},"  \n",[86,4990,4991,4993],{"class":88,"line":207},[86,4992,2170],{"class":92},[86,4994,4995],{"class":201}," courseInfos\n",[86,4997,4998],{"class":88,"line":232},[86,4999,340],{"class":103},[20,5001,5002],{},"如果需要一个临时的测试方案，可以用以下的测试结构",[78,5004,5006],{"className":80,"code":5005,"language":82,"meta":69,"style":69},"function scheduleHtmlParser(json_str) {\n  courses_json = JSON.parse(json_str)\n  const courseInfos = []\n\n  //...\n  \n  return courseInfos\n}\n\ninput_text = `\n// 这里是我在上文中复制的 fetch 函数输出的 json 结果\n`\n\nconsole.log(scheduleHtmlParser(input_text))\n",[60,5007,5008,5020,5038,5048,5052,5056,5060,5066,5070,5074,5084,5089,5094,5098],{"__ignoreMap":69},[86,5009,5010,5012,5014,5016,5018],{"class":88,"line":89},[86,5011,2299],{"class":92},[86,5013,4935],{"class":99},[86,5015,166],{"class":103},[86,5017,4940],{"class":362},[86,5019,301],{"class":103},[86,5021,5022,5024,5026,5028,5030,5032,5034,5036],{"class":88,"line":107},[86,5023,4947],{"class":201},[86,5025,118],{"class":117},[86,5027,498],{"class":113},[86,5029,181],{"class":103},[86,5031,4956],{"class":99},[86,5033,166],{"class":103},[86,5035,4940],{"class":201},[86,5037,172],{"class":103},[86,5039,5040,5042,5044,5046],{"class":88,"line":128},[86,5041,1777],{"class":92},[86,5043,4969],{"class":113},[86,5045,118],{"class":117},[86,5047,4974],{"class":103},[86,5049,5050],{"class":88,"line":143},[86,5051,147],{"emptyLinePlaceholder":146},[86,5053,5054],{"class":88,"line":150},[86,5055,4983],{"class":1714},[86,5057,5058],{"class":88,"line":3},[86,5059,4988],{"class":103},[86,5061,5062,5064],{"class":88,"line":207},[86,5063,2170],{"class":92},[86,5065,4995],{"class":201},[86,5067,5068],{"class":88,"line":232},[86,5069,340],{"class":103},[86,5071,5072],{"class":88,"line":255},[86,5073,147],{"emptyLinePlaceholder":146},[86,5075,5076,5079,5081],{"class":88,"line":277},[86,5077,5078],{"class":201},"input_text",[86,5080,118],{"class":117},[86,5082,5083],{"class":121}," `\n",[86,5085,5086],{"class":88,"line":304},[86,5087,5088],{"class":121},"// 这里是我在上文中复制的 fetch 函数输出的 json 结果\n",[86,5090,5091],{"class":88,"line":322},[86,5092,5093],{"class":121},"`\n",[86,5095,5096],{"class":88,"line":328},[86,5097,147],{"emptyLinePlaceholder":146},[86,5099,5100,5103,5105,5107,5109,5112,5114,5116],{"class":88,"line":337},[86,5101,5102],{"class":177},"console",[86,5104,181],{"class":103},[86,5106,527],{"class":99},[86,5108,166],{"class":103},[86,5110,5111],{"class":99},"scheduleHtmlParser",[86,5113,166],{"class":103},[86,5115,5078],{"class":201},[86,5117,1842],{"class":103},[20,5119,5120,5121,5124],{},"执行 ",[60,5122,5123],{},"node code/parser.js"," ，观察输出结果是否和官方要求的结构严格一致。",[1682,5126,5128],{"id":5127},"编写-timer","编写 timer",[20,5130,5131,5134,5135,5137],{},[60,5132,5133],{},"timer"," 函数的运行环境和 ",[60,5136,4919],{}," 一致，都允许你使用 fetch 向教务系统打请求，或者解析页面的 html 函数，但我们学校的教务系统一不写第一周的周一是几号，二不写每节课具体的上下课时间，所以我把我校的相关数据都进行了硬编码，这里直接放个官方文档的示例文件。",[78,5139,5141],{"className":80,"code":5140,"language":82,"meta":69,"style":69},"/**\n * 时间配置函数，此为入口函数，不要改动函数名\n */\nasync function scheduleTimer({\n  providerRes,\n  parserRes\n} = {}) {\n  // 支持异步操作 推荐await写法\n\n  // 这是一个示例函数，用于演示，正常用不到可以删掉\n  const someAsyncFunc = () => new Promise(resolve => {\n    setTimeout(() => resolve(), 1)\n  })\n  await someAsyncFunc()\n\n  // 这个函数中也支持使用 AIScheduleTools 譬如给出多条时间配置让用户选择之类的\n\n  // 返回时间配置JSON，所有项都为可选项，如果不进行时间配置，请返回空对象\n  return {\n    totalWeek: 20, // 总周数：[1, 30]之间的整数\n    startSemester: '', // 开学时间：时间戳，13位长度字符串，推荐用代码生成\n    startWithSunday: false, // 是否是周日为起始日，该选项为true时，会开启显示周末选项\n    showWeekend: false, // 是否显示周末\n    forenoon: 1, // 上午课程节数：[1, 10]之间的整数\n    afternoon: 0, // 下午课程节数：[0, 10]之间的整数\n    night: 0, // 晚间课程节数：[0, 10]之间的整数\n    sections: [{\n      section: 1, // 节次：[1, 30]之间的整数\n      startTime: '08:00', // 开始时间：参照这个标准格式5位长度字符串\n      endTime: '08:50', // 结束时间：同上\n    }], // 课程时间表，注意：总长度要和上边配置的节数加和对齐\n  }\n  // PS: 夏令时什么的还是让用户在夏令时的时候重新导入一遍吧，在这个函数里边适配吧！奥里给！————不愿意透露姓名的嘤某人\n}\n",[60,5142,5143,5147,5152,5156,5167,5174,5179,5190,5195,5199,5204,5232,5252,5257,5265,5269,5274,5278,5283,5289,5304,5319,5334,5348,5363,5377,5391,5400,5414,5429,5444,5452,5456,5461],{"__ignoreMap":69},[86,5144,5145],{"class":88,"line":89},[86,5146,1998],{"class":1714},[86,5148,5149],{"class":88,"line":107},[86,5150,5151],{"class":1714}," * 时间配置函数，此为入口函数，不要改动函数名\n",[86,5153,5154],{"class":88,"line":128},[86,5155,2013],{"class":1714},[86,5157,5158,5160,5162,5165],{"class":88,"line":143},[86,5159,93],{"class":92},[86,5161,96],{"class":92},[86,5163,5164],{"class":99}," scheduleTimer",[86,5166,4003],{"class":103},[86,5168,5169,5172],{"class":88,"line":150},[86,5170,5171],{"class":362},"  providerRes",[86,5173,404],{"class":103},[86,5175,5176],{"class":88,"line":3},[86,5177,5178],{"class":362},"  parserRes\n",[86,5180,5181,5184,5187],{"class":88,"line":207},[86,5182,5183],{"class":103},"} ",[86,5185,5186],{"class":117},"=",[86,5188,5189],{"class":103}," {}) {\n",[86,5191,5192],{"class":88,"line":232},[86,5193,5194],{"class":1714},"  // 支持异步操作 推荐await写法\n",[86,5196,5197],{"class":88,"line":255},[86,5198,147],{"emptyLinePlaceholder":146},[86,5200,5201],{"class":88,"line":277},[86,5202,5203],{"class":1714},"  // 这是一个示例函数，用于演示，正常用不到可以删掉\n",[86,5205,5206,5208,5211,5213,5216,5219,5221,5223,5225,5228,5230],{"class":88,"line":304},[86,5207,1777],{"class":92},[86,5209,5210],{"class":99}," someAsyncFunc",[86,5212,118],{"class":117},[86,5214,5215],{"class":103}," () ",[86,5217,5218],{"class":92},"=>",[86,5220,160],{"class":92},[86,5222,2635],{"class":2634},[86,5224,166],{"class":103},[86,5226,5227],{"class":362},"resolve",[86,5229,1770],{"class":92},[86,5231,389],{"class":103},[86,5233,5234,5237,5240,5242,5245,5248,5250],{"class":88,"line":322},[86,5235,5236],{"class":99},"    setTimeout",[86,5238,5239],{"class":103},"(() ",[86,5241,5218],{"class":92},[86,5243,5244],{"class":99}," resolve",[86,5246,5247],{"class":103},"(), ",[86,5249,1376],{"class":816},[86,5251,172],{"class":103},[86,5253,5254],{"class":88,"line":328},[86,5255,5256],{"class":103},"  })\n",[86,5258,5259,5261,5263],{"class":88,"line":337},[86,5260,4563],{"class":92},[86,5262,5210],{"class":99},[86,5264,274],{"class":103},[86,5266,5267],{"class":88,"line":513},[86,5268,147],{"emptyLinePlaceholder":146},[86,5270,5271],{"class":88,"line":519},[86,5272,5273],{"class":1714},"  // 这个函数中也支持使用 AIScheduleTools 譬如给出多条时间配置让用户选择之类的\n",[86,5275,5276],{"class":88,"line":537},[86,5277,147],{"emptyLinePlaceholder":146},[86,5279,5280],{"class":88,"line":792},[86,5281,5282],{"class":1714},"  // 返回时间配置JSON，所有项都为可选项，如果不进行时间配置，请返回空对象\n",[86,5284,5285,5287],{"class":88,"line":797},[86,5286,2170],{"class":92},[86,5288,389],{"class":103},[86,5290,5291,5294,5296,5299,5301],{"class":88,"line":822},[86,5292,5293],{"class":291},"    totalWeek",[86,5295,398],{"class":397},[86,5297,5298],{"class":816}," 20",[86,5300,198],{"class":103},[86,5302,5303],{"class":1714},"// 总周数：[1, 30]之间的整数\n",[86,5305,5306,5309,5311,5314,5316],{"class":88,"line":871},[86,5307,5308],{"class":291},"    startSemester",[86,5310,398],{"class":397},[86,5312,5313],{"class":121}," ''",[86,5315,198],{"class":103},[86,5317,5318],{"class":1714},"// 开学时间：时间戳，13位长度字符串，推荐用代码生成\n",[86,5320,5321,5324,5326,5329,5331],{"class":88,"line":882},[86,5322,5323],{"class":291},"    startWithSunday",[86,5325,398],{"class":397},[86,5327,5328],{"class":816}," false",[86,5330,198],{"class":103},[86,5332,5333],{"class":1714},"// 是否是周日为起始日，该选项为true时，会开启显示周末选项\n",[86,5335,5336,5339,5341,5343,5345],{"class":88,"line":899},[86,5337,5338],{"class":291},"    showWeekend",[86,5340,398],{"class":397},[86,5342,5328],{"class":816},[86,5344,198],{"class":103},[86,5346,5347],{"class":1714},"// 是否显示周末\n",[86,5349,5350,5353,5355,5358,5360],{"class":88,"line":904},[86,5351,5352],{"class":291},"    forenoon",[86,5354,398],{"class":397},[86,5356,5357],{"class":816}," 1",[86,5359,198],{"class":103},[86,5361,5362],{"class":1714},"// 上午课程节数：[1, 10]之间的整数\n",[86,5364,5365,5368,5370,5372,5374],{"class":88,"line":909},[86,5366,5367],{"class":291},"    afternoon",[86,5369,398],{"class":397},[86,5371,817],{"class":816},[86,5373,198],{"class":103},[86,5375,5376],{"class":1714},"// 下午课程节数：[0, 10]之间的整数\n",[86,5378,5379,5382,5384,5386,5388],{"class":88,"line":2259},[86,5380,5381],{"class":291},"    night",[86,5383,398],{"class":397},[86,5385,817],{"class":816},[86,5387,198],{"class":103},[86,5389,5390],{"class":1714},"// 晚间课程节数：[0, 10]之间的整数\n",[86,5392,5393,5395,5397],{"class":88,"line":2264},[86,5394,4744],{"class":291},[86,5396,398],{"class":397},[86,5398,5399],{"class":103}," [{\n",[86,5401,5402,5405,5407,5409,5411],{"class":88,"line":2269},[86,5403,5404],{"class":291},"      section",[86,5406,398],{"class":397},[86,5408,5357],{"class":816},[86,5410,198],{"class":103},[86,5412,5413],{"class":1714},"// 节次：[1, 30]之间的整数\n",[86,5415,5416,5419,5421,5424,5426],{"class":88,"line":2274},[86,5417,5418],{"class":291},"      startTime",[86,5420,398],{"class":397},[86,5422,5423],{"class":121}," '08:00'",[86,5425,198],{"class":103},[86,5427,5428],{"class":1714},"// 开始时间：参照这个标准格式5位长度字符串\n",[86,5430,5431,5434,5436,5439,5441],{"class":88,"line":2279},[86,5432,5433],{"class":291},"      endTime",[86,5435,398],{"class":397},[86,5437,5438],{"class":121}," '08:50'",[86,5440,198],{"class":103},[86,5442,5443],{"class":1714},"// 结束时间：同上\n",[86,5445,5446,5449],{"class":88,"line":2285},[86,5447,5448],{"class":103},"    }], ",[86,5450,5451],{"class":1714},"// 课程时间表，注意：总长度要和上边配置的节数加和对齐\n",[86,5453,5454],{"class":88,"line":2291},[86,5455,1977],{"class":103},[86,5457,5458],{"class":88,"line":2296},[86,5459,5460],{"class":1714},"  // PS: 夏令时什么的还是让用户在夏令时的时候重新导入一遍吧，在这个函数里边适配吧！奥里给！————不愿意透露姓名的嘤某人\n",[86,5462,5463],{"class":88,"line":2310},[86,5464,340],{"class":103},[1682,5466,5467],{"id":5467},"调试阶段",[20,5469,5470,5471,5474],{},"运行 ",[60,5472,5473],{},"pnpm main"," 能调起一个临时的服务器和浏览器插件进行互动，将编辑器的代码实时同步到浏览器插件。",[20,5476,5477],{},"在浏览器插件中，先创建一个新项目",[20,5479,5480],{},[67,5481],{"alt":69,"src":5482},"https://static.031130.xyz/uploads/2024/11/18/d1ebba67ddc83.webp",[20,5484,5485],{},"保存后再次打开，选择「编写代码」按钮",[20,5487,5488],{},[67,5489],{"alt":69,"src":5490},"https://static.031130.xyz/uploads/2024/11/18/e697bcf2a7a1f.webp",[20,5492,5493],{},"检查自己的代码是不是被实时同步到了浏览器插件中，然后可以点击右上角的「本地测试」按钮",[20,5495,5496],{},[67,5497],{"alt":69,"src":5498},"https://static.031130.xyz/uploads/2024/11/18/eb563904a64a1.webp",[20,5500,5501],{},"如果本机测试出现了问题，可以使用 console.log 语句进行 debug ，问题可能会出现在 F12 开发者工具的控制台，也可能会出现在 vscode 的终端中。确认本机测试无问题后，点击右上角蓝色的「上传」按钮，就可以在上传到云端，在登陆了自己小米账号的手机中找到自己适配的教务导入测试项目，顺利完成导入后给自己的满意度打满分，就可以在浏览器插件中点击上传审核，审核通过后你的适配工作就会公开啦。",[933,5503,5504],{},"html pre.shiki code .sLKXg, html code.shiki .sLKXg{--shiki-default:#A626A4;--shiki-dark:#C678DD}html pre.shiki code .sAdtL, html code.shiki .sAdtL{--shiki-default:#4078F2;--shiki-dark:#61AFEF}html pre.shiki code .s5ixo, html code.shiki .s5ixo{--shiki-default:#383A42;--shiki-dark:#ABB2BF}html pre.shiki code .sDhpE, html code.shiki .sDhpE{--shiki-default:#50A14F;--shiki-dark:#98C379}html pre.shiki code .st7oF, html code.shiki .st7oF{--shiki-default:#0184BC;--shiki-dark:#ABB2BF}html .default .shiki span {color: var(--shiki-default);background: var(--shiki-default-bg);font-style: var(--shiki-default-font-style);font-weight: var(--shiki-default-font-weight);text-decoration: var(--shiki-default-text-decoration);}html .shiki span {color: var(--shiki-default);background: var(--shiki-default-bg);font-style: var(--shiki-default-font-style);font-weight: var(--shiki-default-font-weight);text-decoration: var(--shiki-default-text-decoration);}html .dark .shiki span {color: var(--shiki-dark);background: var(--shiki-dark-bg);font-style: var(--shiki-dark-font-style);font-weight: var(--shiki-dark-font-weight);text-decoration: var(--shiki-dark-text-decoration);}html.dark .shiki span {color: var(--shiki-dark);background: var(--shiki-dark-bg);font-style: var(--shiki-dark-font-style);font-weight: var(--shiki-dark-font-weight);text-decoration: var(--shiki-dark-text-decoration);}html pre.shiki code .s8iYz, html code.shiki .s8iYz{--shiki-default:#383A42;--shiki-default-font-style:inherit;--shiki-dark:#E06C75;--shiki-dark-font-style:italic}html pre.shiki code .s7GmK, html code.shiki .s7GmK{--shiki-default:#383A42;--shiki-dark:#E5C07B}html pre.shiki code .sNmU0, html code.shiki .sNmU0{--shiki-default:#986801;--shiki-dark:#E5C07B}html pre.shiki code .s_Sar, html code.shiki .s_Sar{--shiki-default:#0184BC;--shiki-dark:#56B6C2}html pre.shiki code .sJa8x, html code.shiki .sJa8x{--shiki-default:#E45649;--shiki-dark:#E06C75}html pre.shiki code .sz0mV, html code.shiki .sz0mV{--shiki-default:#383A42;--shiki-dark:#E06C75}html pre.shiki code .sAGMh, html code.shiki .sAGMh{--shiki-default:#986801;--shiki-dark:#D19A66}html pre.shiki code .sAOjX, html code.shiki .sAOjX{--shiki-default:#CA1243;--shiki-dark:#C678DD}html pre.shiki code .sW2Sy, html code.shiki .sW2Sy{--shiki-default:#A0A1A7;--shiki-default-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic}html pre.shiki code .sUNH4, html code.shiki .sUNH4{--shiki-default:white;--shiki-dark:#FFFFFF}html pre.shiki code .sC09Y, html code.shiki .sC09Y{--shiki-default:#C18401;--shiki-dark:#E5C07B}",{"title":69,"searchDepth":107,"depth":107,"links":5506},[5507,5508,5509],{"id":3448,"depth":107,"text":3448},{"id":3476,"depth":107,"text":3476},{"id":3528,"depth":107,"text":3528,"children":5510},[5511,5512,5513,5514,5515,5516,5517,5518],{"id":3531,"depth":128,"text":3531},{"id":3565,"depth":128,"text":3565},{"id":3596,"depth":128,"text":3597},{"id":3921,"depth":128,"text":3921},{"id":3939,"depth":128,"text":3940},{"id":4627,"depth":128,"text":4628},{"id":5127,"depth":128,"text":5128},{"id":5467,"depth":128,"text":5467},{"title":5520,"date":5521,"path":5522,"tags":5523,"body":5527},"将博客从 waline v2 更新到 waline v3","2024-11-15 23:49:43","/2024/11/15/upgrade-waline-from-v2-to-v3",[5524,5525,5526],"Python","waline","Hexo",{"type":14,"value":5528,"toc":6024},[5529,5534,5541,5558,5562,5565,5571,5576,5584,5600,5608,5611,5617,5621,5624,5629,5638,5643,5646,5649,5654,5657,5660,5665,5668,5671,5685,5688,5695,5702,5709,5712,6004,6011,6016,6021],[17,5530,5531],{},[20,5532,5533],{},"waline 更新到 V3 版本已经是九个月前的事情了，眼瞅着 hexo fluid 主题并没有带我更新的意思，我就打算自己更新到最新版，结果遇到了两个坑，写文供大家参考。",[20,5535,5536,5537,5540],{},"在 Hexo 目录下的 ",[60,5538,5539],{},"_config.fluid.yml"," 文件中找到 waline 的 cdn，将版本号指向最新版。",[78,5542,5546],{"className":5543,"code":5544,"language":5545,"meta":69,"style":69},"language-diff shiki shiki-themes one-light one-dark-pro","-  waline: https://registry.npmmirror.com/@waline/client/2.15.8/files/dist/\n+  waline: https://registry.npmmirror.com/@waline/client/^3/files/dist/\n","diff",[60,5547,5548,5553],{"__ignoreMap":69},[86,5549,5550],{"class":88,"line":89},[86,5551,5552],{"class":291},"-  waline: https://registry.npmmirror.com/@waline/client/2.15.8/files/dist/\n",[86,5554,5555],{"class":88,"line":107},[86,5556,5557],{"class":121},"+  waline: https://registry.npmmirror.com/@waline/client/^3/files/dist/\n",[948,5559,5561],{"id":5560},"插曲一waline-不加载","插曲一——waline 不加载",[20,5563,5564],{},"再次部署博客，我遇到了第一个坑：waline 没有在页面上正常加载。",[20,5566,5567,5568],{},"打开控制台一看，报错给得很明白：",[60,5569,5570],{},"Waline is not defined",[20,5572,5573],{},[67,5574],{"alt":69,"src":5575},"https://static.031130.xyz/uploads/2024/11/16/663e910db29b7.webp",[20,5577,5578,5579,58],{},"根据 ",[30,5580,5583],{"href":5581,"rel":5582},"https://github.com/walinejs/waline/issues/2483",[41],"issue#2483",[17,5585,5586,5593],{},[20,5587,5588,5592],{},[30,5589,5590],{"href":5590,"rel":5591},"https://unpkg.com/@waline/client@3.1.3/dist/waline.umd.js",[41]," 用这个地址",[20,5594,5595,5596,5599],{},"本质是 ...... 没有使用 ES Module 的加载方式 ",[60,5597,5598],{},"\u003Cscript type=\"module\">","，所以需要使用 UMD 的模块",[20,5601,5602,5603],{},"那么按照正常的脑回路，我们应该修改主题中的引入 waline 部分的 js 文件，把针对 waline.js 的引用改成 waline.umd.js，具体的修改处",[30,5604,5607],{"href":5605,"rel":5606},"https://github.com/fluid-dev/hexo-theme-fluid/blob/94049b2e6da5ae865f5cf7088f0c53917a6dc8bc/layout/_partials/comments/waline.ejs#L5-L6",[41],"在这里",[20,5609,5610],{},"但是，我是使用 npm 安装的主题，方便在主题更新时直接同步上游的更改，如果使用这种修改源文件引用的方式将会导致我不得不放弃原有的主题安装方式，改用下载主题源码的方式。",[20,5612,5613,5614,5616],{},"那么有没有办法，既能够成功加载带 umd 的 js，又不用改动主题源码呢？还真有，我自己部署 cdn 就好了。从 npmjs 下载带 umd 的 waline.umd.js，重命名成 waline.js，和 waline.css 一起放在同一路径下，在把自己的 cdn 链接前缀填入 ",[60,5615,5539],{}," 中，就可以实现移花接木——表面上访问的是 waline.js，实际上内容是 waline.umd.js 。",[948,5618,5620],{"id":5619},"插曲二重复显示的","插曲二——重复显示的 @",[20,5622,5623],{},"更新到 v3 版本以后，我发现所有的评论都出现了重复两遍的 @",[20,5625,5626],{},[67,5627],{"alt":69,"src":5628},"https://static.031130.xyz/uploads/2024/11/16/f6fbaa99a784e.webp",[20,5630,5631,5632,5637],{},"我去群里提问，管理员 ",[30,5633,5636],{"href":5634,"rel":5635},"https://imnerd.org/",[41],"li zheming"," 给出了这样的答复:",[17,5639,5640],{},[20,5641,5642],{},"这个是 feature 了，早版本 @ 是渲染在评论内容里的，这块后来重构了下，@ 是 Waline 自己渲染了。不过历史数据我们并没有处理，所以会出现这种情况。如果比较介意的话可以手动去数据库里删除下。",[20,5644,5645],{},"那么很显然，我很介意这点，我需要删除数据库中的 @ 信息。",[20,5647,5648],{},"打开 waline 的后台管理站点，我发现我有整整 30 页的评论——很显然我是 waline 的牢用户了，我不太可能一个一个手动去掉评论中的 @",[20,5650,5651],{},[67,5652],{"alt":69,"src":5653},"https://static.031130.xyz/uploads/2024/11/16/c4487502542e5.webp",[20,5655,5656],{},"我的 waline 数据库是 leancloud，对方的 webui 没办法帮助我批量去除 html 或者 markdown 形式的内容（就算对方支持 sql 语句，处理这个问题都够呛），我需要一个脚本来直接处理数据库中的信息。",[20,5658,5659],{},"首先，我们需要导出数据库数据，自然是登陆 leancloud，然后找到 数据存储 - 导入导出 - 数据导出，选择 Comment 单个 Class，单击导出按钮。",[20,5661,5662],{},[67,5663],{"alt":69,"src":5664},"https://static.031130.xyz/uploads/2024/11/16/d2cd564739120.webp",[20,5666,5667],{},"err，我寻思凌晨 1 点应该是 16 点前吧，怎么导出不了，而我昨晚 23 点反而可以导出，leancloud 到底是哪门子时区。所以我直接拿了 23 点时导出的数据进行处理。",[20,5669,5670],{},"leancloud 导出的数据是 jsonl 格式的，我们对需要去除的 @ 信息进行归纳总结，发现一共有两种 @ 的渲染方式",[2935,5672,5673,5679],{},[991,5674,5675,5678],{},[60,5676,5677],{},"\u003Ca class=\"at\" href=\"#id\">@username\u003C/a>","  的 html 风格（有时 class 和 href 顺序还会反过来）",[991,5680,5681,5684],{},[60,5682,5683],{},"[@username](#id)"," 的 markdown 风格",[20,5686,5687],{},"而 html 风格还有两种结尾方式，",[20,5689,5690,5691,5694],{},"一种是如 ",[60,5692,5693],{},"\u003Ca class=\"at\" href=\"#id\">@username\u003C/a> , "," 这样以 空格 + 半角逗号 + 空格 结尾的形式，",[20,5696,5697,5698,5701],{},"令一种是如 ",[60,5699,5700],{},"\u003Ca class=\"at\" href=\"#id\">@username\u003C/a>: "," 这样以 半角冒号 + 空格结尾的形式。",[20,5703,5704,5705,5708],{},"markdown 风格的结尾方式我就只看到一种，如 ",[60,5706,5707],{},"[@username](#id): ","这样以 半角冒号 + 空格结尾的形式。",[20,5710,5711],{},"因此，我们需要对三种形式分别编写正则表达式进行匹配并删除，参考代码如下",[78,5713,5717],{"className":5714,"code":5715,"language":5716,"meta":69,"style":69},"language-python shiki shiki-themes one-light one-dark-pro","import re\n\nwith open('Comment.0.jsonl', 'r') as f:\n    s = f.read()\n\npatterns = [\n    r'\u003Ca class=\\\\\"at\\\\\" href=\\\\\"#(?:.*?)\\\\\">@(?:.*?)\u003C/a>: ',\n    r'\u003Ca class=\\\\\"at\\\\\" href=\\\\\"#(?:.*?)\\\\\">@(?:.*?)\u003C/a> , ',\n    r'\\[@(?:.*?)\\]\\(#(?:.*?)\\):'\n]\n\nfor pattern in patterns:\n    s = re.sub(pattern, \"\", s)\n\nwith open('Comment.1.jsonl', 'w') as f:\n    f.write(s)\n","python",[60,5718,5719,5727,5731,5757,5774,5778,5788,5841,5884,5924,5928,5932,5946,5967,5971,5993],{"__ignoreMap":69},[86,5720,5721,5724],{"class":88,"line":89},[86,5722,5723],{"class":92},"import",[86,5725,5726],{"class":103}," re\n",[86,5728,5729],{"class":88,"line":107},[86,5730,147],{"emptyLinePlaceholder":146},[86,5732,5733,5736,5739,5741,5744,5746,5749,5751,5754],{"class":88,"line":128},[86,5734,5735],{"class":92},"with",[86,5737,5738],{"class":117}," open",[86,5740,166],{"class":103},[86,5742,5743],{"class":121},"'Comment.0.jsonl'",[86,5745,198],{"class":103},[86,5747,5748],{"class":121},"'r'",[86,5750,2063],{"class":103},[86,5752,5753],{"class":92},"as",[86,5755,5756],{"class":103}," f:\n",[86,5758,5759,5762,5765,5768,5772],{"class":88,"line":143},[86,5760,5761],{"class":103},"    s ",[86,5763,5186],{"class":5764},"sknuh",[86,5766,5767],{"class":103}," f.",[86,5769,5771],{"class":5770},"slOjB","read",[86,5773,274],{"class":103},[86,5775,5776],{"class":88,"line":150},[86,5777,147],{"emptyLinePlaceholder":146},[86,5779,5780,5783,5785],{"class":88,"line":3},[86,5781,5782],{"class":103},"patterns ",[86,5784,5186],{"class":5764},[86,5786,5787],{"class":103}," [\n",[86,5789,5790,5793,5796,5799,5802,5804,5807,5809,5812,5815,5817,5821,5823,5825,5828,5830,5832,5834,5836,5839],{"class":88,"line":207},[86,5791,5792],{"class":92},"    r",[86,5794,5795],{"class":2518},"'\u003Ca class=",[86,5797,5798],{"class":117},"\\\\",[86,5800,5801],{"class":2518},"\"at",[86,5803,5798],{"class":117},[86,5805,5806],{"class":2518},"\" href=",[86,5808,5798],{"class":117},[86,5810,5811],{"class":2518},"\"#",[86,5813,5814],{"class":2534},"(?:",[86,5816,181],{"class":2518},[86,5818,5820],{"class":5819},"sYebD","*?",[86,5822,860],{"class":2534},[86,5824,5798],{"class":117},[86,5826,5827],{"class":2518},"\">@",[86,5829,5814],{"class":2534},[86,5831,181],{"class":2518},[86,5833,5820],{"class":5819},[86,5835,860],{"class":2534},[86,5837,5838],{"class":2518},"\u003C/a>: '",[86,5840,404],{"class":103},[86,5842,5843,5845,5847,5849,5851,5853,5855,5857,5859,5861,5863,5865,5867,5869,5871,5873,5875,5877,5879,5882],{"class":88,"line":232},[86,5844,5792],{"class":92},[86,5846,5795],{"class":2518},[86,5848,5798],{"class":117},[86,5850,5801],{"class":2518},[86,5852,5798],{"class":117},[86,5854,5806],{"class":2518},[86,5856,5798],{"class":117},[86,5858,5811],{"class":2518},[86,5860,5814],{"class":2534},[86,5862,181],{"class":2518},[86,5864,5820],{"class":5819},[86,5866,860],{"class":2534},[86,5868,5798],{"class":117},[86,5870,5827],{"class":2518},[86,5872,5814],{"class":2534},[86,5874,181],{"class":2518},[86,5876,5820],{"class":5819},[86,5878,860],{"class":2534},[86,5880,5881],{"class":2518},"\u003C/a> , '",[86,5883,404],{"class":103},[86,5885,5886,5888,5890,5893,5896,5898,5900,5902,5904,5907,5910,5912,5914,5916,5918,5921],{"class":88,"line":255},[86,5887,5792],{"class":92},[86,5889,2339],{"class":2518},[86,5891,5892],{"class":117},"\\[",[86,5894,5895],{"class":2518},"@",[86,5897,5814],{"class":2534},[86,5899,181],{"class":2518},[86,5901,5820],{"class":5819},[86,5903,860],{"class":2534},[86,5905,5906],{"class":117},"\\]\\(",[86,5908,5909],{"class":2518},"#",[86,5911,5814],{"class":2534},[86,5913,181],{"class":2518},[86,5915,5820],{"class":5819},[86,5917,860],{"class":2534},[86,5919,5920],{"class":117},"\\)",[86,5922,5923],{"class":2518},":'\n",[86,5925,5926],{"class":88,"line":277},[86,5927,4340],{"class":103},[86,5929,5930],{"class":88,"line":304},[86,5931,147],{"emptyLinePlaceholder":146},[86,5933,5934,5937,5940,5943],{"class":88,"line":322},[86,5935,5936],{"class":92},"for",[86,5938,5939],{"class":103}," pattern ",[86,5941,5942],{"class":92},"in",[86,5944,5945],{"class":103}," patterns:\n",[86,5947,5948,5950,5952,5955,5958,5961,5964],{"class":88,"line":328},[86,5949,5761],{"class":103},[86,5951,5186],{"class":5764},[86,5953,5954],{"class":103}," re.",[86,5956,5957],{"class":5770},"sub",[86,5959,5960],{"class":103},"(pattern, ",[86,5962,5963],{"class":121},"\"\"",[86,5965,5966],{"class":103},", s)\n",[86,5968,5969],{"class":88,"line":337},[86,5970,147],{"emptyLinePlaceholder":146},[86,5972,5973,5975,5977,5979,5982,5984,5987,5989,5991],{"class":88,"line":513},[86,5974,5735],{"class":92},[86,5976,5738],{"class":117},[86,5978,166],{"class":103},[86,5980,5981],{"class":121},"'Comment.1.jsonl'",[86,5983,198],{"class":103},[86,5985,5986],{"class":121},"'w'",[86,5988,2063],{"class":103},[86,5990,5753],{"class":92},[86,5992,5756],{"class":103},[86,5994,5995,5998,6001],{"class":88,"line":519},[86,5996,5997],{"class":103},"    f.",[86,5999,6000],{"class":5770},"write",[86,6002,6003],{"class":103},"(s)\n",[20,6005,6006,6007,6010],{},"随后删除 Comment 表中所有数据，把生成的 ",[60,6008,6009],{},"Comment.1.jsonl"," 导入 leancloud，就算是大功告成了。",[20,6012,6013],{},[67,6014],{"alt":69,"src":6015},"https://static.031130.xyz/uploads/2024/11/16/d248ae2eac74c.webp",[20,6017,6018],{},[67,6019],{"alt":69,"src":6020},"https://static.031130.xyz/uploads/2024/11/16/c3875dcde1d97.webp",[933,6022,6023],{},"html pre.shiki code .sJa8x, html code.shiki .sJa8x{--shiki-default:#E45649;--shiki-dark:#E06C75}html pre.shiki code .sDhpE, html code.shiki .sDhpE{--shiki-default:#50A14F;--shiki-dark:#98C379}html .default .shiki span {color: var(--shiki-default);background: var(--shiki-default-bg);font-style: var(--shiki-default-font-style);font-weight: var(--shiki-default-font-weight);text-decoration: var(--shiki-default-text-decoration);}html .shiki span {color: var(--shiki-default);background: var(--shiki-default-bg);font-style: var(--shiki-default-font-style);font-weight: var(--shiki-default-font-weight);text-decoration: var(--shiki-default-text-decoration);}html .dark .shiki span {color: var(--shiki-dark);background: var(--shiki-dark-bg);font-style: var(--shiki-dark-font-style);font-weight: var(--shiki-dark-font-weight);text-decoration: var(--shiki-dark-text-decoration);}html.dark .shiki span {color: var(--shiki-dark);background: var(--shiki-dark-bg);font-style: var(--shiki-dark-font-style);font-weight: var(--shiki-dark-font-weight);text-decoration: var(--shiki-dark-text-decoration);}html pre.shiki code .sLKXg, html code.shiki .sLKXg{--shiki-default:#A626A4;--shiki-dark:#C678DD}html pre.shiki code .s5ixo, html code.shiki .s5ixo{--shiki-default:#383A42;--shiki-dark:#ABB2BF}html pre.shiki code .s_Sar, html code.shiki .s_Sar{--shiki-default:#0184BC;--shiki-dark:#56B6C2}html pre.shiki code .sknuh, html code.shiki .sknuh{--shiki-default:#383A42;--shiki-dark:#56B6C2}html pre.shiki code .slOjB, html code.shiki .slOjB{--shiki-default:#383A42;--shiki-dark:#61AFEF}html pre.shiki code .sDaw7, html code.shiki .sDaw7{--shiki-default:#0184BC;--shiki-dark:#E06C75}html pre.shiki code .sYoRg, html code.shiki .sYoRg{--shiki-default:#0184BC;--shiki-dark:#D19A66}html pre.shiki code .sYebD, html code.shiki .sYebD{--shiki-default:#383A42;--shiki-dark:#D19A66}",{"title":69,"searchDepth":107,"depth":107,"links":6025},[6026,6027],{"id":5560,"depth":107,"text":5561},{"id":5619,"depth":107,"text":5620},{"title":6029,"date":6030,"path":6031,"tags":6032,"body":6038},"给家里云装上 Fedora 41 KDE 后，我是如何配置的","2024-11-01 23:35:08","/2024/11/01/my-config-for-fedora-kde-41",[6033,12,6034,6035,6036,6037],"Linux","KDE","HomeServer","Rustdesk","Notes",{"type":14,"value":6039,"toc":6832},[6040,6045,6048,6056,6086,6090,6098,6101,6155,6158,6219,6226,6244,6247,6250,6271,6275,6294,6297,6313,6317,6337,6341,6366,6369,6385,6388,6391,6407,6412,6416,6432,6436,6455,6458,6480,6484,6491,6594,6598,6620,6623,6626,6632,6638,6642,6648,6727,6730,6734,6789,6792,6795,6798,6819,6823,6829],[17,6041,6042],{},[20,6043,6044],{},"前两天给自己的 N100 小主机重装成了最近发布的 Fedora 41 ( KDE )，也是花了不少时间把整个系统调成自己熟悉的样子，因此开一篇博客记录一下。以下仅为我个人的 HomeServer 小主机使用，不具有普适性。",[948,6046,6047],{"id":6047},"换官方源",[20,6049,6050,6051,983],{},"我这里比较适合用上交的源，直接参考",[30,6052,6055],{"href":6053,"rel":6054},"https://mirrors.sjtug.sjtu.edu.cn/docs/fedora/linux",[41],"他们的文档",[78,6057,6059],{"className":1043,"code":6058,"language":1045,"meta":69,"style":69},"sudo sed -e 's/^metalink=/#metalink=/g' -e 's|^#baseurl=http://download.example/pub/|baseurl=https://mirror.sjtu.edu.cn/|g' -i.bak /etc/yum.repos.d/{fedora.repo,fedora-updates.repo}\n",[60,6060,6061],{"__ignoreMap":69},[86,6062,6063,6066,6069,6072,6075,6077,6080,6083],{"class":88,"line":89},[86,6064,6065],{"class":99},"sudo",[86,6067,6068],{"class":121}," sed",[86,6070,6071],{"class":816}," -e",[86,6073,6074],{"class":121}," 's/^metalink=/#metalink=/g'",[86,6076,6071],{"class":816},[86,6078,6079],{"class":121}," 's|^#baseurl=http://download.example/pub/|baseurl=https://mirror.sjtu.edu.cn/|g'",[86,6081,6082],{"class":816}," -i.bak",[86,6084,6085],{"class":121}," /etc/yum.repos.d/{fedora.repo,fedora-updates.repo}\n",[948,6087,6089],{"id":6088},"加-rpmfusion-源","加 rpmfusion 源",[20,6091,6092,6093],{},"参考 ",[30,6094,6097],{"href":6095,"rel":6096},"https://help.mirrors.cernet.edu.cn/rpmfusion/?mirror=SJTUG-Siyuan",[41],"help.cernet.edu.cn 提供的文档",[20,6099,6100],{},"安装源配置文件",[78,6102,6104],{"className":1043,"code":6103,"language":1045,"meta":69,"style":69},"sudo yum install --nogpgcheck https://mirror.sjtu.edu.cn/rpmfusion/free/fedora/rpmfusion-free-release-$(rpm -E %fedora).noarch.rpm https://mirror.sjtu.edu.cn/rpmfusion/nonfree/fedora/rpmfusion-nonfree-release-$(rpm -E %fedora).noarch.rpm\n",[60,6105,6106],{"__ignoreMap":69},[86,6107,6108,6110,6113,6116,6119,6122,6125,6128,6131,6134,6136,6139,6142,6144,6146,6148,6150,6152],{"class":88,"line":89},[86,6109,6065],{"class":99},[86,6111,6112],{"class":121}," yum",[86,6114,6115],{"class":121}," install",[86,6117,6118],{"class":816}," --nogpgcheck",[86,6120,6121],{"class":121}," https://mirror.sjtu.edu.cn/rpmfusion/free/fedora/rpmfusion-free-release-",[86,6123,6124],{"class":103},"$(",[86,6126,6127],{"class":99},"rpm",[86,6129,6130],{"class":816}," -E",[86,6132,6133],{"class":121}," %fedora",[86,6135,860],{"class":103},[86,6137,6138],{"class":121},".noarch.rpm",[86,6140,6141],{"class":121}," https://mirror.sjtu.edu.cn/rpmfusion/nonfree/fedora/rpmfusion-nonfree-release-",[86,6143,6124],{"class":103},[86,6145,6127],{"class":99},[86,6147,6130],{"class":816},[86,6149,6133],{"class":121},[86,6151,860],{"class":103},[86,6153,6154],{"class":121},".noarch.rpm\n",[20,6156,6157],{},"换源",[78,6159,6161],{"className":1043,"code":6160,"language":1045,"meta":69,"style":69},"sudo sed -e 's!^metalink=!#metalink=!g' \\\n         -e 's!^mirrorlist=!#mirrorlist=!g' \\\n         -e 's!^#baseurl=!baseurl=!g' \\\n         -e 's!https\\?://download1\\.rpmfusion\\.org/!https://mirror.sjtu.edu.cn/rpmfusion/!g' \\\n         -i.bak /etc/yum.repos.d/rpmfusion*.repo\n",[60,6162,6163,6177,6187,6196,6205],{"__ignoreMap":69},[86,6164,6165,6167,6169,6171,6174],{"class":88,"line":89},[86,6166,6065],{"class":99},[86,6168,6068],{"class":121},[86,6170,6071],{"class":816},[86,6172,6173],{"class":121}," 's!^metalink=!#metalink=!g'",[86,6175,6176],{"class":117}," \\\n",[86,6178,6179,6182,6185],{"class":88,"line":107},[86,6180,6181],{"class":816},"         -e",[86,6183,6184],{"class":121}," 's!^mirrorlist=!#mirrorlist=!g'",[86,6186,6176],{"class":117},[86,6188,6189,6191,6194],{"class":88,"line":128},[86,6190,6181],{"class":816},[86,6192,6193],{"class":121}," 's!^#baseurl=!baseurl=!g'",[86,6195,6176],{"class":117},[86,6197,6198,6200,6203],{"class":88,"line":143},[86,6199,6181],{"class":816},[86,6201,6202],{"class":121}," 's!https\\?://download1\\.rpmfusion\\.org/!https://mirror.sjtu.edu.cn/rpmfusion/!g'",[86,6204,6176],{"class":117},[86,6206,6207,6210,6213,6216],{"class":88,"line":150},[86,6208,6209],{"class":816},"         -i.bak",[86,6211,6212],{"class":121}," /etc/yum.repos.d/rpmfusion",[86,6214,6215],{"class":184},"*",[86,6217,6218],{"class":121},".repo\n",[948,6220,6222,6223],{"id":6221},"dnf-操作默认使用-yn","dnf 操作默认使用 ",[86,6224,6225],{},"Y/n",[78,6227,6229],{"className":1043,"code":6228,"language":1045,"meta":69,"style":69},"sudo sh -c \"echo 'defaultyes=True' >> /etc/dnf/dnf.conf\"\n",[60,6230,6231],{"__ignoreMap":69},[86,6232,6233,6235,6238,6241],{"class":88,"line":89},[86,6234,6065],{"class":99},[86,6236,6237],{"class":121}," sh",[86,6239,6240],{"class":816}," -c",[86,6242,6243],{"class":121}," \"echo 'defaultyes=True' >> /etc/dnf/dnf.conf\"\n",[948,6245,6246],{"id":6246},"移除不想要的软件",[1682,6248,6249],{"id":6249},"libreoffice",[78,6251,6253],{"className":1043,"code":6252,"language":1045,"meta":69,"style":69},"sudo dnf remove libreoffice*\n",[60,6254,6255],{"__ignoreMap":69},[86,6256,6257,6259,6262,6265,6268],{"class":88,"line":89},[86,6258,6065],{"class":99},[86,6260,6261],{"class":121}," dnf",[86,6263,6264],{"class":121}," remove",[86,6266,6267],{"class":121}," libreoffice",[86,6269,6270],{"class":184},"*\n",[1682,6272,6274],{"id":6273},"discover-flatpak","discover, flatpak",[78,6276,6278],{"className":1043,"code":6277,"language":1045,"meta":69,"style":69},"sudo dnf remove discover flatpak\n",[60,6279,6280],{"__ignoreMap":69},[86,6281,6282,6284,6286,6288,6291],{"class":88,"line":89},[86,6283,6065],{"class":99},[86,6285,6261],{"class":121},[86,6287,6264],{"class":121},[86,6289,6290],{"class":121}," discover",[86,6292,6293],{"class":121}," flatpak\n",[1682,6295,6296],{"id":6296},"podman",[78,6298,6300],{"className":1043,"code":6299,"language":1045,"meta":69,"style":69},"sudo dnf remove podman\n",[60,6301,6302],{"__ignoreMap":69},[86,6303,6304,6306,6308,6310],{"class":88,"line":89},[86,6305,6065],{"class":99},[86,6307,6261],{"class":121},[86,6309,6264],{"class":121},[86,6311,6312],{"class":121}," podman\n",[948,6314,6316],{"id":6315},"关闭-selinux","关闭 selinux",[78,6318,6320],{"className":1043,"code":6319,"language":1045,"meta":69,"style":69},"sudo sed -i \"s|SELINUX=enforcing|SELINUX=disabled|\" /etc/selinux/config\n",[60,6321,6322],{"__ignoreMap":69},[86,6323,6324,6326,6328,6331,6334],{"class":88,"line":89},[86,6325,6065],{"class":99},[86,6327,6068],{"class":121},[86,6329,6330],{"class":816}," -i",[86,6332,6333],{"class":121}," \"s|SELINUX=enforcing|SELINUX=disabled|\"",[86,6335,6336],{"class":121}," /etc/selinux/config\n",[948,6338,6340],{"id":6339},"vlcmpvffmpeg-补全大部分编码器","vlc，mpv，ffmpeg （补全大部分编码器）",[78,6342,6344],{"className":1043,"code":6343,"language":1045,"meta":69,"style":69},"sudo dnf install vlc mpv ffmpeg --allowerasing\n",[60,6345,6346],{"__ignoreMap":69},[86,6347,6348,6350,6352,6354,6357,6360,6363],{"class":88,"line":89},[86,6349,6065],{"class":99},[86,6351,6261],{"class":121},[86,6353,6115],{"class":121},[86,6355,6356],{"class":121}," vlc",[86,6358,6359],{"class":121}," mpv",[86,6361,6362],{"class":121}," ffmpeg",[86,6364,6365],{"class":816}," --allowerasing\n",[948,6367,6368],{"id":6368},"docker",[78,6370,6372],{"className":1043,"code":6371,"language":1045,"meta":69,"style":69},"sudo dnf install docker\n",[60,6373,6374],{"__ignoreMap":69},[86,6375,6376,6378,6380,6382],{"class":88,"line":89},[86,6377,6065],{"class":99},[86,6379,6261],{"class":121},[86,6381,6115],{"class":121},[86,6383,6384],{"class":121}," docker\n",[948,6386,6387],{"id":6387},"rustdesk",[20,6389,6390],{},"直接去官方的 Github Release 下载安装包",[78,6392,6394],{"className":1043,"code":6393,"language":1045,"meta":69,"style":69},"sudo dnf install https://github.com/rustdesk/rustdesk/releases/download/1.3.2/rustdesk-1.3.2-0.x86_64.rpm\n",[60,6395,6396],{"__ignoreMap":69},[86,6397,6398,6400,6402,6404],{"class":88,"line":89},[86,6399,6065],{"class":99},[86,6401,6261],{"class":121},[86,6403,6115],{"class":121},[86,6405,6406],{"class":121}," https://github.com/rustdesk/rustdesk/releases/download/1.3.2/rustdesk-1.3.2-0.x86_64.rpm\n",[17,6408,6409],{},[20,6410,6411],{},"尽管 Rustdesk 支持被控端使用 wayland，但因为权限原因需要被控端手动选择被控区域，不适合无人值守的环境，因此还是要换 x11。",[1682,6413,6415],{"id":6414},"安装-x11-支持","安装 x11 支持",[78,6417,6419],{"className":1043,"code":6418,"language":1045,"meta":69,"style":69},"sudo dnf install plasma-workspace-x11\n",[60,6420,6421],{"__ignoreMap":69},[86,6422,6423,6425,6427,6429],{"class":88,"line":89},[86,6424,6065],{"class":99},[86,6426,6261],{"class":121},[86,6428,6115],{"class":121},[86,6430,6431],{"class":121}," plasma-workspace-x11\n",[1682,6433,6435],{"id":6434},"使用-x11-启动-sddm","使用 x11 启动 sddm",[78,6437,6439],{"className":1043,"code":6438,"language":1045,"meta":69,"style":69},"sudo sed -i \"s|^#DisplayServer=wayland|DisplayServer=x11|\" /etc/sddm.conf\n",[60,6440,6441],{"__ignoreMap":69},[86,6442,6443,6445,6447,6449,6452],{"class":88,"line":89},[86,6444,6065],{"class":99},[86,6446,6068],{"class":121},[86,6448,6330],{"class":816},[86,6450,6451],{"class":121}," \"s|^#DisplayServer=wayland|DisplayServer=x11|\"",[86,6453,6454],{"class":121}," /etc/sddm.conf\n",[948,6456,6457],{"id":6457},"开发相关",[78,6459,6461],{"className":1043,"code":6460,"language":1045,"meta":69,"style":69},"sudo dnf install gcc g++ python3-devel\n",[60,6462,6463],{"__ignoreMap":69},[86,6464,6465,6467,6469,6471,6474,6477],{"class":88,"line":89},[86,6466,6065],{"class":99},[86,6468,6261],{"class":121},[86,6470,6115],{"class":121},[86,6472,6473],{"class":121}," gcc",[86,6475,6476],{"class":121}," g++",[86,6478,6479],{"class":121}," python3-devel\n",[948,6481,6483],{"id":6482},"解除-systemd-resolved-53-端口占用","解除 systemd-resolved 53 端口占用",[20,6485,6486,6487,6490],{},"编辑 ",[60,6488,6489],{},"/usr/lib/systemd/resolved.conf","，取消注释，yes 改 no",[78,6492,6494],{"className":5543,"code":6493,"language":5545,"meta":69,"style":69},"[Resolve]\n# Some examples of DNS servers which may be used for DNS= and FallbackDNS=:\n\n//...\n\n#DNS=\n#FallbackDNS=\n#Domains=\n#DNSSEC=no\n#DNSOverTLS=no\n#MulticastDNS=yes\n#LLMNR=yes\n#Cache=yes\n#CacheFromLocalhost=no\n-#DNSStubListener=yes\n+DNSStubListener=no\n#DNSStubListenerExtra=\n#ReadEtcHosts=yes\n#ResolveUnicastSingleLabel=no\n#StaleRetentionSec=0\n",[60,6495,6496,6501,6506,6510,6515,6519,6524,6529,6534,6539,6544,6549,6554,6559,6564,6569,6574,6579,6584,6589],{"__ignoreMap":69},[86,6497,6498],{"class":88,"line":89},[86,6499,6500],{"class":103},"[Resolve]\n",[86,6502,6503],{"class":88,"line":107},[86,6504,6505],{"class":1714},"# Some examples of DNS servers which may be used for DNS= and FallbackDNS=:\n",[86,6507,6508],{"class":88,"line":128},[86,6509,147],{"emptyLinePlaceholder":146},[86,6511,6512],{"class":88,"line":143},[86,6513,6514],{"class":103},"//...\n",[86,6516,6517],{"class":88,"line":150},[86,6518,147],{"emptyLinePlaceholder":146},[86,6520,6521],{"class":88,"line":3},[86,6522,6523],{"class":1714},"#DNS=\n",[86,6525,6526],{"class":88,"line":207},[86,6527,6528],{"class":1714},"#FallbackDNS=\n",[86,6530,6531],{"class":88,"line":232},[86,6532,6533],{"class":1714},"#Domains=\n",[86,6535,6536],{"class":88,"line":255},[86,6537,6538],{"class":1714},"#DNSSEC=no\n",[86,6540,6541],{"class":88,"line":277},[86,6542,6543],{"class":1714},"#DNSOverTLS=no\n",[86,6545,6546],{"class":88,"line":304},[86,6547,6548],{"class":1714},"#MulticastDNS=yes\n",[86,6550,6551],{"class":88,"line":322},[86,6552,6553],{"class":1714},"#LLMNR=yes\n",[86,6555,6556],{"class":88,"line":328},[86,6557,6558],{"class":1714},"#Cache=yes\n",[86,6560,6561],{"class":88,"line":337},[86,6562,6563],{"class":1714},"#CacheFromLocalhost=no\n",[86,6565,6566],{"class":88,"line":513},[86,6567,6568],{"class":291},"-#DNSStubListener=yes\n",[86,6570,6571],{"class":88,"line":519},[86,6572,6573],{"class":121},"+DNSStubListener=no\n",[86,6575,6576],{"class":88,"line":537},[86,6577,6578],{"class":1714},"#DNSStubListenerExtra=\n",[86,6580,6581],{"class":88,"line":792},[86,6582,6583],{"class":1714},"#ReadEtcHosts=yes\n",[86,6585,6586],{"class":88,"line":797},[86,6587,6588],{"class":1714},"#ResolveUnicastSingleLabel=no\n",[86,6590,6591],{"class":88,"line":822},[86,6592,6593],{"class":1714},"#StaleRetentionSec=0\n",[948,6595,6597],{"id":6596},"配置-fcitx5","配置 fcitx5",[78,6599,6601],{"className":1043,"code":6600,"language":1045,"meta":69,"style":69},"sudo dnf install fcitx5-chinese-addons kcm-fcitx5 fcitx5-autostart\n",[60,6602,6603],{"__ignoreMap":69},[86,6604,6605,6607,6609,6611,6614,6617],{"class":88,"line":89},[86,6606,6065],{"class":99},[86,6608,6261],{"class":121},[86,6610,6115],{"class":121},[86,6612,6613],{"class":121}," fcitx5-chinese-addons",[86,6615,6616],{"class":121}," kcm-fcitx5",[86,6618,6619],{"class":121}," fcitx5-autostart\n",[20,6621,6622],{},"在 设置 - 输入法 中添加拼音",[1682,6624,6625],{"id":6625},"安装词库",[20,6627,6628],{},[30,6629,6630],{"href":6630,"rel":6631},"https://github.com/felixonmars/fcitx5-pinyin-zhwiki",[41],[20,6633,6634],{},[30,6635,6636],{"href":6636,"rel":6637},"https://github.com/outloudvi/mw2fcitx",[41],[1682,6639,6641],{"id":6640},"在-wayland-下使用","在 wayland 下使用",[20,6643,6092,6644],{},[30,6645,6647],{"href":6646},"/2022/07/03/fcitx5-blinking-on-tg-under-wayland-kde/","处理 fcitx5 的文字候选框在 tg 客户端上闪烁的问题",[78,6649,6651],{"className":5543,"code":6650,"language":5545,"meta":69,"style":69},"if [ ! \"$XDG_SESSION_TYPE\" = \"tty\" ]   # if this is a gui session (not tty)\nthen\n    # let's use fcitx instead of fcitx5 to make flatpak happy\n    # this may break behavior for users who have installed both\n    # fcitx and fcitx5, let then change the file on their own\n\n    export INPUT_METHOD=fcitx\n    export GTK_IM_MODULE=fcitx\n    export QT_IM_MODULE=fcitx\n    export XMODIFIERS=@im=fcitx\nfi\n+if [ \"$XDG_SESSION_TYPE\" = \"wayland\" ]\n+then\n+        unset QT_IM_MODULE\n+fi\n",[60,6652,6653,6658,6663,6668,6673,6678,6682,6687,6692,6697,6702,6707,6712,6717,6722],{"__ignoreMap":69},[86,6654,6655],{"class":88,"line":89},[86,6656,6657],{"class":103},"if [ ! \"$XDG_SESSION_TYPE\" = \"tty\" ]   # if this is a gui session (not tty)\n",[86,6659,6660],{"class":88,"line":107},[86,6661,6662],{"class":103},"then\n",[86,6664,6665],{"class":88,"line":128},[86,6666,6667],{"class":103},"    # let's use fcitx instead of fcitx5 to make flatpak happy\n",[86,6669,6670],{"class":88,"line":143},[86,6671,6672],{"class":103},"    # this may break behavior for users who have installed both\n",[86,6674,6675],{"class":88,"line":150},[86,6676,6677],{"class":103},"    # fcitx and fcitx5, let then change the file on their own\n",[86,6679,6680],{"class":88,"line":3},[86,6681,147],{"emptyLinePlaceholder":146},[86,6683,6684],{"class":88,"line":207},[86,6685,6686],{"class":103},"    export INPUT_METHOD=fcitx\n",[86,6688,6689],{"class":88,"line":232},[86,6690,6691],{"class":103},"    export GTK_IM_MODULE=fcitx\n",[86,6693,6694],{"class":88,"line":255},[86,6695,6696],{"class":103},"    export QT_IM_MODULE=fcitx\n",[86,6698,6699],{"class":88,"line":277},[86,6700,6701],{"class":103},"    export XMODIFIERS=@im=fcitx\n",[86,6703,6704],{"class":88,"line":304},[86,6705,6706],{"class":103},"fi\n",[86,6708,6709],{"class":88,"line":322},[86,6710,6711],{"class":121},"+if [ \"$XDG_SESSION_TYPE\" = \"wayland\" ]\n",[86,6713,6714],{"class":88,"line":328},[86,6715,6716],{"class":121},"+then\n",[86,6718,6719],{"class":88,"line":337},[86,6720,6721],{"class":121},"+        unset QT_IM_MODULE\n",[86,6723,6724],{"class":88,"line":513},[86,6725,6726],{"class":121},"+fi\n",[20,6728,6729],{},"然后仍然要去 设置 - 键盘 - 虚拟键盘 中选中 fcitx5",[948,6731,6733],{"id":6732},"安装-vscode","安装 vscode",[78,6735,6737],{"className":1043,"code":6736,"language":1045,"meta":69,"style":69},"sudo rpm --import https://packages.microsoft.com/keys/microsoft.asc\necho -e \"[code]\\nname=Visual Studio Code\\nbaseurl=https://packages.microsoft.com/yumrepos/vscode\\nenabled=1\\ngpgcheck=1\\ngpgkey=https://packages.microsoft.com/keys/microsoft.asc\" | sudo tee /etc/yum.repos.d/vscode.repo > /dev/null\nsudo dnf install code\n",[60,6738,6739,6752,6778],{"__ignoreMap":69},[86,6740,6741,6743,6746,6749],{"class":88,"line":89},[86,6742,6065],{"class":99},[86,6744,6745],{"class":121}," rpm",[86,6747,6748],{"class":816}," --import",[86,6750,6751],{"class":121}," https://packages.microsoft.com/keys/microsoft.asc\n",[86,6753,6754,6757,6759,6762,6764,6766,6769,6772,6775],{"class":88,"line":107},[86,6755,6756],{"class":117},"echo",[86,6758,6071],{"class":816},[86,6760,6761],{"class":121}," \"[code]\\nname=Visual Studio Code\\nbaseurl=https://packages.microsoft.com/yumrepos/vscode\\nenabled=1\\ngpgcheck=1\\ngpgkey=https://packages.microsoft.com/keys/microsoft.asc\"",[86,6763,3065],{"class":103},[86,6765,6065],{"class":99},[86,6767,6768],{"class":121}," tee",[86,6770,6771],{"class":121}," /etc/yum.repos.d/vscode.repo",[86,6773,6774],{"class":103}," > ",[86,6776,6777],{"class":121},"/dev/null\n",[86,6779,6780,6782,6784,6786],{"class":88,"line":128},[86,6781,6065],{"class":99},[86,6783,6261],{"class":121},[86,6785,6115],{"class":121},[86,6787,6788],{"class":121}," code\n",[948,6790,6791],{"id":6791},"网络优化工具",[20,6793,6794],{},"略",[948,6796,6797],{"id":6797},"禁用防火墙",[78,6799,6801],{"className":1043,"code":6800,"language":1045,"meta":69,"style":69},"sudo systemctl disable firewalld --now\n",[60,6802,6803],{"__ignoreMap":69},[86,6804,6805,6807,6810,6813,6816],{"class":88,"line":89},[86,6806,6065],{"class":99},[86,6808,6809],{"class":121}," systemctl",[86,6811,6812],{"class":121}," disable",[86,6814,6815],{"class":121}," firewalld",[86,6817,6818],{"class":816}," --now\n",[948,6820,6822],{"id":6821},"rpm-构建","RPM 构建",[20,6824,6092,6825],{},[30,6826,6828],{"href":6827},"/2024/05/03/open-rpmbuild-in-the-way-of-archlinux-makepkg/","以 Archlinux 中 makepkg 的方式打开 rpmbuild",[933,6830,6831],{},"html pre.shiki code .sAdtL, html code.shiki .sAdtL{--shiki-default:#4078F2;--shiki-dark:#61AFEF}html pre.shiki code .sDhpE, html code.shiki .sDhpE{--shiki-default:#50A14F;--shiki-dark:#98C379}html pre.shiki code .sAGMh, html code.shiki .sAGMh{--shiki-default:#986801;--shiki-dark:#D19A66}html .default .shiki span {color: var(--shiki-default);background: var(--shiki-default-bg);font-style: var(--shiki-default-font-style);font-weight: var(--shiki-default-font-weight);text-decoration: var(--shiki-default-text-decoration);}html .shiki span {color: var(--shiki-default);background: var(--shiki-default-bg);font-style: var(--shiki-default-font-style);font-weight: var(--shiki-default-font-weight);text-decoration: var(--shiki-default-text-decoration);}html .dark .shiki span {color: var(--shiki-dark);background: var(--shiki-dark-bg);font-style: var(--shiki-dark-font-style);font-weight: var(--shiki-dark-font-weight);text-decoration: var(--shiki-dark-text-decoration);}html.dark .shiki span {color: var(--shiki-dark);background: var(--shiki-dark-bg);font-style: var(--shiki-dark-font-style);font-weight: var(--shiki-dark-font-weight);text-decoration: var(--shiki-dark-text-decoration);}html pre.shiki code .s5ixo, html code.shiki .s5ixo{--shiki-default:#383A42;--shiki-dark:#ABB2BF}html pre.shiki code .s_Sar, html code.shiki .s_Sar{--shiki-default:#0184BC;--shiki-dark:#56B6C2}html pre.shiki code .s2QsP, html code.shiki .s2QsP{--shiki-default:#E45649;--shiki-dark:#E5C07B}html pre.shiki code .sW2Sy, html code.shiki .sW2Sy{--shiki-default:#A0A1A7;--shiki-default-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic}html pre.shiki code .sJa8x, html code.shiki .sJa8x{--shiki-default:#E45649;--shiki-dark:#E06C75}",{"title":69,"searchDepth":107,"depth":107,"links":6833},[6834,6835,6836,6838,6843,6844,6845,6846,6850,6851,6852,6856,6857,6858,6859],{"id":6047,"depth":107,"text":6047},{"id":6088,"depth":107,"text":6089},{"id":6221,"depth":107,"text":6837},"dnf 操作默认使用 Y/n",{"id":6246,"depth":107,"text":6246,"children":6839},[6840,6841,6842],{"id":6249,"depth":128,"text":6249},{"id":6273,"depth":128,"text":6274},{"id":6296,"depth":128,"text":6296},{"id":6315,"depth":107,"text":6316},{"id":6339,"depth":107,"text":6340},{"id":6368,"depth":107,"text":6368},{"id":6387,"depth":107,"text":6387,"children":6847},[6848,6849],{"id":6414,"depth":128,"text":6415},{"id":6434,"depth":128,"text":6435},{"id":6457,"depth":107,"text":6457},{"id":6482,"depth":107,"text":6483},{"id":6596,"depth":107,"text":6597,"children":6853},[6854,6855],{"id":6625,"depth":128,"text":6625},{"id":6640,"depth":128,"text":6641},{"id":6732,"depth":107,"text":6733},{"id":6791,"depth":107,"text":6791},{"id":6797,"depth":107,"text":6797},{"id":6821,"depth":107,"text":6822},{"title":6861,"date":6862,"path":6863,"tags":6864,"body":6866},"为 Hexo 添加 follow 认证","2024-10-23 23:11:32","/2024/10/23/follow-cert-for-hexo-feed",[5526,6865],"Follow",{"type":14,"value":6867,"toc":7307},[6868,6871,6874,6879,6882,6885,6891,6898,6904,6910,6921,6976,7024,7027,7030,7039,7050,7144,7150,7155,7158,7210,7290,7292,7295,7297,7304],[948,6869,6870],{"id":6870},"前言",[20,6872,6873],{},"Follow 从今天开始不需要邀请码就可以开始使用部分功能了，除了只能订阅五个订阅源、成就系统没开放、签到不能获得 power 以外，还有部分功能没有解锁（如下图）",[20,6875,6876],{},[67,6877],{"alt":69,"src":6878},"https://static.031130.xyz/uploads/2024/10/23/d3a69a7bcde58.webp",[20,6880,6881],{},"我注意到 Follow 的认证机制目前对于 Hexo 用户还是相对不友好的，起码对于 Hexo 用户来说。",[20,6883,6884],{},"「内容」方案要我们在网页（也可能是 rss，follow 没有给出非常明确的指示）上添加非常明显的一段文本，我并不是很喜欢这种行为。",[78,6886,6889],{"className":6887,"code":6888,"language":363},[1425],"This message is used to verify that this feed (feedId:56144913816835091) belongs to me (userId:70410173045150720). Join me in enjoying the next generation information browser https://follow.is.\n",[60,6890,6888],{"__ignoreMap":69},[20,6892,6893,6894,6897],{},"「描述」方案要求我们在 rss 的 xml 文件的 ",[60,6895,6896],{},"\u003Cdescription />"," 字段添加一段丑丑的代码。无论是使用 follow 的读者还是其他 rss reader 的读者都会看到博客的 description 中含有一段丑丑的代码，这对于强迫症的我来说是无法忍受的，更别提 atom 类型的订阅根本没有这个字段。",[78,6899,6902],{"className":6900,"code":6901,"language":363},[1425],"feedId:56144913816835091+userId:70410173045150720\n",[60,6903,6901],{"__ignoreMap":69},[20,6905,6906],{},[67,6907],{"alt":6908,"src":6909},"即使是在 follow 中，这样的文字也是非常眨眼","https://static.031130.xyz/uploads/2024/10/23/10dfda54f4dcc.webp",[20,6911,6912,6913,6916,6917,6920],{},"「RSS 标签」方案是我唯一能接受的方案，这个方案需要我们在 rss 的 xml 文件中添加一个名为 ",[60,6914,6915],{},"\u003Cfollow_challenge>"," 的标签，或者是 json 文件中的一个 ",[60,6918,6919],{},"follow_challenge"," 对象。虽然具有一定的侵入性，但对于读者来说不会受到影响——应该没有除了 follow 以外的 rss reader 对这个字段进行解析。",[78,6922,6926],{"className":6923,"code":6924,"language":6925,"meta":69,"style":69},"language-xml shiki shiki-themes one-light one-dark-pro","\u003Cfollow_challenge>\n    \u003CfeedId>56144913816835091\u003C/feedId>\n    \u003CuserId>70410173045150720\u003C/userId>\n\u003C/follow_challenge>\n","xml",[60,6927,6928,6938,6953,6967],{"__ignoreMap":69},[86,6929,6930,6933,6935],{"class":88,"line":89},[86,6931,6932],{"class":103},"\u003C",[86,6934,6919],{"class":291},[86,6936,6937],{"class":103},">\n",[86,6939,6940,6943,6946,6949,6951],{"class":88,"line":107},[86,6941,6942],{"class":103},"    \u003C",[86,6944,6945],{"class":291},"feedId",[86,6947,6948],{"class":103},">56144913816835091\u003C/",[86,6950,6945],{"class":291},[86,6952,6937],{"class":103},[86,6954,6955,6957,6960,6963,6965],{"class":88,"line":128},[86,6956,6942],{"class":103},[86,6958,6959],{"class":291},"userId",[86,6961,6962],{"class":103},">70410173045150720\u003C/",[86,6964,6959],{"class":291},[86,6966,6937],{"class":103},[86,6968,6969,6972,6974],{"class":88,"line":143},[86,6970,6971],{"class":103},"\u003C/",[86,6973,6919],{"class":291},[86,6975,6937],{"class":103},[78,6977,6979],{"className":4634,"code":6978,"language":271,"meta":69,"style":69},"{\n  \"follow_challenge\": {\n    \"feed_id\": \"56144913816835091\",\n    \"user_id\": \"70410173045150720\"\n  }\n}\n",[60,6980,6981,6986,6994,7006,7016,7020],{"__ignoreMap":69},[86,6982,6983],{"class":88,"line":89},[86,6984,6985],{"class":103},"{\n",[86,6987,6988,6991],{"class":88,"line":107},[86,6989,6990],{"class":291},"  \"follow_challenge\"",[86,6992,6993],{"class":103},": {\n",[86,6995,6996,6999,7001,7004],{"class":88,"line":128},[86,6997,6998],{"class":291},"    \"feed_id\"",[86,7000,4656],{"class":103},[86,7002,7003],{"class":121},"\"56144913816835091\"",[86,7005,404],{"class":103},[86,7007,7008,7011,7013],{"class":88,"line":143},[86,7009,7010],{"class":291},"    \"user_id\"",[86,7012,4656],{"class":103},[86,7014,7015],{"class":121},"\"70410173045150720\"\n",[86,7017,7018],{"class":88,"line":150},[86,7019,1977],{"class":103},[86,7021,7022],{"class":88,"line":3},[86,7023,340],{"class":103},[948,7025,7026],{"id":7026},"正篇",[20,7028,7029],{},"那么问题来了，Hexo 用户应该如何使用「RSS 标签」的方案给我们的博客进行 Follow 认证呢？",[20,7031,7032,7033,7038],{},"首先确认前提，我在使用 ",[30,7034,7037],{"href":7035,"rel":7036},"https://github.com/hexojs/hexo-generator-feed",[41],"hexo-generator-feed"," 这个 npm 库来生成 Hexo 博客的 rss 订阅文件。",[20,7040,7041,7042,7045,7046,7049],{},"在项目的 README 文件中，我们知道可以在 ",[60,7043,7044],{},"_config.yml"," 文件中指定 rss 生成时使用的模板文件。模板文件位于 ",[60,7047,7048],{},"./node_modules/hexo-generator-feed"," 路径下，atom.xml 和 rss2.xml 就是这个库所使用的模板文件。我正在使用 atom，所以我把 atom.xml 复制一份放到博客的根目录下魔改模板。下面是 _config.yml 的 feed 配置，你可以看到我在最后两行指定了 template 模板文件。",[78,7051,7055],{"className":7052,"code":7053,"language":7054,"meta":69,"style":69},"language-yml shiki shiki-themes one-light one-dark-pro","feed:\n    type: atom\n    path: rss.xml\n    limit: 0\n    hub:\n    content: true\n    content_limit:\n    content_limit_delim: ' '\n    template:\n      - atom.xml\n","yml",[60,7056,7057,7065,7075,7085,7095,7102,7112,7119,7129,7136],{"__ignoreMap":69},[86,7058,7059,7062],{"class":88,"line":89},[86,7060,7061],{"class":291},"feed",[86,7063,7064],{"class":103},":\n",[86,7066,7067,7070,7072],{"class":88,"line":107},[86,7068,7069],{"class":291},"    type",[86,7071,4656],{"class":103},[86,7073,7074],{"class":121},"atom\n",[86,7076,7077,7080,7082],{"class":88,"line":128},[86,7078,7079],{"class":291},"    path",[86,7081,4656],{"class":103},[86,7083,7084],{"class":121},"rss.xml\n",[86,7086,7087,7090,7092],{"class":88,"line":143},[86,7088,7089],{"class":291},"    limit",[86,7091,4656],{"class":103},[86,7093,7094],{"class":816},"0\n",[86,7096,7097,7100],{"class":88,"line":150},[86,7098,7099],{"class":291},"    hub",[86,7101,7064],{"class":103},[86,7103,7104,7107,7109],{"class":88,"line":3},[86,7105,7106],{"class":291},"    content",[86,7108,4656],{"class":103},[86,7110,7111],{"class":816},"true\n",[86,7113,7114,7117],{"class":88,"line":207},[86,7115,7116],{"class":291},"    content_limit",[86,7118,7064],{"class":103},[86,7120,7121,7124,7126],{"class":88,"line":232},[86,7122,7123],{"class":291},"    content_limit_delim",[86,7125,4656],{"class":103},[86,7127,7128],{"class":121},"' '\n",[86,7130,7131,7134],{"class":88,"line":255},[86,7132,7133],{"class":291},"    template",[86,7135,7064],{"class":103},[86,7137,7138,7141],{"class":88,"line":277},[86,7139,7140],{"class":103},"      - ",[86,7142,7143],{"class":121},"atom.xml\n",[20,7145,7146,7147,7149],{},"如果是个人用途，其实可以直接硬编码，在文件的倒数第二行把我们复制的 ",[60,7148,6915],{}," 放进去。",[20,7151,7152],{},[67,7153],{"alt":69,"src":7154},"https://static.031130.xyz/uploads/2024/10/23/fae341d7985ea.webp",[20,7156,7157],{},"或者如果我们想要写得考究一些，那么可以是下面这个样子的",[78,7159,7161],{"className":7052,"code":7160,"language":7054,"meta":69,"style":69},"feed:\n  template:\n    - atom.xml\n  follow_challenge:\n    feedId: 56144913816835091\n    userId: 70410173045150720\n",[60,7162,7163,7169,7176,7183,7190,7200],{"__ignoreMap":69},[86,7164,7165,7167],{"class":88,"line":89},[86,7166,7061],{"class":291},[86,7168,7064],{"class":103},[86,7170,7171,7174],{"class":88,"line":107},[86,7172,7173],{"class":291},"  template",[86,7175,7064],{"class":103},[86,7177,7178,7181],{"class":88,"line":128},[86,7179,7180],{"class":103},"    - ",[86,7182,7143],{"class":121},[86,7184,7185,7188],{"class":88,"line":143},[86,7186,7187],{"class":291},"  follow_challenge",[86,7189,7064],{"class":103},[86,7191,7192,7195,7197],{"class":88,"line":150},[86,7193,7194],{"class":291},"    feedId",[86,7196,4656],{"class":103},[86,7198,7199],{"class":816},"56144913816835091\n",[86,7201,7202,7205,7207],{"class":88,"line":3},[86,7203,7204],{"class":291},"    userId",[86,7206,4656],{"class":103},[86,7208,7209],{"class":816},"70410173045150720\n",[78,7211,7213],{"className":6923,"code":7212,"language":6925,"meta":69,"style":69},"\u003C!-- //... -->\n  {% endfor %}\n  {% if config.feed.follow_challenge %}\n    \u003Cfollow_challenge>\n      \u003CfeedId>{{ config.feed.follow_challenge.feedId }}\u003C/feedId>\n      \u003CuserId>{{ config.feed.follow_challenge.userId }}\u003C/userId>\n    \u003C/follow_challenge>\n  {% endif %}\n\u003C/feed>\n",[60,7214,7215,7223,7228,7233,7241,7255,7268,7277,7282],{"__ignoreMap":69},[86,7216,7217,7220],{"class":88,"line":89},[86,7218,7219],{"class":1714},"\u003C!--",[86,7221,7222],{"class":1714}," //... -->\n",[86,7224,7225],{"class":88,"line":107},[86,7226,7227],{"class":103},"  {% endfor %}\n",[86,7229,7230],{"class":88,"line":128},[86,7231,7232],{"class":103},"  {% if config.feed.follow_challenge %}\n",[86,7234,7235,7237,7239],{"class":88,"line":143},[86,7236,6942],{"class":103},[86,7238,6919],{"class":291},[86,7240,6937],{"class":103},[86,7242,7243,7246,7248,7251,7253],{"class":88,"line":150},[86,7244,7245],{"class":103},"      \u003C",[86,7247,6945],{"class":291},[86,7249,7250],{"class":103},">{{ config.feed.follow_challenge.feedId }}\u003C/",[86,7252,6945],{"class":291},[86,7254,6937],{"class":103},[86,7256,7257,7259,7261,7264,7266],{"class":88,"line":3},[86,7258,7245],{"class":103},[86,7260,6959],{"class":291},[86,7262,7263],{"class":103},">{{ config.feed.follow_challenge.userId }}\u003C/",[86,7265,6959],{"class":291},[86,7267,6937],{"class":103},[86,7269,7270,7273,7275],{"class":88,"line":207},[86,7271,7272],{"class":103},"    \u003C/",[86,7274,6919],{"class":291},[86,7276,6937],{"class":103},[86,7278,7279],{"class":88,"line":232},[86,7280,7281],{"class":103},"  {% endif %}\n",[86,7283,7284,7286,7288],{"class":88,"line":255},[86,7285,6971],{"class":103},[86,7287,7061],{"class":291},[86,7289,6937],{"class":103},[1673,7291],{},[20,7293,7294],{},"（说起来，这两个小改动一改，其实完全可以上传 npmjs.com 作为一个新的插件，不过我有点懒了）",[1673,7296],{},[20,7298,7299,7300],{},"文末附一个 follow 邀请码: ",[86,7301,7303],{"className":7302},[3523],"6O0oBazB9s",[933,7305,7306],{},"html pre.shiki code .s5ixo, html code.shiki .s5ixo{--shiki-default:#383A42;--shiki-dark:#ABB2BF}html pre.shiki code .sJa8x, html code.shiki .sJa8x{--shiki-default:#E45649;--shiki-dark:#E06C75}html .default .shiki span {color: var(--shiki-default);background: var(--shiki-default-bg);font-style: var(--shiki-default-font-style);font-weight: var(--shiki-default-font-weight);text-decoration: var(--shiki-default-text-decoration);}html .shiki span {color: var(--shiki-default);background: var(--shiki-default-bg);font-style: var(--shiki-default-font-style);font-weight: var(--shiki-default-font-weight);text-decoration: var(--shiki-default-text-decoration);}html .dark .shiki span {color: var(--shiki-dark);background: var(--shiki-dark-bg);font-style: var(--shiki-dark-font-style);font-weight: var(--shiki-dark-font-weight);text-decoration: var(--shiki-dark-text-decoration);}html.dark .shiki span {color: var(--shiki-dark);background: var(--shiki-dark-bg);font-style: var(--shiki-dark-font-style);font-weight: var(--shiki-dark-font-weight);text-decoration: var(--shiki-dark-text-decoration);}html pre.shiki code .sDhpE, html code.shiki .sDhpE{--shiki-default:#50A14F;--shiki-dark:#98C379}html pre.shiki code .sAGMh, html code.shiki .sAGMh{--shiki-default:#986801;--shiki-dark:#D19A66}html pre.shiki code .sW2Sy, html code.shiki .sW2Sy{--shiki-default:#A0A1A7;--shiki-default-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic}",{"title":69,"searchDepth":107,"depth":107,"links":7308},[7309,7310],{"id":6870,"depth":107,"text":6870},{"id":7026,"depth":107,"text":7026},{"title":7312,"date":7313,"path":7314,"tags":7315,"body":7317},"使用 GPT 对 waline 的评论进行审查","2024-10-12 16:11:06","/2024/10/12/use-gpt-to-review-waline-comments",[5525,7316],"GPT",{"type":14,"value":7318,"toc":8645},[7319,7322,7336,7339,7345,7353,7362,8022,8037,8040,8043,8046,8372,8375,8384,8389,8403,8408,8582,8587,8634,8637,8642],[20,7320,7321],{},"前一阵子收到了这么一条来自 waline 的评论提醒。",[17,7323,7324],{},[20,7325,7326,7327,7331,7332],{},"New comment on 竹林里有冰的博客\n【网站名称】：竹林里有冰的博客\n【评论者昵称】：专业数据库\n【评论者邮箱】：",[30,7328,7330],{"href":7329},"mailto:rakhiranijhhg@gmail.com","rakhiranijhhg@gmail.com","\n【内容】：总之，优化专业数据库对于保持数据准确性、提高系统性能和推动业务成功至关重要。通过遵循本文中概述的策略，您可以提高数据库操作的效率并释放新的增长机会。\n【地址】：",[30,7333,7334],{"href":7334,"rel":7335},"https://zhul.in/2021/04/04/yay-more/#66f7a8889ab78865d5f5ae19",[41],[20,7337,7338],{},"评论的内容不仅透露着一股 AI 味，还和文章内容可谓是一点关系都没有，点开评论者的网站一看，一股塑料机翻味，怕是又是个来蹭 SEO 的广告哥。",[20,7340,7341],{},[67,7342],{"alt":7343,"src":7344},"广告哥留下的网站","https://static.031130.xyz/uploads/2024/10/07/4673580090861.webp",[20,7346,5578,7347,7352],{},[30,7348,7351],{"href":7349,"rel":7350},"https://waline.js.org/advanced/faq.html#%E5%8F%91%E5%B8%83%E8%AF%84%E8%AE%BA%E5%BE%88%E6%85%A2%E6%80%8E%E4%B9%88%E5%8A%9E",[41],"waline 的官方文档","所言，waline 是使用了 Akismet 提供的垃圾内容检测服务的。可惜它似乎对 AI 生成的垃圾没有分辨能力。因此我计划使用 GPT 代替 Akismet 对 waline 的新评论进行审核。",[20,7354,7355,7356,7361],{},"walinejs/plugin 提供了一个 ",[30,7357,7360],{"href":7358,"rel":7359},"https://github.com/walinejs/plugins/blob/master/packages/tencent-tms/index.js",[41],"tencent-cms"," 的插件，功能是使用腾讯云的内容审查接口审查评论内容，这和我们需要的功能很像，主体部分和调用方法可以直接借鉴。",[78,7363,7365],{"className":80,"code":7364,"language":82,"meta":69,"style":69},"// index.js\n\nconst tencentcloud = require(\"tencentcloud-sdk-nodejs-tms\");\nconst TmsClient = tencentcloud.tms.v20201229.Client;\n\n\nmodule.exports = function({secretId, secretKey, region}) {\n  if (!secretId || !secretKey || !region) {\n    return {};\n  }\n\n  const clientConfig = {\n    credential: {\n      secretId,\n      secretKey,\n    },\n    region,\n    profile: {\n      httpProfile: {\n        endpoint: \"tms.tencentcloudapi.com\",\n      },\n    },\n  };\n  \n  return {\n    hooks: {\n      async preSave(data) {\n        const { userInfo } = this.ctx.state;\n        const isAdmin = userInfo.type === 'administrator';\n        // ignore admin comment\n        if (isAdmin) {\n          return;\n        }\n\n        const client = new TmsClient(clientConfig);\n        try {\n          const resp = await client.TextModeration({ Content: data.comment });\n          if (!resp.Suggestion) {\n            throw new Error('Suggestion is empty. Tencent Cloud TMS info:', resp);\n          }\n\n          switch(resp.Suggestion) {\n            case 'Pass':\n              data.status = 'approved';\n              break;\n            case 'Block':\n              data.status = 'spam';\n              break;\n              case 'Review':\n              default:\n                data.status = 'waiting';\n                break;\n          }\n        } catch(e) {\n          console.log(e);\n          data.status = 'waiting';\n        }\n      },\n    },\n  };\n}\n",[60,7366,7367,7372,7376,7395,7423,7427,7431,7464,7489,7496,7500,7504,7515,7524,7531,7538,7542,7549,7558,7567,7579,7584,7588,7593,7597,7603,7612,7626,7654,7678,7683,7694,7701,7705,7709,7729,7736,7773,7792,7812,7817,7821,7836,7846,7862,7869,7879,7895,7902,7913,7921,7938,7946,7951,7965,7981,7997,8002,8007,8012,8017],{"__ignoreMap":69},[86,7368,7369],{"class":88,"line":89},[86,7370,7371],{"class":1714},"// index.js\n",[86,7373,7374],{"class":88,"line":107},[86,7375,147],{"emptyLinePlaceholder":146},[86,7377,7378,7380,7383,7385,7388,7390,7393],{"class":88,"line":128},[86,7379,676],{"class":92},[86,7381,7382],{"class":113}," tencentcloud",[86,7384,118],{"class":117},[86,7386,7387],{"class":99}," require",[86,7389,166],{"class":103},[86,7391,7392],{"class":121},"\"tencentcloud-sdk-nodejs-tms\"",[86,7394,600],{"class":103},[86,7396,7397,7399,7402,7404,7406,7408,7411,7413,7416,7418,7421],{"class":88,"line":143},[86,7398,676],{"class":92},[86,7400,7401],{"class":113}," TmsClient",[86,7403,118],{"class":117},[86,7405,7382],{"class":177},[86,7407,181],{"class":103},[86,7409,7410],{"class":184},"tms",[86,7412,181],{"class":103},[86,7414,7415],{"class":184},"v20201229",[86,7417,181],{"class":103},[86,7419,7420],{"class":291},"Client",[86,7422,125],{"class":103},[86,7424,7425],{"class":88,"line":150},[86,7426,147],{"emptyLinePlaceholder":146},[86,7428,7429],{"class":88,"line":3},[86,7430,147],{"emptyLinePlaceholder":146},[86,7432,7433,7436,7438,7441,7443,7445,7448,7451,7453,7456,7458,7461],{"class":88,"line":207},[86,7434,7435],{"class":184},"module",[86,7437,181],{"class":103},[86,7439,7440],{"class":184},"exports",[86,7442,118],{"class":117},[86,7444,96],{"class":92},[86,7446,7447],{"class":103},"({",[86,7449,7450],{"class":362},"secretId",[86,7452,198],{"class":103},[86,7454,7455],{"class":362},"secretKey",[86,7457,198],{"class":103},[86,7459,7460],{"class":362},"region",[86,7462,7463],{"class":103},"}) {\n",[86,7465,7466,7468,7470,7472,7474,7476,7479,7481,7483,7485,7487],{"class":88,"line":232},[86,7467,1804],{"class":92},[86,7469,283],{"class":103},[86,7471,2487],{"class":117},[86,7473,7450],{"class":201},[86,7475,4097],{"class":117},[86,7477,7478],{"class":117}," !",[86,7480,7455],{"class":201},[86,7482,4097],{"class":117},[86,7484,7478],{"class":117},[86,7486,7460],{"class":201},[86,7488,301],{"class":103},[86,7490,7491,7493],{"class":88,"line":255},[86,7492,331],{"class":92},[86,7494,7495],{"class":103}," {};\n",[86,7497,7498],{"class":88,"line":277},[86,7499,1977],{"class":103},[86,7501,7502],{"class":88,"line":304},[86,7503,147],{"emptyLinePlaceholder":146},[86,7505,7506,7508,7511,7513],{"class":88,"line":322},[86,7507,1777],{"class":92},[86,7509,7510],{"class":113}," clientConfig",[86,7512,118],{"class":117},[86,7514,389],{"class":103},[86,7516,7517,7520,7522],{"class":88,"line":328},[86,7518,7519],{"class":291},"    credential",[86,7521,398],{"class":397},[86,7523,389],{"class":103},[86,7525,7526,7529],{"class":88,"line":337},[86,7527,7528],{"class":201},"      secretId",[86,7530,404],{"class":103},[86,7532,7533,7536],{"class":88,"line":513},[86,7534,7535],{"class":201},"      secretKey",[86,7537,404],{"class":103},[86,7539,7540],{"class":88,"line":519},[86,7541,605],{"class":103},[86,7543,7544,7547],{"class":88,"line":537},[86,7545,7546],{"class":201},"    region",[86,7548,404],{"class":103},[86,7550,7551,7554,7556],{"class":88,"line":792},[86,7552,7553],{"class":291},"    profile",[86,7555,398],{"class":397},[86,7557,389],{"class":103},[86,7559,7560,7563,7565],{"class":88,"line":797},[86,7561,7562],{"class":291},"      httpProfile",[86,7564,398],{"class":397},[86,7566,389],{"class":103},[86,7568,7569,7572,7574,7577],{"class":88,"line":822},[86,7570,7571],{"class":291},"        endpoint",[86,7573,398],{"class":397},[86,7575,7576],{"class":121}," \"tms.tencentcloudapi.com\"",[86,7578,404],{"class":103},[86,7580,7581],{"class":88,"line":871},[86,7582,7583],{"class":103},"      },\n",[86,7585,7586],{"class":88,"line":882},[86,7587,605],{"class":103},[86,7589,7590],{"class":88,"line":899},[86,7591,7592],{"class":103},"  };\n",[86,7594,7595],{"class":88,"line":904},[86,7596,4988],{"class":103},[86,7598,7599,7601],{"class":88,"line":909},[86,7600,2170],{"class":92},[86,7602,389],{"class":103},[86,7604,7605,7608,7610],{"class":88,"line":2259},[86,7606,7607],{"class":291},"    hooks",[86,7609,398],{"class":397},[86,7611,389],{"class":103},[86,7613,7614,7617,7620,7622,7624],{"class":88,"line":2264},[86,7615,7616],{"class":92},"      async",[86,7618,7619],{"class":99}," preSave",[86,7621,166],{"class":103},[86,7623,286],{"class":362},[86,7625,301],{"class":103},[86,7627,7628,7630,7633,7636,7639,7641,7644,7646,7648,7650,7652],{"class":88,"line":2269},[86,7629,636],{"class":92},[86,7631,7632],{"class":103}," { ",[86,7634,7635],{"class":113},"userInfo",[86,7637,7638],{"class":103}," } ",[86,7640,5186],{"class":117},[86,7642,7643],{"class":184}," this",[86,7645,181],{"class":103},[86,7647,580],{"class":184},[86,7649,181],{"class":103},[86,7651,741],{"class":291},[86,7653,125],{"class":103},[86,7655,7656,7658,7661,7663,7666,7668,7671,7673,7676],{"class":88,"line":2274},[86,7657,636],{"class":92},[86,7659,7660],{"class":113}," isAdmin",[86,7662,118],{"class":117},[86,7664,7665],{"class":177}," userInfo",[86,7667,181],{"class":103},[86,7669,7670],{"class":291},"type",[86,7672,1816],{"class":117},[86,7674,7675],{"class":121}," 'administrator'",[86,7677,125],{"class":103},[86,7679,7680],{"class":88,"line":2279},[86,7681,7682],{"class":1714},"        // ignore admin comment\n",[86,7684,7685,7687,7689,7692],{"class":88,"line":2285},[86,7686,800],{"class":92},[86,7688,283],{"class":103},[86,7690,7691],{"class":201},"isAdmin",[86,7693,301],{"class":103},[86,7695,7696,7699],{"class":88,"line":2291},[86,7697,7698],{"class":92},"          return",[86,7700,125],{"class":103},[86,7702,7703],{"class":88,"line":2296},[86,7704,428],{"class":103},[86,7706,7707],{"class":88,"line":2310},[86,7708,147],{"emptyLinePlaceholder":146},[86,7710,7711,7713,7716,7718,7720,7722,7724,7727],{"class":88,"line":2354},[86,7712,636],{"class":92},[86,7714,7715],{"class":113}," client",[86,7717,118],{"class":117},[86,7719,160],{"class":92},[86,7721,7401],{"class":99},[86,7723,166],{"class":103},[86,7725,7726],{"class":201},"clientConfig",[86,7728,600],{"class":103},[86,7730,7731,7734],{"class":88,"line":2359},[86,7732,7733],{"class":92},"        try",[86,7735,389],{"class":103},[86,7737,7738,7741,7744,7746,7748,7750,7752,7755,7758,7761,7763,7765,7767,7770],{"class":88,"line":2364},[86,7739,7740],{"class":92},"          const",[86,7742,7743],{"class":113}," resp",[86,7745,118],{"class":117},[86,7747,242],{"class":92},[86,7749,7715],{"class":177},[86,7751,181],{"class":103},[86,7753,7754],{"class":99},"TextModeration",[86,7756,7757],{"class":103},"({ ",[86,7759,7760],{"class":291},"Content",[86,7762,398],{"class":397},[86,7764,260],{"class":177},[86,7766,181],{"class":103},[86,7768,7769],{"class":291},"comment",[86,7771,7772],{"class":103}," });\n",[86,7774,7775,7778,7780,7782,7785,7787,7790],{"class":88,"line":2369},[86,7776,7777],{"class":92},"          if",[86,7779,283],{"class":103},[86,7781,2487],{"class":117},[86,7783,7784],{"class":177},"resp",[86,7786,181],{"class":103},[86,7788,7789],{"class":291},"Suggestion",[86,7791,301],{"class":103},[86,7793,7794,7797,7799,7801,7803,7806,7808,7810],{"class":88,"line":2375},[86,7795,7796],{"class":92},"            throw",[86,7798,160],{"class":92},[86,7800,312],{"class":99},[86,7802,166],{"class":103},[86,7804,7805],{"class":121},"'Suggestion is empty. Tencent Cloud TMS info:'",[86,7807,198],{"class":103},[86,7809,7784],{"class":201},[86,7811,600],{"class":103},[86,7813,7814],{"class":88,"line":2381},[86,7815,7816],{"class":103},"          }\n",[86,7818,7819],{"class":88,"line":2386},[86,7820,147],{"emptyLinePlaceholder":146},[86,7822,7823,7826,7828,7830,7832,7834],{"class":88,"line":2406},[86,7824,7825],{"class":92},"          switch",[86,7827,166],{"class":103},[86,7829,7784],{"class":177},[86,7831,181],{"class":103},[86,7833,7789],{"class":291},[86,7835,301],{"class":103},[86,7837,7838,7841,7844],{"class":88,"line":2430},[86,7839,7840],{"class":92},"            case",[86,7842,7843],{"class":121}," 'Pass'",[86,7845,7064],{"class":103},[86,7847,7848,7851,7853,7855,7857,7860],{"class":88,"line":2443},[86,7849,7850],{"class":177},"              data",[86,7852,181],{"class":103},[86,7854,2089],{"class":291},[86,7856,118],{"class":117},[86,7858,7859],{"class":121}," 'approved'",[86,7861,125],{"class":103},[86,7863,7864,7867],{"class":88,"line":2449},[86,7865,7866],{"class":92},"              break",[86,7868,125],{"class":103},[86,7870,7872,7874,7877],{"class":88,"line":7871},46,[86,7873,7840],{"class":92},[86,7875,7876],{"class":121}," 'Block'",[86,7878,7064],{"class":103},[86,7880,7882,7884,7886,7888,7890,7893],{"class":88,"line":7881},47,[86,7883,7850],{"class":177},[86,7885,181],{"class":103},[86,7887,2089],{"class":291},[86,7889,118],{"class":117},[86,7891,7892],{"class":121}," 'spam'",[86,7894,125],{"class":103},[86,7896,7898,7900],{"class":88,"line":7897},48,[86,7899,7866],{"class":92},[86,7901,125],{"class":103},[86,7903,7905,7908,7911],{"class":88,"line":7904},49,[86,7906,7907],{"class":92},"              case",[86,7909,7910],{"class":121}," 'Review'",[86,7912,7064],{"class":103},[86,7914,7916,7919],{"class":88,"line":7915},50,[86,7917,7918],{"class":92},"              default",[86,7920,7064],{"class":103},[86,7922,7924,7927,7929,7931,7933,7936],{"class":88,"line":7923},51,[86,7925,7926],{"class":177},"                data",[86,7928,181],{"class":103},[86,7930,2089],{"class":291},[86,7932,118],{"class":117},[86,7934,7935],{"class":121}," 'waiting'",[86,7937,125],{"class":103},[86,7939,7941,7944],{"class":88,"line":7940},52,[86,7942,7943],{"class":92},"                break",[86,7945,125],{"class":103},[86,7947,7949],{"class":88,"line":7948},53,[86,7950,7816],{"class":103},[86,7952,7954,7956,7958,7960,7963],{"class":88,"line":7953},54,[86,7955,874],{"class":103},[86,7957,4133],{"class":92},[86,7959,166],{"class":103},[86,7961,7962],{"class":201},"e",[86,7964,301],{"class":103},[86,7966,7968,7971,7973,7975,7977,7979],{"class":88,"line":7967},55,[86,7969,7970],{"class":177},"          console",[86,7972,181],{"class":103},[86,7974,527],{"class":99},[86,7976,166],{"class":103},[86,7978,7962],{"class":201},[86,7980,600],{"class":103},[86,7982,7984,7987,7989,7991,7993,7995],{"class":88,"line":7983},56,[86,7985,7986],{"class":177},"          data",[86,7988,181],{"class":103},[86,7990,2089],{"class":291},[86,7992,118],{"class":117},[86,7994,7935],{"class":121},[86,7996,125],{"class":103},[86,7998,8000],{"class":88,"line":7999},57,[86,8001,428],{"class":103},[86,8003,8005],{"class":88,"line":8004},58,[86,8006,7583],{"class":103},[86,8008,8010],{"class":88,"line":8009},59,[86,8011,605],{"class":103},[86,8013,8015],{"class":88,"line":8014},60,[86,8016,7592],{"class":103},[86,8018,8020],{"class":88,"line":8019},61,[86,8021,340],{"class":103},[20,8023,8024,8025,8030,8031,8036],{},"可以看到，我们需要在这个被 module.exports 导出的函数中，return 一个对象，如果使用 hooks 编写的话可以调用",[30,8026,8029],{"href":8027,"rel":8028},"https://waline.js.org/reference/server/config.html#%E8%AF%84%E8%AE%BA-hooks",[41],"一些生命周期 hook",": 在 preSave 阶段，我们可以通过标注 data.status 参数来反馈评论类型。approved 为接受，spam 为垃圾邮件，waiting 为等待人工审核；除此之外，还可以",[30,8032,8035],{"href":8033,"rel":8034},"https://waline.js.org/reference/server/plugin.html#%E5%9F%BA%E4%BA%8E%E4%B8%AD%E9%97%B4%E4%BB%B6%E5%88%B6%E4%BD%9C",[41],"基于 Koa 中间件制作插件","，文档中有具体的描述。",[20,8038,8039],{},"index.js 顶部是需要引入的依赖。当然，如果需要引入外部的第三方包的话，需要在 packages.json 中加入需要的依赖（使用包管理器的命令进行安装）。",[20,8041,8042],{},"有了这些基础知识，就能手搓一个基于 GPT 的评论审查插件。",[20,8044,8045],{},"OpenAI 提供的是标准的 Restful API，本身的鉴权逻辑也不复杂，其实没必要调用 SDK，直接使用 fetch 调用就行。",[78,8047,8049],{"className":80,"code":8048,"language":82,"meta":69,"style":69},"const doReview = async (comment) => {\n  const response = await fetch(openaiBaseUrl + '/v1/chat/completions', {\n    method: 'POST',\n    headers: {\n      'Content-Type': 'application/json',\n      'Authorization': `Bearer ${openaiApiKey}`,\n    },\n    body: JSON.stringify({\n      model: openaiModel,\n      messages: [\n        {\n          role: 'system',\n          content: prompt\n        },\n        {\n          role: 'user',\n          content: comment,\n        },\n      ],\n    }),\n  });\n  const data = await response.json();\n  if (data && data.choices && data.choices.length > 0) {\n    return data.choices[0].message.content;\n  } else {\n    return 'waiting';\n  }\n}\n",[60,8050,8051,8073,8097,8109,8118,8130,8151,8155,8170,8182,8191,8196,8208,8218,8222,8226,8237,8248,8252,8257,8262,8267,8285,8321,8348,8356,8364,8368],{"__ignoreMap":69},[86,8052,8053,8055,8058,8060,8063,8065,8067,8069,8071],{"class":88,"line":89},[86,8054,676],{"class":92},[86,8056,8057],{"class":99}," doReview",[86,8059,118],{"class":117},[86,8061,8062],{"class":92}," async",[86,8064,283],{"class":103},[86,8066,7769],{"class":362},[86,8068,2063],{"class":103},[86,8070,5218],{"class":92},[86,8072,389],{"class":103},[86,8074,8075,8077,8079,8081,8083,8085,8087,8090,8092,8095],{"class":88,"line":107},[86,8076,1777],{"class":92},[86,8078,237],{"class":113},[86,8080,118],{"class":117},[86,8082,242],{"class":92},[86,8084,245],{"class":99},[86,8086,166],{"class":103},[86,8088,8089],{"class":201},"openaiBaseUrl",[86,8091,2342],{"class":117},[86,8093,8094],{"class":121}," '/v1/chat/completions'",[86,8096,452],{"class":103},[86,8098,8099,8102,8104,8107],{"class":88,"line":128},[86,8100,8101],{"class":291},"    method",[86,8103,398],{"class":397},[86,8105,8106],{"class":121}," 'POST'",[86,8108,404],{"class":103},[86,8110,8111,8114,8116],{"class":88,"line":143},[86,8112,8113],{"class":291},"    headers",[86,8115,398],{"class":397},[86,8117,389],{"class":103},[86,8119,8120,8123,8125,8128],{"class":88,"line":150},[86,8121,8122],{"class":121},"      'Content-Type'",[86,8124,398],{"class":397},[86,8126,8127],{"class":121}," 'application/json'",[86,8129,404],{"class":103},[86,8131,8132,8135,8137,8140,8142,8145,8147,8149],{"class":88,"line":3},[86,8133,8134],{"class":121},"      'Authorization'",[86,8136,398],{"class":397},[86,8138,8139],{"class":121}," `Bearer ",[86,8141,839],{"class":838},[86,8143,8144],{"class":201},"openaiApiKey",[86,8146,863],{"class":838},[86,8148,866],{"class":121},[86,8150,404],{"class":103},[86,8152,8153],{"class":88,"line":207},[86,8154,605],{"class":103},[86,8156,8157,8160,8162,8164,8166,8168],{"class":88,"line":232},[86,8158,8159],{"class":291},"    body",[86,8161,398],{"class":397},[86,8163,498],{"class":113},[86,8165,181],{"class":103},[86,8167,503],{"class":99},[86,8169,4003],{"class":103},[86,8171,8172,8175,8177,8180],{"class":88,"line":255},[86,8173,8174],{"class":291},"      model",[86,8176,398],{"class":397},[86,8178,8179],{"class":201}," openaiModel",[86,8181,404],{"class":103},[86,8183,8184,8187,8189],{"class":88,"line":277},[86,8185,8186],{"class":291},"      messages",[86,8188,398],{"class":397},[86,8190,5787],{"class":103},[86,8192,8193],{"class":88,"line":304},[86,8194,8195],{"class":103},"        {\n",[86,8197,8198,8201,8203,8206],{"class":88,"line":322},[86,8199,8200],{"class":291},"          role",[86,8202,398],{"class":397},[86,8204,8205],{"class":121}," 'system'",[86,8207,404],{"class":103},[86,8209,8210,8213,8215],{"class":88,"line":328},[86,8211,8212],{"class":291},"          content",[86,8214,398],{"class":397},[86,8216,8217],{"class":201}," prompt\n",[86,8219,8220],{"class":88,"line":337},[86,8221,488],{"class":103},[86,8223,8224],{"class":88,"line":513},[86,8225,8195],{"class":103},[86,8227,8228,8230,8232,8235],{"class":88,"line":519},[86,8229,8200],{"class":291},[86,8231,398],{"class":397},[86,8233,8234],{"class":121}," 'user'",[86,8236,404],{"class":103},[86,8238,8239,8241,8243,8246],{"class":88,"line":537},[86,8240,8212],{"class":291},[86,8242,398],{"class":397},[86,8244,8245],{"class":201}," comment",[86,8247,404],{"class":103},[86,8249,8250],{"class":88,"line":792},[86,8251,488],{"class":103},[86,8253,8254],{"class":88,"line":797},[86,8255,8256],{"class":103},"      ],\n",[86,8258,8259],{"class":88,"line":822},[86,8260,8261],{"class":103},"    }),\n",[86,8263,8264],{"class":88,"line":871},[86,8265,8266],{"class":103},"  });\n",[86,8268,8269,8271,8273,8275,8277,8279,8281,8283],{"class":88,"line":882},[86,8270,1777],{"class":92},[86,8272,260],{"class":113},[86,8274,118],{"class":117},[86,8276,242],{"class":92},[86,8278,237],{"class":177},[86,8280,181],{"class":103},[86,8282,271],{"class":99},[86,8284,1517],{"class":103},[86,8286,8287,8289,8291,8293,8296,8298,8300,8303,8305,8307,8309,8311,8313,8315,8317,8319],{"class":88,"line":899},[86,8288,1804],{"class":92},[86,8290,283],{"class":103},[86,8292,286],{"class":201},[86,8294,8295],{"class":117}," &&",[86,8297,260],{"class":177},[86,8299,181],{"class":103},[86,8301,8302],{"class":291},"choices",[86,8304,8295],{"class":117},[86,8306,260],{"class":177},[86,8308,181],{"class":103},[86,8310,8302],{"class":184},[86,8312,181],{"class":103},[86,8314,810],{"class":291},[86,8316,813],{"class":117},[86,8318,817],{"class":816},[86,8320,301],{"class":103},[86,8322,8323,8325,8327,8329,8331,8334,8336,8339,8341,8343,8346],{"class":88,"line":904},[86,8324,331],{"class":92},[86,8326,260],{"class":177},[86,8328,181],{"class":103},[86,8330,8302],{"class":291},[86,8332,8333],{"class":103},"[",[86,8335,1385],{"class":816},[86,8337,8338],{"class":103},"].",[86,8340,2254],{"class":184},[86,8342,181],{"class":103},[86,8344,8345],{"class":291},"content",[86,8347,125],{"class":103},[86,8349,8350,8352,8354],{"class":88,"line":909},[86,8351,1847],{"class":103},[86,8353,877],{"class":92},[86,8355,389],{"class":103},[86,8357,8358,8360,8362],{"class":88,"line":2259},[86,8359,331],{"class":92},[86,8361,7935],{"class":121},[86,8363,125],{"class":103},[86,8365,8366],{"class":88,"line":2264},[86,8367,1977],{"class":103},[86,8369,8370],{"class":88,"line":2269},[86,8371,340],{"class":103},[20,8373,8374],{},"再配合相应的封装，一款基于 GPT 的 waline 评论审核插件就完成了",[2935,8376,8377],{},[991,8378,8379],{},[30,8380,8383],{"href":8381,"rel":8382},"https://github.com/zhullyb/waline-plugin-llm-reviewer",[41],"zhullyb/waline-plugin-llm-reviewer",[20,8385,8386],{},[924,8387,8388],{},"如何安装",[78,8390,8392],{"className":1043,"code":8391,"language":1045,"meta":69,"style":69},"npm install waline-plugin-llm-reviewer\n",[60,8393,8394],{"__ignoreMap":69},[86,8395,8396,8398,8400],{"class":88,"line":89},[86,8397,1076],{"class":99},[86,8399,6115],{"class":121},[86,8401,8402],{"class":121}," waline-plugin-llm-reviewer\n",[20,8404,8405],{},[924,8406,8407],{},"如何使用",[78,8409,8411],{"className":80,"code":8410,"language":82,"meta":69,"style":69},"// index.js\nconst Waline = require('@waline/vercel');\nconst GPTReviewer = require('waline-plugin-llm-reviewer');\n\nmodule.exports = Waline({\n  plugins: [\n    GptReviewer({\n        openaiBaseUrl: process.env.OPENAI_BASE_URL,\n        openaiModel: process.env.OPENAI_MODEL,\n        openaiApiKey: process.env.OPENAI_API_KEY,\n        openaiPrompt: process.env.OPENAI_PROMPT,\n    })\n  ]\n});\n",[60,8412,8413,8417,8435,8453,8457,8471,8480,8487,8509,8529,8549,8569,8573,8578],{"__ignoreMap":69},[86,8414,8415],{"class":88,"line":89},[86,8416,7371],{"class":1714},[86,8418,8419,8421,8424,8426,8428,8430,8433],{"class":88,"line":107},[86,8420,676],{"class":92},[86,8422,8423],{"class":113}," Waline",[86,8425,118],{"class":117},[86,8427,7387],{"class":99},[86,8429,166],{"class":103},[86,8431,8432],{"class":121},"'@waline/vercel'",[86,8434,600],{"class":103},[86,8436,8437,8439,8442,8444,8446,8448,8451],{"class":88,"line":128},[86,8438,676],{"class":92},[86,8440,8441],{"class":113}," GPTReviewer",[86,8443,118],{"class":117},[86,8445,7387],{"class":99},[86,8447,166],{"class":103},[86,8449,8450],{"class":121},"'waline-plugin-llm-reviewer'",[86,8452,600],{"class":103},[86,8454,8455],{"class":88,"line":143},[86,8456,147],{"emptyLinePlaceholder":146},[86,8458,8459,8461,8463,8465,8467,8469],{"class":88,"line":150},[86,8460,7435],{"class":184},[86,8462,181],{"class":103},[86,8464,7440],{"class":184},[86,8466,118],{"class":117},[86,8468,8423],{"class":99},[86,8470,4003],{"class":103},[86,8472,8473,8476,8478],{"class":88,"line":3},[86,8474,8475],{"class":291},"  plugins",[86,8477,398],{"class":397},[86,8479,5787],{"class":103},[86,8481,8482,8485],{"class":88,"line":207},[86,8483,8484],{"class":99},"    GptReviewer",[86,8486,4003],{"class":103},[86,8488,8489,8492,8494,8497,8499,8501,8503,8507],{"class":88,"line":232},[86,8490,8491],{"class":291},"        openaiBaseUrl",[86,8493,398],{"class":397},[86,8495,8496],{"class":177}," process",[86,8498,181],{"class":103},[86,8500,575],{"class":2634},[86,8502,181],{"class":103},[86,8504,8506],{"class":8505},"sRZ4U","OPENAI_BASE_URL",[86,8508,404],{"class":103},[86,8510,8511,8514,8516,8518,8520,8522,8524,8527],{"class":88,"line":255},[86,8512,8513],{"class":291},"        openaiModel",[86,8515,398],{"class":397},[86,8517,8496],{"class":177},[86,8519,181],{"class":103},[86,8521,575],{"class":2634},[86,8523,181],{"class":103},[86,8525,8526],{"class":8505},"OPENAI_MODEL",[86,8528,404],{"class":103},[86,8530,8531,8534,8536,8538,8540,8542,8544,8547],{"class":88,"line":277},[86,8532,8533],{"class":291},"        openaiApiKey",[86,8535,398],{"class":397},[86,8537,8496],{"class":177},[86,8539,181],{"class":103},[86,8541,575],{"class":2634},[86,8543,181],{"class":103},[86,8545,8546],{"class":8505},"OPENAI_API_KEY",[86,8548,404],{"class":103},[86,8550,8551,8554,8556,8558,8560,8562,8564,8567],{"class":88,"line":304},[86,8552,8553],{"class":291},"        openaiPrompt",[86,8555,398],{"class":397},[86,8557,8496],{"class":177},[86,8559,181],{"class":103},[86,8561,575],{"class":2634},[86,8563,181],{"class":103},[86,8565,8566],{"class":8505},"OPENAI_PROMPT",[86,8568,404],{"class":103},[86,8570,8571],{"class":88,"line":322},[86,8572,516],{"class":103},[86,8574,8575],{"class":88,"line":328},[86,8576,8577],{"class":103},"  ]\n",[86,8579,8580],{"class":88,"line":337},[86,8581,3759],{"class":103},[20,8583,8584],{},[924,8585,8586],{},"环境变量",[2935,8588,8589,8602,8610,8618,8626],{},[991,8590,8591,8594,8595,983],{},[60,8592,8593],{},"ASISMET_KEY",": Waline 使用的反垃圾评论服务，",[924,8596,8597,8598,8601],{},"建议设置为 ",[60,8599,8600],{},"false"," 以禁用",[991,8603,8604,8606,8607],{},[60,8605,8506],{},": API 基础 URL。例如 ",[60,8608,8609],{},"https://api.openai.com",[991,8611,8612,8614,8615],{},[60,8613,8526],{},": 模型名称。例如 ",[60,8616,8617],{},"gpt-4o-mini",[991,8619,8620,8622,8623],{},[60,8621,8546],{},": API 密钥。例如 ",[60,8624,8625],{},"ak-xxxxxx",[991,8627,8628,8630,8631],{},[60,8629,8566],{},"(可选): 模型的提示。例如 ",[60,8632,8633],{},"这是一个评论审查: ",[20,8635,8636],{},"在 waline 中设置好对应的环境变量，使用 npm 安装好对应的包，就算大功告成了。",[20,8638,8639],{},[67,8640],{"alt":69,"src":8641},"https://static.031130.xyz/uploads/2024/10/12/45f06a78286de.webp",[933,8643,8644],{},"html pre.shiki code .sW2Sy, html code.shiki .sW2Sy{--shiki-default:#A0A1A7;--shiki-default-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic}html pre.shiki code .sLKXg, html code.shiki .sLKXg{--shiki-default:#A626A4;--shiki-dark:#C678DD}html pre.shiki code .sNmU0, html code.shiki .sNmU0{--shiki-default:#986801;--shiki-dark:#E5C07B}html pre.shiki code .s_Sar, html code.shiki .s_Sar{--shiki-default:#0184BC;--shiki-dark:#56B6C2}html pre.shiki code .sAdtL, html code.shiki .sAdtL{--shiki-default:#4078F2;--shiki-dark:#61AFEF}html pre.shiki code .s5ixo, html code.shiki .s5ixo{--shiki-default:#383A42;--shiki-dark:#ABB2BF}html pre.shiki code .sDhpE, html code.shiki .sDhpE{--shiki-default:#50A14F;--shiki-dark:#98C379}html pre.shiki code .s7GmK, html code.shiki .s7GmK{--shiki-default:#383A42;--shiki-dark:#E5C07B}html pre.shiki code .s2QsP, html code.shiki .s2QsP{--shiki-default:#E45649;--shiki-dark:#E5C07B}html pre.shiki code .sJa8x, html code.shiki .sJa8x{--shiki-default:#E45649;--shiki-dark:#E06C75}html pre.shiki code .s8iYz, html code.shiki .s8iYz{--shiki-default:#383A42;--shiki-default-font-style:inherit;--shiki-dark:#E06C75;--shiki-dark-font-style:italic}html pre.shiki code .sz0mV, html code.shiki .sz0mV{--shiki-default:#383A42;--shiki-dark:#E06C75}html pre.shiki code .st7oF, html code.shiki .st7oF{--shiki-default:#0184BC;--shiki-dark:#ABB2BF}html .default .shiki span {color: var(--shiki-default);background: var(--shiki-default-bg);font-style: var(--shiki-default-font-style);font-weight: var(--shiki-default-font-weight);text-decoration: var(--shiki-default-text-decoration);}html .shiki span {color: var(--shiki-default);background: var(--shiki-default-bg);font-style: var(--shiki-default-font-style);font-weight: var(--shiki-default-font-weight);text-decoration: var(--shiki-default-text-decoration);}html .dark .shiki span {color: var(--shiki-dark);background: var(--shiki-dark-bg);font-style: var(--shiki-dark-font-style);font-weight: var(--shiki-dark-font-weight);text-decoration: var(--shiki-dark-text-decoration);}html.dark .shiki span {color: var(--shiki-dark);background: var(--shiki-dark-bg);font-style: var(--shiki-dark-font-style);font-weight: var(--shiki-dark-font-weight);text-decoration: var(--shiki-dark-text-decoration);}html pre.shiki code .sAOjX, html code.shiki .sAOjX{--shiki-default:#CA1243;--shiki-dark:#C678DD}html pre.shiki code .sAGMh, html code.shiki .sAGMh{--shiki-default:#986801;--shiki-dark:#D19A66}html pre.shiki code .sC09Y, html code.shiki .sC09Y{--shiki-default:#C18401;--shiki-dark:#E5C07B}html pre.shiki code .sRZ4U, html code.shiki .sRZ4U{--shiki-default:#986801;--shiki-dark:#E06C75}",{"title":69,"searchDepth":107,"depth":107,"links":8646},[],{"title":8648,"date":8649,"path":8650,"tags":8651,"body":8652},"基于 JavaScript 的 Hexo Fluid 主题 banner 随机背景图实现","2024-09-25 00:00:42","/2024/09/25/random-banner-backgroud-image-implement-for-hexo-fluid-with-javascript",[10,5526],{"type":14,"value":8653,"toc":9091},[8654,8658,8667,8673,8677,8685,8691,8694,8697,8700,8704,8707,8711,8714,8717,8730,8736,8740,8743,8794,8797,8806,9067,9070,9077,9079,9088],[948,8655,8657],{"id":8656},"为什么要换掉随机图片-api","为什么要换掉随机图片 API",[20,8659,8660,8661,8666],{},"因为 API 太慢了。根据 ",[30,8662,8665],{"href":8663,"rel":8664},"https://pagespeed.web.dev/",[41],"PageSpeed"," 的测速，使用 API 的图片加载时间来到了整整 2.5s，这似乎有些不可忍受。",[20,8668,8669],{},[67,8670],{"alt":8671,"src":8672},"PageSpeed 测速","https://static.031130.xyz/uploads/2024/09/25/3ef1a17bca955.webp",[1682,8674,8676],{"id":8675},"vercel-冷启动问题","Vercel 冷启动问题",[20,8678,8679,8680,8684],{},"当初年少无知，为了实现 banner 随机背景图，选择了",[30,8681,8683],{"href":8682},"/2021/05/21/create-a-random-picture-api-with-vercel/","使用 vercel 创建随机图片 API","。这带来了一些问题，首先 vercel 在站点一段时间没人访问以后会进入一种类似休眠的模式，下一次启动将会经历一个冷启动（cold start）的过程。我认为这对于一个图片背景的随机 API 而言是不可忍受的。",[20,8686,8687],{},[67,8688],{"alt":8689,"src":8690},"冷启动","https://static.031130.xyz/uploads/2024/09/24/f8cb9fd7a963e.webp",[20,8692,8693],{},"观察图上就可以发现，第一次访问时花费了 1.9 秒，第二次只需要 0.5 秒，这是因为第一次是冷启动，需要花费更多时间。",[1682,8695,8696],{"id":8696},"多一次网络请求",[20,8698,8699],{},"抛开冷启动不谈，引入 API 就会导致一次额外的网络请求。访客的浏览器将会先请求随机图片 API，然后根据 API 返回的 302 相应去请求真正的图片，而且这一过程是没法并行的，只能串行执行，这会浪费更多的等待时间。",[1682,8701,8703],{"id":8702},"vercel-在大陆境内的访问质量","Vercel 在大陆境内的访问质量",[20,8705,8706],{},"Vercel 在大陆境内的访问质量其实并不算好，即使是使用了所谓的优选节点，也不一定能保证整个大陆境内大部分访客都有不错的访问质量，因此使用 Vercel 搭建 API 的行为并不是最优解。",[948,8708,8710],{"id":8709},"转向-javascript-实现","转向 JavaScript 实现",[20,8712,8713],{},"这个方案本身没多少复杂的，只不过是三年前的我对前端一无所知不敢操刀罢了。",[1682,8715,8716],{"id":8716},"删除原有的背景图",[20,8718,1455,8719,8721,8722,8725,8726,8729],{},[60,8720,5539],{}," 中，将所有的 ",[60,8723,8724],{},"banner_img:"," 字段全部置空，防止其加载默认的 ",[60,8727,8728],{},"/img/default.png"," 而白白浪费用户的流量。这个字段一共在配置文件中出现了九次。",[20,8731,8732],{},[67,8733],{"alt":8734,"src":8735},"字段置空","https://static.031130.xyz/uploads/2024/09/25/70bd0b27f5aad.webp",[1682,8737,8739],{"id":8738},"添加-js","添加 js",[20,8741,8742],{},"我们的目标是修改 id 为 banner 的 div 块的 backgroud 的 css 属性，Hexo Fluid 默认的生成内容是这样的",[78,8744,8748],{"className":8745,"code":8746,"language":8747,"meta":69,"style":69},"language-html shiki shiki-themes one-light one-dark-pro","\u003Cdiv id=\"banner\" class=\"banner\" parallax=true style=\"background: url('/img/default.png') no-repeat center center; background-size: cover;\">\n","html",[60,8749,8750],{"__ignoreMap":69},[86,8751,8752,8754,8756,8759,8761,8764,8767,8769,8771,8774,8776,8779,8782,8784,8786,8790,8792],{"class":88,"line":89},[86,8753,6932],{"class":103},[86,8755,2975],{"class":291},[86,8757,8758],{"class":816}," id",[86,8760,5186],{"class":103},[86,8762,8763],{"class":121},"\"banner\"",[86,8765,8766],{"class":816}," class",[86,8768,5186],{"class":103},[86,8770,8763],{"class":121},[86,8772,8773],{"class":816}," parallax",[86,8775,5186],{"class":103},[86,8777,8778],{"class":121},"true",[86,8780,8781],{"class":816}," style",[86,8783,5186],{"class":103},[86,8785,853],{"class":121},[86,8787,8789],{"class":8788},"s-4uI","background: url('/img/default.png') no-repeat center center; background-size: cover;",[86,8791,853],{"class":121},[86,8793,6937],{"class":103},[20,8795,8796],{},"我们可以通过 id 来定位这个元素，修改其 style.background 属性。",[20,8798,8799,8800,8805],{},"可以在任何地方引入下面的 js 代码，在这篇名为",[30,8801,8804],{"href":8802,"rel":8803},"https://www.zywvvd.com/notes/hexo/theme/fluid/fluid-add-umami/fluid-add-umami/",[41],"《Fluid -23- 添加 Umami 统计》"," 的文章里的方案是可供参考的。",[78,8807,8809],{"className":80,"code":8808,"language":82,"meta":69,"style":69},"const imgs = [\n    \"https://example.com/1.jpg\",\n    \"https://example.com/2.jpg\",\n    \"https://example.com/3.jpg\",\n    \"https://example.com/4.jpg\",\n    \"https://example.com/5.jpg\",\n    \"https://example.com/6.jpg\",\n    \"https://example.com/7.jpg\",\n    \"https://example.com/8.jpg\",\n    \"https://example.com/9.jpg\",\n    \"https://example.com/10.jpg\",\n    \"https://example.com/11.jpg\",\n    \"https://example.com/12.jpg\",\n    \"https://example.com/13.jpg\",\n    \"https://example.com/14.jpg\",\n    \"https://example.com/15.jpg\",\n    \"https://example.com/16.jpg\",\n    \"https://example.com/17.jpg\",\n    \"https://example.com/18.jpg\",\n    \"https://example.com/19.jpg\",\n    \"https://example.com/20.jpg\",\n]\n\nconst luck_img = imgs[Math.floor(Math.random() * imgs.length)]\nconst banner = document.getElementById('banner')\nbanner.style.background = `url(${luck_img}) center center / cover no-repeat`\n",[60,8810,8811,8822,8829,8836,8843,8850,8857,8864,8871,8878,8885,8892,8899,8906,8913,8920,8927,8934,8941,8948,8955,8962,8966,8970,9014,9038],{"__ignoreMap":69},[86,8812,8813,8815,8818,8820],{"class":88,"line":89},[86,8814,676],{"class":92},[86,8816,8817],{"class":113}," imgs",[86,8819,118],{"class":117},[86,8821,5787],{"class":103},[86,8823,8824,8827],{"class":88,"line":107},[86,8825,8826],{"class":121},"    \"https://example.com/1.jpg\"",[86,8828,404],{"class":103},[86,8830,8831,8834],{"class":88,"line":128},[86,8832,8833],{"class":121},"    \"https://example.com/2.jpg\"",[86,8835,404],{"class":103},[86,8837,8838,8841],{"class":88,"line":143},[86,8839,8840],{"class":121},"    \"https://example.com/3.jpg\"",[86,8842,404],{"class":103},[86,8844,8845,8848],{"class":88,"line":150},[86,8846,8847],{"class":121},"    \"https://example.com/4.jpg\"",[86,8849,404],{"class":103},[86,8851,8852,8855],{"class":88,"line":3},[86,8853,8854],{"class":121},"    \"https://example.com/5.jpg\"",[86,8856,404],{"class":103},[86,8858,8859,8862],{"class":88,"line":207},[86,8860,8861],{"class":121},"    \"https://example.com/6.jpg\"",[86,8863,404],{"class":103},[86,8865,8866,8869],{"class":88,"line":232},[86,8867,8868],{"class":121},"    \"https://example.com/7.jpg\"",[86,8870,404],{"class":103},[86,8872,8873,8876],{"class":88,"line":255},[86,8874,8875],{"class":121},"    \"https://example.com/8.jpg\"",[86,8877,404],{"class":103},[86,8879,8880,8883],{"class":88,"line":277},[86,8881,8882],{"class":121},"    \"https://example.com/9.jpg\"",[86,8884,404],{"class":103},[86,8886,8887,8890],{"class":88,"line":304},[86,8888,8889],{"class":121},"    \"https://example.com/10.jpg\"",[86,8891,404],{"class":103},[86,8893,8894,8897],{"class":88,"line":322},[86,8895,8896],{"class":121},"    \"https://example.com/11.jpg\"",[86,8898,404],{"class":103},[86,8900,8901,8904],{"class":88,"line":328},[86,8902,8903],{"class":121},"    \"https://example.com/12.jpg\"",[86,8905,404],{"class":103},[86,8907,8908,8911],{"class":88,"line":337},[86,8909,8910],{"class":121},"    \"https://example.com/13.jpg\"",[86,8912,404],{"class":103},[86,8914,8915,8918],{"class":88,"line":513},[86,8916,8917],{"class":121},"    \"https://example.com/14.jpg\"",[86,8919,404],{"class":103},[86,8921,8922,8925],{"class":88,"line":519},[86,8923,8924],{"class":121},"    \"https://example.com/15.jpg\"",[86,8926,404],{"class":103},[86,8928,8929,8932],{"class":88,"line":537},[86,8930,8931],{"class":121},"    \"https://example.com/16.jpg\"",[86,8933,404],{"class":103},[86,8935,8936,8939],{"class":88,"line":792},[86,8937,8938],{"class":121},"    \"https://example.com/17.jpg\"",[86,8940,404],{"class":103},[86,8942,8943,8946],{"class":88,"line":797},[86,8944,8945],{"class":121},"    \"https://example.com/18.jpg\"",[86,8947,404],{"class":103},[86,8949,8950,8953],{"class":88,"line":822},[86,8951,8952],{"class":121},"    \"https://example.com/19.jpg\"",[86,8954,404],{"class":103},[86,8956,8957,8960],{"class":88,"line":871},[86,8958,8959],{"class":121},"    \"https://example.com/20.jpg\"",[86,8961,404],{"class":103},[86,8963,8964],{"class":88,"line":882},[86,8965,4340],{"class":103},[86,8967,8968],{"class":88,"line":899},[86,8969,147],{"emptyLinePlaceholder":146},[86,8971,8972,8974,8977,8979,8981,8983,8986,8988,8991,8993,8995,8997,9000,9003,9005,9007,9009,9011],{"class":88,"line":904},[86,8973,676],{"class":92},[86,8975,8976],{"class":113}," luck_img",[86,8978,118],{"class":117},[86,8980,8817],{"class":201},[86,8982,8333],{"class":103},[86,8984,8985],{"class":177},"Math",[86,8987,181],{"class":103},[86,8989,8990],{"class":99},"floor",[86,8992,166],{"class":103},[86,8994,8985],{"class":177},[86,8996,181],{"class":103},[86,8998,8999],{"class":99},"random",[86,9001,9002],{"class":103},"() ",[86,9004,6215],{"class":117},[86,9006,8817],{"class":177},[86,9008,181],{"class":103},[86,9010,810],{"class":291},[86,9012,9013],{"class":103},")]\n",[86,9015,9016,9018,9021,9023,9026,9028,9031,9033,9036],{"class":88,"line":909},[86,9017,676],{"class":92},[86,9019,9020],{"class":113}," banner",[86,9022,118],{"class":117},[86,9024,9025],{"class":177}," document",[86,9027,181],{"class":103},[86,9029,9030],{"class":99},"getElementById",[86,9032,166],{"class":103},[86,9034,9035],{"class":121},"'banner'",[86,9037,172],{"class":103},[86,9039,9040,9043,9045,9047,9049,9052,9054,9057,9059,9062,9064],{"class":88,"line":2259},[86,9041,9042],{"class":177},"banner",[86,9044,181],{"class":103},[86,9046,933],{"class":184},[86,9048,181],{"class":103},[86,9050,9051],{"class":291},"background",[86,9053,118],{"class":117},[86,9055,9056],{"class":121}," `url(",[86,9058,839],{"class":838},[86,9060,9061],{"class":201},"luck_img",[86,9063,863],{"class":838},[86,9065,9066],{"class":121},") center center / cover no-repeat`\n",[948,9068,9069],{"id":9069},"成果",[20,9071,9072,9073,9076],{},"博客能够在不引入外部 api 的情况下通过 js 自主实现随机的 banner 背景图，",[23,9074,9075],{},"但 pagespeed 的测速结果并没有明显好转","，因为 pagespeed 模拟了低速 4G 的访问速度，无论如何都无法提升大文件的加载速度。不过避免了多一次网络请求后，打开页面时的加载速度确实有提升。",[948,9078,1577],{"id":1577},[2935,9080,9081],{},[991,9082,9083],{},[30,9084,9087],{"href":9085,"rel":9086},"https://vercel.com/guides/how-can-i-improve-serverless-function-lambda-cold-start-performance-on-vercel",[41],"How can I improve function cold start performance on Vercel?",[933,9089,9090],{},"html pre.shiki code .s5ixo, html code.shiki .s5ixo{--shiki-default:#383A42;--shiki-dark:#ABB2BF}html pre.shiki code .sJa8x, html code.shiki .sJa8x{--shiki-default:#E45649;--shiki-dark:#E06C75}html pre.shiki code .sAGMh, html code.shiki .sAGMh{--shiki-default:#986801;--shiki-dark:#D19A66}html pre.shiki code .sDhpE, html code.shiki .sDhpE{--shiki-default:#50A14F;--shiki-dark:#98C379}html pre.shiki code .s-4uI, html code.shiki .s-4uI{--shiki-default:#383A42;--shiki-dark:#98C379}html .default .shiki span {color: var(--shiki-default);background: var(--shiki-default-bg);font-style: var(--shiki-default-font-style);font-weight: var(--shiki-default-font-weight);text-decoration: var(--shiki-default-text-decoration);}html .shiki span {color: var(--shiki-default);background: var(--shiki-default-bg);font-style: var(--shiki-default-font-style);font-weight: var(--shiki-default-font-weight);text-decoration: var(--shiki-default-text-decoration);}html .dark .shiki span {color: var(--shiki-dark);background: var(--shiki-dark-bg);font-style: var(--shiki-dark-font-style);font-weight: var(--shiki-dark-font-weight);text-decoration: var(--shiki-dark-text-decoration);}html.dark .shiki span {color: var(--shiki-dark);background: var(--shiki-dark-bg);font-style: var(--shiki-dark-font-style);font-weight: var(--shiki-dark-font-weight);text-decoration: var(--shiki-dark-text-decoration);}html pre.shiki code .sLKXg, html code.shiki .sLKXg{--shiki-default:#A626A4;--shiki-dark:#C678DD}html pre.shiki code .sNmU0, html code.shiki .sNmU0{--shiki-default:#986801;--shiki-dark:#E5C07B}html pre.shiki code .s_Sar, html code.shiki .s_Sar{--shiki-default:#0184BC;--shiki-dark:#56B6C2}html pre.shiki code .sz0mV, html code.shiki .sz0mV{--shiki-default:#383A42;--shiki-dark:#E06C75}html pre.shiki code .s7GmK, html code.shiki .s7GmK{--shiki-default:#383A42;--shiki-dark:#E5C07B}html pre.shiki code .sAdtL, html code.shiki .sAdtL{--shiki-default:#4078F2;--shiki-dark:#61AFEF}html pre.shiki code .s2QsP, html code.shiki .s2QsP{--shiki-default:#E45649;--shiki-dark:#E5C07B}html pre.shiki code .sAOjX, html code.shiki .sAOjX{--shiki-default:#CA1243;--shiki-dark:#C678DD}",{"title":69,"searchDepth":107,"depth":107,"links":9092},[9093,9098,9102,9103],{"id":8656,"depth":107,"text":8657,"children":9094},[9095,9096,9097],{"id":8675,"depth":128,"text":8676},{"id":8696,"depth":128,"text":8696},{"id":8702,"depth":128,"text":8703},{"id":8709,"depth":107,"text":8710,"children":9099},[9100,9101],{"id":8716,"depth":128,"text":8716},{"id":8738,"depth":128,"text":8739},{"id":9069,"depth":107,"text":9069},{"id":1577,"depth":107,"text":1577},"/en/archives/",134,1771555476708]