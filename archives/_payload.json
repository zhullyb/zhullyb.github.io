[{"data":1,"prerenderedAt":7458},["ShallowReactive",2],{"randomIndex/archives":3,"index-page-1":4,"posts-nums-total":7457},0,[5,396,829,1217,2252,2626,2838,3243,5170,6582],{"title":6,"date":7,"path":8,"tags":9,"body":12},"DNS 冷启动：小型站点的“西西弗斯之石”","2025-11-11","/2025/11/11/dns-cold-start-dilemma",[10,11],"DNS","Network",{"type":13,"value":14,"toc":385},"minimark",[15,19,24,27,67,234,245,249,252,255,258,261,264,279,282,285,289,292,295,309,312,316,319,324,327,330,333,337,340,343,350,354,357,360,363,381],[16,17,18],"p",{},"当我们谈论网站性能时，我们通常关注前端渲染、资源懒加载、服务器响应时间（TTFB）等。然而，在用户浏览器真正开始请求内容之前，有一个至关重要却鲜少在性能优化方面被提及的部分—— DNS 解析。对于默默无闻的小型站点而言，“DNS Cache Miss”（缓存未命中）或我称之为“DNS 冷启动”，会成为绕不过去的性能瓶颈，也就是本文标题所提到的“西西弗斯之石”。",[20,21,23],"h2",{"id":22},"神话的隐喻dns-解析的漫长旅程","神话的隐喻：DNS 解析的漫长旅程",[16,25,26],{},"要理解这块“石头”的重量，我们必须重温 DNS 解析的完整路径。这并非一次简单的查找，而是一场跨越全球的接力赛：",[28,29,30,38,44,55,61],"ol",{},[31,32,33,37],"li",{},[34,35,36],"strong",{},"起点：公共 DNS 服务器"," — 用户发出请求，公共 DNS 服务器尝试在缓存中寻找答案。",[31,39,40,43],{},[34,41,42],{},"首次“推石”：根服务器"," — 缓存缺失（Cache Miss），公共 DNS 服务器被引向全球 13 组根服务器。",[31,45,46,49,50,54],{},[34,47,48],{},"第二程：TLD 服务器"," — 根服务器指向特定后缀（如 ",[51,52,53],"code",{},".com","）的顶级域名服务器。",[31,56,57,60],{},[34,58,59],{},"第三程：权威服务器"," — TLD 服务器指向网站域名最终的“管家”——权威 DNS 服务器。",[31,62,63,66],{},[34,64,65],{},"终点："," 权威服务器返回最终的 IP 地址，再由公共 DNS 服务器返回给用户。",[68,69,74],"pre",{"className":70,"code":71,"language":72,"meta":73,"style":73},"language-mermaid shiki shiki-themes one-light one-dark-pro","sequenceDiagram\n    participant User as 用户/浏览器\n    participant Local as 本地DNS\u003Cbr>递归解析器\n    participant Root as 根域名服务器\n    participant TLD as 顶级域服务器\u003Cbr>(.com, .org等)\n    participant Auth as 权威DNS服务器\n\n    Note over User,Auth: DNS递归查询完整流程\n\n    User->>Local: 1. 查询域名\u003Cbr>www.example.com\n    Note over Local: 检查缓存\u003Cbr>未找到记录\n\n    Local->>Root: 2. 查询 .com 的TLD服务器\n    Root-->>Local: 3. 返回 .com TLD服务器地址\n\n    Local->>TLD: 4. 查询 example.com 的权威服务器\n    TLD-->>Local: 5. 返回 example.com 的权威服务器地址\n\n    Local->>Auth: 6. 查询 www.example.com 的A记录\n    Auth-->>Local: 7. 返回 IP地址 (e.g., 1.1.1.1)\n\n    Note over Local: 缓存结果\u003Cbr>(根据TTL设置)\n\n    Local-->>User: 8. 返回最终IP地址\n\n    Note over User,Auth: 后续流程\n    User->>Auth: 9. 使用IP地址建立TCP连接\u003Cbr>开始HTTP请求\n","mermaid","",[51,75,76,84,90,96,102,108,114,121,127,132,138,144,149,155,161,166,172,178,183,189,195,200,206,211,217,222,228],{"__ignoreMap":73},[77,78,81],"span",{"class":79,"line":80},"line",1,[77,82,83],{},"sequenceDiagram\n",[77,85,87],{"class":79,"line":86},2,[77,88,89],{},"    participant User as 用户/浏览器\n",[77,91,93],{"class":79,"line":92},3,[77,94,95],{},"    participant Local as 本地DNS\u003Cbr>递归解析器\n",[77,97,99],{"class":79,"line":98},4,[77,100,101],{},"    participant Root as 根域名服务器\n",[77,103,105],{"class":79,"line":104},5,[77,106,107],{},"    participant TLD as 顶级域服务器\u003Cbr>(.com, .org等)\n",[77,109,111],{"class":79,"line":110},6,[77,112,113],{},"    participant Auth as 权威DNS服务器\n",[77,115,117],{"class":79,"line":116},7,[77,118,120],{"emptyLinePlaceholder":119},true,"\n",[77,122,124],{"class":79,"line":123},8,[77,125,126],{},"    Note over User,Auth: DNS递归查询完整流程\n",[77,128,130],{"class":79,"line":129},9,[77,131,120],{"emptyLinePlaceholder":119},[77,133,135],{"class":79,"line":134},10,[77,136,137],{},"    User->>Local: 1. 查询域名\u003Cbr>www.example.com\n",[77,139,141],{"class":79,"line":140},11,[77,142,143],{},"    Note over Local: 检查缓存\u003Cbr>未找到记录\n",[77,145,147],{"class":79,"line":146},12,[77,148,120],{"emptyLinePlaceholder":119},[77,150,152],{"class":79,"line":151},13,[77,153,154],{},"    Local->>Root: 2. 查询 .com 的TLD服务器\n",[77,156,158],{"class":79,"line":157},14,[77,159,160],{},"    Root-->>Local: 3. 返回 .com TLD服务器地址\n",[77,162,164],{"class":79,"line":163},15,[77,165,120],{"emptyLinePlaceholder":119},[77,167,169],{"class":79,"line":168},16,[77,170,171],{},"    Local->>TLD: 4. 查询 example.com 的权威服务器\n",[77,173,175],{"class":79,"line":174},17,[77,176,177],{},"    TLD-->>Local: 5. 返回 example.com 的权威服务器地址\n",[77,179,181],{"class":79,"line":180},18,[77,182,120],{"emptyLinePlaceholder":119},[77,184,186],{"class":79,"line":185},19,[77,187,188],{},"    Local->>Auth: 6. 查询 www.example.com 的A记录\n",[77,190,192],{"class":79,"line":191},20,[77,193,194],{},"    Auth-->>Local: 7. 返回 IP地址 (e.g., 1.1.1.1)\n",[77,196,198],{"class":79,"line":197},21,[77,199,120],{"emptyLinePlaceholder":119},[77,201,203],{"class":79,"line":202},22,[77,204,205],{},"    Note over Local: 缓存结果\u003Cbr>(根据TTL设置)\n",[77,207,209],{"class":79,"line":208},23,[77,210,120],{"emptyLinePlaceholder":119},[77,212,214],{"class":79,"line":213},24,[77,215,216],{},"    Local-->>User: 8. 返回最终IP地址\n",[77,218,220],{"class":79,"line":219},25,[77,221,120],{"emptyLinePlaceholder":119},[77,223,225],{"class":79,"line":224},26,[77,226,227],{},"    Note over User,Auth: 后续流程\n",[77,229,231],{"class":79,"line":230},27,[77,232,233],{},"    User->>Auth: 9. 使用IP地址建立TCP连接\u003Cbr>开始HTTP请求\n",[16,235,236,237,240,241,244],{},"对于",[34,238,239],{},"首次","或",[34,242,243],{},"长时间未访问","的请求，这个过程意味着至少 4 次网络往返（RTT），而在涉及到 CNAME 等情况时则会更多。对于那些拥有完美缓存的大型网站来说，这块石头可能已被别人推到了山顶；但对小型站点，它总是在山脚等待它的西西弗斯。",[20,246,248],{"id":247},"多重世界anycast-的镜像迷宫","多重世界：Anycast 的镜像迷宫",[16,250,251],{},"“既然 DNS 冷启动的代价如此之高，那我能否使用脚本定时访问自己的网站，提前让公共 DNS 缓存预热起来呢？”——这是我曾经设想的解题思路。",[16,253,254],{},"然而，这一思路在现代互联网的 Anycast（泛播）架构下，往往徒劳无功。",[16,256,257],{},"Anycast 的核心理念是：同一个 IP 地址在全球多个节点同时存在，用户请求会被路由到“距离最近”或“网络路径最优”的节点。",[16,259,260],{},"这意味着，Google DNS (8.8.8.8) 、Cloudflare DNS (1.1.1.1)、阿里 DNS (223.5.5.5)、腾讯 DNS (119.29.29.29) 等公共 DNS 服务器背后并不是一台中心化的服务器，而是一组分布在世界各地、动态路由的节点集群。",[16,262,263],{},"于是问题出现了：",[265,266,267,270,273],"ul",{},[31,268,269],{},"我在上海运行的预热脚本，也许命中了 223.5.5.5 的上海节点；",[31,271,272],{},"但来自北京的访问者，却会被路由到 223.5.5.5 的北京节点；",[31,274,275,276],{},"这两个节点的缓存，",[34,277,278],{},"彼此独立、互不共享。",[16,280,281],{},"从站长的视角来看，DNS 缓存不再是一个可预测的实体，而是分裂成一片片地理隔离、随时可变的“镜像迷宫”。",[16,283,284],{},"每个访客都在不同的山脚下推着自己的那块石头，仿佛世界上有成千上万个西西弗斯，孤独地在各自的路径上前行。",[20,286,288],{"id":287},"不可控的缓存与冷启动的常态化","不可控的缓存与「冷启动的常态化」",[16,290,291],{},"这也解释了为什么即便一个小型网站有规律地被脚本访问，仍可能在真实访客那里出现明显的 DNS 延迟。因为「预热」只是局部生效 —— 它温暖的是某一个任播节点的缓存，而不是整个网络的全貌。而当 TTL 到期或缓存被公共 DNS 服务器采用 LRU 等算法清理时，这份温度也会悄然散去。",[16,293,294],{},"从宏观上看，这让“小流量站点”陷入了某种宿命循环：",[28,296,297,300,303,306],{},[31,298,299],{},"因访问量低，缓存不易命中；",[31,301,302],{},"因缓存不命中，解析耗时高；",[31,304,305],{},"因解析耗时高，首屏性能差，用户更少访问；",[31,307,308],{},"因用户更少访问，缓存更难命中。",[16,310,311],{},"冷启动不再是偶发的“意外”，而是一种被动的“常态”。",[20,313,315],{"id":314},"我们能否让石头变轻-减缓冷启动影响的策略","我们能否让石头变轻？—— 减缓冷启动影响的策略",[16,317,318],{},"西西弗斯的困境看似无解，但我们并非完全无能为力。虽然无法彻底消除 DNS 冷启动，但通过一系列策略，我们可以显著减轻这块石头的重量，缩短它每次滚落后被推上山顶的时间。",[320,321,323],"h3",{"id":322},"权衡的艺术调整-dns-ttl-time-to-live","权衡的艺术：调整 DNS TTL (Time-To-Live)",[16,325,326],{},"TTL（生存时间）是 DNS 记录中的一个关键值，它告知递归解析器（如公共 DNS、本地缓存）可以将一条解析记录缓存多久，尽管他们可能会被 LRU 算法淘汰。",[16,328,329],{},"拉长 TTL 可以有效提高缓存的命中率，减少 DNS 冷启动的情况，尽可能让西西弗斯之石保留在山顶上。",[16,331,332],{},"但拉长 TTL 是以牺牲灵活性作为代价的：如果你因为某些原因需要更换域名做对应的 IP 地址，过长的 TTL 可能会导致访客在很长一段时间内取得的都是已经失效的 IP 地址。",[320,334,336],{"id":335},"选择更快的信使使用合适的权威-dns-服务器","选择更快的“信使”：使用合适的权威 DNS 服务器",[16,338,339],{},"DNS 解析的最后一公里——从公共 DNS 服务器到你的权威 DNS 服务器——的耗时同样至关重要。如果你的域名所采用的 Nameserver 服务响应缓慢、全球节点稀少、又或者距离访客所请求的公共 DNS 服务器距离太远，那么即使用户的公共 DNS 节点就在身边，整个解析链条依然会被这最后一环拖慢。",[16,341,342],{},"如果我正在写的是一篇英文博客，那么我只需要说把 Nameserver 换成 Cloudflare、Google 等一线大厂就完事了。这些大厂提供免费的权威 DNS 托管业务，且在全球各地拥有大量节点，在这方面是非常专业且值得信赖的。",[16,344,345,346,349],{},"但我现在正在使用简体中文，根据我的博客统计数据，我的读者大多来自中国大陆，他们的站点访客大多也来自中国大陆，他们请求的公共 DNS 服务器大概率也都部署在中国大陆，而 Cloudflare/Google Cloud DNS 完全没有权威 DNS 服务器的中国大陆节点，这会拖慢速度。所以",[34,347,348],{},"如果你的访客主要来自中国大陆境内，或许可以试试阿里云或者 Dnspod","，他们主要的权威 DNS 服务器节点都在中国大陆境内，这在理论上可以减少公共 DNS 服务器与 权威 DNS 服务器之间的通信时长。",[20,351,353],{"id":352},"结语推石头的人","结语：推石头的人",[16,355,356],{},"DNS 冷启动的问题，从未有完美的解决方案。它像是互联网架构中注定存在的一段“延迟的诗意”——每个访问者都从自己的网络拓扑出发，沿着看不见的路径，一步步推着那块属于自己的石头，直到抵达你的服务器山顶，换得屏幕上第一个像素的亮起。",[16,358,359],{},"对小型站点而言，这或许是命运的重量；但理解它、优化它、监测它，便是我们在这条漫长上坡路上，为石头磨出更光滑的棱角。",[20,361,362],{"id":362},"参见",[265,364,365,374],{},[31,366,367],{},[368,369,373],"a",{"href":370,"rel":371},"https://developers.google.com/speed/public-dns/docs/performance",[372],"nofollow","Performance Benefits  |  Public DNS  |  Google for Developers",[31,375,376],{},[368,377,380],{"href":378,"rel":379},"https://falconcloud.ae/about/blog/how-do-dns-queries-affect-website-latency/",[372],"How do DNS queries affect website latency? - falconcloud.ae",[382,383,384],"style",{},"html .default .shiki span {color: var(--shiki-default);background: var(--shiki-default-bg);font-style: var(--shiki-default-font-style);font-weight: var(--shiki-default-font-weight);text-decoration: var(--shiki-default-text-decoration);}html .shiki span {color: var(--shiki-default);background: var(--shiki-default-bg);font-style: var(--shiki-default-font-style);font-weight: var(--shiki-default-font-weight);text-decoration: var(--shiki-default-text-decoration);}html .dark .shiki span {color: var(--shiki-dark);background: var(--shiki-dark-bg);font-style: var(--shiki-dark-font-style);font-weight: var(--shiki-dark-font-weight);text-decoration: var(--shiki-dark-text-decoration);}html.dark .shiki span {color: var(--shiki-dark);background: var(--shiki-dark-bg);font-style: var(--shiki-dark-font-style);font-weight: var(--shiki-dark-font-weight);text-decoration: var(--shiki-dark-text-decoration);}",{"title":73,"searchDepth":86,"depth":86,"links":386},[387,388,389,390,394,395],{"id":22,"depth":86,"text":23},{"id":247,"depth":86,"text":248},{"id":287,"depth":86,"text":288},{"id":314,"depth":86,"text":315,"children":391},[392,393],{"id":322,"depth":92,"text":323},{"id":335,"depth":92,"text":336},{"id":352,"depth":86,"text":353},{"id":362,"depth":86,"text":362},{"title":397,"date":398,"path":399,"tags":400,"body":405},"HTTP/2 Server Push Has Effectively \"Died\" - I Miss It","2025-11-05","/2025/11/05/http-2-server-push-is-practically-obsolete-en",[401,402,11,403,404],"HTTP","Caddy","HTML","Vercel",{"type":13,"value":406,"toc":818},[407,410,414,425,487,494,547,556,562,565,569,572,617,630,634,637,645,654,662,665,669,673,676,679,682,690,705,709,716,730,736,740,743,748,751,754,757,768,771,775,816],[16,408,409],{},"I've been refactoring my blog recently, and while preparing for autumn recruitment and memorizing technical concepts, I came across HTTP/2 server push. I then attempted to configure HTTP/2 server push for my blog during deployment to further optimize first-screen loading speed.",[20,411,413],{"id":412},"why-http2-server-push-could-improve-first-screen-loading-speed","Why HTTP/2 Server Push Could Improve First-Screen Loading Speed",[16,415,416,417,420,421,424],{},"As shown in the diagram below, in traditional HTTP/1.1, the browser first downloads ",[51,418,419],{},"index.html"," and completes the initial parsing, then retrieves the URLs for CSS/JS resources from the parsed data before making a second round of requests. After establishing TCP/TLS connections, it requires ",[34,422,423],{},"at least two RTTs to retrieve"," all the resources needed to fully render the page.",[68,426,428],{"className":70,"code":427,"language":72,"meta":73,"style":73},"sequenceDiagram\n    participant Browser\n    participant Server\n\n    Browser->>Server: GET /index.html\n    Server-->>Browser: 200 OK + HTML\n    Browser->>Server: GET /style.css\n    Browser->>Server: GET /app.js\n    Server-->>Browser: 200 OK + CSS\n    Server-->>Browser: 200 OK + JS\n\n    Note over Browser: Browser must wait for HTML to download\u003Cbr/>and parse before making subsequent requests,\u003Cbr/>increasing round-trip latency (RTT)\n",[51,429,430,434,439,444,448,453,458,463,468,473,478,482],{"__ignoreMap":73},[77,431,432],{"class":79,"line":80},[77,433,83],{},[77,435,436],{"class":79,"line":86},[77,437,438],{},"    participant Browser\n",[77,440,441],{"class":79,"line":92},[77,442,443],{},"    participant Server\n",[77,445,446],{"class":79,"line":98},[77,447,120],{"emptyLinePlaceholder":119},[77,449,450],{"class":79,"line":104},[77,451,452],{},"    Browser->>Server: GET /index.html\n",[77,454,455],{"class":79,"line":110},[77,456,457],{},"    Server-->>Browser: 200 OK + HTML\n",[77,459,460],{"class":79,"line":116},[77,461,462],{},"    Browser->>Server: GET /style.css\n",[77,464,465],{"class":79,"line":123},[77,466,467],{},"    Browser->>Server: GET /app.js\n",[77,469,470],{"class":79,"line":129},[77,471,472],{},"    Server-->>Browser: 200 OK + CSS\n",[77,474,475],{"class":79,"line":134},[77,476,477],{},"    Server-->>Browser: 200 OK + JS\n",[77,479,480],{"class":79,"line":140},[77,481,120],{"emptyLinePlaceholder":119},[77,483,484],{"class":79,"line":146},[77,485,486],{},"    Note over Browser: Browser must wait for HTML to download\u003Cbr/>and parse before making subsequent requests,\u003Cbr/>increasing round-trip latency (RTT)\n",[16,488,489,490,493],{},"In HTTP/2's vision, the process would look like the diagram below. When the browser requests index.html, the server can simultaneously push CSS/JS resources to the client. This way, after establishing the TCP/TLS connection, it only needs ",[34,491,492],{},"one RTT"," to retrieve all resources needed for page rendering.",[68,495,497],{"className":70,"code":496,"language":72,"meta":73,"style":73},"sequenceDiagram\n    participant Browser\n    participant Server\n\n    Browser->>Server: GET /index.html\n    Server-->>Browser: 200 OK + HTML\n    Server-->>Browser: PUSH_PROMISE /style.css\n    Server-->>Browser: PUSH_PROMISE /app.js\n    Server-->>Browser: (Push) style.css + app.js content\n\n    Note over Browser: Browser receives proactive resource push\u003Cbr/>Reduces request rounds and first-screen latency\n",[51,498,499,503,507,511,515,519,523,528,533,538,542],{"__ignoreMap":73},[77,500,501],{"class":79,"line":80},[77,502,83],{},[77,504,505],{"class":79,"line":86},[77,506,438],{},[77,508,509],{"class":79,"line":92},[77,510,443],{},[77,512,513],{"class":79,"line":98},[77,514,120],{"emptyLinePlaceholder":119},[77,516,517],{"class":79,"line":104},[77,518,452],{},[77,520,521],{"class":79,"line":110},[77,522,457],{},[77,524,525],{"class":79,"line":116},[77,526,527],{},"    Server-->>Browser: PUSH_PROMISE /style.css\n",[77,529,530],{"class":79,"line":123},[77,531,532],{},"    Server-->>Browser: PUSH_PROMISE /app.js\n",[77,534,535],{"class":79,"line":129},[77,536,537],{},"    Server-->>Browser: (Push) style.css + app.js content\n",[77,539,540],{"class":79,"line":134},[77,541,120],{"emptyLinePlaceholder":119},[77,543,544],{"class":79,"line":140},[77,545,546],{},"    Note over Browser: Browser receives proactive resource push\u003Cbr/>Reduces request rounds and first-screen latency\n",[16,548,549,550,555],{},"To minimize subsequent requests in HTTP/1.1, front-end developers have tried numerous optimization techniques. As Sukka mentioned in \"",[368,551,554],{"href":552,"rel":553},"https://blog.skk.moe/post/http2-server-push/",[372],"Static Resource Delivery Optimization: HTTP/2 and Server Push","\":",[557,558,559],"blockquote",{},[16,560,561],{},"The concepts of critical resources, critical rendering path, and critical request chain have existed for a long time. Asynchronous resource loading is old news: lazy-loading images, videos, iframes, and even lazy-loading CSS, JS, DOM, and lazy execution of functions. However, the approach to critical resource delivery hasn't changed much.",[16,563,564],{},"HTTP/2 Server Push created a new resource delivery paradigm. CSS/JS and other resources don't need to be delivered along with HTML to reach the client within one RTT, and these resources can be cached by the browser without being constrained by HTML's shorter TTL.",[20,566,568],{"id":567},"initial-solution","Initial Solution",[16,570,571],{},"Having understood the advantages of HTTP/2 server push, I prepared to implement the optimization. My blog is purely static, using DNS for traffic splitting between domestic and international visitors: domestic traffic accesses a DMIT VPS with cmin2/9929 network optimization, served through Caddy; international traffic goes directly to Vercel, leveraging Amazon's CDN for global edge acceleration. The network architecture looks roughly like this:",[68,573,575],{"className":70,"code":574,"language":72,"meta":73,"style":73},"graph TD\n    A[Blog Visitors] --> B[Initiate DNS Resolution]\n    B --> C[DNSPod Service]\n    C -->|Domestic Visitors: Smart Routing| D[Network-Optimized VPS]\n    C -->|International Visitors: Smart Routing| E[Vercel Platform]\n    D --> F[Caddy]\n    F --> G[Return Blog Content to Domestic Visitors]\n    E --> H[Return Blog Content to International Visitors]\n",[51,576,577,582,587,592,597,602,607,612],{"__ignoreMap":73},[77,578,579],{"class":79,"line":80},[77,580,581],{},"graph TD\n",[77,583,584],{"class":79,"line":86},[77,585,586],{},"    A[Blog Visitors] --> B[Initiate DNS Resolution]\n",[77,588,589],{"class":79,"line":92},[77,590,591],{},"    B --> C[DNSPod Service]\n",[77,593,594],{"class":79,"line":98},[77,595,596],{},"    C -->|Domestic Visitors: Smart Routing| D[Network-Optimized VPS]\n",[77,598,599],{"class":79,"line":104},[77,600,601],{},"    C -->|International Visitors: Smart Routing| E[Vercel Platform]\n",[77,603,604],{"class":79,"line":110},[77,605,606],{},"    D --> F[Caddy]\n",[77,608,609],{"class":79,"line":116},[77,610,611],{},"    F --> G[Return Blog Content to Domestic Visitors]\n",[77,613,614],{"class":79,"line":123},[77,615,616],{},"    E --> H[Return Blog Content to International Visitors]\n",[16,618,619,620,623,624,629],{},"Caddy can implement HTTP/2 server push through the ",[51,621,622],{},"http.handlers.push"," module. We can write simple push logic in the Caddyfile—no problem there. However, Vercel doesn't provide configuration options for HTTP/2 server push. Fortunately, since I have a static blog with low platform dependency, I considered migrating to Cloudflare Workers, ",[368,625,628],{"href":626,"rel":627},"https://brianli.com/cloudflare-workers-sites-http2-server-push/",[372],"which developers implemented five years ago",".",[20,631,633],{"id":632},"client-support-status","Client Support Status",[16,635,636],{},"Historically, mainstream browser engines (Chrome/Chromium, Firefox, Edge, Safari) widely supported server push technology.",[16,638,639,640,629],{},"In November 2020, Google announced ",[368,641,644],{"href":642,"rel":643},"https://groups.google.com/a/chromium.org/g/blink-dev/c/K3rYLvmQUBY/m/vOWBKZGoAQAJ",[372],"plans to remove server push functionality from Chrome's HTTP/2 and gQUIC (which later evolved into HTTP/3) implementations",[16,646,647,648,653],{},"In October 2022, Google announced ",[368,649,652],{"href":650,"rel":651},"https://developer.chrome.com/blog/removing-push/",[372],"plans to remove server push from Chrome",", citing poor real-world performance, low adoption rates, and better alternatives. Chrome 106 became the first version to disable server push by default.",[16,655,656,657],{},"On October 29, 2024, Mozilla released Firefox 132, ",[368,658,661],{"href":659,"rel":660},"https://www.firefox.com/en-US/firefox/132.0/releasenotes/",[372],"removing support for HTTP/2 server push due to \"compatibility issues with multiple websites.\"",[16,663,664],{},"With this, mainstream browser support for HTTP/2 Server Push has completely ended. From initially being viewed as an innovative feature to \"reduce round-trip latency and optimize first-screen loading,\" to its eventual complete deprecation, HTTP/2 push's lifecycle lasted only a few short years, becoming an important experiment in web performance optimization history.",[20,666,668],{"id":667},"alternative-solutions","Alternative Solutions",[320,670,672],{"id":671},"_1-http-103-early-hints","1. HTTP 103 Early Hints",[16,674,675],{},"103 Early Hints is the most direct \"successor\" to server push. It's an informational HTTP status code that allows the server to send an \"early hint\" response with Link headers before generating the complete HTML response (e.g., status code 200 OK).",[16,677,678],{},"This Link header can tell the browser: \"Hey, I'm still preparing the main course (HTML), but you can start preparing the side dishes (CSS, JS) first.\" This way, the browser can utilize the server's \"thinking time\" to preemptively download critical resources or warm up connections to required origins, significantly reducing first-screen rendering time.",[16,680,681],{},"Compared to server push:",[265,683,684,687],{},[31,685,686],{},"Decision authority lies with the client: Early Hints are just \"hints.\" The browser can decide whether to adopt them based on its own cache status, network conditions, and other factors. This solves server push's biggest pain point—servers cannot know about client caches, leading to redundant resource pushes.",[31,688,689],{},"Better compatibility: It's a lighter mechanism that's easier for intermediary proxy servers to understand and relay.",[16,691,692,693,696,697,700,701,704],{},"103 Early Hints is very meaningful for dynamic blogs. Before backend computation, the 103 response can inform the browser about needed resources, allowing the browser to retrieve other resources first while waiting for the backend to return the final HTML. However, ",[34,694,695],{},"for static blogs"," like mine where ",[34,698,699],{},"everything is pre-built",", it has ",[34,702,703],{},"absolutely no meaning",". The gateway has enough time to send the 103 response that it could just directly send the HTML instead.",[320,706,708],{"id":707},"_2-resource-hints-preload-prefetch","2. Resource Hints: Preload & Prefetch",[16,710,711,712,715],{},"Even before server push was deprecated, resource hints implemented through ",[51,713,714],{},"\u003Clink>"," tags were already common tools for front-end performance optimization. They declare resource loading hints in HTML, with the browser leading the entire process.",[265,717,718,724],{},[31,719,720,723],{},[51,721,722],{},"\u003Clink rel=\"preload\">",": Tells the browser about resources that the current page will definitely use, requesting immediate high-priority loading without execution. For example, font files hidden deep in CSS or first-screen images dynamically loaded by JS. Through preload, you can ensure these critical resources are discovered and downloaded early, avoiding render blocking.",[31,725,726,729],{},[51,727,728],{},"\u003Clink rel=\"prefetch\">",": Tells the browser about pages or resources the user might access in the future, requesting low-priority background downloads during browser idle time. For example, prefetching article page resources that users are most likely to click on the article list page, achieving near-\"instant\" navigation experience.",[16,731,732,733,629],{},"Preload and Prefetch completely hand over resource loading control to developers and browsers. Through declarative methods, they allow fine-grained management of resource loading priority and timing. They are currently the most mature and widely applied resource preloading solutions, but still ",[34,734,735],{},"cannot escape the curse of 2 RTTs",[20,737,739],{"id":738},"epilogue-an-elegy-for-an-idealist","Epilogue: An Elegy for an Idealist",[16,741,742],{},"In the end, I couldn't configure HTTP/2 server push for my blog.",[16,744,745],{},[34,746,747],{},"HTTP/2 Server Push has effectively \"died.\" I miss it.",[16,749,750],{},"In an ideal model, when the browser requests HTML, the server conveniently pushes the CSS and JS needed for rendering along with it, cleanly compressing what would originally be at least two round trips (RTT) into one. This is such a direct, such an elegant solution—almost the \"silver bullet\" that front-end engineers dream of when facing first-screen rendering latency issues. Behind it lies an ambitious spirit: attempting to thoroughly solve the \"critical request chain\" latency problem from the server side, once and for all.",[16,752,753],{},"But the Web world is ultimately not an ideal laboratory. It's full of caches, returning users, and all kinds of network environments.",[16,755,756],{},"The greatest charm of server push lies in its \"proactivity,\" and its greatest regret also stems precisely from this \"proactivity.\" It cannot know whether the browser's cache already quietly holds that style.css file it's preparing to enthusiastically push. For the sake of the ultimate experience for a small portion of first-time visitors, it might waste precious bandwidth for more returning users.",[16,758,759,760,763,764,767],{},"The Web's evolution ultimately chose a more prudent path with a more collaborative spirit. It returned decision-making authority to the browser, which knows the situation best. The entire interaction changed from the server's \"",[34,761,762],{},"I push to you","\" to the server's \"",[34,765,766],{},"I suggest you fetch",",\" with the browser making its own judgment. This may not be romantic enough, not extreme enough, but it's more universal and more robust.",[16,769,770],{},"So, I still miss that ambitious Server Push. It represented a pure pursuit of ultimate performance, a beautiful technical idealism. Although it has quietly faded from the historical stage, the dream about \"speed\" it pointed toward has long been inherited by 103 Early Hints and preload in a more mature, more balanced way.",[20,772,774],{"id":773},"see-also","See Also",[265,776,777,784,791,797,804,810],{},[31,778,779],{},[368,780,783],{"href":781,"rel":782},"https://developer.chrome.com/blog/removing-push",[372],"Remove HTTP/2 Server Push from Chrome  |  Blog  |  Chrome for Developers",[31,785,786],{},[368,787,790],{"href":788,"rel":789},"https://en.wikipedia.org/wiki/HTTP/2_Server_Push",[372],"HTTP/2 Server Push - Wikipedia",[31,792,793],{},[368,794,796],{"href":552,"rel":795},[372],"静态资源递送优化：HTTP/2 和 Server Push | Sukka's Blog",[31,798,799],{},[368,800,803],{"href":801,"rel":802},"https://caddyserver.com/docs/modules/http.handlers.push",[372],"Module http.handlers.push - Caddy Documentation",[31,805,806],{},[368,807,809],{"href":626,"rel":808},[372],"How to Configure HTTP/2 Server Push on Cloudflare Workers Sites",[31,811,812],{},[368,813,815],{"href":642,"rel":814},[372],"Intent to Remove: HTTP/2 and gQUIC server push",[382,817,384],{},{"title":73,"searchDepth":86,"depth":86,"links":819},[820,821,822,823,827,828],{"id":412,"depth":86,"text":413},{"id":567,"depth":86,"text":568},{"id":632,"depth":86,"text":633},{"id":667,"depth":86,"text":668,"children":824},[825,826],{"id":671,"depth":92,"text":672},{"id":707,"depth":92,"text":708},{"id":738,"depth":86,"text":739},{"id":773,"depth":86,"text":774},{"title":830,"date":398,"path":831,"tags":832,"body":833},"HTTP/2 Server Push 已事实性“死亡”，我很怀念它","/2025/11/05/http-2-server-push-is-practically-obsolete",[401,402,11,403,404],{"type":13,"value":834,"toc":1206},[835,838,842,852,906,913,964,972,977,980,983,986,1029,1040,1043,1046,1053,1061,1068,1071,1074,1076,1079,1082,1085,1093,1107,1111,1117,1129,1135,1139,1142,1147,1150,1153,1156,1167,1170,1172,1204],[16,836,837],{},"我最近一阵子在重构我的博客，恰巧之前一阵子准备秋招的时候背八股时看到了 HTTP/2 的服务端推送，于是便尝试在部署阶段为我的博客配置好 HTTP/2 的服务端推送，试图以此来进一步优化首屏加载速度。",[20,839,841],{"id":840},"http2-服务端推送为什么能提升首屏加载速度","HTTP/2 服务端推送为什么能提升首屏加载速度",[16,843,844,845,847,848,851],{},"如下图，在传统的 HTTP/1.1 中，浏览器会先下载 ",[51,846,419],{}," 并完成第一轮解析，然后再从解析出的数据中拿到 css/js 资源的 url，再进行第二轮请求，在 tcp/tls 连接建立后最小需要",[34,849,850],{},"两个 RTT 才能取回","完整渲染页面所需的资源。",[68,853,855],{"className":70,"code":854,"language":72,"meta":73,"style":73},"sequenceDiagram\n    participant Browser\n    participant Server\n\n    Browser->>Server: GET /index.html\n    Server-->>Browser: 200 OK + HTML\n    Browser->>Server: GET /style.css\n    Browser->>Server: GET /app.js\n    Server-->>Browser: 200 OK + CSS\n    Server-->>Browser: 200 OK + JS\n\n    Note over Browser: 浏览器必须等 HTML 下载并解析后\u003Cbr/>才能发起后续请求，增加往返延迟 (RTT)\n\n",[51,856,857,861,865,869,873,877,881,885,889,893,897,901],{"__ignoreMap":73},[77,858,859],{"class":79,"line":80},[77,860,83],{},[77,862,863],{"class":79,"line":86},[77,864,438],{},[77,866,867],{"class":79,"line":92},[77,868,443],{},[77,870,871],{"class":79,"line":98},[77,872,120],{"emptyLinePlaceholder":119},[77,874,875],{"class":79,"line":104},[77,876,452],{},[77,878,879],{"class":79,"line":110},[77,880,457],{},[77,882,883],{"class":79,"line":116},[77,884,462],{},[77,886,887],{"class":79,"line":123},[77,888,467],{},[77,890,891],{"class":79,"line":129},[77,892,472],{},[77,894,895],{"class":79,"line":134},[77,896,477],{},[77,898,899],{"class":79,"line":140},[77,900,120],{"emptyLinePlaceholder":119},[77,902,903],{"class":79,"line":146},[77,904,905],{},"    Note over Browser: 浏览器必须等 HTML 下载并解析后\u003Cbr/>才能发起后续请求，增加往返延迟 (RTT)\n",[16,907,908,909,912],{},"而在 HTTP/2 的设想中，流程则是像下面这张图一样。当浏览器请求 index.html 时，服务端可以顺带将 css/js 资源一起推送给客户端，这样在 tcp/tls 连接建立后最小只需要",[34,910,911],{},"一个 RTT 就可以","将页面渲染所需的资源取回。",[68,914,916],{"className":70,"code":915,"language":72,"meta":73,"style":73},"sequenceDiagram\n    participant Browser\n    participant Server\n\n    Browser->>Server: GET /index.html\n    Server-->>Browser: 200 OK + HTML\n    Server-->>Browser: PUSH_PROMISE /style.css\n    Server-->>Browser: PUSH_PROMISE /app.js\n    Server-->>Browser: (推送) style.css + app.js 内容\n\n    Note over Browser: 浏览器收到资源前置推送\u003Cbr/>减少请求轮次与首屏延迟\n\n",[51,917,918,922,926,930,934,938,942,946,950,955,959],{"__ignoreMap":73},[77,919,920],{"class":79,"line":80},[77,921,83],{},[77,923,924],{"class":79,"line":86},[77,925,438],{},[77,927,928],{"class":79,"line":92},[77,929,443],{},[77,931,932],{"class":79,"line":98},[77,933,120],{"emptyLinePlaceholder":119},[77,935,936],{"class":79,"line":104},[77,937,452],{},[77,939,940],{"class":79,"line":110},[77,941,457],{},[77,943,944],{"class":79,"line":116},[77,945,527],{},[77,947,948],{"class":79,"line":123},[77,949,532],{},[77,951,952],{"class":79,"line":129},[77,953,954],{},"    Server-->>Browser: (推送) style.css + app.js 内容\n",[77,956,957],{"class":79,"line":134},[77,958,120],{"emptyLinePlaceholder":119},[77,960,961],{"class":79,"line":140},[77,962,963],{},"    Note over Browser: 浏览器收到资源前置推送\u003Cbr/>减少请求轮次与首屏延迟\n",[16,965,966,967,971],{},"为了在 HTTP/1.1 中尽可能减少后续的请求，前端开发者尝试了非常多的优化手段，正如 Sukka 在《",[368,968,970],{"href":552,"rel":969},[372],"静态资源递送优化：HTTP/2 和 Server Push","》一文中所讲：",[557,973,974],{},[16,975,976],{},"关键资源、关键渲染路径、关键请求链的概念诞生已久，异步加载资源的概念可谓是老生常谈：懒加载图片、视频、iframe，乃至懒加载 CSS、JS、DOM，懒执行函数。但是，关键资源递送的思路却依然没有多少改变。",[16,978,979],{},"HTTP/2 的 Server Push 创造了新的资源递送思路，CSS/JS 等资源不用随着 html 一起递送也能在一个 RTT 内被传送到客户端，而这一部分资源可以被浏览器缓存起来，不被 html 那较短的 TTL 所限制。",[20,981,982],{"id":982},"初步方案",[16,984,985],{},"既然理清了 HTTP/2 服务端推送的优势，于是准备着手优化。我的博客是纯静态的，通过 DNS 进行境内外分流：境内流量会访问到 DMIT 一台带有 cmin2/9929 网络优化的 vps 上，通过 caddy 提供服务；境外流量则是直接打到 vercel，借助 Amazon 的 CDN 为全球网络提供边缘加速。网络架构大概是下面这个样子：",[68,987,989],{"className":70,"code":988,"language":72,"meta":73,"style":73},"graph TD\n    A[博客访客] --> B[发起DNS解析请求]\n    B --> C[DNSPod 服务]\n    C -->|境内访客：智能分流| D[网络优化 VPS]\n    C -->|境外访客：智能分流| E[Vercel 平台]\n    D --> F[Caddy]\n    F --> G[返回博客内容给境内访客]\n    E --> H[返回博客内容给境外访客]\n",[51,990,991,995,1000,1005,1010,1015,1019,1024],{"__ignoreMap":73},[77,992,993],{"class":79,"line":80},[77,994,581],{},[77,996,997],{"class":79,"line":86},[77,998,999],{},"    A[博客访客] --> B[发起DNS解析请求]\n",[77,1001,1002],{"class":79,"line":92},[77,1003,1004],{},"    B --> C[DNSPod 服务]\n",[77,1006,1007],{"class":79,"line":98},[77,1008,1009],{},"    C -->|境内访客：智能分流| D[网络优化 VPS]\n",[77,1011,1012],{"class":79,"line":104},[77,1013,1014],{},"    C -->|境外访客：智能分流| E[Vercel 平台]\n",[77,1016,1017],{"class":79,"line":110},[77,1018,606],{},[77,1020,1021],{"class":79,"line":116},[77,1022,1023],{},"    F --> G[返回博客内容给境内访客]\n",[77,1025,1026],{"class":79,"line":123},[77,1027,1028],{},"    E --> H[返回博客内容给境外访客]\n",[16,1030,1031,1032,1034,1035,1039],{},"Caddy 可以通过 ",[51,1033,622],{}," 模块实现 HTTP/2 的服务端推送，在 Caddyfile 中我们可以编写简单的推送逻辑，这没问题；vercel 平台则没有给开发者提供 HTTP/2 服务端推送的配置项，但好在我是静态博客，对平台依赖性不强，考虑迁移到 Cloudflare Workers，",[368,1036,1038],{"href":626,"rel":1037},[372],"五年前就有开发者实现了","。",[20,1041,1042],{"id":1042},"客户端的支持情况",[16,1044,1045],{},"历史上主流浏览器引擎（Chrome/Chromium、Firefox、Edge、Safari）曾普遍支持服务器推送技术。",[16,1047,1048,1049,1039],{},"2020 年 11 月，谷歌宣布",[368,1050,1052],{"href":642,"rel":1051},[372],"计划在其 Chrome 浏览器的 HTTP/2 及 gQUIC（后发展为HTTP/3）实现中移除服务器推送功能",[16,1054,1055,1056,1060],{},"2022 年 10 月，谷歌宣布",[368,1057,1059],{"href":650,"rel":1058},[372],"计划从Chrome浏览器中移除服务器推送功能","，指出该扩展在实际应用中性能不佳、使用率低且存在更优替代方案。Chrome 106 成为首个默认禁用服务器推送的版本。",[16,1062,1063,1064],{},"2024 年 10 月 29 日，Mozilla 发布了 Firefox 132版本，",[368,1065,1067],{"href":659,"rel":1066},[372],"因“与多个网站存在兼容性问题”移除了对HTTP/2服务器推送功能的支持。",[16,1069,1070],{},"至此，主流浏览器对 HTTP/2 服务端推送（Server Push）的支持已全部终结。从最初被视为“减少往返延迟、优化首屏加载”的创新特性，到最终被全面弃用，HTTP/2 推送的生命周期不过短短数年，成为 Web 性能优化历史上的一次重要实验。",[20,1072,1073],{"id":1073},"替代方案",[320,1075,672],{"id":671},[16,1077,1078],{},"103 Early Hints 是对服务端推送最直接的“继任者”。它是一个信息性的 HTTP 状态码 (Informational Response)，允许服务器在生成完整的 HTML 响应（例如，状态码为 200 OK）之前，先发送一个带有 Link 头部的“早期提示”响应。",[16,1080,1081],{},"这个 Link 头部可以告诉浏览器：“嘿，我还在准备主菜（HTML），但你可以先去把配菜（CSS、JS）准备好”。这样，浏览器就能利用服务器的“思考时间”提前开始下载关键资源或预热到所需源的连接，从而显著缩短首屏渲染时间。",[16,1083,1084],{},"与服务端推送的对比：",[265,1086,1087,1090],{},[31,1088,1089],{},"决策权在客户端：Early Hints 只是“提示”，浏览器可以根据自身缓存情况、网络状况等因素决定是否采纳该提示。这就解决了服务端推送最大的痛点——服务器无法知晓客户端缓存而导致推送冗余资源。",[31,1091,1092],{},"兼容性更好：它是一种更轻量、更易于中间代理服务器理解和传递的机制。",[16,1094,1095,1096,1098,1099,1102,1103,1106],{},"103 Early Hints 对动态博客很有意义，在后端进行计算之前先把需要的资源通过 103 响应告知浏览器，让浏览器先取回其他资源，再等待后端返回最终的 html；而",[34,1097,236],{},"我这种产物都是预构建好的",[34,1100,1101],{},"静态博客","，完全",[34,1104,1105],{},"没有任何意义","，网关有那个发 103 响应的闲工夫完全可以把 html 直接发过去了。",[320,1108,1110],{"id":1109},"_2-资源提示resource-hints-preload-prefetch","2. 资源提示（Resource Hints）: Preload & Prefetch",[16,1112,1113,1114,1116],{},"早在服务端推送被弃用前，通过 ",[51,1115,714],{},"标签实现的资源提示就已经是前端性能优化的常用手段。它们将资源加载的提示声明在 HTML 中，由浏览器主导整个过程。",[265,1118,1119,1124],{},[31,1120,1121,1123],{},[51,1122,722],{},": 用于告诉浏览器当前页面必定会用到的资源，请以高优先级立即开始加载，但加载后不执行。比如，隐藏在 CSS 深处的字体文件或由 JS 动态加载的首屏图片。通过 Preload，可以确保这些关键资源能尽早被发现和下载，避免渲染阻塞。",[31,1125,1126,1128],{},[51,1127,728],{},": 用于告诉浏览器用户在未来可能访问的页面或用到的资源，请在浏览器空闲时以低优先级在后台下载。例如，在文章列表页 prefetch 用户最可能点击的文章页面的资源，从而实现近乎“秒开”的跳转体验。",[16,1130,1131,1132,1039],{},"Preload 和 Prefetch 将资源加载的控制权完全交给了开发者和浏览器，通过声明式的方式精细化管理资源加载的优先级和时机，是目前最成熟、应用最广泛的资源预加载方案，但仍然",[34,1133,1134],{},"逃不过 2 RTT 的魔咒",[20,1136,1138],{"id":1137},"尾声写给一个理想主义者的挽歌","尾声：写给一个理想主义者的挽歌",[16,1140,1141],{},"写到最后，我终究是没能为我的博客配上 HTTP/2 服务端推送。",[16,1143,1144],{},[34,1145,1146],{},"HTTP/2 Server Push 已事实性“死亡”，我很怀念它。",[16,1148,1149],{},"在一个理想模型里，当浏览器请求 HTML 时，服务器顺手将渲染所需的 CSS 和 JS  一并推来，将原本至少两次的往返（RTT）干脆利落地压缩为一次。这是一个如此直接、如此漂亮的解决方案，几乎是前端工程师面对首屏渲染延迟问题时梦寐以求的“银弹”。它背后蕴含的是一种雄心勃勃的魄力：试图由服务端一次性地、彻底地解决“关键请求链”的延迟问题。",[16,1151,1152],{},"但 Web 的世界终究不是一个理想的实验室。它充满了缓存、重复访问的用户、以及形形色色的网络环境。",[16,1154,1155],{},"服务端推送最大的魅力，在于它的“主动”，而它最大的遗憾，也恰恰源于这份“主动”。它无法知晓浏览器缓存中是否早已静静躺着那个它正准备满腔热情推送的 style.css 文件。为了那一小部分首次访问用户的极致体验，却可能要以浪费更多再次访问用户的宝贵带宽为代价。",[16,1157,1158,1159,1162,1163,1166],{},"Web 的演进最终选择了一条更稳妥、更具协作精神的道路。它将决策权交还给了最了解情况的浏览器，整个交互从服务器的“",[34,1160,1161],{},"我推送给你","”，变成了服务器的“",[34,1164,1165],{},"我建议你拿","”，再由浏览器自己定夺。这或许不够浪漫，不够极致，但它更普适，也更健壮。",[16,1168,1169],{},"所以，我依然会怀念那个雄心勃勃的 Server Push。它代表了一种对极致性能的纯粹追求，一种美好的技术理想主义。尽管它已悄然淡出历史舞台，但它所指向的那个关于“速度”的梦想，早已被 103 Early Hints 和 preload 以一种更成熟、更懂得权衡的方式继承了下来。",[20,1171,362],{"id":362},[265,1173,1174,1179,1184,1189,1194,1199],{},[31,1175,1176],{},[368,1177,783],{"href":781,"rel":1178},[372],[31,1180,1181],{},[368,1182,790],{"href":788,"rel":1183},[372],[31,1185,1186],{},[368,1187,796],{"href":552,"rel":1188},[372],[31,1190,1191],{},[368,1192,803],{"href":801,"rel":1193},[372],[31,1195,1196],{},[368,1197,809],{"href":626,"rel":1198},[372],[31,1200,1201],{},[368,1202,815],{"href":642,"rel":1203},[372],[382,1205,384],{},{"title":73,"searchDepth":86,"depth":86,"links":1207},[1208,1209,1210,1211,1215,1216],{"id":840,"depth":86,"text":841},{"id":982,"depth":86,"text":982},{"id":1042,"depth":86,"text":1042},{"id":1073,"depth":86,"text":1073,"children":1212},[1213,1214],{"id":671,"depth":92,"text":672},{"id":1109,"depth":92,"text":1110},{"id":1137,"depth":86,"text":1138},{"id":362,"depth":86,"text":362},{"title":1218,"date":1219,"path":1220,"tags":1221,"body":1225},"Nuxt Content v3 中数组字段的筛选困境与性能优化","2025-10-20 21:52:59","/2025/10/20/nuxt-content-v3-z-array-query-challenge",[1222,1223,1224],"Nuxt","Nuxt Content","JavaScript",{"type":13,"value":1226,"toc":2246},[1227,1242,1245,1296,1303,1307,1317,1445,1460,1638,1647,1657,1661,1664,1939,1945,1963,1970,1975,1979,1990,2007,2013,2027,2197,2200,2208,2214,2220,2225,2227,2234,2243],[16,1228,1229,1230,1233,1234,1237,1238,1241],{},"Nuxt Content 是 Nuxt 生态中用于处理 Markdown、YAML 等内容的强大模块。最近，我在使用 ",[34,1231,1232],{},"Nuxt v4 + Nuxt Content v3"," 重构博客（原为 Hexo）时，遇到了一个棘手的问题：v3 版本的默认查询 API ",[34,1235,1236],{},"并未直接提供","对数组字段进行“包含”（",[51,1239,1240],{},"$contains","）操作的支持。",[16,1243,1244],{},"例如，这是我的正在写的这篇博客的 Front Matter：",[68,1246,1250],{"className":1247,"code":1248,"language":1249,"meta":73,"style":73},"language-markdown shiki shiki-themes one-light one-dark-pro","---\ntitle: Nuxt Content v3 中数组字段的筛选困境\ndate: 2025-10-20 21:52:59\nsticky:\ntags:\n- Nuxt\n- Nuxt Content\n- JavaScript\n---\n","markdown",[51,1251,1252,1257,1262,1267,1272,1277,1282,1287,1292],{"__ignoreMap":73},[77,1253,1254],{"class":79,"line":80},[77,1255,1256],{},"---\n",[77,1258,1259],{"class":79,"line":86},[77,1260,1261],{},"title: Nuxt Content v3 中数组字段的筛选困境\n",[77,1263,1264],{"class":79,"line":92},[77,1265,1266],{},"date: 2025-10-20 21:52:59\n",[77,1268,1269],{"class":79,"line":98},[77,1270,1271],{},"sticky:\n",[77,1273,1274],{"class":79,"line":104},[77,1275,1276],{},"tags:\n",[77,1278,1279],{"class":79,"line":110},[77,1280,1281],{},"- Nuxt\n",[77,1283,1284],{"class":79,"line":116},[77,1285,1286],{},"- Nuxt Content\n",[77,1288,1289],{"class":79,"line":123},[77,1290,1291],{},"- JavaScript\n",[77,1293,1294],{"class":79,"line":129},[77,1295,1256],{},[16,1297,1298,1299,1302],{},"我的目标是创建一个 ",[34,1300,1301],{},"Tag 页面","，列出所有包含特定 Tag（例如 'Nuxt'）的文章。",[20,1304,1306],{"id":1305},"v2-的便捷与-v3-的限制","v2 的便捷与 v3 的限制",[16,1308,1309,1310,1313,1314,1316],{},"在 Nuxt Content v2 中，数据基于文件系统存储，查询方式是对文件内容的抽象，模拟了类似 ",[34,1311,1312],{},"MongoDB 的 JSON 文档查询","语法。我们可以轻松地使用 ",[51,1315,1240],{}," 方法获取所有包含 “Nuxt” 标签的文章：",[68,1318,1322],{"className":1319,"code":1320,"language":1321,"meta":73,"style":73},"language-typescript shiki shiki-themes one-light one-dark-pro","const tag = decodeURIComponent(route.params.tag as string)\n\nconst articles = await queryContent('posts')\n  .where({ tags: { $contains: tag } })  // ✅ v2 中的 MongoDB Style 查询\n  .find()\n","typescript",[51,1323,1324,1373,1377,1400,1435],{"__ignoreMap":73},[77,1325,1326,1330,1334,1338,1342,1346,1350,1352,1356,1358,1362,1366,1370],{"class":79,"line":80},[77,1327,1329],{"class":1328},"sLKXg","const",[77,1331,1333],{"class":1332},"sNmU0"," tag",[77,1335,1337],{"class":1336},"s_Sar"," =",[77,1339,1341],{"class":1340},"sAdtL"," decodeURIComponent",[77,1343,1345],{"class":1344},"s5ixo","(",[77,1347,1349],{"class":1348},"s7GmK","route",[77,1351,629],{"class":1344},[77,1353,1355],{"class":1354},"s2QsP","params",[77,1357,629],{"class":1344},[77,1359,1361],{"class":1360},"sJa8x","tag",[77,1363,1365],{"class":1364},"sblXP"," as",[77,1367,1369],{"class":1368},"sN9Y4"," string",[77,1371,1372],{"class":1344},")\n",[77,1374,1375],{"class":79,"line":86},[77,1376,120],{"emptyLinePlaceholder":119},[77,1378,1379,1381,1384,1386,1389,1392,1394,1398],{"class":79,"line":92},[77,1380,1329],{"class":1328},[77,1382,1383],{"class":1332}," articles",[77,1385,1337],{"class":1336},[77,1387,1388],{"class":1328}," await",[77,1390,1391],{"class":1340}," queryContent",[77,1393,1345],{"class":1344},[77,1395,1397],{"class":1396},"sDhpE","'posts'",[77,1399,1372],{"class":1344},[77,1401,1402,1405,1408,1411,1414,1418,1421,1423,1425,1428,1431],{"class":79,"line":98},[77,1403,1404],{"class":1344},"  .",[77,1406,1407],{"class":1340},"where",[77,1409,1410],{"class":1344},"({ ",[77,1412,1413],{"class":1360},"tags",[77,1415,1417],{"class":1416},"st7oF",":",[77,1419,1420],{"class":1344}," { ",[77,1422,1240],{"class":1360},[77,1424,1417],{"class":1416},[77,1426,1333],{"class":1427},"sz0mV",[77,1429,1430],{"class":1344}," } })  ",[77,1432,1434],{"class":1433},"sW2Sy","// ✅ v2 中的 MongoDB Style 查询\n",[77,1436,1437,1439,1442],{"class":79,"line":104},[77,1438,1404],{"class":1344},[77,1440,1441],{"class":1340},"find",[77,1443,1444],{"class":1344},"()\n",[16,1446,1447,1448,1455,1456,1459],{},"但在使用 ",[34,1449,1450,1451,1454],{},"Nuxt Content v3 的 ",[51,1452,1453],{},"queryCollection"," API"," 时，我们很自然地会尝试使用 ",[51,1457,1458],{},".where()"," 方法进行筛选：",[68,1461,1463],{"className":1319,"code":1462,"language":1321,"meta":73,"style":73},"const tag = decodeURIComponent(route.params.tag as string)\n\nconst { data } = await useAsyncData(`tag-${tag}`, () =>\n    queryCollection('posts')\n        .where(tag, 'in', 'tags')  // ❌ 这样会报错，因为第一次参数必须是字段名\n        .order('date', 'DESC')\n        .select('title', 'date', 'path', 'tags')\n        .all()\n)\n",[51,1464,1465,1493,1497,1540,1551,1579,1598,1625,1634],{"__ignoreMap":73},[77,1466,1467,1469,1471,1473,1475,1477,1479,1481,1483,1485,1487,1489,1491],{"class":79,"line":80},[77,1468,1329],{"class":1328},[77,1470,1333],{"class":1332},[77,1472,1337],{"class":1336},[77,1474,1341],{"class":1340},[77,1476,1345],{"class":1344},[77,1478,1349],{"class":1348},[77,1480,629],{"class":1344},[77,1482,1355],{"class":1354},[77,1484,629],{"class":1344},[77,1486,1361],{"class":1360},[77,1488,1365],{"class":1364},[77,1490,1369],{"class":1368},[77,1492,1372],{"class":1344},[77,1494,1495],{"class":79,"line":86},[77,1496,120],{"emptyLinePlaceholder":119},[77,1498,1499,1501,1503,1506,1509,1512,1514,1517,1519,1522,1526,1528,1531,1534,1537],{"class":79,"line":92},[77,1500,1329],{"class":1328},[77,1502,1420],{"class":1344},[77,1504,1505],{"class":1332},"data",[77,1507,1508],{"class":1344}," } ",[77,1510,1511],{"class":1336},"=",[77,1513,1388],{"class":1328},[77,1515,1516],{"class":1340}," useAsyncData",[77,1518,1345],{"class":1344},[77,1520,1521],{"class":1396},"`tag-",[77,1523,1525],{"class":1524},"sAOjX","${",[77,1527,1361],{"class":1427},[77,1529,1530],{"class":1524},"}",[77,1532,1533],{"class":1396},"`",[77,1535,1536],{"class":1344},", () ",[77,1538,1539],{"class":1328},"=>\n",[77,1541,1542,1545,1547,1549],{"class":79,"line":98},[77,1543,1544],{"class":1340},"    queryCollection",[77,1546,1345],{"class":1344},[77,1548,1397],{"class":1396},[77,1550,1372],{"class":1344},[77,1552,1553,1556,1558,1560,1562,1565,1568,1570,1573,1576],{"class":79,"line":104},[77,1554,1555],{"class":1344},"        .",[77,1557,1407],{"class":1340},[77,1559,1345],{"class":1344},[77,1561,1361],{"class":1427},[77,1563,1564],{"class":1344},", ",[77,1566,1567],{"class":1396},"'in'",[77,1569,1564],{"class":1344},[77,1571,1572],{"class":1396},"'tags'",[77,1574,1575],{"class":1344},")  ",[77,1577,1578],{"class":1433},"// ❌ 这样会报错，因为第一次参数必须是字段名\n",[77,1580,1581,1583,1586,1588,1591,1593,1596],{"class":79,"line":110},[77,1582,1555],{"class":1344},[77,1584,1585],{"class":1340},"order",[77,1587,1345],{"class":1344},[77,1589,1590],{"class":1396},"'date'",[77,1592,1564],{"class":1344},[77,1594,1595],{"class":1396},"'DESC'",[77,1597,1372],{"class":1344},[77,1599,1600,1602,1605,1607,1610,1612,1614,1616,1619,1621,1623],{"class":79,"line":116},[77,1601,1555],{"class":1344},[77,1603,1604],{"class":1340},"select",[77,1606,1345],{"class":1344},[77,1608,1609],{"class":1396},"'title'",[77,1611,1564],{"class":1344},[77,1613,1590],{"class":1396},[77,1615,1564],{"class":1344},[77,1617,1618],{"class":1396},"'path'",[77,1620,1564],{"class":1344},[77,1622,1572],{"class":1396},[77,1624,1372],{"class":1344},[77,1626,1627,1629,1632],{"class":79,"line":123},[77,1628,1555],{"class":1344},[77,1630,1631],{"class":1340},"all",[77,1633,1444],{"class":1344},[77,1635,1636],{"class":79,"line":129},[77,1637,1372],{"class":1344},[16,1639,1640,1641,1643,1644,1039],{},"遗憾的是，这样是行不通的。",[51,1642,1458],{}," 的方法签名要求字段名必须作为首个参数传入：",[51,1645,1646],{},"where(field: keyof Collection | string, operator: SqlOperator, value?: unknown)",[16,1648,1649,1650,1653,1654,1656],{},"由于 Nuxt Content v3 ",[34,1651,1652],{},"底层采用 SQLite 作为本地数据库","，所有查询都必须遵循类 SQL 语法。如果设计时未提供针对数组字段的内置操作符（例如 ",[51,1655,1240],{}," 的 SQL 等价形式），最终的解决方案往往会显得比较“别扭”。",[20,1658,1660],{"id":1659},"初版实现牺牲性能的全量拉取","初版实现：牺牲性能的“全量拉取”",[16,1662,1663],{},"本着“尽快重构，后续优化”的思路，我写出了以下代码：",[68,1665,1667],{"className":1319,"code":1666,"language":1321,"meta":73,"style":73},"// 初版实现：全量拉取后使用 JS 筛选\nconst allPosts = (\n    await useAsyncData(`tag-${route.params.tag}`, () =>\n        queryCollection('posts')\n            .order('date', 'DESC')\n            .select('title', 'date', 'path', 'tags')\n            .all()\n    )\n).data as Ref\u003CPost[]>\n\nconst Posts = computed(() => {\n    return allPosts.value.filter(post =>\n        typeof post.tags?.map === 'function'\n            ? post.tags?.includes(decodeURIComponent(route.params.tag as string))\n            : false\n    )\n})\n",[51,1668,1669,1674,1686,1718,1729,1746,1770,1778,1783,1805,1809,1830,1856,1881,1921,1930,1934],{"__ignoreMap":73},[77,1670,1671],{"class":79,"line":80},[77,1672,1673],{"class":1433},"// 初版实现：全量拉取后使用 JS 筛选\n",[77,1675,1676,1678,1681,1683],{"class":79,"line":86},[77,1677,1329],{"class":1328},[77,1679,1680],{"class":1340}," allPosts",[77,1682,1337],{"class":1336},[77,1684,1685],{"class":1344}," (\n",[77,1687,1688,1691,1693,1695,1697,1699,1701,1704,1706,1708,1710,1712,1714,1716],{"class":79,"line":92},[77,1689,1690],{"class":1328},"    await",[77,1692,1516],{"class":1340},[77,1694,1345],{"class":1344},[77,1696,1521],{"class":1396},[77,1698,1525],{"class":1524},[77,1700,1349],{"class":1348},[77,1702,629],{"class":1703},"sMj0N",[77,1705,1355],{"class":1354},[77,1707,629],{"class":1703},[77,1709,1361],{"class":1360},[77,1711,1530],{"class":1524},[77,1713,1533],{"class":1396},[77,1715,1536],{"class":1344},[77,1717,1539],{"class":1328},[77,1719,1720,1723,1725,1727],{"class":79,"line":98},[77,1721,1722],{"class":1340},"        queryCollection",[77,1724,1345],{"class":1344},[77,1726,1397],{"class":1396},[77,1728,1372],{"class":1344},[77,1730,1731,1734,1736,1738,1740,1742,1744],{"class":79,"line":104},[77,1732,1733],{"class":1344},"            .",[77,1735,1585],{"class":1340},[77,1737,1345],{"class":1344},[77,1739,1590],{"class":1396},[77,1741,1564],{"class":1344},[77,1743,1595],{"class":1396},[77,1745,1372],{"class":1344},[77,1747,1748,1750,1752,1754,1756,1758,1760,1762,1764,1766,1768],{"class":79,"line":110},[77,1749,1733],{"class":1344},[77,1751,1604],{"class":1340},[77,1753,1345],{"class":1344},[77,1755,1609],{"class":1396},[77,1757,1564],{"class":1344},[77,1759,1590],{"class":1396},[77,1761,1564],{"class":1344},[77,1763,1618],{"class":1396},[77,1765,1564],{"class":1344},[77,1767,1572],{"class":1396},[77,1769,1372],{"class":1344},[77,1771,1772,1774,1776],{"class":79,"line":116},[77,1773,1733],{"class":1344},[77,1775,1631],{"class":1340},[77,1777,1444],{"class":1344},[77,1779,1780],{"class":79,"line":123},[77,1781,1782],{"class":1344},"    )\n",[77,1784,1785,1788,1790,1792,1796,1799,1802],{"class":79,"line":129},[77,1786,1787],{"class":1344},").",[77,1789,1505],{"class":1360},[77,1791,1365],{"class":1364},[77,1793,1795],{"class":1794},"sC09Y"," Ref",[77,1797,1798],{"class":1344},"\u003C",[77,1800,1801],{"class":1794},"Post",[77,1803,1804],{"class":1344},"[]>\n",[77,1806,1807],{"class":79,"line":134},[77,1808,120],{"emptyLinePlaceholder":119},[77,1810,1811,1813,1816,1818,1821,1824,1827],{"class":79,"line":140},[77,1812,1329],{"class":1328},[77,1814,1815],{"class":1332}," Posts",[77,1817,1337],{"class":1336},[77,1819,1820],{"class":1340}," computed",[77,1822,1823],{"class":1344},"(() ",[77,1825,1826],{"class":1328},"=>",[77,1828,1829],{"class":1344}," {\n",[77,1831,1832,1835,1837,1839,1842,1844,1847,1849,1853],{"class":79,"line":146},[77,1833,1834],{"class":1328},"    return",[77,1836,1680],{"class":1348},[77,1838,629],{"class":1344},[77,1840,1841],{"class":1354},"value",[77,1843,629],{"class":1344},[77,1845,1846],{"class":1340},"filter",[77,1848,1345],{"class":1344},[77,1850,1852],{"class":1851},"s8iYz","post",[77,1854,1855],{"class":1328}," =>\n",[77,1857,1858,1862,1865,1867,1869,1872,1875,1878],{"class":79,"line":151},[77,1859,1861],{"class":1860},"s7DPa","        typeof",[77,1863,1864],{"class":1348}," post",[77,1866,629],{"class":1344},[77,1868,1413],{"class":1354},[77,1870,1871],{"class":1344},"?.",[77,1873,1874],{"class":1360},"map",[77,1876,1877],{"class":1336}," ===",[77,1879,1880],{"class":1396}," 'function'\n",[77,1882,1883,1886,1888,1890,1892,1894,1897,1899,1902,1904,1906,1908,1910,1912,1914,1916,1918],{"class":79,"line":157},[77,1884,1885],{"class":1860},"            ?",[77,1887,1864],{"class":1348},[77,1889,629],{"class":1344},[77,1891,1413],{"class":1354},[77,1893,1871],{"class":1344},[77,1895,1896],{"class":1340},"includes",[77,1898,1345],{"class":1344},[77,1900,1901],{"class":1340},"decodeURIComponent",[77,1903,1345],{"class":1344},[77,1905,1349],{"class":1348},[77,1907,629],{"class":1344},[77,1909,1355],{"class":1354},[77,1911,629],{"class":1344},[77,1913,1361],{"class":1360},[77,1915,1365],{"class":1364},[77,1917,1369],{"class":1368},[77,1919,1920],{"class":1344},"))\n",[77,1922,1923,1926],{"class":79,"line":163},[77,1924,1925],{"class":1860},"            :",[77,1927,1929],{"class":1928},"sAGMh"," false\n",[77,1931,1932],{"class":79,"line":168},[77,1933,1782],{"class":1344},[77,1935,1936],{"class":79,"line":174},[77,1937,1938],{"class":1344},"})\n",[16,1940,1941,1942],{},"这种方法虽然满足了需求，但也带来了明显的性能代价：",[34,1943,1944],{},"_payload.json 文件体积的膨胀。",[16,1946,1947,1948,1951,1952,1955,1956,1959,1960,1962],{},"在 Nuxt 项目中，",[51,1949,1950],{},"_payload.json"," 用于存储 ",[51,1953,1954],{},"useAsyncData"," 的结果等动态数据。在全量拉取的方案下，",[34,1957,1958],{},"每一个 Tag 页面"," 都会加载包含所有文章信息的 ",[51,1961,1950],{},"，造成数据冗余。很多 Tag 页面仅需一两篇文章的数据，却被迫加载了全部文章信息，严重影响了性能。",[16,1964,1965],{},[1966,1967],"img",{"alt":1968,"src":1969},"tags 目录占据了 2.9MiB，是所有目录中最大的","https://static.031130.xyz/uploads/2025/10/20/a748878c03c64.webp",[16,1971,1972],{},[1966,1973],{"alt":1950,"src":1974},"https://static.031130.xyz/uploads/2025/10/20/8ef786d873da1.webp",[20,1976,1978],{"id":1977},"讨巧方案利用-sqlite-的存储特性进行优化","讨巧方案：利用 SQLite 的存储特性进行优化",[16,1980,1981,1982,1984,1985,1039],{},"为了减少 ",[51,1983,1954],{}," 返回的查询结果，我查阅了 Nuxt Content 的 GitHub Discussions，发现",[368,1986,1989],{"href":1987,"rel":1988},"https://github.com/nuxt/content/discussions/2955",[372],"在 v3.alpha.8 版本时就有人提出了一种“巧妙”的解决方案",[16,1991,1992,1993,2002,2003,2006],{},"由于 Nuxt Content v3 使用 SQLite 数据库，原本在 Front Matter 中定义的 ",[34,1994,1995,1997,1998,2001],{},[51,1996,1413],{}," 数组（通过 ",[51,1999,2000],{},"z.array()"," 定义）最终会以 JSON 字符串的形式存储","在数据库中（具体格式可在 ",[51,2004,2005],{},".nuxt/content/sql_dump.txt"," 文件中查看）。",[16,2008,2009],{},[1966,2010],{"alt":2011,"src":2012},"sql_dump.txt","https://static.031130.xyz/uploads/2025/10/20/b70036c55bb29.webp",[16,2014,2015,2016,2019,2020,2026],{},"这意味着我们可以利用 SQLite 的",[34,2017,2018],{},"字符串操作","特性，通过 ",[34,2021,2022,2025],{},[51,2023,2024],{},"LIKE"," 动词配合通配符","来完成数组包含的筛选，本质上是查询 JSON 字符串是否包含特定子串：",[68,2028,2030],{"className":1319,"code":2029,"language":1321,"meta":73,"style":73},"const tag = decodeURIComponent(route.params.tag as string)\n\nconst { data } = await useAsyncData(`tag-${route.params.tag}`, () =>\n    queryCollection('posts')\n        .where('tags', 'LIKE', `%\"${tag}\"%`)\n        .order('date', 'DESC')\n        .select('title', 'date', 'path', 'tags')\n        .all()\n)\n",[51,2031,2032,2060,2064,2104,2114,2145,2161,2185,2193],{"__ignoreMap":73},[77,2033,2034,2036,2038,2040,2042,2044,2046,2048,2050,2052,2054,2056,2058],{"class":79,"line":80},[77,2035,1329],{"class":1328},[77,2037,1333],{"class":1332},[77,2039,1337],{"class":1336},[77,2041,1341],{"class":1340},[77,2043,1345],{"class":1344},[77,2045,1349],{"class":1348},[77,2047,629],{"class":1344},[77,2049,1355],{"class":1354},[77,2051,629],{"class":1344},[77,2053,1361],{"class":1360},[77,2055,1365],{"class":1364},[77,2057,1369],{"class":1368},[77,2059,1372],{"class":1344},[77,2061,2062],{"class":79,"line":86},[77,2063,120],{"emptyLinePlaceholder":119},[77,2065,2066,2068,2070,2072,2074,2076,2078,2080,2082,2084,2086,2088,2090,2092,2094,2096,2098,2100,2102],{"class":79,"line":92},[77,2067,1329],{"class":1328},[77,2069,1420],{"class":1344},[77,2071,1505],{"class":1332},[77,2073,1508],{"class":1344},[77,2075,1511],{"class":1336},[77,2077,1388],{"class":1328},[77,2079,1516],{"class":1340},[77,2081,1345],{"class":1344},[77,2083,1521],{"class":1396},[77,2085,1525],{"class":1524},[77,2087,1349],{"class":1348},[77,2089,629],{"class":1703},[77,2091,1355],{"class":1354},[77,2093,629],{"class":1703},[77,2095,1361],{"class":1360},[77,2097,1530],{"class":1524},[77,2099,1533],{"class":1396},[77,2101,1536],{"class":1344},[77,2103,1539],{"class":1328},[77,2105,2106,2108,2110,2112],{"class":79,"line":98},[77,2107,1544],{"class":1340},[77,2109,1345],{"class":1344},[77,2111,1397],{"class":1396},[77,2113,1372],{"class":1344},[77,2115,2116,2118,2120,2122,2124,2126,2129,2131,2134,2136,2138,2140,2143],{"class":79,"line":104},[77,2117,1555],{"class":1344},[77,2119,1407],{"class":1340},[77,2121,1345],{"class":1344},[77,2123,1572],{"class":1396},[77,2125,1564],{"class":1344},[77,2127,2128],{"class":1396},"'LIKE'",[77,2130,1564],{"class":1344},[77,2132,2133],{"class":1396},"`%\"",[77,2135,1525],{"class":1524},[77,2137,1361],{"class":1427},[77,2139,1530],{"class":1524},[77,2141,2142],{"class":1396},"\"%`",[77,2144,1372],{"class":1344},[77,2146,2147,2149,2151,2153,2155,2157,2159],{"class":79,"line":110},[77,2148,1555],{"class":1344},[77,2150,1585],{"class":1340},[77,2152,1345],{"class":1344},[77,2154,1590],{"class":1396},[77,2156,1564],{"class":1344},[77,2158,1595],{"class":1396},[77,2160,1372],{"class":1344},[77,2162,2163,2165,2167,2169,2171,2173,2175,2177,2179,2181,2183],{"class":79,"line":116},[77,2164,1555],{"class":1344},[77,2166,1604],{"class":1340},[77,2168,1345],{"class":1344},[77,2170,1609],{"class":1396},[77,2172,1564],{"class":1344},[77,2174,1590],{"class":1396},[77,2176,1564],{"class":1344},[77,2178,1618],{"class":1396},[77,2180,1564],{"class":1344},[77,2182,1572],{"class":1396},[77,2184,1372],{"class":1344},[77,2186,2187,2189,2191],{"class":79,"line":123},[77,2188,1555],{"class":1344},[77,2190,1631],{"class":1340},[77,2192,1444],{"class":1344},[77,2194,2195],{"class":79,"line":129},[77,2196,1372],{"class":1344},[16,2198,2199],{},"下面是优化后重新生成的文件占用，体积减小还是非常显著的",[265,2201,2202,2205],{},[31,2203,2204],{},"tags 目录体积: 2.9MiB -> 1.4MiB",[31,2206,2207],{},"单个 _payload.json 的体积: 23.1KiB -> 1.01 KiB",[16,2209,2210,2211,2213],{},"通过这种方法，我们成功将查询逻辑下推到了数据库层，避免了不必要的全量数据传输，显著降低了单个目录中 ",[51,2212,1950],{}," 的体积，实现了性能优化。",[16,2215,2216],{},[1966,2217],{"alt":2218,"src":2219},"tags 目录体积下降","https://static.031130.xyz/uploads/2025/10/20/007e72e7b476d.webp",[16,2221,2222],{},[1966,2223],{"alt":1950,"src":2224},"https://static.031130.xyz/uploads/2025/10/20/17ba3ccbbdf9e.webp",[20,2226,362],{"id":362},[16,2228,2229],{},[368,2230,2233],{"href":2231,"rel":2232},"https://content.nuxt.com/docs/utils/query-collection#wherefield-keyof-collection-string-operator-sqloperator-value-unknown",[372],"queryCollection - Nuxt Content",[16,2235,2236],{},[368,2237,2239,2240,2242],{"href":1987,"rel":2238},[372],"How do you query ",[51,2241,2000],{}," fields (e.g. tags) in the latest nuxt-content module (v3.alpha.8) · nuxt/content · Discussion #2955",[382,2244,2245],{},"html .default .shiki span {color: var(--shiki-default);background: var(--shiki-default-bg);font-style: var(--shiki-default-font-style);font-weight: var(--shiki-default-font-weight);text-decoration: var(--shiki-default-text-decoration);}html .shiki span {color: var(--shiki-default);background: var(--shiki-default-bg);font-style: var(--shiki-default-font-style);font-weight: var(--shiki-default-font-weight);text-decoration: var(--shiki-default-text-decoration);}html .dark .shiki span {color: var(--shiki-dark);background: var(--shiki-dark-bg);font-style: var(--shiki-dark-font-style);font-weight: var(--shiki-dark-font-weight);text-decoration: var(--shiki-dark-text-decoration);}html.dark .shiki span {color: var(--shiki-dark);background: var(--shiki-dark-bg);font-style: var(--shiki-dark-font-style);font-weight: var(--shiki-dark-font-weight);text-decoration: var(--shiki-dark-text-decoration);}html pre.shiki code .sLKXg, html code.shiki .sLKXg{--shiki-default:#A626A4;--shiki-dark:#C678DD}html pre.shiki code .sNmU0, html code.shiki .sNmU0{--shiki-default:#986801;--shiki-dark:#E5C07B}html pre.shiki code .s_Sar, html code.shiki .s_Sar{--shiki-default:#0184BC;--shiki-dark:#56B6C2}html pre.shiki code .sAdtL, html code.shiki .sAdtL{--shiki-default:#4078F2;--shiki-dark:#61AFEF}html pre.shiki code .s5ixo, html code.shiki .s5ixo{--shiki-default:#383A42;--shiki-dark:#ABB2BF}html pre.shiki code .s7GmK, html code.shiki .s7GmK{--shiki-default:#383A42;--shiki-dark:#E5C07B}html pre.shiki code .s2QsP, html code.shiki .s2QsP{--shiki-default:#E45649;--shiki-dark:#E5C07B}html pre.shiki code .sJa8x, html code.shiki .sJa8x{--shiki-default:#E45649;--shiki-dark:#E06C75}html pre.shiki code .sblXP, html code.shiki .sblXP{--shiki-default:#383A42;--shiki-dark:#C678DD}html pre.shiki code .sN9Y4, html code.shiki .sN9Y4{--shiki-default:#0184BC;--shiki-dark:#E5C07B}html pre.shiki code .sDhpE, html code.shiki .sDhpE{--shiki-default:#50A14F;--shiki-dark:#98C379}html pre.shiki code .st7oF, html code.shiki .st7oF{--shiki-default:#0184BC;--shiki-dark:#ABB2BF}html pre.shiki code .sz0mV, html code.shiki .sz0mV{--shiki-default:#383A42;--shiki-dark:#E06C75}html pre.shiki code .sW2Sy, html code.shiki .sW2Sy{--shiki-default:#A0A1A7;--shiki-default-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic}html pre.shiki code .sAOjX, html code.shiki .sAOjX{--shiki-default:#CA1243;--shiki-dark:#C678DD}html pre.shiki code .sMj0N, html code.shiki .sMj0N{--shiki-default:#50A14F;--shiki-dark:#ABB2BF}html pre.shiki code .sC09Y, html code.shiki .sC09Y{--shiki-default:#C18401;--shiki-dark:#E5C07B}html pre.shiki code .s8iYz, html code.shiki .s8iYz{--shiki-default:#383A42;--shiki-default-font-style:inherit;--shiki-dark:#E06C75;--shiki-dark-font-style:italic}html pre.shiki code .s7DPa, html code.shiki .s7DPa{--shiki-default:#0184BC;--shiki-dark:#C678DD}html pre.shiki code .sAGMh, html code.shiki .sAGMh{--shiki-default:#986801;--shiki-dark:#D19A66}",{"title":73,"searchDepth":86,"depth":86,"links":2247},[2248,2249,2250,2251],{"id":1305,"depth":86,"text":1306},{"id":1659,"depth":86,"text":1660},{"id":1977,"depth":86,"text":1978},{"id":362,"depth":86,"text":362},{"title":2253,"date":2254,"path":2255,"tags":2256,"body":2263},"后 OCSP 时代，浏览器如何应对证书吊销新挑战","2025-10-16 15:38:50","/2025/10/16/how-s-mozilla-crlite-going-now",[2257,2258,2259,2260,2261,2262],"SSL","Firefox","Web PKI","OCSP","CRLSets","CRLite",{"type":13,"value":2264,"toc":2616},[2265,2268,2277,2286,2297,2302,2306,2317,2320,2327,2337,2344,2348,2355,2359,2362,2365,2373,2377,2380,2389,2409,2412,2416,2419,2432,2435,2459,2478,2481,2488,2491,2494,2498,2501,2525,2532,2538,2540],[16,2266,2267],{},"2023 年 8 月，CA/Browser Forum 通过了一项投票——不再强制要求 Let’s Encrypt 等公开信任的 CA 设立 OCSP Server",[16,2269,2270,2271,2276],{},"2024 年 7 月，Let's Encrypt 发布",[368,2272,2275],{"href":2273,"rel":2274},"https://letsencrypt.org/2024/07/23/replacing-ocsp-with-crls",[372],"博客","，披露其计划关闭 OCSP Server",[16,2278,2279,2280,2285],{},"同年 12 月，Let's Encrypt 发布",[368,2281,2284],{"href":2282,"rel":2283},"https://letsencrypt.org/2024/12/05/ending-ocsp",[372],"其关闭 OCSP Server 的时间计划表","，大致情况如下：",[265,2287,2288,2291,2294],{},[31,2289,2290],{},"2025 年 1 月 30 日 - Let’s Encrypt 不再接受新的包含 OCSP Must-Staple 扩展的证书签发请求，除非你的账号先前申请过此类证书",[31,2292,2293],{},"2025 年 5 月 7 日 - Let's Encrypt 新签发的证书将加入 CRL URLs，不再包含 OCSP URLs，并且所有新的包含 OCSP Must-Staple 扩展的证书签发请求都将被拒绝",[31,2295,2296],{},"2025 年 8 月 6 日 - Let's Encrypt 关闭 OCSP 服务器",[16,2298,2299],{},[34,2300,2301],{},"Let's Encrypt 是全世界最大的免费 SSL 证书颁发机构，而这一举动标志着我们已逐渐步入后 OCSP 时代。",[20,2303,2305],{"id":2304},"ocsp-的困境性能与隐私的权衡","OCSP 的困境：性能与隐私的权衡",[16,2307,2308,2309,2312,2313,2316],{},"Let's Encrypt 这一举动的背后，是人们对 OCSP（在线证书状态协议）长久以来累积的不满。OCSP 作为一种实时查询证书有效性的方式，最初的设想很美好：当浏览器访问一个网站时，它可以向 ",[34,2310,2311],{},"CA（证书颁发机构）"," 的 OCSP 服务器发送一个简短的请求，询问该证书是否仍然有效。这似乎比下载一个巨大的 ",[34,2314,2315],{},"CRL（证书吊销列表）"," 要高效得多。",[16,2318,2319],{},"然而，OCSP 在实际应用中暴露出众多缺陷：",[16,2321,2322,2323,2326],{},"首先是",[34,2324,2325],{},"性能问题","。尽管单个请求很小，但当数百万用户同时访问网站时，OCSP 服务器需要处理海量的实时查询。这不仅给 CA 带来了巨大的服务器压力，也增加了用户访问网站的延迟。如果 OCSP 服务器响应缓慢甚至宕机，浏览器可能会因为无法确认证书状态而中断连接，或者为了用户体验而不得不“睁一只眼闭一只眼”，这都削弱了 OCSP 的安全性。",[16,2328,2329,2330,2333,2334],{},"更严重的是",[34,2331,2332],{},"隐私问题","。每一次 OCSP 查询，都相当于向 CA 报告了用户的访问行为。这意味着 CA 能够知道某个用户在何时访问了哪个网站。虽然 OCSP 查询本身不包含个人身份信息，但将这些信息与 IP 地址等数据结合起来，CA 完全可以建立起用户的浏览习惯画像。对于重视隐私的用户和开发者来说，这种“无声的监视”是不可接受的。",[34,2335,2336],{},"即使 CA 故意不保留这些信息，地区法律也可能强制 CA 收集这些信息。",[16,2338,2339,2340,2343],{},"再者，OCSP  还存在设计上的",[34,2341,2342],{},"安全缺陷","。由于担心连接超时影响用户体验，浏览器通常默认采用 soft-fail 机制：一旦无法连接 OCSP  服务器，便会选择放行而非阻断连接。攻击者恰恰可以利用这一点，通过阻断客户端与 OCSP  服务器之间的通信，使查询始终超时，从而轻松绕过证书状态验证。",[320,2345,2347],{"id":2346},"ocsp-装订-ocsp-stapling","OCSP 装订 (OCSP stapling)",[16,2349,2350,2351,1039],{},"基于上面这些缺陷，我们有了 OCSP 装订 (OCSP stapling) 方案，这",[368,2352,2354],{"href":2353},"/2024/11/19/firefox-is-the-only-mainstream-brower-doing-online-certificate-revocation-checks/#OCSP-%E8%A3%85%E8%AE%A2-OCSP-stapling","在我去年的博客里讲过，欢迎回顾",[320,2356,2358],{"id":2357},"强制-ocsp-装订-ocsp-must-staple","强制 OCSP 装订 (OCSP Must-Staple)",[16,2360,2361],{},"OCSP Must-Staple 是一个在 ssl 证书申请时的拓展项，该扩展会告知浏览器：若在证书中识别到此扩展，则不得向证书颁发机构发送查询请求，而应在握手阶段获取装订式副本。若未能获得有效副本，浏览器应拒绝连接。",[16,2363,2364],{},"这项功能赋予了浏览器开发者 hard-fail 的勇气，但在 OCSP 淡出历史之前，Let's Encrypt 似乎是唯一支持这一拓展的主流 CA，并且这项功能并没有得到广泛使用。",[16,2366,2367,2368,1039],{},"~~本来不想介绍这项功能的（因为根本没人用），但考虑到这东西快入土了，还是给它在中文互联网中立个碑，~~更多信息参考 ",[368,2369,2372],{"href":2370,"rel":2371},"https://letsencrypt.org/2024/12/05/ending-ocsp#must-staple",[372],"Let's Encrypt 的博客",[20,2374,2376],{"id":2375},"chromium-的方案弱水三千只取一瓢","Chromium 的方案：弱水三千只取一瓢",[16,2378,2379],{},"OCSP 的隐私和性能问题并非秘密，浏览器厂商们早就开始了各自的探索。2012 年，Chrome 默认禁用了 CRLs、OCSP 检查，转向自行设计的证书校验机制。",[16,2381,2382,2383,2388],{},"众所周知，吊销列表可以非常庞大。如果浏览器需要下载和解析一个完整的全球吊销列表，那将是一场性能灾难（Mozilla 团队在",[368,2384,2387],{"href":2385,"rel":2386},"https://hacks.mozilla.org/2025/08/crlite-fast-private-and-comprehensive-certificate-revocation-checking-in-firefox/",[372],"今年的博客","中提到，从 3000 个活跃的 CRL 下载的文件大小将达到 300MB）。Chromium 团队通过分析历史数据发现，大多数被吊销的证书属于少数高风险类别，例如证书颁发机构（CA）本身被攻破、或者某些大型网站的证书被吊销。基于此洞察，CRLSets 采取了以下策略：",[28,2390,2391,2397,2403],{},[31,2392,2393,2396],{},[34,2394,2395],{},"分层吊销","：Chromium 不会下载所有被吊销的证书信息，而是由 Google 团队维护一个精简的、包含“最重要”吊销信息的列表。这个列表会定期更新并通过 Chrome 浏览器更新推送给用户。",[31,2398,2399,2402],{},[34,2400,2401],{},"精简高效","：这个列表体积非常小，目前大概只有 600KB。它包含了那些一旦被滥用就会造成大规模安全事故的证书，例如 CA 的中间证书、或者一些知名网站（如 Google、Facebook）的证书。",[31,2404,2405,2408],{},[34,2406,2407],{},"牺牲部分安全性","：这种方案的缺点也很明显——它无法覆盖所有的证书吊销情况。对于一个普通网站的证书被吊销，CRLSets 大概率无法检测到。根据 Mozilla 今年的博客所说，CRLSets 只包含了 1%~2% 的未过期的被吊销证书信息。",[16,2410,2411],{},"虽然 CRLSets 是一种“不完美”的解决方案，但它在性能和可用性之间找到了一个平衡点。它确保了用户在访问主流网站时的基础安全，同时避免了 OCSP 带来的性能和隐私开销。对于 Chromium 而言，与其追求一个在现实中难以完美实现的 OCSP 方案，不如集中精力解决最紧迫的安全威胁。",[20,2413,2415],{"id":2414},"firefox-的方案从-crls-到-crlite","Firefox 的方案：从 CRLs 到 CRLite",[16,2417,2418],{},"与 Chromium 的“只取一瓢”策略不同，Firefox 的开发者们一直在寻找一种既能保证全面性，又能解决性能问题的方案。",[16,2420,2421,2422,2424,2425,2428,2429,1039],{},"为了解决这个问题，Mozilla 提出了一个创新的方案：",[34,2423,2262],{},"。CRLite 的设计理念是通过",[34,2426,2427],{},"哈希函数和布隆过滤器","等数据结构，将庞大的证书吊销列表压缩成一个",[34,2430,2431],{},"小巧、可下载且易于本地验证的格式",[16,2433,2434],{},"CRLite 的工作原理可以简单概括为：",[28,2436,2437,2443,2453],{},[31,2438,2439,2442],{},[34,2440,2441],{},"数据压缩","：CA 定期生成其全部吊销证书的列表。",[31,2444,2445,2448,2449,2452],{},[34,2446,2447],{},"服务器处理","：Mozilla 的服务器会收集这些列表，并使用加密哈希函数和布隆过滤器等技术，将所有吊销证书的信息",[34,2450,2451],{},"编码","成一个非常紧凑的数据结构。",[31,2454,2455,2458],{},[34,2456,2457],{},"客户端验证","：浏览器下载这个压缩文件，当访问网站时，只需本地对证书进行哈希计算，然后查询这个本地文件，就能快速判断该证书是否已被吊销。",[16,2460,2461,2462,2465,2466,2469,2470,2473,2474,2477],{},"与 CRLSets 相比，CRLite 的优势在于它能够实现",[34,2463,2464],{},"对所有吊销证书的全面覆盖","，同时保持",[34,2467,2468],{},"极小的体积","。更重要的是，它",[34,2471,2472],{},"完全在本地完成验证","，这意味着浏览器",[34,2475,2476],{},"无需向任何第三方服务器发送请求","，从而彻底解决了 OCSP 的隐私问题。",[16,2479,2480],{},"Firefox 当前的策略为每 12 小时对 CRLite 数据进行一次增量更新，每日的下载数据大约为 300KB；每 45 天进行一次全量的快照同步，下载数据约为 4MB。",[16,2482,2483,2484],{},"Mozilla 开放了他们的数据看板，你可以在这里找到近期的 CRLite 数据大小：",[368,2485,2486],{"href":2486,"rel":2487},"https://yardstick.mozilla.org/dashboard/snapshot/c1WZrxGkNxdm9oZp7xVvGUEFJCELfApN",[372],[16,2489,2490],{},"自 2025 年 4 月 1 日发布的 Firefox Desktop 137 版本起，Firefox 开始逐步以 CRLite 替换 OCSP 校验；同年 8 月 19 日，Firefox Desktop 142 针对 DV 证书正式弃用 OCSP 检验。",[16,2492,2493],{},"CRLite 已经成为 Firefox 未来证书吊销验证的核心方案，它代表了对性能、隐私和安全性的全面追求。",[20,2495,2497],{"id":2496},"后-ocsp-时代的展望","后 OCSP 时代的展望",[16,2499,2500],{},"随着 Let's Encrypt 等主要 CA 关闭 OCSP 服务，OCSP 的时代正在加速落幕。我们可以看到，浏览器厂商们已经开始各自探索更高效、更安全的替代方案。",[265,2502,2503,2513],{},[31,2504,2505,2508,2509,2512],{},[34,2506,2507],{},"Chromium"," 凭借其 CRLSets 方案，在",[34,2510,2511],{},"性能和关键安全保障","之间取得了务实的平衡。",[31,2514,2515,2517,2518,2520,2521,2524],{},[34,2516,2258],{}," 则通过 ",[34,2519,2262],{}," 这一技术创新，试图在",[34,2522,2523],{},"全面性、隐私和性能","三者之间找到最佳的解决方案。",[16,2526,2527,2528,2531],{},"这些方案的共同点是：",[34,2529,2530],{},"将证书吊销验证从实时在线查询（OCSP）转变为本地化验证","，从而规避了 OCSP 固有的性能瓶颈和隐私风险。",[16,2533,2534,2535],{},"未来，证书吊销的生态系统将不再依赖单一的、中心化的 OCSP 服务器。取而代之的是，一个更加多元、分布式和智能化的新时代正在到来。",[34,2536,2537],{},"OCSP 这一技术可能逐渐被淘汰，但它所试图解决的“证书吊销”这一核心安全问题，将永远是浏览器和网络安全社区关注的重点。",[20,2539,362],{"id":362},[265,2541,2542,2548,2555,2562,2569,2575,2581,2588,2595,2602,2609],{},[31,2543,2544],{},[368,2545,2547],{"href":2385,"rel":2546},[372],"CRLite: Fast, private, and comprehensive certificate revocation checking in Firefox - Mozilla Hacks - the Web developer blog",[31,2549,2550],{},[368,2551,2554],{"href":2552,"rel":2553},"https://www.feistyduck.com/newsletter/issue_121_the_slow_death_of_ocsp",[372],"The Slow Death of OCSP | Feisty Duck",[31,2556,2557],{},[368,2558,2561],{"href":2559,"rel":2560},"https://github.com/mozilla/crlite",[372],"mozilla/crlite: Compact certificate revocation lists for the WebPKI",[31,2563,2564],{},[368,2565,2568],{"href":2566,"rel":2567},"https://letsencrypt.org/2025/08/06/ocsp-service-has-reached-end-of-life",[372],"OCSP Service Has Reached End of Life - Let's Encrypt",[31,2570,2571],{},[368,2572,2574],{"href":2282,"rel":2573},[372],"Ending OCSP Support in 2025 - Let's Encrypt",[31,2576,2577],{},[368,2578,2580],{"href":2273,"rel":2579},[372],"Intent to End OCSP Service - Let's Encrypt",[31,2582,2583],{},[368,2584,2587],{"href":2585,"rel":2586},"https://www.chromium.org/Home/chromium-security/crlsets/",[372],"CRLSets - The Chromium Projects",[31,2589,2590],{},[368,2591,2594],{"href":2592,"rel":2593},"https://www.pcworld.com/article/474296/google_chrome_will_no_longer_check_for_revoked_ssl_certificates_online-2.html",[372],"Google Chrome Will No Longer Check for Revoked SSL Certificates Online | PCWorld",[31,2596,2597],{},[368,2598,2601],{"href":2599,"rel":2600},"https://www.zdnet.com/article/chrome-does-certificate-revocation-better/",[372],"Chrome does certificate revocation better | ZDNET",[31,2603,2604],{},[368,2605,2608],{"href":2606,"rel":2607},"https://www.hats-land.com/WIP/2025-technical-and-analysis-of-mainstream-clientbrowser-certificate-revocation-verification-mechanism.html",[372],"主流客户端/浏览器证书吊销验证机制技术对与分析 | 帽之岛, Hat's Land",[31,2610,2611],{},[368,2612,2615],{"href":2613,"rel":2614},"https://blog.gslin.org/archives/2025/02/02/12239/ocsp-%E7%9A%84%E6%B7%A1%E5%87%BA/",[372],"OCSP 的淡出… – Gea-Suan Lin's BLOG",{"title":73,"searchDepth":86,"depth":86,"links":2617},[2618,2622,2623,2624,2625],{"id":2304,"depth":86,"text":2305,"children":2619},[2620,2621],{"id":2346,"depth":92,"text":2347},{"id":2357,"depth":92,"text":2358},{"id":2375,"depth":86,"text":2376},{"id":2414,"depth":86,"text":2415},{"id":2496,"depth":86,"text":2497},{"id":362,"depth":86,"text":362},{"title":2627,"date":2628,"path":2629,"tags":2630,"body":2635},"初试 Github Action Self-hosted Runner，想说爱你不容易","2025-09-05 05:54:17","/2025/09/05/first-try-of-github-action-self-hosted-runner",[2631,2632,2633,2634],"Github","Github Action","CI/CD","Experience",{"type":13,"value":2636,"toc":2832},[2637,2651,2654,2665,2668,2671,2674,2679,2682,2687,2690,2695,2700,2703,2708,2711,2716,2720,2723,2750,2753,2760,2765,2782,2800,2807,2811,2822,2829],[16,2638,2639,2640,2645,2646,1039],{},"在今年八月的时候，我这边所在的一个 Github Organization 在私有项目开发阶段频繁触发 CI，耗尽了 Github 为免费计划 (Free Plan) 提供的",[368,2641,2644],{"href":2642,"rel":2643},"https://docs.github.com/en/get-started/learning-about-github/githubs-plans#github-free-for-organizations",[372],"每月 2000 分钟 Action 额度","（所有私有仓库共享，公有仓库不计）。大致看了下，CI 流设置得是合理的，那么就要另寻他法看看有没有办法去提供更宽裕的资源，因此也就盯上了文章标题中所提到的 ",[368,2647,2650],{"href":2648,"rel":2649},"https://docs.github.com/en/actions/concepts/runners/self-hosted-runners",[372],"Github Action Self-hosted Runner",[16,2652,2653],{},"对于这个 Self-hosted Runner，与 Github 官方提供的 runner 相比，主要有以下几个优势",[265,2655,2656,2659,2662],{},[31,2657,2658],{},"针对私有仓库，拥有无限制的 Action 运行时长",[31,2660,2661],{},"可以自行搭配更强大的硬件计算能力和内存",[31,2663,2664],{},"可以接入内网环境，方便与内网/局域网设备通信",[20,2666,2667],{"id":2667},"配置安装",[16,2669,2670],{},"由于不清楚需要的网络环境，我这次测试直接选用了一台闲置的香港 vps，4核4G + 80G 硬盘 + 1Gbps 大口子的配置，除了硬盘读写稍微拉胯一些，别的地方可以说是拉满了。",[16,2672,2673],{},"Self-hosted Runner 的配置本身是相当直接和清晰的，照着官方提供的方案基本没什么问题。",[16,2675,2676],{},[1966,2677],{"alt":73,"src":2678},"https://static.031130.xyz/uploads/2025/09/05/7c0475cdb1aa9.webp",[16,2680,2681],{},"三个主流平台都有，如果好好加以利用，应该可以涵盖包括 iPhone 应用打包等一系列的需求。",[16,2683,2684],{},[1966,2685],{"alt":73,"src":2686},"https://static.031130.xyz/uploads/2025/09/05/96ff7cb263da1.webp",[16,2688,2689],{},"在观察一下我这边拿到手的 2.328.0 版本的 runner 安装文件压缩包的体积在 220MB 左右，内置了 node20 和 node24 各两个版本的运行环境。",[16,2691,2692],{},[1966,2693],{"alt":73,"src":2694},"https://static.031130.xyz/uploads/2025/09/05/f775e3bcd2cdc.webp",[16,2696,2697],{},[1966,2698],{"alt":73,"src":2699},"https://static.031130.xyz/uploads/2025/09/05/d0d4fe4611a40.webp",[16,2701,2702],{},"在执行完 config.sh 后，当前目录下就会多出一个 svc.sh，可以帮助利用这东西来调用 systemd 实现进程守护之类的需求。",[16,2704,2705],{},[1966,2706],{"alt":73,"src":2707},"https://static.031130.xyz/uploads/2025/09/05/43c6b19038def.webp",[16,2709,2710],{},"再次刷新网页，就可以看到 Self-hosted Runner 处于已经上线的状态了",[16,2712,2713],{},[1966,2714],{"alt":73,"src":2715},"https://static.031130.xyz/uploads/2025/09/05/6dad15beff900.webp",[20,2717,2719],{"id":2718},"指定-action-采用自己的-runner","指定 Action 采用自己的 Runner",[16,2721,2722],{},"这一步很简单，只需在原 Action 的 yml 文件中改变 runs-on 字段即可",[68,2724,2728],{"className":2725,"code":2726,"language":2727,"meta":73,"style":73},"language-diff shiki shiki-themes one-light one-dark-pro","jobs:\n  run:\n+    runs-on: self-hosted\n-    runs-on: ubuntu-latest\n","diff",[51,2729,2730,2735,2740,2745],{"__ignoreMap":73},[77,2731,2732],{"class":79,"line":80},[77,2733,2734],{"class":1344},"jobs:\n",[77,2736,2737],{"class":79,"line":86},[77,2738,2739],{"class":1344},"  run:\n",[77,2741,2742],{"class":79,"line":92},[77,2743,2744],{"class":1396},"+    runs-on: self-hosted\n",[77,2746,2747],{"class":79,"line":98},[77,2748,2749],{"class":1360},"-    runs-on: ubuntu-latest\n",[20,2751,2752],{"id":2752},"实测",[16,2754,2755,2756,2759],{},"当我满心欢喜地将 CI 流程从 Github 官方的 runner 切换到自托管的 runner 后，问题很快就浮现了，而这也正是我“爱不起来”的主要原因。问题集中体现在我习以为常的 ",[51,2757,2758],{},"setup-python"," 这一由 Github 官方维护的 Github Action Flow 中，提示 3.12 版本没找到。",[16,2761,2762],{},[1966,2763],{"alt":73,"src":2764},"https://static.031130.xyz/uploads/2025/09/05/1c93947170a85.webp",[16,2766,2767,2768,2771,2772,2775,2776,2781],{},"在 Github 官方提供的虚拟环境中，这些 Action 会为我们准备好指定版本的开发环境。例如，",[51,2769,2770],{},"uses: actions/setup-python"," 加上 ",[51,2773,2774],{},"with: python-version: '3.12'"," 就会自动在环境中安装并配置好 Python 3.12.x。我对此已经习以为常，认为这是一个“开箱即用”的功能。但在 Self-hosted Runner 上，情况略有些不同。setup-python 在",[368,2777,2780],{"href":2778,"rel":2779},"https://github.com/actions/setup-python/blob/main/docs/advanced-usage.md#using-setup-python-with-a-self-hosted-runner",[372],"文档","中指出",[557,2783,2784],{},[16,2785,2786,2787,2792,2793,2796,2797,2799],{},"Python distributions are only available for the same ",[368,2788,2791],{"href":2789,"rel":2790},"https://github.com/actions/runner-images#available-images",[372],"environments"," that GitHub Actions hosted environments are available for. If you are using an unsupported version of Ubuntu such as ",[51,2794,2795],{},"19.04"," or another Linux distribution such as Fedora, ",[51,2798,2758],{}," may not work.",[16,2801,2802,2803,2806],{},"setup-python 这个 Action ",[34,2804,2805],{},"只支持 Github Action 所采用的同款操作系统","，而我 VPS 的 Debian 不受支持，因此有这个误报，同时也给我的 Debian 判了死刑。",[20,2808,2810],{"id":2809},"症结所在对-self-hosted-runner-的误解","症结所在：对 Self-hosted Runner 的误解",[16,2812,2813,2814,2817,2818,2821],{},"我潜意识里认为，Self-hosted Runner 仅仅是将计算成本从 Github 服务器转移到了本地，而 ",[51,2815,2816],{},"actions/setup-python"," 这种官方标准动作，理应会像 Github-hosted Runner 中那样，优雅地为我下载、安装、并配置好我需要的一切。然而，",[34,2819,2820],{},"Self-hosted  Runner 的本质只是从 Github 接收任务，并在当前的操作系统环境中执行指令","，并不保证和 Github 官方提供的 Runner 的运行环境一致。",[16,2823,2824,2825,2828],{},"Self-hosted Runner 不是一个开箱即用的“服务”，而是",[34,2826,2827],{},"一个需要你亲自管理的“基础设施”","。你需要负责服务器的安装、配置、安全更新、依赖管理、磁盘清理等一系列运维工作。它更适合那些对 CI/CD 有更高阶需求的团队或个人：比如 CI/CD 消费大户、需要特定硬件（如 ARM、GPU）进行构建的团队、或者 CI 流程深度依赖内部网络资源的企业。对于像我这样只是愿意拿出更多的本地计算资源来获取更多 Action 运行时长的普通开发者而言，它带来的运维心智负担，似乎是有一点重了。",[382,2830,2831],{},"html pre.shiki code .s5ixo, html code.shiki .s5ixo{--shiki-default:#383A42;--shiki-dark:#ABB2BF}html pre.shiki code .sDhpE, html code.shiki .sDhpE{--shiki-default:#50A14F;--shiki-dark:#98C379}html pre.shiki code .sJa8x, html code.shiki .sJa8x{--shiki-default:#E45649;--shiki-dark:#E06C75}html .default .shiki span {color: var(--shiki-default);background: var(--shiki-default-bg);font-style: var(--shiki-default-font-style);font-weight: var(--shiki-default-font-weight);text-decoration: var(--shiki-default-text-decoration);}html .shiki span {color: var(--shiki-default);background: var(--shiki-default-bg);font-style: var(--shiki-default-font-style);font-weight: var(--shiki-default-font-weight);text-decoration: var(--shiki-default-text-decoration);}html .dark .shiki span {color: var(--shiki-dark);background: var(--shiki-dark-bg);font-style: var(--shiki-dark-font-style);font-weight: var(--shiki-dark-font-weight);text-decoration: var(--shiki-dark-text-decoration);}html.dark .shiki span {color: var(--shiki-dark);background: var(--shiki-dark-bg);font-style: var(--shiki-dark-font-style);font-weight: var(--shiki-dark-font-weight);text-decoration: var(--shiki-dark-text-decoration);}",{"title":73,"searchDepth":86,"depth":86,"links":2833},[2834,2835,2836,2837],{"id":2667,"depth":86,"text":2667},{"id":2718,"depth":86,"text":2719},{"id":2752,"depth":86,"text":2752},{"id":2809,"depth":86,"text":2810},{"title":2839,"date":2840,"path":2841,"tags":2842,"body":2847},"DNS 解析时长毁了我精心设计的图床网络架构","2025-08-11 00:06:40","/2025/08/11/dns-resolve-time-destroyed-my-optimization-for-pic-cdn",[2843,2844,10,11,2845,2846],"CDN","Image Hosting","Cloudflare","Dnspod",{"type":13,"value":2848,"toc":3241},[2849,2856,2861,2867,2877,2882,2971,2986,2991,2994,3066,3071,3074,3079,3102,3107,3118],[16,2850,2851,2852,2855],{},"去年夏天，我兴致勃勃地写了好几篇博文，详细讲述了我如何搭建博客图床。核心目标很明确：",[34,2853,2854],{},"分地区解析 DNS","，让国内外的访客都能嗖嗖地加载图片，体验拉满。想法嘛，绝对是走在技术前沿的，堪称完美！然而……现实它总是喜欢给你来点小惊喜，对吧？",[16,2857,2858],{},[1966,2859],{"alt":73,"src":2860},"https://static.031130.xyz/uploads/2025/08/11/26306b2a483ba.webp",[16,2862,2863,2866],{},[34,2864,2865],{},"955 毫秒！"," 看到这个 DNS  解析时长的时候，我差点把刚喝下去的霸王茶姬喷在屏幕上。这简直就是一个隐形刺客，在我精心设计的图床网络架构背后，悄咪咪地给了致命一击。想象一下，访客满怀期待地点开你的博客，结果光是为了搞清楚图片服务器在哪，就要等上差不多一秒钟？这体验优化了个寂寞啊！",[16,2868,2869,2870,2873,2874,1039],{},"为啥之前没发现？这得“感谢”",[34,2871,2872],{},"DNS 缓存","这位老好人。它勤勤恳恳地帮后来的访客记住了答案，让我的本地测试和复访测试都一片祥和。直到最近，有群友向我反馈了首次访问时图片的加载速度过慢，我才如梦初醒。再结合最近为了秋招准备的八股文中里面关于 DNS 解析那套繁琐的流程（递归查询、权威查询、根域名、顶级域名……查个地址堪比查户口本），我瞬间锁定了罪魁祸首：",[34,2875,2876],{},"首次访问时的 DNS 解析延迟",[16,2878,2879],{},[34,2880,2881],{},"来，复盘一下我那“曲折离奇”的 DNS 寻址之旅（访客视角）：",[28,2883,2884,2893,2906,2923,2935,2951,2966],{},[31,2885,2886],{},[34,2887,2888,2889,2892],{},"访客想访问 ",[51,2890,2891],{},"static.031130.xyz"," 的图片。",[31,2894,2895,2902,2903,2905],{},[34,2896,2897,2898,2901],{},"查 ",[51,2899,2900],{},"031130.xyz"," 的权威 DNS："," 问了一圈，发现权威服务器原来在 ",[34,2904,2845],{}," (国外)。",[31,2907,2908,2911,2912,2914,2915,2918,2919,2922],{},[34,2909,2910],{},"Cloudflare 权威服务器回复："," “哦，",[51,2913,2891],{}," 啊？它是个马甲 (",[51,2916,2917],{},"CNAME",")，真身是 ",[51,2920,2921],{},"cdn-cname.zhul.in","，你去找它吧！”",[31,2924,2925,2930,2931,2934],{},[34,2926,2897,2927,2901],{},[51,2928,2929],{},"zhul.in"," 这次权威服务器在 ",[34,2932,2933],{},"DNSPod"," (国内)。",[31,2936,2937,2940,2941,2943,2944,2946,2947,2950],{},[34,2938,2939],{},"DNSPod 权威服务器回复 (针对国内用户)："," “",[51,2942,2921],{}," 也是个马甲 (",[51,2945,2917],{},")，它实际是 ",[51,2948,2949],{},"small-storage-cdn.b0.aicdn.com","，接着找！”",[31,2952,2953,2958,2959,2961,2962,2965],{},[34,2954,2897,2955,2957],{},[51,2956,2949],{},"："," 最终，它可能还会再 ",[51,2960,2917],{}," 到类似 ",[51,2963,2964],{},"nm.aicdn.com"," 这样的 CDN 节点主机名。",[31,2967,2968],{},[34,2969,2970],{},"最终获得 IP 地址，开始连接 CDN 节点下载图片。",[16,2972,2973,2974,2977,2978,2981,2982,2985],{},"发现问题没？",[34,2975,2976],{},"关键的第一步和第二步，权威 DNS 查询指向了国外的 Cloudflare！"," 对于国内用户，虽然最终解析到的 CDN 节点 (",[51,2979,2980],{},"small-storage-cdn.b0.aicdn.com/nm.aicdn.com",") 是国内的、速度飞快，但光是",[34,2983,2984],{},"前两步跨越重洋的 DNS 查询","，就足够让首次访问的用户体验跌入谷底。那个 955ms 的解析时长，基本就是花在跟国外 DNS 服务器“跨国聊天”上了。",[16,2987,2988],{},[34,2989,2990],{},"优化方案：三管齐下，围剿 DNS 延迟",[16,2992,2993],{},"既然找到了病根，就得下猛药：",[28,2995,2996,3014,3026],{},[31,2997,2998,3005,3006,3009,3010,3013],{},[34,2999,3000,3001,3004],{},"DNS 预取 (",[51,3002,3003],{},"dns-prefetch","):"," 在博客的 HTML ",[51,3007,3008],{},"\u003Chead>"," 里，早早地加上 ",[51,3011,3012],{},"\u003Clink rel=\"dns-prefetch\" href=\"//static.031130.xyz\">","。这相当于浏览器在渲染页面时，就悄悄开始解析图床域名了，等真需要加载图片时，DNS 结果可能已经准备好了，神不知鬼不觉。当然也可以使用 preconnect 等等更激进的策略，但本文着重讲 DNS 解析，因此不做拓展。",[31,3015,3016,3019,3020,3022,3023,3025],{},[34,3017,3018],{},"延长 DNS 记录的 TTL (生存时间)："," 把 ",[51,3021,2891],{}," 这个 ",[51,3024,2917],{}," 记录的 TTL 值调大。以前都设置得较短，方便快速切换。现在为了缓存，适当延长（比如几小时甚至一天）。这样，一旦有用户解析过，本地 DNS 服务器就能记住更久，后续用户（包括同一用户再次访问）就能直接从缓存拿到结果，省掉跨国查询。",[31,3027,3028,3031,3032,3034,3035,3038,3039,3042,3043],{},[34,3029,3030],{},"釜底抽薪：迁移权威 DNS！"," 这是最核心的一步。直接把 ",[51,3033,2900],{}," 域名的",[34,3036,3037],{},"权威 DNS 服务器","，从 Cloudflare ",[34,3040,3041],{},"搬回国内 DNSPod","。这样一来：\n",[265,3044,3045,3051,3063],{},[31,3046,3047,3048,3050],{},"访客的递归 DNS 服务器查询 ",[51,3049,2900],{}," 的权威服务器时，直接找到的就是国内的 DNSPod，响应飞快。",[31,3052,3053,3054,3056,3057,3059,3060,3062],{},"DNSPod 直接告诉递归服务器 ",[51,3055,2891],{}," -> ",[51,3058,2949],{}," 完全在国内完成，丝般顺滑，不需要 ",[51,3061,2921],{}," 当分区域解析的工具人",[31,3064,3065],{},"整个 DNS 解析链路都在国内高速完成，首次访问的 955ms 噩梦彻底拜拜。",[16,3067,3068],{},[34,3069,3070],{},"效果如何？",[16,3072,3073],{},"受限于 DNS 缓存带来的测试困难，最终的效果确实很难在短时间内测试出来。但迁移权威 DNS 到 DNSPod + 调整 TTL +  加上预取之后，再测试首次访问的 DNS 解析时间总算是降到了可接受的程度，这才是 CDN  优化该有的样子！",[16,3075,3076],{},[34,3077,3078],{},"教训总结：",[265,3080,3081,3087,3096],{},[31,3082,3083,3086],{},[34,3084,3085],{},"别让 DNS 成为性能短板！"," 尤其是在涉及多地优化时，权威 DNS 的地理位置对首次访问延迟至关重要。能用国内的权威，就别用国外的。",[31,3088,3089,3092,3093,3095],{},[34,3090,3091],{},"缓存是好东西，但首次访问是软肋。"," 善用 ",[51,3094,3003],{}," 和合理设置 TTL 能有效缓解。",[31,3097,3098,3101],{},[34,3099,3100],{},"监控和用户反馈是金。"," 自己的测试环境往往有缓存“美化”，真实世界的首次访问体验要靠更细致的监控和用户的火眼金睛（感谢反馈的朋友！）。",[16,3103,3104],{},[34,3105,3106],{},"!!! 超级重要补充：警惕 CNAME 拉平 !!!",[16,3108,3109,3110,3117],{},"最后，必须给各位提个醒！如果你和我一样，需要依赖分地区解析来让访客访问到最近的 CDN 节点（比如让国内走国内CDN，国外走Cloudflare），那么千万要",[34,3111,3112,3113,3116],{},"避开 ",[51,3114,3115],{},"CNAME Flattening"," (CNAME 拉平) 这个“优化”方案","！",[265,3119,3120,3153,3165,3200],{},[31,3121,3122,3125,3126,3128,3129,3056,3132,3135,3136,3138,3139,3142,3143,3146,3147,3150,3151,1039],{},[34,3123,3124],{},"CNAME 拉平是什么？"," 简单说，就是权威 DNS 服务器（比如 Cloudflare）看到你设置了一个 ",[51,3127,2917],{}," 记录（比如 ",[51,3130,3131],{},"static.example.com",[51,3133,3134],{},"cdn.cname.target.com","），它主动帮你去找 ",[51,3137,3134],{}," 的最终 ",[51,3140,3141],{},"A","/",[51,3144,3145],{},"AAAA"," 记录 (IP地址)，然后把 ",[34,3148,3149],{},"最终的 IP 地址"," 直接返回给查询者，而不是返回 ",[51,3152,2917],{},[31,3154,3155,3158,3159,2957,3162],{},[34,3156,3157],{},"听起来很美好？它确实能减少 CNAME 链的长度！"," 但它有个",[34,3160,3161],{},"致命缺点",[34,3163,3164],{},"权威 DNS 服务器在拉平解析时，会丢掉分地区解析的上下文！",[31,3166,3167,3170,3171,3174,3175,3178,3179,3182,3183,3185,3186,3188,3189,3191,3192,3195,3196,3199],{},[34,3168,3169],{},"为什么失效？"," 分地区解析 (",[51,3172,3173],{},"DNS View"," 或 ",[51,3176,3177],{},"GeoDNS",") 的功能是",[34,3180,3181],{},"在权威 DNS 服务器层面实现的","。当权威服务器执行 ",[51,3184,2917],{}," 拉平时，它是在它自己所在的位置去查询 ",[51,3187,3134],{}," 的 IP。比如你的权威 DNS 在 Cloudflare (美国节点)，它拉平查询时，拿到的 ",[51,3190,3134],{}," 的 IP ",[34,3193,3194],{},"大概率是给美国用户用的最优 IP","。然后它把这个 IP ",[34,3197,3198],{},"返回给了所有地区的查询者","，包括中国用户！你精心配置的让中国用户解析到国内 CDN IP 的策略就完全失效了！",[31,3201,3202,3205,3206,3212,3213,3216,3217,3219,3220,1564,3223,3226,3227,3229,3230,3232,3233,3056,3235,3237,3238,3240],{},[34,3203,3204],{},"结论："," 如果你需要 ",[34,3207,3208,3209,3211],{},"分地区解析 (",[51,3210,3177],{},")"," 功能，",[34,3214,3215],{},"绝对不要","在你希望应用分地区解析的域名上启用 ",[51,3218,3115],{}," (或 ",[51,3221,3222],{},"ALIAS",[51,3224,3225],{},"ANAME"," 等实现类似拉平效果的功能)。老老实实用 ",[51,3228,2917],{}," 指向另一个支持 ",[51,3231,3177],{}," 的域名（就像我初始方案里 ",[51,3234,2891],{},[51,3236,2921],{},"，而 ",[51,3239,2929],{}," 在 DNSPod 上做分地区解析），才能保证你的分流策略正确执行。",{"title":73,"searchDepth":86,"depth":86,"links":3242},[],{"title":3244,"date":3245,"path":3246,"tags":3247,"body":3253},"Vue Markdown 渲染优化实战(下)：告别 DOM 操作，拥抱 AST 与函数式渲染","2025-07-13 00:01:35","/2025/07/13/vue-markdown-render-improvement-2",[3248,3249,3250,1224,3251,3252],"Vue.js","Markdown","AST","Web","unified",{"type":13,"value":3254,"toc":5157},[3255,3263,3278,3281,3284,3287,3297,3307,3311,3320,3337,3347,3350,3365,3369,3390,3393,3397,3407,3437,3441,3444,3465,3468,3633,3636,3878,3882,3889,3901,3904,4536,4540,4547,4884,4887,5005,5009,5012,5117,5121,5124,5148,5151,5154],[20,3256,3258,3259,3262],{"id":3257},"上回回顾当-morphdom-遇上-vue","上回回顾：当 ",[51,3260,3261],{},"morphdom"," 遇上 Vue",[16,3264,3265,3266,3270,3271,3274,3275,3277],{},"在",[368,3267,3269],{"href":3268},"/2025/07/12/vue-markdown-render-improvement-1/","上一篇文章","中，我们经历了一场 Markdown 渲染的性能优化之旅。从最原始的 ",[51,3272,3273],{},"v-html"," 全量刷新，到按块更新，最终我们请出了 ",[51,3276,3261],{}," 这个“终极武器”。它通过直接比对和操作真实 DOM，以最小的代价更新视图，完美解决了实时渲染中的性能瓶颈和交互状态丢失问题。",[16,3279,3280],{},"然而，一个根本性问题始终存在：在 Vue 的地盘里，绕过 Vue 的虚拟 DOM (Virtual DOM) 和 Diff 算法，直接用一个第三方库去“动刀”真实 DOM，总感觉有些“旁门左道”。这就像在一个精密的自动化工厂里，引入了一个老师傅拿着锤子和扳手进行手动修补。虽然活干得漂亮，但总觉得破坏了原有的工作流，不够“Vue”。",[16,3282,3283],{},"那么，有没有一种更优雅、更“原生”的方式，让我们既能享受精准更新的快感，又能完全融入 Vue 的生态体系呢？",[16,3285,3286],{},"带着这个问题，我询问了前端群里的伙伴们。",[557,3288,3289],{},[16,3290,3291,3292],{},"如果就要做一个渲染器，你这个思路不是最佳实践。每次更新时，你都生成全量的虚拟 HTML，然后再对 HTML 做减法来优化性能。然而，每次更新的增量部分是明确的，为什么不直接用这部分增量去做加法？增量部分通过 markdown-it 的库无法直接获取，但更好的做法是在这一步进行改造：先解析 Markdown 的结构，再利用 Vue 的动态渲染能力生成 DOM。这样，DOM 的复用就可以借助 Vue 自身的能力来实现。—— ",[368,3293,3296],{"href":3294,"rel":3295},"https://site.j10c.cc/",[372],"j10c",[557,3298,3299],{},[16,3300,3301,3302],{},"可以用 unified 结合 remark-parse 插件，将 markdown 字符串解析为 ast，然后根据 ast 使用 render func 进行渲染即可。—— bii & ",[368,3303,3306],{"href":3304,"rel":3305},"https://github.com/nekomeowww",[372],"nekomeowww",[20,3308,3310],{"id":3309},"新思路从字符串转换到结构化渲染","新思路：从“字符串转换”到“结构化渲染”",[16,3312,3313,3314,3316,3317,3319],{},"我们之前的方案，无论是 ",[51,3315,3273],{}," 还是 ",[51,3318,3261],{},"，其核心思路都是：",[16,3321,3322,3056,3325,3056,3328,3056,3331,3056,3334],{},[51,3323,3324],{},"Markdown 字符串",[51,3326,3327],{},"markdown-it",[51,3329,3330],{},"HTML 字符串",[51,3332,3333],{},"浏览器/morphdom",[51,3335,3336],{},"DOM",[16,3338,3339,3340,3342,3343,3346],{},"这条链路的问题在于，从 ",[51,3341,3330],{}," 这一步开始，我们就丢失了 Markdown 的",[34,3344,3345],{},"原始结构信息","。我们得到的是一堆非结构化的文本，Vue 无法理解其内在逻辑，只能将其囫囵吞下。",[16,3348,3349],{},"而新的思路则是将流程改造为：",[16,3351,3352,3056,3354,3056,3357,3056,3360,3056,3363],{},[51,3353,3324],{},[51,3355,3356],{},"AST (抽象语法树)",[51,3358,3359],{},"Vue VNodes (虚拟节点)",[51,3361,3362],{},"Vue",[51,3364,3336],{},[320,3366,3368],{"id":3367},"什么是-ast","什么是 AST？",[16,3370,3371,3374,3375,3378,3379,3382,3383,3386,3387,1039],{},[34,3372,3373],{},"AST (Abstract Syntax Tree)"," ，即抽象语法树，是源代码或标记语言的结构化表示。它将一长串的文本，解析成一个层级分明的树状对象。对于 Markdown 来说，一个一级标题会变成一个 ",[51,3376,3377],{},"type: 'heading', depth: 1"," 的节点，一个段落会变成一个 ",[51,3380,3381],{},"type: 'paragraph'"," 的节点，而段落里的文字，则是 ",[51,3384,3385],{},"paragraph"," 节点的 ",[51,3388,3389],{},"children",[16,3391,3392],{},"一旦我们将 Markdown 转换成 AST，就相当于拥有了整个文档的“结构图纸”。我们不再是面对一堆模糊的 HTML 字符串，而是面对一个清晰、可编程的 JavaScript 对象。",[320,3394,3396],{"id":3395},"我们的新工具unified-与-remark","我们的新工具：unified 与 remark",[16,3398,3399,3400,3403,3404,3406],{},"为了实现 ",[51,3401,3402],{},"Markdown -> AST"," 的转换，我们引入 ",[51,3405,3252],{}," 生态。",[265,3408,3409,3418],{},[31,3410,3411,3417],{},[34,3412,3413],{},[368,3414,3252],{"href":3415,"rel":3416},"https://github.com/unifiedjs/unified",[372],": 一个强大的内容处理引擎。你可以把它想象成一条流水线，原始文本是原料，通过添加不同的“插件”来对它进行解析、转换和序列化。",[31,3419,3420,3427,3428,3430,3431,3436],{},[34,3421,3422],{},[368,3423,3426],{"href":3424,"rel":3425},"https://github.com/remarkjs/remark",[372],"remark-parse",": 一个 ",[51,3429,3252],{}," 插件，专门负责将 Markdown 文本解析成 AST（具体来说是 ",[368,3432,3435],{"href":3433,"rel":3434},"https://github.com/syntax-tree/mdast",[372],"mdast"," 格式）。",[20,3438,3440],{"id":3439},"第一步将-markdown-解析为-ast","第一步：将 Markdown 解析为 AST",[16,3442,3443],{},"首先，我们需要安装相关依赖：",[68,3445,3449],{"className":3446,"code":3447,"language":3448,"meta":73,"style":73},"language-bash shiki shiki-themes one-light one-dark-pro","npm install unified remark-parse\n","bash",[51,3450,3451],{"__ignoreMap":73},[77,3452,3453,3456,3459,3462],{"class":79,"line":80},[77,3454,3455],{"class":1340},"npm",[77,3457,3458],{"class":1396}," install",[77,3460,3461],{"class":1396}," unified",[77,3463,3464],{"class":1396}," remark-parse\n",[16,3466,3467],{},"然后，我们可以轻松地将 Markdown 字符串转换为 AST：",[68,3469,3473],{"className":3470,"code":3471,"language":3472,"meta":73,"style":73},"language-javascript shiki shiki-themes one-light one-dark-pro","import { unified } from 'unified'\nimport remarkParse from 'remark-parse'\n\nconst markdownContent = '# Hello, AST!\\n\\nThis is a paragraph.'\n\n// 创建一个处理器实例\nconst processor = unified().use(remarkParse)\n\n// 解析 Markdown 内容\nconst ast = processor.parse(markdownContent)\n\nconsole.log(JSON.stringify(ast, null, 2))\n","javascript",[51,3474,3475,3492,3505,3509,3527,3531,3536,3560,3564,3569,3592,3596],{"__ignoreMap":73},[77,3476,3477,3480,3482,3484,3486,3489],{"class":79,"line":80},[77,3478,3479],{"class":1328},"import",[77,3481,1420],{"class":1344},[77,3483,3252],{"class":1360},[77,3485,1508],{"class":1344},[77,3487,3488],{"class":1328},"from",[77,3490,3491],{"class":1396}," 'unified'\n",[77,3493,3494,3496,3499,3502],{"class":79,"line":86},[77,3495,3479],{"class":1328},[77,3497,3498],{"class":1360}," remarkParse",[77,3500,3501],{"class":1328}," from",[77,3503,3504],{"class":1396}," 'remark-parse'\n",[77,3506,3507],{"class":79,"line":92},[77,3508,120],{"emptyLinePlaceholder":119},[77,3510,3511,3513,3516,3518,3521,3524],{"class":79,"line":98},[77,3512,1329],{"class":1328},[77,3514,3515],{"class":1332}," markdownContent",[77,3517,1337],{"class":1336},[77,3519,3520],{"class":1396}," '# Hello, AST!",[77,3522,3523],{"class":1336},"\\n\\n",[77,3525,3526],{"class":1396},"This is a paragraph.'\n",[77,3528,3529],{"class":79,"line":104},[77,3530,120],{"emptyLinePlaceholder":119},[77,3532,3533],{"class":79,"line":110},[77,3534,3535],{"class":1433},"// 创建一个处理器实例\n",[77,3537,3538,3540,3543,3545,3547,3550,3553,3555,3558],{"class":79,"line":116},[77,3539,1329],{"class":1328},[77,3541,3542],{"class":1332}," processor",[77,3544,1337],{"class":1336},[77,3546,3461],{"class":1340},[77,3548,3549],{"class":1344},"().",[77,3551,3552],{"class":1340},"use",[77,3554,1345],{"class":1344},[77,3556,3557],{"class":1427},"remarkParse",[77,3559,1372],{"class":1344},[77,3561,3562],{"class":79,"line":123},[77,3563,120],{"emptyLinePlaceholder":119},[77,3565,3566],{"class":79,"line":129},[77,3567,3568],{"class":1433},"// 解析 Markdown 内容\n",[77,3570,3571,3573,3576,3578,3580,3582,3585,3587,3590],{"class":79,"line":134},[77,3572,1329],{"class":1328},[77,3574,3575],{"class":1332}," ast",[77,3577,1337],{"class":1336},[77,3579,3542],{"class":1348},[77,3581,629],{"class":1344},[77,3583,3584],{"class":1340},"parse",[77,3586,1345],{"class":1344},[77,3588,3589],{"class":1427},"markdownContent",[77,3591,1372],{"class":1344},[77,3593,3594],{"class":79,"line":140},[77,3595,120],{"emptyLinePlaceholder":119},[77,3597,3598,3601,3603,3606,3608,3611,3613,3616,3618,3621,3623,3626,3628,3631],{"class":79,"line":146},[77,3599,3600],{"class":1348},"console",[77,3602,629],{"class":1344},[77,3604,3605],{"class":1340},"log",[77,3607,1345],{"class":1344},[77,3609,3610],{"class":1332},"JSON",[77,3612,629],{"class":1344},[77,3614,3615],{"class":1340},"stringify",[77,3617,1345],{"class":1344},[77,3619,3620],{"class":1427},"ast",[77,3622,1564],{"class":1344},[77,3624,3625],{"class":1928},"null",[77,3627,1564],{"class":1344},[77,3629,3630],{"class":1928},"2",[77,3632,1920],{"class":1344},[16,3634,3635],{},"运行以上代码，我们将得到一个如下所示的 JSON 对象，这就是我们梦寐以求的 AST：",[68,3637,3641],{"className":3638,"code":3639,"language":3640,"meta":73,"style":73},"language-json shiki shiki-themes one-light one-dark-pro","{\n  \"type\": \"root\",\n  \"children\": [\n    {\n      \"type\": \"heading\",\n      \"depth\": 1,\n      \"children\": [\n        {\n          \"type\": \"text\",\n          \"value\": \"Hello, AST!\",\n          \"position\": { ... }\n        }\n      ],\n      \"position\": { ... }\n    },\n    {\n      \"type\": \"paragraph\",\n      \"children\": [\n        {\n          \"type\": \"text\",\n          \"value\": \"This is a paragraph.\",\n          \"position\": { ... }\n        }\n      ],\n      \"position\": { ... }\n    }\n  ],\n  \"position\": { ... }\n}\n","json",[51,3642,3643,3648,3662,3670,3675,3687,3699,3706,3711,3723,3735,3750,3755,3760,3771,3776,3780,3791,3797,3801,3811,3822,3832,3836,3840,3850,3855,3860,3872],{"__ignoreMap":73},[77,3644,3645],{"class":79,"line":80},[77,3646,3647],{"class":1344},"{\n",[77,3649,3650,3653,3656,3659],{"class":79,"line":86},[77,3651,3652],{"class":1360},"  \"type\"",[77,3654,3655],{"class":1344},": ",[77,3657,3658],{"class":1396},"\"root\"",[77,3660,3661],{"class":1344},",\n",[77,3663,3664,3667],{"class":79,"line":92},[77,3665,3666],{"class":1360},"  \"children\"",[77,3668,3669],{"class":1344},": [\n",[77,3671,3672],{"class":79,"line":98},[77,3673,3674],{"class":1344},"    {\n",[77,3676,3677,3680,3682,3685],{"class":79,"line":104},[77,3678,3679],{"class":1360},"      \"type\"",[77,3681,3655],{"class":1344},[77,3683,3684],{"class":1396},"\"heading\"",[77,3686,3661],{"class":1344},[77,3688,3689,3692,3694,3697],{"class":79,"line":110},[77,3690,3691],{"class":1360},"      \"depth\"",[77,3693,3655],{"class":1344},[77,3695,3696],{"class":1928},"1",[77,3698,3661],{"class":1344},[77,3700,3701,3704],{"class":79,"line":116},[77,3702,3703],{"class":1360},"      \"children\"",[77,3705,3669],{"class":1344},[77,3707,3708],{"class":79,"line":123},[77,3709,3710],{"class":1344},"        {\n",[77,3712,3713,3716,3718,3721],{"class":79,"line":129},[77,3714,3715],{"class":1360},"          \"type\"",[77,3717,3655],{"class":1344},[77,3719,3720],{"class":1396},"\"text\"",[77,3722,3661],{"class":1344},[77,3724,3725,3728,3730,3733],{"class":79,"line":134},[77,3726,3727],{"class":1360},"          \"value\"",[77,3729,3655],{"class":1344},[77,3731,3732],{"class":1396},"\"Hello, AST!\"",[77,3734,3661],{"class":1344},[77,3736,3737,3740,3743,3747],{"class":79,"line":140},[77,3738,3739],{"class":1360},"          \"position\"",[77,3741,3742],{"class":1344},": { ",[77,3744,3746],{"class":3745},"sUNH4","...",[77,3748,3749],{"class":1344}," }\n",[77,3751,3752],{"class":79,"line":146},[77,3753,3754],{"class":1344},"        }\n",[77,3756,3757],{"class":79,"line":151},[77,3758,3759],{"class":1344},"      ],\n",[77,3761,3762,3765,3767,3769],{"class":79,"line":157},[77,3763,3764],{"class":1360},"      \"position\"",[77,3766,3742],{"class":1344},[77,3768,3746],{"class":3745},[77,3770,3749],{"class":1344},[77,3772,3773],{"class":79,"line":163},[77,3774,3775],{"class":1344},"    },\n",[77,3777,3778],{"class":79,"line":168},[77,3779,3674],{"class":1344},[77,3781,3782,3784,3786,3789],{"class":79,"line":174},[77,3783,3679],{"class":1360},[77,3785,3655],{"class":1344},[77,3787,3788],{"class":1396},"\"paragraph\"",[77,3790,3661],{"class":1344},[77,3792,3793,3795],{"class":79,"line":180},[77,3794,3703],{"class":1360},[77,3796,3669],{"class":1344},[77,3798,3799],{"class":79,"line":185},[77,3800,3710],{"class":1344},[77,3802,3803,3805,3807,3809],{"class":79,"line":191},[77,3804,3715],{"class":1360},[77,3806,3655],{"class":1344},[77,3808,3720],{"class":1396},[77,3810,3661],{"class":1344},[77,3812,3813,3815,3817,3820],{"class":79,"line":197},[77,3814,3727],{"class":1360},[77,3816,3655],{"class":1344},[77,3818,3819],{"class":1396},"\"This is a paragraph.\"",[77,3821,3661],{"class":1344},[77,3823,3824,3826,3828,3830],{"class":79,"line":202},[77,3825,3739],{"class":1360},[77,3827,3742],{"class":1344},[77,3829,3746],{"class":3745},[77,3831,3749],{"class":1344},[77,3833,3834],{"class":79,"line":208},[77,3835,3754],{"class":1344},[77,3837,3838],{"class":79,"line":213},[77,3839,3759],{"class":1344},[77,3841,3842,3844,3846,3848],{"class":79,"line":219},[77,3843,3764],{"class":1360},[77,3845,3742],{"class":1344},[77,3847,3746],{"class":3745},[77,3849,3749],{"class":1344},[77,3851,3852],{"class":79,"line":224},[77,3853,3854],{"class":1344},"    }\n",[77,3856,3857],{"class":79,"line":230},[77,3858,3859],{"class":1344},"  ],\n",[77,3861,3863,3866,3868,3870],{"class":79,"line":3862},28,[77,3864,3865],{"class":1360},"  \"position\"",[77,3867,3742],{"class":1344},[77,3869,3746],{"class":3745},[77,3871,3749],{"class":1344},[77,3873,3875],{"class":79,"line":3874},29,[77,3876,3877],{"class":1344},"}\n",[20,3879,3881],{"id":3880},"第二步从-ast-到-vue-vnodes","第二步：从 AST 到 Vue VNodes",[16,3883,3884,3885,3888],{},"拿到了 AST，下一步就是将这个“结构图纸”真正地“施工”成用户可见的界面。在 Vue 的世界里，描述 UI 的蓝图就是虚拟节点 (VNode)，而 ",[51,3886,3887],{},"h()"," 函数（即 hyperscript）就是创建 VNode 的画笔。",[16,3890,3891,3892,1564,3895,1564,3897,3900],{},"我们的任务是编写一个渲染函数，它能够递归地遍历 AST，并为每一种节点类型（",[51,3893,3894],{},"heading",[51,3896,3385],{},[51,3898,3899],{},"text"," 等）生成对应的 VNode。",[16,3902,3903],{},"下面是一个简单的渲染函数实现：",[68,3905,3907],{"className":3470,"code":3906,"language":3472,"meta":73,"style":73},"function renderAst(node) {\n  if (!node) return null\n  switch (node.type) {\n    case 'root':\n      return h('div', {}, node.children.map(renderAst))\n    case 'paragraph':\n      return h('p', {}, node.children.map(renderAst))\n    case 'text':\n      return node.value\n    case 'emphasis':\n      return h('em', {}, node.children.map(renderAst))\n    case 'strong':\n      return h('strong', {}, node.children.map(renderAst))\n    case 'inlineCode':\n      return h('code', {}, node.value)\n    case 'heading':\n      return h('h' + node.depth, {}, node.children.map(renderAst))\n    case 'code':\n      return h('pre', {}, [h('code', {}, node.value)])\n    case 'list':\n      return h(node.ordered ? 'ol' : 'ul', {}, node.children.map(renderAst))\n    case 'listItem':\n      return h('li', {}, node.children.map(renderAst))\n    case 'thematicBreak':\n      return h('hr')\n    case 'blockquote':\n      return h('blockquote', {}, node.children.map(renderAst))\n    case 'link':\n      return h('a', { href: node.url, target: '_blank' }, node.children.map(renderAst))\n    default:\n      // 其它未实现类型\n      return h('span', { }, `[${node.type}]`)\n  }\n}\n",[51,3908,3909,3925,3947,3963,3974,4007,4016,4045,4054,4066,4075,4104,4113,4142,4151,4172,4181,4220,4229,4262,4271,4316,4325,4354,4363,4376,4385,4414,4423,4478,4486,4492,4525,4531],{"__ignoreMap":73},[77,3910,3911,3914,3917,3919,3922],{"class":79,"line":80},[77,3912,3913],{"class":1328},"function",[77,3915,3916],{"class":1340}," renderAst",[77,3918,1345],{"class":1344},[77,3920,3921],{"class":1851},"node",[77,3923,3924],{"class":1344},") {\n",[77,3926,3927,3930,3933,3936,3938,3941,3944],{"class":79,"line":86},[77,3928,3929],{"class":1328},"  if",[77,3931,3932],{"class":1344}," (",[77,3934,3935],{"class":1336},"!",[77,3937,3921],{"class":1427},[77,3939,3940],{"class":1344},") ",[77,3942,3943],{"class":1328},"return",[77,3945,3946],{"class":1928}," null\n",[77,3948,3949,3952,3954,3956,3958,3961],{"class":79,"line":92},[77,3950,3951],{"class":1328},"  switch",[77,3953,3932],{"class":1344},[77,3955,3921],{"class":1348},[77,3957,629],{"class":1344},[77,3959,3960],{"class":1360},"type",[77,3962,3924],{"class":1344},[77,3964,3965,3968,3971],{"class":79,"line":98},[77,3966,3967],{"class":1328},"    case",[77,3969,3970],{"class":1396}," 'root'",[77,3972,3973],{"class":1344},":\n",[77,3975,3976,3979,3982,3984,3987,3990,3992,3994,3996,3998,4000,4002,4005],{"class":79,"line":104},[77,3977,3978],{"class":1328},"      return",[77,3980,3981],{"class":1340}," h",[77,3983,1345],{"class":1344},[77,3985,3986],{"class":1396},"'div'",[77,3988,3989],{"class":1344},", {}, ",[77,3991,3921],{"class":1348},[77,3993,629],{"class":1344},[77,3995,3389],{"class":1354},[77,3997,629],{"class":1344},[77,3999,1874],{"class":1340},[77,4001,1345],{"class":1344},[77,4003,4004],{"class":1427},"renderAst",[77,4006,1920],{"class":1344},[77,4008,4009,4011,4014],{"class":79,"line":110},[77,4010,3967],{"class":1328},[77,4012,4013],{"class":1396}," 'paragraph'",[77,4015,3973],{"class":1344},[77,4017,4018,4020,4022,4024,4027,4029,4031,4033,4035,4037,4039,4041,4043],{"class":79,"line":116},[77,4019,3978],{"class":1328},[77,4021,3981],{"class":1340},[77,4023,1345],{"class":1344},[77,4025,4026],{"class":1396},"'p'",[77,4028,3989],{"class":1344},[77,4030,3921],{"class":1348},[77,4032,629],{"class":1344},[77,4034,3389],{"class":1354},[77,4036,629],{"class":1344},[77,4038,1874],{"class":1340},[77,4040,1345],{"class":1344},[77,4042,4004],{"class":1427},[77,4044,1920],{"class":1344},[77,4046,4047,4049,4052],{"class":79,"line":123},[77,4048,3967],{"class":1328},[77,4050,4051],{"class":1396}," 'text'",[77,4053,3973],{"class":1344},[77,4055,4056,4058,4061,4063],{"class":79,"line":129},[77,4057,3978],{"class":1328},[77,4059,4060],{"class":1348}," node",[77,4062,629],{"class":1344},[77,4064,4065],{"class":1360},"value\n",[77,4067,4068,4070,4073],{"class":79,"line":134},[77,4069,3967],{"class":1328},[77,4071,4072],{"class":1396}," 'emphasis'",[77,4074,3973],{"class":1344},[77,4076,4077,4079,4081,4083,4086,4088,4090,4092,4094,4096,4098,4100,4102],{"class":79,"line":140},[77,4078,3978],{"class":1328},[77,4080,3981],{"class":1340},[77,4082,1345],{"class":1344},[77,4084,4085],{"class":1396},"'em'",[77,4087,3989],{"class":1344},[77,4089,3921],{"class":1348},[77,4091,629],{"class":1344},[77,4093,3389],{"class":1354},[77,4095,629],{"class":1344},[77,4097,1874],{"class":1340},[77,4099,1345],{"class":1344},[77,4101,4004],{"class":1427},[77,4103,1920],{"class":1344},[77,4105,4106,4108,4111],{"class":79,"line":146},[77,4107,3967],{"class":1328},[77,4109,4110],{"class":1396}," 'strong'",[77,4112,3973],{"class":1344},[77,4114,4115,4117,4119,4121,4124,4126,4128,4130,4132,4134,4136,4138,4140],{"class":79,"line":151},[77,4116,3978],{"class":1328},[77,4118,3981],{"class":1340},[77,4120,1345],{"class":1344},[77,4122,4123],{"class":1396},"'strong'",[77,4125,3989],{"class":1344},[77,4127,3921],{"class":1348},[77,4129,629],{"class":1344},[77,4131,3389],{"class":1354},[77,4133,629],{"class":1344},[77,4135,1874],{"class":1340},[77,4137,1345],{"class":1344},[77,4139,4004],{"class":1427},[77,4141,1920],{"class":1344},[77,4143,4144,4146,4149],{"class":79,"line":157},[77,4145,3967],{"class":1328},[77,4147,4148],{"class":1396}," 'inlineCode'",[77,4150,3973],{"class":1344},[77,4152,4153,4155,4157,4159,4162,4164,4166,4168,4170],{"class":79,"line":163},[77,4154,3978],{"class":1328},[77,4156,3981],{"class":1340},[77,4158,1345],{"class":1344},[77,4160,4161],{"class":1396},"'code'",[77,4163,3989],{"class":1344},[77,4165,3921],{"class":1348},[77,4167,629],{"class":1344},[77,4169,1841],{"class":1360},[77,4171,1372],{"class":1344},[77,4173,4174,4176,4179],{"class":79,"line":168},[77,4175,3967],{"class":1328},[77,4177,4178],{"class":1396}," 'heading'",[77,4180,3973],{"class":1344},[77,4182,4183,4185,4187,4189,4192,4195,4197,4199,4202,4204,4206,4208,4210,4212,4214,4216,4218],{"class":79,"line":174},[77,4184,3978],{"class":1328},[77,4186,3981],{"class":1340},[77,4188,1345],{"class":1344},[77,4190,4191],{"class":1396},"'h'",[77,4193,4194],{"class":1336}," +",[77,4196,4060],{"class":1348},[77,4198,629],{"class":1344},[77,4200,4201],{"class":1360},"depth",[77,4203,3989],{"class":1344},[77,4205,3921],{"class":1348},[77,4207,629],{"class":1344},[77,4209,3389],{"class":1354},[77,4211,629],{"class":1344},[77,4213,1874],{"class":1340},[77,4215,1345],{"class":1344},[77,4217,4004],{"class":1427},[77,4219,1920],{"class":1344},[77,4221,4222,4224,4227],{"class":79,"line":180},[77,4223,3967],{"class":1328},[77,4225,4226],{"class":1396}," 'code'",[77,4228,3973],{"class":1344},[77,4230,4231,4233,4235,4237,4240,4243,4246,4248,4250,4252,4254,4256,4259],{"class":79,"line":185},[77,4232,3978],{"class":1328},[77,4234,3981],{"class":1340},[77,4236,1345],{"class":1344},[77,4238,4239],{"class":1396},"'pre'",[77,4241,4242],{"class":1344},", {}, [",[77,4244,4245],{"class":1340},"h",[77,4247,1345],{"class":1344},[77,4249,4161],{"class":1396},[77,4251,3989],{"class":1344},[77,4253,3921],{"class":1348},[77,4255,629],{"class":1344},[77,4257,1841],{"class":4258},"sj4iG",[77,4260,4261],{"class":1344},")])\n",[77,4263,4264,4266,4269],{"class":79,"line":191},[77,4265,3967],{"class":1328},[77,4267,4268],{"class":1396}," 'list'",[77,4270,3973],{"class":1344},[77,4272,4273,4275,4277,4279,4281,4283,4286,4289,4292,4295,4298,4300,4302,4304,4306,4308,4310,4312,4314],{"class":79,"line":197},[77,4274,3978],{"class":1328},[77,4276,3981],{"class":1340},[77,4278,1345],{"class":1344},[77,4280,3921],{"class":1348},[77,4282,629],{"class":1344},[77,4284,4285],{"class":1360},"ordered",[77,4287,4288],{"class":1860}," ?",[77,4290,4291],{"class":1396}," 'ol'",[77,4293,4294],{"class":1860}," :",[77,4296,4297],{"class":1396}," 'ul'",[77,4299,3989],{"class":1344},[77,4301,3921],{"class":1348},[77,4303,629],{"class":1344},[77,4305,3389],{"class":1354},[77,4307,629],{"class":1344},[77,4309,1874],{"class":1340},[77,4311,1345],{"class":1344},[77,4313,4004],{"class":1427},[77,4315,1920],{"class":1344},[77,4317,4318,4320,4323],{"class":79,"line":202},[77,4319,3967],{"class":1328},[77,4321,4322],{"class":1396}," 'listItem'",[77,4324,3973],{"class":1344},[77,4326,4327,4329,4331,4333,4336,4338,4340,4342,4344,4346,4348,4350,4352],{"class":79,"line":208},[77,4328,3978],{"class":1328},[77,4330,3981],{"class":1340},[77,4332,1345],{"class":1344},[77,4334,4335],{"class":1396},"'li'",[77,4337,3989],{"class":1344},[77,4339,3921],{"class":1348},[77,4341,629],{"class":1344},[77,4343,3389],{"class":1354},[77,4345,629],{"class":1344},[77,4347,1874],{"class":1340},[77,4349,1345],{"class":1344},[77,4351,4004],{"class":1427},[77,4353,1920],{"class":1344},[77,4355,4356,4358,4361],{"class":79,"line":213},[77,4357,3967],{"class":1328},[77,4359,4360],{"class":1396}," 'thematicBreak'",[77,4362,3973],{"class":1344},[77,4364,4365,4367,4369,4371,4374],{"class":79,"line":219},[77,4366,3978],{"class":1328},[77,4368,3981],{"class":1340},[77,4370,1345],{"class":1344},[77,4372,4373],{"class":1396},"'hr'",[77,4375,1372],{"class":1344},[77,4377,4378,4380,4383],{"class":79,"line":224},[77,4379,3967],{"class":1328},[77,4381,4382],{"class":1396}," 'blockquote'",[77,4384,3973],{"class":1344},[77,4386,4387,4389,4391,4393,4396,4398,4400,4402,4404,4406,4408,4410,4412],{"class":79,"line":230},[77,4388,3978],{"class":1328},[77,4390,3981],{"class":1340},[77,4392,1345],{"class":1344},[77,4394,4395],{"class":1396},"'blockquote'",[77,4397,3989],{"class":1344},[77,4399,3921],{"class":1348},[77,4401,629],{"class":1344},[77,4403,3389],{"class":1354},[77,4405,629],{"class":1344},[77,4407,1874],{"class":1340},[77,4409,1345],{"class":1344},[77,4411,4004],{"class":1427},[77,4413,1920],{"class":1344},[77,4415,4416,4418,4421],{"class":79,"line":3862},[77,4417,3967],{"class":1328},[77,4419,4420],{"class":1396}," 'link'",[77,4422,3973],{"class":1344},[77,4424,4425,4427,4429,4431,4434,4437,4440,4442,4444,4446,4449,4451,4454,4456,4459,4462,4464,4466,4468,4470,4472,4474,4476],{"class":79,"line":3874},[77,4426,3978],{"class":1328},[77,4428,3981],{"class":1340},[77,4430,1345],{"class":1344},[77,4432,4433],{"class":1396},"'a'",[77,4435,4436],{"class":1344},", { ",[77,4438,4439],{"class":1360},"href",[77,4441,1417],{"class":1416},[77,4443,4060],{"class":1348},[77,4445,629],{"class":1344},[77,4447,4448],{"class":1360},"url",[77,4450,1564],{"class":1344},[77,4452,4453],{"class":1360},"target",[77,4455,1417],{"class":1416},[77,4457,4458],{"class":1396}," '_blank'",[77,4460,4461],{"class":1344}," }, ",[77,4463,3921],{"class":1348},[77,4465,629],{"class":1344},[77,4467,3389],{"class":1354},[77,4469,629],{"class":1344},[77,4471,1874],{"class":1340},[77,4473,1345],{"class":1344},[77,4475,4004],{"class":1427},[77,4477,1920],{"class":1344},[77,4479,4481,4484],{"class":79,"line":4480},30,[77,4482,4483],{"class":1328},"    default",[77,4485,3973],{"class":1344},[77,4487,4489],{"class":79,"line":4488},31,[77,4490,4491],{"class":1433},"      // 其它未实现类型\n",[77,4493,4495,4497,4499,4501,4504,4507,4510,4512,4514,4516,4518,4520,4523],{"class":79,"line":4494},32,[77,4496,3978],{"class":1328},[77,4498,3981],{"class":1340},[77,4500,1345],{"class":1344},[77,4502,4503],{"class":1396},"'span'",[77,4505,4506],{"class":1344},", { }, ",[77,4508,4509],{"class":1396},"`[",[77,4511,1525],{"class":1524},[77,4513,3921],{"class":1348},[77,4515,629],{"class":1703},[77,4517,3960],{"class":1360},[77,4519,1530],{"class":1524},[77,4521,4522],{"class":1396},"]`",[77,4524,1372],{"class":1344},[77,4526,4528],{"class":79,"line":4527},33,[77,4529,4530],{"class":1344},"  }\n",[77,4532,4534],{"class":79,"line":4533},34,[77,4535,3877],{"class":1344},[20,4537,4539],{"id":4538},"第三步封装-vue-组件","第三步：封装 Vue 组件",[16,4541,4542,4543,4546],{},"整合上述逻辑，我们可以构建一个 Vue 组件。鉴于直接生成 VNode 的特性，采用函数式组件或显式 ",[51,4544,4545],{},"render"," 函数最为适宜。",[68,4548,4552],{"className":4549,"code":4550,"language":4551,"meta":73,"style":73},"language-vue shiki shiki-themes one-light one-dark-pro","\u003Ctemplate>\n  \u003Ccomponent :is=\"VNodeTree\" />\n\u003C/template>\n\n\u003Cscript setup>\nimport { computed, h, shallowRef, watchEffect } from 'vue'\nimport { unified } from 'unified'\nimport remarkParse from 'remark-parse'\n\nconst props = defineProps({\n  mdText: {\n    type: String,\n    default: ''\n  }\n})\n\nconst ast = shallowRef(null)\nconst parser = unified().use(remarkParse)\n\nwatchEffect(() => {\n  ast.value = parser.parse(props.mdText)\n})\n\n// AST 渲染函数 (同上文 renderAst 函数)\nfunction renderAst(node) { ... }\n\nconst VNodeTree = computed(() => renderAst(ast.value))\n\n\u003C/script>\n","vue",[51,4553,4554,4564,4590,4599,4603,4615,4645,4659,4669,4673,4688,4697,4709,4718,4722,4726,4730,4747,4768,4772,4782,4811,4815,4819,4824,4841,4845,4872,4876],{"__ignoreMap":73},[77,4555,4556,4558,4561],{"class":79,"line":80},[77,4557,1798],{"class":1344},[77,4559,4560],{"class":1360},"template",[77,4562,4563],{"class":1344},">\n",[77,4565,4566,4569,4572,4574,4577,4579,4582,4585,4587],{"class":79,"line":86},[77,4567,4568],{"class":1344},"  \u003C",[77,4570,4571],{"class":1360},"component",[77,4573,4294],{"class":1344},[77,4575,4576],{"class":1928},"is",[77,4578,1511],{"class":1344},[77,4580,4581],{"class":1344},"\"",[77,4583,4584],{"class":1427},"VNodeTree",[77,4586,4581],{"class":1344},[77,4588,4589],{"class":1344}," />\n",[77,4591,4592,4595,4597],{"class":79,"line":92},[77,4593,4594],{"class":1344},"\u003C/",[77,4596,4560],{"class":1360},[77,4598,4563],{"class":1344},[77,4600,4601],{"class":79,"line":98},[77,4602,120],{"emptyLinePlaceholder":119},[77,4604,4605,4607,4610,4613],{"class":79,"line":104},[77,4606,1798],{"class":1344},[77,4608,4609],{"class":1360},"script",[77,4611,4612],{"class":1928}," setup",[77,4614,4563],{"class":1344},[77,4616,4617,4619,4621,4624,4626,4628,4630,4633,4635,4638,4640,4642],{"class":79,"line":110},[77,4618,3479],{"class":1328},[77,4620,1420],{"class":1344},[77,4622,4623],{"class":1360},"computed",[77,4625,1564],{"class":1344},[77,4627,4245],{"class":1360},[77,4629,1564],{"class":1344},[77,4631,4632],{"class":1360},"shallowRef",[77,4634,1564],{"class":1344},[77,4636,4637],{"class":1360},"watchEffect",[77,4639,1508],{"class":1344},[77,4641,3488],{"class":1328},[77,4643,4644],{"class":1396}," 'vue'\n",[77,4646,4647,4649,4651,4653,4655,4657],{"class":79,"line":116},[77,4648,3479],{"class":1328},[77,4650,1420],{"class":1344},[77,4652,3252],{"class":1360},[77,4654,1508],{"class":1344},[77,4656,3488],{"class":1328},[77,4658,3491],{"class":1396},[77,4660,4661,4663,4665,4667],{"class":79,"line":123},[77,4662,3479],{"class":1328},[77,4664,3498],{"class":1360},[77,4666,3501],{"class":1328},[77,4668,3504],{"class":1396},[77,4670,4671],{"class":79,"line":129},[77,4672,120],{"emptyLinePlaceholder":119},[77,4674,4675,4677,4680,4682,4685],{"class":79,"line":134},[77,4676,1329],{"class":1328},[77,4678,4679],{"class":1332}," props",[77,4681,1337],{"class":1336},[77,4683,4684],{"class":1340}," defineProps",[77,4686,4687],{"class":1344},"({\n",[77,4689,4690,4693,4695],{"class":79,"line":140},[77,4691,4692],{"class":1360},"  mdText",[77,4694,1417],{"class":1416},[77,4696,1829],{"class":1344},[77,4698,4699,4702,4704,4707],{"class":79,"line":146},[77,4700,4701],{"class":1360},"    type",[77,4703,1417],{"class":1416},[77,4705,4706],{"class":1427}," String",[77,4708,3661],{"class":1344},[77,4710,4711,4713,4715],{"class":79,"line":151},[77,4712,4483],{"class":1360},[77,4714,1417],{"class":1416},[77,4716,4717],{"class":1396}," ''\n",[77,4719,4720],{"class":79,"line":157},[77,4721,4530],{"class":1344},[77,4723,4724],{"class":79,"line":163},[77,4725,1938],{"class":1344},[77,4727,4728],{"class":79,"line":168},[77,4729,120],{"emptyLinePlaceholder":119},[77,4731,4732,4734,4736,4738,4741,4743,4745],{"class":79,"line":174},[77,4733,1329],{"class":1328},[77,4735,3575],{"class":1332},[77,4737,1337],{"class":1336},[77,4739,4740],{"class":1340}," shallowRef",[77,4742,1345],{"class":1344},[77,4744,3625],{"class":1928},[77,4746,1372],{"class":1344},[77,4748,4749,4751,4754,4756,4758,4760,4762,4764,4766],{"class":79,"line":180},[77,4750,1329],{"class":1328},[77,4752,4753],{"class":1332}," parser",[77,4755,1337],{"class":1336},[77,4757,3461],{"class":1340},[77,4759,3549],{"class":1344},[77,4761,3552],{"class":1340},[77,4763,1345],{"class":1344},[77,4765,3557],{"class":1427},[77,4767,1372],{"class":1344},[77,4769,4770],{"class":79,"line":185},[77,4771,120],{"emptyLinePlaceholder":119},[77,4773,4774,4776,4778,4780],{"class":79,"line":191},[77,4775,4637],{"class":1340},[77,4777,1823],{"class":1344},[77,4779,1826],{"class":1328},[77,4781,1829],{"class":1344},[77,4783,4784,4787,4789,4791,4793,4795,4797,4799,4801,4804,4806,4809],{"class":79,"line":197},[77,4785,4786],{"class":1348},"  ast",[77,4788,629],{"class":1344},[77,4790,1841],{"class":1360},[77,4792,1337],{"class":1336},[77,4794,4753],{"class":1348},[77,4796,629],{"class":1344},[77,4798,3584],{"class":1340},[77,4800,1345],{"class":1344},[77,4802,4803],{"class":1348},"props",[77,4805,629],{"class":1344},[77,4807,4808],{"class":1360},"mdText",[77,4810,1372],{"class":1344},[77,4812,4813],{"class":79,"line":202},[77,4814,1938],{"class":1344},[77,4816,4817],{"class":79,"line":208},[77,4818,120],{"emptyLinePlaceholder":119},[77,4820,4821],{"class":79,"line":213},[77,4822,4823],{"class":1433},"// AST 渲染函数 (同上文 renderAst 函数)\n",[77,4825,4826,4828,4830,4832,4834,4837,4839],{"class":79,"line":219},[77,4827,3913],{"class":1328},[77,4829,3916],{"class":1340},[77,4831,1345],{"class":1344},[77,4833,3921],{"class":1851},[77,4835,4836],{"class":1344},") { ",[77,4838,3746],{"class":1416},[77,4840,3749],{"class":1344},[77,4842,4843],{"class":79,"line":224},[77,4844,120],{"emptyLinePlaceholder":119},[77,4846,4847,4849,4852,4854,4856,4858,4860,4862,4864,4866,4868,4870],{"class":79,"line":230},[77,4848,1329],{"class":1328},[77,4850,4851],{"class":1332}," VNodeTree",[77,4853,1337],{"class":1336},[77,4855,1820],{"class":1340},[77,4857,1823],{"class":1344},[77,4859,1826],{"class":1328},[77,4861,3916],{"class":1340},[77,4863,1345],{"class":1344},[77,4865,3620],{"class":1348},[77,4867,629],{"class":1344},[77,4869,1841],{"class":1360},[77,4871,1920],{"class":1344},[77,4873,4874],{"class":79,"line":3862},[77,4875,120],{"emptyLinePlaceholder":119},[77,4877,4878,4880,4882],{"class":79,"line":3874},[77,4879,4594],{"class":1344},[77,4881,4609],{"class":1360},[77,4883,4563],{"class":1344},[16,4885,4886],{},"现在就可以像使用普通组件一样使用它了：",[68,4888,4890],{"className":4549,"code":4889,"language":4551,"meta":73,"style":73},"\u003Ctemplate>\n  \u003CMarkdownRenderer :mdText=\"markdownContent\" />\n\u003C/template>\n\n\u003Cscript setup>\nimport { ref } from 'vue'\nimport MarkdownRenderer from './MarkdownRenderer.vue'\n\nconst markdownContent = ref('# Hello Vue\\n\\nThis is rendered via AST!')\n\u003C/script>\n",[51,4891,4892,4900,4921,4929,4933,4943,4958,4970,4974,4997],{"__ignoreMap":73},[77,4893,4894,4896,4898],{"class":79,"line":80},[77,4895,1798],{"class":1344},[77,4897,4560],{"class":1360},[77,4899,4563],{"class":1344},[77,4901,4902,4904,4907,4909,4911,4913,4915,4917,4919],{"class":79,"line":86},[77,4903,4568],{"class":1344},[77,4905,4906],{"class":1360},"MarkdownRenderer",[77,4908,4294],{"class":1344},[77,4910,4808],{"class":1928},[77,4912,1511],{"class":1344},[77,4914,4581],{"class":1344},[77,4916,3589],{"class":1427},[77,4918,4581],{"class":1344},[77,4920,4589],{"class":1344},[77,4922,4923,4925,4927],{"class":79,"line":92},[77,4924,4594],{"class":1344},[77,4926,4560],{"class":1360},[77,4928,4563],{"class":1344},[77,4930,4931],{"class":79,"line":98},[77,4932,120],{"emptyLinePlaceholder":119},[77,4934,4935,4937,4939,4941],{"class":79,"line":104},[77,4936,1798],{"class":1344},[77,4938,4609],{"class":1360},[77,4940,4612],{"class":1928},[77,4942,4563],{"class":1344},[77,4944,4945,4947,4949,4952,4954,4956],{"class":79,"line":110},[77,4946,3479],{"class":1328},[77,4948,1420],{"class":1344},[77,4950,4951],{"class":1360},"ref",[77,4953,1508],{"class":1344},[77,4955,3488],{"class":1328},[77,4957,4644],{"class":1396},[77,4959,4960,4962,4965,4967],{"class":79,"line":116},[77,4961,3479],{"class":1328},[77,4963,4964],{"class":1360}," MarkdownRenderer",[77,4966,3501],{"class":1328},[77,4968,4969],{"class":1396}," './MarkdownRenderer.vue'\n",[77,4971,4972],{"class":79,"line":123},[77,4973,120],{"emptyLinePlaceholder":119},[77,4975,4976,4978,4980,4982,4985,4987,4990,4992,4995],{"class":79,"line":129},[77,4977,1329],{"class":1328},[77,4979,3515],{"class":1332},[77,4981,1337],{"class":1336},[77,4983,4984],{"class":1340}," ref",[77,4986,1345],{"class":1344},[77,4988,4989],{"class":1396},"'# Hello Vue",[77,4991,3523],{"class":1336},[77,4993,4994],{"class":1396},"This is rendered via AST!'",[77,4996,1372],{"class":1344},[77,4998,4999,5001,5003],{"class":79,"line":134},[77,5000,4594],{"class":1344},[77,5002,4609],{"class":1360},[77,5004,4563],{"class":1344},[20,5006,5008],{"id":5007},"ast-方案的巨大优势","AST 方案的巨大优势",[16,5010,5011],{},"切换到 AST 赛道后，我们获得了前所未有的超能力：",[28,5013,5014,5026,5098,5111],{},[31,5015,5016,5019,5020,5022,5023,5025],{},[34,5017,5018],{},"原生集成，性能卓越","：我们不再需要 ",[51,5021,3273],{}," 的暴力刷新，也不再需要 ",[51,5024,3261],{}," 这样的“外援”。所有更新都交由 Vue 自己的 Diff 算法处理，这不仅性能极高，而且完全符合 Vue 的设计哲学，是真正的“自己人”。",[31,5027,5028,5031,5032],{},[34,5029,5030],{},"高度灵活性与可扩展性","：AST 作为可编程的 JavaScript 对象，为定制化处理提供了坚实基础：\n",[265,5033,5034,5055,5077],{},[31,5035,5036,5039,5040,5043,5044,5047,5048,5050,5051,5054],{},[34,5037,5038],{},"元素替换","：可将原生元素（如 ",[51,5041,5042],{},"\u003Ch2>","）无缝替换为自定义 Vue 组件（如 ",[51,5045,5046],{},"\u003CFancyHeading>","），仅在 ",[51,5049,4004],{}," 函数中调整对应 ",[51,5052,5053],{},"case"," 逻辑即可。",[31,5056,5057,5060,5061,5064,5065,5068,5069,5072,5073,5076],{},[34,5058,5059],{},"逻辑注入","：可便捷地为外部链接 ",[51,5062,5063],{},"\u003Ca>"," 添加 ",[51,5066,5067],{},"target=\"_blank\""," 与 ",[51,5070,5071],{},"rel=\"noopener noreferrer\""," 属性，或为图片 ",[51,5074,5075],{},"\u003Cimg>"," 包裹懒加载组件，此类操作在 AST 层面易于实现。",[31,5078,5079,5082,5083,5085,5086,5089,5090,5093,5094,5097],{},[34,5080,5081],{},"生态集成","：充分利用 ",[51,5084,3252],{}," 丰富的插件生态（如 ",[51,5087,5088],{},"remark-gfm"," 支持 GFM 语法，",[51,5091,5092],{},"remark-prism"," 实现代码高亮），仅需在处理器链中引入相应插件（",[51,5095,5096],{},".use(pluginName)","）。",[31,5099,5100,5103,5104,5107,5108,5110],{},[34,5101,5102],{},"关注点分离","：解析逻辑（",[51,5105,5106],{},"remark","）、渲染逻辑（",[51,5109,4004],{},"）和业务逻辑（Vue 组件）被清晰地分离开来，代码结构更清晰，维护性更强。",[31,5112,5113,5116],{},[34,5114,5115],{},"类型安全与可预测性","：相较于操作字符串或原始 HTML，基于结构化 AST 的渲染逻辑更易于进行类型校验与逻辑推理。",[20,5118,5120],{"id":5119},"结论从功能实现到架构优化的演进","结论：从功能实现到架构优化的演进",[16,5122,5123],{},"回顾优化历程：",[265,5125,5126,5131,5137,5142],{},[31,5127,5128,5130],{},[34,5129,3273],{},"：实现简单，但存在性能与安全性隐患。",[31,5132,5133,5136],{},[34,5134,5135],{},"分块更新","：缓解了部分性能问题，但方案存在局限性。",[31,5138,5139,5141],{},[34,5140,3261],{},"：有效提升了性能与用户体验，但与 Vue 核心机制存在隔阂。",[31,5143,5144,5147],{},[34,5145,5146],{},"AST + 函数式渲染","：回归 Vue 原生范式，提供了性能、灵活性、可维护性俱佳的终极解决方案。",[16,5149,5150],{},"通过采用 AST，我们不仅解决了具体的技术挑战，更重要的是实现了思维范式的转变——从面向结果（HTML 字符串）的编程，转向面向过程与结构（AST）的编程。这使我们能够深入内容本质，从而实现对渲染流程的精确控制。",[16,5152,5153],{},"本次从“全量刷新”到“结构化渲染”的优化实践，不仅是一次性能提升的技术过程，更是一次深入理解现代前端工程化思想的系统性探索。最终实现的 Markdown 渲染方案，在性能、功能性与架构优雅性上均达到了较高水准。",[382,5155,5156],{},"html pre.shiki code .sAdtL, html code.shiki .sAdtL{--shiki-default:#4078F2;--shiki-dark:#61AFEF}html pre.shiki code .sDhpE, html code.shiki .sDhpE{--shiki-default:#50A14F;--shiki-dark:#98C379}html .default .shiki span {color: var(--shiki-default);background: var(--shiki-default-bg);font-style: var(--shiki-default-font-style);font-weight: var(--shiki-default-font-weight);text-decoration: var(--shiki-default-text-decoration);}html .shiki span {color: var(--shiki-default);background: var(--shiki-default-bg);font-style: var(--shiki-default-font-style);font-weight: var(--shiki-default-font-weight);text-decoration: var(--shiki-default-text-decoration);}html .dark .shiki span {color: var(--shiki-dark);background: var(--shiki-dark-bg);font-style: var(--shiki-dark-font-style);font-weight: var(--shiki-dark-font-weight);text-decoration: var(--shiki-dark-text-decoration);}html.dark .shiki span {color: var(--shiki-dark);background: var(--shiki-dark-bg);font-style: var(--shiki-dark-font-style);font-weight: var(--shiki-dark-font-weight);text-decoration: var(--shiki-dark-text-decoration);}html pre.shiki code .sLKXg, html code.shiki .sLKXg{--shiki-default:#A626A4;--shiki-dark:#C678DD}html pre.shiki code .s5ixo, html code.shiki .s5ixo{--shiki-default:#383A42;--shiki-dark:#ABB2BF}html pre.shiki code .sJa8x, html code.shiki .sJa8x{--shiki-default:#E45649;--shiki-dark:#E06C75}html pre.shiki code .sNmU0, html code.shiki .sNmU0{--shiki-default:#986801;--shiki-dark:#E5C07B}html pre.shiki code .s_Sar, html code.shiki .s_Sar{--shiki-default:#0184BC;--shiki-dark:#56B6C2}html pre.shiki code .sW2Sy, html code.shiki .sW2Sy{--shiki-default:#A0A1A7;--shiki-default-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic}html pre.shiki code .sz0mV, html code.shiki .sz0mV{--shiki-default:#383A42;--shiki-dark:#E06C75}html pre.shiki code .s7GmK, html code.shiki .s7GmK{--shiki-default:#383A42;--shiki-dark:#E5C07B}html pre.shiki code .sAGMh, html code.shiki .sAGMh{--shiki-default:#986801;--shiki-dark:#D19A66}html pre.shiki code .sUNH4, html code.shiki .sUNH4{--shiki-default:white;--shiki-dark:#FFFFFF}html pre.shiki code .s8iYz, html code.shiki .s8iYz{--shiki-default:#383A42;--shiki-default-font-style:inherit;--shiki-dark:#E06C75;--shiki-dark-font-style:italic}html pre.shiki code .s2QsP, html code.shiki .s2QsP{--shiki-default:#E45649;--shiki-dark:#E5C07B}html pre.shiki code .sj4iG, html code.shiki .sj4iG{--shiki-default:#C18401;--shiki-dark:#E06C75}html pre.shiki code .s7DPa, html code.shiki .s7DPa{--shiki-default:#0184BC;--shiki-dark:#C678DD}html pre.shiki code .st7oF, html code.shiki .st7oF{--shiki-default:#0184BC;--shiki-dark:#ABB2BF}html pre.shiki code .sAOjX, html code.shiki .sAOjX{--shiki-default:#CA1243;--shiki-dark:#C678DD}html pre.shiki code .sMj0N, html code.shiki .sMj0N{--shiki-default:#50A14F;--shiki-dark:#ABB2BF}",{"title":73,"searchDepth":86,"depth":86,"links":5158},[5159,5161,5165,5166,5167,5168,5169],{"id":3257,"depth":86,"text":5160},"上回回顾：当 morphdom 遇上 Vue",{"id":3309,"depth":86,"text":3310,"children":5162},[5163,5164],{"id":3367,"depth":92,"text":3368},{"id":3395,"depth":92,"text":3396},{"id":3439,"depth":86,"text":3440},{"id":3880,"depth":86,"text":3881},{"id":4538,"depth":86,"text":4539},{"id":5007,"depth":86,"text":5008},{"id":5119,"depth":86,"text":5120},{"title":5171,"date":5172,"path":5173,"tags":5174,"body":5175},"Vue Markdown 渲染优化实战(上)：从暴力刷新、分块更新到 Morphdom 的华丽变身","2025-07-12 20:48:56","/2025/07/12/vue-markdown-render-improvement-1",[3248,3249,1224,3251,403],{"type":13,"value":5176,"toc":6571},[5177,5180,5183,5210,5214,5217,5220,5230,5233,5440,5444,5451,5462,5474,5482,5485,6062,6066,6069,6073,6081,6087,6098,6108,6111,6114,6522,6526,6529,6535,6540,6547,6550,6556,6562,6568],[20,5178,5179],{"id":5179},"需求背景",[16,5181,5182],{},"在最近接手的 AI 需求中，需要实现一个类似 ChatGPT 的对话交互界面。其核心流程是：后端通过 SSE（Server-Sent  Events）协议，持续地将 AI 生成的 Markdown 格式文本片段推送到前端。前端负责动态接收并拼接这些 Markdown  片段，最终将拼接完成的 Markdown 文本实时渲染并显示在用户界面上。",[16,5184,5185,5186,5191,5192,5197,5198,5203,5204,5209],{},"Markdown 渲染并不是什么罕见的需求，尤其是在 LLM 相关落地产品满天飞的当下。不同于 React 生态拥有一个 14k+ star 的著名第三方库——",[368,5187,5190],{"href":5188,"rel":5189},"https://github.com/remarkjs/react-markdown",[372],"react-markdown","，Vue 这边似乎暂时还没有一个仍在活跃维护的、star 数量不低（起码得 2k+ 吧？）的 markdown 渲染库。",[368,5193,5196],{"href":5194,"rel":5195},"https://github.com/cloudacy/vue-markdown-render#readme",[372],"cloudacy/vue-markdown-render"," 最后一次发版在一年前，但截止本文写作时间只有 103 个 star；",[368,5199,5202],{"href":5200,"rel":5201},"https://github.com/miaolz123/vue-markdown",[372],"miaolz123/vue-markdown"," 有 2k star，但最后一次 commit 已经是 7 年前了；",[368,5205,5208],{"href":5206,"rel":5207},"https://github.com/zhaoxuhui1122/vue-markdown",[372],"zhaoxuhui1122/vue-markdown"," 更是 archived 状态。",[20,5211,5213],{"id":5212},"第一版方案简单粗暴的-v-html","第一版方案：简单粗暴的 v-html",[16,5215,5216],{},"简单调研了一圈，发现 Vue 生态里确实缺少一个能打的 Markdown 渲染库。既然没有现成的轮子，那咱就自己造一个！",[16,5218,5219],{},"根据大部分文章以及 LLM 的推荐，我们首先采用 markdown-it 这个第三方库将 markdown 转换为 html 字符串，再通过 v-html 传入。",[16,5221,5222,5225,5226,5229],{},[34,5223,5224],{},"PS:"," 我们这里假设 Markdown 内容是可信的（比如由我们自己的 AI 生成）。如果内容来自用户输入，一定要使用 ",[51,5227,5228],{},"DOMPurify"," 这类库来防止 XSS 攻击，避免给网站“开天窗”哦！",[16,5231,5232],{},"示例代码如下：",[68,5234,5236],{"className":4549,"code":5235,"language":4551,"meta":73,"style":73},"\u003Ctemplate>\n  \u003Cdiv v-html=\"renderedHtml\">\u003C/div>\n\u003C/template>\n\n\u003Cscript setup>\nimport { computed, onMounted, ref } from 'vue';\nimport MarkdownIt from 'markdown-it';\n\nconst markdownContent = ref('');\nconst md = new MarkdownIt();\n\nconst renderedHtml = computed(() => md.render(markdownContent.value))\n\nonMounted(() => {\n  // markdownContent.value = await fetch() ...\n})\n\u003C/script>\n",[51,5237,5238,5246,5272,5280,5284,5294,5321,5335,5339,5357,5374,5378,5409,5413,5423,5428,5432],{"__ignoreMap":73},[77,5239,5240,5242,5244],{"class":79,"line":80},[77,5241,1798],{"class":1344},[77,5243,4560],{"class":1360},[77,5245,4563],{"class":1344},[77,5247,5248,5250,5253,5256,5258,5260,5263,5265,5268,5270],{"class":79,"line":86},[77,5249,4568],{"class":1344},[77,5251,5252],{"class":1360},"div",[77,5254,5255],{"class":1928}," v-html",[77,5257,1511],{"class":1344},[77,5259,4581],{"class":1344},[77,5261,5262],{"class":1427},"renderedHtml",[77,5264,4581],{"class":1344},[77,5266,5267],{"class":1344},">\u003C/",[77,5269,5252],{"class":1360},[77,5271,4563],{"class":1344},[77,5273,5274,5276,5278],{"class":79,"line":92},[77,5275,4594],{"class":1344},[77,5277,4560],{"class":1360},[77,5279,4563],{"class":1344},[77,5281,5282],{"class":79,"line":98},[77,5283,120],{"emptyLinePlaceholder":119},[77,5285,5286,5288,5290,5292],{"class":79,"line":104},[77,5287,1798],{"class":1344},[77,5289,4609],{"class":1360},[77,5291,4612],{"class":1928},[77,5293,4563],{"class":1344},[77,5295,5296,5298,5300,5302,5304,5307,5309,5311,5313,5315,5318],{"class":79,"line":110},[77,5297,3479],{"class":1328},[77,5299,1420],{"class":1344},[77,5301,4623],{"class":1360},[77,5303,1564],{"class":1344},[77,5305,5306],{"class":1360},"onMounted",[77,5308,1564],{"class":1344},[77,5310,4951],{"class":1360},[77,5312,1508],{"class":1344},[77,5314,3488],{"class":1328},[77,5316,5317],{"class":1396}," 'vue'",[77,5319,5320],{"class":1344},";\n",[77,5322,5323,5325,5328,5330,5333],{"class":79,"line":116},[77,5324,3479],{"class":1328},[77,5326,5327],{"class":1360}," MarkdownIt",[77,5329,3501],{"class":1328},[77,5331,5332],{"class":1396}," 'markdown-it'",[77,5334,5320],{"class":1344},[77,5336,5337],{"class":79,"line":123},[77,5338,120],{"emptyLinePlaceholder":119},[77,5340,5341,5343,5345,5347,5349,5351,5354],{"class":79,"line":129},[77,5342,1329],{"class":1328},[77,5344,3515],{"class":1332},[77,5346,1337],{"class":1336},[77,5348,4984],{"class":1340},[77,5350,1345],{"class":1344},[77,5352,5353],{"class":1396},"''",[77,5355,5356],{"class":1344},");\n",[77,5358,5359,5361,5364,5366,5369,5371],{"class":79,"line":134},[77,5360,1329],{"class":1328},[77,5362,5363],{"class":1332}," md",[77,5365,1337],{"class":1336},[77,5367,5368],{"class":1328}," new",[77,5370,5327],{"class":1340},[77,5372,5373],{"class":1344},"();\n",[77,5375,5376],{"class":79,"line":140},[77,5377,120],{"emptyLinePlaceholder":119},[77,5379,5380,5382,5385,5387,5389,5391,5393,5395,5397,5399,5401,5403,5405,5407],{"class":79,"line":146},[77,5381,1329],{"class":1328},[77,5383,5384],{"class":1332}," renderedHtml",[77,5386,1337],{"class":1336},[77,5388,1820],{"class":1340},[77,5390,1823],{"class":1344},[77,5392,1826],{"class":1328},[77,5394,5363],{"class":1348},[77,5396,629],{"class":1344},[77,5398,4545],{"class":1340},[77,5400,1345],{"class":1344},[77,5402,3589],{"class":1348},[77,5404,629],{"class":1344},[77,5406,1841],{"class":1360},[77,5408,1920],{"class":1344},[77,5410,5411],{"class":79,"line":151},[77,5412,120],{"emptyLinePlaceholder":119},[77,5414,5415,5417,5419,5421],{"class":79,"line":157},[77,5416,5306],{"class":1340},[77,5418,1823],{"class":1344},[77,5420,1826],{"class":1328},[77,5422,1829],{"class":1344},[77,5424,5425],{"class":79,"line":163},[77,5426,5427],{"class":1433},"  // markdownContent.value = await fetch() ...\n",[77,5429,5430],{"class":79,"line":168},[77,5431,1938],{"class":1344},[77,5433,5434,5436,5438],{"class":79,"line":174},[77,5435,4594],{"class":1344},[77,5437,4609],{"class":1360},[77,5439,4563],{"class":1344},[20,5441,5443],{"id":5442},"进化版给-markdown-分块更新","进化版：给 Markdown 分块更新",[16,5445,5446,5447,5450],{},"上述方案虽然能实现基础渲染，但在实时更新场景下存在明显缺陷：",[34,5448,5449],{},"每次接收到新的 Markdown 片段，整个文档都会触发全量重渲染","。即使只有最后一行是新增内容，整个文档的 DOM 也会被完全替换。这导致两个核心问题：",[28,5452,5453,5459],{},[31,5454,5455,5456,5458],{},"**性能顶不住：**Markdown 内容增长时，",[51,5457,3327],{}," 解析和 DOM 重建的开销呈线性上升。",[31,5460,5461],{},"**交互状态丢失：**全量刷新会把用户当前的操作状态冲掉。最明显的就是，如果你选中了某段文字，一刷新，选中状态就没了！",[16,5463,5464,5465,5470,5471,5473],{},"为了解决这两个问题，",[368,5466,5469],{"href":5467,"rel":5468},"https://juejin.cn/post/7480900772386734143",[372],"我们在网上找到了分块渲染的方案"," —— 把 Markdown 按两个连续的换行符 (",[51,5472,3523],{},") 切成一块一块的。这样每次更新，只重新渲染最后一块新的，前面的老块直接复用缓存。好处很明显：",[265,5475,5476,5479],{},[31,5477,5478],{},"用户如果选中了前面块里的文字，下次更新时选中状态不会丢（因为前面的块没动）。",[31,5480,5481],{},"需要重新渲染的 DOM 变少了，性能自然就上来了。",[16,5483,5484],{},"代码调整后像这样：",[68,5486,5488],{"className":4549,"code":5487,"language":4551,"meta":73,"style":73},"\u003Ctemplate>\n  \u003Cdiv>\n    \u003Cdiv\n      v-for=\"(block, idx) in renderedBlocks\"\n      :key=\"idx\"\n      v-html=\"block\"\n      class=\"markdown-block\"\n    >\u003C/div>\n  \u003C/div>\n\u003C/template>\n\n\u003Cscript setup>\nimport { ref, computed, watch } from 'vue'\nimport MarkdownIt from 'markdown-it'\n\nconst markdownContent = ref('')\nconst md = new MarkdownIt()\n\nconst renderedBlocks = ref([])\nconst blockCache = ref([])\n\nwatch(\n  markdownContent,\n  (newContent, oldContent) => {\n    const blocks = newContent.split(/\\n{2,}/)\n    // 只重新渲染最后一个块，其余用缓存\n    // 处理块减少、块增多的场景\n    blockCache.value.length = blocks.length\n    for (let i = 0; i \u003C blocks.length; i++) {\n      // 只渲染最后一个，或新块\n      if (i === blocks.length - 1 || !blockCache.value[i]) {\n        blockCache.value[i] = md.render(blocks[i] || '')\n      }\n      // 其余块直接复用\n    }\n    renderedBlocks.value = blockCache.value.slice()\n  },\n  { immediate: true }\n)\n\nonMounted(() => {\n  // markdownContent.value = await fetch() ...\n})\n\u003C/script>\n",[51,5489,5490,5498,5506,5514,5544,5560,5573,5583,5592,5601,5609,5613,5623,5646,5657,5661,5677,5691,5695,5708,5721,5725,5732,5739,5758,5793,5798,5803,5826,5868,5873,5917,5960,5965,5970,5975,6000,6006,6022,6027,6032,6043,6048,6053],{"__ignoreMap":73},[77,5491,5492,5494,5496],{"class":79,"line":80},[77,5493,1798],{"class":1344},[77,5495,4560],{"class":1360},[77,5497,4563],{"class":1344},[77,5499,5500,5502,5504],{"class":79,"line":86},[77,5501,4568],{"class":1344},[77,5503,5252],{"class":1360},[77,5505,4563],{"class":1344},[77,5507,5508,5511],{"class":79,"line":92},[77,5509,5510],{"class":1344},"    \u003C",[77,5512,5513],{"class":1360},"div\n",[77,5515,5516,5519,5521,5523,5525,5528,5530,5533,5535,5538,5541],{"class":79,"line":98},[77,5517,5518],{"class":1328},"      v-for",[77,5520,1511],{"class":1344},[77,5522,4581],{"class":1344},[77,5524,1345],{"class":1344},[77,5526,5527],{"class":1427},"block",[77,5529,1564],{"class":1344},[77,5531,5532],{"class":1427},"idx",[77,5534,3940],{"class":1344},[77,5536,5537],{"class":1328},"in",[77,5539,5540],{"class":1427}," renderedBlocks",[77,5542,5543],{"class":1344},"\"\n",[77,5545,5546,5549,5552,5554,5556,5558],{"class":79,"line":104},[77,5547,5548],{"class":1344},"      :",[77,5550,5551],{"class":1928},"key",[77,5553,1511],{"class":1344},[77,5555,4581],{"class":1344},[77,5557,5532],{"class":1427},[77,5559,5543],{"class":1344},[77,5561,5562,5565,5567,5569,5571],{"class":79,"line":110},[77,5563,5564],{"class":1928},"      v-html",[77,5566,1511],{"class":1344},[77,5568,4581],{"class":1344},[77,5570,5527],{"class":1427},[77,5572,5543],{"class":1344},[77,5574,5575,5578,5580],{"class":79,"line":116},[77,5576,5577],{"class":1928},"      class",[77,5579,1511],{"class":1344},[77,5581,5582],{"class":1396},"\"markdown-block\"\n",[77,5584,5585,5588,5590],{"class":79,"line":123},[77,5586,5587],{"class":1344},"    >\u003C/",[77,5589,5252],{"class":1360},[77,5591,4563],{"class":1344},[77,5593,5594,5597,5599],{"class":79,"line":129},[77,5595,5596],{"class":1344},"  \u003C/",[77,5598,5252],{"class":1360},[77,5600,4563],{"class":1344},[77,5602,5603,5605,5607],{"class":79,"line":134},[77,5604,4594],{"class":1344},[77,5606,4560],{"class":1360},[77,5608,4563],{"class":1344},[77,5610,5611],{"class":79,"line":140},[77,5612,120],{"emptyLinePlaceholder":119},[77,5614,5615,5617,5619,5621],{"class":79,"line":146},[77,5616,1798],{"class":1344},[77,5618,4609],{"class":1360},[77,5620,4612],{"class":1928},[77,5622,4563],{"class":1344},[77,5624,5625,5627,5629,5631,5633,5635,5637,5640,5642,5644],{"class":79,"line":151},[77,5626,3479],{"class":1328},[77,5628,1420],{"class":1344},[77,5630,4951],{"class":1360},[77,5632,1564],{"class":1344},[77,5634,4623],{"class":1360},[77,5636,1564],{"class":1344},[77,5638,5639],{"class":1360},"watch",[77,5641,1508],{"class":1344},[77,5643,3488],{"class":1328},[77,5645,4644],{"class":1396},[77,5647,5648,5650,5652,5654],{"class":79,"line":157},[77,5649,3479],{"class":1328},[77,5651,5327],{"class":1360},[77,5653,3501],{"class":1328},[77,5655,5656],{"class":1396}," 'markdown-it'\n",[77,5658,5659],{"class":79,"line":163},[77,5660,120],{"emptyLinePlaceholder":119},[77,5662,5663,5665,5667,5669,5671,5673,5675],{"class":79,"line":168},[77,5664,1329],{"class":1328},[77,5666,3515],{"class":1332},[77,5668,1337],{"class":1336},[77,5670,4984],{"class":1340},[77,5672,1345],{"class":1344},[77,5674,5353],{"class":1396},[77,5676,1372],{"class":1344},[77,5678,5679,5681,5683,5685,5687,5689],{"class":79,"line":174},[77,5680,1329],{"class":1328},[77,5682,5363],{"class":1332},[77,5684,1337],{"class":1336},[77,5686,5368],{"class":1328},[77,5688,5327],{"class":1340},[77,5690,1444],{"class":1344},[77,5692,5693],{"class":79,"line":180},[77,5694,120],{"emptyLinePlaceholder":119},[77,5696,5697,5699,5701,5703,5705],{"class":79,"line":185},[77,5698,1329],{"class":1328},[77,5700,5540],{"class":1332},[77,5702,1337],{"class":1336},[77,5704,4984],{"class":1340},[77,5706,5707],{"class":1344},"([])\n",[77,5709,5710,5712,5715,5717,5719],{"class":79,"line":191},[77,5711,1329],{"class":1328},[77,5713,5714],{"class":1332}," blockCache",[77,5716,1337],{"class":1336},[77,5718,4984],{"class":1340},[77,5720,5707],{"class":1344},[77,5722,5723],{"class":79,"line":197},[77,5724,120],{"emptyLinePlaceholder":119},[77,5726,5727,5729],{"class":79,"line":202},[77,5728,5639],{"class":1340},[77,5730,5731],{"class":1344},"(\n",[77,5733,5734,5737],{"class":79,"line":208},[77,5735,5736],{"class":1427},"  markdownContent",[77,5738,3661],{"class":1344},[77,5740,5741,5744,5747,5749,5752,5754,5756],{"class":79,"line":213},[77,5742,5743],{"class":1344},"  (",[77,5745,5746],{"class":1851},"newContent",[77,5748,1564],{"class":1344},[77,5750,5751],{"class":1851},"oldContent",[77,5753,3940],{"class":1344},[77,5755,1826],{"class":1328},[77,5757,1829],{"class":1344},[77,5759,5760,5763,5766,5768,5771,5773,5776,5778,5781,5785,5789,5791],{"class":79,"line":219},[77,5761,5762],{"class":1328},"    const",[77,5764,5765],{"class":1332}," blocks",[77,5767,1337],{"class":1336},[77,5769,5770],{"class":1348}," newContent",[77,5772,629],{"class":1344},[77,5774,5775],{"class":1340},"split",[77,5777,1345],{"class":1344},[77,5779,3142],{"class":5780},"sDaw7",[77,5782,5784],{"class":5783},"sRZ4U","\\n",[77,5786,5788],{"class":5787},"sYoRg","{2,}",[77,5790,3142],{"class":5780},[77,5792,1372],{"class":1344},[77,5794,5795],{"class":79,"line":224},[77,5796,5797],{"class":1433},"    // 只重新渲染最后一个块，其余用缓存\n",[77,5799,5800],{"class":79,"line":230},[77,5801,5802],{"class":1433},"    // 处理块减少、块增多的场景\n",[77,5804,5805,5808,5810,5812,5814,5817,5819,5821,5823],{"class":79,"line":3862},[77,5806,5807],{"class":1348},"    blockCache",[77,5809,629],{"class":1344},[77,5811,1841],{"class":1354},[77,5813,629],{"class":1344},[77,5815,5816],{"class":1360},"length",[77,5818,1337],{"class":1336},[77,5820,5765],{"class":1348},[77,5822,629],{"class":1344},[77,5824,5825],{"class":1360},"length\n",[77,5827,5828,5831,5833,5836,5839,5841,5844,5847,5850,5853,5855,5857,5859,5861,5863,5866],{"class":79,"line":3874},[77,5829,5830],{"class":1328},"    for",[77,5832,3932],{"class":1344},[77,5834,5835],{"class":1328},"let",[77,5837,5838],{"class":1427}," i",[77,5840,1337],{"class":1336},[77,5842,5843],{"class":1928}," 0",[77,5845,5846],{"class":1344},"; ",[77,5848,5849],{"class":1427},"i",[77,5851,5852],{"class":1336}," \u003C",[77,5854,5765],{"class":1348},[77,5856,629],{"class":1344},[77,5858,5816],{"class":1360},[77,5860,5846],{"class":1344},[77,5862,5849],{"class":1427},[77,5864,5865],{"class":1336},"++",[77,5867,3924],{"class":1344},[77,5869,5870],{"class":79,"line":4480},[77,5871,5872],{"class":1433},"      // 只渲染最后一个，或新块\n",[77,5874,5875,5878,5880,5882,5884,5886,5888,5890,5893,5896,5899,5902,5905,5907,5909,5912,5914],{"class":79,"line":4488},[77,5876,5877],{"class":1328},"      if",[77,5879,3932],{"class":1344},[77,5881,5849],{"class":1427},[77,5883,1877],{"class":1336},[77,5885,5765],{"class":1348},[77,5887,629],{"class":1344},[77,5889,5816],{"class":1360},[77,5891,5892],{"class":1336}," -",[77,5894,5895],{"class":1928}," 1",[77,5897,5898],{"class":1336}," ||",[77,5900,5901],{"class":1336}," !",[77,5903,5904],{"class":1348},"blockCache",[77,5906,629],{"class":1344},[77,5908,1841],{"class":1360},[77,5910,5911],{"class":1344},"[",[77,5913,5849],{"class":1427},[77,5915,5916],{"class":1344},"]) {\n",[77,5918,5919,5922,5924,5926,5928,5930,5933,5935,5937,5939,5941,5943,5946,5948,5950,5952,5955,5958],{"class":79,"line":4494},[77,5920,5921],{"class":1348},"        blockCache",[77,5923,629],{"class":1344},[77,5925,1841],{"class":1360},[77,5927,5911],{"class":1344},[77,5929,5849],{"class":1427},[77,5931,5932],{"class":1344},"] ",[77,5934,1511],{"class":1336},[77,5936,5363],{"class":1348},[77,5938,629],{"class":1344},[77,5940,4545],{"class":1340},[77,5942,1345],{"class":1344},[77,5944,5945],{"class":1427},"blocks",[77,5947,5911],{"class":1344},[77,5949,5849],{"class":1427},[77,5951,5932],{"class":1344},[77,5953,5954],{"class":1336},"||",[77,5956,5957],{"class":1396}," ''",[77,5959,1372],{"class":1344},[77,5961,5962],{"class":79,"line":4527},[77,5963,5964],{"class":1344},"      }\n",[77,5966,5967],{"class":79,"line":4533},[77,5968,5969],{"class":1433},"      // 其余块直接复用\n",[77,5971,5973],{"class":79,"line":5972},35,[77,5974,3854],{"class":1344},[77,5976,5978,5981,5983,5985,5987,5989,5991,5993,5995,5998],{"class":79,"line":5977},36,[77,5979,5980],{"class":1348},"    renderedBlocks",[77,5982,629],{"class":1344},[77,5984,1841],{"class":1360},[77,5986,1337],{"class":1336},[77,5988,5714],{"class":1348},[77,5990,629],{"class":1344},[77,5992,1841],{"class":1354},[77,5994,629],{"class":1344},[77,5996,5997],{"class":1340},"slice",[77,5999,1444],{"class":1344},[77,6001,6003],{"class":79,"line":6002},37,[77,6004,6005],{"class":1344},"  },\n",[77,6007,6009,6012,6015,6017,6020],{"class":79,"line":6008},38,[77,6010,6011],{"class":1344},"  { ",[77,6013,6014],{"class":1360},"immediate",[77,6016,1417],{"class":1416},[77,6018,6019],{"class":1928}," true",[77,6021,3749],{"class":1344},[77,6023,6025],{"class":79,"line":6024},39,[77,6026,1372],{"class":1344},[77,6028,6030],{"class":79,"line":6029},40,[77,6031,120],{"emptyLinePlaceholder":119},[77,6033,6035,6037,6039,6041],{"class":79,"line":6034},41,[77,6036,5306],{"class":1340},[77,6038,1823],{"class":1344},[77,6040,1826],{"class":1328},[77,6042,1829],{"class":1344},[77,6044,6046],{"class":79,"line":6045},42,[77,6047,5427],{"class":1433},[77,6049,6051],{"class":79,"line":6050},43,[77,6052,1938],{"class":1344},[77,6054,6056,6058,6060],{"class":79,"line":6055},44,[77,6057,4594],{"class":1344},[77,6059,4609],{"class":1360},[77,6061,4563],{"class":1344},[20,6063,6065],{"id":6064},"终极武器用-morphdom-实现精准更新","终极武器：用 morphdom 实现精准更新",[16,6067,6068],{},"分块渲染虽然解决了大部分问题，但遇到 Markdown 列表就有点力不从心了。因为 Markdown 语法里，列表项之间通常只有一个换行符，整个列表会被当成一个大块。想象一下一个几百项的列表，哪怕只更新最后一项，整个列表块也要全部重来，前面的问题又回来了。",[320,6070,6072],{"id":6071},"morphdom-是何方神圣","morphdom 是何方神圣？",[16,6074,6075,6077,6078,1039],{},[51,6076,3261],{}," 是一个仅 5KB（gzip 后）的 JavaScript 库，核心功能是：",[34,6079,6080],{},"接收两个 DOM 节点（或 HTML 字符串），计算出最小化的 DOM 操作，将第一个节点 “变形” 为第二个节点，而非直接替换",[16,6082,6083,6084,2957],{},"其工作原理类似虚拟 DOM 的 Diff 算法，但",[34,6085,6086],{},"直接操作真实 DOM",[28,6088,6089,6092,6095],{},[31,6090,6091],{},"对比新旧 DOM 的标签名、属性、文本内容等；",[31,6093,6094],{},"仅对差异部分执行增 / 删 / 改操作（如修改文本、更新属性、移动节点位置）；",[31,6096,6097],{},"未变化的 DOM 节点会被完整保留，包括其事件监听、滚动位置、选中状态等。",[16,6099,6100,6101,6104,6105,6107],{},"Markdown 把列表当整体，但生成的 HTML 里，每个列表项 (",[51,6102,6103],{},"\u003Cli>",") 都是独立的！",[51,6106,3261],{}," 在更新后面的列表项时，能保证前面的列表项纹丝不动，状态自然就保住了。",[16,6109,6110],{},"这不就是我们梦寐以求的效果吗？在 Markdown 实时更新的同时，最大程度留住用户的操作状态，还能省掉一堆不必要的 DOM 操作！",[320,6112,6113],{"id":6113},"示例代码",[68,6115,6117],{"className":4549,"code":6116,"language":4551,"meta":73,"style":73},"\u003Ctemplate>\n  \u003Cdiv ref=\"markdownContainer\" class=\"markdown-container\">\n    \u003Cdiv id=\"md-root\">\u003C/div>\n  \u003C/div>\n\u003C/template>\n\n\u003Cscript setup>\nimport { nextTick, ref, watch } from 'vue';\nimport MarkdownIt from 'markdown-it';\nimport morphdom from 'morphdom';\n\nconst markdownContent = ref('');\nconst markdownContainer = ref(null);\nconst md = new MarkdownIt();\n\nconst render = () => {\n  if (!markdownContainer.value.querySelector('#md-root')) return;\n\n  const newHtml = `\u003Cdiv id=\"md-root\">` + md.render(markdownContent.value) + `\u003C/div>`\n\n  morphdom(markdownContainer.value, newHtml, {\n    childrenOnly: true\n  });\n}\n\nwatch(markdownContent, () => {\n    render()\n});\n\nonMounted(async () => {\n  // 等待 Dom 被挂载上\n  await nextTick()\n  render()\n})\n\u003C/script>\n\n",[51,6118,6119,6127,6150,6170,6178,6186,6190,6200,6225,6237,6251,6255,6271,6288,6302,6306,6322,6354,6358,6395,6399,6420,6430,6435,6439,6443,6457,6464,6469,6473,6488,6493,6503,6510,6514],{"__ignoreMap":73},[77,6120,6121,6123,6125],{"class":79,"line":80},[77,6122,1798],{"class":1344},[77,6124,4560],{"class":1360},[77,6126,4563],{"class":1344},[77,6128,6129,6131,6133,6135,6137,6140,6143,6145,6148],{"class":79,"line":86},[77,6130,4568],{"class":1344},[77,6132,5252],{"class":1360},[77,6134,4984],{"class":1928},[77,6136,1511],{"class":1344},[77,6138,6139],{"class":1396},"\"markdownContainer\"",[77,6141,6142],{"class":1928}," class",[77,6144,1511],{"class":1344},[77,6146,6147],{"class":1396},"\"markdown-container\"",[77,6149,4563],{"class":1344},[77,6151,6152,6154,6156,6159,6161,6164,6166,6168],{"class":79,"line":92},[77,6153,5510],{"class":1344},[77,6155,5252],{"class":1360},[77,6157,6158],{"class":1928}," id",[77,6160,1511],{"class":1344},[77,6162,6163],{"class":1396},"\"md-root\"",[77,6165,5267],{"class":1344},[77,6167,5252],{"class":1360},[77,6169,4563],{"class":1344},[77,6171,6172,6174,6176],{"class":79,"line":98},[77,6173,5596],{"class":1344},[77,6175,5252],{"class":1360},[77,6177,4563],{"class":1344},[77,6179,6180,6182,6184],{"class":79,"line":104},[77,6181,4594],{"class":1344},[77,6183,4560],{"class":1360},[77,6185,4563],{"class":1344},[77,6187,6188],{"class":79,"line":110},[77,6189,120],{"emptyLinePlaceholder":119},[77,6191,6192,6194,6196,6198],{"class":79,"line":116},[77,6193,1798],{"class":1344},[77,6195,4609],{"class":1360},[77,6197,4612],{"class":1928},[77,6199,4563],{"class":1344},[77,6201,6202,6204,6206,6209,6211,6213,6215,6217,6219,6221,6223],{"class":79,"line":123},[77,6203,3479],{"class":1328},[77,6205,1420],{"class":1344},[77,6207,6208],{"class":1360},"nextTick",[77,6210,1564],{"class":1344},[77,6212,4951],{"class":1360},[77,6214,1564],{"class":1344},[77,6216,5639],{"class":1360},[77,6218,1508],{"class":1344},[77,6220,3488],{"class":1328},[77,6222,5317],{"class":1396},[77,6224,5320],{"class":1344},[77,6226,6227,6229,6231,6233,6235],{"class":79,"line":129},[77,6228,3479],{"class":1328},[77,6230,5327],{"class":1360},[77,6232,3501],{"class":1328},[77,6234,5332],{"class":1396},[77,6236,5320],{"class":1344},[77,6238,6239,6241,6244,6246,6249],{"class":79,"line":134},[77,6240,3479],{"class":1328},[77,6242,6243],{"class":1360}," morphdom",[77,6245,3501],{"class":1328},[77,6247,6248],{"class":1396}," 'morphdom'",[77,6250,5320],{"class":1344},[77,6252,6253],{"class":79,"line":140},[77,6254,120],{"emptyLinePlaceholder":119},[77,6256,6257,6259,6261,6263,6265,6267,6269],{"class":79,"line":146},[77,6258,1329],{"class":1328},[77,6260,3515],{"class":1332},[77,6262,1337],{"class":1336},[77,6264,4984],{"class":1340},[77,6266,1345],{"class":1344},[77,6268,5353],{"class":1396},[77,6270,5356],{"class":1344},[77,6272,6273,6275,6278,6280,6282,6284,6286],{"class":79,"line":151},[77,6274,1329],{"class":1328},[77,6276,6277],{"class":1332}," markdownContainer",[77,6279,1337],{"class":1336},[77,6281,4984],{"class":1340},[77,6283,1345],{"class":1344},[77,6285,3625],{"class":1928},[77,6287,5356],{"class":1344},[77,6289,6290,6292,6294,6296,6298,6300],{"class":79,"line":157},[77,6291,1329],{"class":1328},[77,6293,5363],{"class":1332},[77,6295,1337],{"class":1336},[77,6297,5368],{"class":1328},[77,6299,5327],{"class":1340},[77,6301,5373],{"class":1344},[77,6303,6304],{"class":79,"line":163},[77,6305,120],{"emptyLinePlaceholder":119},[77,6307,6308,6310,6313,6315,6318,6320],{"class":79,"line":168},[77,6309,1329],{"class":1328},[77,6311,6312],{"class":1340}," render",[77,6314,1337],{"class":1336},[77,6316,6317],{"class":1344}," () ",[77,6319,1826],{"class":1328},[77,6321,1829],{"class":1344},[77,6323,6324,6326,6328,6330,6333,6335,6337,6339,6342,6344,6347,6350,6352],{"class":79,"line":174},[77,6325,3929],{"class":1328},[77,6327,3932],{"class":1344},[77,6329,3935],{"class":1336},[77,6331,6332],{"class":1348},"markdownContainer",[77,6334,629],{"class":1344},[77,6336,1841],{"class":1354},[77,6338,629],{"class":1344},[77,6340,6341],{"class":1340},"querySelector",[77,6343,1345],{"class":1344},[77,6345,6346],{"class":1396},"'#md-root'",[77,6348,6349],{"class":1344},")) ",[77,6351,3943],{"class":1328},[77,6353,5320],{"class":1344},[77,6355,6356],{"class":79,"line":180},[77,6357,120],{"emptyLinePlaceholder":119},[77,6359,6360,6363,6366,6368,6371,6373,6375,6377,6379,6381,6383,6385,6387,6389,6392],{"class":79,"line":185},[77,6361,6362],{"class":1328},"  const",[77,6364,6365],{"class":1332}," newHtml",[77,6367,1337],{"class":1336},[77,6369,6370],{"class":1396}," `\u003Cdiv id=\"md-root\">`",[77,6372,4194],{"class":1336},[77,6374,5363],{"class":1348},[77,6376,629],{"class":1344},[77,6378,4545],{"class":1340},[77,6380,1345],{"class":1344},[77,6382,3589],{"class":1348},[77,6384,629],{"class":1344},[77,6386,1841],{"class":1360},[77,6388,3940],{"class":1344},[77,6390,6391],{"class":1336},"+",[77,6393,6394],{"class":1396}," `\u003C/div>`\n",[77,6396,6397],{"class":79,"line":191},[77,6398,120],{"emptyLinePlaceholder":119},[77,6400,6401,6404,6406,6408,6410,6412,6414,6417],{"class":79,"line":197},[77,6402,6403],{"class":1340},"  morphdom",[77,6405,1345],{"class":1344},[77,6407,6332],{"class":1348},[77,6409,629],{"class":1344},[77,6411,1841],{"class":1360},[77,6413,1564],{"class":1344},[77,6415,6416],{"class":1427},"newHtml",[77,6418,6419],{"class":1344},", {\n",[77,6421,6422,6425,6427],{"class":79,"line":202},[77,6423,6424],{"class":1360},"    childrenOnly",[77,6426,1417],{"class":1416},[77,6428,6429],{"class":1928}," true\n",[77,6431,6432],{"class":79,"line":208},[77,6433,6434],{"class":1344},"  });\n",[77,6436,6437],{"class":79,"line":213},[77,6438,3877],{"class":1344},[77,6440,6441],{"class":79,"line":219},[77,6442,120],{"emptyLinePlaceholder":119},[77,6444,6445,6447,6449,6451,6453,6455],{"class":79,"line":224},[77,6446,5639],{"class":1340},[77,6448,1345],{"class":1344},[77,6450,3589],{"class":1427},[77,6452,1536],{"class":1344},[77,6454,1826],{"class":1328},[77,6456,1829],{"class":1344},[77,6458,6459,6462],{"class":79,"line":230},[77,6460,6461],{"class":1340},"    render",[77,6463,1444],{"class":1344},[77,6465,6466],{"class":79,"line":3862},[77,6467,6468],{"class":1344},"});\n",[77,6470,6471],{"class":79,"line":3874},[77,6472,120],{"emptyLinePlaceholder":119},[77,6474,6475,6477,6479,6482,6484,6486],{"class":79,"line":4480},[77,6476,5306],{"class":1340},[77,6478,1345],{"class":1344},[77,6480,6481],{"class":1328},"async",[77,6483,6317],{"class":1344},[77,6485,1826],{"class":1328},[77,6487,1829],{"class":1344},[77,6489,6490],{"class":79,"line":4488},[77,6491,6492],{"class":1433},"  // 等待 Dom 被挂载上\n",[77,6494,6495,6498,6501],{"class":79,"line":4494},[77,6496,6497],{"class":1328},"  await",[77,6499,6500],{"class":1340}," nextTick",[77,6502,1444],{"class":1344},[77,6504,6505,6508],{"class":79,"line":4527},[77,6506,6507],{"class":1340},"  render",[77,6509,1444],{"class":1344},[77,6511,6512],{"class":79,"line":4533},[77,6513,1938],{"class":1344},[77,6515,6516,6518,6520],{"class":79,"line":5972},[77,6517,4594],{"class":1344},[77,6519,4609],{"class":1360},[77,6521,4563],{"class":1344},[320,6523,6525],{"id":6524},"眼见为实demo-对比","眼见为实：Demo 对比",[16,6527,6528],{},"下面这个 iframe 里放了个对比 Demo，展示了不同方案的效果差异。",[16,6530,6531,6534],{},[34,6532,6533],{},"小技巧："," 如果你用的是 Chrome、Edge 这类 Chromium 内核的浏览器，打开开发者工具 (DevTools)，找到“渲染”(Rendering) 标签页，勾选「突出显示重绘区域(Paint flashing)」。这样你就能直观看到每次更新时，哪些部分被重新绘制了——重绘区域越少，性能越好！",[16,6536,6537],{},[1966,6538],{"alt":73,"src":6539},"https://static.031130.xyz/uploads/2025/07/12/d5721c40fb076.webp",[6541,6542],"iframe",{"src":6543,"width":6544,"height":6545,"allowFullScreen":119,"loading":6546},"https://static.031130.xyz/demo/morphdom-vs-markdown-chunk.html","100%",500,"lazy",[20,6548,6549],{"id":6549},"阶段性成果",[16,6551,6552,6553,6555],{},"从最开始的“暴力全量刷新”，到“聪明点的分块更新”，再到如今“精准手术刀般的 ",[51,6554,3261],{}," 更新”，我们一步步把那些不必要的渲染开销给砍掉了，最终搞出了一个既快又能留住用户状态的 Markdown 实时渲染方案。",[16,6557,6558,6559,6561],{},"不过，用 ",[51,6560,3261],{}," 这个第三方库来直接操作 Vue 组件里的 DOM，总觉得有点...不够“Vue”？它虽然解决了核心的性能和状态问题，但在 Vue 的世界里这么玩，多少有点旁门左道的意思。",[16,6563,6564,6567],{},[34,6565,6566],{},"下篇预告："," 在下一篇文章里，咱们就来聊聊，在 Vue 的世界里，有没有更优雅、更“原生”的方案来搞定 Markdown 的精准更新？敬请期待！",[382,6569,6570],{},"html pre.shiki code .s5ixo, html code.shiki .s5ixo{--shiki-default:#383A42;--shiki-dark:#ABB2BF}html pre.shiki code .sJa8x, html code.shiki .sJa8x{--shiki-default:#E45649;--shiki-dark:#E06C75}html pre.shiki code .sAGMh, html code.shiki .sAGMh{--shiki-default:#986801;--shiki-dark:#D19A66}html pre.shiki code .sz0mV, html code.shiki .sz0mV{--shiki-default:#383A42;--shiki-dark:#E06C75}html pre.shiki code .sLKXg, html code.shiki .sLKXg{--shiki-default:#A626A4;--shiki-dark:#C678DD}html pre.shiki code .sDhpE, html code.shiki .sDhpE{--shiki-default:#50A14F;--shiki-dark:#98C379}html pre.shiki code .sNmU0, html code.shiki .sNmU0{--shiki-default:#986801;--shiki-dark:#E5C07B}html pre.shiki code .s_Sar, html code.shiki .s_Sar{--shiki-default:#0184BC;--shiki-dark:#56B6C2}html pre.shiki code .sAdtL, html code.shiki .sAdtL{--shiki-default:#4078F2;--shiki-dark:#61AFEF}html pre.shiki code .s7GmK, html code.shiki .s7GmK{--shiki-default:#383A42;--shiki-dark:#E5C07B}html pre.shiki code .sW2Sy, html code.shiki .sW2Sy{--shiki-default:#A0A1A7;--shiki-default-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic}html .default .shiki span {color: var(--shiki-default);background: var(--shiki-default-bg);font-style: var(--shiki-default-font-style);font-weight: var(--shiki-default-font-weight);text-decoration: var(--shiki-default-text-decoration);}html .shiki span {color: var(--shiki-default);background: var(--shiki-default-bg);font-style: var(--shiki-default-font-style);font-weight: var(--shiki-default-font-weight);text-decoration: var(--shiki-default-text-decoration);}html .dark .shiki span {color: var(--shiki-dark);background: var(--shiki-dark-bg);font-style: var(--shiki-dark-font-style);font-weight: var(--shiki-dark-font-weight);text-decoration: var(--shiki-dark-text-decoration);}html.dark .shiki span {color: var(--shiki-dark);background: var(--shiki-dark-bg);font-style: var(--shiki-dark-font-style);font-weight: var(--shiki-dark-font-weight);text-decoration: var(--shiki-dark-text-decoration);}html pre.shiki code .s8iYz, html code.shiki .s8iYz{--shiki-default:#383A42;--shiki-default-font-style:inherit;--shiki-dark:#E06C75;--shiki-dark-font-style:italic}html pre.shiki code .sDaw7, html code.shiki .sDaw7{--shiki-default:#0184BC;--shiki-dark:#E06C75}html pre.shiki code .sRZ4U, html code.shiki .sRZ4U{--shiki-default:#986801;--shiki-dark:#E06C75}html pre.shiki code .sYoRg, html code.shiki .sYoRg{--shiki-default:#0184BC;--shiki-dark:#D19A66}html pre.shiki code .s2QsP, html code.shiki .s2QsP{--shiki-default:#E45649;--shiki-dark:#E5C07B}html pre.shiki code .st7oF, html code.shiki .st7oF{--shiki-default:#0184BC;--shiki-dark:#ABB2BF}",{"title":73,"searchDepth":86,"depth":86,"links":6572},[6573,6574,6575,6576,6581],{"id":5179,"depth":86,"text":5179},{"id":5212,"depth":86,"text":5213},{"id":5442,"depth":86,"text":5443},{"id":6064,"depth":86,"text":6065,"children":6577},[6578,6579,6580],{"id":6071,"depth":92,"text":6072},{"id":6113,"depth":92,"text":6113},{"id":6524,"depth":92,"text":6525},{"id":6549,"depth":86,"text":6549},{"title":6583,"date":6584,"path":6585,"tags":6586,"body":6589},"node-sass 迁移至 dart-sass 踩坑实录","2025-07-05 17:57:02","/2025/07/05/node-sass-migration-to-dart-sass",[3251,3248,6587,6588,1224],"Sass","CSS",{"type":13,"value":6590,"toc":7435},[6591,6594,6605,6609,6624,6627,6659,6662,6666,6669,6673,6682,6685,6694,6741,6744,6747,6750,6780,6789,6792,6796,6800,6824,6828,6942,6946,6955,6993,6997,7000,7066,7069,7073,7076,7079,7105,7108,7149,7158,7163,7167,7176,7183,7235,7238,7293,7296,7319,7322,7324,7432],[20,6592,6593],{"id":6593},"更新目标",[265,6595,6596,6599,6602],{},[31,6597,6598],{},"node-sass -> sass ( dart-sass )",[31,6600,6601],{},"减少影响面，非必要不更新其他依赖的版本",[31,6603,6604],{},"在前两条基础上，看看能否提升 node.js 的版本",[20,6606,6608],{"id":6607},"抛弃-node-sass-的理由","抛弃 node-sass 的理由",[265,6610,6611,6618,6621],{},[31,6612,6613],{},[368,6614,6617],{"href":6615,"rel":6616},"https://sass-lang.com/blog/libsass-is-deprecated/",[372],"node-sass 已经停止维护，dart-sass 是 sass 官方主推的继任者",[31,6619,6620],{},"node-sass 在 windows 下的安装非常麻烦，npm 安装时需要开发机上同时装有 python2 和 Microsoft Visual C++",[31,6622,6623],{},"在安装 node-sass 时，需要从 Github 拉取资源，在特定网络环境下成功率并不高",[20,6625,6626],{"id":6626},"项目依赖版本现状",[265,6628,6629,6634,6639,6644,6649,6654],{},[31,6630,6631],{},[51,6632,6633],{},"node@^12",[31,6635,6636],{},[51,6637,6638],{},"vue@^2",[31,6640,6641],{},[51,6642,6643],{},"webpack@^3",[31,6645,6646],{},[51,6647,6648],{},"vue-loader@^14",[31,6650,6651],{},[51,6652,6653],{},"sass-loader@^7.0.3",[31,6655,6656],{},[51,6657,6658],{},"node-sass@^4",[20,6660,6661],{"id":6661},"更新思路",[320,6663,6665],{"id":6664},"nodejs","node.js",[16,6667,6668],{},"webpack 官方并没有提供 webpack 3 支持的最高 node 版本，且即使 webpack 官方支持，webpack 的相关插件也未必支持。因此 node 版本能否更新就只能自己试。好在尽管这个项目的 CI/CD 跑在 node 12，但我日常都在用 node 14 开发，因此顺势将 node 版本提升至 14。",[320,6670,6672],{"id":6671},"webpacksass-loader","webpack、sass-loader",[16,6674,6675,6676,6681],{},"webpack 的版本目前处于非必要不更新的定时炸弹状态，基于现有的 webpack 3 限制，所支持的最高 sass-loader 版本就是 ^7 （ sass-loader 在 ",[368,6677,6680],{"href":6678,"rel":6679},"https://github.com/webpack-contrib/sass-loader/blob/v8.0.0/CHANGELOG.md",[372],"8.0.0 版本的更新日志","中明确指出 8.0.0 版本需要 webpack 4.36.0）。",[16,6683,6684],{},"如果项目中 sass-loader@^7 支持使用 dart-sass 就可以不更新 sass-loader，也就不必更新 webpack 版本；反之，就需要同步更新 webpack 至 4，再视情况定下 sass-loader 的版本。",[16,6686,6687,6688,6693],{},"那么到底支不支持呢？我在 ",[368,6689,6692],{"href":6690,"rel":6691},"https://www.webpackjs.com/loaders/sass-loader/",[372],"webpack 官方文档介绍 sass-loader 的页面","找到了这样一段 package.json 片段",[68,6695,6697],{"className":3638,"code":6696,"language":3640,"meta":73,"style":73},"{\n  \"devDependencies\": {\n    \"sass-loader\": \"^7.2.0\",\n    \"sass\": \"^1.22.10\"\n  }\n}\n",[51,6698,6699,6703,6711,6723,6733,6737],{"__ignoreMap":73},[77,6700,6701],{"class":79,"line":80},[77,6702,3647],{"class":1344},[77,6704,6705,6708],{"class":79,"line":86},[77,6706,6707],{"class":1360},"  \"devDependencies\"",[77,6709,6710],{"class":1344},": {\n",[77,6712,6713,6716,6718,6721],{"class":79,"line":92},[77,6714,6715],{"class":1360},"    \"sass-loader\"",[77,6717,3655],{"class":1344},[77,6719,6720],{"class":1396},"\"^7.2.0\"",[77,6722,3661],{"class":1344},[77,6724,6725,6728,6730],{"class":79,"line":98},[77,6726,6727],{"class":1360},"    \"sass\"",[77,6729,3655],{"class":1344},[77,6731,6732],{"class":1396},"\"^1.22.10\"\n",[77,6734,6735],{"class":79,"line":104},[77,6736,4530],{"class":1344},[77,6738,6739],{"class":79,"line":110},[77,6740,3877],{"class":1344},[16,6742,6743],{},"这证明起码在 sass-loader@7.2.0 这一版本就已经支持 dart-sass 了，因此 webpack 版本可以停留在 ^3，而 sass-loader 暂时停留在 7.0.3 版本，如果后续有问题可以更新到 ^7 版本中最新的 7.3.1 版本。",[320,6745,6746],{"id":6746},"dart-sass",[16,6748,6749],{},"sass-loader@^7 所支持的最高 sass 我并没有查到，Github Copilot 信誓旦旦地告诉我",[557,6751,6752,6757,6762,6767],{},[16,6753,6754],{},[34,6755,6756],{},"官方文档引用：",[557,6758,6759],{},[16,6760,6761],{},"sass-loader@^7.0.0 requires node-sass >=4.0.0 or sass >=1.3.0, \u003C=1.26.5.",[16,6763,6764],{},[34,6765,6766],{},"建议：",[265,6768,6769],{},[31,6770,6771,6772,6775,6776,6779],{},"如果需要使用更高版本的 ",[51,6773,6774],{},"sass","，请升级到 ",[51,6777,6778],{},"sass-loader"," 8 或更高版本。",[16,6781,6782,6783,6788],{},"但事实上，我并没有在互联网上找到这段文本的蛛丝马迹。并且在 sass 的 ~1.26 版本中最后一个版本是 1.26.11 而非 1.26.5，",[368,6784,6787],{"href":6785,"rel":6786},"https://docs.npmjs.com/about-semantic-versioning",[372],"根据常见的 npm 版本号原则","，major version 和 minor version 不变，只改变了 patch version 的发版一般只有 bugfix 而没有 breaking change，不至于从 1.26.5 更新到 1.26.11 就突然不支持 sass-loader 7 了，因此更可能是 AI 幻觉或者是训练数据受限。",[16,6790,6791],{},"出于谨慎考虑，最终决定采用 webpack 官方文档中提到的 sass 1.22 的最后一个版本，也就是 1.22.12。",[20,6793,6795],{"id":6794},"分析完成动手更新","分析完成，动手更新",[320,6797,6799],{"id":6798},"第一步卸载-node-sass安装-sass12212","第一步，卸载 node-sass，安装 sass@^1.22.12",[68,6801,6803],{"className":3446,"code":6802,"language":3448,"meta":73,"style":73},"npm uninstall node-sass\nnpm install sass@^1.22.12\n",[51,6804,6805,6815],{"__ignoreMap":73},[77,6806,6807,6809,6812],{"class":79,"line":80},[77,6808,3455],{"class":1340},[77,6810,6811],{"class":1396}," uninstall",[77,6813,6814],{"class":1396}," node-sass\n",[77,6816,6817,6819,6821],{"class":79,"line":86},[77,6818,3455],{"class":1340},[77,6820,3458],{"class":1396},[77,6822,6823],{"class":1396}," sass@^1.22.12\n",[320,6825,6827],{"id":6826},"第二步更新-webpack-配置非必须","第二步，更新 webpack 配置（非必须）",[68,6829,6831],{"className":2725,"code":6830,"language":2727,"meta":73,"style":73},"module.exports = {\n  // ...\n  module: {\n    rules: [\n      {\n        test: /\\.(scss|sass)$/,\n        use: [\n          'style-loader',\n          'css-loader',\n          {\n            loader: 'sass-loader',\n+            options: {\n+                // 事实上，这一行在大部分 sass-loader 版本中不用加，sass-loader 能自动检测本地是 sass 还是 node-sass\n+                implementation: require('sass')\n+              },\n            },\n          },\n        ],\n      },\n    ],\n  },\n};\n",[51,6832,6833,6838,6843,6848,6853,6858,6863,6868,6873,6878,6883,6888,6893,6898,6903,6908,6913,6918,6923,6928,6933,6937],{"__ignoreMap":73},[77,6834,6835],{"class":79,"line":80},[77,6836,6837],{"class":1344},"module.exports = {\n",[77,6839,6840],{"class":79,"line":86},[77,6841,6842],{"class":1344},"  // ...\n",[77,6844,6845],{"class":79,"line":92},[77,6846,6847],{"class":1344},"  module: {\n",[77,6849,6850],{"class":79,"line":98},[77,6851,6852],{"class":1344},"    rules: [\n",[77,6854,6855],{"class":79,"line":104},[77,6856,6857],{"class":1344},"      {\n",[77,6859,6860],{"class":79,"line":110},[77,6861,6862],{"class":1344},"        test: /\\.(scss|sass)$/,\n",[77,6864,6865],{"class":79,"line":116},[77,6866,6867],{"class":1344},"        use: [\n",[77,6869,6870],{"class":79,"line":123},[77,6871,6872],{"class":1344},"          'style-loader',\n",[77,6874,6875],{"class":79,"line":129},[77,6876,6877],{"class":1344},"          'css-loader',\n",[77,6879,6880],{"class":79,"line":134},[77,6881,6882],{"class":1344},"          {\n",[77,6884,6885],{"class":79,"line":140},[77,6886,6887],{"class":1344},"            loader: 'sass-loader',\n",[77,6889,6890],{"class":79,"line":146},[77,6891,6892],{"class":1396},"+            options: {\n",[77,6894,6895],{"class":79,"line":151},[77,6896,6897],{"class":1396},"+                // 事实上，这一行在大部分 sass-loader 版本中不用加，sass-loader 能自动检测本地是 sass 还是 node-sass\n",[77,6899,6900],{"class":79,"line":157},[77,6901,6902],{"class":1396},"+                implementation: require('sass')\n",[77,6904,6905],{"class":79,"line":163},[77,6906,6907],{"class":1396},"+              },\n",[77,6909,6910],{"class":79,"line":168},[77,6911,6912],{"class":1344},"            },\n",[77,6914,6915],{"class":79,"line":174},[77,6916,6917],{"class":1344},"          },\n",[77,6919,6920],{"class":79,"line":180},[77,6921,6922],{"class":1344},"        ],\n",[77,6924,6925],{"class":79,"line":185},[77,6926,6927],{"class":1344},"      },\n",[77,6929,6930],{"class":79,"line":191},[77,6931,6932],{"class":1344},"    ],\n",[77,6934,6935],{"class":79,"line":197},[77,6936,6005],{"class":1344},[77,6938,6939],{"class":79,"line":202},[77,6940,6941],{"class":1344},"};\n",[320,6943,6945],{"id":6944},"第三步批量替换-deep-语法为-v-deep","第三步，批量替换 /deep/ 语法为 ::v-deep",[16,6947,6948,6949,6954],{},"因为 ",[368,6950,6953],{"href":6951,"rel":6952},"https://chromestatus.com/feature/4964279606312960",[372],"/deep/ 写法在 2017 年被弃用"," ，/deep/ 变成了不受支持的深度作用选择器，node-sass 凭借其出色的容错性能够继续提供兼容，但 dart-sass 则不支持这种写法。于是需要将 /deep/ 语法批量替换成 ::v-deep 写法，这种写法虽然在 vue 的后续 rfc 被放弃了，但直至今日依然在事实上被支持。",[68,6956,6958],{"className":3446,"code":6957,"language":3448,"meta":73,"style":73},"# 大概就是这么个意思，用 vscode 的批量替换其实也行\nsed -i 's#\\s*/deep/\\s*# ::v-deep #g' $(grep -rl '/deep/' .)\n",[51,6959,6960,6965],{"__ignoreMap":73},[77,6961,6962],{"class":79,"line":80},[77,6963,6964],{"class":1433},"# 大概就是这么个意思，用 vscode 的批量替换其实也行\n",[77,6966,6967,6970,6973,6976,6979,6982,6985,6988,6991],{"class":79,"line":86},[77,6968,6969],{"class":1340},"sed",[77,6971,6972],{"class":1928}," -i",[77,6974,6975],{"class":1396}," 's#\\s*/deep/\\s*# ::v-deep #g'",[77,6977,6978],{"class":1344}," $(",[77,6980,6981],{"class":1340},"grep",[77,6983,6984],{"class":1928}," -rl",[77,6986,6987],{"class":1396}," '/deep/'",[77,6989,6990],{"class":1396}," .",[77,6992,1372],{"class":1344},[320,6994,6996],{"id":6995},"第四步修复其他-sass-语法错误","第四步，修复其他 sass 语法错误",[16,6998,6999],{},"在迁移的过程中，我发现项目中有一些不规范的写法，node-sass 凭借出色的鲁棒性不吭一声强行解析，而 dart-sass 则干不了这粗活。因此需要根据编译时的报错手动修复一下这些语法错误，我这里一共遇到两种。",[68,7001,7003],{"className":2725,"code":7002,"language":2727,"meta":73,"style":73},"// 多打了一个冒号\n.foo {\n-  color:: #fff;\n+  color: #fff;\n}\n\n// :nth-last-child 没指定数字\n.bar {\n-  &:nth-last-child() {\n+  &:nth-last-child(1) {\n      margin-bottom: 0;\n  }\n}\n",[51,7004,7005,7010,7015,7020,7025,7029,7033,7038,7043,7048,7053,7058,7062],{"__ignoreMap":73},[77,7006,7007],{"class":79,"line":80},[77,7008,7009],{"class":1344},"// 多打了一个冒号\n",[77,7011,7012],{"class":79,"line":86},[77,7013,7014],{"class":1344},".foo {\n",[77,7016,7017],{"class":79,"line":92},[77,7018,7019],{"class":1360},"-  color:: #fff;\n",[77,7021,7022],{"class":79,"line":98},[77,7023,7024],{"class":1396},"+  color: #fff;\n",[77,7026,7027],{"class":79,"line":104},[77,7028,3877],{"class":1344},[77,7030,7031],{"class":79,"line":110},[77,7032,120],{"emptyLinePlaceholder":119},[77,7034,7035],{"class":79,"line":116},[77,7036,7037],{"class":1344},"// :nth-last-child 没指定数字\n",[77,7039,7040],{"class":79,"line":123},[77,7041,7042],{"class":1344},".bar {\n",[77,7044,7045],{"class":79,"line":129},[77,7046,7047],{"class":1360},"-  &:nth-last-child() {\n",[77,7049,7050],{"class":79,"line":134},[77,7051,7052],{"class":1396},"+  &:nth-last-child(1) {\n",[77,7054,7055],{"class":79,"line":140},[77,7056,7057],{"class":1344},"      margin-bottom: 0;\n",[77,7059,7060],{"class":79,"line":146},[77,7061,4530],{"class":1344},[77,7063,7064],{"class":79,"line":151},[77,7065,3877],{"class":1344},[20,7067,7068],{"id":7068},"踩坑",[320,7070,7072],{"id":7071},"v-deep-样式不生效","::v-deep 样式不生效",[16,7074,7075],{},"依赖更新完后看了两眼好像是没问题，就推测试环境了。结果一天没到就被同事 call 了，::v-deep 这种深度作用选择器居然没有生效？",[16,7077,7078],{},"抱着试一试的态度，GPT 给了如下回答",[557,7080,7081],{},[16,7082,7083,7084,7087,7088,7091,7092,7098,7099,7102,7103,5097],{},"在 ",[34,7085,7086],{},"Vue 2 + vue-loader + Sass"," 的组合下，",[34,7089,7090],{},"这种写法是正确的","，",[34,7093,7094,7095],{},"前提是你的构建工具链支持 ",[51,7096,7097],{},"::v-deep"," 语法（如 ",[51,7100,7101],{},"vue-loader@15"," 及以上版本 + ",[51,7104,6778],{},[16,7106,7107],{},"虽说我依然没有查证到为什么更新 vue-loader@15 才能使用 ::v-deep 语法，但对 vue-loader 进行更新后，::v-deep 语法确实生效了。在撰写本文时，我找到了些许蛛丝马迹，可能能解释这一问题。",[28,7109,7110,7124],{},[31,7111,7112,7113,7118,7119,1039],{},"vue-loader 在 ",[368,7114,7117],{"href":7115,"rel":7116},"https://vue-loader-v14.vuejs.org/en/features/scoped-css.html#deep-selectors",[372],"14 版本的官方文档","就是没有 ::v-deep 写法的示例，",[368,7120,7123],{"href":7121,"rel":7122},"https://github.com/vuejs/vue-loader/commit/2585d254fc774386a898887467fbdd30eb864b53",[372],"这一示例一直在 vue-loader 15.7.0 版本发布后才被加入",[31,7125,7126,7127,7134,7137,7138,7143,7144],{},"vue-cli 的 Github Issue 评论区中有人提到",[557,7128,7129],{},[16,7130,7131,7133],{},[51,7132,7097],{}," implemented in @vue/component-compiler-utils v2.6.0, should work after you reinstall the deps.",[7135,7136],"br",{},"而 vue-loader 在 15.0.0-beta.1 版本才",[368,7139,7142],{"href":7140,"rel":7141},"https://github.com/vuejs/vue-loader/commit/e32cd0e4372fcc6f13b6c307402713807516d71c#diff-7ae45ad102eab3b6d7e7896acd08c427a9b25b346470d7bc6507b6481575d519",[372],"将 @vue/component-compiler-utils 加入到自己的 dependencies 中","，并直到 vue-loader 15.7.1 中才",[368,7145,7148],{"href":7146,"rel":7147},"https://github.com/vuejs/vue-loader/commit/c359a38db0fbb4135fc97114baec3cd557d4123a",[372],"将其 @vue/component-compiler-utils 的版本号更新到满足要求的 ^3.0.0",[16,7150,7151,7152,7157],{},"那能否升级到 vue-loader 16 甚至 17 版本呢？不行，在 ",[368,7153,7156],{"href":7154,"rel":7155},"https://github.com/vuejs/vue-loader/releases/tag/v16.1.2",[372],"vue-loader v16.1.2 的更新日志","中明确写道",[557,7159,7160],{},[16,7161,7162],{},"Note: vue-loader v16 is for Vue 3 only.",[320,7164,7166],{"id":7165},"vue-loader-14-15-breaking-change","vue-loader 14 -> 15 breaking change",[16,7168,7169,7170,7175],{},"vue-loader 从 14 往上迁移时，不修改 webpack 配置直接跑会遇到 vue 语法不识别的问题。具体表现为 .vue 文件命名都是正确有效的语法，但构建开发时编译器就是不认，报语法错误。vue-loader 官方有一份",[368,7171,7174],{"href":7172,"rel":7173},"https://vue-loader.vuejs.org/migrating.html",[372],"迁移文档","，需要注意一下。",[68,7177,7181],{"className":7178,"code":7180,"language":3899},[7179],"language-text","ERROR in ./src/......\nModule parse failed: Unexpected token(1:0)\nYou may need an appropriate loader to handle this file type.\n",[51,7182,7180],{"__ignoreMap":73},[68,7184,7186],{"className":2725,"code":7185,"language":2727,"meta":73,"style":73},"// ...\nimport path from 'path'\n+const VueLoaderPlugin = require('vue-loader/lib/plugin')\n\n// ...\n\n  plugins: [\n+    new VueLoaderPlugin()\n    // ...\n  ]\n",[51,7187,7188,7193,7198,7203,7207,7211,7215,7220,7225,7230],{"__ignoreMap":73},[77,7189,7190],{"class":79,"line":80},[77,7191,7192],{"class":1344},"// ...\n",[77,7194,7195],{"class":79,"line":86},[77,7196,7197],{"class":1344},"import path from 'path'\n",[77,7199,7200],{"class":79,"line":92},[77,7201,7202],{"class":1396},"+const VueLoaderPlugin = require('vue-loader/lib/plugin')\n",[77,7204,7205],{"class":79,"line":98},[77,7206,120],{"emptyLinePlaceholder":119},[77,7208,7209],{"class":79,"line":104},[77,7210,7192],{"class":1344},[77,7212,7213],{"class":79,"line":110},[77,7214,120],{"emptyLinePlaceholder":119},[77,7216,7217],{"class":79,"line":116},[77,7218,7219],{"class":1344},"  plugins: [\n",[77,7221,7222],{"class":79,"line":123},[77,7223,7224],{"class":1396},"+    new VueLoaderPlugin()\n",[77,7226,7227],{"class":79,"line":129},[77,7228,7229],{"class":1344},"    // ...\n",[77,7231,7232],{"class":79,"line":134},[77,7233,7234],{"class":1344},"  ]\n",[16,7236,7237],{},"除此之外，在我这个项目中需要额外移除 webpack 配置中针对 .vue 文件的 babel-loader",[68,7239,7241],{"className":2725,"code":7240,"language":2727,"meta":73,"style":73},"{\n  test: /\\.vue$/,\n  use: [\n-    {\n-      loader: 'babel-loader'\n-    },\n    {\n      loader: 'vue-loader',\n    }\n  ]\n}\n",[51,7242,7243,7247,7252,7257,7262,7267,7272,7276,7281,7285,7289],{"__ignoreMap":73},[77,7244,7245],{"class":79,"line":80},[77,7246,3647],{"class":1344},[77,7248,7249],{"class":79,"line":86},[77,7250,7251],{"class":1344},"  test: /\\.vue$/,\n",[77,7253,7254],{"class":79,"line":92},[77,7255,7256],{"class":1344},"  use: [\n",[77,7258,7259],{"class":79,"line":98},[77,7260,7261],{"class":1360},"-    {\n",[77,7263,7264],{"class":79,"line":104},[77,7265,7266],{"class":1360},"-      loader: 'babel-loader'\n",[77,7268,7269],{"class":79,"line":110},[77,7270,7271],{"class":1360},"-    },\n",[77,7273,7274],{"class":79,"line":116},[77,7275,3674],{"class":1344},[77,7277,7278],{"class":79,"line":123},[77,7279,7280],{"class":1344},"      loader: 'vue-loader',\n",[77,7282,7283],{"class":79,"line":129},[77,7284,3854],{"class":1344},[77,7286,7287],{"class":79,"line":134},[77,7288,7234],{"class":1344},[77,7290,7291],{"class":79,"line":140},[77,7292,3877],{"class":1344},[20,7294,7295],{"id":7295},"最终更新情况",[265,7297,7298,7305,7312],{},[31,7299,7300,3056,7302],{},[51,7301,6633],{},[51,7303,7304],{},"node@^14",[31,7306,7307,3056,7309],{},[51,7308,6648],{},[51,7310,7311],{},"vue-loader@^15",[31,7313,7314,3056,7316],{},[51,7315,6658],{},[51,7317,7318],{},"sass@^1.22.12",[16,7320,7321],{},"其余依赖版本维持不变",[20,7323,362],{"id":362},[265,7325,7326,7343,7350,7356,7362,7369,7376,7382,7388,7394,7400,7406,7412,7419,7426],{},[31,7327,7328],{},[368,7329,7332,7333,7335,7336,7339,7340,7342],{"href":7330,"rel":7331},"https://juejin.cn/post/7327094228350500914",[372],"node-sass更换为dart-sass",[51,7334,6746],{}," 和 ",[51,7337,7338],{},"node-sass","都是用来将",[51,7341,6774],{},"编译成 - 掘金",[31,7344,7345],{},[368,7346,7349],{"href":7347,"rel":7348},"https://sunchenggit.github.io/2021/01/13/node-sass%E8%BF%81%E7%A7%BBdart-sass/",[372],"node-sass迁移dart-sass | Bolg",[31,7351,7352],{},[368,7353,7355],{"href":6690,"rel":7354},[372],"sass-loader | webpack 中文文档 | webpack中文文档 | webpack中文网",[31,7357,7358],{},[368,7359,7361],{"href":6615,"rel":7360},[372],"Sass: LibSass is Deprecated",[31,7363,7364],{},[368,7365,7368],{"href":7366,"rel":7367},"https://www.npmjs.com/package/sass?activeTab=versions",[372],"sass - npm",[31,7370,7371],{},[368,7372,7375],{"href":7373,"rel":7374},"https://www.npmjs.com/package/node-sass",[372],"node-sass - npm",[31,7377,7378],{},[368,7379,7381],{"href":6785,"rel":7380},[372],"About semantic versioning | npm Docs",[31,7383,7384],{},[368,7385,7387],{"href":6951,"rel":7386},[372],"Make /deep/ behave like the descendant combinator \" \" in CSS live profile (in css file or inside of \u003Cstyle>) - Chrome Platform Status",[31,7389,7390],{},[368,7391,7393],{"href":6678,"rel":7392},[372],"sass-loader/CHANGELOG.md at v8.0.0 · webpack-contrib/sass-loader",[31,7395,7396],{},[368,7397,7399],{"href":7154,"rel":7398},[372],"Release v16.1.2 · vuejs/vue-loader",[31,7401,7402],{},[368,7403,7405],{"href":7140,"rel":7404},[372],"refactor: use @vue/component-compiler-utils · vuejs/vue-loader@e32cd0e",[31,7407,7408],{},[368,7409,7411],{"href":7146,"rel":7410},[372],"chore: update @vue/component-compiler-utils to v3 · vuejs/vue-loader@c359a38",[31,7413,7414],{},[368,7415,7418],{"href":7416,"rel":7417},"https://github.com/vuejs/vue-cli/issues/3399#issuecomment-466319019",[372],"dart-sass does not support /deep/ selector · Issue #3399 · vuejs/vue-cli",[31,7420,7421],{},[368,7422,7425],{"href":7423,"rel":7424},"https://vue-loader-v14.vuejs.org/en/features/scoped-css.html",[372],"Scoped CSS · vue-loader v14",[31,7427,7428],{},[368,7429,7431],{"href":7172,"rel":7430},[372],"Migrating from v14 | Vue Loader",[382,7433,7434],{},"html pre.shiki code .s5ixo, html code.shiki .s5ixo{--shiki-default:#383A42;--shiki-dark:#ABB2BF}html pre.shiki code .sJa8x, html code.shiki .sJa8x{--shiki-default:#E45649;--shiki-dark:#E06C75}html pre.shiki code .sDhpE, html code.shiki .sDhpE{--shiki-default:#50A14F;--shiki-dark:#98C379}html .default .shiki span {color: var(--shiki-default);background: var(--shiki-default-bg);font-style: var(--shiki-default-font-style);font-weight: var(--shiki-default-font-weight);text-decoration: var(--shiki-default-text-decoration);}html .shiki span {color: var(--shiki-default);background: var(--shiki-default-bg);font-style: var(--shiki-default-font-style);font-weight: var(--shiki-default-font-weight);text-decoration: var(--shiki-default-text-decoration);}html .dark .shiki span {color: var(--shiki-dark);background: var(--shiki-dark-bg);font-style: var(--shiki-dark-font-style);font-weight: var(--shiki-dark-font-weight);text-decoration: var(--shiki-dark-text-decoration);}html.dark .shiki span {color: var(--shiki-dark);background: var(--shiki-dark-bg);font-style: var(--shiki-dark-font-style);font-weight: var(--shiki-dark-font-weight);text-decoration: var(--shiki-dark-text-decoration);}html pre.shiki code .sAdtL, html code.shiki .sAdtL{--shiki-default:#4078F2;--shiki-dark:#61AFEF}html pre.shiki code .sW2Sy, html code.shiki .sW2Sy{--shiki-default:#A0A1A7;--shiki-default-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic}html pre.shiki code .sAGMh, html code.shiki .sAGMh{--shiki-default:#986801;--shiki-dark:#D19A66}",{"title":73,"searchDepth":86,"depth":86,"links":7436},[7437,7438,7439,7440,7445,7451,7455,7456],{"id":6593,"depth":86,"text":6593},{"id":6607,"depth":86,"text":6608},{"id":6626,"depth":86,"text":6626},{"id":6661,"depth":86,"text":6661,"children":7441},[7442,7443,7444],{"id":6664,"depth":92,"text":6665},{"id":6671,"depth":92,"text":6672},{"id":6746,"depth":92,"text":6746},{"id":6794,"depth":86,"text":6795,"children":7446},[7447,7448,7449,7450],{"id":6798,"depth":92,"text":6799},{"id":6826,"depth":92,"text":6827},{"id":6944,"depth":92,"text":6945},{"id":6995,"depth":92,"text":6996},{"id":7068,"depth":86,"text":7068,"children":7452},[7453,7454],{"id":7071,"depth":92,"text":7072},{"id":7165,"depth":92,"text":7166},{"id":7295,"depth":86,"text":7295},{"id":362,"depth":86,"text":362},130,1762982128206]