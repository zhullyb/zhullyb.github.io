[{"data":1,"prerenderedAt":9048},["ShallowReactive",2],{"randomIndex/":3,"language-switch-/-en":4,"index-page-1-zh":5,"posts-total-zh":9047},6,"/en/",[6,2057,2397,2824,3842,4216,4428,4909,6808,8173],{"title":7,"date":8,"path":9,"tags":10,"body":13},"你的域名后缀拖慢你的网站速度了嘛？——再谈 DNS 冷启动","2025-11-25","/2025/11/25/did-your-tld-slowing-down-your-site",[11,12],"Network","DNS",{"type":14,"value":15,"toc":2052},"minimark",[16,30,37,250,253,257,260,271,290,297,300,306,309,312,318,321,324,327,333,336,339,342,358,361,364,367,1628,1631,1636,2026,2029,2039,2048],[17,18,19,20,25,26],"p",{},"在",[21,22,24],"a",{"href":23},"/2025/11/11/dns-cold-start-dilemma/","上一篇博客","中，我提到过一个核心观点——",[27,28,29],"strong",{},"对于流量少、访客的地理位置不集中的小型站点，DNS 冷启动不是偶发的“意外”，而是一种被动的“常态”。",[17,31,32,33,36],{},"对于大多数站长而言，自己的站点流量不是一时半刻就能提上去的，因此我们的访客大概率都要走完一遍完整的 DNS 解析过程。上一篇博客中我提到过更改为距离访客物理位置更近的权威 DNS 服务器来提升速度，但 ",[27,34,35],{},"TLD（域名后缀）的 Nameservers 是我们无法改变的","，也就是下图中红色背景的那一段解析过程。",[38,39,44],"pre",{"className":40,"code":41,"language":42,"meta":43,"style":43},"language-mermaid shiki shiki-themes one-light one-dark-pro","sequenceDiagram\n    autonumber\n    participant User as 用户/浏览器\n    participant Local as 本地DNS\u003Cbr>递归解析器\n    participant Root as 根域名服务器\n    participant TLD as 顶级域服务器\u003Cbr>(TLD Server)\n    participant Auth as 权威DNS服务器\n\n    Note over User,Auth: DNS 递归查询完整流程\n\n    User->>Local: 查询域名 www.example.com\n    Note over Local: 检查缓存 (MISS)\n\n    Local->>Root: 查询 .com 的 TLD 服务器\n    Root-->>Local: 返回 .com TLD 服务器地址\n\n    %% --- 重点高亮区域开始 ---\n    rect rgb(255, 235, 235)\n        Note right of Local: ⚠️ 本文核心讨论区域 \u003Cbr> (TLD 解析时延)\n        Local->>TLD: 查询 example.com 的权威服务器\n\n        Note left of TLD: 这里的物理距离与 Anycast 能力\u003Cbr>决定了是否存在数百毫秒的延迟\n\n        TLD-->>Local: 返回 example.com 的权威服务器地址\n    end\n    %% --- 重点高亮区域结束 ---\n\n    Local->>Auth: 查询 www.example.com 的 A 记录\n    Auth-->>Local: 返回 IP 地址 (e.g., 1.1.1.1)\n\n    Note over Local: 缓存结果 (TTL)\n\n    Local-->>User: 返回最终 IP 地址\n\n    User->>Auth: 建立 TCP 连接 / HTTP 请求\n","mermaid","",[45,46,47,55,61,67,73,79,84,90,97,103,108,114,120,125,131,137,142,148,154,160,166,171,177,182,188,194,200,205,211,217,222,228,233,239,244],"code",{"__ignoreMap":43},[48,49,52],"span",{"class":50,"line":51},"line",1,[48,53,54],{},"sequenceDiagram\n",[48,56,58],{"class":50,"line":57},2,[48,59,60],{},"    autonumber\n",[48,62,64],{"class":50,"line":63},3,[48,65,66],{},"    participant User as 用户/浏览器\n",[48,68,70],{"class":50,"line":69},4,[48,71,72],{},"    participant Local as 本地DNS\u003Cbr>递归解析器\n",[48,74,76],{"class":50,"line":75},5,[48,77,78],{},"    participant Root as 根域名服务器\n",[48,80,81],{"class":50,"line":3},[48,82,83],{},"    participant TLD as 顶级域服务器\u003Cbr>(TLD Server)\n",[48,85,87],{"class":50,"line":86},7,[48,88,89],{},"    participant Auth as 权威DNS服务器\n",[48,91,93],{"class":50,"line":92},8,[48,94,96],{"emptyLinePlaceholder":95},true,"\n",[48,98,100],{"class":50,"line":99},9,[48,101,102],{},"    Note over User,Auth: DNS 递归查询完整流程\n",[48,104,106],{"class":50,"line":105},10,[48,107,96],{"emptyLinePlaceholder":95},[48,109,111],{"class":50,"line":110},11,[48,112,113],{},"    User->>Local: 查询域名 www.example.com\n",[48,115,117],{"class":50,"line":116},12,[48,118,119],{},"    Note over Local: 检查缓存 (MISS)\n",[48,121,123],{"class":50,"line":122},13,[48,124,96],{"emptyLinePlaceholder":95},[48,126,128],{"class":50,"line":127},14,[48,129,130],{},"    Local->>Root: 查询 .com 的 TLD 服务器\n",[48,132,134],{"class":50,"line":133},15,[48,135,136],{},"    Root-->>Local: 返回 .com TLD 服务器地址\n",[48,138,140],{"class":50,"line":139},16,[48,141,96],{"emptyLinePlaceholder":95},[48,143,145],{"class":50,"line":144},17,[48,146,147],{},"    %% --- 重点高亮区域开始 ---\n",[48,149,151],{"class":50,"line":150},18,[48,152,153],{},"    rect rgb(255, 235, 235)\n",[48,155,157],{"class":50,"line":156},19,[48,158,159],{},"        Note right of Local: ⚠️ 本文核心讨论区域 \u003Cbr> (TLD 解析时延)\n",[48,161,163],{"class":50,"line":162},20,[48,164,165],{},"        Local->>TLD: 查询 example.com 的权威服务器\n",[48,167,169],{"class":50,"line":168},21,[48,170,96],{"emptyLinePlaceholder":95},[48,172,174],{"class":50,"line":173},22,[48,175,176],{},"        Note left of TLD: 这里的物理距离与 Anycast 能力\u003Cbr>决定了是否存在数百毫秒的延迟\n",[48,178,180],{"class":50,"line":179},23,[48,181,96],{"emptyLinePlaceholder":95},[48,183,185],{"class":50,"line":184},24,[48,186,187],{},"        TLD-->>Local: 返回 example.com 的权威服务器地址\n",[48,189,191],{"class":50,"line":190},25,[48,192,193],{},"    end\n",[48,195,197],{"class":50,"line":196},26,[48,198,199],{},"    %% --- 重点高亮区域结束 ---\n",[48,201,203],{"class":50,"line":202},27,[48,204,96],{"emptyLinePlaceholder":95},[48,206,208],{"class":50,"line":207},28,[48,209,210],{},"    Local->>Auth: 查询 www.example.com 的 A 记录\n",[48,212,214],{"class":50,"line":213},29,[48,215,216],{},"    Auth-->>Local: 返回 IP 地址 (e.g., 1.1.1.1)\n",[48,218,220],{"class":50,"line":219},30,[48,221,96],{"emptyLinePlaceholder":95},[48,223,225],{"class":50,"line":224},31,[48,226,227],{},"    Note over Local: 缓存结果 (TTL)\n",[48,229,231],{"class":50,"line":230},32,[48,232,96],{"emptyLinePlaceholder":95},[48,234,236],{"class":50,"line":235},33,[48,237,238],{},"    Local-->>User: 返回最终 IP 地址\n",[48,240,242],{"class":50,"line":241},34,[48,243,96],{"emptyLinePlaceholder":95},[48,245,247],{"class":50,"line":246},35,[48,248,249],{},"    User->>Auth: 建立 TCP 连接 / HTTP 请求\n",[17,251,252],{},"所以，如果你还没有购买域名，但想要像个 geeker 一样追求极致的首屏加载（哪怕你并没有多少访客），你该选择哪个 TLD 呢？",[254,255,256],"h2",{"id":256},"简单测试",[17,258,259],{},"一个简单的方法是，直接去 ping TLD 的 nameserver，看看访客所请求的公共 DNS 服务器在这一段解析中所花费的时常。",[17,261,262,263,266,267,270],{},"以我的域名 zhul.in 为例，在 Linux 下，可以通过 ",[45,264,265],{},"dig"," 命令拿到 ",[45,268,269],{},"in"," 这个 TLD 的 Nameserver",[38,272,276],{"className":273,"code":274,"language":275,"meta":43,"style":43},"language-bash shiki shiki-themes one-light one-dark-pro","dig NS in.\n","bash",[45,277,278],{"__ignoreMap":43},[48,279,280,283,287],{"class":50,"line":51},[48,281,265],{"class":282},"sAdtL",[48,284,286],{"class":285},"sDhpE"," NS",[48,288,289],{"class":285}," in.\n",[17,291,292],{},[293,294],"img",{"alt":295,"src":296},"in 的 TLD Nameservers","https://static.031130.xyz/uploads/2025/11/24/b15e97068bd75.webp",[17,298,299],{},"随后可以挑选任何一个 Nameserver（公共 DNS 服务器其实有一套基于历史性能的选择策略），直接去 ping 这个域名",[17,301,302],{},[293,303],{"alt":304,"src":305},"距离 TLD Nameserver 的延迟","https://static.031130.xyz/uploads/2025/11/24/bed48f4ed30ac.webp",[17,307,308],{},"我这里的网络环境是杭州移动，如果我在我的局域网开一台 DNS 递归服务器，这个结果就是在上面那张时序图中红色部分所需要时长的最小值（DNS 服务器还需要额外的时长去处理请求）。",[17,310,311],{},"借助一些网站提供的多个地点 ping 延迟测试，我们可以推测这个 TLD 在全球哪些国家或地区部署了 Anycast（泛播）节点，下图为 iplark.com 提供的结果。",[17,313,314],{},[293,315],{"alt":316,"src":317},"in 的 TLD Nameserver 在全球范围内的 ping 值","https://static.031130.xyz/uploads/2025/11/24/748d25e0beecc.webp",[17,319,320],{},"可以推测，in 的 TLD Nameserver 起码在日本、香港、美国、加拿大、欧洲、澳大利亚、巴西、印度、南非等多地部署了 Anycast 节点，而在中国大陆境内的延迟较高。",[322,323],"hr",{},[17,325,326],{},"作为对比，我们可以通过同样的方法再看看 cn 域名的 TLD Nameserver 的 Anycast 节点。",[17,328,329],{},[293,330],{"alt":331,"src":332},"cn 的 TLD Nameserver 在全球范围内的 ping 值","https://static.031130.xyz/uploads/2025/11/24/9751de16b460b.webp",[17,334,335],{},"经过 itdog.cn 的测试，推测 cn 域名的 TLD Nameserver 可能仅在北京有节点。",[254,337,338],{"id":338},"更进一步的的实验方案",[17,340,341],{},"上面的测试方法只是一个简易的判断方法，在现实中会有很多的外部因素影响 DNS 冷启动的解析时长：",[343,344,345,349,352,355],"ul",{},[346,347,348],"li",{},"公共 DNS 服务器和 TLD Nameserver 之间存在 peer，他们的通信非常快",[346,350,351],{},"TLD Nameserver 的性能差，需要额外的几十 ms 去处理你的请求",[346,353,354],{},"TLD 的几个 Nameserver 有快慢之分，而你选用的公共 DNS 服务器能根据历史数据选择较快的那个",[346,356,357],{},"...",[17,359,360],{},"所以，我们需要有一个基于真实的 DNS 解析请求的测试方案",[17,362,363],{},"对于 DNS 冷启动相关的测试一直以来存在一个困境——公共 DNS 服务器不归我们管，我们无法登陆上去手动清除它的缓存，因此所有的测试都只有第一次结果才可能有效，后续的请求会直接打到缓存上。但这一次我们测试的是公共 DNS 服务器到 TLD Nameserver 这一段的延迟，在 Gemini 的提醒下，我意识到可以在不同地区测试公共 DNS 对随机的、不存在的域名的解析时长，这能够反应不同 TLD 之间的差异。",[17,365,366],{},"所以，测试代码在下面，你可以使用常见的 Linux 使用 bash 执行这段代码，需要确保装有 dig 和 shasum 命令，并且推荐使用 screen / tmux 等工具挂在后台，因为整个测试过程可能会持续十几分钟。如果你所采用的网络环境在中国大陆境内，我建议你把代码中的公共 DNS 服务器换成 223.5.5.5 / 119.29.29.29 ，应该会更符合境内访客的使用环境。",[38,368,370],{"className":273,"code":369,"language":275,"meta":43,"style":43},"#!/bin/bash\n\n# ================= 配置区域 =================\n# CSV 文件名\nOUTPUT_FILE=\"dns_benchmark_results.csv\"\n\n# DNS 服务器\nDNS_SERVER=\"8.8.8.8\"\n\n# 待测试的 TLD 列表\n# 包含：全球通用(com), 国别(cn, de), 热门技术(io, xyz), 以及可能较慢的后缀\nTLDS_TO_TEST=(\"com\" \"net\" \"org\" \"cn\" \"in\" \"de\" \"cc\" \"site\" \"ai\" \"io\" \"xyz\" \"top\")\n\n# 每个 TLD 测试次数\nSAMPLES=1000\n\n# 每次查询间隔 (秒)，防止被 DNS 服务器判定为攻击\n# 1000次 * 0.1s = 100秒/TLD，总耗时约 15-20 分钟\nSLEEP_INTERVAL=0.1\n# ===========================================\n\n# 初始化 CSV 文件头\necho \"TLD,Domain,QueryTime_ms,Status,Timestamp\" > \"$OUTPUT_FILE\"\n\necho \"=============================================\"\necho \"   DNS TLD Latency Benchmark Tool\"\necho \"   Target DNS: $DNS_SERVER\"\necho \"   Samples per TLD: $SAMPLES\"\necho \"   Output File: $OUTPUT_FILE\"\necho \"=============================================\"\necho \"\"\n\n# 定义进度条函数\nfunction show_progress {\n    # 参数: $1=当前进度, $2=总数, $3=当前TLD, $4=当前平均耗时\n    let _progress=(${1}*100/${2})\n    let _done=(${_progress}*4)/10\n    let _left=40-$_done\n\n    # 构建填充字符串\n    _fill=$(printf \"%${_done}s\")\n    _empty=$(printf \"%${_left}s\")\n\n    # \\r 让光标回到行首，实现刷新效果\n    printf \"\\rProgress [${_fill// /#}${_empty// /-}] ${_progress}%% - Testing .${3} (Avg: ${4}ms) \"\n}\n\n# 主循环\nfor tld in \"${TLDS_TO_TEST[@]}\"; do\n    # 统计变量初始化\n    total_time_accum=0\n    valid_count=0\n\n    for (( i=1; i\u003C=${SAMPLES}; i++ )); do\n        # 1. 生成随机域名 (防止缓存命中)\n        # 使用 date +%N (纳秒) 确保足够随机，兼容 Linux/macOS\n        RAND_PART=$(date +%s%N | shasum | head -c 10)\n        DOMAIN=\"test-${RAND_PART}.${tld}\"\n        TIMESTAMP=$(date \"+%Y-%m-%d %H:%M:%S\")\n\n        # 2. 执行查询\n        # +tries=1 +time=2: 尝试1次，超时2秒，避免脚本卡死\n        result=$(dig @${DNS_SERVER} ${DOMAIN} A +noall +stats +time=2 +tries=1)\n\n        # 提取时间 (Query time: 12 msec)\n        query_time=$(echo \"$result\" | grep \"Query time\" | awk '{print $4}')\n        # 提取状态 (status: NXDOMAIN, NOERROR, etc.)\n        status=$(echo \"$result\" | grep \"status:\" | awk '{print $6}' | tr -d ',')\n\n        # 3. 数据清洗与记录\n        if [[ -n \"$query_time\" && \"$query_time\" =~ ^[0-9]+$ ]]; then\n            # 写入 CSV\n            echo \"${tld},${DOMAIN},${query_time},${status},${TIMESTAMP}\" >> \"$OUTPUT_FILE\"\n\n            # 更新统计\n            total_time_accum=$((total_time_accum + query_time))\n            valid_count=$((valid_count + 1))\n            current_avg=$((total_time_accum / valid_count))\n        else\n            # 记录失败/超时\n            echo \"${tld},${DOMAIN},-1,TIMEOUT,${TIMESTAMP}\" >> \"$OUTPUT_FILE\"\n            current_avg=\"N/A\"\n        fi\n\n        # 4. 显示进度条\n        show_progress $i $SAMPLES $tld $current_avg\n\n        sleep $SLEEP_INTERVAL\n    done\n\n    # 每个 TLD 完成后换行\n    echo \"\"\n    echo \"✅ Completed .${tld} | Final Avg: ${current_avg} ms\"\n    echo \"---------------------------------------------\"\ndone\n\necho \"🎉 All Done! Results saved to $OUTPUT_FILE\"\n",[45,371,372,378,382,387,392,405,409,414,424,428,433,438,488,492,497,507,511,516,521,531,536,540,545,566,570,577,584,596,608,619,625,632,636,641,653,658,681,707,718,723,729,759,784,789,795,855,861,866,872,910,916,927,937,942,985,991,997,1032,1062,1079,1084,1090,1096,1147,1152,1158,1195,1201,1246,1251,1257,1294,1300,1361,1366,1372,1395,1415,1434,1440,1446,1486,1496,1502,1507,1513,1531,1536,1545,1551,1556,1562,1570,1597,1605,1611,1616],{"__ignoreMap":43},[48,373,374],{"class":50,"line":51},[48,375,377],{"class":376},"sW2Sy","#!/bin/bash\n",[48,379,380],{"class":50,"line":57},[48,381,96],{"emptyLinePlaceholder":95},[48,383,384],{"class":50,"line":63},[48,385,386],{"class":376},"# ================= 配置区域 =================\n",[48,388,389],{"class":50,"line":69},[48,390,391],{"class":376},"# CSV 文件名\n",[48,393,394,398,402],{"class":50,"line":75},[48,395,397],{"class":396},"sJa8x","OUTPUT_FILE",[48,399,401],{"class":400},"sknuh","=",[48,403,404],{"class":285},"\"dns_benchmark_results.csv\"\n",[48,406,407],{"class":50,"line":3},[48,408,96],{"emptyLinePlaceholder":95},[48,410,411],{"class":50,"line":86},[48,412,413],{"class":376},"# DNS 服务器\n",[48,415,416,419,421],{"class":50,"line":92},[48,417,418],{"class":396},"DNS_SERVER",[48,420,401],{"class":400},[48,422,423],{"class":285},"\"8.8.8.8\"\n",[48,425,426],{"class":50,"line":99},[48,427,96],{"emptyLinePlaceholder":95},[48,429,430],{"class":50,"line":105},[48,431,432],{"class":376},"# 待测试的 TLD 列表\n",[48,434,435],{"class":50,"line":110},[48,436,437],{"class":376},"# 包含：全球通用(com), 国别(cn, de), 热门技术(io, xyz), 以及可能较慢的后缀\n",[48,439,440,443,445,449,452,455,458,461,464,467,470,473,476,479,482,485],{"class":50,"line":116},[48,441,442],{"class":396},"TLDS_TO_TEST",[48,444,401],{"class":400},[48,446,448],{"class":447},"s5ixo","(",[48,450,451],{"class":285},"\"com\"",[48,453,454],{"class":285}," \"net\"",[48,456,457],{"class":285}," \"org\"",[48,459,460],{"class":285}," \"cn\"",[48,462,463],{"class":285}," \"in\"",[48,465,466],{"class":285}," \"de\"",[48,468,469],{"class":285}," \"cc\"",[48,471,472],{"class":285}," \"site\"",[48,474,475],{"class":285}," \"ai\"",[48,477,478],{"class":285}," \"io\"",[48,480,481],{"class":285}," \"xyz\"",[48,483,484],{"class":285}," \"top\"",[48,486,487],{"class":447},")\n",[48,489,490],{"class":50,"line":122},[48,491,96],{"emptyLinePlaceholder":95},[48,493,494],{"class":50,"line":127},[48,495,496],{"class":376},"# 每个 TLD 测试次数\n",[48,498,499,502,504],{"class":50,"line":133},[48,500,501],{"class":396},"SAMPLES",[48,503,401],{"class":400},[48,505,506],{"class":285},"1000\n",[48,508,509],{"class":50,"line":139},[48,510,96],{"emptyLinePlaceholder":95},[48,512,513],{"class":50,"line":144},[48,514,515],{"class":376},"# 每次查询间隔 (秒)，防止被 DNS 服务器判定为攻击\n",[48,517,518],{"class":50,"line":150},[48,519,520],{"class":376},"# 1000次 * 0.1s = 100秒/TLD，总耗时约 15-20 分钟\n",[48,522,523,526,528],{"class":50,"line":156},[48,524,525],{"class":396},"SLEEP_INTERVAL",[48,527,401],{"class":400},[48,529,530],{"class":285},"0.1\n",[48,532,533],{"class":50,"line":162},[48,534,535],{"class":376},"# ===========================================\n",[48,537,538],{"class":50,"line":168},[48,539,96],{"emptyLinePlaceholder":95},[48,541,542],{"class":50,"line":173},[48,543,544],{"class":376},"# 初始化 CSV 文件头\n",[48,546,547,551,554,557,560,563],{"class":50,"line":179},[48,548,550],{"class":549},"s_Sar","echo",[48,552,553],{"class":285}," \"TLD,Domain,QueryTime_ms,Status,Timestamp\"",[48,555,556],{"class":447}," > ",[48,558,559],{"class":285},"\"",[48,561,562],{"class":396},"$OUTPUT_FILE",[48,564,565],{"class":285},"\"\n",[48,567,568],{"class":50,"line":184},[48,569,96],{"emptyLinePlaceholder":95},[48,571,572,574],{"class":50,"line":190},[48,573,550],{"class":549},[48,575,576],{"class":285}," \"=============================================\"\n",[48,578,579,581],{"class":50,"line":196},[48,580,550],{"class":549},[48,582,583],{"class":285}," \"   DNS TLD Latency Benchmark Tool\"\n",[48,585,586,588,591,594],{"class":50,"line":202},[48,587,550],{"class":549},[48,589,590],{"class":285}," \"   Target DNS: ",[48,592,593],{"class":396},"$DNS_SERVER",[48,595,565],{"class":285},[48,597,598,600,603,606],{"class":50,"line":207},[48,599,550],{"class":549},[48,601,602],{"class":285}," \"   Samples per TLD: ",[48,604,605],{"class":396},"$SAMPLES",[48,607,565],{"class":285},[48,609,610,612,615,617],{"class":50,"line":213},[48,611,550],{"class":549},[48,613,614],{"class":285}," \"   Output File: ",[48,616,562],{"class":396},[48,618,565],{"class":285},[48,620,621,623],{"class":50,"line":219},[48,622,550],{"class":549},[48,624,576],{"class":285},[48,626,627,629],{"class":50,"line":224},[48,628,550],{"class":549},[48,630,631],{"class":285}," \"\"\n",[48,633,634],{"class":50,"line":230},[48,635,96],{"emptyLinePlaceholder":95},[48,637,638],{"class":50,"line":235},[48,639,640],{"class":376},"# 定义进度条函数\n",[48,642,643,647,650],{"class":50,"line":241},[48,644,646],{"class":645},"sLKXg","function",[48,648,649],{"class":282}," show_progress",[48,651,652],{"class":447}," {\n",[48,654,655],{"class":50,"line":246},[48,656,657],{"class":376},"    # 参数: $1=当前进度, $2=总数, $3=当前TLD, $4=当前平均耗时\n",[48,659,661,664,667,669,673,676,679],{"class":50,"line":660},36,[48,662,663],{"class":549},"    let",[48,665,666],{"class":285}," _progress=",[48,668,448],{"class":447},[48,670,672],{"class":671},"s8iYz","${1}",[48,674,675],{"class":447},"*100/",[48,677,678],{"class":671},"${2}",[48,680,487],{"class":447},[48,682,684,686,689,691,695,698,701,704],{"class":50,"line":683},37,[48,685,663],{"class":549},[48,687,688],{"class":285}," _done=",[48,690,448],{"class":447},[48,692,694],{"class":693},"sr1Ac","${",[48,696,697],{"class":396},"_progress",[48,699,700],{"class":693},"}",[48,702,703],{"class":447},"*4)",[48,705,706],{"class":285},"/10\n",[48,708,710,712,715],{"class":50,"line":709},38,[48,711,663],{"class":549},[48,713,714],{"class":285}," _left=40-",[48,716,717],{"class":396},"$_done\n",[48,719,721],{"class":50,"line":720},39,[48,722,96],{"emptyLinePlaceholder":95},[48,724,726],{"class":50,"line":725},40,[48,727,728],{"class":376},"    # 构建填充字符串\n",[48,730,732,735,737,740,743,746,749,752,754,757],{"class":50,"line":731},41,[48,733,734],{"class":396},"    _fill",[48,736,401],{"class":400},[48,738,739],{"class":447},"$(",[48,741,742],{"class":549},"printf",[48,744,745],{"class":285}," \"%",[48,747,694],{"class":748},"sTIpt",[48,750,751],{"class":396},"_done",[48,753,700],{"class":748},[48,755,756],{"class":285},"s\"",[48,758,487],{"class":447},[48,760,762,765,767,769,771,773,775,778,780,782],{"class":50,"line":761},42,[48,763,764],{"class":396},"    _empty",[48,766,401],{"class":400},[48,768,739],{"class":447},[48,770,742],{"class":549},[48,772,745],{"class":285},[48,774,694],{"class":748},[48,776,777],{"class":396},"_left",[48,779,700],{"class":748},[48,781,756],{"class":285},[48,783,487],{"class":447},[48,785,787],{"class":50,"line":786},43,[48,788,96],{"emptyLinePlaceholder":95},[48,790,792],{"class":50,"line":791},44,[48,793,794],{"class":376},"    # \\r 让光标回到行首，实现刷新效果\n",[48,796,798,801,804,806,809,812,815,818,821,823,826,829,831,834,836,838,840,843,846,849,852],{"class":50,"line":797},45,[48,799,800],{"class":549},"    printf",[48,802,803],{"class":285}," \"\\rProgress [",[48,805,694],{"class":748},[48,807,808],{"class":396},"_fill",[48,810,811],{"class":447},"//",[48,813,814],{"class":447}," /#",[48,816,817],{"class":748},"}${",[48,819,820],{"class":396},"_empty",[48,822,811],{"class":447},[48,824,825],{"class":447}," /",[48,827,828],{"class":396},"-",[48,830,700],{"class":748},[48,832,833],{"class":285},"] ",[48,835,694],{"class":748},[48,837,697],{"class":396},[48,839,700],{"class":748},[48,841,842],{"class":285},"%% - Testing .",[48,844,845],{"class":671},"${3}",[48,847,848],{"class":285}," (Avg: ",[48,850,851],{"class":671},"${4}",[48,853,854],{"class":285},"ms) \"\n",[48,856,858],{"class":50,"line":857},46,[48,859,860],{"class":447},"}\n",[48,862,864],{"class":50,"line":863},47,[48,865,96],{"emptyLinePlaceholder":95},[48,867,869],{"class":50,"line":868},48,[48,870,871],{"class":376},"# 主循环\n",[48,873,875,878,881,884,887,889,891,894,897,900,902,904,907],{"class":50,"line":874},49,[48,876,877],{"class":645},"for",[48,879,880],{"class":396}," tld",[48,882,883],{"class":645}," in",[48,885,886],{"class":285}," \"",[48,888,694],{"class":748},[48,890,442],{"class":396},[48,892,893],{"class":285},"[",[48,895,896],{"class":447},"@",[48,898,899],{"class":285},"]",[48,901,700],{"class":748},[48,903,559],{"class":285},[48,905,906],{"class":447},"; ",[48,908,909],{"class":645},"do\n",[48,911,913],{"class":50,"line":912},50,[48,914,915],{"class":376},"    # 统计变量初始化\n",[48,917,919,922,924],{"class":50,"line":918},51,[48,920,921],{"class":396},"    total_time_accum",[48,923,401],{"class":400},[48,925,926],{"class":285},"0\n",[48,928,930,933,935],{"class":50,"line":929},52,[48,931,932],{"class":396},"    valid_count",[48,934,401],{"class":400},[48,936,926],{"class":285},[48,938,940],{"class":50,"line":939},53,[48,941,96],{"emptyLinePlaceholder":95},[48,943,945,948,951,954,956,960,962,964,967,969,971,973,975,977,980,983],{"class":50,"line":944},54,[48,946,947],{"class":645},"    for",[48,949,950],{"class":447}," (( ",[48,952,953],{"class":396},"i",[48,955,401],{"class":400},[48,957,959],{"class":958},"sAGMh","1",[48,961,906],{"class":447},[48,963,953],{"class":396},[48,965,966],{"class":400},"\u003C=",[48,968,694],{"class":693},[48,970,501],{"class":396},[48,972,700],{"class":693},[48,974,906],{"class":447},[48,976,953],{"class":396},[48,978,979],{"class":400},"++",[48,981,982],{"class":447}," )); ",[48,984,909],{"class":645},[48,986,988],{"class":50,"line":987},55,[48,989,990],{"class":376},"        # 1. 生成随机域名 (防止缓存命中)\n",[48,992,994],{"class":50,"line":993},56,[48,995,996],{"class":376},"        # 使用 date +%N (纳秒) 确保足够随机，兼容 Linux/macOS\n",[48,998,1000,1003,1005,1007,1010,1013,1016,1019,1021,1024,1027,1030],{"class":50,"line":999},57,[48,1001,1002],{"class":396},"        RAND_PART",[48,1004,401],{"class":400},[48,1006,739],{"class":447},[48,1008,1009],{"class":282},"date",[48,1011,1012],{"class":285}," +%s%N",[48,1014,1015],{"class":447}," | ",[48,1017,1018],{"class":282},"shasum",[48,1020,1015],{"class":447},[48,1022,1023],{"class":282},"head",[48,1025,1026],{"class":958}," -c",[48,1028,1029],{"class":958}," 10",[48,1031,487],{"class":447},[48,1033,1035,1038,1040,1043,1045,1048,1050,1053,1055,1058,1060],{"class":50,"line":1034},58,[48,1036,1037],{"class":396},"        DOMAIN",[48,1039,401],{"class":400},[48,1041,1042],{"class":285},"\"test-",[48,1044,694],{"class":748},[48,1046,1047],{"class":396},"RAND_PART",[48,1049,700],{"class":748},[48,1051,1052],{"class":285},".",[48,1054,694],{"class":748},[48,1056,1057],{"class":396},"tld",[48,1059,700],{"class":748},[48,1061,565],{"class":285},[48,1063,1065,1068,1070,1072,1074,1077],{"class":50,"line":1064},59,[48,1066,1067],{"class":396},"        TIMESTAMP",[48,1069,401],{"class":400},[48,1071,739],{"class":447},[48,1073,1009],{"class":282},[48,1075,1076],{"class":285}," \"+%Y-%m-%d %H:%M:%S\"",[48,1078,487],{"class":447},[48,1080,1082],{"class":50,"line":1081},60,[48,1083,96],{"emptyLinePlaceholder":95},[48,1085,1087],{"class":50,"line":1086},61,[48,1088,1089],{"class":376},"        # 2. 执行查询\n",[48,1091,1093],{"class":50,"line":1092},62,[48,1094,1095],{"class":376},"        # +tries=1 +time=2: 尝试1次，超时2秒，避免脚本卡死\n",[48,1097,1099,1102,1104,1106,1108,1111,1113,1115,1117,1120,1123,1125,1128,1131,1134,1137,1140,1143,1145],{"class":50,"line":1098},63,[48,1100,1101],{"class":396},"        result",[48,1103,401],{"class":400},[48,1105,739],{"class":447},[48,1107,265],{"class":282},[48,1109,1110],{"class":285}," @",[48,1112,694],{"class":693},[48,1114,418],{"class":396},[48,1116,700],{"class":693},[48,1118,1119],{"class":693}," ${",[48,1121,1122],{"class":396},"DOMAIN",[48,1124,700],{"class":693},[48,1126,1127],{"class":285}," A",[48,1129,1130],{"class":285}," +noall",[48,1132,1133],{"class":285}," +stats",[48,1135,1136],{"class":285}," +time=",[48,1138,1139],{"class":958},"2",[48,1141,1142],{"class":285}," +tries=",[48,1144,959],{"class":958},[48,1146,487],{"class":447},[48,1148,1150],{"class":50,"line":1149},64,[48,1151,96],{"emptyLinePlaceholder":95},[48,1153,1155],{"class":50,"line":1154},65,[48,1156,1157],{"class":376},"        # 提取时间 (Query time: 12 msec)\n",[48,1159,1161,1164,1166,1168,1170,1172,1175,1177,1179,1182,1185,1187,1190,1193],{"class":50,"line":1160},66,[48,1162,1163],{"class":396},"        query_time",[48,1165,401],{"class":400},[48,1167,739],{"class":447},[48,1169,550],{"class":549},[48,1171,886],{"class":285},[48,1173,1174],{"class":396},"$result",[48,1176,559],{"class":285},[48,1178,1015],{"class":447},[48,1180,1181],{"class":282},"grep",[48,1183,1184],{"class":285}," \"Query time\"",[48,1186,1015],{"class":447},[48,1188,1189],{"class":282},"awk",[48,1191,1192],{"class":285}," '{print $4}'",[48,1194,487],{"class":447},[48,1196,1198],{"class":50,"line":1197},67,[48,1199,1200],{"class":376},"        # 提取状态 (status: NXDOMAIN, NOERROR, etc.)\n",[48,1202,1204,1207,1209,1211,1213,1215,1217,1219,1221,1223,1226,1228,1230,1233,1235,1238,1241,1244],{"class":50,"line":1203},68,[48,1205,1206],{"class":396},"        status",[48,1208,401],{"class":400},[48,1210,739],{"class":447},[48,1212,550],{"class":549},[48,1214,886],{"class":285},[48,1216,1174],{"class":396},[48,1218,559],{"class":285},[48,1220,1015],{"class":447},[48,1222,1181],{"class":282},[48,1224,1225],{"class":285}," \"status:\"",[48,1227,1015],{"class":447},[48,1229,1189],{"class":282},[48,1231,1232],{"class":285}," '{print $6}'",[48,1234,1015],{"class":447},[48,1236,1237],{"class":282},"tr",[48,1239,1240],{"class":958}," -d",[48,1242,1243],{"class":285}," ','",[48,1245,487],{"class":447},[48,1247,1249],{"class":50,"line":1248},69,[48,1250,96],{"emptyLinePlaceholder":95},[48,1252,1254],{"class":50,"line":1253},70,[48,1255,1256],{"class":376},"        # 3. 数据清洗与记录\n",[48,1258,1260,1263,1266,1269,1271,1274,1276,1279,1281,1283,1285,1288,1291],{"class":50,"line":1259},71,[48,1261,1262],{"class":645},"        if",[48,1264,1265],{"class":447}," [[ ",[48,1267,1268],{"class":400},"-n",[48,1270,886],{"class":285},[48,1272,1273],{"class":396},"$query_time",[48,1275,559],{"class":285},[48,1277,1278],{"class":400}," &&",[48,1280,886],{"class":285},[48,1282,1273],{"class":396},[48,1284,559],{"class":285},[48,1286,1287],{"class":400}," =~",[48,1289,1290],{"class":447}," ^[0-9]+$ ]]; ",[48,1292,1293],{"class":645},"then\n",[48,1295,1297],{"class":50,"line":1296},72,[48,1298,1299],{"class":376},"            # 写入 CSV\n",[48,1301,1303,1306,1308,1310,1312,1314,1317,1319,1321,1323,1325,1327,1330,1332,1334,1336,1339,1341,1343,1345,1348,1350,1352,1355,1357,1359],{"class":50,"line":1302},73,[48,1304,1305],{"class":549},"            echo",[48,1307,886],{"class":285},[48,1309,694],{"class":748},[48,1311,1057],{"class":396},[48,1313,700],{"class":748},[48,1315,1316],{"class":285},",",[48,1318,694],{"class":748},[48,1320,1122],{"class":396},[48,1322,700],{"class":748},[48,1324,1316],{"class":285},[48,1326,694],{"class":748},[48,1328,1329],{"class":396},"query_time",[48,1331,700],{"class":748},[48,1333,1316],{"class":285},[48,1335,694],{"class":748},[48,1337,1338],{"class":396},"status",[48,1340,700],{"class":748},[48,1342,1316],{"class":285},[48,1344,694],{"class":748},[48,1346,1347],{"class":396},"TIMESTAMP",[48,1349,700],{"class":748},[48,1351,559],{"class":285},[48,1353,1354],{"class":447}," >> ",[48,1356,559],{"class":285},[48,1358,562],{"class":396},[48,1360,565],{"class":285},[48,1362,1364],{"class":50,"line":1363},74,[48,1365,96],{"emptyLinePlaceholder":95},[48,1367,1369],{"class":50,"line":1368},75,[48,1370,1371],{"class":376},"            # 更新统计\n",[48,1373,1375,1378,1380,1383,1386,1389,1392],{"class":50,"line":1374},76,[48,1376,1377],{"class":396},"            total_time_accum",[48,1379,401],{"class":400},[48,1381,1382],{"class":447},"$((",[48,1384,1385],{"class":282},"total_time_accum",[48,1387,1388],{"class":285}," +",[48,1390,1391],{"class":285}," query_time",[48,1393,1394],{"class":447},"))\n",[48,1396,1398,1401,1403,1405,1408,1410,1413],{"class":50,"line":1397},77,[48,1399,1400],{"class":396},"            valid_count",[48,1402,401],{"class":400},[48,1404,1382],{"class":447},[48,1406,1407],{"class":282},"valid_count",[48,1409,1388],{"class":285},[48,1411,1412],{"class":958}," 1",[48,1414,1394],{"class":447},[48,1416,1418,1421,1423,1425,1427,1429,1432],{"class":50,"line":1417},78,[48,1419,1420],{"class":396},"            current_avg",[48,1422,401],{"class":400},[48,1424,1382],{"class":447},[48,1426,1385],{"class":282},[48,1428,825],{"class":285},[48,1430,1431],{"class":285}," valid_count",[48,1433,1394],{"class":447},[48,1435,1437],{"class":50,"line":1436},79,[48,1438,1439],{"class":645},"        else\n",[48,1441,1443],{"class":50,"line":1442},80,[48,1444,1445],{"class":376},"            # 记录失败/超时\n",[48,1447,1449,1451,1453,1455,1457,1459,1461,1463,1465,1467,1470,1472,1474,1476,1478,1480,1482,1484],{"class":50,"line":1448},81,[48,1450,1305],{"class":549},[48,1452,886],{"class":285},[48,1454,694],{"class":748},[48,1456,1057],{"class":396},[48,1458,700],{"class":748},[48,1460,1316],{"class":285},[48,1462,694],{"class":748},[48,1464,1122],{"class":396},[48,1466,700],{"class":748},[48,1468,1469],{"class":285},",-1,TIMEOUT,",[48,1471,694],{"class":748},[48,1473,1347],{"class":396},[48,1475,700],{"class":748},[48,1477,559],{"class":285},[48,1479,1354],{"class":447},[48,1481,559],{"class":285},[48,1483,562],{"class":396},[48,1485,565],{"class":285},[48,1487,1489,1491,1493],{"class":50,"line":1488},82,[48,1490,1420],{"class":396},[48,1492,401],{"class":400},[48,1494,1495],{"class":285},"\"N/A\"\n",[48,1497,1499],{"class":50,"line":1498},83,[48,1500,1501],{"class":645},"        fi\n",[48,1503,1505],{"class":50,"line":1504},84,[48,1506,96],{"emptyLinePlaceholder":95},[48,1508,1510],{"class":50,"line":1509},85,[48,1511,1512],{"class":376},"        # 4. 显示进度条\n",[48,1514,1516,1519,1522,1525,1528],{"class":50,"line":1515},86,[48,1517,1518],{"class":282},"        show_progress",[48,1520,1521],{"class":396}," $i",[48,1523,1524],{"class":396}," $SAMPLES",[48,1526,1527],{"class":396}," $tld",[48,1529,1530],{"class":396}," $current_avg\n",[48,1532,1534],{"class":50,"line":1533},87,[48,1535,96],{"emptyLinePlaceholder":95},[48,1537,1539,1542],{"class":50,"line":1538},88,[48,1540,1541],{"class":282},"        sleep",[48,1543,1544],{"class":396}," $SLEEP_INTERVAL\n",[48,1546,1548],{"class":50,"line":1547},89,[48,1549,1550],{"class":645},"    done\n",[48,1552,1554],{"class":50,"line":1553},90,[48,1555,96],{"emptyLinePlaceholder":95},[48,1557,1559],{"class":50,"line":1558},91,[48,1560,1561],{"class":376},"    # 每个 TLD 完成后换行\n",[48,1563,1565,1568],{"class":50,"line":1564},92,[48,1566,1567],{"class":549},"    echo",[48,1569,631],{"class":285},[48,1571,1573,1575,1578,1580,1582,1584,1587,1589,1592,1594],{"class":50,"line":1572},93,[48,1574,1567],{"class":549},[48,1576,1577],{"class":285}," \"✅ Completed .",[48,1579,694],{"class":748},[48,1581,1057],{"class":396},[48,1583,700],{"class":748},[48,1585,1586],{"class":285}," | Final Avg: ",[48,1588,694],{"class":748},[48,1590,1591],{"class":396},"current_avg",[48,1593,700],{"class":748},[48,1595,1596],{"class":285}," ms\"\n",[48,1598,1600,1602],{"class":50,"line":1599},94,[48,1601,1567],{"class":549},[48,1603,1604],{"class":285}," \"---------------------------------------------\"\n",[48,1606,1608],{"class":50,"line":1607},95,[48,1609,1610],{"class":645},"done\n",[48,1612,1614],{"class":50,"line":1613},96,[48,1615,96],{"emptyLinePlaceholder":95},[48,1617,1619,1621,1624,1626],{"class":50,"line":1618},97,[48,1620,550],{"class":549},[48,1622,1623],{"class":285}," \"🎉 All Done! Results saved to ",[48,1625,562],{"class":396},[48,1627,565],{"class":285},[254,1629,1630],{"id":1630},"测试结果",[17,1632,1633],{},[27,1634,1635],{},"免责声明：以下测试结果仅供参考，不构成任何购买推荐，且仅代表测试当日（2025.11.24）的网络情况，后续不会进行跟进。DNS 冷启动对于大型站点几乎没有影响，仅小站需要关注。本次测试中，所有境内检测点使用 223.5.5.5 作为 DNS 服务器，境外检测点使用 8.8.8.8。",[1637,1638,1639,1684],"table",{},[1640,1641,1642],"thead",{},[1237,1643,1644,1648,1651,1654,1657,1660,1663,1666,1669,1672,1675,1678,1681],{},[1645,1646,1647],"th",{},"测试点/延迟（ms）",[1645,1649,1650],{},".com",[1645,1652,1653],{},".net",[1645,1655,1656],{},".org",[1645,1658,1659],{},".cn",[1645,1661,1662],{},".in",[1645,1664,1665],{},".de",[1645,1667,1668],{},".cc",[1645,1670,1671],{},".site",[1645,1673,1674],{},".ai",[1645,1676,1677],{},".io",[1645,1679,1680],{},".xyz",[1645,1682,1683],{},".top",[1685,1686,1687,1729,1770,1809,1850,1887,1921,1957,1991],"tbody",{},[1237,1688,1689,1693,1696,1699,1702,1705,1708,1711,1714,1717,1720,1723,1726],{},[1690,1691,1692],"td",{},"🇨🇳 上海腾讯云",[1690,1694,1695],{},"438",[1690,1697,1698],{},"429",[1690,1700,1701],{},"470",[1690,1703,1704],{},"30",[1690,1706,1707],{},"535",[1690,1709,1710],{},"353",[1690,1712,1713],{},"476",[1690,1715,1716],{},"454",[1690,1718,1719],{},"367",[1690,1721,1722],{},"485",[1690,1724,1725],{},"444",[1690,1727,1728],{},"43",[1237,1730,1731,1734,1737,1740,1743,1746,1749,1752,1755,1758,1761,1764,1767],{},[1690,1732,1733],{},"🇨🇳 北京腾讯云",[1690,1735,1736],{},"425",[1690,1738,1739],{},"443",[1690,1741,1742],{},"469",[1690,1744,1745],{},"17",[1690,1747,1748],{},"350",[1690,1750,1751],{},"420",[1690,1753,1754],{},"466",[1690,1756,1757],{},"647",[1690,1759,1760],{},"582",[1690,1762,1763],{},"461",[1690,1765,1766],{},"559",[1690,1768,1769],{},"9",[1237,1771,1772,1775,1778,1780,1783,1786,1789,1792,1795,1797,1800,1803,1806],{},[1690,1773,1774],{},"🇭🇰 香港 Yxvm",[1690,1776,1777],{},"75",[1690,1779,1777],{},[1690,1781,1782],{},"363",[1690,1784,1785],{},"227",[1690,1787,1788],{},"6",[1690,1790,1791],{},"11",[1690,1793,1794],{},"61",[1690,1796,1788],{},[1690,1798,1799],{},"33",[1690,1801,1802],{},"126",[1690,1804,1805],{},"5",[1690,1807,1808],{},"7",[1237,1810,1811,1814,1817,1820,1823,1826,1829,1832,1835,1838,1841,1844,1847],{},[1690,1812,1813],{},"🇨🇳 彰化(台湾) Hinet",[1690,1815,1816],{},"90",[1690,1818,1819],{},"87",[1690,1821,1822],{},"128",[1690,1824,1825],{},"213",[1690,1827,1828],{},"59",[1690,1830,1831],{},"38",[1690,1833,1834],{},"76",[1690,1836,1837],{},"37",[1690,1839,1840],{},"73",[1690,1842,1843],{},"94",[1690,1845,1846],{},"36",[1690,1848,1849],{},"47",[1237,1851,1852,1855,1858,1861,1864,1867,1870,1873,1875,1878,1880,1883,1885],{},[1690,1853,1854],{},"🇯🇵 大阪 Vmiss",[1690,1856,1857],{},"20",[1690,1859,1860],{},"19",[1690,1862,1863],{},"244",[1690,1865,1866],{},"309",[1690,1868,1869],{},"15",[1690,1871,1872],{},"24",[1690,1874,1745],{},[1690,1876,1877],{},"35",[1690,1879,1860],{},[1690,1881,1882],{},"65",[1690,1884,1837],{},[1690,1886,1816],{},[1237,1888,1889,1892,1894,1896,1899,1902,1904,1907,1909,1911,1913,1916,1918],{},[1690,1890,1891],{},"🇸🇬 新加坡 Wap",[1690,1893,1788],{},[1690,1895,1769],{},[1690,1897,1898],{},"139",[1690,1900,1901],{},"398",[1690,1903,1788],{},[1690,1905,1906],{},"10",[1690,1908,1808],{},[1690,1910,1745],{},[1690,1912,1808],{},[1690,1914,1915],{},"110",[1690,1917,1745],{},[1690,1919,1920],{},"66",[1237,1922,1923,1926,1928,1930,1933,1936,1939,1942,1944,1947,1949,1952,1954],{},[1690,1924,1925],{},"🇺🇸 洛杉矶 ColoCrossing",[1690,1927,1808],{},[1690,1929,1808],{},[1690,1931,1932],{},"307",[1690,1934,1935],{},"137",[1690,1937,1938],{},"4",[1690,1940,1941],{},"64",[1690,1943,1805],{},[1690,1945,1946],{},"62",[1690,1948,1805],{},[1690,1950,1951],{},"49",[1690,1953,1849],{},[1690,1955,1956],{},"231",[1237,1958,1959,1962,1965,1967,1970,1973,1975,1977,1980,1982,1984,1986,1988],{},[1690,1960,1961],{},"🇩🇪 杜塞尔多夫 WIIT AG",[1690,1963,1964],{},"16",[1690,1966,1745],{},[1690,1968,1969],{},"288",[1690,1971,1972],{},"82",[1690,1974,1777],{},[1690,1976,1869],{},[1690,1978,1979],{},"14",[1690,1981,1872],{},[1690,1983,1920],{},[1690,1985,1840],{},[1690,1987,1872],{},[1690,1989,1990],{},"306",[1237,1992,1993,1996,1998,2001,2004,2007,2009,2012,2015,2017,2019,2021,2023],{},[1690,1994,1995],{},"🇦🇺 悉尼 Oracle",[1690,1997,1799],{},[1690,1999,2000],{},"31",[1690,2002,2003],{},"12",[1690,2005,2006],{},"338",[1690,2008,1808],{},[1690,2010,2011],{},"13",[1690,2013,2014],{},"121",[1690,2016,1808],{},[1690,2018,1906],{},[1690,2020,1769],{},[1690,2022,1808],{},[1690,2024,2025],{},"191",[17,2027,2028],{},"通过上面的数据，我们可以看到 .cn 和 .top 是所有测试的域名后缀中在中国大陆境内解析速度最快的，但选择 .cn 和 .top 意味着你需要牺牲其他地区访客的解析速度。而像 .com、.net、.org 这些通用的域名后缀在全球绝大部分地区表现良好，而在中国大陆境内的解析速度则相对较慢，因为他们没有在大陆境内部署 Anycast 节点。",[17,2030,2031,2032,2038],{},"经 v2ex 的网友 ",[21,2033,2037],{"href":2034,"rel":2035},"https://www.v2ex.com/member/Showfom",[2036],"nofollow","Showfom"," 提醒，GoDaddy 作为注册局掌握的部分 TLD 的 Nameserver 同样在中国大路境内拥有 Anycast 节点，比如 .one、.tv 等，具体可自行查询验证。",[17,2040,2041,2042,2047],{},"你可以点击",[21,2043,2046],{"href":2044,"rel":2045},"https://static.031130.xyz/bin/dns_benchmark_results_20251124.tar.zst",[2036],"这里","下载完整的测试结果 CSV 文件进行进一步的分析。",[2049,2050,2051],"style",{},"html .default .shiki span {color: var(--shiki-default);background: var(--shiki-default-bg);font-style: var(--shiki-default-font-style);font-weight: var(--shiki-default-font-weight);text-decoration: var(--shiki-default-text-decoration);}html .shiki span {color: var(--shiki-default);background: var(--shiki-default-bg);font-style: var(--shiki-default-font-style);font-weight: var(--shiki-default-font-weight);text-decoration: var(--shiki-default-text-decoration);}html .dark .shiki span {color: var(--shiki-dark);background: var(--shiki-dark-bg);font-style: var(--shiki-dark-font-style);font-weight: var(--shiki-dark-font-weight);text-decoration: var(--shiki-dark-text-decoration);}html.dark .shiki span {color: var(--shiki-dark);background: var(--shiki-dark-bg);font-style: var(--shiki-dark-font-style);font-weight: var(--shiki-dark-font-weight);text-decoration: var(--shiki-dark-text-decoration);}html pre.shiki code .sAdtL, html code.shiki .sAdtL{--shiki-default:#4078F2;--shiki-dark:#61AFEF}html pre.shiki code .sDhpE, html code.shiki .sDhpE{--shiki-default:#50A14F;--shiki-dark:#98C379}html pre.shiki code .sW2Sy, html code.shiki .sW2Sy{--shiki-default:#A0A1A7;--shiki-default-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic}html pre.shiki code .sJa8x, html code.shiki .sJa8x{--shiki-default:#E45649;--shiki-dark:#E06C75}html pre.shiki code .sknuh, html code.shiki .sknuh{--shiki-default:#383A42;--shiki-dark:#56B6C2}html pre.shiki code .s5ixo, html code.shiki .s5ixo{--shiki-default:#383A42;--shiki-dark:#ABB2BF}html pre.shiki code .s_Sar, html code.shiki .s_Sar{--shiki-default:#0184BC;--shiki-dark:#56B6C2}html pre.shiki code .sLKXg, html code.shiki .sLKXg{--shiki-default:#A626A4;--shiki-dark:#C678DD}html pre.shiki code .s8iYz, html code.shiki .s8iYz{--shiki-default:#383A42;--shiki-default-font-style:inherit;--shiki-dark:#E06C75;--shiki-dark-font-style:italic}html pre.shiki code .sr1Ac, html code.shiki .sr1Ac{--shiki-default:#E45649;--shiki-dark:#ABB2BF}html pre.shiki code .sTIpt, html code.shiki .sTIpt{--shiki-default:#E45649;--shiki-dark:#98C379}html pre.shiki code .sAGMh, html code.shiki .sAGMh{--shiki-default:#986801;--shiki-dark:#D19A66}",{"title":43,"searchDepth":57,"depth":57,"links":2053},[2054,2055,2056],{"id":256,"depth":57,"text":256},{"id":338,"depth":57,"text":338},{"id":1630,"depth":57,"text":1630},{"title":2058,"date":2059,"path":2060,"tags":2061,"body":2062},"DNS 冷启动：小型站点的“西西弗斯之石”","2025-11-11","/2025/11/11/dns-cold-start-dilemma",[12,11],{"type":14,"value":2063,"toc":2386},[2064,2067,2071,2074,2110,2237,2248,2252,2255,2258,2261,2264,2267,2281,2284,2287,2291,2294,2297,2311,2316,2320,2323,2328,2331,2334,2337,2341,2344,2347,2354,2358,2361,2364,2367,2383],[17,2065,2066],{},"当我们谈论网站性能时，我们通常关注前端渲染、资源懒加载、服务器响应时间（TTFB）等。然而，在用户浏览器真正开始请求内容之前，有一个至关重要却鲜少在性能优化方面被提及的部分—— DNS 解析。对于默默无闻的小型站点而言，“DNS Cache Miss”（缓存未命中）或我称之为“DNS 冷启动”，会成为绕不过去的性能瓶颈，也就是本文标题所提到的“西西弗斯之石”。",[254,2068,2070],{"id":2069},"神话的隐喻dns-解析的漫长旅程","神话的隐喻：DNS 解析的漫长旅程",[17,2072,2073],{},"要理解这块“石头”的重量，我们必须重温 DNS 解析的完整路径。这并非一次简单的查找，而是一场跨越全球的接力赛：",[2075,2076,2077,2083,2089,2098,2104],"ol",{},[346,2078,2079,2082],{},[27,2080,2081],{},"起点：公共 DNS 服务器"," — 用户发出请求，公共 DNS 服务器尝试在缓存中寻找答案。",[346,2084,2085,2088],{},[27,2086,2087],{},"首次“推石”：根服务器"," — 缓存缺失（Cache Miss），公共 DNS 服务器被引向全球 13 组根服务器。",[346,2090,2091,2094,2095,2097],{},[27,2092,2093],{},"第二程：TLD 服务器"," — 根服务器指向特定后缀（如 ",[45,2096,1650],{},"）的顶级域名服务器。",[346,2099,2100,2103],{},[27,2101,2102],{},"第三程：权威服务器"," — TLD 服务器指向网站域名最终的“管家”——权威 DNS 服务器。",[346,2105,2106,2109],{},[27,2107,2108],{},"终点："," 权威服务器返回最终的 IP 地址，再由公共 DNS 服务器返回给用户。",[38,2111,2113],{"className":40,"code":2112,"language":42,"meta":43,"style":43},"sequenceDiagram\n    participant User as 用户/浏览器\n    participant Local as 本地DNS\u003Cbr>递归解析器\n    participant Root as 根域名服务器\n    participant TLD as 顶级域服务器\u003Cbr>(.com, .org等)\n    participant Auth as 权威DNS服务器\n\n    Note over User,Auth: DNS递归查询完整流程\n\n    User->>Local: 1. 查询域名\u003Cbr>www.example.com\n    Note over Local: 检查缓存\u003Cbr>未找到记录\n\n    Local->>Root: 2. 查询 .com 的TLD服务器\n    Root-->>Local: 3. 返回 .com TLD服务器地址\n\n    Local->>TLD: 4. 查询 example.com 的权威服务器\n    TLD-->>Local: 5. 返回 example.com 的权威服务器地址\n\n    Local->>Auth: 6. 查询 www.example.com 的A记录\n    Auth-->>Local: 7. 返回 IP地址 (e.g., 1.1.1.1)\n\n    Note over Local: 缓存结果\u003Cbr>(根据TTL设置)\n\n    Local-->>User: 8. 返回最终IP地址\n\n    Note over User,Auth: 后续流程\n    User->>Auth: 9. 使用IP地址建立TCP连接\u003Cbr>开始HTTP请求\n",[45,2114,2115,2119,2123,2127,2131,2136,2140,2144,2149,2153,2158,2163,2167,2172,2177,2181,2186,2191,2195,2200,2205,2209,2214,2218,2223,2227,2232],{"__ignoreMap":43},[48,2116,2117],{"class":50,"line":51},[48,2118,54],{},[48,2120,2121],{"class":50,"line":57},[48,2122,66],{},[48,2124,2125],{"class":50,"line":63},[48,2126,72],{},[48,2128,2129],{"class":50,"line":69},[48,2130,78],{},[48,2132,2133],{"class":50,"line":75},[48,2134,2135],{},"    participant TLD as 顶级域服务器\u003Cbr>(.com, .org等)\n",[48,2137,2138],{"class":50,"line":3},[48,2139,89],{},[48,2141,2142],{"class":50,"line":86},[48,2143,96],{"emptyLinePlaceholder":95},[48,2145,2146],{"class":50,"line":92},[48,2147,2148],{},"    Note over User,Auth: DNS递归查询完整流程\n",[48,2150,2151],{"class":50,"line":99},[48,2152,96],{"emptyLinePlaceholder":95},[48,2154,2155],{"class":50,"line":105},[48,2156,2157],{},"    User->>Local: 1. 查询域名\u003Cbr>www.example.com\n",[48,2159,2160],{"class":50,"line":110},[48,2161,2162],{},"    Note over Local: 检查缓存\u003Cbr>未找到记录\n",[48,2164,2165],{"class":50,"line":116},[48,2166,96],{"emptyLinePlaceholder":95},[48,2168,2169],{"class":50,"line":122},[48,2170,2171],{},"    Local->>Root: 2. 查询 .com 的TLD服务器\n",[48,2173,2174],{"class":50,"line":127},[48,2175,2176],{},"    Root-->>Local: 3. 返回 .com TLD服务器地址\n",[48,2178,2179],{"class":50,"line":133},[48,2180,96],{"emptyLinePlaceholder":95},[48,2182,2183],{"class":50,"line":139},[48,2184,2185],{},"    Local->>TLD: 4. 查询 example.com 的权威服务器\n",[48,2187,2188],{"class":50,"line":144},[48,2189,2190],{},"    TLD-->>Local: 5. 返回 example.com 的权威服务器地址\n",[48,2192,2193],{"class":50,"line":150},[48,2194,96],{"emptyLinePlaceholder":95},[48,2196,2197],{"class":50,"line":156},[48,2198,2199],{},"    Local->>Auth: 6. 查询 www.example.com 的A记录\n",[48,2201,2202],{"class":50,"line":162},[48,2203,2204],{},"    Auth-->>Local: 7. 返回 IP地址 (e.g., 1.1.1.1)\n",[48,2206,2207],{"class":50,"line":168},[48,2208,96],{"emptyLinePlaceholder":95},[48,2210,2211],{"class":50,"line":173},[48,2212,2213],{},"    Note over Local: 缓存结果\u003Cbr>(根据TTL设置)\n",[48,2215,2216],{"class":50,"line":179},[48,2217,96],{"emptyLinePlaceholder":95},[48,2219,2220],{"class":50,"line":184},[48,2221,2222],{},"    Local-->>User: 8. 返回最终IP地址\n",[48,2224,2225],{"class":50,"line":190},[48,2226,96],{"emptyLinePlaceholder":95},[48,2228,2229],{"class":50,"line":196},[48,2230,2231],{},"    Note over User,Auth: 后续流程\n",[48,2233,2234],{"class":50,"line":202},[48,2235,2236],{},"    User->>Auth: 9. 使用IP地址建立TCP连接\u003Cbr>开始HTTP请求\n",[17,2238,2239,2240,2243,2244,2247],{},"对于",[27,2241,2242],{},"首次","或",[27,2245,2246],{},"长时间未访问","的请求，这个过程意味着至少 4 次网络往返（RTT），而在涉及到 CNAME 等情况时则会更多。对于那些拥有完美缓存的大型网站来说，这块石头可能已被别人推到了山顶；但对小型站点，它总是在山脚等待它的西西弗斯。",[254,2249,2251],{"id":2250},"多重世界anycast-的镜像迷宫","多重世界：Anycast 的镜像迷宫",[17,2253,2254],{},"“既然 DNS 冷启动的代价如此之高，那我能否使用脚本定时访问自己的网站，提前让公共 DNS 缓存预热起来呢？”——这是我曾经设想的解题思路。",[17,2256,2257],{},"然而，这一思路在现代互联网的 Anycast（泛播）架构下，往往徒劳无功。",[17,2259,2260],{},"Anycast 的核心理念是：同一个 IP 地址在全球多个节点同时存在，用户请求会被路由到“距离最近”或“网络路径最优”的节点。",[17,2262,2263],{},"这意味着，Google DNS (8.8.8.8) 、Cloudflare DNS (1.1.1.1)、阿里 DNS (223.5.5.5)、腾讯 DNS (119.29.29.29) 等公共 DNS 服务器背后并不是一台中心化的服务器，而是一组分布在世界各地、动态路由的节点集群。",[17,2265,2266],{},"于是问题出现了：",[343,2268,2269,2272,2275],{},[346,2270,2271],{},"我在上海运行的预热脚本，也许命中了 223.5.5.5 的上海节点；",[346,2273,2274],{},"但来自北京的访问者，却会被路由到 223.5.5.5 的北京节点；",[346,2276,2277,2278],{},"这两个节点的缓存，",[27,2279,2280],{},"彼此独立、互不共享。",[17,2282,2283],{},"从站长的视角来看，DNS 缓存不再是一个可预测的实体，而是分裂成一片片地理隔离、随时可变的“镜像迷宫”。",[17,2285,2286],{},"每个访客都在不同的山脚下推着自己的那块石头，仿佛世界上有成千上万个西西弗斯，孤独地在各自的路径上前行。",[254,2288,2290],{"id":2289},"不可控的缓存与冷启动的常态化","不可控的缓存与「冷启动的常态化」",[17,2292,2293],{},"这也解释了为什么即便一个小型网站有规律地被脚本访问，仍可能在真实访客那里出现明显的 DNS 延迟。因为「预热」只是局部生效 —— 它温暖的是某一个任播节点的缓存，而不是整个网络的全貌。而当 TTL 到期或缓存被公共 DNS 服务器采用 LRU 等算法清理时，这份温度也会悄然散去。",[17,2295,2296],{},"从宏观上看，这让“小流量站点”陷入了某种宿命循环：",[2075,2298,2299,2302,2305,2308],{},[346,2300,2301],{},"因访问量低，缓存不易命中；",[346,2303,2304],{},"因缓存不命中，解析耗时高；",[346,2306,2307],{},"因解析耗时高，首屏性能差，用户更少访问；",[346,2309,2310],{},"因用户更少访问，缓存更难命中。",[17,2312,2313],{},[27,2314,2315],{},"冷启动不再是偶发的“意外”，而是一种被动的“常态”。",[254,2317,2319],{"id":2318},"我们能否让石头变轻-减缓冷启动影响的策略","我们能否让石头变轻？—— 减缓冷启动影响的策略",[17,2321,2322],{},"西西弗斯的困境看似无解，但我们并非完全无能为力。虽然无法彻底消除 DNS 冷启动，但通过一系列策略，我们可以显著减轻这块石头的重量，缩短它每次滚落后被推上山顶的时间。",[2324,2325,2327],"h3",{"id":2326},"权衡的艺术调整-dns-ttl-time-to-live","权衡的艺术：调整 DNS TTL (Time-To-Live)",[17,2329,2330],{},"TTL（生存时间）是 DNS 记录中的一个关键值，它告知递归解析器（如公共 DNS、本地缓存）可以将一条解析记录缓存多久，尽管他们可能会被 LRU 算法淘汰。",[17,2332,2333],{},"拉长 TTL 可以有效提高缓存的命中率，减少 DNS 冷启动的情况，尽可能让西西弗斯之石保留在山顶上。",[17,2335,2336],{},"但拉长 TTL 是以牺牲灵活性作为代价的：如果你因为某些原因需要更换域名做对应的 IP 地址，过长的 TTL 可能会导致访客在很长一段时间内取得的都是已经失效的 IP 地址。",[2324,2338,2340],{"id":2339},"选择更快的信使使用合适的权威-dns-服务器","选择更快的“信使”：使用合适的权威 DNS 服务器",[17,2342,2343],{},"DNS 解析的最后一公里——从公共 DNS 服务器到你的权威 DNS 服务器——的耗时同样至关重要。如果你的域名所采用的 Nameserver 服务响应缓慢、全球节点稀少、又或者距离访客所请求的公共 DNS 服务器距离太远，那么即使用户的公共 DNS 节点就在身边，整个解析链条依然会被这最后一环拖慢。",[17,2345,2346],{},"如果我正在写的是一篇英文博客，那么我只需要说把 Nameserver 换成 Cloudflare、Google 等一线大厂就完事了。这些大厂提供免费的权威 DNS 托管业务，且在全球各地拥有大量节点，在这方面是非常专业且值得信赖的。",[17,2348,2349,2350,2353],{},"但我现在正在使用简体中文，根据我的博客统计数据，我的读者大多来自中国大陆，他们的站点访客大多也来自中国大陆，他们请求的公共 DNS 服务器大概率也都部署在中国大陆，而 Cloudflare/Google Cloud DNS 完全没有权威 DNS 服务器的中国大陆节点，这会拖慢速度。所以",[27,2351,2352],{},"如果你的访客主要来自中国大陆境内，或许可以试试阿里云或者 Dnspod","，他们主要的权威 DNS 服务器节点都在中国大陆境内，这在理论上可以减少公共 DNS 服务器与 权威 DNS 服务器之间的通信时长。",[254,2355,2357],{"id":2356},"结语推石头的人","结语：推石头的人",[17,2359,2360],{},"DNS 冷启动的问题，从未有完美的解决方案。它像是互联网架构中注定存在的一段“延迟的诗意”——每个访问者都从自己的网络拓扑出发，沿着看不见的路径，一步步推着那块属于自己的石头，直到抵达你的服务器山顶，换得屏幕上第一个像素的亮起。",[17,2362,2363],{},"对小型站点而言，这或许是命运的重量；但理解它、优化它、监测它，便是我们在这条漫长上坡路上，为石头磨出更光滑的棱角。",[254,2365,2366],{"id":2366},"参见",[343,2368,2369,2376],{},[346,2370,2371],{},[21,2372,2375],{"href":2373,"rel":2374},"https://developers.google.com/speed/public-dns/docs/performance",[2036],"Performance Benefits  |  Public DNS  |  Google for Developers",[346,2377,2378],{},[21,2379,2382],{"href":2380,"rel":2381},"https://falconcloud.ae/about/blog/how-do-dns-queries-affect-website-latency/",[2036],"How do DNS queries affect website latency? - falconcloud.ae",[2049,2384,2385],{},"html .default .shiki span {color: var(--shiki-default);background: var(--shiki-default-bg);font-style: var(--shiki-default-font-style);font-weight: var(--shiki-default-font-weight);text-decoration: var(--shiki-default-text-decoration);}html .shiki span {color: var(--shiki-default);background: var(--shiki-default-bg);font-style: var(--shiki-default-font-style);font-weight: var(--shiki-default-font-weight);text-decoration: var(--shiki-default-text-decoration);}html .dark .shiki span {color: var(--shiki-dark);background: var(--shiki-dark-bg);font-style: var(--shiki-dark-font-style);font-weight: var(--shiki-dark-font-weight);text-decoration: var(--shiki-dark-text-decoration);}html.dark .shiki span {color: var(--shiki-dark);background: var(--shiki-dark-bg);font-style: var(--shiki-dark-font-style);font-weight: var(--shiki-dark-font-weight);text-decoration: var(--shiki-dark-text-decoration);}",{"title":43,"searchDepth":57,"depth":57,"links":2387},[2388,2389,2390,2391,2395,2396],{"id":2069,"depth":57,"text":2070},{"id":2250,"depth":57,"text":2251},{"id":2289,"depth":57,"text":2290},{"id":2318,"depth":57,"text":2319,"children":2392},[2393,2394],{"id":2326,"depth":63,"text":2327},{"id":2339,"depth":63,"text":2340},{"id":2356,"depth":57,"text":2357},{"id":2366,"depth":57,"text":2366},{"title":2398,"date":2399,"path":2400,"tags":2401,"body":2406},"HTTP/2 Server Push 已事实性“死亡”，我很怀念它","2025-11-05","/2025/11/05/http-2-server-push-is-practically-obsolete",[2402,2403,11,2404,2405],"HTTP","Caddy","HTML","Vercel",{"type":14,"value":2407,"toc":2813},[2408,2411,2415,2426,2488,2495,2548,2557,2563,2566,2569,2572,2617,2630,2633,2636,2644,2653,2661,2664,2667,2671,2674,2677,2680,2688,2702,2706,2713,2727,2733,2737,2740,2745,2748,2751,2754,2765,2768,2770,2811],[17,2409,2410],{},"我最近一阵子在重构我的博客，恰巧之前一阵子准备秋招的时候背八股时看到了 HTTP/2 的服务端推送，于是便尝试在部署阶段为我的博客配置好 HTTP/2 的服务端推送，试图以此来进一步优化首屏加载速度。",[254,2412,2414],{"id":2413},"http2-服务端推送为什么能提升首屏加载速度","HTTP/2 服务端推送为什么能提升首屏加载速度",[17,2416,2417,2418,2421,2422,2425],{},"如下图，在传统的 HTTP/1.1 中，浏览器会先下载 ",[45,2419,2420],{},"index.html"," 并完成第一轮解析，然后再从解析出的数据中拿到 css/js 资源的 url，再进行第二轮请求，在 tcp/tls 连接建立后最小需要",[27,2423,2424],{},"两个 RTT 才能取回","完整渲染页面所需的资源。",[38,2427,2429],{"className":40,"code":2428,"language":42,"meta":43,"style":43},"sequenceDiagram\n    participant Browser\n    participant Server\n\n    Browser->>Server: GET /index.html\n    Server-->>Browser: 200 OK + HTML\n    Browser->>Server: GET /style.css\n    Browser->>Server: GET /app.js\n    Server-->>Browser: 200 OK + CSS\n    Server-->>Browser: 200 OK + JS\n\n    Note over Browser: 浏览器必须等 HTML 下载并解析后\u003Cbr/>才能发起后续请求，增加往返延迟 (RTT)\n\n",[45,2430,2431,2435,2440,2445,2449,2454,2459,2464,2469,2474,2479,2483],{"__ignoreMap":43},[48,2432,2433],{"class":50,"line":51},[48,2434,54],{},[48,2436,2437],{"class":50,"line":57},[48,2438,2439],{},"    participant Browser\n",[48,2441,2442],{"class":50,"line":63},[48,2443,2444],{},"    participant Server\n",[48,2446,2447],{"class":50,"line":69},[48,2448,96],{"emptyLinePlaceholder":95},[48,2450,2451],{"class":50,"line":75},[48,2452,2453],{},"    Browser->>Server: GET /index.html\n",[48,2455,2456],{"class":50,"line":3},[48,2457,2458],{},"    Server-->>Browser: 200 OK + HTML\n",[48,2460,2461],{"class":50,"line":86},[48,2462,2463],{},"    Browser->>Server: GET /style.css\n",[48,2465,2466],{"class":50,"line":92},[48,2467,2468],{},"    Browser->>Server: GET /app.js\n",[48,2470,2471],{"class":50,"line":99},[48,2472,2473],{},"    Server-->>Browser: 200 OK + CSS\n",[48,2475,2476],{"class":50,"line":105},[48,2477,2478],{},"    Server-->>Browser: 200 OK + JS\n",[48,2480,2481],{"class":50,"line":110},[48,2482,96],{"emptyLinePlaceholder":95},[48,2484,2485],{"class":50,"line":116},[48,2486,2487],{},"    Note over Browser: 浏览器必须等 HTML 下载并解析后\u003Cbr/>才能发起后续请求，增加往返延迟 (RTT)\n",[17,2489,2490,2491,2494],{},"而在 HTTP/2 的设想中，流程则是像下面这张图一样。当浏览器请求 index.html 时，服务端可以顺带将 css/js 资源一起推送给客户端，这样在 tcp/tls 连接建立后最小只需要",[27,2492,2493],{},"一个 RTT 就可以","将页面渲染所需的资源取回。",[38,2496,2498],{"className":40,"code":2497,"language":42,"meta":43,"style":43},"sequenceDiagram\n    participant Browser\n    participant Server\n\n    Browser->>Server: GET /index.html\n    Server-->>Browser: 200 OK + HTML\n    Server-->>Browser: PUSH_PROMISE /style.css\n    Server-->>Browser: PUSH_PROMISE /app.js\n    Server-->>Browser: (推送) style.css + app.js 内容\n\n    Note over Browser: 浏览器收到资源前置推送\u003Cbr/>减少请求轮次与首屏延迟\n\n",[45,2499,2500,2504,2508,2512,2516,2520,2524,2529,2534,2539,2543],{"__ignoreMap":43},[48,2501,2502],{"class":50,"line":51},[48,2503,54],{},[48,2505,2506],{"class":50,"line":57},[48,2507,2439],{},[48,2509,2510],{"class":50,"line":63},[48,2511,2444],{},[48,2513,2514],{"class":50,"line":69},[48,2515,96],{"emptyLinePlaceholder":95},[48,2517,2518],{"class":50,"line":75},[48,2519,2453],{},[48,2521,2522],{"class":50,"line":3},[48,2523,2458],{},[48,2525,2526],{"class":50,"line":86},[48,2527,2528],{},"    Server-->>Browser: PUSH_PROMISE /style.css\n",[48,2530,2531],{"class":50,"line":92},[48,2532,2533],{},"    Server-->>Browser: PUSH_PROMISE /app.js\n",[48,2535,2536],{"class":50,"line":99},[48,2537,2538],{},"    Server-->>Browser: (推送) style.css + app.js 内容\n",[48,2540,2541],{"class":50,"line":105},[48,2542,96],{"emptyLinePlaceholder":95},[48,2544,2545],{"class":50,"line":110},[48,2546,2547],{},"    Note over Browser: 浏览器收到资源前置推送\u003Cbr/>减少请求轮次与首屏延迟\n",[17,2549,2550,2551,2556],{},"为了在 HTTP/1.1 中尽可能减少后续的请求，前端开发者尝试了非常多的优化手段，正如 Sukka 在《",[21,2552,2555],{"href":2553,"rel":2554},"https://blog.skk.moe/post/http2-server-push/",[2036],"静态资源递送优化：HTTP/2 和 Server Push","》一文中所讲：",[2558,2559,2560],"blockquote",{},[17,2561,2562],{},"关键资源、关键渲染路径、关键请求链的概念诞生已久，异步加载资源的概念可谓是老生常谈：懒加载图片、视频、iframe，乃至懒加载 CSS、JS、DOM，懒执行函数。但是，关键资源递送的思路却依然没有多少改变。",[17,2564,2565],{},"HTTP/2 的 Server Push 创造了新的资源递送思路，CSS/JS 等资源不用随着 html 一起递送也能在一个 RTT 内被传送到客户端，而这一部分资源可以被浏览器缓存起来，不被 html 那较短的 TTL 所限制。",[254,2567,2568],{"id":2568},"初步方案",[17,2570,2571],{},"既然理清了 HTTP/2 服务端推送的优势，于是准备着手优化。我的博客是纯静态的，通过 DNS 进行境内外分流：境内流量会访问到 DMIT 一台带有 cmin2/9929 网络优化的 vps 上，通过 caddy 提供服务；境外流量则是直接打到 vercel，借助 Amazon 的 CDN 为全球网络提供边缘加速。网络架构大概是下面这个样子：",[38,2573,2575],{"className":40,"code":2574,"language":42,"meta":43,"style":43},"graph TD\n    A[博客访客] --> B[发起DNS解析请求]\n    B --> C[DNSPod 服务]\n    C -->|境内访客：智能分流| D[网络优化 VPS]\n    C -->|境外访客：智能分流| E[Vercel 平台]\n    D --> F[Caddy]\n    F --> G[返回博客内容给境内访客]\n    E --> H[返回博客内容给境外访客]\n",[45,2576,2577,2582,2587,2592,2597,2602,2607,2612],{"__ignoreMap":43},[48,2578,2579],{"class":50,"line":51},[48,2580,2581],{},"graph TD\n",[48,2583,2584],{"class":50,"line":57},[48,2585,2586],{},"    A[博客访客] --> B[发起DNS解析请求]\n",[48,2588,2589],{"class":50,"line":63},[48,2590,2591],{},"    B --> C[DNSPod 服务]\n",[48,2593,2594],{"class":50,"line":69},[48,2595,2596],{},"    C -->|境内访客：智能分流| D[网络优化 VPS]\n",[48,2598,2599],{"class":50,"line":75},[48,2600,2601],{},"    C -->|境外访客：智能分流| E[Vercel 平台]\n",[48,2603,2604],{"class":50,"line":3},[48,2605,2606],{},"    D --> F[Caddy]\n",[48,2608,2609],{"class":50,"line":86},[48,2610,2611],{},"    F --> G[返回博客内容给境内访客]\n",[48,2613,2614],{"class":50,"line":92},[48,2615,2616],{},"    E --> H[返回博客内容给境外访客]\n",[17,2618,2619,2620,2623,2624,2629],{},"Caddy 可以通过 ",[45,2621,2622],{},"http.handlers.push"," 模块实现 HTTP/2 的服务端推送，在 Caddyfile 中我们可以编写简单的推送逻辑，这没问题；vercel 平台则没有给开发者提供 HTTP/2 服务端推送的配置项，但好在我是静态博客，对平台依赖性不强，考虑迁移到 Cloudflare Workers，",[21,2625,2628],{"href":2626,"rel":2627},"https://brianli.com/cloudflare-workers-sites-http2-server-push/",[2036],"五年前就有开发者实现了","。",[254,2631,2632],{"id":2632},"客户端的支持情况",[17,2634,2635],{},"历史上主流浏览器引擎（Chrome/Chromium、Firefox、Edge、Safari）曾普遍支持服务器推送技术。",[17,2637,2638,2639,2629],{},"2020 年 11 月，谷歌宣布",[21,2640,2643],{"href":2641,"rel":2642},"https://groups.google.com/a/chromium.org/g/blink-dev/c/K3rYLvmQUBY/m/vOWBKZGoAQAJ",[2036],"计划在其 Chrome 浏览器的 HTTP/2 及 gQUIC（后发展为HTTP/3）实现中移除服务器推送功能",[17,2645,2646,2647,2652],{},"2022 年 10 月，谷歌宣布",[21,2648,2651],{"href":2649,"rel":2650},"https://developer.chrome.com/blog/removing-push/",[2036],"计划从Chrome浏览器中移除服务器推送功能","，指出该扩展在实际应用中性能不佳、使用率低且存在更优替代方案。Chrome 106 成为首个默认禁用服务器推送的版本。",[17,2654,2655,2656],{},"2024 年 10 月 29 日，Mozilla 发布了 Firefox 132版本，",[21,2657,2660],{"href":2658,"rel":2659},"https://www.firefox.com/en-US/firefox/132.0/releasenotes/",[2036],"因“与多个网站存在兼容性问题”移除了对HTTP/2服务器推送功能的支持。",[17,2662,2663],{},"至此，主流浏览器对 HTTP/2 服务端推送（Server Push）的支持已全部终结。从最初被视为“减少往返延迟、优化首屏加载”的创新特性，到最终被全面弃用，HTTP/2 推送的生命周期不过短短数年，成为 Web 性能优化历史上的一次重要实验。",[254,2665,2666],{"id":2666},"替代方案",[2324,2668,2670],{"id":2669},"_1-http-103-early-hints","1. HTTP 103 Early Hints",[17,2672,2673],{},"103 Early Hints 是对服务端推送最直接的“继任者”。它是一个信息性的 HTTP 状态码 (Informational Response)，允许服务器在生成完整的 HTML 响应（例如，状态码为 200 OK）之前，先发送一个带有 Link 头部的“早期提示”响应。",[17,2675,2676],{},"这个 Link 头部可以告诉浏览器：“嘿，我还在准备主菜（HTML），但你可以先去把配菜（CSS、JS）准备好”。这样，浏览器就能利用服务器的“思考时间”提前开始下载关键资源或预热到所需源的连接，从而显著缩短首屏渲染时间。",[17,2678,2679],{},"与服务端推送的对比：",[343,2681,2682,2685],{},[346,2683,2684],{},"决策权在客户端：Early Hints 只是“提示”，浏览器可以根据自身缓存情况、网络状况等因素决定是否采纳该提示。这就解决了服务端推送最大的痛点——服务器无法知晓客户端缓存而导致推送冗余资源。",[346,2686,2687],{},"兼容性更好：它是一种更轻量、更易于中间代理服务器理解和传递的机制。",[17,2689,2690,2691,2693,2694,2697,2698,2701],{},"103 Early Hints 对动态博客很有意义，在后端进行计算之前先把需要的资源通过 103 响应告知浏览器，让浏览器先取回其他资源，再等待后端返回最终的 html；而",[27,2692,2239],{},"我这种产物都是预构建好的",[27,2695,2696],{},"静态博客","，完全",[27,2699,2700],{},"没有任何意义","，网关有那个发 103 响应的闲工夫完全可以把 html 直接发过去了。",[2324,2703,2705],{"id":2704},"_2-资源提示resource-hints-preload-prefetch","2. 资源提示（Resource Hints）: Preload & Prefetch",[17,2707,2708,2709,2712],{},"早在服务端推送被弃用前，通过 ",[45,2710,2711],{},"\u003Clink>","标签实现的资源提示就已经是前端性能优化的常用手段。它们将资源加载的提示声明在 HTML 中，由浏览器主导整个过程。",[343,2714,2715,2721],{},[346,2716,2717,2720],{},[45,2718,2719],{},"\u003Clink rel=\"preload\">",": 用于告诉浏览器当前页面必定会用到的资源，请以高优先级立即开始加载，但加载后不执行。比如，隐藏在 CSS 深处的字体文件或由 JS 动态加载的首屏图片。通过 Preload，可以确保这些关键资源能尽早被发现和下载，避免渲染阻塞。",[346,2722,2723,2726],{},[45,2724,2725],{},"\u003Clink rel=\"prefetch\">",": 用于告诉浏览器用户在未来可能访问的页面或用到的资源，请在浏览器空闲时以低优先级在后台下载。例如，在文章列表页 prefetch 用户最可能点击的文章页面的资源，从而实现近乎“秒开”的跳转体验。",[17,2728,2729,2730,2629],{},"Preload 和 Prefetch 将资源加载的控制权完全交给了开发者和浏览器，通过声明式的方式精细化管理资源加载的优先级和时机，是目前最成熟、应用最广泛的资源预加载方案，但仍然",[27,2731,2732],{},"逃不过 2 RTT 的魔咒",[254,2734,2736],{"id":2735},"尾声写给一个理想主义者的挽歌","尾声：写给一个理想主义者的挽歌",[17,2738,2739],{},"写到最后，我终究是没能为我的博客配上 HTTP/2 服务端推送。",[17,2741,2742],{},[27,2743,2744],{},"HTTP/2 Server Push 已事实性“死亡”，我很怀念它。",[17,2746,2747],{},"在一个理想模型里，当浏览器请求 HTML 时，服务器顺手将渲染所需的 CSS 和 JS  一并推来，将原本至少两次的往返（RTT）干脆利落地压缩为一次。这是一个如此直接、如此漂亮的解决方案，几乎是前端工程师面对首屏渲染延迟问题时梦寐以求的“银弹”。它背后蕴含的是一种雄心勃勃的魄力：试图由服务端一次性地、彻底地解决“关键请求链”的延迟问题。",[17,2749,2750],{},"但 Web 的世界终究不是一个理想的实验室。它充满了缓存、重复访问的用户、以及形形色色的网络环境。",[17,2752,2753],{},"服务端推送最大的魅力，在于它的“主动”，而它最大的遗憾，也恰恰源于这份“主动”。它无法知晓浏览器缓存中是否早已静静躺着那个它正准备满腔热情推送的 style.css 文件。为了那一小部分首次访问用户的极致体验，却可能要以浪费更多再次访问用户的宝贵带宽为代价。",[17,2755,2756,2757,2760,2761,2764],{},"Web 的演进最终选择了一条更稳妥、更具协作精神的道路。它将决策权交还给了最了解情况的浏览器，整个交互从服务器的“",[27,2758,2759],{},"我推送给你","”，变成了服务器的“",[27,2762,2763],{},"我建议你拿","”，再由浏览器自己定夺。这或许不够浪漫，不够极致，但它更普适，也更健壮。",[17,2766,2767],{},"所以，我依然会怀念那个雄心勃勃的 Server Push。它代表了一种对极致性能的纯粹追求，一种美好的技术理想主义。尽管它已悄然淡出历史舞台，但它所指向的那个关于“速度”的梦想，早已被 103 Early Hints 和 preload 以一种更成熟、更懂得权衡的方式继承了下来。",[254,2769,2366],{"id":2366},[343,2771,2772,2779,2786,2792,2799,2805],{},[346,2773,2774],{},[21,2775,2778],{"href":2776,"rel":2777},"https://developer.chrome.com/blog/removing-push",[2036],"Remove HTTP/2 Server Push from Chrome  |  Blog  |  Chrome for Developers",[346,2780,2781],{},[21,2782,2785],{"href":2783,"rel":2784},"https://en.wikipedia.org/wiki/HTTP/2_Server_Push",[2036],"HTTP/2 Server Push - Wikipedia",[346,2787,2788],{},[21,2789,2791],{"href":2553,"rel":2790},[2036],"静态资源递送优化：HTTP/2 和 Server Push | Sukka's Blog",[346,2793,2794],{},[21,2795,2798],{"href":2796,"rel":2797},"https://caddyserver.com/docs/modules/http.handlers.push",[2036],"Module http.handlers.push - Caddy Documentation",[346,2800,2801],{},[21,2802,2804],{"href":2626,"rel":2803},[2036],"How to Configure HTTP/2 Server Push on Cloudflare Workers Sites",[346,2806,2807],{},[21,2808,2810],{"href":2641,"rel":2809},[2036],"Intent to Remove: HTTP/2 and gQUIC server push",[2049,2812,2385],{},{"title":43,"searchDepth":57,"depth":57,"links":2814},[2815,2816,2817,2818,2822,2823],{"id":2413,"depth":57,"text":2414},{"id":2568,"depth":57,"text":2568},{"id":2632,"depth":57,"text":2632},{"id":2666,"depth":57,"text":2666,"children":2819},[2820,2821],{"id":2669,"depth":63,"text":2670},{"id":2704,"depth":63,"text":2705},{"id":2735,"depth":57,"text":2736},{"id":2366,"depth":57,"text":2366},{"title":2825,"date":2826,"path":2827,"tags":2828,"body":2832},"Nuxt Content v3 中数组字段的筛选困境与性能优化","2025-10-20 21:52:59","/2025/10/20/nuxt-content-v3-z-array-query-challenge",[2829,2830,2831],"Nuxt","Nuxt Content","JavaScript",{"type":14,"value":2833,"toc":3836},[2834,2849,2852,2903,2910,2914,2924,3043,3058,3233,3242,3252,3256,3259,3530,3536,3554,3560,3565,3569,3580,3597,3603,3617,3787,3790,3798,3804,3810,3815,3817,3824,3833],[17,2835,2836,2837,2840,2841,2844,2845,2848],{},"Nuxt Content 是 Nuxt 生态中用于处理 Markdown、YAML 等内容的强大模块。最近，我在使用 ",[27,2838,2839],{},"Nuxt v4 + Nuxt Content v3"," 重构博客（原为 Hexo）时，遇到了一个棘手的问题：v3 版本的默认查询 API ",[27,2842,2843],{},"并未直接提供","对数组字段进行“包含”（",[45,2846,2847],{},"$contains","）操作的支持。",[17,2850,2851],{},"例如，这是我的正在写的这篇博客的 Front Matter：",[38,2853,2857],{"className":2854,"code":2855,"language":2856,"meta":43,"style":43},"language-markdown shiki shiki-themes one-light one-dark-pro","---\ntitle: Nuxt Content v3 中数组字段的筛选困境\ndate: 2025-10-20 21:52:59\nsticky:\ntags:\n- Nuxt\n- Nuxt Content\n- JavaScript\n---\n","markdown",[45,2858,2859,2864,2869,2874,2879,2884,2889,2894,2899],{"__ignoreMap":43},[48,2860,2861],{"class":50,"line":51},[48,2862,2863],{},"---\n",[48,2865,2866],{"class":50,"line":57},[48,2867,2868],{},"title: Nuxt Content v3 中数组字段的筛选困境\n",[48,2870,2871],{"class":50,"line":63},[48,2872,2873],{},"date: 2025-10-20 21:52:59\n",[48,2875,2876],{"class":50,"line":69},[48,2877,2878],{},"sticky:\n",[48,2880,2881],{"class":50,"line":75},[48,2882,2883],{},"tags:\n",[48,2885,2886],{"class":50,"line":3},[48,2887,2888],{},"- Nuxt\n",[48,2890,2891],{"class":50,"line":86},[48,2892,2893],{},"- Nuxt Content\n",[48,2895,2896],{"class":50,"line":92},[48,2897,2898],{},"- JavaScript\n",[48,2900,2901],{"class":50,"line":99},[48,2902,2863],{},[17,2904,2905,2906,2909],{},"我的目标是创建一个 ",[27,2907,2908],{},"Tag 页面","，列出所有包含特定 Tag（例如 'Nuxt'）的文章。",[254,2911,2913],{"id":2912},"v2-的便捷与-v3-的限制","v2 的便捷与 v3 的限制",[17,2915,2916,2917,2920,2921,2923],{},"在 Nuxt Content v2 中，数据基于文件系统存储，查询方式是对文件内容的抽象，模拟了类似 ",[27,2918,2919],{},"MongoDB 的 JSON 文档查询","语法。我们可以轻松地使用 ",[45,2922,2847],{}," 方法获取所有包含 “Nuxt” 标签的文章：",[38,2925,2929],{"className":2926,"code":2927,"language":2928,"meta":43,"style":43},"language-typescript shiki shiki-themes one-light one-dark-pro","const tag = decodeURIComponent(route.params.tag as string)\n\nconst articles = await queryContent('posts')\n  .where({ tags: { $contains: tag } })  // ✅ v2 中的 MongoDB Style 查询\n  .find()\n","typescript",[45,2930,2931,2973,2977,2999,3033],{"__ignoreMap":43},[48,2932,2933,2936,2940,2943,2946,2948,2952,2954,2958,2960,2963,2967,2971],{"class":50,"line":51},[48,2934,2935],{"class":645},"const",[48,2937,2939],{"class":2938},"sNmU0"," tag",[48,2941,2942],{"class":549}," =",[48,2944,2945],{"class":282}," decodeURIComponent",[48,2947,448],{"class":447},[48,2949,2951],{"class":2950},"s7GmK","route",[48,2953,1052],{"class":447},[48,2955,2957],{"class":2956},"s2QsP","params",[48,2959,1052],{"class":447},[48,2961,2962],{"class":396},"tag",[48,2964,2966],{"class":2965},"sblXP"," as",[48,2968,2970],{"class":2969},"sN9Y4"," string",[48,2972,487],{"class":447},[48,2974,2975],{"class":50,"line":57},[48,2976,96],{"emptyLinePlaceholder":95},[48,2978,2979,2981,2984,2986,2989,2992,2994,2997],{"class":50,"line":63},[48,2980,2935],{"class":645},[48,2982,2983],{"class":2938}," articles",[48,2985,2942],{"class":549},[48,2987,2988],{"class":645}," await",[48,2990,2991],{"class":282}," queryContent",[48,2993,448],{"class":447},[48,2995,2996],{"class":285},"'posts'",[48,2998,487],{"class":447},[48,3000,3001,3004,3007,3010,3013,3017,3020,3022,3024,3027,3030],{"class":50,"line":69},[48,3002,3003],{"class":447},"  .",[48,3005,3006],{"class":282},"where",[48,3008,3009],{"class":447},"({ ",[48,3011,3012],{"class":396},"tags",[48,3014,3016],{"class":3015},"st7oF",":",[48,3018,3019],{"class":447}," { ",[48,3021,2847],{"class":396},[48,3023,3016],{"class":3015},[48,3025,2939],{"class":3026},"sz0mV",[48,3028,3029],{"class":447}," } })  ",[48,3031,3032],{"class":376},"// ✅ v2 中的 MongoDB Style 查询\n",[48,3034,3035,3037,3040],{"class":50,"line":75},[48,3036,3003],{"class":447},[48,3038,3039],{"class":282},"find",[48,3041,3042],{"class":447},"()\n",[17,3044,3045,3046,3053,3054,3057],{},"但在使用 ",[27,3047,3048,3049,3052],{},"Nuxt Content v3 的 ",[45,3050,3051],{},"queryCollection"," API"," 时，我们很自然地会尝试使用 ",[45,3055,3056],{},".where()"," 方法进行筛选：",[38,3059,3061],{"className":2926,"code":3060,"language":2928,"meta":43,"style":43},"const tag = decodeURIComponent(route.params.tag as string)\n\nconst { data } = await useAsyncData(`tag-${tag}`, () =>\n    queryCollection('posts')\n        .where(tag, 'in', 'tags')  // ❌ 这样会报错，因为第一次参数必须是字段名\n        .order('date', 'DESC')\n        .select('title', 'date', 'path', 'tags')\n        .all()\n)\n",[45,3062,3063,3091,3095,3135,3146,3174,3193,3220,3229],{"__ignoreMap":43},[48,3064,3065,3067,3069,3071,3073,3075,3077,3079,3081,3083,3085,3087,3089],{"class":50,"line":51},[48,3066,2935],{"class":645},[48,3068,2939],{"class":2938},[48,3070,2942],{"class":549},[48,3072,2945],{"class":282},[48,3074,448],{"class":447},[48,3076,2951],{"class":2950},[48,3078,1052],{"class":447},[48,3080,2957],{"class":2956},[48,3082,1052],{"class":447},[48,3084,2962],{"class":396},[48,3086,2966],{"class":2965},[48,3088,2970],{"class":2969},[48,3090,487],{"class":447},[48,3092,3093],{"class":50,"line":57},[48,3094,96],{"emptyLinePlaceholder":95},[48,3096,3097,3099,3101,3104,3107,3109,3111,3114,3116,3119,3122,3124,3126,3129,3132],{"class":50,"line":63},[48,3098,2935],{"class":645},[48,3100,3019],{"class":447},[48,3102,3103],{"class":2938},"data",[48,3105,3106],{"class":447}," } ",[48,3108,401],{"class":549},[48,3110,2988],{"class":645},[48,3112,3113],{"class":282}," useAsyncData",[48,3115,448],{"class":447},[48,3117,3118],{"class":285},"`tag-",[48,3120,694],{"class":3121},"sAOjX",[48,3123,2962],{"class":3026},[48,3125,700],{"class":3121},[48,3127,3128],{"class":285},"`",[48,3130,3131],{"class":447},", () ",[48,3133,3134],{"class":645},"=>\n",[48,3136,3137,3140,3142,3144],{"class":50,"line":69},[48,3138,3139],{"class":282},"    queryCollection",[48,3141,448],{"class":447},[48,3143,2996],{"class":285},[48,3145,487],{"class":447},[48,3147,3148,3151,3153,3155,3157,3160,3163,3165,3168,3171],{"class":50,"line":75},[48,3149,3150],{"class":447},"        .",[48,3152,3006],{"class":282},[48,3154,448],{"class":447},[48,3156,2962],{"class":3026},[48,3158,3159],{"class":447},", ",[48,3161,3162],{"class":285},"'in'",[48,3164,3159],{"class":447},[48,3166,3167],{"class":285},"'tags'",[48,3169,3170],{"class":447},")  ",[48,3172,3173],{"class":376},"// ❌ 这样会报错，因为第一次参数必须是字段名\n",[48,3175,3176,3178,3181,3183,3186,3188,3191],{"class":50,"line":3},[48,3177,3150],{"class":447},[48,3179,3180],{"class":282},"order",[48,3182,448],{"class":447},[48,3184,3185],{"class":285},"'date'",[48,3187,3159],{"class":447},[48,3189,3190],{"class":285},"'DESC'",[48,3192,487],{"class":447},[48,3194,3195,3197,3200,3202,3205,3207,3209,3211,3214,3216,3218],{"class":50,"line":86},[48,3196,3150],{"class":447},[48,3198,3199],{"class":282},"select",[48,3201,448],{"class":447},[48,3203,3204],{"class":285},"'title'",[48,3206,3159],{"class":447},[48,3208,3185],{"class":285},[48,3210,3159],{"class":447},[48,3212,3213],{"class":285},"'path'",[48,3215,3159],{"class":447},[48,3217,3167],{"class":285},[48,3219,487],{"class":447},[48,3221,3222,3224,3227],{"class":50,"line":92},[48,3223,3150],{"class":447},[48,3225,3226],{"class":282},"all",[48,3228,3042],{"class":447},[48,3230,3231],{"class":50,"line":99},[48,3232,487],{"class":447},[17,3234,3235,3236,3238,3239,2629],{},"遗憾的是，这样是行不通的。",[45,3237,3056],{}," 的方法签名要求字段名必须作为首个参数传入：",[45,3240,3241],{},"where(field: keyof Collection | string, operator: SqlOperator, value?: unknown)",[17,3243,3244,3245,3248,3249,3251],{},"由于 Nuxt Content v3 ",[27,3246,3247],{},"底层采用 SQLite 作为本地数据库","，所有查询都必须遵循类 SQL 语法。如果设计时未提供针对数组字段的内置操作符（例如 ",[45,3250,2847],{}," 的 SQL 等价形式），最终的解决方案往往会显得比较“别扭”。",[254,3253,3255],{"id":3254},"初版实现牺牲性能的全量拉取","初版实现：牺牲性能的“全量拉取”",[17,3257,3258],{},"本着“尽快重构，后续优化”的思路，我写出了以下代码：",[38,3260,3262],{"className":2926,"code":3261,"language":2928,"meta":43,"style":43},"// 初版实现：全量拉取后使用 JS 筛选\nconst allPosts = (\n    await useAsyncData(`tag-${route.params.tag}`, () =>\n        queryCollection('posts')\n            .order('date', 'DESC')\n            .select('title', 'date', 'path', 'tags')\n            .all()\n    )\n).data as Ref\u003CPost[]>\n\nconst Posts = computed(() => {\n    return allPosts.value.filter(post =>\n        typeof post.tags?.map === 'function'\n            ? post.tags?.includes(decodeURIComponent(route.params.tag as string))\n            : false\n    )\n})\n",[45,3263,3264,3269,3281,3313,3324,3341,3365,3373,3378,3400,3404,3424,3449,3474,3513,3521,3525],{"__ignoreMap":43},[48,3265,3266],{"class":50,"line":51},[48,3267,3268],{"class":376},"// 初版实现：全量拉取后使用 JS 筛选\n",[48,3270,3271,3273,3276,3278],{"class":50,"line":57},[48,3272,2935],{"class":645},[48,3274,3275],{"class":282}," allPosts",[48,3277,2942],{"class":549},[48,3279,3280],{"class":447}," (\n",[48,3282,3283,3286,3288,3290,3292,3294,3296,3299,3301,3303,3305,3307,3309,3311],{"class":50,"line":63},[48,3284,3285],{"class":645},"    await",[48,3287,3113],{"class":282},[48,3289,448],{"class":447},[48,3291,3118],{"class":285},[48,3293,694],{"class":3121},[48,3295,2951],{"class":2950},[48,3297,1052],{"class":3298},"sMj0N",[48,3300,2957],{"class":2956},[48,3302,1052],{"class":3298},[48,3304,2962],{"class":396},[48,3306,700],{"class":3121},[48,3308,3128],{"class":285},[48,3310,3131],{"class":447},[48,3312,3134],{"class":645},[48,3314,3315,3318,3320,3322],{"class":50,"line":69},[48,3316,3317],{"class":282},"        queryCollection",[48,3319,448],{"class":447},[48,3321,2996],{"class":285},[48,3323,487],{"class":447},[48,3325,3326,3329,3331,3333,3335,3337,3339],{"class":50,"line":75},[48,3327,3328],{"class":447},"            .",[48,3330,3180],{"class":282},[48,3332,448],{"class":447},[48,3334,3185],{"class":285},[48,3336,3159],{"class":447},[48,3338,3190],{"class":285},[48,3340,487],{"class":447},[48,3342,3343,3345,3347,3349,3351,3353,3355,3357,3359,3361,3363],{"class":50,"line":3},[48,3344,3328],{"class":447},[48,3346,3199],{"class":282},[48,3348,448],{"class":447},[48,3350,3204],{"class":285},[48,3352,3159],{"class":447},[48,3354,3185],{"class":285},[48,3356,3159],{"class":447},[48,3358,3213],{"class":285},[48,3360,3159],{"class":447},[48,3362,3167],{"class":285},[48,3364,487],{"class":447},[48,3366,3367,3369,3371],{"class":50,"line":86},[48,3368,3328],{"class":447},[48,3370,3226],{"class":282},[48,3372,3042],{"class":447},[48,3374,3375],{"class":50,"line":92},[48,3376,3377],{"class":447},"    )\n",[48,3379,3380,3383,3385,3387,3391,3394,3397],{"class":50,"line":99},[48,3381,3382],{"class":447},").",[48,3384,3103],{"class":396},[48,3386,2966],{"class":2965},[48,3388,3390],{"class":3389},"sC09Y"," Ref",[48,3392,3393],{"class":447},"\u003C",[48,3395,3396],{"class":3389},"Post",[48,3398,3399],{"class":447},"[]>\n",[48,3401,3402],{"class":50,"line":105},[48,3403,96],{"emptyLinePlaceholder":95},[48,3405,3406,3408,3411,3413,3416,3419,3422],{"class":50,"line":110},[48,3407,2935],{"class":645},[48,3409,3410],{"class":2938}," Posts",[48,3412,2942],{"class":549},[48,3414,3415],{"class":282}," computed",[48,3417,3418],{"class":447},"(() ",[48,3420,3421],{"class":645},"=>",[48,3423,652],{"class":447},[48,3425,3426,3429,3431,3433,3436,3438,3441,3443,3446],{"class":50,"line":116},[48,3427,3428],{"class":645},"    return",[48,3430,3275],{"class":2950},[48,3432,1052],{"class":447},[48,3434,3435],{"class":2956},"value",[48,3437,1052],{"class":447},[48,3439,3440],{"class":282},"filter",[48,3442,448],{"class":447},[48,3444,3445],{"class":671},"post",[48,3447,3448],{"class":645}," =>\n",[48,3450,3451,3455,3458,3460,3462,3465,3468,3471],{"class":50,"line":122},[48,3452,3454],{"class":3453},"s7DPa","        typeof",[48,3456,3457],{"class":2950}," post",[48,3459,1052],{"class":447},[48,3461,3012],{"class":2956},[48,3463,3464],{"class":447},"?.",[48,3466,3467],{"class":396},"map",[48,3469,3470],{"class":549}," ===",[48,3472,3473],{"class":285}," 'function'\n",[48,3475,3476,3479,3481,3483,3485,3487,3490,3492,3495,3497,3499,3501,3503,3505,3507,3509,3511],{"class":50,"line":127},[48,3477,3478],{"class":3453},"            ?",[48,3480,3457],{"class":2950},[48,3482,1052],{"class":447},[48,3484,3012],{"class":2956},[48,3486,3464],{"class":447},[48,3488,3489],{"class":282},"includes",[48,3491,448],{"class":447},[48,3493,3494],{"class":282},"decodeURIComponent",[48,3496,448],{"class":447},[48,3498,2951],{"class":2950},[48,3500,1052],{"class":447},[48,3502,2957],{"class":2956},[48,3504,1052],{"class":447},[48,3506,2962],{"class":396},[48,3508,2966],{"class":2965},[48,3510,2970],{"class":2969},[48,3512,1394],{"class":447},[48,3514,3515,3518],{"class":50,"line":133},[48,3516,3517],{"class":3453},"            :",[48,3519,3520],{"class":958}," false\n",[48,3522,3523],{"class":50,"line":139},[48,3524,3377],{"class":447},[48,3526,3527],{"class":50,"line":144},[48,3528,3529],{"class":447},"})\n",[17,3531,3532,3533],{},"这种方法虽然满足了需求，但也带来了明显的性能代价：",[27,3534,3535],{},"_payload.json 文件体积的膨胀。",[17,3537,3538,3539,3542,3543,3546,3547,3550,3551,3553],{},"在 Nuxt 项目中，",[45,3540,3541],{},"_payload.json"," 用于存储 ",[45,3544,3545],{},"useAsyncData"," 的结果等动态数据。在全量拉取的方案下，",[27,3548,3549],{},"每一个 Tag 页面"," 都会加载包含所有文章信息的 ",[45,3552,3541],{},"，造成数据冗余。很多 Tag 页面仅需一两篇文章的数据，却被迫加载了全部文章信息，严重影响了性能。",[17,3555,3556],{},[293,3557],{"alt":3558,"src":3559},"tags 目录占据了 2.9MiB，是所有目录中最大的","https://static.031130.xyz/uploads/2025/10/20/a748878c03c64.webp",[17,3561,3562],{},[293,3563],{"alt":3541,"src":3564},"https://static.031130.xyz/uploads/2025/10/20/8ef786d873da1.webp",[254,3566,3568],{"id":3567},"讨巧方案利用-sqlite-的存储特性进行优化","讨巧方案：利用 SQLite 的存储特性进行优化",[17,3570,3571,3572,3574,3575,2629],{},"为了减少 ",[45,3573,3545],{}," 返回的查询结果，我查阅了 Nuxt Content 的 GitHub Discussions，发现",[21,3576,3579],{"href":3577,"rel":3578},"https://github.com/nuxt/content/discussions/2955",[2036],"在 v3.alpha.8 版本时就有人提出了一种“巧妙”的解决方案",[17,3581,3582,3583,3592,3593,3596],{},"由于 Nuxt Content v3 使用 SQLite 数据库，原本在 Front Matter 中定义的 ",[27,3584,3585,3587,3588,3591],{},[45,3586,3012],{}," 数组（通过 ",[45,3589,3590],{},"z.array()"," 定义）最终会以 JSON 字符串的形式存储","在数据库中（具体格式可在 ",[45,3594,3595],{},".nuxt/content/sql_dump.txt"," 文件中查看）。",[17,3598,3599],{},[293,3600],{"alt":3601,"src":3602},"sql_dump.txt","https://static.031130.xyz/uploads/2025/10/20/b70036c55bb29.webp",[17,3604,3605,3606,3609,3610,3616],{},"这意味着我们可以利用 SQLite 的",[27,3607,3608],{},"字符串操作","特性，通过 ",[27,3611,3612,3615],{},[45,3613,3614],{},"LIKE"," 动词配合通配符","来完成数组包含的筛选，本质上是查询 JSON 字符串是否包含特定子串：",[38,3618,3620],{"className":2926,"code":3619,"language":2928,"meta":43,"style":43},"const tag = decodeURIComponent(route.params.tag as string)\n\nconst { data } = await useAsyncData(`tag-${route.params.tag}`, () =>\n    queryCollection('posts')\n        .where('tags', 'LIKE', `%\"${tag}\"%`)\n        .order('date', 'DESC')\n        .select('title', 'date', 'path', 'tags')\n        .all()\n)\n",[45,3621,3622,3650,3654,3694,3704,3735,3751,3775,3783],{"__ignoreMap":43},[48,3623,3624,3626,3628,3630,3632,3634,3636,3638,3640,3642,3644,3646,3648],{"class":50,"line":51},[48,3625,2935],{"class":645},[48,3627,2939],{"class":2938},[48,3629,2942],{"class":549},[48,3631,2945],{"class":282},[48,3633,448],{"class":447},[48,3635,2951],{"class":2950},[48,3637,1052],{"class":447},[48,3639,2957],{"class":2956},[48,3641,1052],{"class":447},[48,3643,2962],{"class":396},[48,3645,2966],{"class":2965},[48,3647,2970],{"class":2969},[48,3649,487],{"class":447},[48,3651,3652],{"class":50,"line":57},[48,3653,96],{"emptyLinePlaceholder":95},[48,3655,3656,3658,3660,3662,3664,3666,3668,3670,3672,3674,3676,3678,3680,3682,3684,3686,3688,3690,3692],{"class":50,"line":63},[48,3657,2935],{"class":645},[48,3659,3019],{"class":447},[48,3661,3103],{"class":2938},[48,3663,3106],{"class":447},[48,3665,401],{"class":549},[48,3667,2988],{"class":645},[48,3669,3113],{"class":282},[48,3671,448],{"class":447},[48,3673,3118],{"class":285},[48,3675,694],{"class":3121},[48,3677,2951],{"class":2950},[48,3679,1052],{"class":3298},[48,3681,2957],{"class":2956},[48,3683,1052],{"class":3298},[48,3685,2962],{"class":396},[48,3687,700],{"class":3121},[48,3689,3128],{"class":285},[48,3691,3131],{"class":447},[48,3693,3134],{"class":645},[48,3695,3696,3698,3700,3702],{"class":50,"line":69},[48,3697,3139],{"class":282},[48,3699,448],{"class":447},[48,3701,2996],{"class":285},[48,3703,487],{"class":447},[48,3705,3706,3708,3710,3712,3714,3716,3719,3721,3724,3726,3728,3730,3733],{"class":50,"line":75},[48,3707,3150],{"class":447},[48,3709,3006],{"class":282},[48,3711,448],{"class":447},[48,3713,3167],{"class":285},[48,3715,3159],{"class":447},[48,3717,3718],{"class":285},"'LIKE'",[48,3720,3159],{"class":447},[48,3722,3723],{"class":285},"`%\"",[48,3725,694],{"class":3121},[48,3727,2962],{"class":3026},[48,3729,700],{"class":3121},[48,3731,3732],{"class":285},"\"%`",[48,3734,487],{"class":447},[48,3736,3737,3739,3741,3743,3745,3747,3749],{"class":50,"line":3},[48,3738,3150],{"class":447},[48,3740,3180],{"class":282},[48,3742,448],{"class":447},[48,3744,3185],{"class":285},[48,3746,3159],{"class":447},[48,3748,3190],{"class":285},[48,3750,487],{"class":447},[48,3752,3753,3755,3757,3759,3761,3763,3765,3767,3769,3771,3773],{"class":50,"line":86},[48,3754,3150],{"class":447},[48,3756,3199],{"class":282},[48,3758,448],{"class":447},[48,3760,3204],{"class":285},[48,3762,3159],{"class":447},[48,3764,3185],{"class":285},[48,3766,3159],{"class":447},[48,3768,3213],{"class":285},[48,3770,3159],{"class":447},[48,3772,3167],{"class":285},[48,3774,487],{"class":447},[48,3776,3777,3779,3781],{"class":50,"line":92},[48,3778,3150],{"class":447},[48,3780,3226],{"class":282},[48,3782,3042],{"class":447},[48,3784,3785],{"class":50,"line":99},[48,3786,487],{"class":447},[17,3788,3789],{},"下面是优化后重新生成的文件占用，体积减小还是非常显著的",[343,3791,3792,3795],{},[346,3793,3794],{},"tags 目录体积: 2.9MiB -> 1.4MiB",[346,3796,3797],{},"单个 _payload.json 的体积: 23.1KiB -> 1.01 KiB",[17,3799,3800,3801,3803],{},"通过这种方法，我们成功将查询逻辑下推到了数据库层，避免了不必要的全量数据传输，显著降低了单个目录中 ",[45,3802,3541],{}," 的体积，实现了性能优化。",[17,3805,3806],{},[293,3807],{"alt":3808,"src":3809},"tags 目录体积下降","https://static.031130.xyz/uploads/2025/10/20/007e72e7b476d.webp",[17,3811,3812],{},[293,3813],{"alt":3541,"src":3814},"https://static.031130.xyz/uploads/2025/10/20/17ba3ccbbdf9e.webp",[254,3816,2366],{"id":2366},[17,3818,3819],{},[21,3820,3823],{"href":3821,"rel":3822},"https://content.nuxt.com/docs/utils/query-collection#wherefield-keyof-collection-string-operator-sqloperator-value-unknown",[2036],"queryCollection - Nuxt Content",[17,3825,3826],{},[21,3827,3829,3830,3832],{"href":3577,"rel":3828},[2036],"How do you query ",[45,3831,3590],{}," fields (e.g. tags) in the latest nuxt-content module (v3.alpha.8) · nuxt/content · Discussion #2955",[2049,3834,3835],{},"html .default .shiki span {color: var(--shiki-default);background: var(--shiki-default-bg);font-style: var(--shiki-default-font-style);font-weight: var(--shiki-default-font-weight);text-decoration: var(--shiki-default-text-decoration);}html .shiki span {color: var(--shiki-default);background: var(--shiki-default-bg);font-style: var(--shiki-default-font-style);font-weight: var(--shiki-default-font-weight);text-decoration: var(--shiki-default-text-decoration);}html .dark .shiki span {color: var(--shiki-dark);background: var(--shiki-dark-bg);font-style: var(--shiki-dark-font-style);font-weight: var(--shiki-dark-font-weight);text-decoration: var(--shiki-dark-text-decoration);}html.dark .shiki span {color: var(--shiki-dark);background: var(--shiki-dark-bg);font-style: var(--shiki-dark-font-style);font-weight: var(--shiki-dark-font-weight);text-decoration: var(--shiki-dark-text-decoration);}html pre.shiki code .sLKXg, html code.shiki .sLKXg{--shiki-default:#A626A4;--shiki-dark:#C678DD}html pre.shiki code .sNmU0, html code.shiki .sNmU0{--shiki-default:#986801;--shiki-dark:#E5C07B}html pre.shiki code .s_Sar, html code.shiki .s_Sar{--shiki-default:#0184BC;--shiki-dark:#56B6C2}html pre.shiki code .sAdtL, html code.shiki .sAdtL{--shiki-default:#4078F2;--shiki-dark:#61AFEF}html pre.shiki code .s5ixo, html code.shiki .s5ixo{--shiki-default:#383A42;--shiki-dark:#ABB2BF}html pre.shiki code .s7GmK, html code.shiki .s7GmK{--shiki-default:#383A42;--shiki-dark:#E5C07B}html pre.shiki code .s2QsP, html code.shiki .s2QsP{--shiki-default:#E45649;--shiki-dark:#E5C07B}html pre.shiki code .sJa8x, html code.shiki .sJa8x{--shiki-default:#E45649;--shiki-dark:#E06C75}html pre.shiki code .sblXP, html code.shiki .sblXP{--shiki-default:#383A42;--shiki-dark:#C678DD}html pre.shiki code .sN9Y4, html code.shiki .sN9Y4{--shiki-default:#0184BC;--shiki-dark:#E5C07B}html pre.shiki code .sDhpE, html code.shiki .sDhpE{--shiki-default:#50A14F;--shiki-dark:#98C379}html pre.shiki code .st7oF, html code.shiki .st7oF{--shiki-default:#0184BC;--shiki-dark:#ABB2BF}html pre.shiki code .sz0mV, html code.shiki .sz0mV{--shiki-default:#383A42;--shiki-dark:#E06C75}html pre.shiki code .sW2Sy, html code.shiki .sW2Sy{--shiki-default:#A0A1A7;--shiki-default-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic}html pre.shiki code .sAOjX, html code.shiki .sAOjX{--shiki-default:#CA1243;--shiki-dark:#C678DD}html pre.shiki code .sMj0N, html code.shiki .sMj0N{--shiki-default:#50A14F;--shiki-dark:#ABB2BF}html pre.shiki code .sC09Y, html code.shiki .sC09Y{--shiki-default:#C18401;--shiki-dark:#E5C07B}html pre.shiki code .s8iYz, html code.shiki .s8iYz{--shiki-default:#383A42;--shiki-default-font-style:inherit;--shiki-dark:#E06C75;--shiki-dark-font-style:italic}html pre.shiki code .s7DPa, html code.shiki .s7DPa{--shiki-default:#0184BC;--shiki-dark:#C678DD}html pre.shiki code .sAGMh, html code.shiki .sAGMh{--shiki-default:#986801;--shiki-dark:#D19A66}",{"title":43,"searchDepth":57,"depth":57,"links":3837},[3838,3839,3840,3841],{"id":2912,"depth":57,"text":2913},{"id":3254,"depth":57,"text":3255},{"id":3567,"depth":57,"text":3568},{"id":2366,"depth":57,"text":2366},{"title":3843,"date":3844,"path":3845,"tags":3846,"body":3853},"后 OCSP 时代，浏览器如何应对证书吊销新挑战","2025-10-16 15:38:50","/2025/10/16/how-s-mozilla-crlite-going-now",[3847,3848,3849,3850,3851,3852],"SSL","Firefox","Web PKI","OCSP","CRLSets","CRLite",{"type":14,"value":3854,"toc":4206},[3855,3858,3867,3876,3887,3892,3896,3907,3910,3917,3927,3934,3938,3945,3949,3952,3955,3963,3967,3970,3979,3999,4002,4006,4009,4022,4025,4049,4068,4071,4078,4081,4084,4088,4091,4115,4122,4128,4130],[17,3856,3857],{},"2023 年 8 月，CA/Browser Forum 通过了一项投票——不再强制要求 Let’s Encrypt 等公开信任的 CA 设立 OCSP Server",[17,3859,3860,3861,3866],{},"2024 年 7 月，Let's Encrypt 发布",[21,3862,3865],{"href":3863,"rel":3864},"https://letsencrypt.org/2024/07/23/replacing-ocsp-with-crls",[2036],"博客","，披露其计划关闭 OCSP Server",[17,3868,3869,3870,3875],{},"同年 12 月，Let's Encrypt 发布",[21,3871,3874],{"href":3872,"rel":3873},"https://letsencrypt.org/2024/12/05/ending-ocsp",[2036],"其关闭 OCSP Server 的时间计划表","，大致情况如下：",[343,3877,3878,3881,3884],{},[346,3879,3880],{},"2025 年 1 月 30 日 - Let’s Encrypt 不再接受新的包含 OCSP Must-Staple 扩展的证书签发请求，除非你的账号先前申请过此类证书",[346,3882,3883],{},"2025 年 5 月 7 日 - Let's Encrypt 新签发的证书将加入 CRL URLs，不再包含 OCSP URLs，并且所有新的包含 OCSP Must-Staple 扩展的证书签发请求都将被拒绝",[346,3885,3886],{},"2025 年 8 月 6 日 - Let's Encrypt 关闭 OCSP 服务器",[17,3888,3889],{},[27,3890,3891],{},"Let's Encrypt 是全世界最大的免费 SSL 证书颁发机构，而这一举动标志着我们已逐渐步入后 OCSP 时代。",[254,3893,3895],{"id":3894},"ocsp-的困境性能与隐私的权衡","OCSP 的困境：性能与隐私的权衡",[17,3897,3898,3899,3902,3903,3906],{},"Let's Encrypt 这一举动的背后，是人们对 OCSP（在线证书状态协议）长久以来累积的不满。OCSP 作为一种实时查询证书有效性的方式，最初的设想很美好：当浏览器访问一个网站时，它可以向 ",[27,3900,3901],{},"CA（证书颁发机构）"," 的 OCSP 服务器发送一个简短的请求，询问该证书是否仍然有效。这似乎比下载一个巨大的 ",[27,3904,3905],{},"CRL（证书吊销列表）"," 要高效得多。",[17,3908,3909],{},"然而，OCSP 在实际应用中暴露出众多缺陷：",[17,3911,3912,3913,3916],{},"首先是",[27,3914,3915],{},"性能问题","。尽管单个请求很小，但当数百万用户同时访问网站时，OCSP 服务器需要处理海量的实时查询。这不仅给 CA 带来了巨大的服务器压力，也增加了用户访问网站的延迟。如果 OCSP 服务器响应缓慢甚至宕机，浏览器可能会因为无法确认证书状态而中断连接，或者为了用户体验而不得不“睁一只眼闭一只眼”，这都削弱了 OCSP 的安全性。",[17,3918,3919,3920,3923,3924],{},"更严重的是",[27,3921,3922],{},"隐私问题","。每一次 OCSP 查询，都相当于向 CA 报告了用户的访问行为。这意味着 CA 能够知道某个用户在何时访问了哪个网站。虽然 OCSP 查询本身不包含个人身份信息，但将这些信息与 IP 地址等数据结合起来，CA 完全可以建立起用户的浏览习惯画像。对于重视隐私的用户和开发者来说，这种“无声的监视”是不可接受的。",[27,3925,3926],{},"即使 CA 故意不保留这些信息，地区法律也可能强制 CA 收集这些信息。",[17,3928,3929,3930,3933],{},"再者，OCSP  还存在设计上的",[27,3931,3932],{},"安全缺陷","。由于担心连接超时影响用户体验，浏览器通常默认采用 soft-fail 机制：一旦无法连接 OCSP  服务器，便会选择放行而非阻断连接。攻击者恰恰可以利用这一点，通过阻断客户端与 OCSP  服务器之间的通信，使查询始终超时，从而轻松绕过证书状态验证。",[2324,3935,3937],{"id":3936},"ocsp-装订-ocsp-stapling","OCSP 装订 (OCSP stapling)",[17,3939,3940,3941,2629],{},"基于上面这些缺陷，我们有了 OCSP 装订 (OCSP stapling) 方案，这",[21,3942,3944],{"href":3943},"/2024/11/19/firefox-is-the-only-mainstream-brower-doing-online-certificate-revocation-checks/#OCSP-%E8%A3%85%E8%AE%A2-OCSP-stapling","在我去年的博客里讲过，欢迎回顾",[2324,3946,3948],{"id":3947},"强制-ocsp-装订-ocsp-must-staple","强制 OCSP 装订 (OCSP Must-Staple)",[17,3950,3951],{},"OCSP Must-Staple 是一个在 ssl 证书申请时的拓展项，该扩展会告知浏览器：若在证书中识别到此扩展，则不得向证书颁发机构发送查询请求，而应在握手阶段获取装订式副本。若未能获得有效副本，浏览器应拒绝连接。",[17,3953,3954],{},"这项功能赋予了浏览器开发者 hard-fail 的勇气，但在 OCSP 淡出历史之前，Let's Encrypt 似乎是唯一支持这一拓展的主流 CA，并且这项功能并没有得到广泛使用。",[17,3956,3957,3958,2629],{},"~~本来不想介绍这项功能的（因为根本没人用），但考虑到这东西快入土了，还是给它在中文互联网中立个碑，~~更多信息参考 ",[21,3959,3962],{"href":3960,"rel":3961},"https://letsencrypt.org/2024/12/05/ending-ocsp#must-staple",[2036],"Let's Encrypt 的博客",[254,3964,3966],{"id":3965},"chromium-的方案弱水三千只取一瓢","Chromium 的方案：弱水三千只取一瓢",[17,3968,3969],{},"OCSP 的隐私和性能问题并非秘密，浏览器厂商们早就开始了各自的探索。2012 年，Chrome 默认禁用了 CRLs、OCSP 检查，转向自行设计的证书校验机制。",[17,3971,3972,3973,3978],{},"众所周知，吊销列表可以非常庞大。如果浏览器需要下载和解析一个完整的全球吊销列表，那将是一场性能灾难（Mozilla 团队在",[21,3974,3977],{"href":3975,"rel":3976},"https://hacks.mozilla.org/2025/08/crlite-fast-private-and-comprehensive-certificate-revocation-checking-in-firefox/",[2036],"今年的博客","中提到，从 3000 个活跃的 CRL 下载的文件大小将达到 300MB）。Chromium 团队通过分析历史数据发现，大多数被吊销的证书属于少数高风险类别，例如证书颁发机构（CA）本身被攻破、或者某些大型网站的证书被吊销。基于此洞察，CRLSets 采取了以下策略：",[2075,3980,3981,3987,3993],{},[346,3982,3983,3986],{},[27,3984,3985],{},"分层吊销","：Chromium 不会下载所有被吊销的证书信息，而是由 Google 团队维护一个精简的、包含“最重要”吊销信息的列表。这个列表会定期更新并通过 Chrome 浏览器更新推送给用户。",[346,3988,3989,3992],{},[27,3990,3991],{},"精简高效","：这个列表体积非常小，目前大概只有 600KB。它包含了那些一旦被滥用就会造成大规模安全事故的证书，例如 CA 的中间证书、或者一些知名网站（如 Google、Facebook）的证书。",[346,3994,3995,3998],{},[27,3996,3997],{},"牺牲部分安全性","：这种方案的缺点也很明显——它无法覆盖所有的证书吊销情况。对于一个普通网站的证书被吊销，CRLSets 大概率无法检测到。根据 Mozilla 今年的博客所说，CRLSets 只包含了 1%~2% 的未过期的被吊销证书信息。",[17,4000,4001],{},"虽然 CRLSets 是一种“不完美”的解决方案，但它在性能和可用性之间找到了一个平衡点。它确保了用户在访问主流网站时的基础安全，同时避免了 OCSP 带来的性能和隐私开销。对于 Chromium 而言，与其追求一个在现实中难以完美实现的 OCSP 方案，不如集中精力解决最紧迫的安全威胁。",[254,4003,4005],{"id":4004},"firefox-的方案从-crls-到-crlite","Firefox 的方案：从 CRLs 到 CRLite",[17,4007,4008],{},"与 Chromium 的“只取一瓢”策略不同，Firefox 的开发者们一直在寻找一种既能保证全面性，又能解决性能问题的方案。",[17,4010,4011,4012,4014,4015,4018,4019,2629],{},"为了解决这个问题，Mozilla 提出了一个创新的方案：",[27,4013,3852],{},"。CRLite 的设计理念是通过",[27,4016,4017],{},"哈希函数和布隆过滤器","等数据结构，将庞大的证书吊销列表压缩成一个",[27,4020,4021],{},"小巧、可下载且易于本地验证的格式",[17,4023,4024],{},"CRLite 的工作原理可以简单概括为：",[2075,4026,4027,4033,4043],{},[346,4028,4029,4032],{},[27,4030,4031],{},"数据压缩","：CA 定期生成其全部吊销证书的列表。",[346,4034,4035,4038,4039,4042],{},[27,4036,4037],{},"服务器处理","：Mozilla 的服务器会收集这些列表，并使用加密哈希函数和布隆过滤器等技术，将所有吊销证书的信息",[27,4040,4041],{},"编码","成一个非常紧凑的数据结构。",[346,4044,4045,4048],{},[27,4046,4047],{},"客户端验证","：浏览器下载这个压缩文件，当访问网站时，只需本地对证书进行哈希计算，然后查询这个本地文件，就能快速判断该证书是否已被吊销。",[17,4050,4051,4052,4055,4056,4059,4060,4063,4064,4067],{},"与 CRLSets 相比，CRLite 的优势在于它能够实现",[27,4053,4054],{},"对所有吊销证书的全面覆盖","，同时保持",[27,4057,4058],{},"极小的体积","。更重要的是，它",[27,4061,4062],{},"完全在本地完成验证","，这意味着浏览器",[27,4065,4066],{},"无需向任何第三方服务器发送请求","，从而彻底解决了 OCSP 的隐私问题。",[17,4069,4070],{},"Firefox 当前的策略为每 12 小时对 CRLite 数据进行一次增量更新，每日的下载数据大约为 300KB；每 45 天进行一次全量的快照同步，下载数据约为 4MB。",[17,4072,4073,4074],{},"Mozilla 开放了他们的数据看板，你可以在这里找到近期的 CRLite 数据大小：",[21,4075,4076],{"href":4076,"rel":4077},"https://yardstick.mozilla.org/dashboard/snapshot/c1WZrxGkNxdm9oZp7xVvGUEFJCELfApN",[2036],[17,4079,4080],{},"自 2025 年 4 月 1 日发布的 Firefox Desktop 137 版本起，Firefox 开始逐步以 CRLite 替换 OCSP 校验；同年 8 月 19 日，Firefox Desktop 142 针对 DV 证书正式弃用 OCSP 检验。",[17,4082,4083],{},"CRLite 已经成为 Firefox 未来证书吊销验证的核心方案，它代表了对性能、隐私和安全性的全面追求。",[254,4085,4087],{"id":4086},"后-ocsp-时代的展望","后 OCSP 时代的展望",[17,4089,4090],{},"随着 Let's Encrypt 等主要 CA 关闭 OCSP 服务，OCSP 的时代正在加速落幕。我们可以看到，浏览器厂商们已经开始各自探索更高效、更安全的替代方案。",[343,4092,4093,4103],{},[346,4094,4095,4098,4099,4102],{},[27,4096,4097],{},"Chromium"," 凭借其 CRLSets 方案，在",[27,4100,4101],{},"性能和关键安全保障","之间取得了务实的平衡。",[346,4104,4105,4107,4108,4110,4111,4114],{},[27,4106,3848],{}," 则通过 ",[27,4109,3852],{}," 这一技术创新，试图在",[27,4112,4113],{},"全面性、隐私和性能","三者之间找到最佳的解决方案。",[17,4116,4117,4118,4121],{},"这些方案的共同点是：",[27,4119,4120],{},"将证书吊销验证从实时在线查询（OCSP）转变为本地化验证","，从而规避了 OCSP 固有的性能瓶颈和隐私风险。",[17,4123,4124,4125],{},"未来，证书吊销的生态系统将不再依赖单一的、中心化的 OCSP 服务器。取而代之的是，一个更加多元、分布式和智能化的新时代正在到来。",[27,4126,4127],{},"OCSP 这一技术可能逐渐被淘汰，但它所试图解决的“证书吊销”这一核心安全问题，将永远是浏览器和网络安全社区关注的重点。",[254,4129,2366],{"id":2366},[343,4131,4132,4138,4145,4152,4159,4165,4171,4178,4185,4192,4199],{},[346,4133,4134],{},[21,4135,4137],{"href":3975,"rel":4136},[2036],"CRLite: Fast, private, and comprehensive certificate revocation checking in Firefox - Mozilla Hacks - the Web developer blog",[346,4139,4140],{},[21,4141,4144],{"href":4142,"rel":4143},"https://www.feistyduck.com/newsletter/issue_121_the_slow_death_of_ocsp",[2036],"The Slow Death of OCSP | Feisty Duck",[346,4146,4147],{},[21,4148,4151],{"href":4149,"rel":4150},"https://github.com/mozilla/crlite",[2036],"mozilla/crlite: Compact certificate revocation lists for the WebPKI",[346,4153,4154],{},[21,4155,4158],{"href":4156,"rel":4157},"https://letsencrypt.org/2025/08/06/ocsp-service-has-reached-end-of-life",[2036],"OCSP Service Has Reached End of Life - Let's Encrypt",[346,4160,4161],{},[21,4162,4164],{"href":3872,"rel":4163},[2036],"Ending OCSP Support in 2025 - Let's Encrypt",[346,4166,4167],{},[21,4168,4170],{"href":3863,"rel":4169},[2036],"Intent to End OCSP Service - Let's Encrypt",[346,4172,4173],{},[21,4174,4177],{"href":4175,"rel":4176},"https://www.chromium.org/Home/chromium-security/crlsets/",[2036],"CRLSets - The Chromium Projects",[346,4179,4180],{},[21,4181,4184],{"href":4182,"rel":4183},"https://www.pcworld.com/article/474296/google_chrome_will_no_longer_check_for_revoked_ssl_certificates_online-2.html",[2036],"Google Chrome Will No Longer Check for Revoked SSL Certificates Online | PCWorld",[346,4186,4187],{},[21,4188,4191],{"href":4189,"rel":4190},"https://www.zdnet.com/article/chrome-does-certificate-revocation-better/",[2036],"Chrome does certificate revocation better | ZDNET",[346,4193,4194],{},[21,4195,4198],{"href":4196,"rel":4197},"https://www.hats-land.com/WIP/2025-technical-and-analysis-of-mainstream-clientbrowser-certificate-revocation-verification-mechanism.html",[2036],"主流客户端/浏览器证书吊销验证机制技术对与分析 | 帽之岛, Hat's Land",[346,4200,4201],{},[21,4202,4205],{"href":4203,"rel":4204},"https://blog.gslin.org/archives/2025/02/02/12239/ocsp-%E7%9A%84%E6%B7%A1%E5%87%BA/",[2036],"OCSP 的淡出… – Gea-Suan Lin's BLOG",{"title":43,"searchDepth":57,"depth":57,"links":4207},[4208,4212,4213,4214,4215],{"id":3894,"depth":57,"text":3895,"children":4209},[4210,4211],{"id":3936,"depth":63,"text":3937},{"id":3947,"depth":63,"text":3948},{"id":3965,"depth":57,"text":3966},{"id":4004,"depth":57,"text":4005},{"id":4086,"depth":57,"text":4087},{"id":2366,"depth":57,"text":2366},{"title":4217,"date":4218,"path":4219,"tags":4220,"body":4225},"初试 Github Action Self-hosted Runner，想说爱你不容易","2025-09-05 05:54:17","/2025/09/05/first-try-of-github-action-self-hosted-runner",[4221,4222,4223,4224],"Github","Github Action","CI/CD","Experience",{"type":14,"value":4226,"toc":4422},[4227,4241,4244,4255,4258,4261,4264,4269,4272,4277,4280,4285,4290,4293,4298,4301,4306,4310,4313,4340,4343,4350,4355,4372,4390,4397,4401,4412,4419],[17,4228,4229,4230,4235,4236,2629],{},"在今年八月的时候，我这边所在的一个 Github Organization 在私有项目开发阶段频繁触发 CI，耗尽了 Github 为免费计划 (Free Plan) 提供的",[21,4231,4234],{"href":4232,"rel":4233},"https://docs.github.com/en/get-started/learning-about-github/githubs-plans#github-free-for-organizations",[2036],"每月 2000 分钟 Action 额度","（所有私有仓库共享，公有仓库不计）。大致看了下，CI 流设置得是合理的，那么就要另寻他法看看有没有办法去提供更宽裕的资源，因此也就盯上了文章标题中所提到的 ",[21,4237,4240],{"href":4238,"rel":4239},"https://docs.github.com/en/actions/concepts/runners/self-hosted-runners",[2036],"Github Action Self-hosted Runner",[17,4242,4243],{},"对于这个 Self-hosted Runner，与 Github 官方提供的 runner 相比，主要有以下几个优势",[343,4245,4246,4249,4252],{},[346,4247,4248],{},"针对私有仓库，拥有无限制的 Action 运行时长",[346,4250,4251],{},"可以自行搭配更强大的硬件计算能力和内存",[346,4253,4254],{},"可以接入内网环境，方便与内网/局域网设备通信",[254,4256,4257],{"id":4257},"配置安装",[17,4259,4260],{},"由于不清楚需要的网络环境，我这次测试直接选用了一台闲置的香港 vps，4核4G + 80G 硬盘 + 1Gbps 大口子的配置，除了硬盘读写稍微拉胯一些，别的地方可以说是拉满了。",[17,4262,4263],{},"Self-hosted Runner 的配置本身是相当直接和清晰的，照着官方提供的方案基本没什么问题。",[17,4265,4266],{},[293,4267],{"alt":43,"src":4268},"https://static.031130.xyz/uploads/2025/09/05/7c0475cdb1aa9.webp",[17,4270,4271],{},"三个主流平台都有，如果好好加以利用，应该可以涵盖包括 iPhone 应用打包等一系列的需求。",[17,4273,4274],{},[293,4275],{"alt":43,"src":4276},"https://static.031130.xyz/uploads/2025/09/05/96ff7cb263da1.webp",[17,4278,4279],{},"在观察一下我这边拿到手的 2.328.0 版本的 runner 安装文件压缩包的体积在 220MB 左右，内置了 node20 和 node24 各两个版本的运行环境。",[17,4281,4282],{},[293,4283],{"alt":43,"src":4284},"https://static.031130.xyz/uploads/2025/09/05/f775e3bcd2cdc.webp",[17,4286,4287],{},[293,4288],{"alt":43,"src":4289},"https://static.031130.xyz/uploads/2025/09/05/d0d4fe4611a40.webp",[17,4291,4292],{},"在执行完 config.sh 后，当前目录下就会多出一个 svc.sh，可以帮助利用这东西来调用 systemd 实现进程守护之类的需求。",[17,4294,4295],{},[293,4296],{"alt":43,"src":4297},"https://static.031130.xyz/uploads/2025/09/05/43c6b19038def.webp",[17,4299,4300],{},"再次刷新网页，就可以看到 Self-hosted Runner 处于已经上线的状态了",[17,4302,4303],{},[293,4304],{"alt":43,"src":4305},"https://static.031130.xyz/uploads/2025/09/05/6dad15beff900.webp",[254,4307,4309],{"id":4308},"指定-action-采用自己的-runner","指定 Action 采用自己的 Runner",[17,4311,4312],{},"这一步很简单，只需在原 Action 的 yml 文件中改变 runs-on 字段即可",[38,4314,4318],{"className":4315,"code":4316,"language":4317,"meta":43,"style":43},"language-diff shiki shiki-themes one-light one-dark-pro","jobs:\n  run:\n+    runs-on: self-hosted\n-    runs-on: ubuntu-latest\n","diff",[45,4319,4320,4325,4330,4335],{"__ignoreMap":43},[48,4321,4322],{"class":50,"line":51},[48,4323,4324],{"class":447},"jobs:\n",[48,4326,4327],{"class":50,"line":57},[48,4328,4329],{"class":447},"  run:\n",[48,4331,4332],{"class":50,"line":63},[48,4333,4334],{"class":285},"+    runs-on: self-hosted\n",[48,4336,4337],{"class":50,"line":69},[48,4338,4339],{"class":396},"-    runs-on: ubuntu-latest\n",[254,4341,4342],{"id":4342},"实测",[17,4344,4345,4346,4349],{},"当我满心欢喜地将 CI 流程从 Github 官方的 runner 切换到自托管的 runner 后，问题很快就浮现了，而这也正是我“爱不起来”的主要原因。问题集中体现在我习以为常的 ",[45,4347,4348],{},"setup-python"," 这一由 Github 官方维护的 Github Action Flow 中，提示 3.12 版本没找到。",[17,4351,4352],{},[293,4353],{"alt":43,"src":4354},"https://static.031130.xyz/uploads/2025/09/05/1c93947170a85.webp",[17,4356,4357,4358,4361,4362,4365,4366,4371],{},"在 Github 官方提供的虚拟环境中，这些 Action 会为我们准备好指定版本的开发环境。例如，",[45,4359,4360],{},"uses: actions/setup-python"," 加上 ",[45,4363,4364],{},"with: python-version: '3.12'"," 就会自动在环境中安装并配置好 Python 3.12.x。我对此已经习以为常，认为这是一个“开箱即用”的功能。但在 Self-hosted Runner 上，情况略有些不同。setup-python 在",[21,4367,4370],{"href":4368,"rel":4369},"https://github.com/actions/setup-python/blob/main/docs/advanced-usage.md#using-setup-python-with-a-self-hosted-runner",[2036],"文档","中指出",[2558,4373,4374],{},[17,4375,4376,4377,4382,4383,4386,4387,4389],{},"Python distributions are only available for the same ",[21,4378,4381],{"href":4379,"rel":4380},"https://github.com/actions/runner-images#available-images",[2036],"environments"," that GitHub Actions hosted environments are available for. If you are using an unsupported version of Ubuntu such as ",[45,4384,4385],{},"19.04"," or another Linux distribution such as Fedora, ",[45,4388,4348],{}," may not work.",[17,4391,4392,4393,4396],{},"setup-python 这个 Action ",[27,4394,4395],{},"只支持 Github Action 所采用的同款操作系统","，而我 VPS 的 Debian 不受支持，因此有这个误报，同时也给我的 Debian 判了死刑。",[254,4398,4400],{"id":4399},"症结所在对-self-hosted-runner-的误解","症结所在：对 Self-hosted Runner 的误解",[17,4402,4403,4404,4407,4408,4411],{},"我潜意识里认为，Self-hosted Runner 仅仅是将计算成本从 Github 服务器转移到了本地，而 ",[45,4405,4406],{},"actions/setup-python"," 这种官方标准动作，理应会像 Github-hosted Runner 中那样，优雅地为我下载、安装、并配置好我需要的一切。然而，",[27,4409,4410],{},"Self-hosted  Runner 的本质只是从 Github 接收任务，并在当前的操作系统环境中执行指令","，并不保证和 Github 官方提供的 Runner 的运行环境一致。",[17,4413,4414,4415,4418],{},"Self-hosted Runner 不是一个开箱即用的“服务”，而是",[27,4416,4417],{},"一个需要你亲自管理的“基础设施”","。你需要负责服务器的安装、配置、安全更新、依赖管理、磁盘清理等一系列运维工作。它更适合那些对 CI/CD 有更高阶需求的团队或个人：比如 CI/CD 消费大户、需要特定硬件（如 ARM、GPU）进行构建的团队、或者 CI 流程深度依赖内部网络资源的企业。对于像我这样只是愿意拿出更多的本地计算资源来获取更多 Action 运行时长的普通开发者而言，它带来的运维心智负担，似乎是有一点重了。",[2049,4420,4421],{},"html pre.shiki code .s5ixo, html code.shiki .s5ixo{--shiki-default:#383A42;--shiki-dark:#ABB2BF}html pre.shiki code .sDhpE, html code.shiki .sDhpE{--shiki-default:#50A14F;--shiki-dark:#98C379}html pre.shiki code .sJa8x, html code.shiki .sJa8x{--shiki-default:#E45649;--shiki-dark:#E06C75}html .default .shiki span {color: var(--shiki-default);background: var(--shiki-default-bg);font-style: var(--shiki-default-font-style);font-weight: var(--shiki-default-font-weight);text-decoration: var(--shiki-default-text-decoration);}html .shiki span {color: var(--shiki-default);background: var(--shiki-default-bg);font-style: var(--shiki-default-font-style);font-weight: var(--shiki-default-font-weight);text-decoration: var(--shiki-default-text-decoration);}html .dark .shiki span {color: var(--shiki-dark);background: var(--shiki-dark-bg);font-style: var(--shiki-dark-font-style);font-weight: var(--shiki-dark-font-weight);text-decoration: var(--shiki-dark-text-decoration);}html.dark .shiki span {color: var(--shiki-dark);background: var(--shiki-dark-bg);font-style: var(--shiki-dark-font-style);font-weight: var(--shiki-dark-font-weight);text-decoration: var(--shiki-dark-text-decoration);}",{"title":43,"searchDepth":57,"depth":57,"links":4423},[4424,4425,4426,4427],{"id":4257,"depth":57,"text":4257},{"id":4308,"depth":57,"text":4309},{"id":4342,"depth":57,"text":4342},{"id":4399,"depth":57,"text":4400},{"title":4429,"date":4430,"path":4431,"tags":4432,"body":4437},"DNS 解析延迟毁了我的图床优化","2025-08-11 00:06:40","/2025/08/11/dns-resolve-time-destroyed-my-optimization-for-pic-cdn",[4433,4434,12,11,4435,4436],"CDN","Image Hosting","Cloudflare","Dnspod",{"type":14,"value":4438,"toc":4893},[4439,4446,4451,4457,4461,4471,4475,4482,4580,4587,4590,4593,4597,4604,4637,4640,4644,4650,4654,4664,4708,4746,4749,4770,4773,4776,4779,4803,4807,4813,4817,4820,4824,4827,4871,4874,4883,4890],[17,4440,4441,4442,4445],{},"去年夏天，我花了不少时间搭建博客图床，核心目标是",[27,4443,4444],{},"分地区解析 DNS","，让国内外访客都能快速加载图片。技术方案看起来完美无缺，直到最近群友反馈首次访问时图片加载很慢，我才发现问题所在。",[17,4447,4448],{},[293,4449],{"alt":43,"src":4450},"https://static.031130.xyz/uploads/2025/08/11/26306b2a483ba.webp",[17,4452,4453,4456],{},[27,4454,4455],{},"955 毫秒的 DNS 解析时长！"," 这个数字让我大吃一惊。访客点开博客后，光是确定图片服务器位置就要等将近一秒，这完全抵消了 CDN 优化的效果。",[254,4458,4460],{"id":4459},"为什么之前没发现","为什么之前没发现？",[17,4462,4463,4464,4467,4468,2629],{},"主要是 ",[27,4465,4466],{},"DNS 缓存","的\"功劳\"。它会为后续访问记住解析结果，让我的本地测试和复访测试看起来都很正常。直到用户反馈，结合最近准备秋招复习的 DNS 解析流程（递归查询、权威查询、根域名、顶级域名等），我才定位到问题：",[27,4469,4470],{},"首次访问时的 DNS 解析延迟",[254,4472,4474],{"id":4473},"dns-解析流程分析","DNS 解析流程分析",[17,4476,4477,4478,4481],{},"让我们看看访客访问 ",[45,4479,4480],{},"static.031130.xyz"," 时，DNS 是如何工作的：",[38,4483,4485],{"className":40,"code":4484,"language":42,"meta":43,"style":43},"sequenceDiagram\n    participant User as 访客浏览器\n    participant Local as 本地 DNS\n    participant CF as Cloudflare\u003Cbr/>(国外权威)\n    participant DP as DNSPod\u003Cbr/>(国内权威)\n    participant CDN as CDN 节点\n\n    User->>Local: 请求 static.031130.xyz\n    Local->>CF: 查询 031130.xyz 权威\n    Note over Local,CF: 跨国查询，延迟高\n    CF->>Local: CNAME: cdn-cname.zhul.in\n    Local->>DP: 查询 zhul.in 权威\n    DP->>Local: CNAME: small-storage-cdn.b0.aicdn.com\n    Local->>DP: 查询 aicdn.com\n    DP->>Local: CNAME: nm.aicdn.com\n    Local->>DP: 查询最终 IP\n    DP->>Local: 返回 CDN IP\n    Local->>User: 返回解析结果\n    User->>CDN: 连接并下载图片\n",[45,4486,4487,4491,4496,4501,4506,4511,4516,4520,4525,4530,4535,4540,4545,4550,4555,4560,4565,4570,4575],{"__ignoreMap":43},[48,4488,4489],{"class":50,"line":51},[48,4490,54],{},[48,4492,4493],{"class":50,"line":57},[48,4494,4495],{},"    participant User as 访客浏览器\n",[48,4497,4498],{"class":50,"line":63},[48,4499,4500],{},"    participant Local as 本地 DNS\n",[48,4502,4503],{"class":50,"line":69},[48,4504,4505],{},"    participant CF as Cloudflare\u003Cbr/>(国外权威)\n",[48,4507,4508],{"class":50,"line":75},[48,4509,4510],{},"    participant DP as DNSPod\u003Cbr/>(国内权威)\n",[48,4512,4513],{"class":50,"line":3},[48,4514,4515],{},"    participant CDN as CDN 节点\n",[48,4517,4518],{"class":50,"line":86},[48,4519,96],{"emptyLinePlaceholder":95},[48,4521,4522],{"class":50,"line":92},[48,4523,4524],{},"    User->>Local: 请求 static.031130.xyz\n",[48,4526,4527],{"class":50,"line":99},[48,4528,4529],{},"    Local->>CF: 查询 031130.xyz 权威\n",[48,4531,4532],{"class":50,"line":105},[48,4533,4534],{},"    Note over Local,CF: 跨国查询，延迟高\n",[48,4536,4537],{"class":50,"line":110},[48,4538,4539],{},"    CF->>Local: CNAME: cdn-cname.zhul.in\n",[48,4541,4542],{"class":50,"line":116},[48,4543,4544],{},"    Local->>DP: 查询 zhul.in 权威\n",[48,4546,4547],{"class":50,"line":122},[48,4548,4549],{},"    DP->>Local: CNAME: small-storage-cdn.b0.aicdn.com\n",[48,4551,4552],{"class":50,"line":127},[48,4553,4554],{},"    Local->>DP: 查询 aicdn.com\n",[48,4556,4557],{"class":50,"line":133},[48,4558,4559],{},"    DP->>Local: CNAME: nm.aicdn.com\n",[48,4561,4562],{"class":50,"line":139},[48,4563,4564],{},"    Local->>DP: 查询最终 IP\n",[48,4566,4567],{"class":50,"line":144},[48,4568,4569],{},"    DP->>Local: 返回 CDN IP\n",[48,4571,4572],{"class":50,"line":150},[48,4573,4574],{},"    Local->>User: 返回解析结果\n",[48,4576,4577],{"class":50,"line":156},[48,4578,4579],{},"    User->>CDN: 连接并下载图片\n",[17,4581,4582,4583,4586],{},"问题就在这里：",[27,4584,4585],{},"前两步查询指向了国外的 Cloudflare 权威服务器","。对于国内用户，虽然最终解析到的 CDN 节点是国内的，但跨国 DNS 查询就足以拖垮首次访问体验。那 955ms 的延迟，基本都耗在与国外 DNS 服务器的通信上了。",[254,4588,4589],{"id":4589},"优化方案",[17,4591,4592],{},"针对这个问题，我采取了三个措施：",[2324,4594,4596],{"id":4595},"_1-dns-预取","1. DNS 预取",[17,4598,4599,4600,4603],{},"在博客 HTML 的 ",[45,4601,4602],{},"\u003Chead>"," 中添加：",[38,4605,4609],{"className":4606,"code":4607,"language":4608,"meta":43,"style":43},"language-html shiki shiki-themes one-light one-dark-pro","\u003Clink rel=\"dns-prefetch\" href=\"//static.031130.xyz\">\n","html",[45,4610,4611],{"__ignoreMap":43},[48,4612,4613,4615,4618,4621,4623,4626,4629,4631,4634],{"class":50,"line":51},[48,4614,3393],{"class":447},[48,4616,4617],{"class":396},"link",[48,4619,4620],{"class":958}," rel",[48,4622,401],{"class":447},[48,4624,4625],{"class":285},"\"dns-prefetch\"",[48,4627,4628],{"class":958}," href",[48,4630,401],{"class":447},[48,4632,4633],{"class":285},"\"//static.031130.xyz\"",[48,4635,4636],{"class":447},">\n",[17,4638,4639],{},"这样浏览器在渲染页面时就会提前解析图床域名，等真正需要加载图片时，DNS 结果可能已经准备好了。",[2324,4641,4643],{"id":4642},"_2-延长-ttl","2. 延长 TTL",[17,4645,4646,4647,4649],{},"将 ",[45,4648,4480],{}," 的 CNAME 记录 TTL 值调大（从几分钟延长到几小时甚至一天）。这样本地 DNS 服务器会缓存更久，后续用户可以直接使用缓存结果，省掉权威查询。",[2324,4651,4653],{"id":4652},"_3-迁移权威-dns核心","3. 迁移权威 DNS（核心）",[17,4655,4646,4656,4659,4660,4663],{},[45,4657,4658],{},"031130.xyz"," 域名的",[27,4661,4662],{},"权威 DNS 服务器","从 Cloudflare 迁移到国内的 DNSPod：",[38,4665,4667],{"className":40,"code":4666,"language":42,"meta":43,"style":43},"graph TB\n    subgraph \"优化前\"\n        A1[访客] --> B1[本地 DNS]\n        B1 --> C1[Cloudflare 权威\u003Cbr/>国外]\n        C1 --> D1[DNSPod 权威\u003Cbr/>国内]\n        D1 --> E1[CDN 节点]\n        style C1 fill:#ffcccc\n    end\n",[45,4668,4669,4674,4679,4684,4689,4694,4699,4704],{"__ignoreMap":43},[48,4670,4671],{"class":50,"line":51},[48,4672,4673],{},"graph TB\n",[48,4675,4676],{"class":50,"line":57},[48,4677,4678],{},"    subgraph \"优化前\"\n",[48,4680,4681],{"class":50,"line":63},[48,4682,4683],{},"        A1[访客] --> B1[本地 DNS]\n",[48,4685,4686],{"class":50,"line":69},[48,4687,4688],{},"        B1 --> C1[Cloudflare 权威\u003Cbr/>国外]\n",[48,4690,4691],{"class":50,"line":75},[48,4692,4693],{},"        C1 --> D1[DNSPod 权威\u003Cbr/>国内]\n",[48,4695,4696],{"class":50,"line":3},[48,4697,4698],{},"        D1 --> E1[CDN 节点]\n",[48,4700,4701],{"class":50,"line":86},[48,4702,4703],{},"        style C1 fill:#ffcccc\n",[48,4705,4706],{"class":50,"line":92},[48,4707,193],{},[38,4709,4711],{"className":40,"code":4710,"language":42,"meta":43,"style":43},"graph TB\n    subgraph \"优化后\"\n        A2[访客] --> B2[本地 DNS]\n        B2 --> D2[DNSPod 权威\u003Cbr/>国内]\n        D2 --> E2[CDN 节点]\n        style D2 fill:#ccffcc\n    end\n\n",[45,4712,4713,4717,4722,4727,4732,4737,4742],{"__ignoreMap":43},[48,4714,4715],{"class":50,"line":51},[48,4716,4673],{},[48,4718,4719],{"class":50,"line":57},[48,4720,4721],{},"    subgraph \"优化后\"\n",[48,4723,4724],{"class":50,"line":63},[48,4725,4726],{},"        A2[访客] --> B2[本地 DNS]\n",[48,4728,4729],{"class":50,"line":69},[48,4730,4731],{},"        B2 --> D2[DNSPod 权威\u003Cbr/>国内]\n",[48,4733,4734],{"class":50,"line":75},[48,4735,4736],{},"        D2 --> E2[CDN 节点]\n",[48,4738,4739],{"class":50,"line":3},[48,4740,4741],{},"        style D2 fill:#ccffcc\n",[48,4743,4744],{"class":50,"line":86},[48,4745,193],{},[17,4747,4748],{},"迁移后的好处：",[343,4750,4751,4757,4767],{},[346,4752,4753,4754,4756],{},"递归 DNS 查询 ",[45,4755,4658],{}," 时，直接找到国内的 DNSPod，响应快",[346,4758,4759,4760,4762,4763,4766],{},"DNSPod 直接返回 ",[45,4761,4480],{}," -> ",[45,4764,4765],{},"small-storage-cdn.b0.aicdn.com","，无需中间跳转",[346,4768,4769],{},"整个 DNS 解析链路在国内完成，首次访问延迟大幅降低",[254,4771,4772],{"id":4772},"优化效果",[17,4774,4775],{},"虽然 DNS 缓存给测试带来了困难，但迁移权威 DNS + 调整 TTL + 添加预取后，首次访问的 DNS 解析时间降到了可接受的范围。",[254,4777,4778],{"id":4778},"经验教训",[2075,4780,4781,4787,4797],{},[346,4782,4783,4786],{},[27,4784,4785],{},"DNS 位置很重要","：涉及多地优化时，权威 DNS 的地理位置对首次访问延迟影响很大。优先使用国内权威服务器。",[346,4788,4789,4792,4793,4796],{},[27,4790,4791],{},"首次访问是关键","：虽然缓存能帮助后续访问，但首次访问体验直接影响用户印象。善用 ",[45,4794,4795],{},"dns-prefetch"," 和合理的 TTL 设置。",[346,4798,4799,4802],{},[27,4800,4801],{},"监控和反馈重要","：本地测试环境往往有缓存加持，真实的首次访问体验需要通过监控和用户反馈来发现。",[254,4804,4806],{"id":4805},"重要提醒警惕-cname-拉平","重要提醒：警惕 CNAME 拉平",[17,4808,4809,4810,2629],{},"如果你需要分地区解析来让访客连接到最近的 CDN 节点，",[27,4811,4812],{},"务必避开 CNAME Flattening（CNAME 拉平）",[2324,4814,4816],{"id":4815},"什么是-cname-拉平","什么是 CNAME 拉平？",[17,4818,4819],{},"权威 DNS 服务器（如 Cloudflare）看到 CNAME 记录后，会主动查询目标域名的最终 IP 地址，然后直接返回 IP 而不是 CNAME。",[2324,4821,4823],{"id":4822},"为什么会出问题","为什么会出问题？",[17,4825,4826],{},"分地区解析（GeoDNS）在权威 DNS 服务器层面实现。当权威服务器执行 CNAME 拉平时，它会在自己的位置查询目标域名的 IP。如果权威 DNS 在美国，它获取的 IP 就是美国最优节点，然后把这个 IP 返回给所有地区的查询者，包括中国用户。这样，你为中国用户配置的国内 CDN IP 策略就完全失效了。",[38,4828,4830],{"className":40,"code":4829,"language":42,"meta":43,"style":43},"graph LR\n    subgraph \"启用 CNAME 拉平的问题\"\n        A[中国用户] --> B[Cloudflare 权威\u003Cbr/>美国节点]\n        B --> C[查询目标 CNAME]\n        C --> D[返回美国 CDN IP]\n        D --> A\n        style D fill:#ffcccc\n    end\n",[45,4831,4832,4837,4842,4847,4852,4857,4862,4867],{"__ignoreMap":43},[48,4833,4834],{"class":50,"line":51},[48,4835,4836],{},"graph LR\n",[48,4838,4839],{"class":50,"line":57},[48,4840,4841],{},"    subgraph \"启用 CNAME 拉平的问题\"\n",[48,4843,4844],{"class":50,"line":63},[48,4845,4846],{},"        A[中国用户] --> B[Cloudflare 权威\u003Cbr/>美国节点]\n",[48,4848,4849],{"class":50,"line":69},[48,4850,4851],{},"        B --> C[查询目标 CNAME]\n",[48,4853,4854],{"class":50,"line":75},[48,4855,4856],{},"        C --> D[返回美国 CDN IP]\n",[48,4858,4859],{"class":50,"line":3},[48,4860,4861],{},"        D --> A\n",[48,4863,4864],{"class":50,"line":86},[48,4865,4866],{},"        style D fill:#ffcccc\n",[48,4868,4869],{"class":50,"line":92},[48,4870,193],{},[2324,4872,4873],{"id":4873},"正确做法",[17,4875,4876,4877,4762,4879,4882],{},"老实使用 CNAME 指向另一个支持 GeoDNS 的域名（如 ",[45,4878,4480],{},[45,4880,4881],{},"cdn-cname.zhul.in","，后者在 DNSPod 上做分地区解析），才能保证分流策略正确执行。",[17,4884,4885,4886,4889],{},"如果需要分地区解析功能，",[27,4887,4888],{},"不要","在相关域名上启用 CNAME Flattening（或 ALIAS、ANAME 等类似功能）。",[2049,4891,4892],{},"html .default .shiki span {color: var(--shiki-default);background: var(--shiki-default-bg);font-style: var(--shiki-default-font-style);font-weight: var(--shiki-default-font-weight);text-decoration: var(--shiki-default-text-decoration);}html .shiki span {color: var(--shiki-default);background: var(--shiki-default-bg);font-style: var(--shiki-default-font-style);font-weight: var(--shiki-default-font-weight);text-decoration: var(--shiki-default-text-decoration);}html .dark .shiki span {color: var(--shiki-dark);background: var(--shiki-dark-bg);font-style: var(--shiki-dark-font-style);font-weight: var(--shiki-dark-font-weight);text-decoration: var(--shiki-dark-text-decoration);}html.dark .shiki span {color: var(--shiki-dark);background: var(--shiki-dark-bg);font-style: var(--shiki-dark-font-style);font-weight: var(--shiki-dark-font-weight);text-decoration: var(--shiki-dark-text-decoration);}html pre.shiki code .s5ixo, html code.shiki .s5ixo{--shiki-default:#383A42;--shiki-dark:#ABB2BF}html pre.shiki code .sJa8x, html code.shiki .sJa8x{--shiki-default:#E45649;--shiki-dark:#E06C75}html pre.shiki code .sAGMh, html code.shiki .sAGMh{--shiki-default:#986801;--shiki-dark:#D19A66}html pre.shiki code .sDhpE, html code.shiki .sDhpE{--shiki-default:#50A14F;--shiki-dark:#98C379}",{"title":43,"searchDepth":57,"depth":57,"links":4894},[4895,4896,4897,4902,4903,4904],{"id":4459,"depth":57,"text":4460},{"id":4473,"depth":57,"text":4474},{"id":4589,"depth":57,"text":4589,"children":4898},[4899,4900,4901],{"id":4595,"depth":63,"text":4596},{"id":4642,"depth":63,"text":4643},{"id":4652,"depth":63,"text":4653},{"id":4772,"depth":57,"text":4772},{"id":4778,"depth":57,"text":4778},{"id":4805,"depth":57,"text":4806,"children":4905},[4906,4907,4908],{"id":4815,"depth":63,"text":4816},{"id":4822,"depth":63,"text":4823},{"id":4873,"depth":63,"text":4873},{"title":4910,"date":4911,"path":4912,"tags":4913,"body":4919},"Vue Markdown 渲染优化实战(下)：告别 DOM 操作，拥抱 AST 与函数式渲染","2025-07-13 00:01:35","/2025/07/13/vue-markdown-render-improvement-2",[4914,4915,4916,2831,4917,4918],"Vue.js","Markdown","AST","Web","unified",{"type":14,"value":4920,"toc":6795},[4921,4929,4943,4946,4949,4952,4962,4972,4976,4985,5002,5012,5015,5030,5034,5055,5058,5062,5072,5102,5106,5109,5128,5131,5295,5298,5535,5539,5546,5558,5561,6186,6190,6197,6526,6529,6643,6647,6650,6755,6759,6762,6786,6789,6792],[254,4922,4924,4925,4928],{"id":4923},"上回回顾当-morphdom-遇上-vue","上回回顾：当 ",[45,4926,4927],{},"morphdom"," 遇上 Vue",[17,4930,19,4931,4935,4936,4939,4940,4942],{},[21,4932,4934],{"href":4933},"/2025/07/12/vue-markdown-render-improvement-1/","上一篇文章","中，我们经历了一场 Markdown 渲染的性能优化之旅。从最原始的 ",[45,4937,4938],{},"v-html"," 全量刷新，到按块更新，最终我们请出了 ",[45,4941,4927],{}," 这个“终极武器”。它通过直接比对和操作真实 DOM，以最小的代价更新视图，完美解决了实时渲染中的性能瓶颈和交互状态丢失问题。",[17,4944,4945],{},"然而，一个根本性问题始终存在：在 Vue 的地盘里，绕过 Vue 的虚拟 DOM (Virtual DOM) 和 Diff 算法，直接用一个第三方库去“动刀”真实 DOM，总感觉有些“旁门左道”。这就像在一个精密的自动化工厂里，引入了一个老师傅拿着锤子和扳手进行手动修补。虽然活干得漂亮，但总觉得破坏了原有的工作流，不够“Vue”。",[17,4947,4948],{},"那么，有没有一种更优雅、更“原生”的方式，让我们既能享受精准更新的快感，又能完全融入 Vue 的生态体系呢？",[17,4950,4951],{},"带着这个问题，我询问了前端群里的伙伴们。",[2558,4953,4954],{},[17,4955,4956,4957],{},"如果就要做一个渲染器，你这个思路不是最佳实践。每次更新时，你都生成全量的虚拟 HTML，然后再对 HTML 做减法来优化性能。然而，每次更新的增量部分是明确的，为什么不直接用这部分增量去做加法？增量部分通过 markdown-it 的库无法直接获取，但更好的做法是在这一步进行改造：先解析 Markdown 的结构，再利用 Vue 的动态渲染能力生成 DOM。这样，DOM 的复用就可以借助 Vue 自身的能力来实现。—— ",[21,4958,4961],{"href":4959,"rel":4960},"https://site.j10c.cc/",[2036],"j10c",[2558,4963,4964],{},[17,4965,4966,4967],{},"可以用 unified 结合 remark-parse 插件，将 markdown 字符串解析为 ast，然后根据 ast 使用 render func 进行渲染即可。—— bii & ",[21,4968,4971],{"href":4969,"rel":4970},"https://github.com/nekomeowww",[2036],"nekomeowww",[254,4973,4975],{"id":4974},"新思路从字符串转换到结构化渲染","新思路：从“字符串转换”到“结构化渲染”",[17,4977,4978,4979,4981,4982,4984],{},"我们之前的方案，无论是 ",[45,4980,4938],{}," 还是 ",[45,4983,4927],{},"，其核心思路都是：",[17,4986,4987,4762,4990,4762,4993,4762,4996,4762,4999],{},[45,4988,4989],{},"Markdown 字符串",[45,4991,4992],{},"markdown-it",[45,4994,4995],{},"HTML 字符串",[45,4997,4998],{},"浏览器/morphdom",[45,5000,5001],{},"DOM",[17,5003,5004,5005,5007,5008,5011],{},"这条链路的问题在于，从 ",[45,5006,4995],{}," 这一步开始，我们就丢失了 Markdown 的",[27,5009,5010],{},"原始结构信息","。我们得到的是一堆非结构化的文本，Vue 无法理解其内在逻辑，只能将其囫囵吞下。",[17,5013,5014],{},"而新的思路则是将流程改造为：",[17,5016,5017,4762,5019,4762,5022,4762,5025,4762,5028],{},[45,5018,4989],{},[45,5020,5021],{},"AST (抽象语法树)",[45,5023,5024],{},"Vue VNodes (虚拟节点)",[45,5026,5027],{},"Vue",[45,5029,5001],{},[2324,5031,5033],{"id":5032},"什么是-ast","什么是 AST？",[17,5035,5036,5039,5040,5043,5044,5047,5048,5051,5052,2629],{},[27,5037,5038],{},"AST (Abstract Syntax Tree)"," ，即抽象语法树，是源代码或标记语言的结构化表示。它将一长串的文本，解析成一个层级分明的树状对象。对于 Markdown 来说，一个一级标题会变成一个 ",[45,5041,5042],{},"type: 'heading', depth: 1"," 的节点，一个段落会变成一个 ",[45,5045,5046],{},"type: 'paragraph'"," 的节点，而段落里的文字，则是 ",[45,5049,5050],{},"paragraph"," 节点的 ",[45,5053,5054],{},"children",[17,5056,5057],{},"一旦我们将 Markdown 转换成 AST，就相当于拥有了整个文档的“结构图纸”。我们不再是面对一堆模糊的 HTML 字符串，而是面对一个清晰、可编程的 JavaScript 对象。",[2324,5059,5061],{"id":5060},"我们的新工具unified-与-remark","我们的新工具：unified 与 remark",[17,5063,5064,5065,5068,5069,5071],{},"为了实现 ",[45,5066,5067],{},"Markdown -> AST"," 的转换，我们引入 ",[45,5070,4918],{}," 生态。",[343,5073,5074,5083],{},[346,5075,5076,5082],{},[27,5077,5078],{},[21,5079,4918],{"href":5080,"rel":5081},"https://github.com/unifiedjs/unified",[2036],": 一个强大的内容处理引擎。你可以把它想象成一条流水线，原始文本是原料，通过添加不同的“插件”来对它进行解析、转换和序列化。",[346,5084,5085,5092,5093,5095,5096,5101],{},[27,5086,5087],{},[21,5088,5091],{"href":5089,"rel":5090},"https://github.com/remarkjs/remark",[2036],"remark-parse",": 一个 ",[45,5094,4918],{}," 插件，专门负责将 Markdown 文本解析成 AST（具体来说是 ",[21,5097,5100],{"href":5098,"rel":5099},"https://github.com/syntax-tree/mdast",[2036],"mdast"," 格式）。",[254,5103,5105],{"id":5104},"第一步将-markdown-解析为-ast","第一步：将 Markdown 解析为 AST",[17,5107,5108],{},"首先，我们需要安装相关依赖：",[38,5110,5112],{"className":273,"code":5111,"language":275,"meta":43,"style":43},"npm install unified remark-parse\n",[45,5113,5114],{"__ignoreMap":43},[48,5115,5116,5119,5122,5125],{"class":50,"line":51},[48,5117,5118],{"class":282},"npm",[48,5120,5121],{"class":285}," install",[48,5123,5124],{"class":285}," unified",[48,5126,5127],{"class":285}," remark-parse\n",[17,5129,5130],{},"然后，我们可以轻松地将 Markdown 字符串转换为 AST：",[38,5132,5136],{"className":5133,"code":5134,"language":5135,"meta":43,"style":43},"language-javascript shiki shiki-themes one-light one-dark-pro","import { unified } from 'unified'\nimport remarkParse from 'remark-parse'\n\nconst markdownContent = '# Hello, AST!\\n\\nThis is a paragraph.'\n\n// 创建一个处理器实例\nconst processor = unified().use(remarkParse)\n\n// 解析 Markdown 内容\nconst ast = processor.parse(markdownContent)\n\nconsole.log(JSON.stringify(ast, null, 2))\n","javascript",[45,5137,5138,5155,5168,5172,5190,5194,5199,5223,5227,5232,5255,5259],{"__ignoreMap":43},[48,5139,5140,5143,5145,5147,5149,5152],{"class":50,"line":51},[48,5141,5142],{"class":645},"import",[48,5144,3019],{"class":447},[48,5146,4918],{"class":396},[48,5148,3106],{"class":447},[48,5150,5151],{"class":645},"from",[48,5153,5154],{"class":285}," 'unified'\n",[48,5156,5157,5159,5162,5165],{"class":50,"line":57},[48,5158,5142],{"class":645},[48,5160,5161],{"class":396}," remarkParse",[48,5163,5164],{"class":645}," from",[48,5166,5167],{"class":285}," 'remark-parse'\n",[48,5169,5170],{"class":50,"line":63},[48,5171,96],{"emptyLinePlaceholder":95},[48,5173,5174,5176,5179,5181,5184,5187],{"class":50,"line":69},[48,5175,2935],{"class":645},[48,5177,5178],{"class":2938}," markdownContent",[48,5180,2942],{"class":549},[48,5182,5183],{"class":285}," '# Hello, AST!",[48,5185,5186],{"class":549},"\\n\\n",[48,5188,5189],{"class":285},"This is a paragraph.'\n",[48,5191,5192],{"class":50,"line":75},[48,5193,96],{"emptyLinePlaceholder":95},[48,5195,5196],{"class":50,"line":3},[48,5197,5198],{"class":376},"// 创建一个处理器实例\n",[48,5200,5201,5203,5206,5208,5210,5213,5216,5218,5221],{"class":50,"line":86},[48,5202,2935],{"class":645},[48,5204,5205],{"class":2938}," processor",[48,5207,2942],{"class":549},[48,5209,5124],{"class":282},[48,5211,5212],{"class":447},"().",[48,5214,5215],{"class":282},"use",[48,5217,448],{"class":447},[48,5219,5220],{"class":3026},"remarkParse",[48,5222,487],{"class":447},[48,5224,5225],{"class":50,"line":92},[48,5226,96],{"emptyLinePlaceholder":95},[48,5228,5229],{"class":50,"line":99},[48,5230,5231],{"class":376},"// 解析 Markdown 内容\n",[48,5233,5234,5236,5239,5241,5243,5245,5248,5250,5253],{"class":50,"line":105},[48,5235,2935],{"class":645},[48,5237,5238],{"class":2938}," ast",[48,5240,2942],{"class":549},[48,5242,5205],{"class":2950},[48,5244,1052],{"class":447},[48,5246,5247],{"class":282},"parse",[48,5249,448],{"class":447},[48,5251,5252],{"class":3026},"markdownContent",[48,5254,487],{"class":447},[48,5256,5257],{"class":50,"line":110},[48,5258,96],{"emptyLinePlaceholder":95},[48,5260,5261,5264,5266,5269,5271,5274,5276,5279,5281,5284,5286,5289,5291,5293],{"class":50,"line":116},[48,5262,5263],{"class":2950},"console",[48,5265,1052],{"class":447},[48,5267,5268],{"class":282},"log",[48,5270,448],{"class":447},[48,5272,5273],{"class":2938},"JSON",[48,5275,1052],{"class":447},[48,5277,5278],{"class":282},"stringify",[48,5280,448],{"class":447},[48,5282,5283],{"class":3026},"ast",[48,5285,3159],{"class":447},[48,5287,5288],{"class":958},"null",[48,5290,3159],{"class":447},[48,5292,1139],{"class":958},[48,5294,1394],{"class":447},[17,5296,5297],{},"运行以上代码，我们将得到一个如下所示的 JSON 对象，这就是我们梦寐以求的 AST：",[38,5299,5303],{"className":5300,"code":5301,"language":5302,"meta":43,"style":43},"language-json shiki shiki-themes one-light one-dark-pro","{\n  \"type\": \"root\",\n  \"children\": [\n    {\n      \"type\": \"heading\",\n      \"depth\": 1,\n      \"children\": [\n        {\n          \"type\": \"text\",\n          \"value\": \"Hello, AST!\",\n          \"position\": { ... }\n        }\n      ],\n      \"position\": { ... }\n    },\n    {\n      \"type\": \"paragraph\",\n      \"children\": [\n        {\n          \"type\": \"text\",\n          \"value\": \"This is a paragraph.\",\n          \"position\": { ... }\n        }\n      ],\n      \"position\": { ... }\n    }\n  ],\n  \"position\": { ... }\n}\n","json",[45,5304,5305,5310,5324,5332,5337,5349,5360,5367,5372,5384,5396,5410,5415,5420,5431,5436,5440,5451,5457,5461,5471,5482,5492,5496,5500,5510,5515,5520,5531],{"__ignoreMap":43},[48,5306,5307],{"class":50,"line":51},[48,5308,5309],{"class":447},"{\n",[48,5311,5312,5315,5318,5321],{"class":50,"line":57},[48,5313,5314],{"class":396},"  \"type\"",[48,5316,5317],{"class":447},": ",[48,5319,5320],{"class":285},"\"root\"",[48,5322,5323],{"class":447},",\n",[48,5325,5326,5329],{"class":50,"line":63},[48,5327,5328],{"class":396},"  \"children\"",[48,5330,5331],{"class":447},": [\n",[48,5333,5334],{"class":50,"line":69},[48,5335,5336],{"class":447},"    {\n",[48,5338,5339,5342,5344,5347],{"class":50,"line":75},[48,5340,5341],{"class":396},"      \"type\"",[48,5343,5317],{"class":447},[48,5345,5346],{"class":285},"\"heading\"",[48,5348,5323],{"class":447},[48,5350,5351,5354,5356,5358],{"class":50,"line":3},[48,5352,5353],{"class":396},"      \"depth\"",[48,5355,5317],{"class":447},[48,5357,959],{"class":958},[48,5359,5323],{"class":447},[48,5361,5362,5365],{"class":50,"line":86},[48,5363,5364],{"class":396},"      \"children\"",[48,5366,5331],{"class":447},[48,5368,5369],{"class":50,"line":92},[48,5370,5371],{"class":447},"        {\n",[48,5373,5374,5377,5379,5382],{"class":50,"line":99},[48,5375,5376],{"class":396},"          \"type\"",[48,5378,5317],{"class":447},[48,5380,5381],{"class":285},"\"text\"",[48,5383,5323],{"class":447},[48,5385,5386,5389,5391,5394],{"class":50,"line":105},[48,5387,5388],{"class":396},"          \"value\"",[48,5390,5317],{"class":447},[48,5392,5393],{"class":285},"\"Hello, AST!\"",[48,5395,5323],{"class":447},[48,5397,5398,5401,5404,5407],{"class":50,"line":110},[48,5399,5400],{"class":396},"          \"position\"",[48,5402,5403],{"class":447},": { ",[48,5405,357],{"class":5406},"sUNH4",[48,5408,5409],{"class":447}," }\n",[48,5411,5412],{"class":50,"line":116},[48,5413,5414],{"class":447},"        }\n",[48,5416,5417],{"class":50,"line":122},[48,5418,5419],{"class":447},"      ],\n",[48,5421,5422,5425,5427,5429],{"class":50,"line":127},[48,5423,5424],{"class":396},"      \"position\"",[48,5426,5403],{"class":447},[48,5428,357],{"class":5406},[48,5430,5409],{"class":447},[48,5432,5433],{"class":50,"line":133},[48,5434,5435],{"class":447},"    },\n",[48,5437,5438],{"class":50,"line":139},[48,5439,5336],{"class":447},[48,5441,5442,5444,5446,5449],{"class":50,"line":144},[48,5443,5341],{"class":396},[48,5445,5317],{"class":447},[48,5447,5448],{"class":285},"\"paragraph\"",[48,5450,5323],{"class":447},[48,5452,5453,5455],{"class":50,"line":150},[48,5454,5364],{"class":396},[48,5456,5331],{"class":447},[48,5458,5459],{"class":50,"line":156},[48,5460,5371],{"class":447},[48,5462,5463,5465,5467,5469],{"class":50,"line":162},[48,5464,5376],{"class":396},[48,5466,5317],{"class":447},[48,5468,5381],{"class":285},[48,5470,5323],{"class":447},[48,5472,5473,5475,5477,5480],{"class":50,"line":168},[48,5474,5388],{"class":396},[48,5476,5317],{"class":447},[48,5478,5479],{"class":285},"\"This is a paragraph.\"",[48,5481,5323],{"class":447},[48,5483,5484,5486,5488,5490],{"class":50,"line":173},[48,5485,5400],{"class":396},[48,5487,5403],{"class":447},[48,5489,357],{"class":5406},[48,5491,5409],{"class":447},[48,5493,5494],{"class":50,"line":179},[48,5495,5414],{"class":447},[48,5497,5498],{"class":50,"line":184},[48,5499,5419],{"class":447},[48,5501,5502,5504,5506,5508],{"class":50,"line":190},[48,5503,5424],{"class":396},[48,5505,5403],{"class":447},[48,5507,357],{"class":5406},[48,5509,5409],{"class":447},[48,5511,5512],{"class":50,"line":196},[48,5513,5514],{"class":447},"    }\n",[48,5516,5517],{"class":50,"line":202},[48,5518,5519],{"class":447},"  ],\n",[48,5521,5522,5525,5527,5529],{"class":50,"line":207},[48,5523,5524],{"class":396},"  \"position\"",[48,5526,5403],{"class":447},[48,5528,357],{"class":5406},[48,5530,5409],{"class":447},[48,5532,5533],{"class":50,"line":213},[48,5534,860],{"class":447},[254,5536,5538],{"id":5537},"第二步从-ast-到-vue-vnodes","第二步：从 AST 到 Vue VNodes",[17,5540,5541,5542,5545],{},"拿到了 AST，下一步就是将这个“结构图纸”真正地“施工”成用户可见的界面。在 Vue 的世界里，描述 UI 的蓝图就是虚拟节点 (VNode)，而 ",[45,5543,5544],{},"h()"," 函数（即 hyperscript）就是创建 VNode 的画笔。",[17,5547,5548,5549,3159,5552,3159,5554,5557],{},"我们的任务是编写一个渲染函数，它能够递归地遍历 AST，并为每一种节点类型（",[45,5550,5551],{},"heading",[45,5553,5050],{},[45,5555,5556],{},"text"," 等）生成对应的 VNode。",[17,5559,5560],{},"下面是一个简单的渲染函数实现：",[38,5562,5564],{"className":5133,"code":5563,"language":5135,"meta":43,"style":43},"function renderAst(node) {\n  if (!node) return null\n  switch (node.type) {\n    case 'root':\n      return h('div', {}, node.children.map(renderAst))\n    case 'paragraph':\n      return h('p', {}, node.children.map(renderAst))\n    case 'text':\n      return node.value\n    case 'emphasis':\n      return h('em', {}, node.children.map(renderAst))\n    case 'strong':\n      return h('strong', {}, node.children.map(renderAst))\n    case 'inlineCode':\n      return h('code', {}, node.value)\n    case 'heading':\n      return h('h' + node.depth, {}, node.children.map(renderAst))\n    case 'code':\n      return h('pre', {}, [h('code', {}, node.value)])\n    case 'list':\n      return h(node.ordered ? 'ol' : 'ul', {}, node.children.map(renderAst))\n    case 'listItem':\n      return h('li', {}, node.children.map(renderAst))\n    case 'thematicBreak':\n      return h('hr')\n    case 'blockquote':\n      return h('blockquote', {}, node.children.map(renderAst))\n    case 'link':\n      return h('a', { href: node.url, target: '_blank' }, node.children.map(renderAst))\n    default:\n      // 其它未实现类型\n      return h('span', { }, `[${node.type}]`)\n  }\n}\n",[45,5565,5566,5581,5603,5619,5630,5663,5672,5701,5710,5722,5731,5760,5769,5798,5807,5828,5837,5875,5884,5917,5926,5971,5980,6009,6018,6031,6040,6069,6078,6133,6140,6145,6177,6182],{"__ignoreMap":43},[48,5567,5568,5570,5573,5575,5578],{"class":50,"line":51},[48,5569,646],{"class":645},[48,5571,5572],{"class":282}," renderAst",[48,5574,448],{"class":447},[48,5576,5577],{"class":671},"node",[48,5579,5580],{"class":447},") {\n",[48,5582,5583,5586,5589,5592,5594,5597,5600],{"class":50,"line":57},[48,5584,5585],{"class":645},"  if",[48,5587,5588],{"class":447}," (",[48,5590,5591],{"class":549},"!",[48,5593,5577],{"class":3026},[48,5595,5596],{"class":447},") ",[48,5598,5599],{"class":645},"return",[48,5601,5602],{"class":958}," null\n",[48,5604,5605,5608,5610,5612,5614,5617],{"class":50,"line":63},[48,5606,5607],{"class":645},"  switch",[48,5609,5588],{"class":447},[48,5611,5577],{"class":2950},[48,5613,1052],{"class":447},[48,5615,5616],{"class":396},"type",[48,5618,5580],{"class":447},[48,5620,5621,5624,5627],{"class":50,"line":69},[48,5622,5623],{"class":645},"    case",[48,5625,5626],{"class":285}," 'root'",[48,5628,5629],{"class":447},":\n",[48,5631,5632,5635,5638,5640,5643,5646,5648,5650,5652,5654,5656,5658,5661],{"class":50,"line":75},[48,5633,5634],{"class":645},"      return",[48,5636,5637],{"class":282}," h",[48,5639,448],{"class":447},[48,5641,5642],{"class":285},"'div'",[48,5644,5645],{"class":447},", {}, ",[48,5647,5577],{"class":2950},[48,5649,1052],{"class":447},[48,5651,5054],{"class":2956},[48,5653,1052],{"class":447},[48,5655,3467],{"class":282},[48,5657,448],{"class":447},[48,5659,5660],{"class":3026},"renderAst",[48,5662,1394],{"class":447},[48,5664,5665,5667,5670],{"class":50,"line":3},[48,5666,5623],{"class":645},[48,5668,5669],{"class":285}," 'paragraph'",[48,5671,5629],{"class":447},[48,5673,5674,5676,5678,5680,5683,5685,5687,5689,5691,5693,5695,5697,5699],{"class":50,"line":86},[48,5675,5634],{"class":645},[48,5677,5637],{"class":282},[48,5679,448],{"class":447},[48,5681,5682],{"class":285},"'p'",[48,5684,5645],{"class":447},[48,5686,5577],{"class":2950},[48,5688,1052],{"class":447},[48,5690,5054],{"class":2956},[48,5692,1052],{"class":447},[48,5694,3467],{"class":282},[48,5696,448],{"class":447},[48,5698,5660],{"class":3026},[48,5700,1394],{"class":447},[48,5702,5703,5705,5708],{"class":50,"line":92},[48,5704,5623],{"class":645},[48,5706,5707],{"class":285}," 'text'",[48,5709,5629],{"class":447},[48,5711,5712,5714,5717,5719],{"class":50,"line":99},[48,5713,5634],{"class":645},[48,5715,5716],{"class":2950}," node",[48,5718,1052],{"class":447},[48,5720,5721],{"class":396},"value\n",[48,5723,5724,5726,5729],{"class":50,"line":105},[48,5725,5623],{"class":645},[48,5727,5728],{"class":285}," 'emphasis'",[48,5730,5629],{"class":447},[48,5732,5733,5735,5737,5739,5742,5744,5746,5748,5750,5752,5754,5756,5758],{"class":50,"line":110},[48,5734,5634],{"class":645},[48,5736,5637],{"class":282},[48,5738,448],{"class":447},[48,5740,5741],{"class":285},"'em'",[48,5743,5645],{"class":447},[48,5745,5577],{"class":2950},[48,5747,1052],{"class":447},[48,5749,5054],{"class":2956},[48,5751,1052],{"class":447},[48,5753,3467],{"class":282},[48,5755,448],{"class":447},[48,5757,5660],{"class":3026},[48,5759,1394],{"class":447},[48,5761,5762,5764,5767],{"class":50,"line":116},[48,5763,5623],{"class":645},[48,5765,5766],{"class":285}," 'strong'",[48,5768,5629],{"class":447},[48,5770,5771,5773,5775,5777,5780,5782,5784,5786,5788,5790,5792,5794,5796],{"class":50,"line":122},[48,5772,5634],{"class":645},[48,5774,5637],{"class":282},[48,5776,448],{"class":447},[48,5778,5779],{"class":285},"'strong'",[48,5781,5645],{"class":447},[48,5783,5577],{"class":2950},[48,5785,1052],{"class":447},[48,5787,5054],{"class":2956},[48,5789,1052],{"class":447},[48,5791,3467],{"class":282},[48,5793,448],{"class":447},[48,5795,5660],{"class":3026},[48,5797,1394],{"class":447},[48,5799,5800,5802,5805],{"class":50,"line":127},[48,5801,5623],{"class":645},[48,5803,5804],{"class":285}," 'inlineCode'",[48,5806,5629],{"class":447},[48,5808,5809,5811,5813,5815,5818,5820,5822,5824,5826],{"class":50,"line":133},[48,5810,5634],{"class":645},[48,5812,5637],{"class":282},[48,5814,448],{"class":447},[48,5816,5817],{"class":285},"'code'",[48,5819,5645],{"class":447},[48,5821,5577],{"class":2950},[48,5823,1052],{"class":447},[48,5825,3435],{"class":396},[48,5827,487],{"class":447},[48,5829,5830,5832,5835],{"class":50,"line":139},[48,5831,5623],{"class":645},[48,5833,5834],{"class":285}," 'heading'",[48,5836,5629],{"class":447},[48,5838,5839,5841,5843,5845,5848,5850,5852,5854,5857,5859,5861,5863,5865,5867,5869,5871,5873],{"class":50,"line":144},[48,5840,5634],{"class":645},[48,5842,5637],{"class":282},[48,5844,448],{"class":447},[48,5846,5847],{"class":285},"'h'",[48,5849,1388],{"class":549},[48,5851,5716],{"class":2950},[48,5853,1052],{"class":447},[48,5855,5856],{"class":396},"depth",[48,5858,5645],{"class":447},[48,5860,5577],{"class":2950},[48,5862,1052],{"class":447},[48,5864,5054],{"class":2956},[48,5866,1052],{"class":447},[48,5868,3467],{"class":282},[48,5870,448],{"class":447},[48,5872,5660],{"class":3026},[48,5874,1394],{"class":447},[48,5876,5877,5879,5882],{"class":50,"line":150},[48,5878,5623],{"class":645},[48,5880,5881],{"class":285}," 'code'",[48,5883,5629],{"class":447},[48,5885,5886,5888,5890,5892,5895,5898,5901,5903,5905,5907,5909,5911,5914],{"class":50,"line":156},[48,5887,5634],{"class":645},[48,5889,5637],{"class":282},[48,5891,448],{"class":447},[48,5893,5894],{"class":285},"'pre'",[48,5896,5897],{"class":447},", {}, [",[48,5899,5900],{"class":282},"h",[48,5902,448],{"class":447},[48,5904,5817],{"class":285},[48,5906,5645],{"class":447},[48,5908,5577],{"class":2950},[48,5910,1052],{"class":447},[48,5912,3435],{"class":5913},"sj4iG",[48,5915,5916],{"class":447},")])\n",[48,5918,5919,5921,5924],{"class":50,"line":162},[48,5920,5623],{"class":645},[48,5922,5923],{"class":285}," 'list'",[48,5925,5629],{"class":447},[48,5927,5928,5930,5932,5934,5936,5938,5941,5944,5947,5950,5953,5955,5957,5959,5961,5963,5965,5967,5969],{"class":50,"line":168},[48,5929,5634],{"class":645},[48,5931,5637],{"class":282},[48,5933,448],{"class":447},[48,5935,5577],{"class":2950},[48,5937,1052],{"class":447},[48,5939,5940],{"class":396},"ordered",[48,5942,5943],{"class":3453}," ?",[48,5945,5946],{"class":285}," 'ol'",[48,5948,5949],{"class":3453}," :",[48,5951,5952],{"class":285}," 'ul'",[48,5954,5645],{"class":447},[48,5956,5577],{"class":2950},[48,5958,1052],{"class":447},[48,5960,5054],{"class":2956},[48,5962,1052],{"class":447},[48,5964,3467],{"class":282},[48,5966,448],{"class":447},[48,5968,5660],{"class":3026},[48,5970,1394],{"class":447},[48,5972,5973,5975,5978],{"class":50,"line":173},[48,5974,5623],{"class":645},[48,5976,5977],{"class":285}," 'listItem'",[48,5979,5629],{"class":447},[48,5981,5982,5984,5986,5988,5991,5993,5995,5997,5999,6001,6003,6005,6007],{"class":50,"line":179},[48,5983,5634],{"class":645},[48,5985,5637],{"class":282},[48,5987,448],{"class":447},[48,5989,5990],{"class":285},"'li'",[48,5992,5645],{"class":447},[48,5994,5577],{"class":2950},[48,5996,1052],{"class":447},[48,5998,5054],{"class":2956},[48,6000,1052],{"class":447},[48,6002,3467],{"class":282},[48,6004,448],{"class":447},[48,6006,5660],{"class":3026},[48,6008,1394],{"class":447},[48,6010,6011,6013,6016],{"class":50,"line":184},[48,6012,5623],{"class":645},[48,6014,6015],{"class":285}," 'thematicBreak'",[48,6017,5629],{"class":447},[48,6019,6020,6022,6024,6026,6029],{"class":50,"line":190},[48,6021,5634],{"class":645},[48,6023,5637],{"class":282},[48,6025,448],{"class":447},[48,6027,6028],{"class":285},"'hr'",[48,6030,487],{"class":447},[48,6032,6033,6035,6038],{"class":50,"line":196},[48,6034,5623],{"class":645},[48,6036,6037],{"class":285}," 'blockquote'",[48,6039,5629],{"class":447},[48,6041,6042,6044,6046,6048,6051,6053,6055,6057,6059,6061,6063,6065,6067],{"class":50,"line":202},[48,6043,5634],{"class":645},[48,6045,5637],{"class":282},[48,6047,448],{"class":447},[48,6049,6050],{"class":285},"'blockquote'",[48,6052,5645],{"class":447},[48,6054,5577],{"class":2950},[48,6056,1052],{"class":447},[48,6058,5054],{"class":2956},[48,6060,1052],{"class":447},[48,6062,3467],{"class":282},[48,6064,448],{"class":447},[48,6066,5660],{"class":3026},[48,6068,1394],{"class":447},[48,6070,6071,6073,6076],{"class":50,"line":207},[48,6072,5623],{"class":645},[48,6074,6075],{"class":285}," 'link'",[48,6077,5629],{"class":447},[48,6079,6080,6082,6084,6086,6089,6092,6095,6097,6099,6101,6104,6106,6109,6111,6114,6117,6119,6121,6123,6125,6127,6129,6131],{"class":50,"line":213},[48,6081,5634],{"class":645},[48,6083,5637],{"class":282},[48,6085,448],{"class":447},[48,6087,6088],{"class":285},"'a'",[48,6090,6091],{"class":447},", { ",[48,6093,6094],{"class":396},"href",[48,6096,3016],{"class":3015},[48,6098,5716],{"class":2950},[48,6100,1052],{"class":447},[48,6102,6103],{"class":396},"url",[48,6105,3159],{"class":447},[48,6107,6108],{"class":396},"target",[48,6110,3016],{"class":3015},[48,6112,6113],{"class":285}," '_blank'",[48,6115,6116],{"class":447}," }, ",[48,6118,5577],{"class":2950},[48,6120,1052],{"class":447},[48,6122,5054],{"class":2956},[48,6124,1052],{"class":447},[48,6126,3467],{"class":282},[48,6128,448],{"class":447},[48,6130,5660],{"class":3026},[48,6132,1394],{"class":447},[48,6134,6135,6138],{"class":50,"line":219},[48,6136,6137],{"class":645},"    default",[48,6139,5629],{"class":447},[48,6141,6142],{"class":50,"line":224},[48,6143,6144],{"class":376},"      // 其它未实现类型\n",[48,6146,6147,6149,6151,6153,6156,6159,6162,6164,6166,6168,6170,6172,6175],{"class":50,"line":230},[48,6148,5634],{"class":645},[48,6150,5637],{"class":282},[48,6152,448],{"class":447},[48,6154,6155],{"class":285},"'span'",[48,6157,6158],{"class":447},", { }, ",[48,6160,6161],{"class":285},"`[",[48,6163,694],{"class":3121},[48,6165,5577],{"class":2950},[48,6167,1052],{"class":3298},[48,6169,5616],{"class":396},[48,6171,700],{"class":3121},[48,6173,6174],{"class":285},"]`",[48,6176,487],{"class":447},[48,6178,6179],{"class":50,"line":235},[48,6180,6181],{"class":447},"  }\n",[48,6183,6184],{"class":50,"line":241},[48,6185,860],{"class":447},[254,6187,6189],{"id":6188},"第三步封装-vue-组件","第三步：封装 Vue 组件",[17,6191,6192,6193,6196],{},"整合上述逻辑，我们可以构建一个 Vue 组件。鉴于直接生成 VNode 的特性，采用函数式组件或显式 ",[45,6194,6195],{},"render"," 函数最为适宜。",[38,6198,6202],{"className":6199,"code":6200,"language":6201,"meta":43,"style":43},"language-vue shiki shiki-themes one-light one-dark-pro","\u003Ctemplate>\n  \u003Ccomponent :is=\"VNodeTree\" />\n\u003C/template>\n\n\u003Cscript setup>\nimport { computed, h, shallowRef, watchEffect } from 'vue'\nimport { unified } from 'unified'\nimport remarkParse from 'remark-parse'\n\nconst props = defineProps({\n  mdText: {\n    type: String,\n    default: ''\n  }\n})\n\nconst ast = shallowRef(null)\nconst parser = unified().use(remarkParse)\n\nwatchEffect(() => {\n  ast.value = parser.parse(props.mdText)\n})\n\n// AST 渲染函数 (同上文 renderAst 函数)\nfunction renderAst(node) { ... }\n\nconst VNodeTree = computed(() => renderAst(ast.value))\n\n\u003C/script>\n","vue",[45,6203,6204,6213,6232,6241,6245,6257,6287,6301,6311,6315,6330,6339,6351,6360,6364,6368,6372,6389,6410,6414,6424,6453,6457,6461,6466,6483,6487,6514,6518],{"__ignoreMap":43},[48,6205,6206,6208,6211],{"class":50,"line":51},[48,6207,3393],{"class":447},[48,6209,6210],{"class":396},"template",[48,6212,4636],{"class":447},[48,6214,6215,6218,6221,6224,6226,6229],{"class":50,"line":57},[48,6216,6217],{"class":447},"  \u003C",[48,6219,6220],{"class":396},"component",[48,6222,6223],{"class":958}," :is",[48,6225,401],{"class":447},[48,6227,6228],{"class":285},"\"VNodeTree\"",[48,6230,6231],{"class":447}," />\n",[48,6233,6234,6237,6239],{"class":50,"line":63},[48,6235,6236],{"class":447},"\u003C/",[48,6238,6210],{"class":396},[48,6240,4636],{"class":447},[48,6242,6243],{"class":50,"line":69},[48,6244,96],{"emptyLinePlaceholder":95},[48,6246,6247,6249,6252,6255],{"class":50,"line":75},[48,6248,3393],{"class":447},[48,6250,6251],{"class":396},"script",[48,6253,6254],{"class":958}," setup",[48,6256,4636],{"class":447},[48,6258,6259,6261,6263,6266,6268,6270,6272,6275,6277,6280,6282,6284],{"class":50,"line":3},[48,6260,5142],{"class":645},[48,6262,3019],{"class":447},[48,6264,6265],{"class":396},"computed",[48,6267,3159],{"class":447},[48,6269,5900],{"class":396},[48,6271,3159],{"class":447},[48,6273,6274],{"class":396},"shallowRef",[48,6276,3159],{"class":447},[48,6278,6279],{"class":396},"watchEffect",[48,6281,3106],{"class":447},[48,6283,5151],{"class":645},[48,6285,6286],{"class":285}," 'vue'\n",[48,6288,6289,6291,6293,6295,6297,6299],{"class":50,"line":86},[48,6290,5142],{"class":645},[48,6292,3019],{"class":447},[48,6294,4918],{"class":396},[48,6296,3106],{"class":447},[48,6298,5151],{"class":645},[48,6300,5154],{"class":285},[48,6302,6303,6305,6307,6309],{"class":50,"line":92},[48,6304,5142],{"class":645},[48,6306,5161],{"class":396},[48,6308,5164],{"class":645},[48,6310,5167],{"class":285},[48,6312,6313],{"class":50,"line":99},[48,6314,96],{"emptyLinePlaceholder":95},[48,6316,6317,6319,6322,6324,6327],{"class":50,"line":105},[48,6318,2935],{"class":645},[48,6320,6321],{"class":2938}," props",[48,6323,2942],{"class":549},[48,6325,6326],{"class":282}," defineProps",[48,6328,6329],{"class":447},"({\n",[48,6331,6332,6335,6337],{"class":50,"line":110},[48,6333,6334],{"class":396},"  mdText",[48,6336,3016],{"class":3015},[48,6338,652],{"class":447},[48,6340,6341,6344,6346,6349],{"class":50,"line":116},[48,6342,6343],{"class":396},"    type",[48,6345,3016],{"class":3015},[48,6347,6348],{"class":3026}," String",[48,6350,5323],{"class":447},[48,6352,6353,6355,6357],{"class":50,"line":122},[48,6354,6137],{"class":396},[48,6356,3016],{"class":3015},[48,6358,6359],{"class":285}," ''\n",[48,6361,6362],{"class":50,"line":127},[48,6363,6181],{"class":447},[48,6365,6366],{"class":50,"line":133},[48,6367,3529],{"class":447},[48,6369,6370],{"class":50,"line":139},[48,6371,96],{"emptyLinePlaceholder":95},[48,6373,6374,6376,6378,6380,6383,6385,6387],{"class":50,"line":144},[48,6375,2935],{"class":645},[48,6377,5238],{"class":2938},[48,6379,2942],{"class":549},[48,6381,6382],{"class":282}," shallowRef",[48,6384,448],{"class":447},[48,6386,5288],{"class":958},[48,6388,487],{"class":447},[48,6390,6391,6393,6396,6398,6400,6402,6404,6406,6408],{"class":50,"line":150},[48,6392,2935],{"class":645},[48,6394,6395],{"class":2938}," parser",[48,6397,2942],{"class":549},[48,6399,5124],{"class":282},[48,6401,5212],{"class":447},[48,6403,5215],{"class":282},[48,6405,448],{"class":447},[48,6407,5220],{"class":3026},[48,6409,487],{"class":447},[48,6411,6412],{"class":50,"line":156},[48,6413,96],{"emptyLinePlaceholder":95},[48,6415,6416,6418,6420,6422],{"class":50,"line":162},[48,6417,6279],{"class":282},[48,6419,3418],{"class":447},[48,6421,3421],{"class":645},[48,6423,652],{"class":447},[48,6425,6426,6429,6431,6433,6435,6437,6439,6441,6443,6446,6448,6451],{"class":50,"line":168},[48,6427,6428],{"class":2950},"  ast",[48,6430,1052],{"class":447},[48,6432,3435],{"class":396},[48,6434,2942],{"class":549},[48,6436,6395],{"class":2950},[48,6438,1052],{"class":447},[48,6440,5247],{"class":282},[48,6442,448],{"class":447},[48,6444,6445],{"class":2950},"props",[48,6447,1052],{"class":447},[48,6449,6450],{"class":396},"mdText",[48,6452,487],{"class":447},[48,6454,6455],{"class":50,"line":173},[48,6456,3529],{"class":447},[48,6458,6459],{"class":50,"line":179},[48,6460,96],{"emptyLinePlaceholder":95},[48,6462,6463],{"class":50,"line":184},[48,6464,6465],{"class":376},"// AST 渲染函数 (同上文 renderAst 函数)\n",[48,6467,6468,6470,6472,6474,6476,6479,6481],{"class":50,"line":190},[48,6469,646],{"class":645},[48,6471,5572],{"class":282},[48,6473,448],{"class":447},[48,6475,5577],{"class":671},[48,6477,6478],{"class":447},") { ",[48,6480,357],{"class":3015},[48,6482,5409],{"class":447},[48,6484,6485],{"class":50,"line":196},[48,6486,96],{"emptyLinePlaceholder":95},[48,6488,6489,6491,6494,6496,6498,6500,6502,6504,6506,6508,6510,6512],{"class":50,"line":202},[48,6490,2935],{"class":645},[48,6492,6493],{"class":2938}," VNodeTree",[48,6495,2942],{"class":549},[48,6497,3415],{"class":282},[48,6499,3418],{"class":447},[48,6501,3421],{"class":645},[48,6503,5572],{"class":282},[48,6505,448],{"class":447},[48,6507,5283],{"class":2950},[48,6509,1052],{"class":447},[48,6511,3435],{"class":396},[48,6513,1394],{"class":447},[48,6515,6516],{"class":50,"line":207},[48,6517,96],{"emptyLinePlaceholder":95},[48,6519,6520,6522,6524],{"class":50,"line":213},[48,6521,6236],{"class":447},[48,6523,6251],{"class":396},[48,6525,4636],{"class":447},[17,6527,6528],{},"现在就可以像使用普通组件一样使用它了：",[38,6530,6532],{"className":6199,"code":6531,"language":6201,"meta":43,"style":43},"\u003Ctemplate>\n  \u003CMarkdownRenderer :mdText=\"markdownContent\" />\n\u003C/template>\n\n\u003Cscript setup>\nimport { ref } from 'vue'\nimport MarkdownRenderer from './MarkdownRenderer.vue'\n\nconst markdownContent = ref('# Hello Vue\\n\\nThis is rendered via AST!')\n\u003C/script>\n",[45,6533,6534,6542,6559,6567,6571,6581,6596,6608,6612,6635],{"__ignoreMap":43},[48,6535,6536,6538,6540],{"class":50,"line":51},[48,6537,3393],{"class":447},[48,6539,6210],{"class":396},[48,6541,4636],{"class":447},[48,6543,6544,6546,6549,6552,6554,6557],{"class":50,"line":57},[48,6545,6217],{"class":447},[48,6547,6548],{"class":396},"MarkdownRenderer",[48,6550,6551],{"class":958}," :mdText",[48,6553,401],{"class":447},[48,6555,6556],{"class":285},"\"markdownContent\"",[48,6558,6231],{"class":447},[48,6560,6561,6563,6565],{"class":50,"line":63},[48,6562,6236],{"class":447},[48,6564,6210],{"class":396},[48,6566,4636],{"class":447},[48,6568,6569],{"class":50,"line":69},[48,6570,96],{"emptyLinePlaceholder":95},[48,6572,6573,6575,6577,6579],{"class":50,"line":75},[48,6574,3393],{"class":447},[48,6576,6251],{"class":396},[48,6578,6254],{"class":958},[48,6580,4636],{"class":447},[48,6582,6583,6585,6587,6590,6592,6594],{"class":50,"line":3},[48,6584,5142],{"class":645},[48,6586,3019],{"class":447},[48,6588,6589],{"class":396},"ref",[48,6591,3106],{"class":447},[48,6593,5151],{"class":645},[48,6595,6286],{"class":285},[48,6597,6598,6600,6603,6605],{"class":50,"line":86},[48,6599,5142],{"class":645},[48,6601,6602],{"class":396}," MarkdownRenderer",[48,6604,5164],{"class":645},[48,6606,6607],{"class":285}," './MarkdownRenderer.vue'\n",[48,6609,6610],{"class":50,"line":92},[48,6611,96],{"emptyLinePlaceholder":95},[48,6613,6614,6616,6618,6620,6623,6625,6628,6630,6633],{"class":50,"line":99},[48,6615,2935],{"class":645},[48,6617,5178],{"class":2938},[48,6619,2942],{"class":549},[48,6621,6622],{"class":282}," ref",[48,6624,448],{"class":447},[48,6626,6627],{"class":285},"'# Hello Vue",[48,6629,5186],{"class":549},[48,6631,6632],{"class":285},"This is rendered via AST!'",[48,6634,487],{"class":447},[48,6636,6637,6639,6641],{"class":50,"line":105},[48,6638,6236],{"class":447},[48,6640,6251],{"class":396},[48,6642,4636],{"class":447},[254,6644,6646],{"id":6645},"ast-方案的巨大优势","AST 方案的巨大优势",[17,6648,6649],{},"切换到 AST 赛道后，我们获得了前所未有的超能力：",[2075,6651,6652,6664,6736,6749],{},[346,6653,6654,6657,6658,6660,6661,6663],{},[27,6655,6656],{},"原生集成，性能卓越","：我们不再需要 ",[45,6659,4938],{}," 的暴力刷新，也不再需要 ",[45,6662,4927],{}," 这样的“外援”。所有更新都交由 Vue 自己的 Diff 算法处理，这不仅性能极高，而且完全符合 Vue 的设计哲学，是真正的“自己人”。",[346,6665,6666,6669,6670],{},[27,6667,6668],{},"高度灵活性与可扩展性","：AST 作为可编程的 JavaScript 对象，为定制化处理提供了坚实基础：\n",[343,6671,6672,6693,6715],{},[346,6673,6674,6677,6678,6681,6682,6685,6686,6688,6689,6692],{},[27,6675,6676],{},"元素替换","：可将原生元素（如 ",[45,6679,6680],{},"\u003Ch2>","）无缝替换为自定义 Vue 组件（如 ",[45,6683,6684],{},"\u003CFancyHeading>","），仅在 ",[45,6687,5660],{}," 函数中调整对应 ",[45,6690,6691],{},"case"," 逻辑即可。",[346,6694,6695,6698,6699,6702,6703,6706,6707,6710,6711,6714],{},[27,6696,6697],{},"逻辑注入","：可便捷地为外部链接 ",[45,6700,6701],{},"\u003Ca>"," 添加 ",[45,6704,6705],{},"target=\"_blank\""," 与 ",[45,6708,6709],{},"rel=\"noopener noreferrer\""," 属性，或为图片 ",[45,6712,6713],{},"\u003Cimg>"," 包裹懒加载组件，此类操作在 AST 层面易于实现。",[346,6716,6717,6720,6721,6723,6724,6727,6728,6731,6732,6735],{},[27,6718,6719],{},"生态集成","：充分利用 ",[45,6722,4918],{}," 丰富的插件生态（如 ",[45,6725,6726],{},"remark-gfm"," 支持 GFM 语法，",[45,6729,6730],{},"remark-prism"," 实现代码高亮），仅需在处理器链中引入相应插件（",[45,6733,6734],{},".use(pluginName)","）。",[346,6737,6738,6741,6742,6745,6746,6748],{},[27,6739,6740],{},"关注点分离","：解析逻辑（",[45,6743,6744],{},"remark","）、渲染逻辑（",[45,6747,5660],{},"）和业务逻辑（Vue 组件）被清晰地分离开来，代码结构更清晰，维护性更强。",[346,6750,6751,6754],{},[27,6752,6753],{},"类型安全与可预测性","：相较于操作字符串或原始 HTML，基于结构化 AST 的渲染逻辑更易于进行类型校验与逻辑推理。",[254,6756,6758],{"id":6757},"结论从功能实现到架构优化的演进","结论：从功能实现到架构优化的演进",[17,6760,6761],{},"回顾优化历程：",[343,6763,6764,6769,6775,6780],{},[346,6765,6766,6768],{},[27,6767,4938],{},"：实现简单，但存在性能与安全性隐患。",[346,6770,6771,6774],{},[27,6772,6773],{},"分块更新","：缓解了部分性能问题，但方案存在局限性。",[346,6776,6777,6779],{},[27,6778,4927],{},"：有效提升了性能与用户体验，但与 Vue 核心机制存在隔阂。",[346,6781,6782,6785],{},[27,6783,6784],{},"AST + 函数式渲染","：回归 Vue 原生范式，提供了性能、灵活性、可维护性俱佳的终极解决方案。",[17,6787,6788],{},"通过采用 AST，我们不仅解决了具体的技术挑战，更重要的是实现了思维范式的转变——从面向结果（HTML 字符串）的编程，转向面向过程与结构（AST）的编程。这使我们能够深入内容本质，从而实现对渲染流程的精确控制。",[17,6790,6791],{},"本次从“全量刷新”到“结构化渲染”的优化实践，不仅是一次性能提升的技术过程，更是一次深入理解现代前端工程化思想的系统性探索。最终实现的 Markdown 渲染方案，在性能、功能性与架构优雅性上均达到了较高水准。",[2049,6793,6794],{},"html pre.shiki code .sAdtL, html code.shiki .sAdtL{--shiki-default:#4078F2;--shiki-dark:#61AFEF}html pre.shiki code .sDhpE, html code.shiki .sDhpE{--shiki-default:#50A14F;--shiki-dark:#98C379}html .default .shiki span {color: var(--shiki-default);background: var(--shiki-default-bg);font-style: var(--shiki-default-font-style);font-weight: var(--shiki-default-font-weight);text-decoration: var(--shiki-default-text-decoration);}html .shiki span {color: var(--shiki-default);background: var(--shiki-default-bg);font-style: var(--shiki-default-font-style);font-weight: var(--shiki-default-font-weight);text-decoration: var(--shiki-default-text-decoration);}html .dark .shiki span {color: var(--shiki-dark);background: var(--shiki-dark-bg);font-style: var(--shiki-dark-font-style);font-weight: var(--shiki-dark-font-weight);text-decoration: var(--shiki-dark-text-decoration);}html.dark .shiki span {color: var(--shiki-dark);background: var(--shiki-dark-bg);font-style: var(--shiki-dark-font-style);font-weight: var(--shiki-dark-font-weight);text-decoration: var(--shiki-dark-text-decoration);}html pre.shiki code .sLKXg, html code.shiki .sLKXg{--shiki-default:#A626A4;--shiki-dark:#C678DD}html pre.shiki code .s5ixo, html code.shiki .s5ixo{--shiki-default:#383A42;--shiki-dark:#ABB2BF}html pre.shiki code .sJa8x, html code.shiki .sJa8x{--shiki-default:#E45649;--shiki-dark:#E06C75}html pre.shiki code .sNmU0, html code.shiki .sNmU0{--shiki-default:#986801;--shiki-dark:#E5C07B}html pre.shiki code .s_Sar, html code.shiki .s_Sar{--shiki-default:#0184BC;--shiki-dark:#56B6C2}html pre.shiki code .sW2Sy, html code.shiki .sW2Sy{--shiki-default:#A0A1A7;--shiki-default-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic}html pre.shiki code .sz0mV, html code.shiki .sz0mV{--shiki-default:#383A42;--shiki-dark:#E06C75}html pre.shiki code .s7GmK, html code.shiki .s7GmK{--shiki-default:#383A42;--shiki-dark:#E5C07B}html pre.shiki code .sAGMh, html code.shiki .sAGMh{--shiki-default:#986801;--shiki-dark:#D19A66}html pre.shiki code .sUNH4, html code.shiki .sUNH4{--shiki-default:white;--shiki-dark:#FFFFFF}html pre.shiki code .s8iYz, html code.shiki .s8iYz{--shiki-default:#383A42;--shiki-default-font-style:inherit;--shiki-dark:#E06C75;--shiki-dark-font-style:italic}html pre.shiki code .s2QsP, html code.shiki .s2QsP{--shiki-default:#E45649;--shiki-dark:#E5C07B}html pre.shiki code .sj4iG, html code.shiki .sj4iG{--shiki-default:#C18401;--shiki-dark:#E06C75}html pre.shiki code .s7DPa, html code.shiki .s7DPa{--shiki-default:#0184BC;--shiki-dark:#C678DD}html pre.shiki code .st7oF, html code.shiki .st7oF{--shiki-default:#0184BC;--shiki-dark:#ABB2BF}html pre.shiki code .sAOjX, html code.shiki .sAOjX{--shiki-default:#CA1243;--shiki-dark:#C678DD}html pre.shiki code .sMj0N, html code.shiki .sMj0N{--shiki-default:#50A14F;--shiki-dark:#ABB2BF}",{"title":43,"searchDepth":57,"depth":57,"links":6796},[6797,6799,6803,6804,6805,6806,6807],{"id":4923,"depth":57,"text":6798},"上回回顾：当 morphdom 遇上 Vue",{"id":4974,"depth":57,"text":4975,"children":6800},[6801,6802],{"id":5032,"depth":63,"text":5033},{"id":5060,"depth":63,"text":5061},{"id":5104,"depth":57,"text":5105},{"id":5537,"depth":57,"text":5538},{"id":6188,"depth":57,"text":6189},{"id":6645,"depth":57,"text":6646},{"id":6757,"depth":57,"text":6758},{"title":6809,"date":6810,"path":6811,"tags":6812,"body":6813},"Vue Markdown 渲染优化实战(上)：从暴力刷新、分块更新到 Morphdom 的华丽变身","2025-07-12 20:48:56","/2025/07/12/vue-markdown-render-improvement-1",[4914,4915,2831,4917,2404],{"type":14,"value":6814,"toc":8162},[6815,6818,6821,6848,6852,6855,6858,6868,6871,7074,7078,7085,7096,7108,7116,7119,7652,7656,7659,7663,7671,7678,7689,7699,7702,7705,8113,8117,8120,8126,8131,8138,8141,8147,8153,8159],[254,6816,6817],{"id":6817},"需求背景",[17,6819,6820],{},"在最近接手的 AI 需求中，需要实现一个类似 ChatGPT 的对话交互界面。其核心流程是：后端通过 SSE（Server-Sent  Events）协议，持续地将 AI 生成的 Markdown 格式文本片段推送到前端。前端负责动态接收并拼接这些 Markdown  片段，最终将拼接完成的 Markdown 文本实时渲染并显示在用户界面上。",[17,6822,6823,6824,6829,6830,6835,6836,6841,6842,6847],{},"Markdown 渲染并不是什么罕见的需求，尤其是在 LLM 相关落地产品满天飞的当下。不同于 React 生态拥有一个 14k+ star 的著名第三方库——",[21,6825,6828],{"href":6826,"rel":6827},"https://github.com/remarkjs/react-markdown",[2036],"react-markdown","，Vue 这边似乎暂时还没有一个仍在活跃维护的、star 数量不低（起码得 2k+ 吧？）的 markdown 渲染库。",[21,6831,6834],{"href":6832,"rel":6833},"https://github.com/cloudacy/vue-markdown-render#readme",[2036],"cloudacy/vue-markdown-render"," 最后一次发版在一年前，但截止本文写作时间只有 103 个 star；",[21,6837,6840],{"href":6838,"rel":6839},"https://github.com/miaolz123/vue-markdown",[2036],"miaolz123/vue-markdown"," 有 2k star，但最后一次 commit 已经是 7 年前了；",[21,6843,6846],{"href":6844,"rel":6845},"https://github.com/zhaoxuhui1122/vue-markdown",[2036],"zhaoxuhui1122/vue-markdown"," 更是 archived 状态。",[254,6849,6851],{"id":6850},"第一版方案简单粗暴的-v-html","第一版方案：简单粗暴的 v-html",[17,6853,6854],{},"简单调研了一圈，发现 Vue 生态里确实缺少一个能打的 Markdown 渲染库。既然没有现成的轮子，那咱就自己造一个！",[17,6856,6857],{},"根据大部分文章以及 LLM 的推荐，我们首先采用 markdown-it 这个第三方库将 markdown 转换为 html 字符串，再通过 v-html 传入。",[17,6859,6860,6863,6864,6867],{},[27,6861,6862],{},"PS:"," 我们这里假设 Markdown 内容是可信的（比如由我们自己的 AI 生成）。如果内容来自用户输入，一定要使用 ",[45,6865,6866],{},"DOMPurify"," 这类库来防止 XSS 攻击，避免给网站“开天窗”哦！",[17,6869,6870],{},"示例代码如下：",[38,6872,6874],{"className":6199,"code":6873,"language":6201,"meta":43,"style":43},"\u003Ctemplate>\n  \u003Cdiv v-html=\"renderedHtml\">\u003C/div>\n\u003C/template>\n\n\u003Cscript setup>\nimport { computed, onMounted, ref } from 'vue';\nimport MarkdownIt from 'markdown-it';\n\nconst markdownContent = ref('');\nconst md = new MarkdownIt();\n\nconst renderedHtml = computed(() => md.render(markdownContent.value))\n\nonMounted(() => {\n  // markdownContent.value = await fetch() ...\n})\n\u003C/script>\n",[45,6875,6876,6884,6906,6914,6918,6928,6955,6969,6973,6991,7008,7012,7043,7047,7057,7062,7066],{"__ignoreMap":43},[48,6877,6878,6880,6882],{"class":50,"line":51},[48,6879,3393],{"class":447},[48,6881,6210],{"class":396},[48,6883,4636],{"class":447},[48,6885,6886,6888,6891,6894,6896,6899,6902,6904],{"class":50,"line":57},[48,6887,6217],{"class":447},[48,6889,6890],{"class":396},"div",[48,6892,6893],{"class":958}," v-html",[48,6895,401],{"class":447},[48,6897,6898],{"class":285},"\"renderedHtml\"",[48,6900,6901],{"class":447},">\u003C/",[48,6903,6890],{"class":396},[48,6905,4636],{"class":447},[48,6907,6908,6910,6912],{"class":50,"line":63},[48,6909,6236],{"class":447},[48,6911,6210],{"class":396},[48,6913,4636],{"class":447},[48,6915,6916],{"class":50,"line":69},[48,6917,96],{"emptyLinePlaceholder":95},[48,6919,6920,6922,6924,6926],{"class":50,"line":75},[48,6921,3393],{"class":447},[48,6923,6251],{"class":396},[48,6925,6254],{"class":958},[48,6927,4636],{"class":447},[48,6929,6930,6932,6934,6936,6938,6941,6943,6945,6947,6949,6952],{"class":50,"line":3},[48,6931,5142],{"class":645},[48,6933,3019],{"class":447},[48,6935,6265],{"class":396},[48,6937,3159],{"class":447},[48,6939,6940],{"class":396},"onMounted",[48,6942,3159],{"class":447},[48,6944,6589],{"class":396},[48,6946,3106],{"class":447},[48,6948,5151],{"class":645},[48,6950,6951],{"class":285}," 'vue'",[48,6953,6954],{"class":447},";\n",[48,6956,6957,6959,6962,6964,6967],{"class":50,"line":86},[48,6958,5142],{"class":645},[48,6960,6961],{"class":396}," MarkdownIt",[48,6963,5164],{"class":645},[48,6965,6966],{"class":285}," 'markdown-it'",[48,6968,6954],{"class":447},[48,6970,6971],{"class":50,"line":92},[48,6972,96],{"emptyLinePlaceholder":95},[48,6974,6975,6977,6979,6981,6983,6985,6988],{"class":50,"line":99},[48,6976,2935],{"class":645},[48,6978,5178],{"class":2938},[48,6980,2942],{"class":549},[48,6982,6622],{"class":282},[48,6984,448],{"class":447},[48,6986,6987],{"class":285},"''",[48,6989,6990],{"class":447},");\n",[48,6992,6993,6995,6998,7000,7003,7005],{"class":50,"line":105},[48,6994,2935],{"class":645},[48,6996,6997],{"class":2938}," md",[48,6999,2942],{"class":549},[48,7001,7002],{"class":645}," new",[48,7004,6961],{"class":282},[48,7006,7007],{"class":447},"();\n",[48,7009,7010],{"class":50,"line":110},[48,7011,96],{"emptyLinePlaceholder":95},[48,7013,7014,7016,7019,7021,7023,7025,7027,7029,7031,7033,7035,7037,7039,7041],{"class":50,"line":116},[48,7015,2935],{"class":645},[48,7017,7018],{"class":2938}," renderedHtml",[48,7020,2942],{"class":549},[48,7022,3415],{"class":282},[48,7024,3418],{"class":447},[48,7026,3421],{"class":645},[48,7028,6997],{"class":2950},[48,7030,1052],{"class":447},[48,7032,6195],{"class":282},[48,7034,448],{"class":447},[48,7036,5252],{"class":2950},[48,7038,1052],{"class":447},[48,7040,3435],{"class":396},[48,7042,1394],{"class":447},[48,7044,7045],{"class":50,"line":122},[48,7046,96],{"emptyLinePlaceholder":95},[48,7048,7049,7051,7053,7055],{"class":50,"line":127},[48,7050,6940],{"class":282},[48,7052,3418],{"class":447},[48,7054,3421],{"class":645},[48,7056,652],{"class":447},[48,7058,7059],{"class":50,"line":133},[48,7060,7061],{"class":376},"  // markdownContent.value = await fetch() ...\n",[48,7063,7064],{"class":50,"line":139},[48,7065,3529],{"class":447},[48,7067,7068,7070,7072],{"class":50,"line":144},[48,7069,6236],{"class":447},[48,7071,6251],{"class":396},[48,7073,4636],{"class":447},[254,7075,7077],{"id":7076},"进化版给-markdown-分块更新","进化版：给 Markdown 分块更新",[17,7079,7080,7081,7084],{},"上述方案虽然能实现基础渲染，但在实时更新场景下存在明显缺陷：",[27,7082,7083],{},"每次接收到新的 Markdown 片段，整个文档都会触发全量重渲染","。即使只有最后一行是新增内容，整个文档的 DOM 也会被完全替换。这导致两个核心问题：",[2075,7086,7087,7093],{},[346,7088,7089,7090,7092],{},"**性能顶不住：**Markdown 内容增长时，",[45,7091,4992],{}," 解析和 DOM 重建的开销呈线性上升。",[346,7094,7095],{},"**交互状态丢失：**全量刷新会把用户当前的操作状态冲掉。最明显的就是，如果你选中了某段文字，一刷新，选中状态就没了！",[17,7097,7098,7099,7104,7105,7107],{},"为了解决这两个问题，",[21,7100,7103],{"href":7101,"rel":7102},"https://juejin.cn/post/7480900772386734143",[2036],"我们在网上找到了分块渲染的方案"," —— 把 Markdown 按两个连续的换行符 (",[45,7106,5186],{},") 切成一块一块的。这样每次更新，只重新渲染最后一块新的，前面的老块直接复用缓存。好处很明显：",[343,7109,7110,7113],{},[346,7111,7112],{},"用户如果选中了前面块里的文字，下次更新时选中状态不会丢（因为前面的块没动）。",[346,7114,7115],{},"需要重新渲染的 DOM 变少了，性能自然就上来了。",[17,7117,7118],{},"代码调整后像这样：",[38,7120,7122],{"className":6199,"code":7121,"language":6201,"meta":43,"style":43},"\u003Ctemplate>\n  \u003Cdiv>\n    \u003Cdiv\n      v-for=\"(block, idx) in renderedBlocks\"\n      :key=\"idx\"\n      v-html=\"block\"\n      class=\"markdown-block\"\n    >\u003C/div>\n  \u003C/div>\n\u003C/template>\n\n\u003Cscript setup>\nimport { ref, computed, watch } from 'vue'\nimport MarkdownIt from 'markdown-it'\n\nconst markdownContent = ref('')\nconst md = new MarkdownIt()\n\nconst renderedBlocks = ref([])\nconst blockCache = ref([])\n\nwatch(\n  markdownContent,\n  (newContent, oldContent) => {\n    const blocks = newContent.split(/\\n{2,}/)\n    // 只重新渲染最后一个块，其余用缓存\n    // 处理块减少、块增多的场景\n    blockCache.value.length = blocks.length\n    for (let i = 0; i \u003C blocks.length; i++) {\n      // 只渲染最后一个，或新块\n      if (i === blocks.length - 1 || !blockCache.value[i]) {\n        blockCache.value[i] = md.render(blocks[i] || '')\n      }\n      // 其余块直接复用\n    }\n    renderedBlocks.value = blockCache.value.slice()\n  },\n  { immediate: true }\n)\n\nonMounted(() => {\n  // markdownContent.value = await fetch() ...\n})\n\u003C/script>\n",[45,7123,7124,7132,7140,7148,7158,7168,7178,7188,7197,7206,7214,7218,7228,7251,7262,7266,7282,7296,7300,7314,7327,7331,7338,7345,7364,7400,7405,7410,7433,7471,7476,7518,7560,7565,7570,7574,7598,7603,7618,7622,7626,7636,7640,7644],{"__ignoreMap":43},[48,7125,7126,7128,7130],{"class":50,"line":51},[48,7127,3393],{"class":447},[48,7129,6210],{"class":396},[48,7131,4636],{"class":447},[48,7133,7134,7136,7138],{"class":50,"line":57},[48,7135,6217],{"class":447},[48,7137,6890],{"class":396},[48,7139,4636],{"class":447},[48,7141,7142,7145],{"class":50,"line":63},[48,7143,7144],{"class":447},"    \u003C",[48,7146,7147],{"class":396},"div\n",[48,7149,7150,7153,7155],{"class":50,"line":69},[48,7151,7152],{"class":958},"      v-for",[48,7154,401],{"class":447},[48,7156,7157],{"class":285},"\"(block, idx) in renderedBlocks\"\n",[48,7159,7160,7163,7165],{"class":50,"line":75},[48,7161,7162],{"class":958},"      :key",[48,7164,401],{"class":447},[48,7166,7167],{"class":285},"\"idx\"\n",[48,7169,7170,7173,7175],{"class":50,"line":3},[48,7171,7172],{"class":958},"      v-html",[48,7174,401],{"class":447},[48,7176,7177],{"class":285},"\"block\"\n",[48,7179,7180,7183,7185],{"class":50,"line":86},[48,7181,7182],{"class":958},"      class",[48,7184,401],{"class":447},[48,7186,7187],{"class":285},"\"markdown-block\"\n",[48,7189,7190,7193,7195],{"class":50,"line":92},[48,7191,7192],{"class":447},"    >\u003C/",[48,7194,6890],{"class":396},[48,7196,4636],{"class":447},[48,7198,7199,7202,7204],{"class":50,"line":99},[48,7200,7201],{"class":447},"  \u003C/",[48,7203,6890],{"class":396},[48,7205,4636],{"class":447},[48,7207,7208,7210,7212],{"class":50,"line":105},[48,7209,6236],{"class":447},[48,7211,6210],{"class":396},[48,7213,4636],{"class":447},[48,7215,7216],{"class":50,"line":110},[48,7217,96],{"emptyLinePlaceholder":95},[48,7219,7220,7222,7224,7226],{"class":50,"line":116},[48,7221,3393],{"class":447},[48,7223,6251],{"class":396},[48,7225,6254],{"class":958},[48,7227,4636],{"class":447},[48,7229,7230,7232,7234,7236,7238,7240,7242,7245,7247,7249],{"class":50,"line":122},[48,7231,5142],{"class":645},[48,7233,3019],{"class":447},[48,7235,6589],{"class":396},[48,7237,3159],{"class":447},[48,7239,6265],{"class":396},[48,7241,3159],{"class":447},[48,7243,7244],{"class":396},"watch",[48,7246,3106],{"class":447},[48,7248,5151],{"class":645},[48,7250,6286],{"class":285},[48,7252,7253,7255,7257,7259],{"class":50,"line":127},[48,7254,5142],{"class":645},[48,7256,6961],{"class":396},[48,7258,5164],{"class":645},[48,7260,7261],{"class":285}," 'markdown-it'\n",[48,7263,7264],{"class":50,"line":133},[48,7265,96],{"emptyLinePlaceholder":95},[48,7267,7268,7270,7272,7274,7276,7278,7280],{"class":50,"line":139},[48,7269,2935],{"class":645},[48,7271,5178],{"class":2938},[48,7273,2942],{"class":549},[48,7275,6622],{"class":282},[48,7277,448],{"class":447},[48,7279,6987],{"class":285},[48,7281,487],{"class":447},[48,7283,7284,7286,7288,7290,7292,7294],{"class":50,"line":144},[48,7285,2935],{"class":645},[48,7287,6997],{"class":2938},[48,7289,2942],{"class":549},[48,7291,7002],{"class":645},[48,7293,6961],{"class":282},[48,7295,3042],{"class":447},[48,7297,7298],{"class":50,"line":150},[48,7299,96],{"emptyLinePlaceholder":95},[48,7301,7302,7304,7307,7309,7311],{"class":50,"line":156},[48,7303,2935],{"class":645},[48,7305,7306],{"class":2938}," renderedBlocks",[48,7308,2942],{"class":549},[48,7310,6622],{"class":282},[48,7312,7313],{"class":447},"([])\n",[48,7315,7316,7318,7321,7323,7325],{"class":50,"line":162},[48,7317,2935],{"class":645},[48,7319,7320],{"class":2938}," blockCache",[48,7322,2942],{"class":549},[48,7324,6622],{"class":282},[48,7326,7313],{"class":447},[48,7328,7329],{"class":50,"line":168},[48,7330,96],{"emptyLinePlaceholder":95},[48,7332,7333,7335],{"class":50,"line":173},[48,7334,7244],{"class":282},[48,7336,7337],{"class":447},"(\n",[48,7339,7340,7343],{"class":50,"line":179},[48,7341,7342],{"class":3026},"  markdownContent",[48,7344,5323],{"class":447},[48,7346,7347,7350,7353,7355,7358,7360,7362],{"class":50,"line":184},[48,7348,7349],{"class":447},"  (",[48,7351,7352],{"class":671},"newContent",[48,7354,3159],{"class":447},[48,7356,7357],{"class":671},"oldContent",[48,7359,5596],{"class":447},[48,7361,3421],{"class":645},[48,7363,652],{"class":447},[48,7365,7366,7369,7372,7374,7377,7379,7382,7384,7388,7392,7396,7398],{"class":50,"line":190},[48,7367,7368],{"class":645},"    const",[48,7370,7371],{"class":2938}," blocks",[48,7373,2942],{"class":549},[48,7375,7376],{"class":2950}," newContent",[48,7378,1052],{"class":447},[48,7380,7381],{"class":282},"split",[48,7383,448],{"class":447},[48,7385,7387],{"class":7386},"sDaw7","/",[48,7389,7391],{"class":7390},"sRZ4U","\\n",[48,7393,7395],{"class":7394},"sYoRg","{2,}",[48,7397,7387],{"class":7386},[48,7399,487],{"class":447},[48,7401,7402],{"class":50,"line":196},[48,7403,7404],{"class":376},"    // 只重新渲染最后一个块，其余用缓存\n",[48,7406,7407],{"class":50,"line":202},[48,7408,7409],{"class":376},"    // 处理块减少、块增多的场景\n",[48,7411,7412,7415,7417,7419,7421,7424,7426,7428,7430],{"class":50,"line":207},[48,7413,7414],{"class":2950},"    blockCache",[48,7416,1052],{"class":447},[48,7418,3435],{"class":2956},[48,7420,1052],{"class":447},[48,7422,7423],{"class":396},"length",[48,7425,2942],{"class":549},[48,7427,7371],{"class":2950},[48,7429,1052],{"class":447},[48,7431,7432],{"class":396},"length\n",[48,7434,7435,7437,7439,7442,7445,7447,7450,7452,7454,7457,7459,7461,7463,7465,7467,7469],{"class":50,"line":213},[48,7436,947],{"class":645},[48,7438,5588],{"class":447},[48,7440,7441],{"class":645},"let",[48,7443,7444],{"class":3026}," i",[48,7446,2942],{"class":549},[48,7448,7449],{"class":958}," 0",[48,7451,906],{"class":447},[48,7453,953],{"class":3026},[48,7455,7456],{"class":549}," \u003C",[48,7458,7371],{"class":2950},[48,7460,1052],{"class":447},[48,7462,7423],{"class":396},[48,7464,906],{"class":447},[48,7466,953],{"class":3026},[48,7468,979],{"class":549},[48,7470,5580],{"class":447},[48,7472,7473],{"class":50,"line":219},[48,7474,7475],{"class":376},"      // 只渲染最后一个，或新块\n",[48,7477,7478,7481,7483,7485,7487,7489,7491,7493,7496,7498,7501,7504,7507,7509,7511,7513,7515],{"class":50,"line":224},[48,7479,7480],{"class":645},"      if",[48,7482,5588],{"class":447},[48,7484,953],{"class":3026},[48,7486,3470],{"class":549},[48,7488,7371],{"class":2950},[48,7490,1052],{"class":447},[48,7492,7423],{"class":396},[48,7494,7495],{"class":549}," -",[48,7497,1412],{"class":958},[48,7499,7500],{"class":549}," ||",[48,7502,7503],{"class":549}," !",[48,7505,7506],{"class":2950},"blockCache",[48,7508,1052],{"class":447},[48,7510,3435],{"class":396},[48,7512,893],{"class":447},[48,7514,953],{"class":3026},[48,7516,7517],{"class":447},"]) {\n",[48,7519,7520,7523,7525,7527,7529,7531,7533,7535,7537,7539,7541,7543,7546,7548,7550,7552,7555,7558],{"class":50,"line":230},[48,7521,7522],{"class":2950},"        blockCache",[48,7524,1052],{"class":447},[48,7526,3435],{"class":396},[48,7528,893],{"class":447},[48,7530,953],{"class":3026},[48,7532,833],{"class":447},[48,7534,401],{"class":549},[48,7536,6997],{"class":2950},[48,7538,1052],{"class":447},[48,7540,6195],{"class":282},[48,7542,448],{"class":447},[48,7544,7545],{"class":3026},"blocks",[48,7547,893],{"class":447},[48,7549,953],{"class":3026},[48,7551,833],{"class":447},[48,7553,7554],{"class":549},"||",[48,7556,7557],{"class":285}," ''",[48,7559,487],{"class":447},[48,7561,7562],{"class":50,"line":235},[48,7563,7564],{"class":447},"      }\n",[48,7566,7567],{"class":50,"line":241},[48,7568,7569],{"class":376},"      // 其余块直接复用\n",[48,7571,7572],{"class":50,"line":246},[48,7573,5514],{"class":447},[48,7575,7576,7579,7581,7583,7585,7587,7589,7591,7593,7596],{"class":50,"line":660},[48,7577,7578],{"class":2950},"    renderedBlocks",[48,7580,1052],{"class":447},[48,7582,3435],{"class":396},[48,7584,2942],{"class":549},[48,7586,7320],{"class":2950},[48,7588,1052],{"class":447},[48,7590,3435],{"class":2956},[48,7592,1052],{"class":447},[48,7594,7595],{"class":282},"slice",[48,7597,3042],{"class":447},[48,7599,7600],{"class":50,"line":683},[48,7601,7602],{"class":447},"  },\n",[48,7604,7605,7608,7611,7613,7616],{"class":50,"line":709},[48,7606,7607],{"class":447},"  { ",[48,7609,7610],{"class":396},"immediate",[48,7612,3016],{"class":3015},[48,7614,7615],{"class":958}," true",[48,7617,5409],{"class":447},[48,7619,7620],{"class":50,"line":720},[48,7621,487],{"class":447},[48,7623,7624],{"class":50,"line":725},[48,7625,96],{"emptyLinePlaceholder":95},[48,7627,7628,7630,7632,7634],{"class":50,"line":731},[48,7629,6940],{"class":282},[48,7631,3418],{"class":447},[48,7633,3421],{"class":645},[48,7635,652],{"class":447},[48,7637,7638],{"class":50,"line":761},[48,7639,7061],{"class":376},[48,7641,7642],{"class":50,"line":786},[48,7643,3529],{"class":447},[48,7645,7646,7648,7650],{"class":50,"line":791},[48,7647,6236],{"class":447},[48,7649,6251],{"class":396},[48,7651,4636],{"class":447},[254,7653,7655],{"id":7654},"终极武器用-morphdom-实现精准更新","终极武器：用 morphdom 实现精准更新",[17,7657,7658],{},"分块渲染虽然解决了大部分问题，但遇到 Markdown 列表就有点力不从心了。因为 Markdown 语法里，列表项之间通常只有一个换行符，整个列表会被当成一个大块。想象一下一个几百项的列表，哪怕只更新最后一项，整个列表块也要全部重来，前面的问题又回来了。",[2324,7660,7662],{"id":7661},"morphdom-是何方神圣","morphdom 是何方神圣？",[17,7664,7665,7667,7668,2629],{},[45,7666,4927],{}," 是一个仅 5KB（gzip 后）的 JavaScript 库，核心功能是：",[27,7669,7670],{},"接收两个 DOM 节点（或 HTML 字符串），计算出最小化的 DOM 操作，将第一个节点 “变形” 为第二个节点，而非直接替换",[17,7672,7673,7674,7677],{},"其工作原理类似虚拟 DOM 的 Diff 算法，但",[27,7675,7676],{},"直接操作真实 DOM","：",[2075,7679,7680,7683,7686],{},[346,7681,7682],{},"对比新旧 DOM 的标签名、属性、文本内容等；",[346,7684,7685],{},"仅对差异部分执行增 / 删 / 改操作（如修改文本、更新属性、移动节点位置）；",[346,7687,7688],{},"未变化的 DOM 节点会被完整保留，包括其事件监听、滚动位置、选中状态等。",[17,7690,7691,7692,7695,7696,7698],{},"Markdown 把列表当整体，但生成的 HTML 里，每个列表项 (",[45,7693,7694],{},"\u003Cli>",") 都是独立的！",[45,7697,4927],{}," 在更新后面的列表项时，能保证前面的列表项纹丝不动，状态自然就保住了。",[17,7700,7701],{},"这不就是我们梦寐以求的效果吗？在 Markdown 实时更新的同时，最大程度留住用户的操作状态，还能省掉一堆不必要的 DOM 操作！",[2324,7703,7704],{"id":7704},"示例代码",[38,7706,7708],{"className":6199,"code":7707,"language":6201,"meta":43,"style":43},"\u003Ctemplate>\n  \u003Cdiv ref=\"markdownContainer\" class=\"markdown-container\">\n    \u003Cdiv id=\"md-root\">\u003C/div>\n  \u003C/div>\n\u003C/template>\n\n\u003Cscript setup>\nimport { nextTick, ref, watch } from 'vue';\nimport MarkdownIt from 'markdown-it';\nimport morphdom from 'morphdom';\n\nconst markdownContent = ref('');\nconst markdownContainer = ref(null);\nconst md = new MarkdownIt();\n\nconst render = () => {\n  if (!markdownContainer.value.querySelector('#md-root')) return;\n\n  const newHtml = `\u003Cdiv id=\"md-root\">` + md.render(markdownContent.value) + `\u003C/div>`\n\n  morphdom(markdownContainer.value, newHtml, {\n    childrenOnly: true\n  });\n}\n\nwatch(markdownContent, () => {\n    render()\n});\n\nonMounted(async () => {\n  // 等待 Dom 被挂载上\n  await nextTick()\n  render()\n})\n\u003C/script>\n\n",[45,7709,7710,7718,7741,7761,7769,7777,7781,7791,7816,7828,7842,7846,7862,7879,7893,7897,7913,7945,7949,7986,7990,8011,8021,8026,8030,8034,8048,8055,8060,8064,8079,8084,8094,8101,8105],{"__ignoreMap":43},[48,7711,7712,7714,7716],{"class":50,"line":51},[48,7713,3393],{"class":447},[48,7715,6210],{"class":396},[48,7717,4636],{"class":447},[48,7719,7720,7722,7724,7726,7728,7731,7734,7736,7739],{"class":50,"line":57},[48,7721,6217],{"class":447},[48,7723,6890],{"class":396},[48,7725,6622],{"class":958},[48,7727,401],{"class":447},[48,7729,7730],{"class":285},"\"markdownContainer\"",[48,7732,7733],{"class":958}," class",[48,7735,401],{"class":447},[48,7737,7738],{"class":285},"\"markdown-container\"",[48,7740,4636],{"class":447},[48,7742,7743,7745,7747,7750,7752,7755,7757,7759],{"class":50,"line":63},[48,7744,7144],{"class":447},[48,7746,6890],{"class":396},[48,7748,7749],{"class":958}," id",[48,7751,401],{"class":447},[48,7753,7754],{"class":285},"\"md-root\"",[48,7756,6901],{"class":447},[48,7758,6890],{"class":396},[48,7760,4636],{"class":447},[48,7762,7763,7765,7767],{"class":50,"line":69},[48,7764,7201],{"class":447},[48,7766,6890],{"class":396},[48,7768,4636],{"class":447},[48,7770,7771,7773,7775],{"class":50,"line":75},[48,7772,6236],{"class":447},[48,7774,6210],{"class":396},[48,7776,4636],{"class":447},[48,7778,7779],{"class":50,"line":3},[48,7780,96],{"emptyLinePlaceholder":95},[48,7782,7783,7785,7787,7789],{"class":50,"line":86},[48,7784,3393],{"class":447},[48,7786,6251],{"class":396},[48,7788,6254],{"class":958},[48,7790,4636],{"class":447},[48,7792,7793,7795,7797,7800,7802,7804,7806,7808,7810,7812,7814],{"class":50,"line":92},[48,7794,5142],{"class":645},[48,7796,3019],{"class":447},[48,7798,7799],{"class":396},"nextTick",[48,7801,3159],{"class":447},[48,7803,6589],{"class":396},[48,7805,3159],{"class":447},[48,7807,7244],{"class":396},[48,7809,3106],{"class":447},[48,7811,5151],{"class":645},[48,7813,6951],{"class":285},[48,7815,6954],{"class":447},[48,7817,7818,7820,7822,7824,7826],{"class":50,"line":99},[48,7819,5142],{"class":645},[48,7821,6961],{"class":396},[48,7823,5164],{"class":645},[48,7825,6966],{"class":285},[48,7827,6954],{"class":447},[48,7829,7830,7832,7835,7837,7840],{"class":50,"line":105},[48,7831,5142],{"class":645},[48,7833,7834],{"class":396}," morphdom",[48,7836,5164],{"class":645},[48,7838,7839],{"class":285}," 'morphdom'",[48,7841,6954],{"class":447},[48,7843,7844],{"class":50,"line":110},[48,7845,96],{"emptyLinePlaceholder":95},[48,7847,7848,7850,7852,7854,7856,7858,7860],{"class":50,"line":116},[48,7849,2935],{"class":645},[48,7851,5178],{"class":2938},[48,7853,2942],{"class":549},[48,7855,6622],{"class":282},[48,7857,448],{"class":447},[48,7859,6987],{"class":285},[48,7861,6990],{"class":447},[48,7863,7864,7866,7869,7871,7873,7875,7877],{"class":50,"line":122},[48,7865,2935],{"class":645},[48,7867,7868],{"class":2938}," markdownContainer",[48,7870,2942],{"class":549},[48,7872,6622],{"class":282},[48,7874,448],{"class":447},[48,7876,5288],{"class":958},[48,7878,6990],{"class":447},[48,7880,7881,7883,7885,7887,7889,7891],{"class":50,"line":127},[48,7882,2935],{"class":645},[48,7884,6997],{"class":2938},[48,7886,2942],{"class":549},[48,7888,7002],{"class":645},[48,7890,6961],{"class":282},[48,7892,7007],{"class":447},[48,7894,7895],{"class":50,"line":133},[48,7896,96],{"emptyLinePlaceholder":95},[48,7898,7899,7901,7904,7906,7909,7911],{"class":50,"line":139},[48,7900,2935],{"class":645},[48,7902,7903],{"class":282}," render",[48,7905,2942],{"class":549},[48,7907,7908],{"class":447}," () ",[48,7910,3421],{"class":645},[48,7912,652],{"class":447},[48,7914,7915,7917,7919,7921,7924,7926,7928,7930,7933,7935,7938,7941,7943],{"class":50,"line":144},[48,7916,5585],{"class":645},[48,7918,5588],{"class":447},[48,7920,5591],{"class":549},[48,7922,7923],{"class":2950},"markdownContainer",[48,7925,1052],{"class":447},[48,7927,3435],{"class":2956},[48,7929,1052],{"class":447},[48,7931,7932],{"class":282},"querySelector",[48,7934,448],{"class":447},[48,7936,7937],{"class":285},"'#md-root'",[48,7939,7940],{"class":447},")) ",[48,7942,5599],{"class":645},[48,7944,6954],{"class":447},[48,7946,7947],{"class":50,"line":150},[48,7948,96],{"emptyLinePlaceholder":95},[48,7950,7951,7954,7957,7959,7962,7964,7966,7968,7970,7972,7974,7976,7978,7980,7983],{"class":50,"line":156},[48,7952,7953],{"class":645},"  const",[48,7955,7956],{"class":2938}," newHtml",[48,7958,2942],{"class":549},[48,7960,7961],{"class":285}," `\u003Cdiv id=\"md-root\">`",[48,7963,1388],{"class":549},[48,7965,6997],{"class":2950},[48,7967,1052],{"class":447},[48,7969,6195],{"class":282},[48,7971,448],{"class":447},[48,7973,5252],{"class":2950},[48,7975,1052],{"class":447},[48,7977,3435],{"class":396},[48,7979,5596],{"class":447},[48,7981,7982],{"class":549},"+",[48,7984,7985],{"class":285}," `\u003C/div>`\n",[48,7987,7988],{"class":50,"line":162},[48,7989,96],{"emptyLinePlaceholder":95},[48,7991,7992,7995,7997,7999,8001,8003,8005,8008],{"class":50,"line":168},[48,7993,7994],{"class":282},"  morphdom",[48,7996,448],{"class":447},[48,7998,7923],{"class":2950},[48,8000,1052],{"class":447},[48,8002,3435],{"class":396},[48,8004,3159],{"class":447},[48,8006,8007],{"class":3026},"newHtml",[48,8009,8010],{"class":447},", {\n",[48,8012,8013,8016,8018],{"class":50,"line":173},[48,8014,8015],{"class":396},"    childrenOnly",[48,8017,3016],{"class":3015},[48,8019,8020],{"class":958}," true\n",[48,8022,8023],{"class":50,"line":179},[48,8024,8025],{"class":447},"  });\n",[48,8027,8028],{"class":50,"line":184},[48,8029,860],{"class":447},[48,8031,8032],{"class":50,"line":190},[48,8033,96],{"emptyLinePlaceholder":95},[48,8035,8036,8038,8040,8042,8044,8046],{"class":50,"line":196},[48,8037,7244],{"class":282},[48,8039,448],{"class":447},[48,8041,5252],{"class":3026},[48,8043,3131],{"class":447},[48,8045,3421],{"class":645},[48,8047,652],{"class":447},[48,8049,8050,8053],{"class":50,"line":202},[48,8051,8052],{"class":282},"    render",[48,8054,3042],{"class":447},[48,8056,8057],{"class":50,"line":207},[48,8058,8059],{"class":447},"});\n",[48,8061,8062],{"class":50,"line":213},[48,8063,96],{"emptyLinePlaceholder":95},[48,8065,8066,8068,8070,8073,8075,8077],{"class":50,"line":219},[48,8067,6940],{"class":282},[48,8069,448],{"class":447},[48,8071,8072],{"class":645},"async",[48,8074,7908],{"class":447},[48,8076,3421],{"class":645},[48,8078,652],{"class":447},[48,8080,8081],{"class":50,"line":224},[48,8082,8083],{"class":376},"  // 等待 Dom 被挂载上\n",[48,8085,8086,8089,8092],{"class":50,"line":230},[48,8087,8088],{"class":645},"  await",[48,8090,8091],{"class":282}," nextTick",[48,8093,3042],{"class":447},[48,8095,8096,8099],{"class":50,"line":235},[48,8097,8098],{"class":282},"  render",[48,8100,3042],{"class":447},[48,8102,8103],{"class":50,"line":241},[48,8104,3529],{"class":447},[48,8106,8107,8109,8111],{"class":50,"line":246},[48,8108,6236],{"class":447},[48,8110,6251],{"class":396},[48,8112,4636],{"class":447},[2324,8114,8116],{"id":8115},"眼见为实demo-对比","眼见为实：Demo 对比",[17,8118,8119],{},"下面这个 iframe 里放了个对比 Demo，展示了不同方案的效果差异。",[17,8121,8122,8125],{},[27,8123,8124],{},"小技巧："," 如果你用的是 Chrome、Edge 这类 Chromium 内核的浏览器，打开开发者工具 (DevTools)，找到“渲染”(Rendering) 标签页，勾选「突出显示重绘区域(Paint flashing)」。这样你就能直观看到每次更新时，哪些部分被重新绘制了——重绘区域越少，性能越好！",[17,8127,8128],{},[293,8129],{"alt":43,"src":8130},"https://static.031130.xyz/uploads/2025/07/12/d5721c40fb076.webp",[8132,8133],"iframe",{"src":8134,"width":8135,"height":8136,"allowFullScreen":95,"loading":8137},"https://static.031130.xyz/demo/morphdom-vs-markdown-chunk.html","100%",500,"lazy",[254,8139,8140],{"id":8140},"阶段性成果",[17,8142,8143,8144,8146],{},"从最开始的“暴力全量刷新”，到“聪明点的分块更新”，再到如今“精准手术刀般的 ",[45,8145,4927],{}," 更新”，我们一步步把那些不必要的渲染开销给砍掉了，最终搞出了一个既快又能留住用户状态的 Markdown 实时渲染方案。",[17,8148,8149,8150,8152],{},"不过，用 ",[45,8151,4927],{}," 这个第三方库来直接操作 Vue 组件里的 DOM，总觉得有点...不够“Vue”？它虽然解决了核心的性能和状态问题，但在 Vue 的世界里这么玩，多少有点旁门左道的意思。",[17,8154,8155,8158],{},[27,8156,8157],{},"下篇预告："," 在下一篇文章里，咱们就来聊聊，在 Vue 的世界里，有没有更优雅、更“原生”的方案来搞定 Markdown 的精准更新？敬请期待！",[2049,8160,8161],{},"html pre.shiki code .s5ixo, html code.shiki .s5ixo{--shiki-default:#383A42;--shiki-dark:#ABB2BF}html pre.shiki code .sJa8x, html code.shiki .sJa8x{--shiki-default:#E45649;--shiki-dark:#E06C75}html pre.shiki code .sAGMh, html code.shiki .sAGMh{--shiki-default:#986801;--shiki-dark:#D19A66}html pre.shiki code .sDhpE, html code.shiki .sDhpE{--shiki-default:#50A14F;--shiki-dark:#98C379}html pre.shiki code .sLKXg, html code.shiki .sLKXg{--shiki-default:#A626A4;--shiki-dark:#C678DD}html pre.shiki code .sNmU0, html code.shiki .sNmU0{--shiki-default:#986801;--shiki-dark:#E5C07B}html pre.shiki code .s_Sar, html code.shiki .s_Sar{--shiki-default:#0184BC;--shiki-dark:#56B6C2}html pre.shiki code .sAdtL, html code.shiki .sAdtL{--shiki-default:#4078F2;--shiki-dark:#61AFEF}html pre.shiki code .s7GmK, html code.shiki .s7GmK{--shiki-default:#383A42;--shiki-dark:#E5C07B}html pre.shiki code .sW2Sy, html code.shiki .sW2Sy{--shiki-default:#A0A1A7;--shiki-default-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic}html .default .shiki span {color: var(--shiki-default);background: var(--shiki-default-bg);font-style: var(--shiki-default-font-style);font-weight: var(--shiki-default-font-weight);text-decoration: var(--shiki-default-text-decoration);}html .shiki span {color: var(--shiki-default);background: var(--shiki-default-bg);font-style: var(--shiki-default-font-style);font-weight: var(--shiki-default-font-weight);text-decoration: var(--shiki-default-text-decoration);}html .dark .shiki span {color: var(--shiki-dark);background: var(--shiki-dark-bg);font-style: var(--shiki-dark-font-style);font-weight: var(--shiki-dark-font-weight);text-decoration: var(--shiki-dark-text-decoration);}html.dark .shiki span {color: var(--shiki-dark);background: var(--shiki-dark-bg);font-style: var(--shiki-dark-font-style);font-weight: var(--shiki-dark-font-weight);text-decoration: var(--shiki-dark-text-decoration);}html pre.shiki code .sz0mV, html code.shiki .sz0mV{--shiki-default:#383A42;--shiki-dark:#E06C75}html pre.shiki code .s8iYz, html code.shiki .s8iYz{--shiki-default:#383A42;--shiki-default-font-style:inherit;--shiki-dark:#E06C75;--shiki-dark-font-style:italic}html pre.shiki code .sDaw7, html code.shiki .sDaw7{--shiki-default:#0184BC;--shiki-dark:#E06C75}html pre.shiki code .sRZ4U, html code.shiki .sRZ4U{--shiki-default:#986801;--shiki-dark:#E06C75}html pre.shiki code .sYoRg, html code.shiki .sYoRg{--shiki-default:#0184BC;--shiki-dark:#D19A66}html pre.shiki code .s2QsP, html code.shiki .s2QsP{--shiki-default:#E45649;--shiki-dark:#E5C07B}html pre.shiki code .st7oF, html code.shiki .st7oF{--shiki-default:#0184BC;--shiki-dark:#ABB2BF}",{"title":43,"searchDepth":57,"depth":57,"links":8163},[8164,8165,8166,8167,8172],{"id":6817,"depth":57,"text":6817},{"id":6850,"depth":57,"text":6851},{"id":7076,"depth":57,"text":7077},{"id":7654,"depth":57,"text":7655,"children":8168},[8169,8170,8171],{"id":7661,"depth":63,"text":7662},{"id":7704,"depth":63,"text":7704},{"id":8115,"depth":63,"text":8116},{"id":8140,"depth":57,"text":8140},{"title":8174,"date":8175,"path":8176,"tags":8177,"body":8180},"node-sass 迁移至 dart-sass 踩坑实录","2025-07-05 17:57:02","/2025/07/05/node-sass-migration-to-dart-sass",[4917,4914,8178,8179,2831],"Sass","CSS",{"type":14,"value":8181,"toc":9025},[8182,8185,8196,8200,8215,8218,8250,8253,8257,8260,8264,8273,8276,8285,8332,8335,8338,8341,8371,8380,8383,8387,8391,8415,8419,8533,8537,8546,8583,8587,8590,8656,8659,8663,8666,8669,8695,8698,8739,8748,8753,8757,8766,8773,8825,8828,8883,8886,8909,8912,8914,9022],[254,8183,8184],{"id":8184},"更新目标",[343,8186,8187,8190,8193],{},[346,8188,8189],{},"node-sass -> sass ( dart-sass )",[346,8191,8192],{},"减少影响面，非必要不更新其他依赖的版本",[346,8194,8195],{},"在前两条基础上，看看能否提升 node.js 的版本",[254,8197,8199],{"id":8198},"抛弃-node-sass-的理由","抛弃 node-sass 的理由",[343,8201,8202,8209,8212],{},[346,8203,8204],{},[21,8205,8208],{"href":8206,"rel":8207},"https://sass-lang.com/blog/libsass-is-deprecated/",[2036],"node-sass 已经停止维护，dart-sass 是 sass 官方主推的继任者",[346,8210,8211],{},"node-sass 在 windows 下的安装非常麻烦，npm 安装时需要开发机上同时装有 python2 和 Microsoft Visual C++",[346,8213,8214],{},"在安装 node-sass 时，需要从 Github 拉取资源，在特定网络环境下成功率并不高",[254,8216,8217],{"id":8217},"项目依赖版本现状",[343,8219,8220,8225,8230,8235,8240,8245],{},[346,8221,8222],{},[45,8223,8224],{},"node@^12",[346,8226,8227],{},[45,8228,8229],{},"vue@^2",[346,8231,8232],{},[45,8233,8234],{},"webpack@^3",[346,8236,8237],{},[45,8238,8239],{},"vue-loader@^14",[346,8241,8242],{},[45,8243,8244],{},"sass-loader@^7.0.3",[346,8246,8247],{},[45,8248,8249],{},"node-sass@^4",[254,8251,8252],{"id":8252},"更新思路",[2324,8254,8256],{"id":8255},"nodejs","node.js",[17,8258,8259],{},"webpack 官方并没有提供 webpack 3 支持的最高 node 版本，且即使 webpack 官方支持，webpack 的相关插件也未必支持。因此 node 版本能否更新就只能自己试。好在尽管这个项目的 CI/CD 跑在 node 12，但我日常都在用 node 14 开发，因此顺势将 node 版本提升至 14。",[2324,8261,8263],{"id":8262},"webpacksass-loader","webpack、sass-loader",[17,8265,8266,8267,8272],{},"webpack 的版本目前处于非必要不更新的定时炸弹状态，基于现有的 webpack 3 限制，所支持的最高 sass-loader 版本就是 ^7 （ sass-loader 在 ",[21,8268,8271],{"href":8269,"rel":8270},"https://github.com/webpack-contrib/sass-loader/blob/v8.0.0/CHANGELOG.md",[2036],"8.0.0 版本的更新日志","中明确指出 8.0.0 版本需要 webpack 4.36.0）。",[17,8274,8275],{},"如果项目中 sass-loader@^7 支持使用 dart-sass 就可以不更新 sass-loader，也就不必更新 webpack 版本；反之，就需要同步更新 webpack 至 4，再视情况定下 sass-loader 的版本。",[17,8277,8278,8279,8284],{},"那么到底支不支持呢？我在 ",[21,8280,8283],{"href":8281,"rel":8282},"https://www.webpackjs.com/loaders/sass-loader/",[2036],"webpack 官方文档介绍 sass-loader 的页面","找到了这样一段 package.json 片段",[38,8286,8288],{"className":5300,"code":8287,"language":5302,"meta":43,"style":43},"{\n  \"devDependencies\": {\n    \"sass-loader\": \"^7.2.0\",\n    \"sass\": \"^1.22.10\"\n  }\n}\n",[45,8289,8290,8294,8302,8314,8324,8328],{"__ignoreMap":43},[48,8291,8292],{"class":50,"line":51},[48,8293,5309],{"class":447},[48,8295,8296,8299],{"class":50,"line":57},[48,8297,8298],{"class":396},"  \"devDependencies\"",[48,8300,8301],{"class":447},": {\n",[48,8303,8304,8307,8309,8312],{"class":50,"line":63},[48,8305,8306],{"class":396},"    \"sass-loader\"",[48,8308,5317],{"class":447},[48,8310,8311],{"class":285},"\"^7.2.0\"",[48,8313,5323],{"class":447},[48,8315,8316,8319,8321],{"class":50,"line":69},[48,8317,8318],{"class":396},"    \"sass\"",[48,8320,5317],{"class":447},[48,8322,8323],{"class":285},"\"^1.22.10\"\n",[48,8325,8326],{"class":50,"line":75},[48,8327,6181],{"class":447},[48,8329,8330],{"class":50,"line":3},[48,8331,860],{"class":447},[17,8333,8334],{},"这证明起码在 sass-loader@7.2.0 这一版本就已经支持 dart-sass 了，因此 webpack 版本可以停留在 ^3，而 sass-loader 暂时停留在 7.0.3 版本，如果后续有问题可以更新到 ^7 版本中最新的 7.3.1 版本。",[2324,8336,8337],{"id":8337},"dart-sass",[17,8339,8340],{},"sass-loader@^7 所支持的最高 sass 我并没有查到，Github Copilot 信誓旦旦地告诉我",[2558,8342,8343,8348,8353,8358],{},[17,8344,8345],{},[27,8346,8347],{},"官方文档引用：",[2558,8349,8350],{},[17,8351,8352],{},"sass-loader@^7.0.0 requires node-sass >=4.0.0 or sass >=1.3.0, \u003C=1.26.5.",[17,8354,8355],{},[27,8356,8357],{},"建议：",[343,8359,8360],{},[346,8361,8362,8363,8366,8367,8370],{},"如果需要使用更高版本的 ",[45,8364,8365],{},"sass","，请升级到 ",[45,8368,8369],{},"sass-loader"," 8 或更高版本。",[17,8372,8373,8374,8379],{},"但事实上，我并没有在互联网上找到这段文本的蛛丝马迹。并且在 sass 的 ~1.26 版本中最后一个版本是 1.26.11 而非 1.26.5，",[21,8375,8378],{"href":8376,"rel":8377},"https://docs.npmjs.com/about-semantic-versioning",[2036],"根据常见的 npm 版本号原则","，major version 和 minor version 不变，只改变了 patch version 的发版一般只有 bugfix 而没有 breaking change，不至于从 1.26.5 更新到 1.26.11 就突然不支持 sass-loader 7 了，因此更可能是 AI 幻觉或者是训练数据受限。",[17,8381,8382],{},"出于谨慎考虑，最终决定采用 webpack 官方文档中提到的 sass 1.22 的最后一个版本，也就是 1.22.12。",[254,8384,8386],{"id":8385},"分析完成动手更新","分析完成，动手更新",[2324,8388,8390],{"id":8389},"第一步卸载-node-sass安装-sass12212","第一步，卸载 node-sass，安装 sass@^1.22.12",[38,8392,8394],{"className":273,"code":8393,"language":275,"meta":43,"style":43},"npm uninstall node-sass\nnpm install sass@^1.22.12\n",[45,8395,8396,8406],{"__ignoreMap":43},[48,8397,8398,8400,8403],{"class":50,"line":51},[48,8399,5118],{"class":282},[48,8401,8402],{"class":285}," uninstall",[48,8404,8405],{"class":285}," node-sass\n",[48,8407,8408,8410,8412],{"class":50,"line":57},[48,8409,5118],{"class":282},[48,8411,5121],{"class":285},[48,8413,8414],{"class":285}," sass@^1.22.12\n",[2324,8416,8418],{"id":8417},"第二步更新-webpack-配置非必须","第二步，更新 webpack 配置（非必须）",[38,8420,8422],{"className":4315,"code":8421,"language":4317,"meta":43,"style":43},"module.exports = {\n  // ...\n  module: {\n    rules: [\n      {\n        test: /\\.(scss|sass)$/,\n        use: [\n          'style-loader',\n          'css-loader',\n          {\n            loader: 'sass-loader',\n+            options: {\n+                // 事实上，这一行在大部分 sass-loader 版本中不用加，sass-loader 能自动检测本地是 sass 还是 node-sass\n+                implementation: require('sass')\n+              },\n            },\n          },\n        ],\n      },\n    ],\n  },\n};\n",[45,8423,8424,8429,8434,8439,8444,8449,8454,8459,8464,8469,8474,8479,8484,8489,8494,8499,8504,8509,8514,8519,8524,8528],{"__ignoreMap":43},[48,8425,8426],{"class":50,"line":51},[48,8427,8428],{"class":447},"module.exports = {\n",[48,8430,8431],{"class":50,"line":57},[48,8432,8433],{"class":447},"  // ...\n",[48,8435,8436],{"class":50,"line":63},[48,8437,8438],{"class":447},"  module: {\n",[48,8440,8441],{"class":50,"line":69},[48,8442,8443],{"class":447},"    rules: [\n",[48,8445,8446],{"class":50,"line":75},[48,8447,8448],{"class":447},"      {\n",[48,8450,8451],{"class":50,"line":3},[48,8452,8453],{"class":447},"        test: /\\.(scss|sass)$/,\n",[48,8455,8456],{"class":50,"line":86},[48,8457,8458],{"class":447},"        use: [\n",[48,8460,8461],{"class":50,"line":92},[48,8462,8463],{"class":447},"          'style-loader',\n",[48,8465,8466],{"class":50,"line":99},[48,8467,8468],{"class":447},"          'css-loader',\n",[48,8470,8471],{"class":50,"line":105},[48,8472,8473],{"class":447},"          {\n",[48,8475,8476],{"class":50,"line":110},[48,8477,8478],{"class":447},"            loader: 'sass-loader',\n",[48,8480,8481],{"class":50,"line":116},[48,8482,8483],{"class":285},"+            options: {\n",[48,8485,8486],{"class":50,"line":122},[48,8487,8488],{"class":285},"+                // 事实上，这一行在大部分 sass-loader 版本中不用加，sass-loader 能自动检测本地是 sass 还是 node-sass\n",[48,8490,8491],{"class":50,"line":127},[48,8492,8493],{"class":285},"+                implementation: require('sass')\n",[48,8495,8496],{"class":50,"line":133},[48,8497,8498],{"class":285},"+              },\n",[48,8500,8501],{"class":50,"line":139},[48,8502,8503],{"class":447},"            },\n",[48,8505,8506],{"class":50,"line":144},[48,8507,8508],{"class":447},"          },\n",[48,8510,8511],{"class":50,"line":150},[48,8512,8513],{"class":447},"        ],\n",[48,8515,8516],{"class":50,"line":156},[48,8517,8518],{"class":447},"      },\n",[48,8520,8521],{"class":50,"line":162},[48,8522,8523],{"class":447},"    ],\n",[48,8525,8526],{"class":50,"line":168},[48,8527,7602],{"class":447},[48,8529,8530],{"class":50,"line":173},[48,8531,8532],{"class":447},"};\n",[2324,8534,8536],{"id":8535},"第三步批量替换-deep-语法为-v-deep","第三步，批量替换 /deep/ 语法为 ::v-deep",[17,8538,8539,8540,8545],{},"因为 ",[21,8541,8544],{"href":8542,"rel":8543},"https://chromestatus.com/feature/4964279606312960",[2036],"/deep/ 写法在 2017 年被弃用"," ，/deep/ 变成了不受支持的深度作用选择器，node-sass 凭借其出色的容错性能够继续提供兼容，但 dart-sass 则不支持这种写法。于是需要将 /deep/ 语法批量替换成 ::v-deep 写法，这种写法虽然在 vue 的后续 rfc 被放弃了，但直至今日依然在事实上被支持。",[38,8547,8549],{"className":273,"code":8548,"language":275,"meta":43,"style":43},"# 大概就是这么个意思，用 vscode 的批量替换其实也行\nsed -i 's#\\s*/deep/\\s*# ::v-deep #g' $(grep -rl '/deep/' .)\n",[45,8550,8551,8556],{"__ignoreMap":43},[48,8552,8553],{"class":50,"line":51},[48,8554,8555],{"class":376},"# 大概就是这么个意思，用 vscode 的批量替换其实也行\n",[48,8557,8558,8561,8564,8567,8570,8572,8575,8578,8581],{"class":50,"line":57},[48,8559,8560],{"class":282},"sed",[48,8562,8563],{"class":958}," -i",[48,8565,8566],{"class":285}," 's#\\s*/deep/\\s*# ::v-deep #g'",[48,8568,8569],{"class":447}," $(",[48,8571,1181],{"class":282},[48,8573,8574],{"class":958}," -rl",[48,8576,8577],{"class":285}," '/deep/'",[48,8579,8580],{"class":285}," .",[48,8582,487],{"class":447},[2324,8584,8586],{"id":8585},"第四步修复其他-sass-语法错误","第四步，修复其他 sass 语法错误",[17,8588,8589],{},"在迁移的过程中，我发现项目中有一些不规范的写法，node-sass 凭借出色的鲁棒性不吭一声强行解析，而 dart-sass 则干不了这粗活。因此需要根据编译时的报错手动修复一下这些语法错误，我这里一共遇到两种。",[38,8591,8593],{"className":4315,"code":8592,"language":4317,"meta":43,"style":43},"// 多打了一个冒号\n.foo {\n-  color:: #fff;\n+  color: #fff;\n}\n\n// :nth-last-child 没指定数字\n.bar {\n-  &:nth-last-child() {\n+  &:nth-last-child(1) {\n      margin-bottom: 0;\n  }\n}\n",[45,8594,8595,8600,8605,8610,8615,8619,8623,8628,8633,8638,8643,8648,8652],{"__ignoreMap":43},[48,8596,8597],{"class":50,"line":51},[48,8598,8599],{"class":447},"// 多打了一个冒号\n",[48,8601,8602],{"class":50,"line":57},[48,8603,8604],{"class":447},".foo {\n",[48,8606,8607],{"class":50,"line":63},[48,8608,8609],{"class":396},"-  color:: #fff;\n",[48,8611,8612],{"class":50,"line":69},[48,8613,8614],{"class":285},"+  color: #fff;\n",[48,8616,8617],{"class":50,"line":75},[48,8618,860],{"class":447},[48,8620,8621],{"class":50,"line":3},[48,8622,96],{"emptyLinePlaceholder":95},[48,8624,8625],{"class":50,"line":86},[48,8626,8627],{"class":447},"// :nth-last-child 没指定数字\n",[48,8629,8630],{"class":50,"line":92},[48,8631,8632],{"class":447},".bar {\n",[48,8634,8635],{"class":50,"line":99},[48,8636,8637],{"class":396},"-  &:nth-last-child() {\n",[48,8639,8640],{"class":50,"line":105},[48,8641,8642],{"class":285},"+  &:nth-last-child(1) {\n",[48,8644,8645],{"class":50,"line":110},[48,8646,8647],{"class":447},"      margin-bottom: 0;\n",[48,8649,8650],{"class":50,"line":116},[48,8651,6181],{"class":447},[48,8653,8654],{"class":50,"line":122},[48,8655,860],{"class":447},[254,8657,8658],{"id":8658},"踩坑",[2324,8660,8662],{"id":8661},"v-deep-样式不生效","::v-deep 样式不生效",[17,8664,8665],{},"依赖更新完后看了两眼好像是没问题，就推测试环境了。结果一天没到就被同事 call 了，::v-deep 这种深度作用选择器居然没有生效？",[17,8667,8668],{},"抱着试一试的态度，GPT 给了如下回答",[2558,8670,8671],{},[17,8672,8673,8674,8677,8678,8681,8682,8688,8689,8692,8693,6735],{},"在 ",[27,8675,8676],{},"Vue 2 + vue-loader + Sass"," 的组合下，",[27,8679,8680],{},"这种写法是正确的","，",[27,8683,8684,8685],{},"前提是你的构建工具链支持 ",[45,8686,8687],{},"::v-deep"," 语法（如 ",[45,8690,8691],{},"vue-loader@15"," 及以上版本 + ",[45,8694,8369],{},[17,8696,8697],{},"虽说我依然没有查证到为什么更新 vue-loader@15 才能使用 ::v-deep 语法，但对 vue-loader 进行更新后，::v-deep 语法确实生效了。在撰写本文时，我找到了些许蛛丝马迹，可能能解释这一问题。",[2075,8699,8700,8714],{},[346,8701,8702,8703,8708,8709,2629],{},"vue-loader 在 ",[21,8704,8707],{"href":8705,"rel":8706},"https://vue-loader-v14.vuejs.org/en/features/scoped-css.html#deep-selectors",[2036],"14 版本的官方文档","就是没有 ::v-deep 写法的示例，",[21,8710,8713],{"href":8711,"rel":8712},"https://github.com/vuejs/vue-loader/commit/2585d254fc774386a898887467fbdd30eb864b53",[2036],"这一示例一直在 vue-loader 15.7.0 版本发布后才被加入",[346,8715,8716,8717,8724,8727,8728,8733,8734],{},"vue-cli 的 Github Issue 评论区中有人提到",[2558,8718,8719],{},[17,8720,8721,8723],{},[45,8722,8687],{}," implemented in @vue/component-compiler-utils v2.6.0, should work after you reinstall the deps.",[8725,8726],"br",{},"而 vue-loader 在 15.0.0-beta.1 版本才",[21,8729,8732],{"href":8730,"rel":8731},"https://github.com/vuejs/vue-loader/commit/e32cd0e4372fcc6f13b6c307402713807516d71c#diff-7ae45ad102eab3b6d7e7896acd08c427a9b25b346470d7bc6507b6481575d519",[2036],"将 @vue/component-compiler-utils 加入到自己的 dependencies 中","，并直到 vue-loader 15.7.1 中才",[21,8735,8738],{"href":8736,"rel":8737},"https://github.com/vuejs/vue-loader/commit/c359a38db0fbb4135fc97114baec3cd557d4123a",[2036],"将其 @vue/component-compiler-utils 的版本号更新到满足要求的 ^3.0.0",[17,8740,8741,8742,8747],{},"那能否升级到 vue-loader 16 甚至 17 版本呢？不行，在 ",[21,8743,8746],{"href":8744,"rel":8745},"https://github.com/vuejs/vue-loader/releases/tag/v16.1.2",[2036],"vue-loader v16.1.2 的更新日志","中明确写道",[2558,8749,8750],{},[17,8751,8752],{},"Note: vue-loader v16 is for Vue 3 only.",[2324,8754,8756],{"id":8755},"vue-loader-14-15-breaking-change","vue-loader 14 -> 15 breaking change",[17,8758,8759,8760,8765],{},"vue-loader 从 14 往上迁移时，不修改 webpack 配置直接跑会遇到 vue 语法不识别的问题。具体表现为 .vue 文件命名都是正确有效的语法，但构建开发时编译器就是不认，报语法错误。vue-loader 官方有一份",[21,8761,8764],{"href":8762,"rel":8763},"https://vue-loader.vuejs.org/migrating.html",[2036],"迁移文档","，需要注意一下。",[38,8767,8771],{"className":8768,"code":8770,"language":5556},[8769],"language-text","ERROR in ./src/......\nModule parse failed: Unexpected token(1:0)\nYou may need an appropriate loader to handle this file type.\n",[45,8772,8770],{"__ignoreMap":43},[38,8774,8776],{"className":4315,"code":8775,"language":4317,"meta":43,"style":43},"// ...\nimport path from 'path'\n+const VueLoaderPlugin = require('vue-loader/lib/plugin')\n\n// ...\n\n  plugins: [\n+    new VueLoaderPlugin()\n    // ...\n  ]\n",[45,8777,8778,8783,8788,8793,8797,8801,8805,8810,8815,8820],{"__ignoreMap":43},[48,8779,8780],{"class":50,"line":51},[48,8781,8782],{"class":447},"// ...\n",[48,8784,8785],{"class":50,"line":57},[48,8786,8787],{"class":447},"import path from 'path'\n",[48,8789,8790],{"class":50,"line":63},[48,8791,8792],{"class":285},"+const VueLoaderPlugin = require('vue-loader/lib/plugin')\n",[48,8794,8795],{"class":50,"line":69},[48,8796,96],{"emptyLinePlaceholder":95},[48,8798,8799],{"class":50,"line":75},[48,8800,8782],{"class":447},[48,8802,8803],{"class":50,"line":3},[48,8804,96],{"emptyLinePlaceholder":95},[48,8806,8807],{"class":50,"line":86},[48,8808,8809],{"class":447},"  plugins: [\n",[48,8811,8812],{"class":50,"line":92},[48,8813,8814],{"class":285},"+    new VueLoaderPlugin()\n",[48,8816,8817],{"class":50,"line":99},[48,8818,8819],{"class":447},"    // ...\n",[48,8821,8822],{"class":50,"line":105},[48,8823,8824],{"class":447},"  ]\n",[17,8826,8827],{},"除此之外，在我这个项目中需要额外移除 webpack 配置中针对 .vue 文件的 babel-loader",[38,8829,8831],{"className":4315,"code":8830,"language":4317,"meta":43,"style":43},"{\n  test: /\\.vue$/,\n  use: [\n-    {\n-      loader: 'babel-loader'\n-    },\n    {\n      loader: 'vue-loader',\n    }\n  ]\n}\n",[45,8832,8833,8837,8842,8847,8852,8857,8862,8866,8871,8875,8879],{"__ignoreMap":43},[48,8834,8835],{"class":50,"line":51},[48,8836,5309],{"class":447},[48,8838,8839],{"class":50,"line":57},[48,8840,8841],{"class":447},"  test: /\\.vue$/,\n",[48,8843,8844],{"class":50,"line":63},[48,8845,8846],{"class":447},"  use: [\n",[48,8848,8849],{"class":50,"line":69},[48,8850,8851],{"class":396},"-    {\n",[48,8853,8854],{"class":50,"line":75},[48,8855,8856],{"class":396},"-      loader: 'babel-loader'\n",[48,8858,8859],{"class":50,"line":3},[48,8860,8861],{"class":396},"-    },\n",[48,8863,8864],{"class":50,"line":86},[48,8865,5336],{"class":447},[48,8867,8868],{"class":50,"line":92},[48,8869,8870],{"class":447},"      loader: 'vue-loader',\n",[48,8872,8873],{"class":50,"line":99},[48,8874,5514],{"class":447},[48,8876,8877],{"class":50,"line":105},[48,8878,8824],{"class":447},[48,8880,8881],{"class":50,"line":110},[48,8882,860],{"class":447},[254,8884,8885],{"id":8885},"最终更新情况",[343,8887,8888,8895,8902],{},[346,8889,8890,4762,8892],{},[45,8891,8224],{},[45,8893,8894],{},"node@^14",[346,8896,8897,4762,8899],{},[45,8898,8239],{},[45,8900,8901],{},"vue-loader@^15",[346,8903,8904,4762,8906],{},[45,8905,8249],{},[45,8907,8908],{},"sass@^1.22.12",[17,8910,8911],{},"其余依赖版本维持不变",[254,8913,2366],{"id":2366},[343,8915,8916,8933,8940,8946,8952,8959,8966,8972,8978,8984,8990,8996,9002,9009,9016],{},[346,8917,8918],{},[21,8919,8922,8923,8925,8926,8929,8930,8932],{"href":8920,"rel":8921},"https://juejin.cn/post/7327094228350500914",[2036],"node-sass更换为dart-sass",[45,8924,8337],{}," 和 ",[45,8927,8928],{},"node-sass","都是用来将",[45,8931,8365],{},"编译成 - 掘金",[346,8934,8935],{},[21,8936,8939],{"href":8937,"rel":8938},"https://sunchenggit.github.io/2021/01/13/node-sass%E8%BF%81%E7%A7%BBdart-sass/",[2036],"node-sass迁移dart-sass | Bolg",[346,8941,8942],{},[21,8943,8945],{"href":8281,"rel":8944},[2036],"sass-loader | webpack 中文文档 | webpack中文文档 | webpack中文网",[346,8947,8948],{},[21,8949,8951],{"href":8206,"rel":8950},[2036],"Sass: LibSass is Deprecated",[346,8953,8954],{},[21,8955,8958],{"href":8956,"rel":8957},"https://www.npmjs.com/package/sass?activeTab=versions",[2036],"sass - npm",[346,8960,8961],{},[21,8962,8965],{"href":8963,"rel":8964},"https://www.npmjs.com/package/node-sass",[2036],"node-sass - npm",[346,8967,8968],{},[21,8969,8971],{"href":8376,"rel":8970},[2036],"About semantic versioning | npm Docs",[346,8973,8974],{},[21,8975,8977],{"href":8542,"rel":8976},[2036],"Make /deep/ behave like the descendant combinator \" \" in CSS live profile (in css file or inside of \u003Cstyle>) - Chrome Platform Status",[346,8979,8980],{},[21,8981,8983],{"href":8269,"rel":8982},[2036],"sass-loader/CHANGELOG.md at v8.0.0 · webpack-contrib/sass-loader",[346,8985,8986],{},[21,8987,8989],{"href":8744,"rel":8988},[2036],"Release v16.1.2 · vuejs/vue-loader",[346,8991,8992],{},[21,8993,8995],{"href":8730,"rel":8994},[2036],"refactor: use @vue/component-compiler-utils · vuejs/vue-loader@e32cd0e",[346,8997,8998],{},[21,8999,9001],{"href":8736,"rel":9000},[2036],"chore: update @vue/component-compiler-utils to v3 · vuejs/vue-loader@c359a38",[346,9003,9004],{},[21,9005,9008],{"href":9006,"rel":9007},"https://github.com/vuejs/vue-cli/issues/3399#issuecomment-466319019",[2036],"dart-sass does not support /deep/ selector · Issue #3399 · vuejs/vue-cli",[346,9010,9011],{},[21,9012,9015],{"href":9013,"rel":9014},"https://vue-loader-v14.vuejs.org/en/features/scoped-css.html",[2036],"Scoped CSS · vue-loader v14",[346,9017,9018],{},[21,9019,9021],{"href":8762,"rel":9020},[2036],"Migrating from v14 | Vue Loader",[2049,9023,9024],{},"html pre.shiki code .s5ixo, html code.shiki .s5ixo{--shiki-default:#383A42;--shiki-dark:#ABB2BF}html pre.shiki code .sJa8x, html code.shiki .sJa8x{--shiki-default:#E45649;--shiki-dark:#E06C75}html pre.shiki code .sDhpE, html code.shiki .sDhpE{--shiki-default:#50A14F;--shiki-dark:#98C379}html .default .shiki span {color: var(--shiki-default);background: var(--shiki-default-bg);font-style: var(--shiki-default-font-style);font-weight: var(--shiki-default-font-weight);text-decoration: var(--shiki-default-text-decoration);}html .shiki span {color: var(--shiki-default);background: var(--shiki-default-bg);font-style: var(--shiki-default-font-style);font-weight: var(--shiki-default-font-weight);text-decoration: var(--shiki-default-text-decoration);}html .dark .shiki span {color: var(--shiki-dark);background: var(--shiki-dark-bg);font-style: var(--shiki-dark-font-style);font-weight: var(--shiki-dark-font-weight);text-decoration: var(--shiki-dark-text-decoration);}html.dark .shiki span {color: var(--shiki-dark);background: var(--shiki-dark-bg);font-style: var(--shiki-dark-font-style);font-weight: var(--shiki-dark-font-weight);text-decoration: var(--shiki-dark-text-decoration);}html pre.shiki code .sAdtL, html code.shiki .sAdtL{--shiki-default:#4078F2;--shiki-dark:#61AFEF}html pre.shiki code .sW2Sy, html code.shiki .sW2Sy{--shiki-default:#A0A1A7;--shiki-default-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic}html pre.shiki code .sAGMh, html code.shiki .sAGMh{--shiki-default:#986801;--shiki-dark:#D19A66}",{"title":43,"searchDepth":57,"depth":57,"links":9026},[9027,9028,9029,9030,9035,9041,9045,9046],{"id":8184,"depth":57,"text":8184},{"id":8198,"depth":57,"text":8199},{"id":8217,"depth":57,"text":8217},{"id":8252,"depth":57,"text":8252,"children":9031},[9032,9033,9034],{"id":8255,"depth":63,"text":8256},{"id":8262,"depth":63,"text":8263},{"id":8337,"depth":63,"text":8337},{"id":8385,"depth":57,"text":8386,"children":9036},[9037,9038,9039,9040],{"id":8389,"depth":63,"text":8390},{"id":8417,"depth":63,"text":8418},{"id":8535,"depth":63,"text":8536},{"id":8585,"depth":63,"text":8586},{"id":8658,"depth":57,"text":8658,"children":9042},[9043,9044],{"id":8661,"depth":63,"text":8662},{"id":8755,"depth":63,"text":8756},{"id":8885,"depth":57,"text":8885},{"id":2366,"depth":57,"text":2366},130,1764102268640]