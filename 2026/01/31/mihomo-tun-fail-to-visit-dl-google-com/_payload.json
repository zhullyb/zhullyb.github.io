[{"data":1,"prerenderedAt":445},["ShallowReactive",2],{"post-2026-01-31-mihomo-tun-fail-to-visit-dl-google-com-zh":3,"surround-2026-01-31-mihomo-tun-fail-to-visit-dl-google-com-zh":435,"randomIndex/2026/01/31/mihomo-tun-fail-to-visit-dl-google-com/":443,"language-switch-/2026/01/31/mihomo-tun-fail-to-visit-dl-google-com/-en":444},{"title":4,"date":5,"path":6,"tags":7,"body":10,"description":434},"我没法访问 dl.google.com —— 记一次 TUN 下的网络 debug","2026-01-31","/2026/01/31/mihomo-tun-fail-to-visit-dl-google-com",[8,9],"Network","DNS",{"type":11,"value":12,"toc":424},"minimark",[13,38,48,55,61,67,70,75,81,87,90,102,105,109,123,129,132,138,147,158,164,168,171,198,208,214,221,224,228,231,257,263,272,277,280,285,288,311,314,320,329,333,342,345,400,408,411,420],[14,15,16,17,21,22,26,27,34,35,37],"p",{},"如果大家对目前中国大陆境内的网络环境足够了解，应该就会知道 ",[18,19,20],"code",{},"dl.google.com"," 在很多情况下是",[23,24,25],"strong",{},"可以直连访问","的。比如，你可以通过 ",[28,29,33],"a",{"href":30,"rel":31},"https://google.cn/chrome/?standalone=1",[32],"nofollow","google.cn/chrome/?standalone=1"," 这个 URL 直接在境内的网络环境下下载 Chrome 的离线安装包，最终的下载域名就是 ",[18,36,20],{},"。",[14,39,40,41,44,45,47],{},"我平常的使用习惯是 24 小时开启代理工具的 TUN，让所有流量先经过一张虚拟网卡，再根据分流规则自动判断要不要走代理。这个习惯大部分时候都挺省心的——直到最近我用 ",[18,42,43],{},"yay"," 滚 Arch 的时候，突然遇到了 ",[18,46,20],{}," 的 SSL 连接建立失败。",[14,49,50],{},[51,52],"img",{"alt":53,"src":54},"yay 更新失败","https://static.031130.xyz/uploads/2026/01/31/df5e547511070.webp",[14,56,57,58,60],{},"而且不止是 ",[18,59,43],{},"，我的浏览器也返回了相同的结果：",[14,62,63],{},[51,64],{"alt":65,"src":66},"Firefox 访问失败","https://static.031130.xyz/uploads/2026/01/31/8ada158510aba.webp",[14,68,69],{},"当时我的第一反应是：是不是我那套分流规则又抽风了？（毕竟不是我自己写的，出事先甩锅很合理。）",[71,72,74],"h2",{"id":73},"规则确实是直连这锅甩不掉","规则确实是直连，这锅甩不掉",[14,76,77,78,80],{},"我特意去查了分流规则，针对 SNI 为 ",[18,79,20],{}," 的流量是直连访问的。",[14,82,83],{},[51,84],{"alt":85,"src":86},"Mihomo的分流规则","https://static.031130.xyz/uploads/2026/01/31/96d27a20f2bf3.webp",[14,88,89],{},"这就很奇怪了。按理说：",[91,92,93,99],"ul",{},[94,95,96,98],"li",{},[18,97,20],{}," 本身在国内网络环境里经常是能直连的",[94,100,101],{},"规则也明确写了 DIRECT",[14,103,104],{},"说实话，这个问题我之前也遇到过，但那时手上有优先级更高的事，就直接关掉代理工具绕过了它完成更新。好在我现在刚处理完手头事情，正处于无事可做的状态，于是决定认真把这个坑填了。",[71,106,108],{"id":107},"解析到海外-ip-了","解析到海外 IP 了",[14,110,111,112,115,116,119,120,122],{},"我先把代理工具的 ",[18,113,114],{},"fake-ip"," 关掉，换成真实 IP 解析（避免再引入额外变量），然后用 ",[18,117,118],{},"curl -vv"," 去访问 ",[18,121,20],{}," 的下载链接，看看它到底要连到哪里去。",[14,124,125],{},[51,126],{"alt":127,"src":128},"curl -vv 的访问结果","https://static.031130.xyz/uploads/2026/01/31/d3dbfc513de9f.webp",[14,130,131],{},"现在回头看我能很笃定地说：这里解析出来的这个 IP 来自 Google 的海外 CDN，而不是国内机房/国内可达的那一类。",[14,133,134],{},[51,135],{"alt":136,"src":137},"image-20260131070318960","https://static.031130.xyz/uploads/2026/01/31/7ba8a0b8a2579.webp",[14,139,140,141,143,144,146],{},"如果大家不清楚的话：",[18,142,20],{}," 针对国内访客的 DNS 解析结果，很多时候会返回国内可达的 IP（否则你也没法在境内直连下载）。而这里返回的这个海外 IP 在我这条网络上是不可达的；再加上我在喵喵工具里给 ",[18,145,20],{}," 配的是直连，于是就变成了：",[148,149,150,153],"blockquote",{},[14,151,152],{},"DNS 给了一个「海外 IP」",[91,154,155],{},[94,156,157],{},"规则要求 DIRECT\n= 直连到一个我连不上的地方\n= TLS 握手失败",[14,159,160,161],{},"所以这并不是「直连规则没生效」，而更像是：",[23,162,163],{},"规则生效得非常彻底，但 DNS 把我带沟里了。",[71,165,167],{"id":166},"谁在负责回答-dlgooglecom","谁在负责回答 dl.google.com？",[14,169,170],{},"Mihomo 内核目前的 DNS 配置项主要是下面四个：",[172,173,174,180,186,192],"ol",{},[94,175,176,179],{},[18,177,178],{},"nameserver",": 默认解析服务器（大部分域名都走这里）",[94,181,182,185],{},[18,183,184],{},"direct-nameserver",": 直连域名的解析服务器（较新版本才有）",[94,187,188,191],{},[18,189,190],{},"proxy-server-nameserver",": 节点域名解析（跟这次没啥关系）",[94,193,194,197],{},[18,195,196],{},"default-nameserver",": 用来解析 DNS 配置里「域名形式」的 nameserver（也先不展开）",[14,199,200,202,203,205,206,37],{},[18,201,20],{}," 被规则指定为直连域名，所以 Mihomo 理论上应该优先参考 ",[18,204,184],{},"；如果没设置，就回落到 ",[18,207,178],{},[14,209,210,211,213],{},"而我当时的 ",[18,212,178],{}," 配置是：",[91,215,216],{},[94,217,218],{},[18,219,220],{},"https://dns.alidns.com/dns-query",[14,222,223],{},"我当时的直觉很简单：既然解析结果像是从海外 CDN 池里出来的，那就先验证一下是不是这条阿里 DNS（DoH）返回的就是海外 IP。",[71,225,227],{"id":226},"直接查阿里-doh确实回了海外池","直接查阿里 DoH，确实回了海外池",[14,229,230],{},"阿里 DoH 提供了一个 JSON 查询接口，所以我直接用 curl 去请求：",[232,233,238],"pre",{"className":234,"code":235,"language":236,"meta":237,"style":237},"language-bash shiki shiki-themes one-light one-dark-pro","curl -s 'https://dns.alidns.com/resolve?name=dl.google.com&type=A'\n","bash","",[18,239,240],{"__ignoreMap":237},[241,242,245,249,253],"span",{"class":243,"line":244},"line",1,[241,246,248],{"class":247},"sAdtL","curl",[241,250,252],{"class":251},"sAGMh"," -s",[241,254,256],{"class":255},"sDhpE"," 'https://dns.alidns.com/resolve?name=dl.google.com&type=A'\n",[14,258,259],{},[51,260],{"alt":261,"src":262},"DoH 解析结果","https://static.031130.xyz/uploads/2026/01/31/b457af9299330.webp",[14,264,265,266],{},"返回的 IP 就是我之前遇到的那个海外 IP。到这一步我基本可以确认：",[23,267,268,269,271],{},"至少在我当前这条网络出口下，阿里 DNS 对 ",[18,270,20],{}," 的解析结果就是“那一类”我访问不到的 IP。",[273,274,276],"h3",{"id":275},"这个问题需要两个条件同时成立缺一不可","这个问题需要两个条件同时成立（缺一不可）",[14,278,279],{},"写到这里必须强调一下：这事并不是「阿里 DNS 永远解析错」这么简单，我后来做了一圈对照，发现它其实很“苛刻”：",[148,281,282],{},[14,283,284],{},"**只有在「移动宽带」+「阿里 DNS（包括 223.5.5.5 或 alidns 的 DoH）」这两个条件同时成立时，问题才可能稳定复现。**两个条件缺一不可。",[14,286,287],{},"更具体一点就是：",[91,289,290,299,305],{},[94,291,292,295,296,298],{},[23,293,294],{},"换成电信/联通的宽带","：用同样的阿里 DNS，",[18,297,20],{}," 的解析结果通常就正常",[94,300,301,304],{},[23,302,303],{},"还是移动宽带，但不用阿里 DNS","：解析结果也通常正常",[94,306,307,310],{},[23,308,309],{},"移动宽带 + 阿里 DNS","：高概率拿到海外池，然后直连就炸",[14,312,313],{},"我也用 itdog 做了下全国解析测试，移动网络下的复现比例确实更高。",[14,315,316],{},[51,317],{"alt":318,"src":319},"itdog 测试结果","https://static.031130.xyz/uploads/2026/01/31/d93222096f005.webp",[14,321,322,323],{},"为什么会这样？老实说我没有能力给一个“全网唯一真相”的解释，我只能说现象非常一致，而且足够让我下结论：",[23,324,325,326,328],{},"问题不是 TUN 本身，而是 TUN 下我的 DNS 选择把 ",[18,327,20],{}," 导向了一个在移动网络里不可达的地址池。",[71,330,332],{"id":331},"我最后怎么解决的","我最后怎么解决的？",[14,334,335,336],{},"既然问题出在「移动宽带 + 阿里 DNS」这个组合上，那解决方式也就很朴素了：",[23,337,338,339,341],{},"别让 ",[18,340,20],{}," 继续走阿里 DNS 解析。",[14,343,344],{},"可以配置 direct-nameserver 或者 nameserver-policy，可以配置 119.29.29.29 等其他公共 DNS，或者干脆把 DNS 解析交给家里的路由器。",[232,346,350],{"className":347,"code":348,"language":349,"meta":237,"style":237},"language-yaml shiki shiki-themes one-light one-dark-pro","direct-nameserver:\n  - 192.168.8.1\n\nnameserver-policy:\n  \"dl.google.com\": [119.29.29.29]\n","yaml",[18,351,352,361,370,377,385],{"__ignoreMap":237},[241,353,354,357],{"class":243,"line":244},[241,355,184],{"class":356},"sJa8x",[241,358,360],{"class":359},"s5ixo",":\n",[241,362,364,367],{"class":243,"line":363},2,[241,365,366],{"class":359},"  - ",[241,368,369],{"class":251},"192.168.8.1\n",[241,371,373],{"class":243,"line":372},3,[241,374,376],{"emptyLinePlaceholder":375},true,"\n",[241,378,380,383],{"class":243,"line":379},4,[241,381,382],{"class":356},"nameserver-policy",[241,384,360],{"class":359},[241,386,388,391,394,397],{"class":243,"line":387},5,[241,389,390],{"class":255},"  \"dl.google.com\"",[241,392,393],{"class":359},": [",[241,395,396],{"class":251},"119.29.29.29",[241,398,399],{"class":359},"]\n",[14,401,402,403,405,406,37],{},"这么搞完之后，",[18,404,43],{}," 更新恢复正常，浏览器也能直连访问 ",[18,407,20],{},[71,409,410],{"id":410},"参见",[91,412,413],{},[94,414,415],{},[28,416,419],{"href":417,"rel":418},"https://linux.do/t/topic/1061825",[32],"mihomo 内核极简防 DNS 泄漏配置（2025 年） - 开发调优 - LINUX DO",[421,422,423],"style",{},"html pre.shiki code .sAdtL, html code.shiki .sAdtL{--shiki-default:#4078F2;--shiki-dark:#61AFEF}html pre.shiki code .sAGMh, html code.shiki .sAGMh{--shiki-default:#986801;--shiki-dark:#D19A66}html pre.shiki code .sDhpE, html code.shiki .sDhpE{--shiki-default:#50A14F;--shiki-dark:#98C379}html .default .shiki span {color: var(--shiki-default);background: var(--shiki-default-bg);font-style: var(--shiki-default-font-style);font-weight: var(--shiki-default-font-weight);text-decoration: var(--shiki-default-text-decoration);}html .shiki span {color: var(--shiki-default);background: var(--shiki-default-bg);font-style: var(--shiki-default-font-style);font-weight: var(--shiki-default-font-weight);text-decoration: var(--shiki-default-text-decoration);}html .dark .shiki span {color: var(--shiki-dark);background: var(--shiki-dark-bg);font-style: var(--shiki-dark-font-style);font-weight: var(--shiki-dark-font-weight);text-decoration: var(--shiki-dark-text-decoration);}html.dark .shiki span {color: var(--shiki-dark);background: var(--shiki-dark-bg);font-style: var(--shiki-dark-font-style);font-weight: var(--shiki-dark-font-weight);text-decoration: var(--shiki-dark-text-decoration);}html pre.shiki code .sJa8x, html code.shiki .sJa8x{--shiki-default:#E45649;--shiki-dark:#E06C75}html pre.shiki code .s5ixo, html code.shiki .s5ixo{--shiki-default:#383A42;--shiki-dark:#ABB2BF}",{"title":237,"searchDepth":363,"depth":363,"links":425},[426,427,428,429,432,433],{"id":73,"depth":363,"text":74},{"id":107,"depth":363,"text":108},{"id":166,"depth":363,"text":167},{"id":226,"depth":363,"text":227,"children":430},[431],{"id":275,"depth":372,"text":276},{"id":331,"depth":363,"text":332},{"id":410,"depth":363,"text":410},"如果大家对目前中国大陆境内的网络环境足够了解，应该就会知道 dl.google.com 在很多情况下是可以直连访问的。比如，你可以通过 google.cn/chrome/?standalone=1 这个 URL 直接在境内的网络环境下下载 Chrome 的离线安装包，最终的下载域名就是 dl.google.com。",[436,437],null,{"title":438,"path":439,"stem":440,"date":441,"lang":442,"children":-1},"Vercel 的缓存控制，你注意过吗？","/2025/12/23/vercel-cache-control","posts/zh/vercel-cache-control","2025-12-23","zh-CN",9,"/en/2026/01/31/mihomo-tun-fail-to-visit-dl-google-com/",1769818297738]