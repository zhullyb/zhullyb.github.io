[{"data":1,"prerenderedAt":328},["ShallowReactive",2],{"post-2021-12-03-dev-app-update-in-wolai-zh":3,"surround-2021-12-03-dev-app-update-in-wolai-zh":314,"randomIndex/2021/12/03/dev-app-update-in-wolai/":326,"language-switch-/2021/12/03/dev-app-update-in-wolai/-en":327},{"title":4,"date":5,"path":6,"tags":7,"body":10,"description":313},"wolai再打包遇到的问题--electron应用的dev判断机制","2021-12-03 22:53:25","/2021/12/03/dev-app-update-in-wolai",[8,9],"Archlinux","electron",{"type":11,"value":12,"toc":310},"minimark",[13,30,37,40,58,61,72,78,85,97,150,153,156,240,243,249,252,306],[14,15,16,17,24,25,29],"p",{},"之前对于electron懵懵懂懂的时候就把 ",[18,19,23],"a",{"href":20,"rel":21},"https://www.wolai.com/",[22],"nofollow","wolai"," 给打包上了 AUR ，那会儿年少无知，也不懂得把内置的 electron 拆开来换成系统内置的以节省空间。前一阵子给CN源打完 Motrix 以后突然想起来自己在 AUR 上还有维护一个叫 wolai 的electron 应用，于是打算把软件内置的 electron 拆出来。尝试使用 ",[26,27,28],"code",{},"electron /path/to/app.asar"," 命令启动的时候发现了以下的问题。",[14,31,32],{},[33,34],"img",{"alt":35,"src":36},"报错了","https://static.031130.xyz/uploads/2024/08/12/62f3caf822bec.webp",[14,38,39],{},"虽然这个报错无关紧要，直接右上角叉掉也不影响软件正常使用，但是就这样推上 AUR 似乎有些不太妥当。于是使用搜索引擎查找答案。",[14,41,42,43,46,47],{},"发现是使用系统自带的 electron 启动时，app.asar 内置的一个叫 ",[26,44,45],{},"electron-updater"," 的模块在自动检测更新时会误认为我们此时处于开发模式，于是会尝试读取 app.asar 内部的 dev-app-update.yml 以查询更新。",[48,49,50],"sup",{},[18,51,57],{"href":52,"ariaDescribedBy":53,"dataFootnoteRef":55,"id":56},"#user-content-fn-1",[54],"footnote-label","","user-content-fnref-1","1",[14,59,60],{},"但问题在于这个 app.asar 并不是 wolai 开发者在开发时使用 development 模式打出来的包，应该是 production ，所以内置的那个文件名叫 app-update.yml ，少了个dev 前缀，就很尴尬。",[14,62,63,64],{},"以下内容来自一篇简书的文章",[48,65,66],{},[18,67,71],{"href":68,"ariaDescribedBy":69,"dataFootnoteRef":55,"id":70},"#user-content-fn-2",[54],"user-content-fnref-2","2",[73,74,75],"blockquote",{},[14,76,77],{},"所以调试的时候可以建一个default-app.yml文件放在D:\\hzhh123\\workspace\\vue-work\\electron-demo1\\node_modules\\electron\\dist\\resources\\default_app.asar 下，这里就涉及到asar解压缩，但是这样会很麻烦，打包后也需要这样替换，麻烦，所幸electron-updater中提供了这个文件的属性配置updateConfigPath，可以通过设置这个属性来解决这个问题",[14,79,80,81,84],{},"很遗憾，我们并不是该应用的开发者，并不能指定",[26,82,83],{},"electron-uploader","构建时的参数，所以只能考虑解压缩 app.asar 手动放入 dev-app-update.yml 的方案。",[14,86,87,88,96],{},"根据又一篇简书的文章",[48,89,90],{},[18,91,95],{"href":92,"ariaDescribedBy":93,"dataFootnoteRef":55,"id":94},"#user-content-fn-3",[54],"user-content-fnref-3","3","，我们了解到 npm 中有一个叫 asar 的程序可以帮助我们解压缩 app.asar。我这里直接将内容搬过来",[73,98,99,102,129,132],{},[14,100,101],{},"解压",[103,104,108],"pre",{"className":105,"code":106,"language":107,"meta":55,"style":55},"language-bash shiki shiki-themes one-light one-dark-pro","asar extract 压缩文件  解压文件夹\n","bash",[26,109,110],{"__ignoreMap":55},[111,112,115,119,123,126],"span",{"class":113,"line":114},"line",1,[111,116,118],{"class":117},"sAdtL","asar",[111,120,122],{"class":121},"sDhpE"," extract",[111,124,125],{"class":121}," 压缩文件",[111,127,128],{"class":121},"  解压文件夹\n",[14,130,131],{},"压缩：如果压缩文件存在，则会被替换",[103,133,135],{"className":105,"code":134,"language":107,"meta":55,"style":55},"asar pack 文件夹  压缩文件名\n",[26,136,137],{"__ignoreMap":55},[111,138,139,141,144,147],{"class":113,"line":114},[111,140,118],{"class":117},[111,142,143],{"class":121}," pack",[111,145,146],{"class":121}," 文件夹",[111,148,149],{"class":121},"  压缩文件名\n",[14,151,152],{},"原文是让我们直接使用 npm 下载安装 asar 程序，然而这就会让打包过程变得很复杂，所幸 Archlinux 官方源中已经将这个程序打完了，我们可以直接将 asar 写入 makedepends。",[14,154,155],{},"大概就写成了这个样子。",[103,157,159],{"className":105,"code":158,"language":107,"meta":55,"style":55},"asar extract ${srcdir}/squashfs-root/resources/app.asar ${srcdir}/new_app\nmv  ${srcdir}/squashfs-root/resources/app-update.yml ${srcdir}/new_app/dev-app-update.yml\nasar pack ${srcdir}/new_app ${srcdir}/squashfs-root/resources/app.asar\n",[26,160,161,190,215],{"__ignoreMap":55},[111,162,163,165,167,171,175,178,181,183,185,187],{"class":113,"line":114},[111,164,118],{"class":117},[111,166,122],{"class":121},[111,168,170],{"class":169},"sr1Ac"," ${",[111,172,174],{"class":173},"sJa8x","srcdir",[111,176,177],{"class":169},"}",[111,179,180],{"class":121},"/squashfs-root/resources/app.asar",[111,182,170],{"class":169},[111,184,174],{"class":173},[111,186,177],{"class":169},[111,188,189],{"class":121},"/new_app\n",[111,191,193,196,199,201,203,206,208,210,212],{"class":113,"line":192},2,[111,194,195],{"class":117},"mv",[111,197,198],{"class":169},"  ${",[111,200,174],{"class":173},[111,202,177],{"class":169},[111,204,205],{"class":121},"/squashfs-root/resources/app-update.yml",[111,207,170],{"class":169},[111,209,174],{"class":173},[111,211,177],{"class":169},[111,213,214],{"class":121},"/new_app/dev-app-update.yml\n",[111,216,218,220,222,224,226,228,231,233,235,237],{"class":113,"line":217},3,[111,219,118],{"class":117},[111,221,143],{"class":121},[111,223,170],{"class":169},[111,225,174],{"class":173},[111,227,177],{"class":169},[111,229,230],{"class":121},"/new_app",[111,232,170],{"class":169},[111,234,174],{"class":173},[111,236,177],{"class":169},[111,238,239],{"class":121},"/squashfs-root/resources/app.asar\n",[14,241,242],{},"程序正常启动，没有弹出之前的对话框了。",[14,244,245],{},[33,246],{"alt":247,"src":248},"成功啦","https://static.031130.xyz/uploads/2024/08/12/62f3cafb6b04d.webp",[14,250,251],{},"参考:",[253,254,257,263],"section",{"className":255,"dataFootnotes":55},[256],"footnotes",[258,259,262],"h2",{"className":260,"id":54},[261],"sr-only","Footnotes",[264,265,266,282,294],"ol",{},[267,268,270,274,275],"li",{"id":269},"user-content-fn-1",[18,271,272],{"href":272,"rel":273},"https://github.com/electron-userland/electron-builder/issues/1505",[22]," ",[18,276,281],{"href":277,"ariaLabel":278,"className":279,"dataFootnoteBackref":55},"#user-content-fnref-1","Back to reference 1",[280],"data-footnote-backref","↩",[267,283,285,274,289],{"id":284},"user-content-fn-2",[18,286,287],{"href":287,"rel":288},"https://www.jianshu.com/p/15bde714e198",[22],[18,290,281],{"href":291,"ariaLabel":292,"className":293,"dataFootnoteBackref":55},"#user-content-fnref-2","Back to reference 2",[280],[267,295,297,274,301],{"id":296},"user-content-fn-3",[18,298,299],{"href":299,"rel":300},"https://www.jianshu.com/p/17d97e6bf174",[22],[18,302,281],{"href":303,"ariaLabel":304,"className":305,"dataFootnoteBackref":55},"#user-content-fnref-3","Back to reference 3",[280],[307,308,309],"style",{},"html pre.shiki code .sAdtL, html code.shiki .sAdtL{--shiki-default:#4078F2;--shiki-dark:#61AFEF}html pre.shiki code .sDhpE, html code.shiki .sDhpE{--shiki-default:#50A14F;--shiki-dark:#98C379}html .default .shiki span {color: var(--shiki-default);background: var(--shiki-default-bg);font-style: var(--shiki-default-font-style);font-weight: var(--shiki-default-font-weight);text-decoration: var(--shiki-default-text-decoration);}html .shiki span {color: var(--shiki-default);background: var(--shiki-default-bg);font-style: var(--shiki-default-font-style);font-weight: var(--shiki-default-font-weight);text-decoration: var(--shiki-default-text-decoration);}html .dark .shiki span {color: var(--shiki-dark);background: var(--shiki-dark-bg);font-style: var(--shiki-dark-font-style);font-weight: var(--shiki-dark-font-weight);text-decoration: var(--shiki-dark-text-decoration);}html.dark .shiki span {color: var(--shiki-dark);background: var(--shiki-dark-bg);font-style: var(--shiki-dark-font-style);font-weight: var(--shiki-dark-font-weight);text-decoration: var(--shiki-dark-text-decoration);}html pre.shiki code .sr1Ac, html code.shiki .sr1Ac{--shiki-default:#E45649;--shiki-dark:#ABB2BF}html pre.shiki code .sJa8x, html code.shiki .sJa8x{--shiki-default:#E45649;--shiki-dark:#E06C75}",{"title":55,"searchDepth":192,"depth":192,"links":311},[312],{"id":54,"depth":192,"text":262},"之前对于electron懵懵懂懂的时候就把 wolai 给打包上了 AUR ，那会儿年少无知，也不懂得把内置的 electron 拆开来换成系统内置的以节省空间。前一阵子给CN源打完 Motrix 以后突然想起来自己在 AUR 上还有维护一个叫 wolai 的electron 应用，于是打算把软件内置的 electron 拆出来。尝试使用 electron /path/to/app.asar 命令启动的时候发现了以下的问题。",[315,321],{"title":316,"path":317,"stem":318,"date":319,"lang":320,"children":-1},"Cutefish的前世今生","/2021/12/12/the-history-of-cutefish","posts/zh/the-history-of-cutefish","2021-12-12 00:10:34","zh-CN",{"title":322,"path":323,"stem":324,"date":325,"lang":320,"children":-1},"Typora与我","/2021/11/26/typora-and-me","posts/zh/typora-and-me","2021-11-26 23:05:05",5,null,1766532349702]