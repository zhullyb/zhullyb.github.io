[{"data":1,"prerenderedAt":321},["ShallowReactive",2],{"post-2021-12-03-dev-app-update-in-wolai":3,"surround-2021-12-03-dev-app-update-in-wolai":309,"randomIndex/2021/12/03/dev-app-update-in-wolai/":320},{"id":4,"title":5,"body":6,"date":295,"description":296,"extension":297,"meta":298,"navigation":299,"path":300,"rawbody":301,"seo":302,"stem":303,"sticky":304,"tags":305,"__hash__":308},"posts/posts/dev-app-update-in-wolai.md","wolai再打包遇到的问题--electron应用的dev判断机制",{"type":7,"value":8,"toc":292},"minimark",[9,26,33,36,54,57,68,74,81,93,125,128,131,222,225,231,234,288],[10,11,12,13,20,21,25],"p",{},"之前对于electron懵懵懂懂的时候就把 ",[14,15,19],"a",{"href":16,"rel":17},"https://www.wolai.com/",[18],"nofollow","wolai"," 给打包上了 AUR ，那会儿年少无知，也不懂得把内置的 electron 拆开来换成系统内置的以节省空间。前一阵子给CN源打完 Motrix 以后突然想起来自己在 AUR 上还有维护一个叫 wolai 的electron 应用，于是打算把软件内置的 electron 拆出来。尝试使用 ",[22,23,24],"code",{},"electron /path/to/app.asar"," 命令启动的时候发现了以下的问题。",[10,27,28],{},[29,30],"img",{"alt":31,"src":32},"报错了","https://static.031130.xyz/uploads/2024/08/12/62f3caf822bec.webp",[10,34,35],{},"虽然这个报错无关紧要，直接右上角叉掉也不影响软件正常使用，但是就这样推上 AUR 似乎有些不太妥当。于是使用搜索引擎查找答案。",[10,37,38,39,42,43],{},"发现是使用系统自带的 electron 启动时，app.asar 内置的一个叫 ",[22,40,41],{},"electron-updater"," 的模块在自动检测更新时会误认为我们此时处于开发模式，于是会尝试读取 app.asar 内部的 dev-app-update.yml 以查询更新。",[44,45,46],"sup",{},[14,47,53],{"href":48,"ariaDescribedBy":49,"dataFootnoteRef":51,"id":52},"#user-content-fn-1",[50],"footnote-label","","user-content-fnref-1","1",[10,55,56],{},"但问题在于这个 app.asar 并不是 wolai 开发者在开发时使用 development 模式打出来的包，应该是 production ，所以内置的那个文件名叫 app-update.yml ，少了个dev 前缀，就很尴尬。",[10,58,59,60],{},"以下内容来自一篇简书的文章",[44,61,62],{},[14,63,67],{"href":64,"ariaDescribedBy":65,"dataFootnoteRef":51,"id":66},"#user-content-fn-2",[50],"user-content-fnref-2","2",[69,70,71],"blockquote",{},[10,72,73],{},"所以调试的时候可以建一个default-app.yml文件放在D:\\hzhh123\\workspace\\vue-work\\electron-demo1\\node_modules\\electron\\dist\\resources\\default_app.asar 下，这里就涉及到asar解压缩，但是这样会很麻烦，打包后也需要这样替换，麻烦，所幸electron-updater中提供了这个文件的属性配置updateConfigPath，可以通过设置这个属性来解决这个问题",[10,75,76,77,80],{},"很遗憾，我们并不是该应用的开发者，并不能指定",[22,78,79],{},"electron-uploader","构建时的参数，所以只能考虑解压缩 app.asar 手动放入 dev-app-update.yml 的方案。",[10,82,83,84,92],{},"根据又一篇简书的文章",[44,85,86],{},[14,87,91],{"href":88,"ariaDescribedBy":89,"dataFootnoteRef":51,"id":90},"#user-content-fn-3",[50],"user-content-fnref-3","3","，我们了解到 npm 中有一个叫 asar 的程序可以帮助我们解压缩 app.asar。我这里直接将内容搬过来",[69,94,95,98,113,116],{},[10,96,97],{},"解压",[99,100,104],"pre",{"className":101,"code":102,"language":103,"meta":51,"style":51},"language-undefined shiki shiki-themes one-light one-dark-pro","asar extract 压缩文件  解压文件夹\n","undefined",[22,105,106],{"__ignoreMap":51},[107,108,111],"span",{"class":109,"line":110},"line",1,[107,112,102],{},[10,114,115],{},"压缩：如果压缩文件存在，则会被替换",[99,117,119],{"className":101,"code":118,"language":103,"meta":51,"style":51},"asar pack 文件夹  压缩文件名\n",[22,120,121],{"__ignoreMap":51},[107,122,123],{"class":109,"line":110},[107,124,118],{},[10,126,127],{},"原文是让我们直接使用 npm 下载安装 asar 程序，然而这就会让打包过程变得很复杂，所幸 Archlinux 官方源中已经将这个程序打完了，我们可以直接将 asar 写入 makedepends。",[10,129,130],{},"大概就写成了这个样子。",[99,132,136],{"className":133,"code":134,"language":135,"meta":51,"style":51},"language-bash shiki shiki-themes one-light one-dark-pro","asar extract ${srcdir}/squashfs-root/resources/app.asar ${srcdir}/new_app\nmv  ${srcdir}/squashfs-root/resources/app-update.yml ${srcdir}/new_app/dev-app-update.yml\nasar pack ${srcdir}/new_app ${srcdir}/squashfs-root/resources/app.asar\n","bash",[22,137,138,171,196],{"__ignoreMap":51},[107,139,140,144,148,152,156,159,162,164,166,168],{"class":109,"line":110},[107,141,143],{"class":142},"sAdtL","asar",[107,145,147],{"class":146},"sDhpE"," extract",[107,149,151],{"class":150},"sr1Ac"," ${",[107,153,155],{"class":154},"sJa8x","srcdir",[107,157,158],{"class":150},"}",[107,160,161],{"class":146},"/squashfs-root/resources/app.asar",[107,163,151],{"class":150},[107,165,155],{"class":154},[107,167,158],{"class":150},[107,169,170],{"class":146},"/new_app\n",[107,172,174,177,180,182,184,187,189,191,193],{"class":109,"line":173},2,[107,175,176],{"class":142},"mv",[107,178,179],{"class":150},"  ${",[107,181,155],{"class":154},[107,183,158],{"class":150},[107,185,186],{"class":146},"/squashfs-root/resources/app-update.yml",[107,188,151],{"class":150},[107,190,155],{"class":154},[107,192,158],{"class":150},[107,194,195],{"class":146},"/new_app/dev-app-update.yml\n",[107,197,199,201,204,206,208,210,213,215,217,219],{"class":109,"line":198},3,[107,200,143],{"class":142},[107,202,203],{"class":146}," pack",[107,205,151],{"class":150},[107,207,155],{"class":154},[107,209,158],{"class":150},[107,211,212],{"class":146},"/new_app",[107,214,151],{"class":150},[107,216,155],{"class":154},[107,218,158],{"class":150},[107,220,221],{"class":146},"/squashfs-root/resources/app.asar\n",[10,223,224],{},"程序正常启动，没有弹出之前的对话框了。",[10,226,227],{},[29,228],{"alt":229,"src":230},"成功啦","https://static.031130.xyz/uploads/2024/08/12/62f3cafb6b04d.webp",[10,232,233],{},"参考:",[235,236,239,245],"section",{"className":237,"dataFootnotes":51},[238],"footnotes",[240,241,244],"h2",{"className":242,"id":50},[243],"sr-only","Footnotes",[246,247,248,264,276],"ol",{},[249,250,252,256,257],"li",{"id":251},"user-content-fn-1",[14,253,254],{"href":254,"rel":255},"https://github.com/electron-userland/electron-builder/issues/1505",[18]," ",[14,258,263],{"href":259,"ariaLabel":260,"className":261,"dataFootnoteBackref":51},"#user-content-fnref-1","Back to reference 1",[262],"data-footnote-backref","↩",[249,265,267,256,271],{"id":266},"user-content-fn-2",[14,268,269],{"href":269,"rel":270},"https://www.jianshu.com/p/15bde714e198",[18],[14,272,263],{"href":273,"ariaLabel":274,"className":275,"dataFootnoteBackref":51},"#user-content-fnref-2","Back to reference 2",[262],[249,277,279,256,283],{"id":278},"user-content-fn-3",[14,280,281],{"href":281,"rel":282},"https://www.jianshu.com/p/17d97e6bf174",[18],[14,284,263],{"href":285,"ariaLabel":286,"className":287,"dataFootnoteBackref":51},"#user-content-fnref-3","Back to reference 3",[262],[289,290,291],"style",{},"html .default .shiki span {color: var(--shiki-default);background: var(--shiki-default-bg);font-style: var(--shiki-default-font-style);font-weight: var(--shiki-default-font-weight);text-decoration: var(--shiki-default-text-decoration);}html .shiki span {color: var(--shiki-default);background: var(--shiki-default-bg);font-style: var(--shiki-default-font-style);font-weight: var(--shiki-default-font-weight);text-decoration: var(--shiki-default-text-decoration);}html .dark .shiki span {color: var(--shiki-dark);background: var(--shiki-dark-bg);font-style: var(--shiki-dark-font-style);font-weight: var(--shiki-dark-font-weight);text-decoration: var(--shiki-dark-text-decoration);}html.dark .shiki span {color: var(--shiki-dark);background: var(--shiki-dark-bg);font-style: var(--shiki-dark-font-style);font-weight: var(--shiki-dark-font-weight);text-decoration: var(--shiki-dark-text-decoration);}html pre.shiki code .sAdtL, html code.shiki .sAdtL{--shiki-default:#4078F2;--shiki-dark:#61AFEF}html pre.shiki code .sDhpE, html code.shiki .sDhpE{--shiki-default:#50A14F;--shiki-dark:#98C379}html pre.shiki code .sr1Ac, html code.shiki .sr1Ac{--shiki-default:#E45649;--shiki-dark:#ABB2BF}html pre.shiki code .sJa8x, html code.shiki .sJa8x{--shiki-default:#E45649;--shiki-dark:#E06C75}",{"title":51,"searchDepth":173,"depth":173,"links":293},[294],{"id":50,"depth":173,"text":244},"2021-12-03 22:53:25","之前对于electron懵懵懂懂的时候就把 wolai 给打包上了 AUR ，那会儿年少无知，也不懂得把内置的 electron 拆开来换成系统内置的以节省空间。前一阵子给CN源打完 Motrix 以后突然想起来自己在 AUR 上还有维护一个叫 wolai 的electron 应用，于是打算把软件内置的 electron 拆出来。尝试使用 electron /path/to/app.asar 命令启动的时候发现了以下的问题。","md",{},true,"/2021/12/03/dev-app-update-in-wolai","---\ntitle: wolai再打包遇到的问题--electron应用的dev判断机制\ndate: 2021-12-03 22:53:25\nsticky:\ntags:\n- Archlinux\n- electron\n---\n\n之前对于electron懵懵懂懂的时候就把 [wolai](https://www.wolai.com/) 给打包上了 AUR ，那会儿年少无知，也不懂得把内置的 electron 拆开来换成系统内置的以节省空间。前一阵子给CN源打完 Motrix 以后突然想起来自己在 AUR 上还有维护一个叫 wolai 的electron 应用，于是打算把软件内置的 electron 拆出来。尝试使用 `electron /path/to/app.asar` 命令启动的时候发现了以下的问题。\n\n![报错了](https://static.031130.xyz/uploads/2024/08/12/62f3caf822bec.webp)\n\n虽然这个报错无关紧要，直接右上角叉掉也不影响软件正常使用，但是就这样推上 AUR 似乎有些不太妥当。于是使用搜索引擎查找答案。\n\n发现是使用系统自带的 electron 启动时，app.asar 内置的一个叫 `electron-updater` 的模块在自动检测更新时会误认为我们此时处于开发模式，于是会尝试读取 app.asar 内部的 dev-app-update.yml 以查询更新。[^1]\n\n但问题在于这个 app.asar 并不是 wolai 开发者在开发时使用 development 模式打出来的包，应该是 production ，所以内置的那个文件名叫 app-update.yml ，少了个dev 前缀，就很尴尬。\n\n以下内容来自一篇简书的文章[^2]\n\n> 所以调试的时候可以建一个default-app.yml文件放在D:\\hzhh123\\workspace\\vue-work\\electron-demo1\\node_modules\\electron\\dist\\resources\\default_app.asar 下，这里就涉及到asar解压缩，但是这样会很麻烦，打包后也需要这样替换，麻烦，所幸electron-updater中提供了这个文件的属性配置updateConfigPath，可以通过设置这个属性来解决这个问题\n\n很遗憾，我们并不是该应用的开发者，并不能指定`electron-uploader`构建时的参数，所以只能考虑解压缩 app.asar 手动放入 dev-app-update.yml 的方案。\n\n根据又一篇简书的文章[^3]，我们了解到 npm 中有一个叫 asar 的程序可以帮助我们解压缩 app.asar。我这里直接将内容搬过来\n\n> 解压\n>\n> ```undefined\n> asar extract 压缩文件  解压文件夹\n> ```\n>\n> 压缩：如果压缩文件存在，则会被替换\n>\n> ```undefined\n> asar pack 文件夹  压缩文件名\n> ```\n\n原文是让我们直接使用 npm 下载安装 asar 程序，然而这就会让打包过程变得很复杂，所幸 Archlinux 官方源中已经将这个程序打完了，我们可以直接将 asar 写入 makedepends。\n\n大概就写成了这个样子。\n\n```bash\nasar extract ${srcdir}/squashfs-root/resources/app.asar ${srcdir}/new_app\nmv  ${srcdir}/squashfs-root/resources/app-update.yml ${srcdir}/new_app/dev-app-update.yml\nasar pack ${srcdir}/new_app ${srcdir}/squashfs-root/resources/app.asar\n```\n\n程序正常启动，没有弹出之前的对话框了。\n\n![成功啦](https://static.031130.xyz/uploads/2024/08/12/62f3cafb6b04d.webp)\n\n参考: \n\n[^1]: https://github.com/electron-userland/electron-builder/issues/1505\n[^2]: https://www.jianshu.com/p/15bde714e198\n[^3]: https://www.jianshu.com/p/17d97e6bf174\n\n",{"title":5,"description":296},"posts/dev-app-update-in-wolai",false,[306,307],"Archlinux","electron","lFOX_T_tkdP_ICa5Uh90uvE571RRQ8DNOC327KmNb10",[310,315],{"title":311,"path":312,"stem":313,"date":314,"children":-1},"Cutefish的前世今生","/2021/12/12/the-history-of-cutefish","posts/the-history-of-cutefish","2021-12-12 00:10:34",{"title":316,"path":317,"stem":318,"date":319,"children":-1},"Typora与我","/2021/11/26/typora-and-me","posts/typora-and-me","2021-11-26 23:05:05",4,1762357993101]