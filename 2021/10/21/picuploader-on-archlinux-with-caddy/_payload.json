[{"data":1,"prerenderedAt":1070},["ShallowReactive",2],{"post-2021-10-21-picuploader-on-archlinux-with-caddy-zh":3,"surround-2021-10-21-picuploader-on-archlinux-with-caddy-zh":1058,"randomIndex/2021/10/21/picuploader-on-archlinux-with-caddy/":54,"language-switch-/2021/10/21/picuploader-on-archlinux-with-caddy/-en":1069},{"id":4,"title":5,"body":6,"date":1043,"description":47,"extension":1044,"lang":1045,"meta":1046,"navigation":640,"path":1047,"rawbody":1048,"seo":1049,"stem":1050,"sticky":1051,"tags":1052,"__hash__":1057},"posts/posts/zh/picuploader-on-archlinux-with-caddy.md","PicUploader使用系列（一）——在Archlinux上使用Caddy部署PicUploader",{"type":7,"value":8,"toc":1024},"minimark",[9,27,41,82,88,97,121,387,394,400,415,422,579,590,777,781,784,802,805,826,829,849,853,860,863,870,878,892,896,903,927,930,936,940,943,961,964,967,975,998,1001,1009,1012,1020],[10,11,12,16],"blockquote",{},[13,14,15],"p",{},"之前找对大陆网络友好的图床时，找到了cloudinary，但是全英文界面对操作增加了不少难度，其页面也不是很简洁，让我一下打消了使用网页版的念头。通过搜索，找到了 PicUploader 这一方案，使用php编写，支持cloudinary的api。",[13,17,18,19,26],{},"作者在其",[20,21,25],"a",{"href":22,"rel":23},"https://www.xiebruce.top/17.html",[24],"nofollow","博客","中仅提供了nginx的部署方案，我参考其配置文件成功实现了在caddy下的部署，并且花费了数个小时排坑，故写下本文帮助后来者节省时间。",[28,29,31,32,36,37,40],"h2",{"id":30},"安装caddy和php-fpm以及所需的拓展","安装",[33,34,35],"code",{},"caddy","和",[33,38,39],{},"php-fpm","以及所需的拓展",[42,43,48],"pre",{"className":44,"code":45,"language":46,"meta":47,"style":47},"language-bash shiki shiki-themes one-light one-dark-pro","sudo pacman -S caddy php-fpm php-gd php-sqlite --needed\n","bash","",[33,49,50],{"__ignoreMap":47},[51,52,55,59,63,67,70,73,76,79],"span",{"class":53,"line":54},"line",1,[51,56,58],{"class":57},"sAdtL","sudo",[51,60,62],{"class":61},"sDhpE"," pacman",[51,64,66],{"class":65},"sAGMh"," -S",[51,68,69],{"class":61}," caddy",[51,71,72],{"class":61}," php-fpm",[51,74,75],{"class":61}," php-gd",[51,77,78],{"class":61}," php-sqlite",[51,80,81],{"class":65}," --needed\n",[28,83,85,86],{"id":84},"配置php-fpm","配置",[33,87,39],{},[89,90,92,93,96],"h3",{"id":91},"在etcphpphpini启用picuploader所需拓展","在",[33,94,95],{},"/etc/php/php.ini","启用PicUploader所需拓展",[13,98,99,100,103,104,103,107,103,110,103,113,116,117,120],{},"PicUploaer依赖于",[33,101,102],{},"fileinfo","、",[33,105,106],{},"gd",[33,108,109],{},"curl",[33,111,112],{},"exif",[33,114,115],{},"pdo_sqlite","拓展，可以使用",[33,118,119],{},"php -m","命令来查看目前加载成功了的插件。",[42,122,126],{"className":123,"code":124,"language":125,"meta":47,"style":47},"language-diff shiki shiki-themes one-light one-dark-pro",";extension=bcmath\n;extension=bz2\n;extension=calendar\n- extension=curl\n+ extension=curl\n;extension=dba\n;extension=enchant\n- extension=exif\n+ extension=exif\n;extension=ffi\n;extension=ftp\n- extension=gd\n+ extension=gd\n;extension=gettext\n;extension=gmp\n;extension=iconv\n;extension=imap\n;extension=intl\n;extension=ldap\n;extension=mysqli\n;extension=odbc\n;zend_extension=opcache\n;extension=pdo_dblib\n;extension=pdo_mysql\n;extension=pdo_odbc\n;extension=pdo_pgsql\n- extension=pdo_sqlite\n+ extension=pdo_sqlite\n;extension=pgsql\n;extension=pspell\n;extension=shmop\n;extension=snmp\n;extension=soap\n;extension=sockets\n;extension=sodium\n;extension=sqlite3\n;extension=sysvmsg\n;extension=sysvsem\n;extension=sysvshm\n;extension=tidy\n;extension=xmlrpc\n;extension=xsl\nextension=zip\n","diff",[33,127,128,134,140,146,153,159,165,171,177,183,189,195,201,207,213,219,225,231,237,243,249,255,261,267,273,279,285,291,297,303,309,315,321,327,333,339,345,351,357,363,369,375,381],{"__ignoreMap":47},[51,129,130],{"class":53,"line":54},[51,131,133],{"class":132},"s5ixo",";extension=bcmath\n",[51,135,137],{"class":53,"line":136},2,[51,138,139],{"class":132},";extension=bz2\n",[51,141,143],{"class":53,"line":142},3,[51,144,145],{"class":132},";extension=calendar\n",[51,147,149],{"class":53,"line":148},4,[51,150,152],{"class":151},"sJa8x","- extension=curl\n",[51,154,156],{"class":53,"line":155},5,[51,157,158],{"class":61},"+ extension=curl\n",[51,160,162],{"class":53,"line":161},6,[51,163,164],{"class":132},";extension=dba\n",[51,166,168],{"class":53,"line":167},7,[51,169,170],{"class":132},";extension=enchant\n",[51,172,174],{"class":53,"line":173},8,[51,175,176],{"class":151},"- extension=exif\n",[51,178,180],{"class":53,"line":179},9,[51,181,182],{"class":61},"+ extension=exif\n",[51,184,186],{"class":53,"line":185},10,[51,187,188],{"class":132},";extension=ffi\n",[51,190,192],{"class":53,"line":191},11,[51,193,194],{"class":132},";extension=ftp\n",[51,196,198],{"class":53,"line":197},12,[51,199,200],{"class":151},"- extension=gd\n",[51,202,204],{"class":53,"line":203},13,[51,205,206],{"class":61},"+ extension=gd\n",[51,208,210],{"class":53,"line":209},14,[51,211,212],{"class":132},";extension=gettext\n",[51,214,216],{"class":53,"line":215},15,[51,217,218],{"class":132},";extension=gmp\n",[51,220,222],{"class":53,"line":221},16,[51,223,224],{"class":132},";extension=iconv\n",[51,226,228],{"class":53,"line":227},17,[51,229,230],{"class":132},";extension=imap\n",[51,232,234],{"class":53,"line":233},18,[51,235,236],{"class":132},";extension=intl\n",[51,238,240],{"class":53,"line":239},19,[51,241,242],{"class":132},";extension=ldap\n",[51,244,246],{"class":53,"line":245},20,[51,247,248],{"class":132},";extension=mysqli\n",[51,250,252],{"class":53,"line":251},21,[51,253,254],{"class":132},";extension=odbc\n",[51,256,258],{"class":53,"line":257},22,[51,259,260],{"class":132},";zend_extension=opcache\n",[51,262,264],{"class":53,"line":263},23,[51,265,266],{"class":132},";extension=pdo_dblib\n",[51,268,270],{"class":53,"line":269},24,[51,271,272],{"class":132},";extension=pdo_mysql\n",[51,274,276],{"class":53,"line":275},25,[51,277,278],{"class":132},";extension=pdo_odbc\n",[51,280,282],{"class":53,"line":281},26,[51,283,284],{"class":132},";extension=pdo_pgsql\n",[51,286,288],{"class":53,"line":287},27,[51,289,290],{"class":151},"- extension=pdo_sqlite\n",[51,292,294],{"class":53,"line":293},28,[51,295,296],{"class":61},"+ extension=pdo_sqlite\n",[51,298,300],{"class":53,"line":299},29,[51,301,302],{"class":132},";extension=pgsql\n",[51,304,306],{"class":53,"line":305},30,[51,307,308],{"class":132},";extension=pspell\n",[51,310,312],{"class":53,"line":311},31,[51,313,314],{"class":132},";extension=shmop\n",[51,316,318],{"class":53,"line":317},32,[51,319,320],{"class":132},";extension=snmp\n",[51,322,324],{"class":53,"line":323},33,[51,325,326],{"class":132},";extension=soap\n",[51,328,330],{"class":53,"line":329},34,[51,331,332],{"class":132},";extension=sockets\n",[51,334,336],{"class":53,"line":335},35,[51,337,338],{"class":132},";extension=sodium\n",[51,340,342],{"class":53,"line":341},36,[51,343,344],{"class":132},";extension=sqlite3\n",[51,346,348],{"class":53,"line":347},37,[51,349,350],{"class":132},";extension=sysvmsg\n",[51,352,354],{"class":53,"line":353},38,[51,355,356],{"class":132},";extension=sysvsem\n",[51,358,360],{"class":53,"line":359},39,[51,361,362],{"class":132},";extension=sysvshm\n",[51,364,366],{"class":53,"line":365},40,[51,367,368],{"class":132},";extension=tidy\n",[51,370,372],{"class":53,"line":371},41,[51,373,374],{"class":132},";extension=xmlrpc\n",[51,376,378],{"class":53,"line":377},42,[51,379,380],{"class":132},";extension=xsl\n",[51,382,384],{"class":53,"line":383},43,[51,385,386],{"class":132},"extension=zip\n",[89,388,390,391,393],{"id":389},"编辑etcphpphpini以增加单文件上传大小限制","编辑",[33,392,95],{},"以增加单文件上传大小限制",[13,395,396],{},[397,398,399],"del",{},"查出这个问题浪费了我整整4小时时间。",[42,401,403],{"className":123,"code":402,"language":125,"meta":47,"style":47},"- upload_max_filesize = 2M\n+ upload_max_filesize = 100M\n",[33,404,405,410],{"__ignoreMap":47},[51,406,407],{"class":53,"line":54},[51,408,409],{"class":151},"- upload_max_filesize = 2M\n",[51,411,412],{"class":53,"line":136},[51,413,414],{"class":61},"+ upload_max_filesize = 100M\n",[89,416,390,418,421],{"id":417},"编辑etcphpphp-fpmdwwwconf使其在运行时使用caddy用户",[33,419,420],{},"/etc/php/php-fpm.d/www.conf","使其在运行时使用caddy用户。",[42,423,425],{"className":123,"code":424,"language":125,"meta":47,"style":47},"---\n; Unix user/group of processes\n; Note: The user is mandatory. If the group is not set, the default user's group\n;       will be used.\n- user = http\n+ user = caddy\n- group = http\n+ group = caddy\n; The address on which to accept FastCGI requests.\n; Valid syntaxes are:\n;   'ip.add.re.ss:port'    - to listen on a TCP socket to a specific IPv4 address on\n;                            a specific port;\n;   '[ip:6:addr:ess]:port' - to listen on a TCP socket to a specific IPv6 address on\n---\n---\n; Note: This value is mandatory.\nlisten = /run/php-fpm/php-fpm.sock\n; and group can be specified either by name or by their numeric IDs.\n; Default Values: user and group are set as the running user\n;                 mode is set to 0660\n- listen.owner = http\n+ listen.owner = caddy\n- listen.group = http\n+ listen.group = caddy\n;listen.mode = 0660\n; When POSIX Access Control Lists are supported you can set them using\n; these options, value is a comma separated list of user/group names.\n; When set, listen.owner and listen.group are ignored\n;listen.acl_users =\n;listen.acl_groups =\n---\n",[33,426,427,432,437,442,447,452,457,462,467,472,477,482,487,492,496,500,505,510,515,520,525,530,535,540,545,550,555,560,565,570,575],{"__ignoreMap":47},[51,428,429],{"class":53,"line":54},[51,430,431],{"class":132},"---\n",[51,433,434],{"class":53,"line":136},[51,435,436],{"class":132},"; Unix user/group of processes\n",[51,438,439],{"class":53,"line":142},[51,440,441],{"class":132},"; Note: The user is mandatory. If the group is not set, the default user's group\n",[51,443,444],{"class":53,"line":148},[51,445,446],{"class":132},";       will be used.\n",[51,448,449],{"class":53,"line":155},[51,450,451],{"class":151},"- user = http\n",[51,453,454],{"class":53,"line":161},[51,455,456],{"class":61},"+ user = caddy\n",[51,458,459],{"class":53,"line":167},[51,460,461],{"class":151},"- group = http\n",[51,463,464],{"class":53,"line":173},[51,465,466],{"class":61},"+ group = caddy\n",[51,468,469],{"class":53,"line":179},[51,470,471],{"class":132},"; The address on which to accept FastCGI requests.\n",[51,473,474],{"class":53,"line":185},[51,475,476],{"class":132},"; Valid syntaxes are:\n",[51,478,479],{"class":53,"line":191},[51,480,481],{"class":132},";   'ip.add.re.ss:port'    - to listen on a TCP socket to a specific IPv4 address on\n",[51,483,484],{"class":53,"line":197},[51,485,486],{"class":132},";                            a specific port;\n",[51,488,489],{"class":53,"line":203},[51,490,491],{"class":132},";   '[ip:6:addr:ess]:port' - to listen on a TCP socket to a specific IPv6 address on\n",[51,493,494],{"class":53,"line":209},[51,495,431],{"class":132},[51,497,498],{"class":53,"line":215},[51,499,431],{"class":132},[51,501,502],{"class":53,"line":221},[51,503,504],{"class":132},"; Note: This value is mandatory.\n",[51,506,507],{"class":53,"line":227},[51,508,509],{"class":132},"listen = /run/php-fpm/php-fpm.sock\n",[51,511,512],{"class":53,"line":233},[51,513,514],{"class":132},"; and group can be specified either by name or by their numeric IDs.\n",[51,516,517],{"class":53,"line":239},[51,518,519],{"class":132},"; Default Values: user and group are set as the running user\n",[51,521,522],{"class":53,"line":245},[51,523,524],{"class":132},";                 mode is set to 0660\n",[51,526,527],{"class":53,"line":251},[51,528,529],{"class":151},"- listen.owner = http\n",[51,531,532],{"class":53,"line":257},[51,533,534],{"class":61},"+ listen.owner = caddy\n",[51,536,537],{"class":53,"line":263},[51,538,539],{"class":151},"- listen.group = http\n",[51,541,542],{"class":53,"line":269},[51,543,544],{"class":61},"+ listen.group = caddy\n",[51,546,547],{"class":53,"line":275},[51,548,549],{"class":132},";listen.mode = 0660\n",[51,551,552],{"class":53,"line":281},[51,553,554],{"class":132},"; When POSIX Access Control Lists are supported you can set them using\n",[51,556,557],{"class":53,"line":287},[51,558,559],{"class":132},"; these options, value is a comma separated list of user/group names.\n",[51,561,562],{"class":53,"line":293},[51,563,564],{"class":132},"; When set, listen.owner and listen.group are ignored\n",[51,566,567],{"class":53,"line":299},[51,568,569],{"class":132},";listen.acl_users =\n",[51,571,572],{"class":53,"line":305},[51,573,574],{"class":132},";listen.acl_groups =\n",[51,576,577],{"class":53,"line":311},[51,578,431],{"class":132},[13,580,581,585,586,589],{},[582,583,584],"strong",{},"2022年1月14日更新","：在 Fedora 尝试部署的时候遇到了新的坑，Fedora 的相应配置文件为 ",[33,587,588],{},"/etc/php-fpm.d/www.conf","，相应修改如下",[42,591,593],{"className":123,"code":592,"language":125,"meta":47,"style":47},"; Unix user/group of processes\n; Note: The user is mandatory. If the group is not set, the default user's group\n;       will be used.\n; RPM: apache user chosen to provide access to the same directories as httpd\n-user = apache\n+user = caddy\n; RPM: Keep a group allowed to write in log dir.\n-user = apache\n+group = caddy\n\n; The address on which to accept FastCGI requests.\n; Valid syntaxes are:\n;   'ip.add.re.ss:port'    - to listen on a TCP socket to a specific IPv4 address on\n;             a specific port;\n---\n---\n; Set permissions for unix socket, if one is used. In Linux, read/write\n; permissions must be set in order to allow connections from a web server.\n; Default Values: user and group are set as the running user\n;                 mode is set to 0660\n-;listen.owner = nobody\n+listen.owner = caddy\n-;listen.owner = nobody\n+listen.group = caddy\n;listen.mode = 0660\n\n; When POSIX Access Control Lists are supported you can set them using\n; these options, value is a comma separated list of user/group names.\n; When set, listen.owner and listen.group are ignored\n-listen.acl_users = apache,nginx\n+;listen.acl_users = apache,nginx\n;listen.acl_groups =\n\n; List of addresses (IPv4/IPv6) of FastCGI clients which are allowed to connect.\n; Equivalent to the FCGI_WEB_SERVER_ADDRS environment variable in the original\n; PHP FCGI (5.2.2+). Makes sense only with a tcp listening socket. Each address\n; must be separated by a comma. If this value is left blank, connections will be\n; accepted from any ip address.\n; Default Value: any\nlisten.allowed_clients = 127.0.0.1\n",[33,594,595,599,603,607,612,617,622,627,631,636,642,646,650,654,659,663,667,672,677,681,685,690,695,699,704,708,712,716,720,724,729,734,738,742,747,752,757,762,767,772],{"__ignoreMap":47},[51,596,597],{"class":53,"line":54},[51,598,436],{"class":132},[51,600,601],{"class":53,"line":136},[51,602,441],{"class":132},[51,604,605],{"class":53,"line":142},[51,606,446],{"class":132},[51,608,609],{"class":53,"line":148},[51,610,611],{"class":132},"; RPM: apache user chosen to provide access to the same directories as httpd\n",[51,613,614],{"class":53,"line":155},[51,615,616],{"class":151},"-user = apache\n",[51,618,619],{"class":53,"line":161},[51,620,621],{"class":61},"+user = caddy\n",[51,623,624],{"class":53,"line":167},[51,625,626],{"class":132},"; RPM: Keep a group allowed to write in log dir.\n",[51,628,629],{"class":53,"line":173},[51,630,616],{"class":151},[51,632,633],{"class":53,"line":179},[51,634,635],{"class":61},"+group = caddy\n",[51,637,638],{"class":53,"line":185},[51,639,641],{"emptyLinePlaceholder":640},true,"\n",[51,643,644],{"class":53,"line":191},[51,645,471],{"class":132},[51,647,648],{"class":53,"line":197},[51,649,476],{"class":132},[51,651,652],{"class":53,"line":203},[51,653,481],{"class":132},[51,655,656],{"class":53,"line":209},[51,657,658],{"class":132},";             a specific port;\n",[51,660,661],{"class":53,"line":215},[51,662,431],{"class":132},[51,664,665],{"class":53,"line":221},[51,666,431],{"class":132},[51,668,669],{"class":53,"line":227},[51,670,671],{"class":132},"; Set permissions for unix socket, if one is used. In Linux, read/write\n",[51,673,674],{"class":53,"line":233},[51,675,676],{"class":132},"; permissions must be set in order to allow connections from a web server.\n",[51,678,679],{"class":53,"line":239},[51,680,519],{"class":132},[51,682,683],{"class":53,"line":245},[51,684,524],{"class":132},[51,686,687],{"class":53,"line":251},[51,688,689],{"class":151},"-;listen.owner = nobody\n",[51,691,692],{"class":53,"line":257},[51,693,694],{"class":61},"+listen.owner = caddy\n",[51,696,697],{"class":53,"line":263},[51,698,689],{"class":151},[51,700,701],{"class":53,"line":269},[51,702,703],{"class":61},"+listen.group = caddy\n",[51,705,706],{"class":53,"line":275},[51,707,549],{"class":132},[51,709,710],{"class":53,"line":281},[51,711,641],{"emptyLinePlaceholder":640},[51,713,714],{"class":53,"line":287},[51,715,554],{"class":132},[51,717,718],{"class":53,"line":293},[51,719,559],{"class":132},[51,721,722],{"class":53,"line":299},[51,723,564],{"class":132},[51,725,726],{"class":53,"line":305},[51,727,728],{"class":151},"-listen.acl_users = apache,nginx\n",[51,730,731],{"class":53,"line":311},[51,732,733],{"class":61},"+;listen.acl_users = apache,nginx\n",[51,735,736],{"class":53,"line":317},[51,737,574],{"class":132},[51,739,740],{"class":53,"line":323},[51,741,641],{"emptyLinePlaceholder":640},[51,743,744],{"class":53,"line":329},[51,745,746],{"class":132},"; List of addresses (IPv4/IPv6) of FastCGI clients which are allowed to connect.\n",[51,748,749],{"class":53,"line":335},[51,750,751],{"class":132},"; Equivalent to the FCGI_WEB_SERVER_ADDRS environment variable in the original\n",[51,753,754],{"class":53,"line":341},[51,755,756],{"class":132},"; PHP FCGI (5.2.2+). Makes sense only with a tcp listening socket. Each address\n",[51,758,759],{"class":53,"line":347},[51,760,761],{"class":132},"; must be separated by a comma. If this value is left blank, connections will be\n",[51,763,764],{"class":53,"line":353},[51,765,766],{"class":132},"; accepted from any ip address.\n",[51,768,769],{"class":53,"line":359},[51,770,771],{"class":132},"; Default Value: any\n",[51,773,774],{"class":53,"line":365},[51,775,776],{"class":132},"listen.allowed_clients = 127.0.0.1\n",[28,778,780],{"id":779},"拉取-picuploader-最新代码","拉取 PicUploader 最新代码",[13,782,783],{},"首先创建一个用于存放代码的目录",[42,785,787],{"className":44,"code":786,"language":46,"meta":47,"style":47},"sudo mkdir -p /var/www/\n",[33,788,789],{"__ignoreMap":47},[51,790,791,793,796,799],{"class":53,"line":54},[51,792,58],{"class":57},[51,794,795],{"class":61}," mkdir",[51,797,798],{"class":65}," -p",[51,800,801],{"class":61}," /var/www/\n",[13,803,804],{},"clone 最新源码",[42,806,808],{"className":44,"code":807,"language":46,"meta":47,"style":47},"sudo git clone https://github.com/xiebruce/PicUploader.git /var/www/picuploader\n",[33,809,810],{"__ignoreMap":47},[51,811,812,814,817,820,823],{"class":53,"line":54},[51,813,58],{"class":57},[51,815,816],{"class":61}," git",[51,818,819],{"class":61}," clone",[51,821,822],{"class":61}," https://github.com/xiebruce/PicUploader.git",[51,824,825],{"class":61}," /var/www/picuploader\n",[13,827,828],{},"将代码所有权转交给caddy用户",[42,830,832],{"className":44,"code":831,"language":46,"meta":47,"style":47},"sudo chown -R caddy:caddy /var/www/picuploader\n",[33,833,834],{"__ignoreMap":47},[51,835,836,838,841,844,847],{"class":53,"line":54},[51,837,58],{"class":57},[51,839,840],{"class":61}," chown",[51,842,843],{"class":65}," -R",[51,845,846],{"class":61}," caddy:caddy",[51,848,825],{"class":61},[28,850,852],{"id":851},"编辑caddyfile","编辑Caddyfile",[13,854,855,856,859],{},"caddy默认使用",[33,857,858],{},"/etc/caddy/Caddyfile","，因此如果你就部署这一个站点，直接修改这个就好了。",[13,861,862],{},"caddy的语法非常简洁易懂，因此我随手写了几行就能跑起来了。",[13,864,865,866,869],{},"下面是我用的Caddyfile，如果你在服务器上部署，请把",[33,867,868],{},"http://api.picuploader.com","更换为你服务器所需要绑定的域名(不带http协议头)，caddy将自动为你申请ssl证书。",[42,871,876],{"className":872,"code":874,"language":875},[873],"language-text","http://api.picuploader.com {\n        root * /var/www/picuploader\n\n        php_fastcgi * unix//run/php-fpm/php-fpm.sock {\n                index dashboard.php\n        }\n\n        file_server {\n                index index.php\n        }\n\n        handle_errors {\n        root * /etc/caddy/error\n                rewrite * /error.html\n                templates\n                file_server\n        }\n}\n\n# Import additional caddy config files in /etc/caddy/conf.d/\nimport /etc/caddy/conf.d/*\n","text",[33,877,874],{"__ignoreMap":47},[13,879,880,881,884,885,887,888,891],{},"php我选择了监听本地",[33,882,883],{},"unix//run/php-fpm/php-fpm.sock","的方案，这个路径在上文的",[33,886,420],{},"可以设置，如需查询，直接使用 ",[33,889,890],{},"grep listen\\ = /etc/php/php-fpm.d/www.conf","应该就能看见。",[89,893,895],{"id":894},"设置访问密码可选","设置访问密码（可选）",[13,897,898,899,902],{},"caddy2开始不允许在caddyfile中直接指定明文密码，因此我们需要用",[33,900,901],{},"hash-password","获取加密后的密码密文",[42,904,906],{"className":44,"code":905,"language":46,"meta":47,"style":47},"caddy hash-password  --plaintext \u003CYourPassword>\n",[33,907,908],{"__ignoreMap":47},[51,909,910,912,915,918,921,924],{"class":53,"line":54},[51,911,35],{"class":57},[51,913,914],{"class":61}," hash-password",[51,916,917],{"class":65},"  --plaintext",[51,919,920],{"class":132}," \u003C",[51,922,923],{"class":61},"YourPasswor",[51,925,926],{"class":132},"d>\n",[13,928,929],{},"再在Caddyfile中，加上",[42,931,934],{"className":932,"code":933,"language":875},[873],"basicauth /* {\n        \u003Cusername> \u003Chashed_password>\n}\n",[33,935,933],{"__ignoreMap":47},[28,937,939],{"id":938},"修改hosts设置dns解析","修改hosts/设置DNS解析",[13,941,942],{},"由于 api.picuploader.com 这个域名不在我手里，而我只是想在本地使用，并不打算部署到服务器，因此修改hosts将这个域名解析到本地是个不错的选择。",[42,944,946],{"className":44,"code":945,"language":46,"meta":47,"style":47},"sudo sh -c \"echo '127.0.0.1     api.picuploader.com'  /etc/hosts\"\n",[33,947,948],{"__ignoreMap":47},[51,949,950,952,955,958],{"class":53,"line":54},[51,951,58],{"class":57},[51,953,954],{"class":61}," sh",[51,956,957],{"class":65}," -c",[51,959,960],{"class":61}," \"echo '127.0.0.1     api.picuploader.com'  /etc/hosts\"\n",[13,962,963],{},"而你若是在服务器上部署，应当去设置DNS解析，这个应该不需要我多说。",[28,965,966],{"id":966},"开启服务",[13,968,969,970,36,972,974],{},"在Archlinux下，我习惯直接用systemd运行",[33,971,35],{},[33,973,39],{},"以开机自启动。",[42,976,978],{"className":44,"code":977,"language":46,"meta":47,"style":47},"sudo systemctl enable --now caddy php-fpm\n",[33,979,980],{"__ignoreMap":47},[51,981,982,984,987,990,993,995],{"class":53,"line":54},[51,983,58],{"class":57},[51,985,986],{"class":61}," systemctl",[51,988,989],{"class":61}," enable",[51,991,992],{"class":65}," --now",[51,994,69],{"class":61},[51,996,997],{"class":61}," php-fpm\n",[28,999,1000],{"id":1000},"最终测试",[13,1002,1003,1004,1008],{},"在浏览器内访问 ",[20,1005,1007],{"href":868,"rel":1006},[24],"api.picuploader.com"," ，如果能看到页面，就算是成功啦。",[28,1010,1011],{"id":1011},"设置上传参数",[13,1013,1014,1015],{},"见作者博客：",[20,1016,1019],{"href":1017,"rel":1018},"https://www.xiebruce.top/117.html",[24],"PicUploader: 各图床获取上传图片参数的方法",[1021,1022,1023],"style",{},"html pre.shiki code .sAdtL, html code.shiki .sAdtL{--shiki-default:#4078F2;--shiki-dark:#61AFEF}html pre.shiki code .sDhpE, html code.shiki .sDhpE{--shiki-default:#50A14F;--shiki-dark:#98C379}html pre.shiki code .sAGMh, html code.shiki .sAGMh{--shiki-default:#986801;--shiki-dark:#D19A66}html .default .shiki span {color: var(--shiki-default);background: var(--shiki-default-bg);font-style: var(--shiki-default-font-style);font-weight: var(--shiki-default-font-weight);text-decoration: var(--shiki-default-text-decoration);}html .shiki span {color: var(--shiki-default);background: var(--shiki-default-bg);font-style: var(--shiki-default-font-style);font-weight: var(--shiki-default-font-weight);text-decoration: var(--shiki-default-text-decoration);}html .dark .shiki span {color: var(--shiki-dark);background: var(--shiki-dark-bg);font-style: var(--shiki-dark-font-style);font-weight: var(--shiki-dark-font-weight);text-decoration: var(--shiki-dark-text-decoration);}html.dark .shiki span {color: var(--shiki-dark);background: var(--shiki-dark-bg);font-style: var(--shiki-dark-font-style);font-weight: var(--shiki-dark-font-weight);text-decoration: var(--shiki-dark-text-decoration);}html pre.shiki code .s5ixo, html code.shiki .s5ixo{--shiki-default:#383A42;--shiki-dark:#ABB2BF}html pre.shiki code .sJa8x, html code.shiki .sJa8x{--shiki-default:#E45649;--shiki-dark:#E06C75}",{"title":47,"searchDepth":136,"depth":136,"links":1025},[1026,1027,1035,1036,1039,1040,1041,1042],{"id":30,"depth":136,"text":30},{"id":84,"depth":136,"text":84,"children":1028},[1029,1031,1033],{"id":91,"depth":142,"text":1030},"在/etc/php/php.ini启用PicUploader所需拓展",{"id":389,"depth":142,"text":1032},"编辑/etc/php/php.ini以增加单文件上传大小限制",{"id":417,"depth":142,"text":1034},"编辑/etc/php/php-fpm.d/www.conf使其在运行时使用caddy用户。",{"id":779,"depth":136,"text":780},{"id":851,"depth":136,"text":852,"children":1037},[1038],{"id":894,"depth":142,"text":895},{"id":938,"depth":136,"text":939},{"id":966,"depth":136,"text":966},{"id":1000,"depth":136,"text":1000},{"id":1011,"depth":136,"text":1011},"2021-10-21 22:15:33","md","zh-CN",{},"/2021/10/21/picuploader-on-archlinux-with-caddy","---\ntitle: PicUploader使用系列（一）——在Archlinux上使用Caddy部署PicUploader\ndate: 2021-10-21 22:15:33\nsticky:\ntags:\n- Archlinux\n- Caddy\n- PicUploader\n- PHP\n---\n\n> 之前找对大陆网络友好的图床时，找到了cloudinary，但是全英文界面对操作增加了不少难度，其页面也不是很简洁，让我一下打消了使用网页版的念头。通过搜索，找到了 PicUploader 这一方案，使用php编写，支持cloudinary的api。\n>\n> 作者在其[博客](https://www.xiebruce.top/17.html)中仅提供了nginx的部署方案，我参考其配置文件成功实现了在caddy下的部署，并且花费了数个小时排坑，故写下本文帮助后来者节省时间。\n\n## 安装`caddy`和`php-fpm`以及所需的拓展\n\n```bash\nsudo pacman -S caddy php-fpm php-gd php-sqlite --needed\n```\n\n## 配置`php-fpm`\n\n### 在`/etc/php/php.ini`启用PicUploader所需拓展\n\nPicUploaer依赖于`fileinfo`、`gd`、`curl`、`exif`、`pdo_sqlite`拓展，可以使用`php -m`命令来查看目前加载成功了的插件。\n\n```diff\n;extension=bcmath\n;extension=bz2\n;extension=calendar\n- extension=curl\n+ extension=curl\n;extension=dba\n;extension=enchant\n- extension=exif\n+ extension=exif\n;extension=ffi\n;extension=ftp\n- extension=gd\n+ extension=gd\n;extension=gettext\n;extension=gmp\n;extension=iconv\n;extension=imap\n;extension=intl\n;extension=ldap\n;extension=mysqli\n;extension=odbc\n;zend_extension=opcache\n;extension=pdo_dblib\n;extension=pdo_mysql\n;extension=pdo_odbc\n;extension=pdo_pgsql\n- extension=pdo_sqlite\n+ extension=pdo_sqlite\n;extension=pgsql\n;extension=pspell\n;extension=shmop\n;extension=snmp\n;extension=soap\n;extension=sockets\n;extension=sodium\n;extension=sqlite3\n;extension=sysvmsg\n;extension=sysvsem\n;extension=sysvshm\n;extension=tidy\n;extension=xmlrpc\n;extension=xsl\nextension=zip\n```\n\n### 编辑`/etc/php/php.ini`以增加单文件上传大小限制\n\n~~查出这个问题浪费了我整整4小时时间。~~\n\n```diff\n- upload_max_filesize = 2M\n+ upload_max_filesize = 100M\n```\n\n### 编辑`/etc/php/php-fpm.d/www.conf`使其在运行时使用caddy用户。\n\n```diff\n---\n; Unix user/group of processes\n; Note: The user is mandatory. If the group is not set, the default user's group\n;       will be used.\n- user = http\n+ user = caddy\n- group = http\n+ group = caddy\n; The address on which to accept FastCGI requests.\n; Valid syntaxes are:\n;   'ip.add.re.ss:port'    - to listen on a TCP socket to a specific IPv4 address on\n;                            a specific port;\n;   '[ip:6:addr:ess]:port' - to listen on a TCP socket to a specific IPv6 address on\n---\n---\n; Note: This value is mandatory.\nlisten = /run/php-fpm/php-fpm.sock\n; and group can be specified either by name or by their numeric IDs.\n; Default Values: user and group are set as the running user\n;                 mode is set to 0660\n- listen.owner = http\n+ listen.owner = caddy\n- listen.group = http\n+ listen.group = caddy\n;listen.mode = 0660\n; When POSIX Access Control Lists are supported you can set them using\n; these options, value is a comma separated list of user/group names.\n; When set, listen.owner and listen.group are ignored\n;listen.acl_users =\n;listen.acl_groups =\n---\n```\n\n**2022年1月14日更新**：在 Fedora 尝试部署的时候遇到了新的坑，Fedora 的相应配置文件为 `/etc/php-fpm.d/www.conf`，相应修改如下\n\n```diff\n; Unix user/group of processes\n; Note: The user is mandatory. If the group is not set, the default user's group\n;       will be used.\n; RPM: apache user chosen to provide access to the same directories as httpd\n-user = apache\n+user = caddy\n; RPM: Keep a group allowed to write in log dir.\n-user = apache\n+group = caddy\n\n; The address on which to accept FastCGI requests.\n; Valid syntaxes are:\n;   'ip.add.re.ss:port'    - to listen on a TCP socket to a specific IPv4 address on\n;             a specific port;\n---\n---\n; Set permissions for unix socket, if one is used. In Linux, read/write\n; permissions must be set in order to allow connections from a web server.\n; Default Values: user and group are set as the running user\n;                 mode is set to 0660\n-;listen.owner = nobody\n+listen.owner = caddy\n-;listen.owner = nobody\n+listen.group = caddy\n;listen.mode = 0660\n\n; When POSIX Access Control Lists are supported you can set them using\n; these options, value is a comma separated list of user/group names.\n; When set, listen.owner and listen.group are ignored\n-listen.acl_users = apache,nginx\n+;listen.acl_users = apache,nginx\n;listen.acl_groups =\n\n; List of addresses (IPv4/IPv6) of FastCGI clients which are allowed to connect.\n; Equivalent to the FCGI_WEB_SERVER_ADDRS environment variable in the original\n; PHP FCGI (5.2.2+). Makes sense only with a tcp listening socket. Each address\n; must be separated by a comma. If this value is left blank, connections will be\n; accepted from any ip address.\n; Default Value: any\nlisten.allowed_clients = 127.0.0.1\n```\n\n## 拉取 PicUploader 最新代码\n\n首先创建一个用于存放代码的目录\n\n```bash\nsudo mkdir -p /var/www/\n```\n\nclone 最新源码\n\n```bash\nsudo git clone https://github.com/xiebruce/PicUploader.git /var/www/picuploader\n```\n\n将代码所有权转交给caddy用户\n\n```bash\nsudo chown -R caddy:caddy /var/www/picuploader\n```\n\n## 编辑Caddyfile\n\ncaddy默认使用`/etc/caddy/Caddyfile`，因此如果你就部署这一个站点，直接修改这个就好了。\n\ncaddy的语法非常简洁易懂，因此我随手写了几行就能跑起来了。\n\n下面是我用的Caddyfile，如果你在服务器上部署，请把`http://api.picuploader.com`更换为你服务器所需要绑定的域名(不带http协议头)，caddy将自动为你申请ssl证书。\n\n```\nhttp://api.picuploader.com {\n        root * /var/www/picuploader\n\n        php_fastcgi * unix//run/php-fpm/php-fpm.sock {\n                index dashboard.php\n        }\n\n        file_server {\n                index index.php\n        }\n\n        handle_errors {\n        root * /etc/caddy/error\n                rewrite * /error.html\n                templates\n                file_server\n        }\n}\n\n# Import additional caddy config files in /etc/caddy/conf.d/\nimport /etc/caddy/conf.d/*\n```\n\nphp我选择了监听本地`unix//run/php-fpm/php-fpm.sock`的方案，这个路径在上文的`/etc/php/php-fpm.d/www.conf`可以设置，如需查询，直接使用 `grep listen\\ = /etc/php/php-fpm.d/www.conf`应该就能看见。\n\n### 设置访问密码（可选）\n\ncaddy2开始不允许在caddyfile中直接指定明文密码，因此我们需要用`hash-password`获取加密后的密码密文\n\n```bash\ncaddy hash-password  --plaintext \u003CYourPassword>\n```\n\n再在Caddyfile中，加上\n\n```\nbasicauth /* {\n\t\t\u003Cusername> \u003Chashed_password>\n}\n```\n\n## 修改hosts/设置DNS解析\n\n由于 api.picuploader.com 这个域名不在我手里，而我只是想在本地使用，并不打算部署到服务器，因此修改hosts将这个域名解析到本地是个不错的选择。\n\n```bash\nsudo sh -c \"echo '127.0.0.1\t\tapi.picuploader.com'  /etc/hosts\"\n```\n\n而你若是在服务器上部署，应当去设置DNS解析，这个应该不需要我多说。\n\n## 开启服务\n\n在Archlinux下，我习惯直接用systemd运行`caddy`和`php-fpm`以开机自启动。\n\n```bash\nsudo systemctl enable --now caddy php-fpm\n```\n\n## 最终测试\n\n在浏览器内访问 [api.picuploader.com](http://api.picuploader.com) ，如果能看到页面，就算是成功啦。\n\n## 设置上传参数\n\n见作者博客：[PicUploader: 各图床获取上传图片参数的方法](https://www.xiebruce.top/117.html)\n\n",{"title":5,"description":47},"posts/zh/picuploader-on-archlinux-with-caddy",false,[1053,1054,1055,1056],"Archlinux","Caddy","PicUploader","PHP","Gd43BUdMKfmyiGCd7XjEtGDXbTI_rG3QZNoTZKPhpGE",[1059,1064],{"title":1060,"path":1061,"stem":1062,"date":1063,"lang":1045,"children":-1},"PicUploader使用系列（二）——为KDE的dolphin添加右键快捷菜单","/2021/10/24/picuploader-with-kde-action","posts/zh/picuploader-with-kde-action","2021-10-24 22:26:50",{"title":1065,"path":1066,"stem":1067,"date":1068,"lang":1045,"children":-1},"Archlinux坚果云踩坑实录","/2021/10/02/nutstore-guide-on-archlinux-kde","posts/zh/nutstore-guide-on-archlinux-kde","2021-10-02 00:21:34",null,1763660158703]