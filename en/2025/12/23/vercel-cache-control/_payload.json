[{"data":1,"prerenderedAt":546},["ShallowReactive",2],{"post-2025-12-23-vercel-cache-control-en":3,"surround-2025-12-23-vercel-cache-control-en":537,"randomIndex/2025/12/23/vercel-cache-control/":213,"language-switch-/en/2025/12/23/vercel-cache-control/-zh":545},{"title":4,"date":5,"path":6,"tags":7,"body":11,"description":17},"Have You Noticed Vercel's Cache Control?","2025-12-23","/2025/12/23/vercel-cache-control",[8,9,10],"Vercel","Network","HTTP",{"type":12,"value":13,"toc":526},"minimark",[14,18,23,30,36,40,45,56,72,83,89,92,96,105,108,114,119,122,125,129,132,143,146,166,172,175,178,235,239,242,249,252,260,266,445,456,459,485,488,492,495,499,522],[15,16,17],"p",{},"Vercel's default cache configuration is actually not very reasonable, but few people notice it.",[19,20,22],"h2",{"id":21},"first-lets-look-at-the-results","First, Let's Look at the Results",[15,24,25],{},[26,27],"img",{"alt":28,"src":29},"Figure 1","https://static.031130.xyz/uploads/2025/12/23/577e579eceb96.webp",[15,31,32],{},[26,33],{"alt":34,"src":35},"Figure 2","https://static.031130.xyz/uploads/2025/12/23/0cfc9543c857a.webp",[19,37,39],{"id":38},"analysis","Analysis",[41,42,44],"h3",{"id":43},"testing-approach","Testing Approach",[15,46,47,48,55],{},"Both images show test results from my blog on ",[49,50,54],"a",{"href":51,"rel":52},"https://pagespeed.web.dev/",[53],"nofollow","PageSpeed Insights",". The testing steps were:",[57,58,59,63,66,69],"ol",{},[60,61,62],"li",{},"Deploy",[60,64,65],{},"Run the first test on PageSpeed Insights",[60,67,68],{},"Wait 120 seconds to prevent PageSpeed Insights from using cached results",[60,70,71],{},"Run the second test and use those results",[15,73,74,78,79,82],{},[75,76,77],"strong",{},"The purpose of using the second test results"," is to ensure that the Vercel CDN node accessed by PageSpeed Insights has completed fetching from origin and ",[75,80,81],{},"cached the content on the CDN node",". This way, the second access retrieves results directly from the CDN cache without needing to fetch from origin.",[15,84,85,86],{},"Looking at the test results in Figure 1, does it seem normal? The loading time for a single HTML page reached ",[75,87,88],{},"450ms. While this doesn't look terribly slow, there's actually a problem when you examine it closely.",[15,90,91],{},"Vercel uses Amazon's global CDN network. After our first visit, the CDN node should have already cached the homepage content, so the second visit should retrieve content directly from the CDN node's cache.",[41,93,95],{"id":94},"what-would-be-a-reasonable-duration","What Would Be a Reasonable Duration?",[97,98,99,102],"ul",{},[60,100,101],{},"TCP connection establishment requires 1.5 round-trip times (RTT) for the three-way handshake, plus 1 RTT for TLS 1.3 handshake, totaling 2.5 RTT.",[60,103,104],{},"The HTML file size is 18KB. The initial congestion window (IW) of 10 MSS ≈ 1460 bytes ≈ 14.6KB means it should theoretically be transmitted within two RTTs.",[15,106,107],{},"Total: 4.5 RTT.",[15,109,110,111],{},"PageSpeed Insights likely uses a node in the United States for testing. Amazon CDN has extensive coverage in the US, so keeping a single RTT under 5ms is more than adequate. Therefore, the theoretical loading time should be around 22.5ms. Adding DNS resolution time (which shouldn't be much since there was an access two minutes prior, so this isn't a cold start) and some uncontrollable network jitter, ",[75,112,113],{},"it should be completely fine to stay within 50ms.",[15,115,116],{},[75,117,118],{},"But the actual measured time was 450ms, nearly 9 times higher—this is very unreasonable.",[15,120,121],{},"Now let's look at Figure 2's results. The single HTML loading time dropped to 41ms, which completely meets expectations.",[15,123,124],{},"Why is there such a huge difference? The reason lies in Vercel's cache control settings.",[19,126,128],{"id":127},"vercels-cache-control","Vercel's Cache Control",[15,130,131],{},"For websites deployed on Vercel, by default, Vercel sets the following cache control header for HTML files:",[133,134,139],"pre",{"className":135,"code":137,"language":138},[136],"language-text","cache-control: public, max-age=0, must-revalidate\n","text",[140,141,137],"code",{"__ignoreMap":142},"",[15,144,145],{},"This setting means:",[97,147,148,154,160],{},[60,149,150,153],{},[140,151,152],{},"public",": The response can be cached by any cache, including browsers and CDNs.",[60,155,156,159],{},[140,157,158],{},"max-age=0",": The maximum cache time for the response is 0 seconds, meaning the response expires immediately after being cached.",[60,161,162,165],{},[140,163,164],{},"must-revalidate",": Once the response expires, the cache must validate its validity with the origin server.",[15,167,168,169,171],{},"Combined, these three directives mean Vercel is essentially telling CDN nodes: you can cache this HTML file, but you must validate its validity with the origin server before using the cache each time. Since ",[140,170,158],{},", the cache expires immediately upon storage, so every request triggers origin validation.",[15,173,174],{},"Although cache validation in HTTP/1.1 and HTTP/2 typically uses conditional requests (such as the file's ETag or Last-Modified headers) to save transmission bandwidth, this still requires round-trip communication with the origin server, adding extra latency overhead.",[15,176,177],{},"Therefore, under Vercel's default configuration, responses to any request won't be directly cached by CDN nodes. The general flow is as follows:",[133,179,183],{"className":180,"code":181,"language":182,"meta":142,"style":142},"language-mermaid shiki shiki-themes one-light one-dark-pro","sequenceDiagram\n    participant Client\n    participant CDN\n    participant Vercel\n    Client->>CDN: Request HTML file\n    CDN->>Vercel: Conditional request to validate cache\n    Vercel->>CDN: Return latest HTML file or 304 Not Modified\n    CDN->>Client: Return HTML file\n","mermaid",[140,184,185,193,199,205,211,217,223,229],{"__ignoreMap":142},[186,187,190],"span",{"class":188,"line":189},"line",1,[186,191,192],{},"sequenceDiagram\n",[186,194,196],{"class":188,"line":195},2,[186,197,198],{},"    participant Client\n",[186,200,202],{"class":188,"line":201},3,[186,203,204],{},"    participant CDN\n",[186,206,208],{"class":188,"line":207},4,[186,209,210],{},"    participant Vercel\n",[186,212,214],{"class":188,"line":213},5,[186,215,216],{},"    Client->>CDN: Request HTML file\n",[186,218,220],{"class":188,"line":219},6,[186,221,222],{},"    CDN->>Vercel: Conditional request to validate cache\n",[186,224,226],{"class":188,"line":225},7,[186,227,228],{},"    Vercel->>CDN: Return latest HTML file or 304 Not Modified\n",[186,230,232],{"class":188,"line":231},8,[186,233,234],{},"    CDN->>Client: Return HTML file\n",[19,236,238],{"id":237},"solution","Solution",[15,240,241],{},"To solve this problem, we need to adjust Vercel's cache control settings so that HTML files can be cached by CDN nodes for a period of time without needing origin validation every time.",[15,243,244,245,248],{},"Vercel allows us to create a ",[140,246,247],{},"vercel.json"," file in the project's root directory to configure various aspects of Vercel's deployment behavior, including HTTP response header configuration.",[15,250,251],{},"My blog is built with the Nuxt.js framework, and the generated build artifacts roughly fall into two categories:",[57,253,254,257],{},[60,255,256],{},"HTML files: These files' content may change frequently and shouldn't have excessively long cache times;",[60,258,259],{},"Static resource files: Including JavaScript, CSS, etc. These files typically have hash values in their filenames and can have longer cache times or even be marked as immutable.",[15,261,262,263,265],{},"In terms of deployment workflow, my blog is first built into static pages in GitHub Actions after each push, then deployed to Vercel. So I created a ",[140,264,247],{}," file in my project's public directory (this way the vercel.json file will be in the root of the build artifacts) with the following content:",[133,267,271],{"className":268,"code":269,"language":270,"meta":142,"style":142},"language-json shiki shiki-themes one-light one-dark-pro","{\n  \"headers\": [\n    {\n      \"source\": \"/(.*)\",\n      \"headers\": [\n        {\n          \"key\": \"Cache-Control\",\n          \"value\": \"public, max-age=0, s-maxage=600, must-revalidate\"\n        }\n      ]\n    },\n    {\n      \"source\": \"/(.*)\\\\.(css|js)\",\n      \"headers\": [\n        {\n          \"key\": \"Cache-Control\",\n          \"value\": \"public, max-age=31536000, immutable\"\n        }\n      ]\n    }\n  ]\n}\n","json",[140,272,273,279,288,293,308,315,320,332,342,348,354,360,365,384,391,396,407,417,422,427,433,439],{"__ignoreMap":142},[186,274,275],{"class":188,"line":189},[186,276,278],{"class":277},"s5ixo","{\n",[186,280,281,285],{"class":188,"line":195},[186,282,284],{"class":283},"sJa8x","  \"headers\"",[186,286,287],{"class":277},": [\n",[186,289,290],{"class":188,"line":201},[186,291,292],{"class":277},"    {\n",[186,294,295,298,301,305],{"class":188,"line":207},[186,296,297],{"class":283},"      \"source\"",[186,299,300],{"class":277},": ",[186,302,304],{"class":303},"sDhpE","\"/(.*)\"",[186,306,307],{"class":277},",\n",[186,309,310,313],{"class":188,"line":213},[186,311,312],{"class":283},"      \"headers\"",[186,314,287],{"class":277},[186,316,317],{"class":188,"line":219},[186,318,319],{"class":277},"        {\n",[186,321,322,325,327,330],{"class":188,"line":225},[186,323,324],{"class":283},"          \"key\"",[186,326,300],{"class":277},[186,328,329],{"class":303},"\"Cache-Control\"",[186,331,307],{"class":277},[186,333,334,337,339],{"class":188,"line":231},[186,335,336],{"class":283},"          \"value\"",[186,338,300],{"class":277},[186,340,341],{"class":303},"\"public, max-age=0, s-maxage=600, must-revalidate\"\n",[186,343,345],{"class":188,"line":344},9,[186,346,347],{"class":277},"        }\n",[186,349,351],{"class":188,"line":350},10,[186,352,353],{"class":277},"      ]\n",[186,355,357],{"class":188,"line":356},11,[186,358,359],{"class":277},"    },\n",[186,361,363],{"class":188,"line":362},12,[186,364,292],{"class":277},[186,366,368,370,372,375,379,382],{"class":188,"line":367},13,[186,369,297],{"class":283},[186,371,300],{"class":277},[186,373,374],{"class":303},"\"/(.*)",[186,376,378],{"class":377},"s_Sar","\\\\",[186,380,381],{"class":303},".(css|js)\"",[186,383,307],{"class":277},[186,385,387,389],{"class":188,"line":386},14,[186,388,312],{"class":283},[186,390,287],{"class":277},[186,392,394],{"class":188,"line":393},15,[186,395,319],{"class":277},[186,397,399,401,403,405],{"class":188,"line":398},16,[186,400,324],{"class":283},[186,402,300],{"class":277},[186,404,329],{"class":303},[186,406,307],{"class":277},[186,408,410,412,414],{"class":188,"line":409},17,[186,411,336],{"class":283},[186,413,300],{"class":277},[186,415,416],{"class":303},"\"public, max-age=31536000, immutable\"\n",[186,418,420],{"class":188,"line":419},18,[186,421,347],{"class":277},[186,423,425],{"class":188,"line":424},19,[186,426,353],{"class":277},[186,428,430],{"class":188,"line":429},20,[186,431,432],{"class":277},"    }\n",[186,434,436],{"class":188,"line":435},21,[186,437,438],{"class":277},"  ]\n",[186,440,442],{"class":188,"line":441},22,[186,443,444],{"class":277},"}\n",[15,446,447,448,451,452,455],{},"Here I set ",[140,449,450],{},"max-age=31536000, immutable"," for all CSS and JS files, so these static resource files can be cached long-term by browsers and CDNs. For all other files (mainly HTML files), I set ",[140,453,454],{},"max-age=0, s-maxage=600, must-revalidate",", so HTML files can be cached by the CDN for 10 minutes. Requests within these 10 minutes can retrieve content directly from the CDN node's cache without needing origin validation.",[15,457,458],{},"With this modified cache control setting, the request flow for HTML files becomes:",[133,460,462],{"className":180,"code":461,"language":182,"meta":142,"style":142},"sequenceDiagram\n    participant Client\n    participant CDN\n    Client->>CDN: Request HTML file\n    CDN->>Client: Directly return cached HTML file\n",[140,463,464,468,472,476,480],{"__ignoreMap":142},[186,465,466],{"class":188,"line":189},[186,467,192],{},[186,469,470],{"class":188,"line":195},[186,471,198],{},[186,473,474],{"class":188,"line":201},[186,475,204],{},[186,477,478],{"class":188,"line":207},[186,479,216],{},[186,481,482],{"class":188,"line":213},[186,483,484],{},"    CDN->>Client: Directly return cached HTML file\n",[15,486,487],{},"This greatly reduces request latency and improves page loading speed.",[19,489,491],{"id":490},"other-considerations","Other Considerations",[15,493,494],{},"Vercel's architecture isn't the traditional \"origin server - CDN\" architecture, but rather closer to a \"global multi-region storage + CDN edge cache\" architecture. So even for origin requests, Vercel will try to retrieve content from the storage node closest to the user to reduce latency. However, this doesn't mean origin request latency can be ignored, especially when pursuing optimal loading speed—proper cache control remains very important.",[19,496,498],{"id":497},"references","References",[97,500,501,508,515],{},[60,502,503],{},[49,504,507],{"href":505,"rel":506},"https://vercel.com/docs/headers/cache-control-headers",[53],"Cache-Control headers | Vercel",[60,509,510],{},[49,511,514],{"href":512,"rel":513},"https://vercel.com/docs/cdn-cache",[53],"Vercel CDN Cache | Vercel",[60,516,517],{},[49,518,521],{"href":519,"rel":520},"https://developer.mozilla.org/en-US/docs/Web/HTTP/Guides/Caching",[53],"HTTP caching - HTTP | MDN",[523,524,525],"style",{},"html .default .shiki span {color: var(--shiki-default);background: var(--shiki-default-bg);font-style: var(--shiki-default-font-style);font-weight: var(--shiki-default-font-weight);text-decoration: var(--shiki-default-text-decoration);}html .shiki span {color: var(--shiki-default);background: var(--shiki-default-bg);font-style: var(--shiki-default-font-style);font-weight: var(--shiki-default-font-weight);text-decoration: var(--shiki-default-text-decoration);}html .dark .shiki span {color: var(--shiki-dark);background: var(--shiki-dark-bg);font-style: var(--shiki-dark-font-style);font-weight: var(--shiki-dark-font-weight);text-decoration: var(--shiki-dark-text-decoration);}html.dark .shiki span {color: var(--shiki-dark);background: var(--shiki-dark-bg);font-style: var(--shiki-dark-font-style);font-weight: var(--shiki-dark-font-weight);text-decoration: var(--shiki-dark-text-decoration);}html pre.shiki code .s5ixo, html code.shiki .s5ixo{--shiki-default:#383A42;--shiki-dark:#ABB2BF}html pre.shiki code .sJa8x, html code.shiki .sJa8x{--shiki-default:#E45649;--shiki-dark:#E06C75}html pre.shiki code .sDhpE, html code.shiki .sDhpE{--shiki-default:#50A14F;--shiki-dark:#98C379}html pre.shiki code .s_Sar, html code.shiki .s_Sar{--shiki-default:#0184BC;--shiki-dark:#56B6C2}",{"title":142,"searchDepth":195,"depth":195,"links":527},[528,529,533,534,535,536],{"id":21,"depth":195,"text":22},{"id":38,"depth":195,"text":39,"children":530},[531,532],{"id":43,"depth":201,"text":44},{"id":94,"depth":201,"text":95},{"id":127,"depth":195,"text":128},{"id":237,"depth":195,"text":238},{"id":490,"depth":195,"text":491},{"id":497,"depth":195,"text":498},[538,539],null,{"title":540,"path":541,"stem":542,"date":543,"lang":544,"children":-1},"Layer 4 Traffic Proxying with Caddy: A Practical Guide","/2025/12/10/caddy-traffic-proxy-on-layer-4","posts/en/caddy-traffic-proxy-on-layer-4","2025-12-10","en","/2025/12/23/vercel-cache-control/",1766437539707]