[{"data":1,"prerenderedAt":253},["ShallowReactive",2],{"post-2025-12-10-caddy-traffic-proxy-on-layer-4-en":3,"surround-2025-12-10-caddy-traffic-proxy-on-layer-4-en":244,"randomIndex/2025/12/10/caddy-traffic-proxy-on-layer-4/":93,"language-switch-/en/2025/12/10/caddy-traffic-proxy-on-layer-4/-zh":252},{"title":4,"date":5,"path":6,"tags":7,"body":10,"description":86},"Layer 4 Traffic Proxying with Caddy: A Practical Guide","2025-12-10","/2025/12/10/caddy-traffic-proxy-on-layer-4",[8,9],"Caddy","Network",{"type":11,"value":12,"toc":237},"minimark",[13,18,22,32,35,39,55,64,68,77,80,102,105,114,134,138,141,149,158,161,167,170,176,195,202,211,214,233],[14,15,17],"h2",{"id":16},"background","Background",[19,20,21],"p",{},"On one of my VPS servers with optimized routing, port 443 needs to serve two distinct purposes:",[23,24,25,29],"ol",{},[26,27,28],"li",{},"Hosting my blog for visitors from mainland China, handling HTTPS encryption/decryption and serving static content",[26,30,31],{},"Disguising certain special-purpose traffic to mimic HTTPS traffic from well-known, commonly-allowed websites (yes, I'm talking about Reality)",[19,33,34],{},"This meant I needed a solution to handle both roles simultaneously on the same port of the same server.",[14,36,38],{"id":37},"choosing-the-solution","Choosing the Solution",[19,40,41,42,46,47,54],{},"I've long been aware that Nginx's ",[43,44,45],"code",{},"stream"," directive can achieve Layer 4 (raw TCP stream forwarding) traffic splitting based on SNI recognition. However, as a devoted Caddy user who has written numerous ",[48,49,53],"a",{"href":50,"rel":51},"https://zhul.in/tags/Caddy/",[52],"nofollow","Caddy-related posts",", I still prefer Caddy despite Nginx's recent ACME v2 support. The simplicity and usability of Caddyfile keep me coming back.",[19,56,57,58,63],{},"After some research, I discovered that while the latest Caddy version (v2.10) doesn't natively support Layer 4 traffic proxying, there's a community module called ",[48,59,62],{"href":60,"rel":61},"https://github.com/mholt/caddy-l4",[52],"caddy-l4"," that provides exactly this functionality. With 1.5k stars on GitHub and active maintenance, it seemed worth trying.",[14,65,67],{"id":66},"installation","Installation",[19,69,70,71,76],{},"Although the official Caddy APT repository doesn't include the caddy-l4 module, I recommend first installing the base Caddy version through APT, then using Caddy's official ",[48,72,75],{"href":73,"rel":74},"https://caddyserver.com/download",[52],"download page"," to build a custom binary with the modules you need. Download it and replace the system Caddy executable. This approach makes systemd service configuration much easier. Just remember to disable the Caddy APT repository to prevent automatic updates from overwriting your custom build.",[19,78,79],{},"For future updates, you can simply run:",[81,82,87],"pre",{"className":83,"code":84,"language":85,"meta":86,"style":86},"language-bash shiki shiki-themes one-light one-dark-pro","caddy upgrade\n","bash","",[43,88,89],{"__ignoreMap":86},[90,91,94,98],"span",{"class":92,"line":93},"line",1,[90,95,97],{"class":96},"sAdtL","caddy",[90,99,101],{"class":100},"sDhpE"," upgrade\n",[19,103,104],{},"Caddy will automatically detect the modules included in your current binary, trigger an online build from the official website to generate a new binary with those modules, and perform the replacement. You just need to manually restart the systemd service to complete the update.",[19,106,107,108,113],{},"If Caddy's online build service fails (it's been somewhat unstable lately), you can ",[48,109,112],{"href":110,"rel":111},"https://caddyserver.com/docs/build#xcaddy",[52],"follow the documentation"," to compile Caddy locally using xcaddy:",[81,115,117],{"className":83,"code":116,"language":85,"meta":86,"style":86},"xcaddy build --with github.com/mholt/caddy-l4\n",[43,118,119],{"__ignoreMap":86},[90,120,121,124,127,131],{"class":92,"line":93},[90,122,123],{"class":96},"xcaddy",[90,125,126],{"class":100}," build",[90,128,130],{"class":129},"sAGMh"," --with",[90,132,133],{"class":100}," github.com/mholt/caddy-l4\n",[14,135,137],{"id":136},"configuration","Configuration",[19,139,140],{},"Here's my original Caddyfile configuration for the blog:",[81,142,147],{"className":143,"code":145,"language":146},[144],"language-text","zhul.in {\n    root * /var/www/zhul.in\n\n    encode zstd gzip\n    file_server\n\n    handle_errors {\n            rewrite * /404.html\n            file_server\n    }\n}\n\nwww.zhul.in {\n    redir https://zhul.in{uri}\n}\n","text",[43,148,145],{"__ignoreMap":86},[19,150,151,152,157],{},"Since both zhul.in and ",[48,153,156],{"href":154,"rel":155},"http://www.zhul.in",[52],"www.zhul.in"," were using ports 80 and 443, I needed to move the HTTPS listeners to a different port and let caddy-l4 handle port 443.",[19,159,160],{},"Here's the modified Caddyfile:",[81,162,165],{"className":163,"code":164,"language":146},[144],"http://zhul.in:80, https://zhul.in:8443 {\n    root * /var/www/zhul.in\n\n    encode zstd gzip\n    file_server\n\n    handle_errors {\n            rewrite * /404.html\n            file_server\n    }\n}\n\nhttp://www.zhul.in:80, https://www.zhul.in:8443 {\n    redir https://zhul.in{uri}\n}\n",[43,166,164],{"__ignoreMap":86},[19,168,169],{},"Next, I added the caddy-l4 configuration:",[81,171,174],{"className":172,"code":173,"language":146},[144],"{\n    layer4 {\n        :443 {\n            @zhulin tls sni zhul.in www.zhul.in\n            route @zhulin {\n                proxy 127.0.0.1:8443\n            }\n\n            @proxy tls sni osxapps.itunes.apple.com\n            route @proxy {\n                proxy 127.0.0.1:20443\n            }\n        }\n    }\n}\n",[43,175,173],{"__ignoreMap":86},[19,177,178,179,182,183,186,187,190,191,194],{},"The syntax is quite straightforward. First, listen on port 443 within the ",[43,180,181],{},"layer4"," block. Then define SNI-based matching rules using ",[43,184,185],{},"@name tls sni domain",". Finally, use ",[43,188,189],{},"route @name"," to specify how to handle traffic matching each rule—here I'm using ",[43,192,193],{},"proxy ip:port"," to forward the traffic.",[19,196,197,198,201],{},"Since my special traffic masquerades as Apple iTunes traffic, the SNI signature in the configuration is ",[43,199,200],{},"osxapps.itunes.apple.com",". This traffic gets forwarded to local port 20443, where another service handles it.",[19,203,204,205,210],{},"caddy-l4 offers various other matching methods and routing handlers. Check out their ",[48,206,209],{"href":207,"rel":208},"https://github.com/mholt/caddy-l4/tree/master/docs/examples",[52],"examples on GitHub"," for more details.",[19,212,213],{},"Once configured, restart the Caddy service:",[81,215,217],{"className":83,"code":216,"language":85,"meta":86,"style":86},"sudo systemctl restart caddy\n",[43,218,219],{"__ignoreMap":86},[90,220,221,224,227,230],{"class":92,"line":93},[90,222,223],{"class":96},"sudo",[90,225,226],{"class":100}," systemctl",[90,228,229],{"class":100}," restart",[90,231,232],{"class":100}," caddy\n",[234,235,236],"style",{},"html pre.shiki code .sAdtL, html code.shiki .sAdtL{--shiki-default:#4078F2;--shiki-dark:#61AFEF}html pre.shiki code .sDhpE, html code.shiki .sDhpE{--shiki-default:#50A14F;--shiki-dark:#98C379}html .default .shiki span {color: var(--shiki-default);background: var(--shiki-default-bg);font-style: var(--shiki-default-font-style);font-weight: var(--shiki-default-font-weight);text-decoration: var(--shiki-default-text-decoration);}html .shiki span {color: var(--shiki-default);background: var(--shiki-default-bg);font-style: var(--shiki-default-font-style);font-weight: var(--shiki-default-font-weight);text-decoration: var(--shiki-default-text-decoration);}html .dark .shiki span {color: var(--shiki-dark);background: var(--shiki-dark-bg);font-style: var(--shiki-dark-font-style);font-weight: var(--shiki-dark-font-weight);text-decoration: var(--shiki-dark-text-decoration);}html.dark .shiki span {color: var(--shiki-dark);background: var(--shiki-dark-bg);font-style: var(--shiki-dark-font-style);font-weight: var(--shiki-dark-font-weight);text-decoration: var(--shiki-dark-text-decoration);}html pre.shiki code .sAGMh, html code.shiki .sAGMh{--shiki-default:#986801;--shiki-dark:#D19A66}",{"title":86,"searchDepth":238,"depth":238,"links":239},2,[240,241,242,243],{"id":16,"depth":238,"text":17},{"id":37,"depth":238,"text":38},{"id":66,"depth":238,"text":67},{"id":136,"depth":238,"text":137},[245,246],null,{"title":247,"path":248,"stem":249,"date":250,"lang":251,"children":-1},"Does Your Top-Level Domain Slow Down Your Website? — Another Look at DNS Cold Start","/2025/11/25/did-your-tld-slowing-down-your-site","posts/en/did-your-tld-slowing-down-your-site","2025-11-25","en","/2025/12/10/caddy-traffic-proxy-on-layer-4/",1765307309072]