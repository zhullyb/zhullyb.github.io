[{"data":1,"prerenderedAt":358},["ShallowReactive",2],{"post-2025-03-30-apt-upgrade-on-internal-server-via-ssh-tunnel-and-reverse-proxy-en":3,"surround-2025-03-30-apt-upgrade-on-internal-server-via-ssh-tunnel-and-reverse-proxy-en":345,"randomIndex/2025/03/30/apt-upgrade-on-internal-server-via-ssh-tunnel-and-reverse-proxy/":356,"language-switch-/en/2025/03/30/apt-upgrade-on-internal-server-via-ssh-tunnel-and-reverse-proxy/-zh":357},{"id":4,"title":5,"body":6,"date":326,"description":327,"extension":328,"lang":329,"meta":330,"navigation":331,"path":332,"rawbody":333,"seo":334,"stem":335,"sticky":336,"tags":337,"__hash__":344},"posts/posts/en/apt-upgrade-on-internal-server-via-ssh-tunnel-and-reverse-proxy.md","SSH to the Rescue - Running APT Updates on Internal Network Servers via SSH Tunnels",{"type":7,"value":8,"toc":320},"minimark",[9,21,28,31,36,51,55,64,67,122,125,149,154,157,162,168,172,175,194,203,206,209,222,227,231,234,248,253,265,293,299,305,308,313,316],[10,11,12,13,20],"p",{},"This all started when Jinghong's ",[14,15,19],"a",{"href":16,"rel":17},"https://blog.cnpatrickstar.com/",[18],"nofollow","former technical director"," complained that the school's internal network servers couldn't connect to the external network, making APT installation and updates extremely difficult. He had to manually download packages from the source, along with their dependencies, and the dependencies of those dependencies... and then transfer all these packages to the server via sftp/rsync or similar methods for manual installation.",[10,22,23],{},[24,25],"img",{"alt":26,"src":27},"","https://static.031130.xyz/uploads/2025/03/30/0447b7d64886a.webp",[10,29,30],{},"Thus, this article was born. We can use Caddy (Nginx works too, of course) on our local machine to reverse proxy an APT mirror site, establish port forwarding through an SSH tunnel, allowing the internal network server to access the local Caddy server and thereby reach the external mirror site.",[32,33,35],"h2",{"id":34},"prerequisites","Prerequisites",[37,38,39,43],"ul",{},[40,41,42],"li",{},"Your control machine (your own computer) can directly connect to the computer via SSH (possibly using some network tools), rather than first logging into a jump host via SSH and then logging into the target server from there. The latter situation can certainly achieve our goal using similar methods, but would be more complex.",[40,44,45,46,50],{},"Your control machine (your own computer) can connect to public mirror sites while connected to the internal network server (",[47,48,49],"del",{},"if not, you might want to sync a local mirror in advance to create an offline mirror site",").",[32,52,54],{"id":53},"reverse-proxying-the-mirror-site","Reverse Proxying the Mirror Site",[10,56,57,58,63],{},"I chose Caddy over Nginx here - on one hand, Caddy's configuration files are simpler to write, and on the other hand, Caddy is written in Golang, so it's a single binary that works everywhere, and Windows can directly ",[14,59,62],{"href":60,"rel":61},"https://caddyserver.com/download",[18],"download"," and run it.",[10,65,66],{},"Using the most common Tsinghua TUNA mirror site as an example, a simple Caddy configuration file looks like this:",[68,69,73],"pre",{"className":70,"code":71,"language":72,"meta":26,"style":26},"language-nginx shiki shiki-themes one-light one-dark-pro",":8080 {\n    reverse_proxy https://mirrors.tuna.tsinghua.edu.cn {\n        header_up Host {http.reverse_proxy.upstream.hostport}\n    }\n}\n","nginx",[74,75,76,92,101,110,116],"code",{"__ignoreMap":26},[77,78,81,85,89],"span",{"class":79,"line":80},"line",1,[77,82,84],{"class":83},"s5ixo",":",[77,86,88],{"class":87},"sLKXg","8080",[77,90,91],{"class":83}," {\n",[77,93,95,98],{"class":79,"line":94},2,[77,96,97],{"class":87},"    reverse_proxy",[77,99,100],{"class":83}," https://mirrors.tuna.tsinghua.edu.cn {\n",[77,102,104,107],{"class":79,"line":103},3,[77,105,106],{"class":87},"        header_up",[77,108,109],{"class":83}," Host {http.reverse_proxy.upstream.hostport}\n",[77,111,113],{"class":79,"line":112},4,[77,114,115],{"class":83},"    }\n",[77,117,119],{"class":79,"line":118},5,[77,120,121],{"class":83},"}\n",[10,123,124],{},"Save the above code as a file named Caddyfile, then run it using the caddy command in the saved path:",[68,126,130],{"className":127,"code":128,"language":129,"meta":26,"style":26},"language-bash shiki shiki-themes one-light one-dark-pro","caddy run --config ./Caddyfile\n","bash",[74,131,132],{"__ignoreMap":26},[77,133,134,138,142,146],{"class":79,"line":80},[77,135,137],{"class":136},"sAdtL","caddy",[77,139,141],{"class":140},"sDhpE"," run",[77,143,145],{"class":144},"sAGMh"," --config",[77,147,148],{"class":140}," ./Caddyfile\n",[10,150,151],{},[24,152],{"alt":26,"src":153},"https://static.031130.xyz/uploads/2025/03/30/8ef15a08e4852.webp",[10,155,156],{},"If there are no errors, you should be able to see the Tsinghua mirror site on your local port 8080:",[10,158,159],{},[24,160],{"alt":26,"src":161},"https://static.031130.xyz/uploads/2025/03/30/a9083c95c07a2.webp",[163,164,165],"blockquote",{},[10,166,167],{},"You may notice that the reverse proxied page differs slightly from Tsinghua's mirror site - it doesn't have Tsinghua's logo. This is probably because the page's JavaScript checks the host, and if it's not Tsinghua or BFSU's page, it won't add the school name. But this doesn't affect our ability to fetch updates from these mirror sites.",[32,169,171],{"id":170},"establishing-the-ssh-tunnel","Establishing the SSH Tunnel",[10,173,174],{},"To establish the tunnel, use the following command:",[68,176,178],{"className":127,"code":177,"language":129,"meta":26,"style":26},"ssh -R 8085:localhost:8080 root@remote.example.com\n",[74,179,180],{"__ignoreMap":26},[77,181,182,185,188,191],{"class":79,"line":80},[77,183,184],{"class":136},"ssh",[77,186,187],{"class":144}," -R",[77,189,190],{"class":140}," 8085:localhost:8080",[77,192,193],{"class":140}," root@remote.example.com\n",[10,195,196,197,202],{},"The -R flag indicates establishing a reverse tunnel. For other parameter options, you can refer to this blog post \"",[14,198,201],{"href":199,"rel":200},"https://www.entropy-tree.top/2024/04/18/ssh-tunneling-techniques/",[18],"SSH Tunneling Techniques","\", also written by a Jinghong senior.",[10,204,205],{},"At this point, we've established SSH port forwarding from the internal network server's port 8085 to our local machine's port 8080. (I used port 8085 to distinguish it from port 8080; in practice, you can use any available port)",[10,207,208],{},"We can test whether we can access it normally on the server using curl. Here I simply accessed a README file in the Debian source root directory:",[68,210,212],{"className":127,"code":211,"language":129,"meta":26,"style":26},"curl http://localhost:8085/debian/README\n",[74,213,214],{"__ignoreMap":26},[77,215,216,219],{"class":79,"line":80},[77,217,218],{"class":136},"curl",[77,220,221],{"class":140}," http://localhost:8085/debian/README\n",[10,223,224],{},[24,225],{"alt":26,"src":226},"https://static.031130.xyz/uploads/2025/03/30/597c4af0d398d.webp",[32,228,230],{"id":229},"changing-sources","Changing Sources",[10,232,233],{},"So now we have a reverse proxy of the Tsinghua open source mirror site on the internal network server's port 8085, and we can access all content in the mirror site through port 8085.",[10,235,236,237,242,243,247],{},"First, follow the ",[14,238,241],{"href":239,"rel":240},"https://mirrors.tuna.tsinghua.edu.cn/help/debian/",[18],"instructions from Tsinghua Open Source Mirror Site"," to change sources. ",[244,245,246],"strong",{},"Remember to check \"Force security updates to use mirror\"",".",[10,249,250],{},[24,251],{"alt":26,"src":252},"https://static.031130.xyz/uploads/2025/03/30/46e3c7030ded4.webp",[10,254,255,256,260,261,84],{},"Then, we replace all instances of ",[14,257,258],{"href":258,"rel":259},"https://mirrors.tuna.tsinghua.edu.cn",[18]," in the sources with ",[14,262,263],{"href":263,"rel":264},"http://localhost:8085",[18],[68,266,268],{"className":127,"code":267,"language":129,"meta":26,"style":26},"sed -i 's|https\\?://mirrors\\.tuna\\.tsinghua\\.edu\\.cn|http://localhost:8085|g' `grep -rlE 'http(s)?://mirrors\\.tuna\\.tsinghua\\.edu\\.cn' /etc/apt/`\n",[74,269,270],{"__ignoreMap":26},[77,271,272,275,278,281,284,287,290],{"class":79,"line":80},[77,273,274],{"class":136},"sed",[77,276,277],{"class":144}," -i",[77,279,280],{"class":140}," 's|https\\?://mirrors\\.tuna\\.tsinghua\\.edu\\.cn|http://localhost:8085|g'",[77,282,283],{"class":140}," `",[77,285,286],{"class":136},"grep",[77,288,289],{"class":144}," -rlE",[77,291,292],{"class":140}," 'http(s)?://mirrors\\.tuna\\.tsinghua\\.edu\\.cn' /etc/apt/`\n",[10,294,295],{},[24,296],{"alt":297,"src":298},"Running apt update","https://static.031130.xyz/uploads/2025/03/30/a8f0c70d48f5b.webp",[10,300,301],{},[24,302],{"alt":303,"src":304},"Installing unzip using apt","https://static.031130.xyz/uploads/2025/03/30/07919bf939e92.webp",[10,306,307],{},"As you can see, we've successfully implemented APT updates and software installation on the internal network server through an SSH tunnel.",[163,309,310],{},[10,311,312],{},"Friendly reminder: SSH tunnels were frequently used in the early 2010s to establish cross-border access, but quickly faded from the scene due to their distinctive traffic characteristics. Therefore, don't use SSH for large amounts of cross-border network transmission, as it's easy to get blocked.",[10,314,315],{},"Of course, there are many ways to achieve this goal. Other tools like frp can achieve the same effect, but the SSH tunnel solution can be started and stopped on demand without additional configuration, which is why I primarily recommend it.",[317,318,319],"style",{},"html pre.shiki code .s5ixo, html code.shiki .s5ixo{--shiki-default:#383A42;--shiki-dark:#ABB2BF}html pre.shiki code .sLKXg, html code.shiki .sLKXg{--shiki-default:#A626A4;--shiki-dark:#C678DD}html .default .shiki span {color: var(--shiki-default);background: var(--shiki-default-bg);font-style: var(--shiki-default-font-style);font-weight: var(--shiki-default-font-weight);text-decoration: var(--shiki-default-text-decoration);}html .shiki span {color: var(--shiki-default);background: var(--shiki-default-bg);font-style: var(--shiki-default-font-style);font-weight: var(--shiki-default-font-weight);text-decoration: var(--shiki-default-text-decoration);}html .dark .shiki span {color: var(--shiki-dark);background: var(--shiki-dark-bg);font-style: var(--shiki-dark-font-style);font-weight: var(--shiki-dark-font-weight);text-decoration: var(--shiki-dark-text-decoration);}html.dark .shiki span {color: var(--shiki-dark);background: var(--shiki-dark-bg);font-style: var(--shiki-dark-font-style);font-weight: var(--shiki-dark-font-weight);text-decoration: var(--shiki-dark-text-decoration);}html pre.shiki code .sAdtL, html code.shiki .sAdtL{--shiki-default:#4078F2;--shiki-dark:#61AFEF}html pre.shiki code .sDhpE, html code.shiki .sDhpE{--shiki-default:#50A14F;--shiki-dark:#98C379}html pre.shiki code .sAGMh, html code.shiki .sAGMh{--shiki-default:#986801;--shiki-dark:#D19A66}",{"title":26,"searchDepth":94,"depth":94,"links":321},[322,323,324,325],{"id":34,"depth":94,"text":35},{"id":53,"depth":94,"text":54},{"id":170,"depth":94,"text":171},{"id":229,"depth":94,"text":230},"2025-03-30 21:45:24","This all started when Jinghong's former technical director complained that the school's internal network servers couldn't connect to the external network, making APT installation and updates extremely difficult. He had to manually download packages from the source, along with their dependencies, and the dependencies of those dependencies... and then transfer all these packages to the server via sftp/rsync or similar methods for manual installation.","md","en",{},true,"/2025/03/30/apt-upgrade-on-internal-server-via-ssh-tunnel-and-reverse-proxy","---\ntitle: SSH to the Rescue - Running APT Updates on Internal Network Servers via SSH Tunnels\ndate: 2025-03-30 21:45:24\nsticky:\ntags:\n- Apt\n- Network\n- OpenSSH\n- Caddy\n- Linux\n- Debian\n---\n\nThis all started when Jinghong's [former technical director](https://blog.cnpatrickstar.com/) complained that the school's internal network servers couldn't connect to the external network, making APT installation and updates extremely difficult. He had to manually download packages from the source, along with their dependencies, and the dependencies of those dependencies... and then transfer all these packages to the server via sftp/rsync or similar methods for manual installation.\n\n![](https://static.031130.xyz/uploads/2025/03/30/0447b7d64886a.webp)\n\nThus, this article was born. We can use Caddy (Nginx works too, of course) on our local machine to reverse proxy an APT mirror site, establish port forwarding through an SSH tunnel, allowing the internal network server to access the local Caddy server and thereby reach the external mirror site.\n\n## Prerequisites\n\n- Your control machine (your own computer) can directly connect to the computer via SSH (possibly using some network tools), rather than first logging into a jump host via SSH and then logging into the target server from there. The latter situation can certainly achieve our goal using similar methods, but would be more complex.\n- Your control machine (your own computer) can connect to public mirror sites while connected to the internal network server (~~if not, you might want to sync a local mirror in advance to create an offline mirror site~~).\n\n## Reverse Proxying the Mirror Site\n\nI chose Caddy over Nginx here - on one hand, Caddy's configuration files are simpler to write, and on the other hand, Caddy is written in Golang, so it's a single binary that works everywhere, and Windows can directly [download](https://caddyserver.com/download) and run it.\n\nUsing the most common Tsinghua TUNA mirror site as an example, a simple Caddy configuration file looks like this:\n\n```nginx\n:8080 {\n    reverse_proxy https://mirrors.tuna.tsinghua.edu.cn {\n        header_up Host {http.reverse_proxy.upstream.hostport}\n    }\n}\n```\n\nSave the above code as a file named Caddyfile, then run it using the caddy command in the saved path:\n\n```bash\ncaddy run --config ./Caddyfile\n```\n\n![](https://static.031130.xyz/uploads/2025/03/30/8ef15a08e4852.webp)\n\nIf there are no errors, you should be able to see the Tsinghua mirror site on your local port 8080:\n\n![](https://static.031130.xyz/uploads/2025/03/30/a9083c95c07a2.webp)\n\n> You may notice that the reverse proxied page differs slightly from Tsinghua's mirror site - it doesn't have Tsinghua's logo. This is probably because the page's JavaScript checks the host, and if it's not Tsinghua or BFSU's page, it won't add the school name. But this doesn't affect our ability to fetch updates from these mirror sites.\n\n## Establishing the SSH Tunnel\n\nTo establish the tunnel, use the following command:\n\n```bash\nssh -R 8085:localhost:8080 root@remote.example.com\n```\n\nThe -R flag indicates establishing a reverse tunnel. For other parameter options, you can refer to this blog post \"[SSH Tunneling Techniques](https://www.entropy-tree.top/2024/04/18/ssh-tunneling-techniques/)\", also written by a Jinghong senior.\n\nAt this point, we've established SSH port forwarding from the internal network server's port 8085 to our local machine's port 8080. (I used port 8085 to distinguish it from port 8080; in practice, you can use any available port)\n\nWe can test whether we can access it normally on the server using curl. Here I simply accessed a README file in the Debian source root directory:\n\n```bash\ncurl http://localhost:8085/debian/README\n```\n\n![](https://static.031130.xyz/uploads/2025/03/30/597c4af0d398d.webp)\n\n## Changing Sources\n\nSo now we have a reverse proxy of the Tsinghua open source mirror site on the internal network server's port 8085, and we can access all content in the mirror site through port 8085.\n\nFirst, follow the [instructions from Tsinghua Open Source Mirror Site](https://mirrors.tuna.tsinghua.edu.cn/help/debian/) to change sources. **Remember to check \"Force security updates to use mirror\"**.\n\n![](https://static.031130.xyz/uploads/2025/03/30/46e3c7030ded4.webp)\n\nThen, we replace all instances of https://mirrors.tuna.tsinghua.edu.cn in the sources with http://localhost:8085:\n\n```bash\nsed -i 's|https\\?://mirrors\\.tuna\\.tsinghua\\.edu\\.cn|http://localhost:8085|g' `grep -rlE 'http(s)?://mirrors\\.tuna\\.tsinghua\\.edu\\.cn' /etc/apt/`\n```\n\n![Running apt update](https://static.031130.xyz/uploads/2025/03/30/a8f0c70d48f5b.webp)\n\n![Installing unzip using apt](https://static.031130.xyz/uploads/2025/03/30/07919bf939e92.webp)\n\nAs you can see, we've successfully implemented APT updates and software installation on the internal network server through an SSH tunnel.\n\n> Friendly reminder: SSH tunnels were frequently used in the early 2010s to establish cross-border access, but quickly faded from the scene due to their distinctive traffic characteristics. Therefore, don't use SSH for large amounts of cross-border network transmission, as it's easy to get blocked.\n\nOf course, there are many ways to achieve this goal. Other tools like frp can achieve the same effect, but the SSH tunnel solution can be started and stopped on demand without additional configuration, which is why I primarily recommend it.\n",{"title":5,"description":327},"posts/en/apt-upgrade-on-internal-server-via-ssh-tunnel-and-reverse-proxy",false,[338,339,340,341,342,343],"Apt","Network","OpenSSH","Caddy","Linux","Debian","x_ImaCUqJv_xpFIK3AwIZqEFmzf8hjAp1QR-IWrhbUA",[346,351],{"title":347,"path":348,"stem":349,"date":350,"lang":329,"children":-1},"How to Copy Text to Clipboard with JavaScript in 2025","/2025/04/21/how-we-copy-text-to-clipboard-with-js-in-2025","posts/en/how-we-copy-text-to-clipboard-with-js-in-2025","2025-04-21 19:48:05",{"title":352,"path":353,"stem":354,"date":355,"lang":329,"children":-1},"Cudy TR3000 daed Installation Guide","/2025/02/28/cudy-tr3000-daed-install-record","posts/en/cudy-tr3000-daed-install-record","2025-02-28 21:18:34",9,"/2025/03/30/apt-upgrade-on-internal-server-via-ssh-tunnel-and-reverse-proxy/",1763997560475]