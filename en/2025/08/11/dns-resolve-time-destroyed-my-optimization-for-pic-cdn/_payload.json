[{"data":1,"prerenderedAt":580},["ShallowReactive",2],{"post-2025-08-11-dns-resolve-time-destroyed-my-optimization-for-pic-cdn-en":3,"surround-2025-08-11-dns-resolve-time-destroyed-my-optimization-for-pic-cdn-en":566,"randomIndex/2025/08/11/dns-resolve-time-destroyed-my-optimization-for-pic-cdn/":578,"language-switch-/en/2025/08/11/dns-resolve-time-destroyed-my-optimization-for-pic-cdn/-zh":579},{"title":4,"date":5,"path":6,"tags":7,"body":14,"description":565},"How DNS Resolution Latency Destroyed My Image Hosting Optimization","2025-08-11 00:06:40","/2025/08/11/dns-resolve-time-destroyed-my-optimization-for-pic-cdn",[8,9,10,11,12,13],"CDN","Image Hosting","DNS","Network","Cloudflare","Dnspod",{"type":15,"value":16,"toc":549},"minimark",[17,26,33,39,48,53,64,68,76,201,208,215,219,222,227,234,273,276,280,286,290,301,346,384,387,410,414,417,421,446,450,456,460,463,467,470,514,518,527,534,537,545],[18,19,20,21,25],"p",{},"Last summer, I spent considerable time setting up an image hosting solution for my blog. The core goal was ",[22,23,24],"strong",{},"geo-distributed DNS resolution"," to ensure fast image loading for visitors both inside and outside China. The technical approach seemed perfect—until recently, when fellow bloggers reported slow image loading on first visits. That's when I discovered the real problem.",[18,27,28],{},[29,30],"img",{"alt":31,"src":32},"","https://static.031130.xyz/uploads/2025/08/11/26306b2a483ba.webp",[18,34,35,38],{},[22,36,37],{},"955 milliseconds of DNS resolution time!"," This number shocked me. After visitors opened my blog, they had to wait nearly a full second just to determine the image server location—completely negating the benefits of CDN optimization.",[40,41,42],"blockquote",{},[18,43,44,47],{},[22,45,46],{},"Context Note:"," In China, there's a significant network divide between domestic and international internet access due to the Great Firewall. Many Chinese websites use geo-DNS to serve domestic users from servers within China and international users from overseas servers, optimizing for both speed and accessibility.",[49,50,52],"h2",{"id":51},"why-didnt-i-notice-earlier","Why Didn't I Notice Earlier?",[18,54,55,56,59,60,63],{},"The main culprit was ",[22,57,58],{},"DNS caching",". It remembers resolution results for subsequent visits, making both my local tests and return visitor tests appear normal. It wasn't until users reported issues—combined with my recent review of DNS resolution flows for job interview prep (recursive queries, authoritative queries, root domains, TLDs, etc.)—that I pinpointed the problem: ",[22,61,62],{},"first-visit DNS resolution latency",".",[49,65,67],{"id":66},"dns-resolution-flow-analysis","DNS Resolution Flow Analysis",[18,69,70,71,75],{},"Let's examine what happens when a visitor accesses ",[72,73,74],"code",{},"static.031130.xyz",":",[77,78,82],"pre",{"className":79,"code":80,"language":81,"meta":31,"style":31},"language-mermaid shiki shiki-themes one-light one-dark-pro","sequenceDiagram\n    participant User as Visitor Browser\n    participant Local as Local DNS\n    participant CF as Cloudflare\u003Cbr/>(Foreign Authority)\n    participant DP as DNSPod\u003Cbr/>(Domestic Authority)\n    participant CDN as CDN Node\n\n    User->>Local: Request static.031130.xyz\n    Local->>CF: Query 031130.xyz authority\n    Note over Local,CF: Cross-border query, high latency\n    CF->>Local: CNAME: cdn-cname.zhul.in\n    Local->>DP: Query zhul.in authority\n    DP->>Local: CNAME: small-storage-cdn.b0.aicdn.com\n    Local->>DP: Query aicdn.com\n    DP->>Local: CNAME: nm.aicdn.com\n    Local->>DP: Query final IP\n    DP->>Local: Return CDN IP\n    Local->>User: Return resolution result\n    User->>CDN: Connect and download images\n","mermaid",[72,83,84,92,98,104,110,116,122,129,135,141,147,153,159,165,171,177,183,189,195],{"__ignoreMap":31},[85,86,89],"span",{"class":87,"line":88},"line",1,[85,90,91],{},"sequenceDiagram\n",[85,93,95],{"class":87,"line":94},2,[85,96,97],{},"    participant User as Visitor Browser\n",[85,99,101],{"class":87,"line":100},3,[85,102,103],{},"    participant Local as Local DNS\n",[85,105,107],{"class":87,"line":106},4,[85,108,109],{},"    participant CF as Cloudflare\u003Cbr/>(Foreign Authority)\n",[85,111,113],{"class":87,"line":112},5,[85,114,115],{},"    participant DP as DNSPod\u003Cbr/>(Domestic Authority)\n",[85,117,119],{"class":87,"line":118},6,[85,120,121],{},"    participant CDN as CDN Node\n",[85,123,125],{"class":87,"line":124},7,[85,126,128],{"emptyLinePlaceholder":127},true,"\n",[85,130,132],{"class":87,"line":131},8,[85,133,134],{},"    User->>Local: Request static.031130.xyz\n",[85,136,138],{"class":87,"line":137},9,[85,139,140],{},"    Local->>CF: Query 031130.xyz authority\n",[85,142,144],{"class":87,"line":143},10,[85,145,146],{},"    Note over Local,CF: Cross-border query, high latency\n",[85,148,150],{"class":87,"line":149},11,[85,151,152],{},"    CF->>Local: CNAME: cdn-cname.zhul.in\n",[85,154,156],{"class":87,"line":155},12,[85,157,158],{},"    Local->>DP: Query zhul.in authority\n",[85,160,162],{"class":87,"line":161},13,[85,163,164],{},"    DP->>Local: CNAME: small-storage-cdn.b0.aicdn.com\n",[85,166,168],{"class":87,"line":167},14,[85,169,170],{},"    Local->>DP: Query aicdn.com\n",[85,172,174],{"class":87,"line":173},15,[85,175,176],{},"    DP->>Local: CNAME: nm.aicdn.com\n",[85,178,180],{"class":87,"line":179},16,[85,181,182],{},"    Local->>DP: Query final IP\n",[85,184,186],{"class":87,"line":185},17,[85,187,188],{},"    DP->>Local: Return CDN IP\n",[85,190,192],{"class":87,"line":191},18,[85,193,194],{},"    Local->>User: Return resolution result\n",[85,196,198],{"class":87,"line":197},19,[85,199,200],{},"    User->>CDN: Connect and download images\n",[18,202,203,204,207],{},"Here's the problem: ",[22,205,206],{},"the first two query steps point to Cloudflare's authoritative servers overseas",". For domestic Chinese users, even though the final resolved CDN node is within China, the cross-border DNS queries are enough to cripple the first-visit experience. That 955ms latency is mostly spent communicating with foreign DNS servers.",[40,209,210],{},[18,211,212,214],{},[22,213,46],{}," DNSPod is Tencent's DNS service provider, widely used in China for its domestic infrastructure and reliability.",[49,216,218],{"id":217},"optimization-solutions","Optimization Solutions",[18,220,221],{},"To address this issue, I implemented three measures:",[223,224,226],"h3",{"id":225},"_1-dns-prefetch","1. DNS Prefetch",[18,228,229,230,233],{},"Added to the blog's HTML ",[72,231,232],{},"\u003Chead>"," section:",[77,235,239],{"className":236,"code":237,"language":238,"meta":31,"style":31},"language-html shiki shiki-themes one-light one-dark-pro","\u003Clink rel=\"dns-prefetch\" href=\"//static.031130.xyz\">\n","html",[72,240,241],{"__ignoreMap":31},[85,242,243,247,251,255,258,262,265,267,270],{"class":87,"line":88},[85,244,246],{"class":245},"s5ixo","\u003C",[85,248,250],{"class":249},"sJa8x","link",[85,252,254],{"class":253},"sAGMh"," rel",[85,256,257],{"class":245},"=",[85,259,261],{"class":260},"sDhpE","\"dns-prefetch\"",[85,263,264],{"class":253}," href",[85,266,257],{"class":245},[85,268,269],{"class":260},"\"//static.031130.xyz\"",[85,271,272],{"class":245},">\n",[18,274,275],{},"This way, the browser performs DNS resolution for the image hosting domain while rendering the page. By the time images actually need to load, the DNS results may already be ready.",[223,277,279],{"id":278},"_2-extended-ttl","2. Extended TTL",[18,281,282,283,285],{},"Increased the TTL (Time To Live) value for the ",[72,284,74],{}," CNAME record from a few minutes to several hours or even a day. This allows local DNS servers to cache results longer, enabling subsequent users to directly use cached results and skip authoritative queries.",[223,287,289],{"id":288},"_3-migrate-authoritative-dns-core-solution","3. Migrate Authoritative DNS (Core Solution)",[18,291,292,293,296,297,300],{},"Migrated the ",[22,294,295],{},"authoritative DNS servers"," for the ",[72,298,299],{},"031130.xyz"," domain from Cloudflare to DNSPod in China:",[77,302,304],{"className":79,"code":303,"language":81,"meta":31,"style":31},"graph TB\n    subgraph \"Before Optimization\"\n        A1[Visitor] --> B1[Local DNS]\n        B1 --> C1[Cloudflare Authority\u003Cbr/>Overseas]\n        C1 --> D1[DNSPod Authority\u003Cbr/>Domestic]\n        D1 --> E1[CDN Node]\n        style C1 fill:#ffcccc\n    end\n",[72,305,306,311,316,321,326,331,336,341],{"__ignoreMap":31},[85,307,308],{"class":87,"line":88},[85,309,310],{},"graph TB\n",[85,312,313],{"class":87,"line":94},[85,314,315],{},"    subgraph \"Before Optimization\"\n",[85,317,318],{"class":87,"line":100},[85,319,320],{},"        A1[Visitor] --> B1[Local DNS]\n",[85,322,323],{"class":87,"line":106},[85,324,325],{},"        B1 --> C1[Cloudflare Authority\u003Cbr/>Overseas]\n",[85,327,328],{"class":87,"line":112},[85,329,330],{},"        C1 --> D1[DNSPod Authority\u003Cbr/>Domestic]\n",[85,332,333],{"class":87,"line":118},[85,334,335],{},"        D1 --> E1[CDN Node]\n",[85,337,338],{"class":87,"line":124},[85,339,340],{},"        style C1 fill:#ffcccc\n",[85,342,343],{"class":87,"line":131},[85,344,345],{},"    end\n",[77,347,349],{"className":79,"code":348,"language":81,"meta":31,"style":31},"graph TB\n    subgraph \"After Optimization\"\n        A2[Visitor] --> B2[Local DNS]\n        B2 --> D2[DNSPod Authority\u003Cbr/>Domestic]\n        D2 --> E2[CDN Node]\n        style D2 fill:#ccffcc\n    end\n",[72,350,351,355,360,365,370,375,380],{"__ignoreMap":31},[85,352,353],{"class":87,"line":88},[85,354,310],{},[85,356,357],{"class":87,"line":94},[85,358,359],{},"    subgraph \"After Optimization\"\n",[85,361,362],{"class":87,"line":100},[85,363,364],{},"        A2[Visitor] --> B2[Local DNS]\n",[85,366,367],{"class":87,"line":106},[85,368,369],{},"        B2 --> D2[DNSPod Authority\u003Cbr/>Domestic]\n",[85,371,372],{"class":87,"line":112},[85,373,374],{},"        D2 --> E2[CDN Node]\n",[85,376,377],{"class":87,"line":118},[85,378,379],{},"        style D2 fill:#ccffcc\n",[85,381,382],{"class":87,"line":124},[85,383,345],{},[18,385,386],{},"Benefits after migration:",[388,389,390,397,407],"ul",{},[391,392,393,394,396],"li",{},"When recursive DNS queries ",[72,395,299],{},", it directly reaches DNSPod in China with fast response",[391,398,399,400,402,403,406],{},"DNSPod directly returns ",[72,401,74],{}," -> ",[72,404,405],{},"small-storage-cdn.b0.aicdn.com"," without intermediate hops",[391,408,409],{},"The entire DNS resolution chain completes domestically, dramatically reducing first-visit latency",[49,411,413],{"id":412},"optimization-results","Optimization Results",[18,415,416],{},"While DNS caching makes testing difficult, after migrating the authoritative DNS + adjusting TTL + adding prefetch, first-visit DNS resolution time dropped to an acceptable range.",[49,418,420],{"id":419},"lessons-learned","Lessons Learned",[422,423,424,430,440],"ol",{},[391,425,426,429],{},[22,427,428],{},"DNS Location Matters",": When optimizing for multiple regions, the geographic location of authoritative DNS servers significantly impacts first-visit latency. Prioritize using domestic authoritative servers for your target audience.",[391,431,432,435,436,439],{},[22,433,434],{},"First Visits Are Critical",": While caching helps subsequent visits, the first-visit experience directly affects user impression. Make good use of ",[72,437,438],{},"dns-prefetch"," and reasonable TTL settings.",[391,441,442,445],{},[22,443,444],{},"Monitoring and Feedback Are Important",": Local test environments often benefit from caching; real first-visit experiences need to be discovered through monitoring and user feedback.",[49,447,449],{"id":448},"important-warning-beware-of-cname-flattening","Important Warning: Beware of CNAME Flattening",[18,451,452,453,63],{},"If you need geo-distributed resolution to connect visitors to the nearest CDN node, ",[22,454,455],{},"absolutely avoid CNAME Flattening",[223,457,459],{"id":458},"what-is-cname-flattening","What Is CNAME Flattening?",[18,461,462],{},"When an authoritative DNS server (like Cloudflare) sees a CNAME record, it proactively queries the final IP address of the target domain and then directly returns the IP instead of the CNAME.",[223,464,466],{"id":465},"why-does-this-cause-problems","Why Does This Cause Problems?",[18,468,469],{},"Geo-distributed resolution (GeoDNS) is implemented at the authoritative DNS server level. When the authoritative server performs CNAME flattening, it queries the target domain's IP from its own location. If the authoritative DNS is in the US, it gets the optimal US node IP, then returns this IP to all regional queries, including Chinese users. This completely breaks your domestic CDN IP strategy configured for Chinese users.",[77,471,473],{"className":79,"code":472,"language":81,"meta":31,"style":31},"graph LR\n    subgraph \"CNAME Flattening Problem\"\n        A[Chinese User] --> B[Cloudflare Authority\u003Cbr/>US Node]\n        B --> C[Query Target CNAME]\n        C --> D[Return US CDN IP]\n        D --> A\n        style D fill:#ffcccc\n    end\n",[72,474,475,480,485,490,495,500,505,510],{"__ignoreMap":31},[85,476,477],{"class":87,"line":88},[85,478,479],{},"graph LR\n",[85,481,482],{"class":87,"line":94},[85,483,484],{},"    subgraph \"CNAME Flattening Problem\"\n",[85,486,487],{"class":87,"line":100},[85,488,489],{},"        A[Chinese User] --> B[Cloudflare Authority\u003Cbr/>US Node]\n",[85,491,492],{"class":87,"line":106},[85,493,494],{},"        B --> C[Query Target CNAME]\n",[85,496,497],{"class":87,"line":112},[85,498,499],{},"        C --> D[Return US CDN IP]\n",[85,501,502],{"class":87,"line":118},[85,503,504],{},"        D --> A\n",[85,506,507],{"class":87,"line":124},[85,508,509],{},"        style D fill:#ffcccc\n",[85,511,512],{"class":87,"line":131},[85,513,345],{},[223,515,517],{"id":516},"the-correct-approach","The Correct Approach",[18,519,520,521,402,523,526],{},"Honestly use CNAME to point to another domain that supports GeoDNS (such as ",[72,522,74],{},[72,524,525],{},"cdn-cname.zhul.in",", with the latter doing geo-distributed resolution on DNSPod). Only this way can you ensure the routing strategy executes correctly.",[18,528,529,530,533],{},"If you need geo-distributed resolution functionality, ",[22,531,532],{},"do not"," enable CNAME Flattening (or similar features like ALIAS, ANAME, etc.) on related domains.",[535,536],"hr",{},[40,538,539],{},[18,540,541,544],{},[22,542,543],{},"Author's Note:"," This article reflects the unique challenges of optimizing web services for the Chinese internet landscape, where the network infrastructure divide between domestic and international access requires careful DNS and CDN configuration to provide optimal performance for all users.",[546,547,548],"style",{},"html .default .shiki span {color: var(--shiki-default);background: var(--shiki-default-bg);font-style: var(--shiki-default-font-style);font-weight: var(--shiki-default-font-weight);text-decoration: var(--shiki-default-text-decoration);}html .shiki span {color: var(--shiki-default);background: var(--shiki-default-bg);font-style: var(--shiki-default-font-style);font-weight: var(--shiki-default-font-weight);text-decoration: var(--shiki-default-text-decoration);}html .dark .shiki span {color: var(--shiki-dark);background: var(--shiki-dark-bg);font-style: var(--shiki-dark-font-style);font-weight: var(--shiki-dark-font-weight);text-decoration: var(--shiki-dark-text-decoration);}html.dark .shiki span {color: var(--shiki-dark);background: var(--shiki-dark-bg);font-style: var(--shiki-dark-font-style);font-weight: var(--shiki-dark-font-weight);text-decoration: var(--shiki-dark-text-decoration);}html pre.shiki code .s5ixo, html code.shiki .s5ixo{--shiki-default:#383A42;--shiki-dark:#ABB2BF}html pre.shiki code .sJa8x, html code.shiki .sJa8x{--shiki-default:#E45649;--shiki-dark:#E06C75}html pre.shiki code .sAGMh, html code.shiki .sAGMh{--shiki-default:#986801;--shiki-dark:#D19A66}html pre.shiki code .sDhpE, html code.shiki .sDhpE{--shiki-default:#50A14F;--shiki-dark:#98C379}",{"title":31,"searchDepth":94,"depth":94,"links":550},[551,552,553,558,559,560],{"id":51,"depth":94,"text":52},{"id":66,"depth":94,"text":67},{"id":217,"depth":94,"text":218,"children":554},[555,556,557],{"id":225,"depth":100,"text":226},{"id":278,"depth":100,"text":279},{"id":288,"depth":100,"text":289},{"id":412,"depth":94,"text":413},{"id":419,"depth":94,"text":420},{"id":448,"depth":94,"text":449,"children":561},[562,563,564],{"id":458,"depth":100,"text":459},{"id":465,"depth":100,"text":466},{"id":516,"depth":100,"text":517},"Last summer, I spent considerable time setting up an image hosting solution for my blog. The core goal was geo-distributed DNS resolution to ensure fast image loading for visitors both inside and outside China. The technical approach seemed perfect—until recently, when fellow bloggers reported slow image loading on first visits. That's when I discovered the real problem.",[567,573],{"title":568,"path":569,"stem":570,"date":571,"lang":572,"children":-1},"First Experience with GitHub Action Self-hosted Runner: Love is Not Easy","/2025/09/05/first-try-of-github-action-self-hosted-runner","posts/en/first-try-of-github-action-self-hosted-runner","2025-09-05 05:54:17","en",{"title":574,"path":575,"stem":576,"date":577,"lang":572,"children":-1},"Vue Markdown Rendering Optimization in Practice (Part 2): Farewell to DOM Manipulation, Embrace AST and Functional Rendering","/2025/07/13/vue-markdown-render-improvement-2","posts/en/vue-markdown-render-improvement-2","2025-07-13 00:01:35",0,"/2025/08/11/dns-resolve-time-destroyed-my-optimization-for-pic-cdn/",1765391925480]