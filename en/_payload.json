[{"data":1,"prerenderedAt":5996},["ShallowReactive",2],{"randomIndex/":3,"index-page-1-en":4,"language-switch-/en/-zh":5995,"posts-total-en":1284},9,[5,415,884,1389,1626,3622,3960,4386,5406,5780],{"title":6,"date":7,"path":8,"tags":9,"body":13},"Mainland China Xiaomi FCM Screen-Off Disconnection: Attempts and Possible Solutions in a Rootless Environment","2026-02-20","/2026/02/20/xiaomi-china-version-fcm-push-debug",[10,11,12],"Android","Network","Hardware",{"type":14,"value":15,"toc":394},"minimark",[16,20,23,26,31,47,51,59,70,73,79,82,86,89,92,96,99,104,107,110,114,121,124,162,165,187,190,196,208,211,220,223,227,230,233,237,240,246,249,271,274,278,281,290,293,296,300,309,318,321,327,331,334,337,341,390],[17,18,19],"p",{},"In November last year, I got a new mainland China version Xiaomi 15 as my daily driver. Actually, my previous Redmi K70 Ultra was released in the same year as this Xiaomi 15, and performance-wise they're comparable. However, during my Gap Year while traveling across the country, I realized it was a shame not being able to capture the night scenes I encountered, so I wanted to switch to a phone with better camera capabilities. The newly released Xiaomi 17 was at a premium price point, and didn't offer significant improvements over the 15, so I went directly for the Xiaomi 15.",[17,21,22],{},"After getting it, I followed my usual habits and enabled \"Google Base Services\" in settings, installed \"Google Play\" and started using it normally. But over these past few months, I discovered that my FCM push notificationsâ€”whether Outlook email notifications or a certain instant messaging app that looks like a paper airplaneâ€”never seemed to work properly from the start. Their notifications would occasionally pop up suddenly after I unlocked my phone, but more often they just disappeared. I would only receive the backlogged notifications when I manually opened the corresponding apps.",[17,24,25],{},"Recently I received an offer from an overseas university and will be going abroad in September to pursue a master's degree, so I wanted to resolve this issue before leaving the country. After all, when living in China, most apps can push messages to me through MiPush, and these FCM-dependent apps weren't my most frequently used ones. I could just open them manually when I woke up each day to receive notifications. Even if my message response time wasn't great, it wasn't a big dealâ€”if there was something urgent, my family and friends knew other ways to reach me faster. But once abroad, FCM push notifications become critically important, so I need to fix this issue quickly, or I'll have to consider switching phones.",[27,28,30],"h2",{"id":29},"test-environment","Test Environment",[32,33,34,38,41,44],"ul",{},[35,36,37],"li",{},"Xiaomi 15 mainland China version, 16GB + 512GB, HyperOS 3.0.7.0.WOCCNXM, the latest version as of this writing",[35,39,40],{},"\"Google Base Services\" enabled, \"Google Play\" installed",[35,42,43],{},"Connected to WiFi, with WiFi-routed data exit IP in ðŸ‡ºðŸ‡¸ Los Angeles",[35,45,46],{},"MIUI optimization not disabled",[27,48,50],{"id":49},"getting-fcm-running-first","Getting FCM Running First",[17,52,53,54,58],{},"I needed to first resolve the issue of FCM not receiving messages even when the screen is on. In the \"Phone\" app's dialer, entering ",[55,56,57],"code",{},"*#*#426#*#*"," opens the FCM Diagnostics interface, which contains logs about FCM connection status.",[17,60,61,66],{},[62,63],"img",{"alt":64,"src":65},"Dialer Input","https://static.031130.xyz/uploads/2026/02/20/6202d116db231.webp",[62,67],{"alt":68,"src":69},"FCM Diagnostics Interface","https://static.031130.xyz/uploads/2026/02/20/432922f339849.webp",[17,71,72],{},"In this interface, I found that FCM's connection status was actually normal, with no obvious error messages in the logs. So I started suspecting that some of HyperOS's power-saving mechanisms were interfering with FCM's normal operation in the background. Through some searching on Xiaohongshu (Little Red Book), I discovered that enabling \"Autostart\" permission for apps requiring FCM push in the settings interface, and setting battery optimization to \"Don't optimize,\" seemed to solve this problem.",[17,74,75],{},[62,76],{"alt":77,"src":78},"App Settings Interface","https://static.031130.xyz/uploads/2026/02/20/8c20be931764b.webp",[17,80,81],{},"Testing with an IM app (sending messages from one account to another), I found that with the screen on, FCM could now receive messages normally even when the app was closed in the background.",[27,83,85],{"id":84},"the-problem-of-fcm-disconnecting-one-minute-after-screen-off","The Problem of FCM Disconnecting One Minute After Screen-Off",[17,87,88],{},"However, after turning off the screen and leaving it idle for a minute, FCM stopped working completely. Whether email notifications or IM messages, none could be pushed to the phone via FCM. Only when I lit up the screen would the backlogged notifications suddenly appear. Checking the FCM Diagnostics interface again, FCM's connection status was either disconnected or had just connected for a few seconds. This indicates that in the lock screen state, FCM's connection gets terminated by the system, preventing message reception.",[17,90,91],{},"PS: I discovered that when charging, even with the phone locked, FCM maintains its connection and receives messages normally. This further confirms that HyperOS's power-saving mechanisms are interfering with FCM's normal operation.",[27,93,95],{"id":94},"possible-solutions","Possible Solutions",[17,97,98],{},"After searching on Xiaohongshu and XiaolÃ¼shu (CoolApk), I found some attempts and solutions from others:",[100,101,103],"h3",{"id":102},"_1-disable-miui-optimization","1. Disable MIUI Optimization",[17,105,106],{},"This is my least favorite solution, because MIUI optimization is actually an important reason why I like HyperOS (MIUI). After disabling MIUI optimization, I found that the remaining battery percentage information can't be displayed inside the status bar battery iconâ€”it must appear to the right of the battery icon. This is a huge waste of status bar space after HyperOS introduced the Super Island (Dynamic Island). Of course, there are other features that would be affected, but this is what I care about most.",[17,108,109],{},"Additionally, in HyperOS 3's developer mode, the \"Disable MIUI optimization\" option can no longer be found, though some users report you can make this option reappear through methods like resetting settings status, but I don't think this is a good solution.",[100,111,113],{"id":112},"_2-freeze-battery-performance-app-or-replace-with-international-version","2. Freeze \"Battery & Performance\" App or Replace with International Version",[17,115,116,117],{},"On HyperOS 2, some users reported that tampering with the \"Battery & Performance\" system app could solve the FCM screen-off disconnection problem. I tried using adb shell to freeze it, but after testing, this wasn't a useful solution, and it might cause some system scheduling anomalies. ",[118,119,120],"strong",{},"Also, don't enter ultra power saving mode, because that mode's UI is provided by the \"Battery & Performance\" app!!",[17,122,123],{},"The adb command is as follows:",[125,126,131],"pre",{"className":127,"code":128,"language":129,"meta":130,"style":130},"language-bash shiki shiki-themes one-light one-dark-pro","adb shell pm uninstall --user 0 com.miui.powerkeeper\n","bash","",[55,132,133],{"__ignoreMap":130},[134,135,138,142,146,149,152,156,159],"span",{"class":136,"line":137},"line",1,[134,139,141],{"class":140},"sAdtL","adb",[134,143,145],{"class":144},"sDhpE"," shell",[134,147,148],{"class":144}," pm",[134,150,151],{"class":144}," uninstall",[134,153,155],{"class":154},"sAGMh"," --user",[134,157,158],{"class":154}," 0",[134,160,161],{"class":144}," com.miui.powerkeeper\n",[17,163,164],{},"If you want to restore it, you can reinstall this app with the following command:",[125,166,168],{"className":127,"code":167,"language":129,"meta":130,"style":130},"adb shell cmd package install-existing com.miui.powerkeeper\n",[55,169,170],{"__ignoreMap":130},[134,171,172,174,176,179,182,185],{"class":136,"line":137},[134,173,141],{"class":140},[134,175,145],{"class":144},[134,177,178],{"class":144}," cmd",[134,180,181],{"class":144}," package",[134,183,184],{"class":144}," install-existing",[134,186,161],{"class":144},[17,188,189],{},"Some people also reported that replacing it with the international version of the \"Battery & Performance\" app could solve this problem, but I couldn't find the installation package for the HyperOS 3 international version's \"Battery & Performance\" app. After downloading and unpacking the complete ROM for the Xiaomi 15 overseas version, that app's apk couldn't be directly updated or installed via adb either.",[17,191,192],{},[62,193],{"alt":194,"src":195},"Update Failed","https://static.031130.xyz/uploads/2026/02/20/58ba6ce88ef49.webp",[100,197,199,200,207],{"id":198},"_3-use-fcmfix-and-other-xposed-modules-after-unlocking-bootloader","3. Use ",[201,202,206],"a",{"href":203,"rel":204},"https://github.com/kooritea/fcmfix",[205],"nofollow","fcmfix"," and Other Xposed Modules After Unlocking Bootloader",[17,209,210],{},"This solution is... forget it. Although I have a level 5 account on the Xiaomi community, I don't have the energy to participate in the \"Xiaomi entrance exam\" (I heard it's been suspended anyway). Moreover, after unlocking the bootloader, I might face a series of problems like payment apps not working. If I wanted to cover up related traces, I'd have to go through more hassleâ€”it feels like more trouble than it's worth.",[100,212,214,215],{"id":213},"_4-use-heartbeatfixerforgcm","4. Use ",[201,216,219],{"href":217,"rel":218},"https://github.com/shaobin0604/HeartbeatFixerForGCM",[205],"HeartbeatFixerForGCM",[17,221,222],{},"This software has been removed from Google Play and hasn't been updated in a long time. Testing shows it cannot prevent FCM from being disconnected by the system in lock screen state on HyperOS 3.",[100,224,226],{"id":225},"_5-use-gboard-to-keep-fcm-alive","5. Use Gboard to Keep FCM Alive",[17,228,229],{},"Although I don't know the principle, some users reported that installing Gboard keyboard allows FCM to maintain its connection and receive messages normally in lock screen state. I tried it too, and indeed after installing Gboard and setting it as the default input method, FCM could maintain its connection in lock screen state.",[17,231,232],{},"However, this solution isn't perfect either. After all, I don't like Gboard's input experience, so I can't really accept this solution.",[27,234,236],{"id":235},"some-personal-experiments","Some Personal Experiments",[17,238,239],{},"Although I don't have much experience with Android developmentâ€”only touching it during a sophomore year course projectâ€”the AI era has given me the ability to do vibe coding.",[17,241,242],{},[62,243],{"alt":244,"src":245},"Attempting to use vibe coding to modify source code and compile","https://static.031130.xyz/uploads/2026/02/20/51db4ed4ef15b.webp",[17,247,248],{},"So I also had AI modify some logic for keeping FCM alive based on HeartbeatFixerForGCM's open-source code, roughly following these approaches:",[32,250,251,254,257,260,263],{},[35,252,253],{},"Input Method Keep-Alive: Continuing Gboard's approach, using the persistent nature of input method services to maintain FCM connection. It could keep FCM alive, but lost the input capability of the input methodâ€”pass.",[35,255,256],{},"Notification Listening: NotificationListener as a system listening role to increase persistence probabilityâ€”no success, pass.",[35,258,259],{},"Foreground Service: Persistent notification + FGS to elevate process survival priorityâ€”no success, pass.",[35,261,262],{},"Accessibility Keep-Alive: Accessibility service also as a system listening role to increase persistence probabilityâ€”no success, pass.",[35,264,265,266,270],{},"VPN Keep-Alive: Using VPN service's persistent nature to maintain FCM connection. Don't know if it has any effect, ",[267,268,269],"del",{},"but it did manage to disconnect my phone's network","â€”pass.",[17,272,273],{},"In short, none of these attempts succeeded. FCM still gets disconnected by the system in lock screen state.",[27,275,277],{"id":276},"seems-like-i-found-a-viable-solution","Seems Like I Found a Viable Solution?",[17,279,280],{},"Just when I was at my wit's end and ready to shop for another phone, I saw a Xiaohongshu post mentioning that you could first uninstall updates to \"Google Play Services,\" then update it again to the latest version. The poster's explanation was to first uninstall the mainland-optimized Play Services, then install an un-optimized version from the Play Store, which could solve this problem.",[17,282,283,284,289],{},"Although you can't directly find the \"Google Play Services\" app on the Play Store, you can search for \"Google Play Services\" using your phone's browser, click the link from google.com, and it will automatically jump to the \"Google Play Services\" app page on the Play Store. You can also click ",[201,285,288],{"href":286,"rel":287},"https://play.google.com/store/apps/details?id=com.google.android.gms",[205],"here"," directly.",[17,291,292],{},"I tried it too, and indeed after uninstalling updates to \"Google Play Services,\" FCM could maintain its connection in lock screen state. Although this solution sounds a bit mystical and I can't see the actual principle at work, since it was effective, I didn't dwell on it.",[17,294,295],{},"But just when I thought the problem was solved, while writing this article, I tried restarting my phone and found the problem had returned. And after restarting, repeating the above steps of uninstalling updates to \"Google Play Services\" still didn't solve the problem. This troubled me greatly, so I started recalling the previous operation steps, but I could never reproduce the previous state...",[27,297,299],{"id":298},"wait-there-seems-to-be-a-fallback","Wait, There Seems to Be a Fallback",[17,301,302,303,308],{},"While discussing this issue with a ",[201,304,307],{"href":305,"rel":306},"https://github.com/Rurikobaka/",[205],"seasoned Android enthusiast",", he pointed out that mainland OS indeed disconnects FCM's long connection after screen-off to save power, but still maintains a periodic check mechanism. This seems to match some isolated cases I encountered during testing. This periodic check interval is quite longâ€”according to his estimate, around 10-20 minutes. I also conducted a round of testing myself. The process was:",[310,311,312,315],"ol",{},[35,313,314],{},"Screen off for one minute, use secondary account to send message to main account, wait 6 minutes until main account receives the message, notified by my Xiaomi band's vibration that the message arrived.",[35,316,317],{},"Immediately use secondary account to send another message to main account, wait for main account to receive the second message, record the time difference between the two messages.",[17,319,320],{},"Because the time interval is quite long, I only tested one and a half rounds. The first round's time difference was 28 minutes, and the second round's time difference reached 38 minutes.",[17,322,323,324],{},"Conclusion: ",[118,325,326],{},"In screen-off state, although FCM's connection gets disconnected by the system, the system will automatically wake up FCM approximately every 30 minutes (inaccurate data) to check for new messages. If there are any, you'll receive notifications.",[27,328,330],{"id":329},"conclusion","Conclusion",[17,332,333],{},"Currently, to receive FCM push notifications on mainland China version Xiaomi phones, you can only choose between using Gboard + real-time push / periodic check mechanism fallback.",[17,335,336],{},"The former uses Gboard input method's persistent nature to maintain FCM connection, enabling real-time message reception in screen-off state, but requires sacrificing input experience; the latter uses system periodic FCM wake-ups to check for new messages. While not requiring sacrifice of input experience, there may be delays exceeding half an hour.",[27,338,340],{"id":339},"references","References",[32,342,343,350,357,364,371,377,387],{},[35,344,345],{},[201,346,349],{"href":347,"rel":348},"https://www.mobile01.com/topicdetail.php?f=634&t=6892724",[205],"ã€HyperOSã€‘ä¿®å¾©å°ç±³é™¸ç‰ˆé€šçŸ¥æŽ¨é€ - Mobile01",[35,351,352],{},[201,353,356],{"href":354,"rel":355},"https://www.v2ex.com/t/993090",[205],"å¦‚ä½•è§£å†³åŽŸç”Ÿ Android ç»­èˆªé—®é¢˜ï¼Ÿ - V2EX",[35,358,359],{},[201,360,363],{"href":361,"rel":362},"https://staging.v2ex.com/t/1089681",[205],"å°ç±³ 15/hyperOS 2.0 æ‰“å¼€ FCM é€šçŸ¥ - V2EX",[35,365,366],{},[201,367,370],{"href":368,"rel":369},"https://www.threads.com/@silicon.salmon/post/DDR_SD8y3Gp",[205],"æµ·å¤–ä¸å»ºè­°è³¼è²·å…§åœ°ç‰ˆå°ç±³æ‰‹æ©Ÿ å› ç‚ºä¸€éŽ–å±å°±æ–·é€£ FCMï¼Œ å°Žè‡´æµ·å¤– App æ”¶ä¸åˆ°æ¶ˆæ¯æŽ¨é€ã€‚ äº®å±å¾Œ FCMï¼Œæœƒå˜—è©¦é‡é€£ã€‚ é‡é€£æˆåŠŸï¼Œæ‰èƒ½æ”¶åˆ°é€šçŸ¥ã€‚ å·²é–‹è‡ªå•Ÿå‹•ï¼Œé›»æ± ç„¡é™åˆ¶ã€‚ æœ‰ä»€éº¼è§£æ±ºè¾¦æ³•ï¼Ÿ é¦™æ¸¯æ¾³é–€| salmon0105",[35,372,373],{},[201,374,376],{"href":217,"rel":375},[205],"shaobin0604/HeartbeatFixerForGCM: Tiny application to fix GCM push notification delay issue",[35,378,379],{},[201,380,382,383,386],{"href":203,"rel":381},[205],"kooritea/fcmfix: ",[134,384,385],{},"xposed","è®©fcmå”¤é†’å·²å®Œå…¨åœæ­¢çš„åº”ç”¨",[35,388,389],{},"Various discussions and feedback on social platforms like Xiaohongshu and CoolApk. Since the content is rather scattered and unsystematic, I won't list them all here. Interested readers can search for relevant keywords to view them.",[391,392,393],"style",{},"html pre.shiki code .sAdtL, html code.shiki .sAdtL{--shiki-default:#4078F2;--shiki-dark:#61AFEF}html pre.shiki code .sDhpE, html code.shiki .sDhpE{--shiki-default:#50A14F;--shiki-dark:#98C379}html pre.shiki code .sAGMh, html code.shiki .sAGMh{--shiki-default:#986801;--shiki-dark:#D19A66}html .default .shiki span {color: var(--shiki-default);background: var(--shiki-default-bg);font-style: var(--shiki-default-font-style);font-weight: var(--shiki-default-font-weight);text-decoration: var(--shiki-default-text-decoration);}html .shiki span {color: var(--shiki-default);background: var(--shiki-default-bg);font-style: var(--shiki-default-font-style);font-weight: var(--shiki-default-font-weight);text-decoration: var(--shiki-default-text-decoration);}html .dark .shiki span {color: var(--shiki-dark);background: var(--shiki-dark-bg);font-style: var(--shiki-dark-font-style);font-weight: var(--shiki-dark-font-weight);text-decoration: var(--shiki-dark-text-decoration);}html.dark .shiki span {color: var(--shiki-dark);background: var(--shiki-dark-bg);font-style: var(--shiki-dark-font-style);font-weight: var(--shiki-dark-font-weight);text-decoration: var(--shiki-dark-text-decoration);}",{"title":130,"searchDepth":395,"depth":395,"links":396},2,[397,398,399,400,410,411,412,413,414],{"id":29,"depth":395,"text":30},{"id":49,"depth":395,"text":50},{"id":84,"depth":395,"text":85},{"id":94,"depth":395,"text":95,"children":401},[402,404,405,407,409],{"id":102,"depth":403,"text":103},3,{"id":112,"depth":403,"text":113},{"id":198,"depth":403,"text":406},"3. Use fcmfix and Other Xposed Modules After Unlocking Bootloader",{"id":213,"depth":403,"text":408},"4. Use HeartbeatFixerForGCM",{"id":225,"depth":403,"text":226},{"id":235,"depth":395,"text":236},{"id":276,"depth":395,"text":277},{"id":298,"depth":395,"text":299},{"id":329,"depth":395,"text":330},{"id":339,"depth":395,"text":340},{"title":416,"date":417,"path":418,"tags":419,"body":421},"I Canâ€™t Access dl.google.com â€” A Network Debugging Story Under TUN","2026-01-31","/2026/01/31/mihomo-tun-fail-to-visit-dl-google-com",[11,420],"DNS",{"type":14,"value":422,"toc":874},[423,448,457,463,469,475,485,489,498,504,507,517,520,524,538,544,551,557,573,584,592,596,599,625,636,642,649,652,656,659,675,681,684,692,696,703,717,720,743,746,752,759,767,771,778,786,800,851,860,862,871],[17,424,425,426,429,430,433,434,437,438,440,445,446,433],{},"If youâ€™re familiar enough with the current network environment in mainland China, you probably know that ",[55,427,428],{},"dl.google.com"," is ",[118,431,432],{},"often directly accessible without a proxy",".",[435,436],"br",{},"\nFor example, you can download the Chrome offline installer directly from",[435,439],{},[201,441,444],{"href":442,"rel":443},"https://google.cn/chrome/?standalone=1",[205],"google.cn/chrome/?standalone=1"," on a domestic network, and the final download domain is ",[55,447,428],{},[17,449,450,451,454,455,433],{},"My usual setup is to keep my proxy toolâ€™s TUN mode enabled 24/7. All traffic goes through a virtual network interface first, and then routing rules decide automatically whether it should go through the proxy or connect directly. Most of the time this setup is pretty hassle-free â€” until recently, when I was rolling updates on Arch Linux with ",[55,452,453],{},"yay"," and suddenly ran into an SSL connection failure with ",[55,456,428],{},[17,458,459],{},[62,460],{"alt":461,"src":462},"yay update failed","https://static.031130.xyz/uploads/2026/01/31/df5e547511070.webp",[17,464,465,466,468],{},"It wasnâ€™t just ",[55,467,453],{},". My browser showed the exact same result:",[17,470,471],{},[62,472],{"alt":473,"src":474},"Firefox access failed","https://static.031130.xyz/uploads/2026/01/31/8ada158510aba.webp",[17,476,477,478,482,484],{},"My first instinct was: ",[479,480,481],"em",{},"did my routing rules break again?",[435,483],{},"\n(Theyâ€™re not written by me, so blaming them first is perfectly reasonable.)",[27,486,488],{"id":487},"the-rule-is-direct-no-one-else-to-blame","The Rule Is DIRECT â€” No One Else to Blame",[17,490,491,492,494,495,433],{},"I double-checked the routing rules. Traffic with SNI ",[55,493,428],{}," was explicitly configured as ",[118,496,497],{},"DIRECT",[17,499,500],{},[62,501],{"alt":502,"src":503},"Mihomo routing rules","https://static.031130.xyz/uploads/2026/01/31/96d27a20f2bf3.webp",[17,505,506],{},"That made things strange. Logically:",[32,508,509,514],{},[35,510,511,513],{},[55,512,428],{}," itself is often directly reachable from domestic networks",[35,515,516],{},"The rule clearly says DIRECT",[17,518,519],{},"To be honest, Iâ€™d seen this issue before. Back then I had higher-priority tasks, so I just turned off the proxy tool, finished the update, and moved on. This time, though, I had nothing urgent on my plate â€” so I decided to finally dig into it properly.",[27,521,523],{"id":522},"it-resolved-to-an-overseas-ip","It Resolved to an Overseas IP",[17,525,526,527,530,531,534,535,537],{},"First, I disabled the proxy toolâ€™s ",[55,528,529],{},"fake-ip"," mode and switched back to real IP resolution to avoid introducing extra variables. Then I used ",[55,532,533],{},"curl -vv"," to access a ",[55,536,428],{}," download URL and see where it was actually trying to connect.",[17,539,540],{},[62,541],{"alt":542,"src":543},"curl -vv output","https://static.031130.xyz/uploads/2026/01/31/d3dbfc513de9f.webp",[17,545,546,547,550],{},"Looking back now, I can say with confidence: the resolved IP belonged to Googleâ€™s ",[118,548,549],{},"overseas CDN",", not a domestic or domestically reachable data center.",[17,552,553],{},[62,554],{"alt":555,"src":556},"IP geolocation","https://static.031130.xyz/uploads/2026/01/31/7ba8a0b8a2579.webp",[17,558,559,560,562,563,566,567,569,570,572],{},"For those unfamiliar: when resolving ",[55,561,428],{}," for users in mainland China, DNS often returns ",[118,564,565],{},"domestically reachable IPs"," (otherwise direct downloads wouldnâ€™t work at all).",[435,568],{},"\nThe overseas IP returned here was unreachable on my connection. Combined with the fact that I had configured ",[55,571,428],{}," as DIRECT, the result was:",[574,575,576,579],"blockquote",{},[17,577,578],{},"DNS returned an â€œoverseas IPâ€",[32,580,581],{},[35,582,583],{},"Rules enforced DIRECT\n= Direct connection to an unreachable destination\n= TLS handshake failure",[17,585,586,587,589],{},"So this wasnâ€™t a case of â€œthe direct rule didnâ€™t workâ€. It was more like:",[435,588],{},[118,590,591],{},"the rule worked perfectly, but DNS led me straight into a ditch.",[27,593,595],{"id":594},"who-is-answering-for-dlgooglecom","Who Is Answering for dl.google.com?",[17,597,598],{},"In the Mihomo core, the main DNS-related configuration options are:",[310,600,601,607,613,619],{},[35,602,603,606],{},[55,604,605],{},"nameserver",": default resolvers (most domains use these)",[35,608,609,612],{},[55,610,611],{},"direct-nameserver",": resolvers for DIRECT domains (only available in newer versions)",[35,614,615,618],{},[55,616,617],{},"proxy-server-nameserver",": resolvers for proxy node hostnames (irrelevant here)",[35,620,621,624],{},[55,622,623],{},"default-nameserver",": used to resolve â€œdomain-formâ€ nameservers in the DNS config itself (not expanded here)",[17,626,627,628,630,631,633,634,433],{},"Since ",[55,629,428],{}," was marked as a DIRECT domain, Mihomo should theoretically prefer ",[55,632,611],{},". If that isnâ€™t set, it falls back to ",[55,635,605],{},[17,637,638,639,641],{},"At the time, my ",[55,640,605],{}," configuration was:",[32,643,644],{},[35,645,646],{},[55,647,648],{},"https://dns.alidns.com/dns-query",[17,650,651],{},"My intuition was simple: if the resolution looked like it came from an overseas CDN pool, I should verify whether AliDNS (DoH) itself was returning that overseas IP.",[27,653,655],{"id":654},"querying-alidns-doh-directly-overseas-pool-confirmed","Querying AliDNS DoH Directly â€” Overseas Pool Confirmed",[17,657,658],{},"AliDNS provides a JSON-based query interface, so I tested it directly with curl:",[125,660,662],{"className":127,"code":661,"language":129,"meta":130,"style":130},"curl -s 'https://dns.alidns.com/resolve?name=dl.google.com&type=A'\n",[55,663,664],{"__ignoreMap":130},[134,665,666,669,672],{"class":136,"line":137},[134,667,668],{"class":140},"curl",[134,670,671],{"class":154}," -s",[134,673,674],{"class":144}," 'https://dns.alidns.com/resolve?name=dl.google.com&type=A'\n",[17,676,677],{},[62,678],{"alt":679,"src":680},"DoH response","https://static.031130.xyz/uploads/2026/01/31/b457af9299330.webp",[17,682,683],{},"The returned IP was exactly the overseas one Iâ€™d seen earlier. At this point, I could confidently conclude:",[17,685,686],{},[118,687,688,689,691],{},"At least on my current network exit, AliDNS resolves ",[55,690,428],{}," to an overseas IP that is unreachable for me.",[100,693,695],{"id":694},"this-requires-two-conditions-both-are-necessary","This Requires Two Conditions (Both Are Necessary)",[17,697,698,699,702],{},"Itâ€™s important to emphasize something here: this is ",[479,700,701],{},"not"," simply â€œAliDNS always resolves it wrongâ€. After running a bunch of comparisons, I found the conditions to be surprisingly strict:",[574,704,705],{},[17,706,707,714,716],{},[118,708,709,710,713],{},"The issue reliably reproduces only when ",[479,711,712],{},"both"," â€œChina Mobile broadbandâ€ and â€œAliDNS (including 223.5.5.5 or AliDNS DoH)â€ are used together.",[435,715],{},"\nRemove either condition, and the problem usually disappears.",[17,718,719],{},"More specifically:",[32,721,722,731,737],{},[35,723,724,727,728,730],{},[118,725,726],{},"Switch to China Telecom or China Unicom broadband",": with the same AliDNS, ",[55,729,428],{}," usually resolves correctly",[35,732,733,736],{},[118,734,735],{},"Stay on China Mobile broadband, but donâ€™t use AliDNS",": resolution is usually fine",[35,738,739,742],{},[118,740,741],{},"China Mobile broadband + AliDNS",": high probability of getting an overseas IP pool, and DIRECT connections fail",[17,744,745],{},"I also ran nationwide resolution tests on itdog, and the reproduction rate was indeed much higher on China Mobile networks.",[17,747,748],{},[62,749],{"alt":750,"src":751},"itdog test results","https://static.031130.xyz/uploads/2026/01/31/d93222096f005.webp",[17,753,754,755,758],{},"Why does this happen? Honestly, I canâ€™t provide a single authoritative explanation. What I ",[479,756,757],{},"can"," say is that the behavior is extremely consistent, and consistent enough for me to conclude:",[17,760,761],{},[118,762,763,764,766],{},"The problem isnâ€™t TUN itself â€” itâ€™s that, under TUN, my DNS choice sent ",[55,765,428],{}," to an address pool thatâ€™s unreachable on China Mobile.",[27,768,770],{"id":769},"how-did-i-finally-fix-it","How Did I Finally Fix It?",[17,772,773,774,777],{},"Since the issue was the combination of ",[118,775,776],{},"China Mobile + AliDNS",", the solution was straightforward:",[17,779,780],{},[118,781,782,783,785],{},"Stop letting ",[55,784,428],{}," be resolved by AliDNS.",[17,787,788,789,791,792,795,796,799],{},"You can do this by configuring ",[55,790,611],{},", using ",[55,793,794],{},"nameserver-policy",", switching to another public DNS like ",[55,797,798],{},"119.29.29.29",", or even delegating DNS resolution to your home router.",[125,801,805],{"className":802,"code":803,"language":804,"meta":130,"style":130},"language-yaml shiki shiki-themes one-light one-dark-pro","direct-nameserver:\n  - 192.168.8.1\n\nnameserver-policy:\n  \"dl.google.com\": [119.29.29.29]\n","yaml",[55,806,807,816,824,830,837],{"__ignoreMap":130},[134,808,809,812],{"class":136,"line":137},[134,810,611],{"class":811},"sJa8x",[134,813,815],{"class":814},"s5ixo",":\n",[134,817,818,821],{"class":136,"line":395},[134,819,820],{"class":814},"  - ",[134,822,823],{"class":154},"192.168.8.1\n",[134,825,826],{"class":136,"line":403},[134,827,829],{"emptyLinePlaceholder":828},true,"\n",[134,831,833,835],{"class":136,"line":832},4,[134,834,794],{"class":811},[134,836,815],{"class":814},[134,838,840,843,846,848],{"class":136,"line":839},5,[134,841,842],{"class":144},"  \"dl.google.com\"",[134,844,845],{"class":814},": [",[134,847,798],{"class":154},[134,849,850],{"class":814},"]\n",[17,852,853,854,856,857,859],{},"After this change, ",[55,855,453],{}," updates worked normally again, and browsers could directly access ",[55,858,428],{}," without issues.",[27,861,340],{"id":339},[32,863,864],{},[35,865,866],{},[201,867,870],{"href":868,"rel":869},"https://linux.do/t/topic/1061825",[205],"Minimal antiâ€“DNS-leak configuration for the mihomo core (2025) â€“ Development & Tuning â€“ LINUX DO",[391,872,873],{},"html pre.shiki code .sAdtL, html code.shiki .sAdtL{--shiki-default:#4078F2;--shiki-dark:#61AFEF}html pre.shiki code .sAGMh, html code.shiki .sAGMh{--shiki-default:#986801;--shiki-dark:#D19A66}html pre.shiki code .sDhpE, html code.shiki .sDhpE{--shiki-default:#50A14F;--shiki-dark:#98C379}html .default .shiki span {color: var(--shiki-default);background: var(--shiki-default-bg);font-style: var(--shiki-default-font-style);font-weight: var(--shiki-default-font-weight);text-decoration: var(--shiki-default-text-decoration);}html .shiki span {color: var(--shiki-default);background: var(--shiki-default-bg);font-style: var(--shiki-default-font-style);font-weight: var(--shiki-default-font-weight);text-decoration: var(--shiki-default-text-decoration);}html .dark .shiki span {color: var(--shiki-dark);background: var(--shiki-dark-bg);font-style: var(--shiki-dark-font-style);font-weight: var(--shiki-dark-font-weight);text-decoration: var(--shiki-dark-text-decoration);}html.dark .shiki span {color: var(--shiki-dark);background: var(--shiki-dark-bg);font-style: var(--shiki-dark-font-style);font-weight: var(--shiki-dark-font-weight);text-decoration: var(--shiki-dark-text-decoration);}html pre.shiki code .sJa8x, html code.shiki .sJa8x{--shiki-default:#E45649;--shiki-dark:#E06C75}html pre.shiki code .s5ixo, html code.shiki .s5ixo{--shiki-default:#383A42;--shiki-dark:#ABB2BF}",{"title":130,"searchDepth":395,"depth":395,"links":875},[876,877,878,879,882,883],{"id":487,"depth":395,"text":488},{"id":522,"depth":395,"text":523},{"id":594,"depth":395,"text":595},{"id":654,"depth":395,"text":655,"children":880},[881],{"id":694,"depth":403,"text":695},{"id":769,"depth":395,"text":770},{"id":339,"depth":395,"text":340},{"title":885,"date":886,"path":887,"tags":888,"body":891},"Have You Noticed Vercel's Cache Control?","2025-12-23","/2025/12/23/vercel-cache-control",[889,11,890],"Vercel","HTTP",{"type":14,"value":892,"toc":1378},[893,896,900,906,912,916,920,929,943,953,959,962,966,974,977,983,988,991,994,998,1001,1009,1012,1032,1038,1041,1044,1094,1098,1101,1108,1111,1119,1125,1300,1311,1314,1340,1343,1347,1350,1352,1375],[17,894,895],{},"Vercel's default cache configuration is actually not very reasonable, but few people notice it.",[27,897,899],{"id":898},"first-lets-look-at-the-results","First, Let's Look at the Results",[17,901,902],{},[62,903],{"alt":904,"src":905},"Figure 1","https://static.031130.xyz/uploads/2025/12/23/577e579eceb96.webp",[17,907,908],{},[62,909],{"alt":910,"src":911},"Figure 2","https://static.031130.xyz/uploads/2025/12/23/0cfc9543c857a.webp",[27,913,915],{"id":914},"analysis","Analysis",[100,917,919],{"id":918},"testing-approach","Testing Approach",[17,921,922,923,928],{},"Both images show test results from my blog on ",[201,924,927],{"href":925,"rel":926},"https://pagespeed.web.dev/",[205],"PageSpeed Insights",". The testing steps were:",[310,930,931,934,937,940],{},[35,932,933],{},"Deploy",[35,935,936],{},"Run the first test on PageSpeed Insights",[35,938,939],{},"Wait 120 seconds to prevent PageSpeed Insights from using cached results",[35,941,942],{},"Run the second test and use those results",[17,944,945,948,949,952],{},[118,946,947],{},"The purpose of using the second test results"," is to ensure that the Vercel CDN node accessed by PageSpeed Insights has completed fetching from origin and ",[118,950,951],{},"cached the content on the CDN node",". This way, the second access retrieves results directly from the CDN cache without needing to fetch from origin.",[17,954,955,956],{},"Looking at the test results in Figure 1, does it seem normal? The loading time for a single HTML page reached ",[118,957,958],{},"450ms. While this doesn't look terribly slow, there's actually a problem when you examine it closely.",[17,960,961],{},"Vercel uses Amazon's global CDN network. After our first visit, the CDN node should have already cached the homepage content, so the second visit should retrieve content directly from the CDN node's cache.",[100,963,965],{"id":964},"what-would-be-a-reasonable-duration","What Would Be a Reasonable Duration?",[32,967,968,971],{},[35,969,970],{},"TCP connection establishment requires 1.5 round-trip times (RTT) for the three-way handshake, plus 1 RTT for TLS 1.3 handshake, totaling 2.5 RTT.",[35,972,973],{},"The HTML file size is 18KB. The initial congestion window (IW) of 10 MSS â‰ˆ 1460 bytes â‰ˆ 14.6KB means it should theoretically be transmitted within two RTTs.",[17,975,976],{},"Total: 4.5 RTT.",[17,978,979,980],{},"PageSpeed Insights likely uses a node in the United States for testing. Amazon CDN has extensive coverage in the US, so keeping a single RTT under 5ms is more than adequate. Therefore, the theoretical loading time should be around 22.5ms. Adding DNS resolution time (which shouldn't be much since there was an access two minutes prior, so this isn't a cold start) and some uncontrollable network jitter, ",[118,981,982],{},"it should be completely fine to stay within 50ms.",[17,984,985],{},[118,986,987],{},"But the actual measured time was 450ms, nearly 9 times higherâ€”this is very unreasonable.",[17,989,990],{},"Now let's look at Figure 2's results. The single HTML loading time dropped to 41ms, which completely meets expectations.",[17,992,993],{},"Why is there such a huge difference? The reason lies in Vercel's cache control settings.",[27,995,997],{"id":996},"vercels-cache-control","Vercel's Cache Control",[17,999,1000],{},"For websites deployed on Vercel, by default, Vercel sets the following cache control header for HTML files:",[125,1002,1007],{"className":1003,"code":1005,"language":1006},[1004],"language-text","cache-control: public, max-age=0, must-revalidate\n","text",[55,1008,1005],{"__ignoreMap":130},[17,1010,1011],{},"This setting means:",[32,1013,1014,1020,1026],{},[35,1015,1016,1019],{},[55,1017,1018],{},"public",": The response can be cached by any cache, including browsers and CDNs.",[35,1021,1022,1025],{},[55,1023,1024],{},"max-age=0",": The maximum cache time for the response is 0 seconds, meaning the response expires immediately after being cached.",[35,1027,1028,1031],{},[55,1029,1030],{},"must-revalidate",": Once the response expires, the cache must validate its validity with the origin server.",[17,1033,1034,1035,1037],{},"Combined, these three directives mean Vercel is essentially telling CDN nodes: you can cache this HTML file, but you must validate its validity with the origin server before using the cache each time. Since ",[55,1036,1024],{},", the cache expires immediately upon storage, so every request triggers origin validation.",[17,1039,1040],{},"Although cache validation in HTTP/1.1 and HTTP/2 typically uses conditional requests (such as the file's ETag or Last-Modified headers) to save transmission bandwidth, this still requires round-trip communication with the origin server, adding extra latency overhead.",[17,1042,1043],{},"Therefore, under Vercel's default configuration, responses to any request won't be directly cached by CDN nodes. The general flow is as follows:",[125,1045,1049],{"className":1046,"code":1047,"language":1048,"meta":130,"style":130},"language-mermaid shiki shiki-themes one-light one-dark-pro","sequenceDiagram\n    participant Client\n    participant CDN\n    participant Vercel\n    Client->>CDN: Request HTML file\n    CDN->>Vercel: Conditional request to validate cache\n    Vercel->>CDN: Return latest HTML file or 304 Not Modified\n    CDN->>Client: Return HTML file\n","mermaid",[55,1050,1051,1056,1061,1066,1071,1076,1082,1088],{"__ignoreMap":130},[134,1052,1053],{"class":136,"line":137},[134,1054,1055],{},"sequenceDiagram\n",[134,1057,1058],{"class":136,"line":395},[134,1059,1060],{},"    participant Client\n",[134,1062,1063],{"class":136,"line":403},[134,1064,1065],{},"    participant CDN\n",[134,1067,1068],{"class":136,"line":832},[134,1069,1070],{},"    participant Vercel\n",[134,1072,1073],{"class":136,"line":839},[134,1074,1075],{},"    Client->>CDN: Request HTML file\n",[134,1077,1079],{"class":136,"line":1078},6,[134,1080,1081],{},"    CDN->>Vercel: Conditional request to validate cache\n",[134,1083,1085],{"class":136,"line":1084},7,[134,1086,1087],{},"    Vercel->>CDN: Return latest HTML file or 304 Not Modified\n",[134,1089,1091],{"class":136,"line":1090},8,[134,1092,1093],{},"    CDN->>Client: Return HTML file\n",[27,1095,1097],{"id":1096},"solution","Solution",[17,1099,1100],{},"To solve this problem, we need to adjust Vercel's cache control settings so that HTML files can be cached by CDN nodes for a period of time without needing origin validation every time.",[17,1102,1103,1104,1107],{},"Vercel allows us to create a ",[55,1105,1106],{},"vercel.json"," file in the project's root directory to configure various aspects of Vercel's deployment behavior, including HTTP response header configuration.",[17,1109,1110],{},"My blog is built with the Nuxt.js framework, and the generated build artifacts roughly fall into two categories:",[310,1112,1113,1116],{},[35,1114,1115],{},"HTML files: These files' content may change frequently and shouldn't have excessively long cache times;",[35,1117,1118],{},"Static resource files: Including JavaScript, CSS, etc. These files typically have hash values in their filenames and can have longer cache times or even be marked as immutable.",[17,1120,1121,1122,1124],{},"In terms of deployment workflow, my blog is first built into static pages in GitHub Actions after each push, then deployed to Vercel. So I created a ",[55,1123,1106],{}," file in my project's public directory (this way the vercel.json file will be in the root of the build artifacts) with the following content:",[125,1126,1130],{"className":1127,"code":1128,"language":1129,"meta":130,"style":130},"language-json shiki shiki-themes one-light one-dark-pro","{\n  \"headers\": [\n    {\n      \"source\": \"/(.*)\",\n      \"headers\": [\n        {\n          \"key\": \"Cache-Control\",\n          \"value\": \"public, max-age=0, s-maxage=600, must-revalidate\"\n        }\n      ]\n    },\n    {\n      \"source\": \"/(.*)\\\\.(css|js)\",\n      \"headers\": [\n        {\n          \"key\": \"Cache-Control\",\n          \"value\": \"public, max-age=31536000, immutable\"\n        }\n      ]\n    }\n  ]\n}\n","json",[55,1131,1132,1137,1145,1150,1164,1171,1176,1188,1198,1203,1209,1215,1220,1239,1246,1251,1262,1272,1277,1282,1288,1294],{"__ignoreMap":130},[134,1133,1134],{"class":136,"line":137},[134,1135,1136],{"class":814},"{\n",[134,1138,1139,1142],{"class":136,"line":395},[134,1140,1141],{"class":811},"  \"headers\"",[134,1143,1144],{"class":814},": [\n",[134,1146,1147],{"class":136,"line":403},[134,1148,1149],{"class":814},"    {\n",[134,1151,1152,1155,1158,1161],{"class":136,"line":832},[134,1153,1154],{"class":811},"      \"source\"",[134,1156,1157],{"class":814},": ",[134,1159,1160],{"class":144},"\"/(.*)\"",[134,1162,1163],{"class":814},",\n",[134,1165,1166,1169],{"class":136,"line":839},[134,1167,1168],{"class":811},"      \"headers\"",[134,1170,1144],{"class":814},[134,1172,1173],{"class":136,"line":1078},[134,1174,1175],{"class":814},"        {\n",[134,1177,1178,1181,1183,1186],{"class":136,"line":1084},[134,1179,1180],{"class":811},"          \"key\"",[134,1182,1157],{"class":814},[134,1184,1185],{"class":144},"\"Cache-Control\"",[134,1187,1163],{"class":814},[134,1189,1190,1193,1195],{"class":136,"line":1090},[134,1191,1192],{"class":811},"          \"value\"",[134,1194,1157],{"class":814},[134,1196,1197],{"class":144},"\"public, max-age=0, s-maxage=600, must-revalidate\"\n",[134,1199,1200],{"class":136,"line":3},[134,1201,1202],{"class":814},"        }\n",[134,1204,1206],{"class":136,"line":1205},10,[134,1207,1208],{"class":814},"      ]\n",[134,1210,1212],{"class":136,"line":1211},11,[134,1213,1214],{"class":814},"    },\n",[134,1216,1218],{"class":136,"line":1217},12,[134,1219,1149],{"class":814},[134,1221,1223,1225,1227,1230,1234,1237],{"class":136,"line":1222},13,[134,1224,1154],{"class":811},[134,1226,1157],{"class":814},[134,1228,1229],{"class":144},"\"/(.*)",[134,1231,1233],{"class":1232},"s_Sar","\\\\",[134,1235,1236],{"class":144},".(css|js)\"",[134,1238,1163],{"class":814},[134,1240,1242,1244],{"class":136,"line":1241},14,[134,1243,1168],{"class":811},[134,1245,1144],{"class":814},[134,1247,1249],{"class":136,"line":1248},15,[134,1250,1175],{"class":814},[134,1252,1254,1256,1258,1260],{"class":136,"line":1253},16,[134,1255,1180],{"class":811},[134,1257,1157],{"class":814},[134,1259,1185],{"class":144},[134,1261,1163],{"class":814},[134,1263,1265,1267,1269],{"class":136,"line":1264},17,[134,1266,1192],{"class":811},[134,1268,1157],{"class":814},[134,1270,1271],{"class":144},"\"public, max-age=31536000, immutable\"\n",[134,1273,1275],{"class":136,"line":1274},18,[134,1276,1202],{"class":814},[134,1278,1280],{"class":136,"line":1279},19,[134,1281,1208],{"class":814},[134,1283,1285],{"class":136,"line":1284},20,[134,1286,1287],{"class":814},"    }\n",[134,1289,1291],{"class":136,"line":1290},21,[134,1292,1293],{"class":814},"  ]\n",[134,1295,1297],{"class":136,"line":1296},22,[134,1298,1299],{"class":814},"}\n",[17,1301,1302,1303,1306,1307,1310],{},"Here I set ",[55,1304,1305],{},"max-age=31536000, immutable"," for all CSS and JS files, so these static resource files can be cached long-term by browsers and CDNs. For all other files (mainly HTML files), I set ",[55,1308,1309],{},"max-age=0, s-maxage=600, must-revalidate",", so HTML files can be cached by the CDN for 10 minutes. Requests within these 10 minutes can retrieve content directly from the CDN node's cache without needing origin validation.",[17,1312,1313],{},"With this modified cache control setting, the request flow for HTML files becomes:",[125,1315,1317],{"className":1046,"code":1316,"language":1048,"meta":130,"style":130},"sequenceDiagram\n    participant Client\n    participant CDN\n    Client->>CDN: Request HTML file\n    CDN->>Client: Directly return cached HTML file\n",[55,1318,1319,1323,1327,1331,1335],{"__ignoreMap":130},[134,1320,1321],{"class":136,"line":137},[134,1322,1055],{},[134,1324,1325],{"class":136,"line":395},[134,1326,1060],{},[134,1328,1329],{"class":136,"line":403},[134,1330,1065],{},[134,1332,1333],{"class":136,"line":832},[134,1334,1075],{},[134,1336,1337],{"class":136,"line":839},[134,1338,1339],{},"    CDN->>Client: Directly return cached HTML file\n",[17,1341,1342],{},"This greatly reduces request latency and improves page loading speed.",[27,1344,1346],{"id":1345},"other-considerations","Other Considerations",[17,1348,1349],{},"Vercel's architecture isn't the traditional \"origin server - CDN\" architecture, but rather closer to a \"global multi-region storage + CDN edge cache\" architecture. So even for origin requests, Vercel will try to retrieve content from the storage node closest to the user to reduce latency. However, this doesn't mean origin request latency can be ignored, especially when pursuing optimal loading speedâ€”proper cache control remains very important.",[27,1351,340],{"id":339},[32,1353,1354,1361,1368],{},[35,1355,1356],{},[201,1357,1360],{"href":1358,"rel":1359},"https://vercel.com/docs/headers/cache-control-headers",[205],"Cache-Control headers | Vercel",[35,1362,1363],{},[201,1364,1367],{"href":1365,"rel":1366},"https://vercel.com/docs/cdn-cache",[205],"Vercel CDN Cache | Vercel",[35,1369,1370],{},[201,1371,1374],{"href":1372,"rel":1373},"https://developer.mozilla.org/en-US/docs/Web/HTTP/Guides/Caching",[205],"HTTP caching - HTTP | MDN",[391,1376,1377],{},"html .default .shiki span {color: var(--shiki-default);background: var(--shiki-default-bg);font-style: var(--shiki-default-font-style);font-weight: var(--shiki-default-font-weight);text-decoration: var(--shiki-default-text-decoration);}html .shiki span {color: var(--shiki-default);background: var(--shiki-default-bg);font-style: var(--shiki-default-font-style);font-weight: var(--shiki-default-font-weight);text-decoration: var(--shiki-default-text-decoration);}html .dark .shiki span {color: var(--shiki-dark);background: var(--shiki-dark-bg);font-style: var(--shiki-dark-font-style);font-weight: var(--shiki-dark-font-weight);text-decoration: var(--shiki-dark-text-decoration);}html.dark .shiki span {color: var(--shiki-dark);background: var(--shiki-dark-bg);font-style: var(--shiki-dark-font-style);font-weight: var(--shiki-dark-font-weight);text-decoration: var(--shiki-dark-text-decoration);}html pre.shiki code .s5ixo, html code.shiki .s5ixo{--shiki-default:#383A42;--shiki-dark:#ABB2BF}html pre.shiki code .sJa8x, html code.shiki .sJa8x{--shiki-default:#E45649;--shiki-dark:#E06C75}html pre.shiki code .sDhpE, html code.shiki .sDhpE{--shiki-default:#50A14F;--shiki-dark:#98C379}html pre.shiki code .s_Sar, html code.shiki .s_Sar{--shiki-default:#0184BC;--shiki-dark:#56B6C2}",{"title":130,"searchDepth":395,"depth":395,"links":1379},[1380,1381,1385,1386,1387,1388],{"id":898,"depth":395,"text":899},{"id":914,"depth":395,"text":915,"children":1382},[1383,1384],{"id":918,"depth":403,"text":919},{"id":964,"depth":403,"text":965},{"id":996,"depth":395,"text":997},{"id":1096,"depth":395,"text":1097},{"id":1345,"depth":395,"text":1346},{"id":339,"depth":395,"text":340},{"title":1390,"date":1391,"path":1392,"tags":1393,"body":1395},"Layer 4 Traffic Proxying with Caddy: A Practical Guide","2025-12-10","/2025/12/10/caddy-traffic-proxy-on-layer-4",[1394,11],"Caddy",{"type":14,"value":1396,"toc":1619},[1397,1401,1404,1412,1415,1419,1431,1440,1444,1453,1456,1469,1472,1481,1500,1504,1507,1513,1522,1525,1531,1534,1540,1559,1566,1575,1578,1597,1601,1616],[27,1398,1400],{"id":1399},"background","Background",[17,1402,1403],{},"On one of my VPS servers with optimized routing, port 443 needs to serve two distinct purposes:",[310,1405,1406,1409],{},[35,1407,1408],{},"Hosting my blog for visitors from mainland China, handling HTTPS encryption/decryption and serving static content",[35,1410,1411],{},"Disguising certain special-purpose traffic to mimic HTTPS traffic from well-known, commonly-allowed websites (yes, I'm talking about Reality)",[17,1413,1414],{},"This meant I needed a solution to handle both roles simultaneously on the same port of the same server.",[27,1416,1418],{"id":1417},"choosing-the-solution","Choosing the Solution",[17,1420,1421,1422,1425,1426,1430],{},"I've long been aware that Nginx's ",[55,1423,1424],{},"stream"," directive can achieve Layer 4 (raw TCP stream forwarding) traffic splitting based on SNI recognition. However, as a devoted Caddy user who has written numerous ",[201,1427,1429],{"href":1428},"/en/tags/Caddy/","Caddy-related posts",", I still prefer Caddy despite Nginx's recent ACME v2 support. The simplicity and usability of Caddyfile keep me coming back.",[17,1432,1433,1434,1439],{},"After some research, I discovered that while the latest Caddy version (v2.10) doesn't natively support Layer 4 traffic proxying, there's a community module called ",[201,1435,1438],{"href":1436,"rel":1437},"https://github.com/mholt/caddy-l4",[205],"caddy-l4"," that provides exactly this functionality. With 1.5k stars on GitHub and active maintenance, it seemed worth trying.",[27,1441,1443],{"id":1442},"installation","Installation",[17,1445,1446,1447,1452],{},"Although the official Caddy APT repository doesn't include the caddy-l4 module, I recommend first installing the base Caddy version through APT, then using Caddy's official ",[201,1448,1451],{"href":1449,"rel":1450},"https://caddyserver.com/download",[205],"download page"," to build a custom binary with the modules you need. Download it and replace the system Caddy executable. This approach makes systemd service configuration much easier. Just remember to disable the Caddy APT repository to prevent automatic updates from overwriting your custom build.",[17,1454,1455],{},"For future updates, you can simply run:",[125,1457,1459],{"className":127,"code":1458,"language":129,"meta":130,"style":130},"caddy upgrade\n",[55,1460,1461],{"__ignoreMap":130},[134,1462,1463,1466],{"class":136,"line":137},[134,1464,1465],{"class":140},"caddy",[134,1467,1468],{"class":144}," upgrade\n",[17,1470,1471],{},"Caddy will automatically detect the modules included in your current binary, trigger an online build from the official website to generate a new binary with those modules, and perform the replacement. You just need to manually restart the systemd service to complete the update.",[17,1473,1474,1475,1480],{},"If Caddy's online build service fails (it's been somewhat unstable lately), you can ",[201,1476,1479],{"href":1477,"rel":1478},"https://caddyserver.com/docs/build#xcaddy",[205],"follow the documentation"," to compile Caddy locally using xcaddy:",[125,1482,1484],{"className":127,"code":1483,"language":129,"meta":130,"style":130},"xcaddy build --with github.com/mholt/caddy-l4\n",[55,1485,1486],{"__ignoreMap":130},[134,1487,1488,1491,1494,1497],{"class":136,"line":137},[134,1489,1490],{"class":140},"xcaddy",[134,1492,1493],{"class":144}," build",[134,1495,1496],{"class":154}," --with",[134,1498,1499],{"class":144}," github.com/mholt/caddy-l4\n",[27,1501,1503],{"id":1502},"configuration","Configuration",[17,1505,1506],{},"Here's my original Caddyfile configuration for the blog:",[125,1508,1511],{"className":1509,"code":1510,"language":1006},[1004],"zhul.in {\n    root * /var/www/zhul.in\n\n    encode zstd gzip\n    file_server\n\n    handle_errors {\n            rewrite * /404.html\n            file_server\n    }\n}\n\nwww.zhul.in {\n    redir https://zhul.in{uri}\n}\n",[55,1512,1510],{"__ignoreMap":130},[17,1514,1515,1516,1521],{},"Since both zhul.in and ",[201,1517,1520],{"href":1518,"rel":1519},"http://www.zhul.in",[205],"www.zhul.in"," were using ports 80 and 443, I needed to move the HTTPS listeners to a different port and let caddy-l4 handle port 443.",[17,1523,1524],{},"Here's the modified Caddyfile:",[125,1526,1529],{"className":1527,"code":1528,"language":1006},[1004],"http://zhul.in:80, https://zhul.in:8443 {\n    root * /var/www/zhul.in\n\n    encode zstd gzip\n    file_server\n\n    handle_errors {\n            rewrite * /404.html\n            file_server\n    }\n}\n\nhttp://www.zhul.in:80, https://www.zhul.in:8443 {\n    redir https://zhul.in{uri}\n}\n",[55,1530,1528],{"__ignoreMap":130},[17,1532,1533],{},"Next, I added the caddy-l4 configuration:",[125,1535,1538],{"className":1536,"code":1537,"language":1006},[1004],"{\n    layer4 {\n        :443 {\n            @zhulin tls sni zhul.in www.zhul.in\n            route @zhulin {\n                proxy 127.0.0.1:8443\n            }\n\n            @proxy tls sni osxapps.itunes.apple.com\n            route @proxy {\n                proxy 127.0.0.1:20443\n            }\n        }\n    }\n}\n",[55,1539,1537],{"__ignoreMap":130},[17,1541,1542,1543,1546,1547,1550,1551,1554,1555,1558],{},"The syntax is quite straightforward. First, listen on port 443 within the ",[55,1544,1545],{},"layer4"," block. Then define SNI-based matching rules using ",[55,1548,1549],{},"@name tls sni domain",". Finally, use ",[55,1552,1553],{},"route @name"," to specify how to handle traffic matching each ruleâ€”here I'm using ",[55,1556,1557],{},"proxy ip:port"," to forward the traffic.",[17,1560,1561,1562,1565],{},"Since my special traffic masquerades as Apple iTunes traffic, the SNI signature in the configuration is ",[55,1563,1564],{},"osxapps.itunes.apple.com",". This traffic gets forwarded to local port 20443, where another service handles it.",[17,1567,1568,1569,1574],{},"caddy-l4 offers various other matching methods and routing handlers. Check out their ",[201,1570,1573],{"href":1571,"rel":1572},"https://github.com/mholt/caddy-l4/tree/master/docs/examples",[205],"examples on GitHub"," for more details.",[17,1576,1577],{},"Once configured, restart the Caddy service:",[125,1579,1581],{"className":127,"code":1580,"language":129,"meta":130,"style":130},"sudo systemctl restart caddy\n",[55,1582,1583],{"__ignoreMap":130},[134,1584,1585,1588,1591,1594],{"class":136,"line":137},[134,1586,1587],{"class":140},"sudo",[134,1589,1590],{"class":144}," systemctl",[134,1592,1593],{"class":144}," restart",[134,1595,1596],{"class":144}," caddy\n",[27,1598,1600],{"id":1599},"see-also","See Also",[32,1602,1603,1609],{},[35,1604,1605],{},[201,1606,1608],{"href":1436,"rel":1607},[205],"mholt/caddy-l4: Layer 4 (TCP/UDP) app for Caddy",[35,1610,1611],{},[201,1612,1615],{"href":1613,"rel":1614},"https://caddyserver.com/docs/build",[205],"Build from source â€” Caddy Documentation",[391,1617,1618],{},"html pre.shiki code .sAdtL, html code.shiki .sAdtL{--shiki-default:#4078F2;--shiki-dark:#61AFEF}html pre.shiki code .sDhpE, html code.shiki .sDhpE{--shiki-default:#50A14F;--shiki-dark:#98C379}html .default .shiki span {color: var(--shiki-default);background: var(--shiki-default-bg);font-style: var(--shiki-default-font-style);font-weight: var(--shiki-default-font-weight);text-decoration: var(--shiki-default-text-decoration);}html .shiki span {color: var(--shiki-default);background: var(--shiki-default-bg);font-style: var(--shiki-default-font-style);font-weight: var(--shiki-default-font-weight);text-decoration: var(--shiki-default-text-decoration);}html .dark .shiki span {color: var(--shiki-dark);background: var(--shiki-dark-bg);font-style: var(--shiki-dark-font-style);font-weight: var(--shiki-dark-font-weight);text-decoration: var(--shiki-dark-text-decoration);}html.dark .shiki span {color: var(--shiki-dark);background: var(--shiki-dark-bg);font-style: var(--shiki-dark-font-style);font-weight: var(--shiki-dark-font-weight);text-decoration: var(--shiki-dark-text-decoration);}html pre.shiki code .sAGMh, html code.shiki .sAGMh{--shiki-default:#986801;--shiki-dark:#D19A66}",{"title":130,"searchDepth":395,"depth":395,"links":1620},[1621,1622,1623,1624,1625],{"id":1399,"depth":395,"text":1400},{"id":1417,"depth":395,"text":1418},{"id":1442,"depth":395,"text":1443},{"id":1502,"depth":395,"text":1503},{"id":1599,"depth":395,"text":1600},{"title":1627,"date":1628,"path":1629,"tags":1630,"body":1631},"Does Your Top-Level Domain Slow Down Your Website? â€” Another Look at DNS Cold Start","2025-11-25","/2025/11/25/did-your-tld-slowing-down-your-site",[11,420],{"type":14,"value":1632,"toc":3617},[1633,1644,1651,1833,1836,1840,1843,1854,1869,1875,1878,1884,1887,1890,1896,1899,1902,1905,1911,1914,1918,1921,1935,1938,1941,1944,3199,3203,3208,3598,3601,3606,3614],[17,1634,1635,1636,1640,1641],{},"In my ",[201,1637,1639],{"href":1638},"/en/2025/11/11/dns-cold-start-dilemma/","previous blog post",", I mentioned a core insight: ",[118,1642,1643],{},"For small sites with low traffic and geographically dispersed visitors, DNS cold start isn't an occasional \"accident\" but rather a passive \"norm.\"",[17,1645,1646,1647,1650],{},"For most webmasters, site traffic doesn't increase overnight, so our visitors will likely need to go through the complete DNS resolution process. In the previous post, I discussed switching to authoritative DNS servers that are physically closer to visitors to improve speed, but ",[118,1648,1649],{},"TLD (Top-Level Domain) Nameservers are beyond our control"," â€” specifically, the portion highlighted in red in the diagram below.",[125,1652,1654],{"className":1046,"code":1653,"language":1048,"meta":130,"style":130},"sequenceDiagram\n    autonumber\n    participant User as User/Browser\n    participant Local as Local DNS\u003Cbr>Recursive Resolver\n    participant Root as Root Nameserver\n    participant TLD as TLD Server\n    participant Auth as Authoritative DNS Server\n\n    Note over User,Auth: Complete DNS Recursive Query Process\n\n    User->>Local: Query domain www.example.com\n    Note over Local: Check cache (MISS)\n\n    Local->>Root: Query .com TLD server\n    Root-->>Local: Return .com TLD server address\n\n    %% --- Highlighted section begins ---\n    rect rgb(255, 235, 235)\n        Note right of Local: âš ï¸ Core focus of this article \u003Cbr> (TLD resolution latency)\n        Local->>TLD: Query authoritative server for example.com\n\n        Note left of TLD: Physical distance and Anycast capability\u003Cbr>determine whether hundreds of ms delay exists\n\n        TLD-->>Local: Return authoritative server address for example.com\n    end\n    %% --- Highlighted section ends ---\n\n    Local->>Auth: Query A record for www.example.com\n    Auth-->>Local: Return IP address (e.g., 1.1.1.1)\n\n    Note over Local: Cache result (TTL)\n\n    Local-->>User: Return final IP address\n\n    User->>Auth: Establish TCP connection / HTTP request\n",[55,1655,1656,1660,1665,1670,1675,1680,1685,1690,1694,1699,1703,1708,1713,1717,1722,1727,1731,1736,1741,1746,1751,1755,1760,1765,1771,1777,1783,1788,1794,1800,1805,1811,1816,1822,1827],{"__ignoreMap":130},[134,1657,1658],{"class":136,"line":137},[134,1659,1055],{},[134,1661,1662],{"class":136,"line":395},[134,1663,1664],{},"    autonumber\n",[134,1666,1667],{"class":136,"line":403},[134,1668,1669],{},"    participant User as User/Browser\n",[134,1671,1672],{"class":136,"line":832},[134,1673,1674],{},"    participant Local as Local DNS\u003Cbr>Recursive Resolver\n",[134,1676,1677],{"class":136,"line":839},[134,1678,1679],{},"    participant Root as Root Nameserver\n",[134,1681,1682],{"class":136,"line":1078},[134,1683,1684],{},"    participant TLD as TLD Server\n",[134,1686,1687],{"class":136,"line":1084},[134,1688,1689],{},"    participant Auth as Authoritative DNS Server\n",[134,1691,1692],{"class":136,"line":1090},[134,1693,829],{"emptyLinePlaceholder":828},[134,1695,1696],{"class":136,"line":3},[134,1697,1698],{},"    Note over User,Auth: Complete DNS Recursive Query Process\n",[134,1700,1701],{"class":136,"line":1205},[134,1702,829],{"emptyLinePlaceholder":828},[134,1704,1705],{"class":136,"line":1211},[134,1706,1707],{},"    User->>Local: Query domain www.example.com\n",[134,1709,1710],{"class":136,"line":1217},[134,1711,1712],{},"    Note over Local: Check cache (MISS)\n",[134,1714,1715],{"class":136,"line":1222},[134,1716,829],{"emptyLinePlaceholder":828},[134,1718,1719],{"class":136,"line":1241},[134,1720,1721],{},"    Local->>Root: Query .com TLD server\n",[134,1723,1724],{"class":136,"line":1248},[134,1725,1726],{},"    Root-->>Local: Return .com TLD server address\n",[134,1728,1729],{"class":136,"line":1253},[134,1730,829],{"emptyLinePlaceholder":828},[134,1732,1733],{"class":136,"line":1264},[134,1734,1735],{},"    %% --- Highlighted section begins ---\n",[134,1737,1738],{"class":136,"line":1274},[134,1739,1740],{},"    rect rgb(255, 235, 235)\n",[134,1742,1743],{"class":136,"line":1279},[134,1744,1745],{},"        Note right of Local: âš ï¸ Core focus of this article \u003Cbr> (TLD resolution latency)\n",[134,1747,1748],{"class":136,"line":1284},[134,1749,1750],{},"        Local->>TLD: Query authoritative server for example.com\n",[134,1752,1753],{"class":136,"line":1290},[134,1754,829],{"emptyLinePlaceholder":828},[134,1756,1757],{"class":136,"line":1296},[134,1758,1759],{},"        Note left of TLD: Physical distance and Anycast capability\u003Cbr>determine whether hundreds of ms delay exists\n",[134,1761,1763],{"class":136,"line":1762},23,[134,1764,829],{"emptyLinePlaceholder":828},[134,1766,1768],{"class":136,"line":1767},24,[134,1769,1770],{},"        TLD-->>Local: Return authoritative server address for example.com\n",[134,1772,1774],{"class":136,"line":1773},25,[134,1775,1776],{},"    end\n",[134,1778,1780],{"class":136,"line":1779},26,[134,1781,1782],{},"    %% --- Highlighted section ends ---\n",[134,1784,1786],{"class":136,"line":1785},27,[134,1787,829],{"emptyLinePlaceholder":828},[134,1789,1791],{"class":136,"line":1790},28,[134,1792,1793],{},"    Local->>Auth: Query A record for www.example.com\n",[134,1795,1797],{"class":136,"line":1796},29,[134,1798,1799],{},"    Auth-->>Local: Return IP address (e.g., 1.1.1.1)\n",[134,1801,1803],{"class":136,"line":1802},30,[134,1804,829],{"emptyLinePlaceholder":828},[134,1806,1808],{"class":136,"line":1807},31,[134,1809,1810],{},"    Note over Local: Cache result (TTL)\n",[134,1812,1814],{"class":136,"line":1813},32,[134,1815,829],{"emptyLinePlaceholder":828},[134,1817,1819],{"class":136,"line":1818},33,[134,1820,1821],{},"    Local-->>User: Return final IP address\n",[134,1823,1825],{"class":136,"line":1824},34,[134,1826,829],{"emptyLinePlaceholder":828},[134,1828,1830],{"class":136,"line":1829},35,[134,1831,1832],{},"    User->>Auth: Establish TCP connection / HTTP request\n",[17,1834,1835],{},"So, if you haven't purchased a domain yet but want to pursue the ultimate first-screen loading time like a true geek (even if you don't have many visitors), which TLD should you choose?",[27,1837,1839],{"id":1838},"simple-test","Simple Test",[17,1841,1842],{},"A simple method is to directly ping the TLD's nameserver to see how long it takes for the public DNS server requested by visitors to complete this segment of resolution.",[17,1844,1845,1846,1849,1850,1853],{},"Taking my domain zhul.in as an example, on Linux, you can use the ",[55,1847,1848],{},"dig"," command to obtain the Nameservers for the ",[55,1851,1852],{},"in"," TLD:",[125,1855,1857],{"className":127,"code":1856,"language":129,"meta":130,"style":130},"dig NS in.\n",[55,1858,1859],{"__ignoreMap":130},[134,1860,1861,1863,1866],{"class":136,"line":137},[134,1862,1848],{"class":140},[134,1864,1865],{"class":144}," NS",[134,1867,1868],{"class":144}," in.\n",[17,1870,1871],{},[62,1872],{"alt":1873,"src":1874},"TLD Nameservers for .in","https://static.031130.xyz/uploads/2025/11/24/b15e97068bd75.webp",[17,1876,1877],{},"Then you can pick any Nameserver (public DNS servers actually have a selection strategy based on historical performance) and directly ping that domain:",[17,1879,1880],{},[62,1881],{"alt":1882,"src":1883},"Latency to TLD Nameserver","https://static.031130.xyz/uploads/2025/11/24/bed48f4ed30ac.webp",[17,1885,1886],{},"My network environment here is Hangzhou Mobile. If I run a DNS recursive server on my local network, this result represents the minimum time required for the red portion in the sequence diagram above (the DNS server needs additional time to process the request).",[17,1888,1889],{},"Using multi-location ping latency tests provided by some websites, we can infer in which countries or regions this TLD has deployed Anycast nodes. Below is the result provided by iplark.com.",[17,1891,1892],{},[62,1893],{"alt":1894,"src":1895},"Ping values for .in TLD Nameserver worldwide","https://static.031130.xyz/uploads/2025/11/24/748d25e0beecc.webp",[17,1897,1898],{},"We can infer that the .in TLD Nameserver has deployed Anycast nodes in at least Japan, Hong Kong, USA, Canada, Europe, Australia, Brazil, India, South Africa, and other locations, while latency within mainland China is relatively high.",[1900,1901],"hr",{},[17,1903,1904],{},"As a comparison, we can use the same method to examine the Anycast nodes for the .cn domain's TLD Nameserver.",[17,1906,1907],{},[62,1908],{"alt":1909,"src":1910},"Ping values for .cn TLD Nameserver worldwide","https://static.031130.xyz/uploads/2025/11/24/9751de16b460b.webp",[17,1912,1913],{},"According to tests by itdog.cn, the .cn domain's TLD Nameserver may only have nodes in Beijing.",[27,1915,1917],{"id":1916},"a-more-advanced-testing-approach","A More Advanced Testing Approach",[17,1919,1920],{},"The above testing method is only a simple judgment method. In reality, many external factors affect DNS cold start resolution time:",[32,1922,1923,1926,1929,1932],{},[35,1924,1925],{},"Peering exists between public DNS servers and TLD Nameservers, making their communication very fast",[35,1927,1928],{},"The TLD Nameserver has poor performance, requiring an additional tens of milliseconds to process your request",[35,1930,1931],{},"Among the TLD's several Nameservers, some are faster than others, and the public DNS server you use can select the faster one based on historical data",[35,1933,1934],{},"...",[17,1936,1937],{},"Therefore, we need a testing approach based on actual DNS resolution requests.",[17,1939,1940],{},"Testing DNS cold start has always faced a dilemma â€” we don't manage public DNS servers and cannot log in to manually clear their cache, so only the first test result may be valid, with subsequent requests hitting the cache. However, this time we're testing the latency between the public DNS server and the TLD Nameserver. With Gemini's reminder, I realized we could test the resolution time for random, non-existent domains across different regions using public DNS, which can reflect differences between various TLDs.",[17,1942,1943],{},"So, the test code is below. You can use bash on common Linux systems to execute this code. Ensure you have the dig and shasum commands installed, and I recommend using tools like screen/tmux to run it in the background, as the entire testing process may last over ten minutes. If your network environment is within mainland China, I suggest changing the public DNS server in the code to 223.5.5.5 / 119.29.29.29, which should better match the usage environment of domestic visitors.",[125,1945,1947],{"className":127,"code":1946,"language":129,"meta":130,"style":130},"#!/bin/bash\n\n# ================= Configuration Section =================\n# CSV filename\nOUTPUT_FILE=\"dns_benchmark_results.csv\"\n\n# DNS server\nDNS_SERVER=\"8.8.8.8\"\n\n# List of TLDs to test\n# Includes: global generic (com), country code (cn, de), popular tech (io, xyz), and potentially slower suffixes\nTLDS_TO_TEST=(\"com\" \"net\" \"org\" \"cn\" \"in\" \"de\" \"cc\" \"site\" \"ai\" \"io\" \"xyz\" \"top\")\n\n# Number of tests per TLD\nSAMPLES=1000\n\n# Interval between queries (seconds), to prevent being flagged as attack by DNS server\n# 1000 times * 0.1s = 100s/TLD, total time approximately 15-20 minutes\nSLEEP_INTERVAL=0.1\n# ===========================================\n\n# Initialize CSV file header\necho \"TLD,Domain,QueryTime_ms,Status,Timestamp\" > \"$OUTPUT_FILE\"\n\necho \"=============================================\"\necho \"   DNS TLD Latency Benchmark Tool\"\necho \"   Target DNS: $DNS_SERVER\"\necho \"   Samples per TLD: $SAMPLES\"\necho \"   Output File: $OUTPUT_FILE\"\necho \"=============================================\"\necho \"\"\n\n# Define progress bar function\nfunction show_progress {\n    # Parameters: $1=current progress, $2=total, $3=current TLD, $4=current average time\n    let _progress=(${1}*100/${2})\n    let _done=(${_progress}*4)/10\n    let _left=40-$_done\n\n    # Build fill strings\n    _fill=$(printf \"%${_done}s\")\n    _empty=$(printf \"%${_left}s\")\n\n    # \\r returns cursor to beginning of line for refresh effect\n    printf \"\\rProgress [${_fill// /#}${_empty// /-}] ${_progress}%% - Testing .${3} (Avg: ${4}ms) \"\n}\n\n# Main loop\nfor tld in \"${TLDS_TO_TEST[@]}\"; do\n    # Initialize statistics variables\n    total_time_accum=0\n    valid_count=0\n\n    for (( i=1; i\u003C=${SAMPLES}; i++ )); do\n        # 1. Generate random domain (prevent cache hits)\n        # Use date +%N (nanoseconds) for sufficient randomness, compatible with Linux/macOS\n        RAND_PART=$(date +%s%N | shasum | head -c 10)\n        DOMAIN=\"test-${RAND_PART}.${tld}\"\n        TIMESTAMP=$(date \"+%Y-%m-%d %H:%M:%S\")\n\n        # 2. Execute query\n        # +tries=1 +time=2: try once, timeout 2 seconds, avoid script hanging\n        result=$(dig @${DNS_SERVER} ${DOMAIN} A +noall +stats +time=2 +tries=1)\n\n        # Extract time (Query time: 12 msec)\n        query_time=$(echo \"$result\" | grep \"Query time\" | awk '{print $4}')\n        # Extract status (status: NXDOMAIN, NOERROR, etc.)\n        status=$(echo \"$result\" | grep \"status:\" | awk '{print $6}' | tr -d ',')\n\n        # 3. Data cleaning and recording\n        if [[ -n \"$query_time\" && \"$query_time\" =~ ^[0-9]+$ ]]; then\n            # Write to CSV\n            echo \"${tld},${DOMAIN},${query_time},${status},${TIMESTAMP}\" >> \"$OUTPUT_FILE\"\n\n            # Update statistics\n            total_time_accum=$((total_time_accum + query_time))\n            valid_count=$((valid_count + 1))\n            current_avg=$((total_time_accum / valid_count))\n        else\n            # Record failure/timeout\n            echo \"${tld},${DOMAIN},-1,TIMEOUT,${TIMESTAMP}\" >> \"$OUTPUT_FILE\"\n            current_avg=\"N/A\"\n        fi\n\n        # 4. Display progress bar\n        show_progress $i $SAMPLES $tld $current_avg\n\n        sleep $SLEEP_INTERVAL\n    done\n\n    # New line after each TLD completes\n    echo \"\"\n    echo \"âœ… Completed .${tld} | Final Avg: ${current_avg} ms\"\n    echo \"---------------------------------------------\"\ndone\n\necho \"ðŸŽ‰ All Done! Results saved to $OUTPUT_FILE\"\n",[55,1948,1949,1955,1959,1964,1969,1981,1985,1990,2000,2004,2009,2014,2063,2067,2072,2082,2086,2091,2096,2106,2111,2115,2120,2140,2144,2151,2158,2170,2182,2193,2199,2206,2210,2215,2227,2232,2255,2281,2292,2297,2303,2333,2358,2363,2369,2429,2434,2439,2445,2483,2489,2500,2510,2515,2557,2563,2569,2604,2633,2650,2655,2661,2667,2718,2723,2729,2766,2772,2817,2822,2828,2865,2871,2932,2937,2943,2966,2986,3005,3011,3017,3057,3067,3073,3078,3084,3102,3107,3116,3122,3127,3133,3141,3168,3176,3182,3187],{"__ignoreMap":130},[134,1950,1951],{"class":136,"line":137},[134,1952,1954],{"class":1953},"sW2Sy","#!/bin/bash\n",[134,1956,1957],{"class":136,"line":395},[134,1958,829],{"emptyLinePlaceholder":828},[134,1960,1961],{"class":136,"line":403},[134,1962,1963],{"class":1953},"# ================= Configuration Section =================\n",[134,1965,1966],{"class":136,"line":832},[134,1967,1968],{"class":1953},"# CSV filename\n",[134,1970,1971,1974,1978],{"class":136,"line":839},[134,1972,1973],{"class":811},"OUTPUT_FILE",[134,1975,1977],{"class":1976},"sknuh","=",[134,1979,1980],{"class":144},"\"dns_benchmark_results.csv\"\n",[134,1982,1983],{"class":136,"line":1078},[134,1984,829],{"emptyLinePlaceholder":828},[134,1986,1987],{"class":136,"line":1084},[134,1988,1989],{"class":1953},"# DNS server\n",[134,1991,1992,1995,1997],{"class":136,"line":1090},[134,1993,1994],{"class":811},"DNS_SERVER",[134,1996,1977],{"class":1976},[134,1998,1999],{"class":144},"\"8.8.8.8\"\n",[134,2001,2002],{"class":136,"line":3},[134,2003,829],{"emptyLinePlaceholder":828},[134,2005,2006],{"class":136,"line":1205},[134,2007,2008],{"class":1953},"# List of TLDs to test\n",[134,2010,2011],{"class":136,"line":1211},[134,2012,2013],{"class":1953},"# Includes: global generic (com), country code (cn, de), popular tech (io, xyz), and potentially slower suffixes\n",[134,2015,2016,2019,2021,2024,2027,2030,2033,2036,2039,2042,2045,2048,2051,2054,2057,2060],{"class":136,"line":1217},[134,2017,2018],{"class":811},"TLDS_TO_TEST",[134,2020,1977],{"class":1976},[134,2022,2023],{"class":814},"(",[134,2025,2026],{"class":144},"\"com\"",[134,2028,2029],{"class":144}," \"net\"",[134,2031,2032],{"class":144}," \"org\"",[134,2034,2035],{"class":144}," \"cn\"",[134,2037,2038],{"class":144}," \"in\"",[134,2040,2041],{"class":144}," \"de\"",[134,2043,2044],{"class":144}," \"cc\"",[134,2046,2047],{"class":144}," \"site\"",[134,2049,2050],{"class":144}," \"ai\"",[134,2052,2053],{"class":144}," \"io\"",[134,2055,2056],{"class":144}," \"xyz\"",[134,2058,2059],{"class":144}," \"top\"",[134,2061,2062],{"class":814},")\n",[134,2064,2065],{"class":136,"line":1222},[134,2066,829],{"emptyLinePlaceholder":828},[134,2068,2069],{"class":136,"line":1241},[134,2070,2071],{"class":1953},"# Number of tests per TLD\n",[134,2073,2074,2077,2079],{"class":136,"line":1248},[134,2075,2076],{"class":811},"SAMPLES",[134,2078,1977],{"class":1976},[134,2080,2081],{"class":144},"1000\n",[134,2083,2084],{"class":136,"line":1253},[134,2085,829],{"emptyLinePlaceholder":828},[134,2087,2088],{"class":136,"line":1264},[134,2089,2090],{"class":1953},"# Interval between queries (seconds), to prevent being flagged as attack by DNS server\n",[134,2092,2093],{"class":136,"line":1274},[134,2094,2095],{"class":1953},"# 1000 times * 0.1s = 100s/TLD, total time approximately 15-20 minutes\n",[134,2097,2098,2101,2103],{"class":136,"line":1279},[134,2099,2100],{"class":811},"SLEEP_INTERVAL",[134,2102,1977],{"class":1976},[134,2104,2105],{"class":144},"0.1\n",[134,2107,2108],{"class":136,"line":1284},[134,2109,2110],{"class":1953},"# ===========================================\n",[134,2112,2113],{"class":136,"line":1290},[134,2114,829],{"emptyLinePlaceholder":828},[134,2116,2117],{"class":136,"line":1296},[134,2118,2119],{"class":1953},"# Initialize CSV file header\n",[134,2121,2122,2125,2128,2131,2134,2137],{"class":136,"line":1762},[134,2123,2124],{"class":1232},"echo",[134,2126,2127],{"class":144}," \"TLD,Domain,QueryTime_ms,Status,Timestamp\"",[134,2129,2130],{"class":814}," > ",[134,2132,2133],{"class":144},"\"",[134,2135,2136],{"class":811},"$OUTPUT_FILE",[134,2138,2139],{"class":144},"\"\n",[134,2141,2142],{"class":136,"line":1767},[134,2143,829],{"emptyLinePlaceholder":828},[134,2145,2146,2148],{"class":136,"line":1773},[134,2147,2124],{"class":1232},[134,2149,2150],{"class":144}," \"=============================================\"\n",[134,2152,2153,2155],{"class":136,"line":1779},[134,2154,2124],{"class":1232},[134,2156,2157],{"class":144}," \"   DNS TLD Latency Benchmark Tool\"\n",[134,2159,2160,2162,2165,2168],{"class":136,"line":1785},[134,2161,2124],{"class":1232},[134,2163,2164],{"class":144}," \"   Target DNS: ",[134,2166,2167],{"class":811},"$DNS_SERVER",[134,2169,2139],{"class":144},[134,2171,2172,2174,2177,2180],{"class":136,"line":1790},[134,2173,2124],{"class":1232},[134,2175,2176],{"class":144}," \"   Samples per TLD: ",[134,2178,2179],{"class":811},"$SAMPLES",[134,2181,2139],{"class":144},[134,2183,2184,2186,2189,2191],{"class":136,"line":1796},[134,2185,2124],{"class":1232},[134,2187,2188],{"class":144}," \"   Output File: ",[134,2190,2136],{"class":811},[134,2192,2139],{"class":144},[134,2194,2195,2197],{"class":136,"line":1802},[134,2196,2124],{"class":1232},[134,2198,2150],{"class":144},[134,2200,2201,2203],{"class":136,"line":1807},[134,2202,2124],{"class":1232},[134,2204,2205],{"class":144}," \"\"\n",[134,2207,2208],{"class":136,"line":1813},[134,2209,829],{"emptyLinePlaceholder":828},[134,2211,2212],{"class":136,"line":1818},[134,2213,2214],{"class":1953},"# Define progress bar function\n",[134,2216,2217,2221,2224],{"class":136,"line":1824},[134,2218,2220],{"class":2219},"sLKXg","function",[134,2222,2223],{"class":140}," show_progress",[134,2225,2226],{"class":814}," {\n",[134,2228,2229],{"class":136,"line":1829},[134,2230,2231],{"class":1953},"    # Parameters: $1=current progress, $2=total, $3=current TLD, $4=current average time\n",[134,2233,2235,2238,2241,2243,2247,2250,2253],{"class":136,"line":2234},36,[134,2236,2237],{"class":1232},"    let",[134,2239,2240],{"class":144}," _progress=",[134,2242,2023],{"class":814},[134,2244,2246],{"class":2245},"s8iYz","${1}",[134,2248,2249],{"class":814},"*100/",[134,2251,2252],{"class":2245},"${2}",[134,2254,2062],{"class":814},[134,2256,2258,2260,2263,2265,2269,2272,2275,2278],{"class":136,"line":2257},37,[134,2259,2237],{"class":1232},[134,2261,2262],{"class":144}," _done=",[134,2264,2023],{"class":814},[134,2266,2268],{"class":2267},"sr1Ac","${",[134,2270,2271],{"class":811},"_progress",[134,2273,2274],{"class":2267},"}",[134,2276,2277],{"class":814},"*4)",[134,2279,2280],{"class":144},"/10\n",[134,2282,2284,2286,2289],{"class":136,"line":2283},38,[134,2285,2237],{"class":1232},[134,2287,2288],{"class":144}," _left=40-",[134,2290,2291],{"class":811},"$_done\n",[134,2293,2295],{"class":136,"line":2294},39,[134,2296,829],{"emptyLinePlaceholder":828},[134,2298,2300],{"class":136,"line":2299},40,[134,2301,2302],{"class":1953},"    # Build fill strings\n",[134,2304,2306,2309,2311,2314,2317,2320,2323,2326,2328,2331],{"class":136,"line":2305},41,[134,2307,2308],{"class":811},"    _fill",[134,2310,1977],{"class":1976},[134,2312,2313],{"class":814},"$(",[134,2315,2316],{"class":1232},"printf",[134,2318,2319],{"class":144}," \"%",[134,2321,2268],{"class":2322},"sTIpt",[134,2324,2325],{"class":811},"_done",[134,2327,2274],{"class":2322},[134,2329,2330],{"class":144},"s\"",[134,2332,2062],{"class":814},[134,2334,2336,2339,2341,2343,2345,2347,2349,2352,2354,2356],{"class":136,"line":2335},42,[134,2337,2338],{"class":811},"    _empty",[134,2340,1977],{"class":1976},[134,2342,2313],{"class":814},[134,2344,2316],{"class":1232},[134,2346,2319],{"class":144},[134,2348,2268],{"class":2322},[134,2350,2351],{"class":811},"_left",[134,2353,2274],{"class":2322},[134,2355,2330],{"class":144},[134,2357,2062],{"class":814},[134,2359,2361],{"class":136,"line":2360},43,[134,2362,829],{"emptyLinePlaceholder":828},[134,2364,2366],{"class":136,"line":2365},44,[134,2367,2368],{"class":1953},"    # \\r returns cursor to beginning of line for refresh effect\n",[134,2370,2372,2375,2378,2380,2383,2386,2389,2392,2395,2397,2400,2403,2405,2408,2410,2412,2414,2417,2420,2423,2426],{"class":136,"line":2371},45,[134,2373,2374],{"class":1232},"    printf",[134,2376,2377],{"class":144}," \"\\rProgress [",[134,2379,2268],{"class":2322},[134,2381,2382],{"class":811},"_fill",[134,2384,2385],{"class":814},"//",[134,2387,2388],{"class":814}," /#",[134,2390,2391],{"class":2322},"}${",[134,2393,2394],{"class":811},"_empty",[134,2396,2385],{"class":814},[134,2398,2399],{"class":814}," /",[134,2401,2402],{"class":811},"-",[134,2404,2274],{"class":2322},[134,2406,2407],{"class":144},"] ",[134,2409,2268],{"class":2322},[134,2411,2271],{"class":811},[134,2413,2274],{"class":2322},[134,2415,2416],{"class":144},"%% - Testing .",[134,2418,2419],{"class":2245},"${3}",[134,2421,2422],{"class":144}," (Avg: ",[134,2424,2425],{"class":2245},"${4}",[134,2427,2428],{"class":144},"ms) \"\n",[134,2430,2432],{"class":136,"line":2431},46,[134,2433,1299],{"class":814},[134,2435,2437],{"class":136,"line":2436},47,[134,2438,829],{"emptyLinePlaceholder":828},[134,2440,2442],{"class":136,"line":2441},48,[134,2443,2444],{"class":1953},"# Main loop\n",[134,2446,2448,2451,2454,2457,2460,2462,2464,2467,2470,2473,2475,2477,2480],{"class":136,"line":2447},49,[134,2449,2450],{"class":2219},"for",[134,2452,2453],{"class":811}," tld",[134,2455,2456],{"class":2219}," in",[134,2458,2459],{"class":144}," \"",[134,2461,2268],{"class":2322},[134,2463,2018],{"class":811},[134,2465,2466],{"class":144},"[",[134,2468,2469],{"class":814},"@",[134,2471,2472],{"class":144},"]",[134,2474,2274],{"class":2322},[134,2476,2133],{"class":144},[134,2478,2479],{"class":814},"; ",[134,2481,2482],{"class":2219},"do\n",[134,2484,2486],{"class":136,"line":2485},50,[134,2487,2488],{"class":1953},"    # Initialize statistics variables\n",[134,2490,2492,2495,2497],{"class":136,"line":2491},51,[134,2493,2494],{"class":811},"    total_time_accum",[134,2496,1977],{"class":1976},[134,2498,2499],{"class":144},"0\n",[134,2501,2503,2506,2508],{"class":136,"line":2502},52,[134,2504,2505],{"class":811},"    valid_count",[134,2507,1977],{"class":1976},[134,2509,2499],{"class":144},[134,2511,2513],{"class":136,"line":2512},53,[134,2514,829],{"emptyLinePlaceholder":828},[134,2516,2518,2521,2524,2527,2529,2532,2534,2536,2539,2541,2543,2545,2547,2549,2552,2555],{"class":136,"line":2517},54,[134,2519,2520],{"class":2219},"    for",[134,2522,2523],{"class":814}," (( ",[134,2525,2526],{"class":811},"i",[134,2528,1977],{"class":1976},[134,2530,2531],{"class":154},"1",[134,2533,2479],{"class":814},[134,2535,2526],{"class":811},[134,2537,2538],{"class":1976},"\u003C=",[134,2540,2268],{"class":2267},[134,2542,2076],{"class":811},[134,2544,2274],{"class":2267},[134,2546,2479],{"class":814},[134,2548,2526],{"class":811},[134,2550,2551],{"class":1976},"++",[134,2553,2554],{"class":814}," )); ",[134,2556,2482],{"class":2219},[134,2558,2560],{"class":136,"line":2559},55,[134,2561,2562],{"class":1953},"        # 1. Generate random domain (prevent cache hits)\n",[134,2564,2566],{"class":136,"line":2565},56,[134,2567,2568],{"class":1953},"        # Use date +%N (nanoseconds) for sufficient randomness, compatible with Linux/macOS\n",[134,2570,2572,2575,2577,2579,2582,2585,2588,2591,2593,2596,2599,2602],{"class":136,"line":2571},57,[134,2573,2574],{"class":811},"        RAND_PART",[134,2576,1977],{"class":1976},[134,2578,2313],{"class":814},[134,2580,2581],{"class":140},"date",[134,2583,2584],{"class":144}," +%s%N",[134,2586,2587],{"class":814}," | ",[134,2589,2590],{"class":140},"shasum",[134,2592,2587],{"class":814},[134,2594,2595],{"class":140},"head",[134,2597,2598],{"class":154}," -c",[134,2600,2601],{"class":154}," 10",[134,2603,2062],{"class":814},[134,2605,2607,2610,2612,2615,2617,2620,2622,2624,2626,2629,2631],{"class":136,"line":2606},58,[134,2608,2609],{"class":811},"        DOMAIN",[134,2611,1977],{"class":1976},[134,2613,2614],{"class":144},"\"test-",[134,2616,2268],{"class":2322},[134,2618,2619],{"class":811},"RAND_PART",[134,2621,2274],{"class":2322},[134,2623,433],{"class":144},[134,2625,2268],{"class":2322},[134,2627,2628],{"class":811},"tld",[134,2630,2274],{"class":2322},[134,2632,2139],{"class":144},[134,2634,2636,2639,2641,2643,2645,2648],{"class":136,"line":2635},59,[134,2637,2638],{"class":811},"        TIMESTAMP",[134,2640,1977],{"class":1976},[134,2642,2313],{"class":814},[134,2644,2581],{"class":140},[134,2646,2647],{"class":144}," \"+%Y-%m-%d %H:%M:%S\"",[134,2649,2062],{"class":814},[134,2651,2653],{"class":136,"line":2652},60,[134,2654,829],{"emptyLinePlaceholder":828},[134,2656,2658],{"class":136,"line":2657},61,[134,2659,2660],{"class":1953},"        # 2. Execute query\n",[134,2662,2664],{"class":136,"line":2663},62,[134,2665,2666],{"class":1953},"        # +tries=1 +time=2: try once, timeout 2 seconds, avoid script hanging\n",[134,2668,2670,2673,2675,2677,2679,2682,2684,2686,2688,2691,2694,2696,2699,2702,2705,2708,2711,2714,2716],{"class":136,"line":2669},63,[134,2671,2672],{"class":811},"        result",[134,2674,1977],{"class":1976},[134,2676,2313],{"class":814},[134,2678,1848],{"class":140},[134,2680,2681],{"class":144}," @",[134,2683,2268],{"class":2267},[134,2685,1994],{"class":811},[134,2687,2274],{"class":2267},[134,2689,2690],{"class":2267}," ${",[134,2692,2693],{"class":811},"DOMAIN",[134,2695,2274],{"class":2267},[134,2697,2698],{"class":144}," A",[134,2700,2701],{"class":144}," +noall",[134,2703,2704],{"class":144}," +stats",[134,2706,2707],{"class":144}," +time=",[134,2709,2710],{"class":154},"2",[134,2712,2713],{"class":144}," +tries=",[134,2715,2531],{"class":154},[134,2717,2062],{"class":814},[134,2719,2721],{"class":136,"line":2720},64,[134,2722,829],{"emptyLinePlaceholder":828},[134,2724,2726],{"class":136,"line":2725},65,[134,2727,2728],{"class":1953},"        # Extract time (Query time: 12 msec)\n",[134,2730,2732,2735,2737,2739,2741,2743,2746,2748,2750,2753,2756,2758,2761,2764],{"class":136,"line":2731},66,[134,2733,2734],{"class":811},"        query_time",[134,2736,1977],{"class":1976},[134,2738,2313],{"class":814},[134,2740,2124],{"class":1232},[134,2742,2459],{"class":144},[134,2744,2745],{"class":811},"$result",[134,2747,2133],{"class":144},[134,2749,2587],{"class":814},[134,2751,2752],{"class":140},"grep",[134,2754,2755],{"class":144}," \"Query time\"",[134,2757,2587],{"class":814},[134,2759,2760],{"class":140},"awk",[134,2762,2763],{"class":144}," '{print $4}'",[134,2765,2062],{"class":814},[134,2767,2769],{"class":136,"line":2768},67,[134,2770,2771],{"class":1953},"        # Extract status (status: NXDOMAIN, NOERROR, etc.)\n",[134,2773,2775,2778,2780,2782,2784,2786,2788,2790,2792,2794,2797,2799,2801,2804,2806,2809,2812,2815],{"class":136,"line":2774},68,[134,2776,2777],{"class":811},"        status",[134,2779,1977],{"class":1976},[134,2781,2313],{"class":814},[134,2783,2124],{"class":1232},[134,2785,2459],{"class":144},[134,2787,2745],{"class":811},[134,2789,2133],{"class":144},[134,2791,2587],{"class":814},[134,2793,2752],{"class":140},[134,2795,2796],{"class":144}," \"status:\"",[134,2798,2587],{"class":814},[134,2800,2760],{"class":140},[134,2802,2803],{"class":144}," '{print $6}'",[134,2805,2587],{"class":814},[134,2807,2808],{"class":140},"tr",[134,2810,2811],{"class":154}," -d",[134,2813,2814],{"class":144}," ','",[134,2816,2062],{"class":814},[134,2818,2820],{"class":136,"line":2819},69,[134,2821,829],{"emptyLinePlaceholder":828},[134,2823,2825],{"class":136,"line":2824},70,[134,2826,2827],{"class":1953},"        # 3. Data cleaning and recording\n",[134,2829,2831,2834,2837,2840,2842,2845,2847,2850,2852,2854,2856,2859,2862],{"class":136,"line":2830},71,[134,2832,2833],{"class":2219},"        if",[134,2835,2836],{"class":814}," [[ ",[134,2838,2839],{"class":1976},"-n",[134,2841,2459],{"class":144},[134,2843,2844],{"class":811},"$query_time",[134,2846,2133],{"class":144},[134,2848,2849],{"class":1976}," &&",[134,2851,2459],{"class":144},[134,2853,2844],{"class":811},[134,2855,2133],{"class":144},[134,2857,2858],{"class":1976}," =~",[134,2860,2861],{"class":814}," ^[0-9]+$ ]]; ",[134,2863,2864],{"class":2219},"then\n",[134,2866,2868],{"class":136,"line":2867},72,[134,2869,2870],{"class":1953},"            # Write to CSV\n",[134,2872,2874,2877,2879,2881,2883,2885,2888,2890,2892,2894,2896,2898,2901,2903,2905,2907,2910,2912,2914,2916,2919,2921,2923,2926,2928,2930],{"class":136,"line":2873},73,[134,2875,2876],{"class":1232},"            echo",[134,2878,2459],{"class":144},[134,2880,2268],{"class":2322},[134,2882,2628],{"class":811},[134,2884,2274],{"class":2322},[134,2886,2887],{"class":144},",",[134,2889,2268],{"class":2322},[134,2891,2693],{"class":811},[134,2893,2274],{"class":2322},[134,2895,2887],{"class":144},[134,2897,2268],{"class":2322},[134,2899,2900],{"class":811},"query_time",[134,2902,2274],{"class":2322},[134,2904,2887],{"class":144},[134,2906,2268],{"class":2322},[134,2908,2909],{"class":811},"status",[134,2911,2274],{"class":2322},[134,2913,2887],{"class":144},[134,2915,2268],{"class":2322},[134,2917,2918],{"class":811},"TIMESTAMP",[134,2920,2274],{"class":2322},[134,2922,2133],{"class":144},[134,2924,2925],{"class":814}," >> ",[134,2927,2133],{"class":144},[134,2929,2136],{"class":811},[134,2931,2139],{"class":144},[134,2933,2935],{"class":136,"line":2934},74,[134,2936,829],{"emptyLinePlaceholder":828},[134,2938,2940],{"class":136,"line":2939},75,[134,2941,2942],{"class":1953},"            # Update statistics\n",[134,2944,2946,2949,2951,2954,2957,2960,2963],{"class":136,"line":2945},76,[134,2947,2948],{"class":811},"            total_time_accum",[134,2950,1977],{"class":1976},[134,2952,2953],{"class":814},"$((",[134,2955,2956],{"class":140},"total_time_accum",[134,2958,2959],{"class":144}," +",[134,2961,2962],{"class":144}," query_time",[134,2964,2965],{"class":814},"))\n",[134,2967,2969,2972,2974,2976,2979,2981,2984],{"class":136,"line":2968},77,[134,2970,2971],{"class":811},"            valid_count",[134,2973,1977],{"class":1976},[134,2975,2953],{"class":814},[134,2977,2978],{"class":140},"valid_count",[134,2980,2959],{"class":144},[134,2982,2983],{"class":154}," 1",[134,2985,2965],{"class":814},[134,2987,2989,2992,2994,2996,2998,3000,3003],{"class":136,"line":2988},78,[134,2990,2991],{"class":811},"            current_avg",[134,2993,1977],{"class":1976},[134,2995,2953],{"class":814},[134,2997,2956],{"class":140},[134,2999,2399],{"class":144},[134,3001,3002],{"class":144}," valid_count",[134,3004,2965],{"class":814},[134,3006,3008],{"class":136,"line":3007},79,[134,3009,3010],{"class":2219},"        else\n",[134,3012,3014],{"class":136,"line":3013},80,[134,3015,3016],{"class":1953},"            # Record failure/timeout\n",[134,3018,3020,3022,3024,3026,3028,3030,3032,3034,3036,3038,3041,3043,3045,3047,3049,3051,3053,3055],{"class":136,"line":3019},81,[134,3021,2876],{"class":1232},[134,3023,2459],{"class":144},[134,3025,2268],{"class":2322},[134,3027,2628],{"class":811},[134,3029,2274],{"class":2322},[134,3031,2887],{"class":144},[134,3033,2268],{"class":2322},[134,3035,2693],{"class":811},[134,3037,2274],{"class":2322},[134,3039,3040],{"class":144},",-1,TIMEOUT,",[134,3042,2268],{"class":2322},[134,3044,2918],{"class":811},[134,3046,2274],{"class":2322},[134,3048,2133],{"class":144},[134,3050,2925],{"class":814},[134,3052,2133],{"class":144},[134,3054,2136],{"class":811},[134,3056,2139],{"class":144},[134,3058,3060,3062,3064],{"class":136,"line":3059},82,[134,3061,2991],{"class":811},[134,3063,1977],{"class":1976},[134,3065,3066],{"class":144},"\"N/A\"\n",[134,3068,3070],{"class":136,"line":3069},83,[134,3071,3072],{"class":2219},"        fi\n",[134,3074,3076],{"class":136,"line":3075},84,[134,3077,829],{"emptyLinePlaceholder":828},[134,3079,3081],{"class":136,"line":3080},85,[134,3082,3083],{"class":1953},"        # 4. Display progress bar\n",[134,3085,3087,3090,3093,3096,3099],{"class":136,"line":3086},86,[134,3088,3089],{"class":140},"        show_progress",[134,3091,3092],{"class":811}," $i",[134,3094,3095],{"class":811}," $SAMPLES",[134,3097,3098],{"class":811}," $tld",[134,3100,3101],{"class":811}," $current_avg\n",[134,3103,3105],{"class":136,"line":3104},87,[134,3106,829],{"emptyLinePlaceholder":828},[134,3108,3110,3113],{"class":136,"line":3109},88,[134,3111,3112],{"class":140},"        sleep",[134,3114,3115],{"class":811}," $SLEEP_INTERVAL\n",[134,3117,3119],{"class":136,"line":3118},89,[134,3120,3121],{"class":2219},"    done\n",[134,3123,3125],{"class":136,"line":3124},90,[134,3126,829],{"emptyLinePlaceholder":828},[134,3128,3130],{"class":136,"line":3129},91,[134,3131,3132],{"class":1953},"    # New line after each TLD completes\n",[134,3134,3136,3139],{"class":136,"line":3135},92,[134,3137,3138],{"class":1232},"    echo",[134,3140,2205],{"class":144},[134,3142,3144,3146,3149,3151,3153,3155,3158,3160,3163,3165],{"class":136,"line":3143},93,[134,3145,3138],{"class":1232},[134,3147,3148],{"class":144}," \"âœ… Completed .",[134,3150,2268],{"class":2322},[134,3152,2628],{"class":811},[134,3154,2274],{"class":2322},[134,3156,3157],{"class":144}," | Final Avg: ",[134,3159,2268],{"class":2322},[134,3161,3162],{"class":811},"current_avg",[134,3164,2274],{"class":2322},[134,3166,3167],{"class":144}," ms\"\n",[134,3169,3171,3173],{"class":136,"line":3170},94,[134,3172,3138],{"class":1232},[134,3174,3175],{"class":144}," \"---------------------------------------------\"\n",[134,3177,3179],{"class":136,"line":3178},95,[134,3180,3181],{"class":2219},"done\n",[134,3183,3185],{"class":136,"line":3184},96,[134,3186,829],{"emptyLinePlaceholder":828},[134,3188,3190,3192,3195,3197],{"class":136,"line":3189},97,[134,3191,2124],{"class":1232},[134,3193,3194],{"class":144}," \"ðŸŽ‰ All Done! Results saved to ",[134,3196,2136],{"class":811},[134,3198,2139],{"class":144},[27,3200,3202],{"id":3201},"test-results","Test Results",[17,3204,3205],{},[118,3206,3207],{},"Disclaimer: The following test results are for reference only, do not constitute any purchase recommendations, and only represent network conditions as of the test date (November 24, 2025), with no follow-up updates planned. DNS cold start has almost no impact on large sites; only small sites need to be concerned. In this test, all testing points within China used 223.5.5.5 as the DNS server, while overseas testing points used 8.8.8.8.",[3209,3210,3211,3256],"table",{},[3212,3213,3214],"thead",{},[2808,3215,3216,3220,3223,3226,3229,3232,3235,3238,3241,3244,3247,3250,3253],{},[3217,3218,3219],"th",{},"Test Point/Latency (ms)",[3217,3221,3222],{},".com",[3217,3224,3225],{},".net",[3217,3227,3228],{},".org",[3217,3230,3231],{},".cn",[3217,3233,3234],{},".in",[3217,3236,3237],{},".de",[3217,3239,3240],{},".cc",[3217,3242,3243],{},".site",[3217,3245,3246],{},".ai",[3217,3248,3249],{},".io",[3217,3251,3252],{},".xyz",[3217,3254,3255],{},".top",[3257,3258,3259,3301,3342,3381,3422,3459,3493,3529,3563],"tbody",{},[2808,3260,3261,3265,3268,3271,3274,3277,3280,3283,3286,3289,3292,3295,3298],{},[3262,3263,3264],"td",{},"ðŸ‡¨ðŸ‡³ Shanghai Tencent Cloud",[3262,3266,3267],{},"438",[3262,3269,3270],{},"429",[3262,3272,3273],{},"470",[3262,3275,3276],{},"30",[3262,3278,3279],{},"535",[3262,3281,3282],{},"353",[3262,3284,3285],{},"476",[3262,3287,3288],{},"454",[3262,3290,3291],{},"367",[3262,3293,3294],{},"485",[3262,3296,3297],{},"444",[3262,3299,3300],{},"43",[2808,3302,3303,3306,3309,3312,3315,3318,3321,3324,3327,3330,3333,3336,3339],{},[3262,3304,3305],{},"ðŸ‡¨ðŸ‡³ Beijing Tencent Cloud",[3262,3307,3308],{},"425",[3262,3310,3311],{},"443",[3262,3313,3314],{},"469",[3262,3316,3317],{},"17",[3262,3319,3320],{},"350",[3262,3322,3323],{},"420",[3262,3325,3326],{},"466",[3262,3328,3329],{},"647",[3262,3331,3332],{},"582",[3262,3334,3335],{},"461",[3262,3337,3338],{},"559",[3262,3340,3341],{},"9",[2808,3343,3344,3347,3350,3352,3355,3358,3361,3364,3367,3369,3372,3375,3378],{},[3262,3345,3346],{},"ðŸ‡­ðŸ‡° Hong Kong Yxvm",[3262,3348,3349],{},"75",[3262,3351,3349],{},[3262,3353,3354],{},"363",[3262,3356,3357],{},"227",[3262,3359,3360],{},"6",[3262,3362,3363],{},"11",[3262,3365,3366],{},"61",[3262,3368,3360],{},[3262,3370,3371],{},"33",[3262,3373,3374],{},"126",[3262,3376,3377],{},"5",[3262,3379,3380],{},"7",[2808,3382,3383,3386,3389,3392,3395,3398,3401,3404,3407,3410,3413,3416,3419],{},[3262,3384,3385],{},"ðŸ‡¨ðŸ‡³ Zhanghua (Taiwan) Hinet",[3262,3387,3388],{},"90",[3262,3390,3391],{},"87",[3262,3393,3394],{},"128",[3262,3396,3397],{},"213",[3262,3399,3400],{},"59",[3262,3402,3403],{},"38",[3262,3405,3406],{},"76",[3262,3408,3409],{},"37",[3262,3411,3412],{},"73",[3262,3414,3415],{},"94",[3262,3417,3418],{},"36",[3262,3420,3421],{},"47",[2808,3423,3424,3427,3430,3433,3436,3439,3442,3445,3447,3450,3452,3455,3457],{},[3262,3425,3426],{},"ðŸ‡¯ðŸ‡µ Osaka Vmiss",[3262,3428,3429],{},"20",[3262,3431,3432],{},"19",[3262,3434,3435],{},"244",[3262,3437,3438],{},"309",[3262,3440,3441],{},"15",[3262,3443,3444],{},"24",[3262,3446,3317],{},[3262,3448,3449],{},"35",[3262,3451,3432],{},[3262,3453,3454],{},"65",[3262,3456,3409],{},[3262,3458,3388],{},[2808,3460,3461,3464,3466,3468,3471,3474,3476,3479,3481,3483,3485,3488,3490],{},[3262,3462,3463],{},"ðŸ‡¸ðŸ‡¬ Singapore Wap",[3262,3465,3360],{},[3262,3467,3341],{},[3262,3469,3470],{},"139",[3262,3472,3473],{},"398",[3262,3475,3360],{},[3262,3477,3478],{},"10",[3262,3480,3380],{},[3262,3482,3317],{},[3262,3484,3380],{},[3262,3486,3487],{},"110",[3262,3489,3317],{},[3262,3491,3492],{},"66",[2808,3494,3495,3498,3500,3502,3505,3508,3511,3514,3516,3519,3521,3524,3526],{},[3262,3496,3497],{},"ðŸ‡ºðŸ‡¸ Los Angeles ColoCrossing",[3262,3499,3380],{},[3262,3501,3380],{},[3262,3503,3504],{},"307",[3262,3506,3507],{},"137",[3262,3509,3510],{},"4",[3262,3512,3513],{},"64",[3262,3515,3377],{},[3262,3517,3518],{},"62",[3262,3520,3377],{},[3262,3522,3523],{},"49",[3262,3525,3421],{},[3262,3527,3528],{},"231",[2808,3530,3531,3534,3537,3539,3542,3545,3547,3549,3552,3554,3556,3558,3560],{},[3262,3532,3533],{},"ðŸ‡©ðŸ‡ª DÃ¼sseldorf WIIT AG",[3262,3535,3536],{},"16",[3262,3538,3317],{},[3262,3540,3541],{},"288",[3262,3543,3544],{},"82",[3262,3546,3349],{},[3262,3548,3441],{},[3262,3550,3551],{},"14",[3262,3553,3444],{},[3262,3555,3492],{},[3262,3557,3412],{},[3262,3559,3444],{},[3262,3561,3562],{},"306",[2808,3564,3565,3568,3570,3573,3576,3579,3581,3584,3587,3589,3591,3593,3595],{},[3262,3566,3567],{},"ðŸ‡¦ðŸ‡º Sydney Oracle",[3262,3569,3371],{},[3262,3571,3572],{},"31",[3262,3574,3575],{},"12",[3262,3577,3578],{},"338",[3262,3580,3380],{},[3262,3582,3583],{},"13",[3262,3585,3586],{},"121",[3262,3588,3380],{},[3262,3590,3478],{},[3262,3592,3341],{},[3262,3594,3380],{},[3262,3596,3597],{},"191",[17,3599,3600],{},"From the data above, we can see that .cn and .top are the fastest domain suffixes for resolution within mainland China among all tested options, but choosing .cn and .top means sacrificing resolution speed for visitors in other regions. Generic domain suffixes like .com, .net, and .org perform well in most regions globally, but their resolution speed within mainland China is relatively slow because they haven't deployed Anycast nodes on the mainland. In DNS cold start scenarios (if your site has few visitors, almost every visit is a cold start), the first screen loading time can increase by 500ms or more.",[17,3602,3603],{},[118,3604,3605],{},"As reminded by Showfom, a V2EX user (Showfom ), GoDaddy, acting as a registry operator, hosts Anycast nodes within mainland China for the nameservers of certain TLDs under its managementâ€”such as .one, .tv and .moe. Additionally, based on my own testing, the .you domain, operated by Amazon Registry Services, also has Anycast nodes within mainland China. You may verify this independently.",[17,3607,3608,3609,3613],{},"You can click ",[201,3610,288],{"href":3611,"rel":3612},"https://static.031130.xyz/bin/dns_benchmark_results_20251124.tar.zst",[205]," to download the complete test results CSV file for further analysis.",[391,3615,3616],{},"html .default .shiki span {color: var(--shiki-default);background: var(--shiki-default-bg);font-style: var(--shiki-default-font-style);font-weight: var(--shiki-default-font-weight);text-decoration: var(--shiki-default-text-decoration);}html .shiki span {color: var(--shiki-default);background: var(--shiki-default-bg);font-style: var(--shiki-default-font-style);font-weight: var(--shiki-default-font-weight);text-decoration: var(--shiki-default-text-decoration);}html .dark .shiki span {color: var(--shiki-dark);background: var(--shiki-dark-bg);font-style: var(--shiki-dark-font-style);font-weight: var(--shiki-dark-font-weight);text-decoration: var(--shiki-dark-text-decoration);}html.dark .shiki span {color: var(--shiki-dark);background: var(--shiki-dark-bg);font-style: var(--shiki-dark-font-style);font-weight: var(--shiki-dark-font-weight);text-decoration: var(--shiki-dark-text-decoration);}html pre.shiki code .sAdtL, html code.shiki .sAdtL{--shiki-default:#4078F2;--shiki-dark:#61AFEF}html pre.shiki code .sDhpE, html code.shiki .sDhpE{--shiki-default:#50A14F;--shiki-dark:#98C379}html pre.shiki code .sW2Sy, html code.shiki .sW2Sy{--shiki-default:#A0A1A7;--shiki-default-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic}html pre.shiki code .sJa8x, html code.shiki .sJa8x{--shiki-default:#E45649;--shiki-dark:#E06C75}html pre.shiki code .sknuh, html code.shiki .sknuh{--shiki-default:#383A42;--shiki-dark:#56B6C2}html pre.shiki code .s5ixo, html code.shiki .s5ixo{--shiki-default:#383A42;--shiki-dark:#ABB2BF}html pre.shiki code .s_Sar, html code.shiki .s_Sar{--shiki-default:#0184BC;--shiki-dark:#56B6C2}html pre.shiki code .sLKXg, html code.shiki .sLKXg{--shiki-default:#A626A4;--shiki-dark:#C678DD}html pre.shiki code .s8iYz, html code.shiki .s8iYz{--shiki-default:#383A42;--shiki-default-font-style:inherit;--shiki-dark:#E06C75;--shiki-dark-font-style:italic}html pre.shiki code .sr1Ac, html code.shiki .sr1Ac{--shiki-default:#E45649;--shiki-dark:#ABB2BF}html pre.shiki code .sTIpt, html code.shiki .sTIpt{--shiki-default:#E45649;--shiki-dark:#98C379}html pre.shiki code .sAGMh, html code.shiki .sAGMh{--shiki-default:#986801;--shiki-dark:#D19A66}",{"title":130,"searchDepth":395,"depth":395,"links":3618},[3619,3620,3621],{"id":1838,"depth":395,"text":1839},{"id":1916,"depth":395,"text":1917},{"id":3201,"depth":395,"text":3202},{"title":3623,"date":3624,"path":3625,"tags":3626,"body":3627},"DNS Cold Start: The \"Stone of Sisyphus\" for Small Sites","2025-11-11","/2025/11/11/dns-cold-start-dilemma",[420,11],{"type":14,"value":3628,"toc":3949},[3629,3632,3636,3639,3674,3802,3813,3817,3820,3823,3826,3829,3832,3846,3849,3852,3856,3859,3862,3876,3881,3885,3888,3892,3895,3898,3901,3905,3908,3911,3918,3922,3925,3928,3930,3946],[17,3630,3631],{},"When we talk about website performance, we usually focus on front-end rendering, lazy loading of resources, server response time (TTFB), and so on. However, before the user's browser can even begin to request content, there is a crucial part that is rarely mentioned in performance optimization: DNS resolution. For obscure small sites, a \"DNS Cache Miss,\" or what I call a \"DNS Cold Start,\" can become an unavoidable performance bottleneck. This is the \"Stone of Sisyphus\" mentioned in the title.",[27,3633,3635],{"id":3634},"the-myths-metaphor-the-long-journey-of-dns-resolution","The Myth's Metaphor: The Long Journey of DNS Resolution",[17,3637,3638],{},"To understand the weight of this \"stone,\" we must review the complete path of DNS resolution. This isn't a simple lookup, but a global relay race:",[310,3640,3641,3647,3653,3662,3668],{},[35,3642,3643,3646],{},[118,3644,3645],{},"Starting Point: Public DNS Server"," â€” A user sends a request, and the public DNS server tries to find the answer in its cache.",[35,3648,3649,3652],{},[118,3650,3651],{},"The First \"Push\": Root Servers"," â€” Cache Miss. The public DNS server is directed to one of the 13 root server groups worldwide.",[35,3654,3655,3658,3659,3661],{},[118,3656,3657],{},"The Second Leg: TLD Servers"," â€” The root server points to the Top-Level Domain (TLD) server for the specific suffix (like ",[55,3660,3222],{},").",[35,3663,3664,3667],{},[118,3665,3666],{},"The Third Leg: Authoritative Servers"," â€” The TLD server points to the domain's final \"steward\"â€”the Authoritative DNS Server.",[35,3669,3670,3673],{},[118,3671,3672],{},"The Finish Line:"," The authoritative server returns the final IP address, which is then returned to the user by the public DNS server.",[125,3675,3677],{"className":1046,"code":3676,"language":1048,"meta":130,"style":130},"sequenceDiagram\n    participant User as User/Browser\n    participant Local as Local DNS\u003Cbr>Recursive Resolver\n    participant Root as Root Server\n    participant TLD as TLD Server\u003Cbr>(.com, .org, etc.)\n    participant Auth as Authoritative DNS Server\n\n    Note over User,Auth: Full DNS Recursive Query Flow\n\n    User->>Local: 1. Query domain\u003Cbr>[www.example.com](https://www.example.com)\n    Note over Local: Check cache\u003Cbr>Record not found\n\n    Local->>Root: 2. Query for .com TLD server\n    Root-->>Local: 3. Return .com TLD server address\n\n    Local->>TLD: 4. Query for example.com authoritative server\n    TLD-->>Local: 5. Return example.com authoritative server address\n\n    Local->>Auth: 6. Query for [www.example.com](https://www.example.com) A record\n    Auth-->>Local: 7. Return IP address (e.g., 1.1.1.1)\n\n    Note over Local: Cache result\u003Cbr>(based on TTL)\n\n    Local-->>User: 8. Return final IP address\n\n    Note over User,Auth: Subsequent process\n    User->>Auth: 9. Establish TCP connection with IP\u003Cbr>Start HTTP request\n",[55,3678,3679,3683,3687,3691,3696,3701,3705,3709,3714,3718,3723,3728,3732,3737,3742,3746,3751,3756,3760,3765,3770,3774,3779,3783,3788,3792,3797],{"__ignoreMap":130},[134,3680,3681],{"class":136,"line":137},[134,3682,1055],{},[134,3684,3685],{"class":136,"line":395},[134,3686,1669],{},[134,3688,3689],{"class":136,"line":403},[134,3690,1674],{},[134,3692,3693],{"class":136,"line":832},[134,3694,3695],{},"    participant Root as Root Server\n",[134,3697,3698],{"class":136,"line":839},[134,3699,3700],{},"    participant TLD as TLD Server\u003Cbr>(.com, .org, etc.)\n",[134,3702,3703],{"class":136,"line":1078},[134,3704,1689],{},[134,3706,3707],{"class":136,"line":1084},[134,3708,829],{"emptyLinePlaceholder":828},[134,3710,3711],{"class":136,"line":1090},[134,3712,3713],{},"    Note over User,Auth: Full DNS Recursive Query Flow\n",[134,3715,3716],{"class":136,"line":3},[134,3717,829],{"emptyLinePlaceholder":828},[134,3719,3720],{"class":136,"line":1205},[134,3721,3722],{},"    User->>Local: 1. Query domain\u003Cbr>[www.example.com](https://www.example.com)\n",[134,3724,3725],{"class":136,"line":1211},[134,3726,3727],{},"    Note over Local: Check cache\u003Cbr>Record not found\n",[134,3729,3730],{"class":136,"line":1217},[134,3731,829],{"emptyLinePlaceholder":828},[134,3733,3734],{"class":136,"line":1222},[134,3735,3736],{},"    Local->>Root: 2. Query for .com TLD server\n",[134,3738,3739],{"class":136,"line":1241},[134,3740,3741],{},"    Root-->>Local: 3. Return .com TLD server address\n",[134,3743,3744],{"class":136,"line":1248},[134,3745,829],{"emptyLinePlaceholder":828},[134,3747,3748],{"class":136,"line":1253},[134,3749,3750],{},"    Local->>TLD: 4. Query for example.com authoritative server\n",[134,3752,3753],{"class":136,"line":1264},[134,3754,3755],{},"    TLD-->>Local: 5. Return example.com authoritative server address\n",[134,3757,3758],{"class":136,"line":1274},[134,3759,829],{"emptyLinePlaceholder":828},[134,3761,3762],{"class":136,"line":1279},[134,3763,3764],{},"    Local->>Auth: 6. Query for [www.example.com](https://www.example.com) A record\n",[134,3766,3767],{"class":136,"line":1284},[134,3768,3769],{},"    Auth-->>Local: 7. Return IP address (e.g., 1.1.1.1)\n",[134,3771,3772],{"class":136,"line":1290},[134,3773,829],{"emptyLinePlaceholder":828},[134,3775,3776],{"class":136,"line":1296},[134,3777,3778],{},"    Note over Local: Cache result\u003Cbr>(based on TTL)\n",[134,3780,3781],{"class":136,"line":1762},[134,3782,829],{"emptyLinePlaceholder":828},[134,3784,3785],{"class":136,"line":1767},[134,3786,3787],{},"    Local-->>User: 8. Return final IP address\n",[134,3789,3790],{"class":136,"line":1773},[134,3791,829],{"emptyLinePlaceholder":828},[134,3793,3794],{"class":136,"line":1779},[134,3795,3796],{},"    Note over User,Auth: Subsequent process\n",[134,3798,3799],{"class":136,"line":1785},[134,3800,3801],{},"    User->>Auth: 9. Establish TCP connection with IP\u003Cbr>Start HTTP request\n",[17,3803,3804,3805,3808,3809,3812],{},"For a ",[118,3806,3807],{},"first-time"," or ",[118,3810,3811],{},"long-unvisited"," request, this process means at least 4 network round-trips (RTT), and even more in cases involving CNAMEs. For large websites with perfect caching, this stone may have already been pushed to the hilltop by someone else. But for a small site, it is always at the foot of the hill, waiting for its Sisyphus.",[27,3814,3816],{"id":3815},"a-multiverse-the-mirror-maze-of-anycast","A Multiverse: The Mirror Maze of Anycast",[17,3818,3819],{},"\"Since the cost of a DNS cold start is so high, can I use a script to periodically visit my own site to 'warm up' the public DNS cache in advance?\" â€” This was a solution I once envisioned.",[17,3821,3822],{},"However, this idea is often futile under the Anycast architecture of the modern internet.",[17,3824,3825],{},"The core concept of Anycast is: the same IP address exists at multiple global nodes simultaneously, and user requests are routed to the \"closest\" or \"most optimal network path\" node.",[17,3827,3828],{},"This means that public DNS servers like Google DNS (8.8.8.8), Cloudflare DNS (1.1.1.1), AliDNS (223.5.5.5), and Tencent DNS (119.29.29.29) are not backed by a single, centralized server, but a cluster of nodes distributed worldwide, routed dynamically.",[17,3830,3831],{},"Thus, the problem arises:",[32,3833,3834,3837,3840],{},[35,3835,3836],{},"The pre-warming script I run in Shanghai might hit the Shanghai node of 223.5.5.5;",[35,3838,3839],{},"But a visitor from Beijing will be routed to the Beijing node of 223.5.5.5;",[35,3841,3842,3843],{},"The caches of these two nodes are ",[118,3844,3845],{},"independent and not shared with each other.",[17,3847,3848],{},"From a webmaster's perspective, the DNS cache is no longer a predictable entity but has splintered into a \"mirror maze\" of geographically isolated, ever-changing fragments.",[17,3850,3851],{},"Each visitor is at the base of a different hill, pushing their own stone, as if there are thousands of Sisyphuses in the world, walking their own paths alone.",[27,3853,3855],{"id":3854},"uncontrollable-caching-and-the-normalization-of-cold-starts","Uncontrollable Caching and the \"Normalization\" of Cold Starts",[17,3857,3858],{},"This also explains why even if a small site is visited regularly by a script, real visitors might still experience significant DNS latency. Because \"pre-warming\" is only locally effectiveâ€”it warms the cache of one Anycast node, not the entire network. And when the TTL expires or the cache is cleared by the public DNS server's algorithm (like LRU), this warmth quietly dissipates.",[17,3860,3861],{},"From a macro perspective, this traps \"low-traffic sites\" in a kind of fatalistic loop:",[310,3863,3864,3867,3870,3873],{},[35,3865,3866],{},"Due to low traffic, cache hits are rare;",[35,3868,3869],{},"Due to cache misses, resolution time is high;",[35,3871,3872],{},"Due to high resolution time, first-paint performance is poor, and users visit less;",[35,3874,3875],{},"Due to fewer user visits, the cache is even harder to hit.",[17,3877,3878],{},[118,3879,3880],{},"The cold start is no longer an occasional \"accident,\" but a passive \"new normal.\"",[27,3882,3884],{"id":3883},"can-we-make-the-stone-lighter-strategies-to-mitigate-cold-start-impact","Can We Make the Stone Lighter? â€” Strategies to Mitigate Cold Start Impact",[17,3886,3887],{},"The predicament of Sisyphus seems unsolvable, but we are not entirely powerless. While we cannot completely eliminate the DNS cold start, we can significantly reduce the weight of this stone through a series of strategies and shorten the time it takes to be pushed back up the hill after each time it rolls down.",[100,3889,3891],{"id":3890},"the-art-of-the-trade-off-adjusting-dns-ttl-time-to-live","The Art of the Trade-off: Adjusting DNS TTL (Time-To-Live)",[17,3893,3894],{},"TTL (Time-To-Live) is a critical value in a DNS record. It tells recursive resolvers (like public DNS, local caches) how long they can cache a record, although they might still be evicted by an LRU algorithm.",[17,3896,3897],{},"Lengthening the TTL can effectively increase the cache hit rate, reduce DNS cold starts, and keep Sisyphus's stone at the top of the hill for as long as possible.",[17,3899,3900],{},"But lengthening the TTL comes at the cost of flexibility: if you need to change the IP address for your domain for any reason, an overly long TTL might cause visitors to retrieve a stale IP address for a long time.",[100,3902,3904],{"id":3903},"choosing-a-faster-messenger-using-the-right-authoritative-dns-server","Choosing a Faster \"Messenger\": Using the Right Authoritative DNS Server",[17,3906,3907],{},"The \"last mile\" of DNS resolutionâ€”the time it takes to get from the public DNS server to your authoritative DNS serverâ€”is equally critical. If the Nameserver service your domain uses responds slowly, has few global nodes, or is too far from the public DNS server the visitor is querying, then the entire resolution chain will still be slowed down by this final link, even if the user's public DNS node is nearby.",[17,3909,3910],{},"If I were writing this blog post in English, I would just say to switch your Nameserver to a top-tier provider like Cloudflare or Google, and be done with it. These large companies offer free authoritative DNS hosting, have numerous nodes around the world, and are very professional and trustworthy in this regard.",[17,3912,3913,3914,3917],{},"But I am currently using Simplified Chinese. According to my blog's statistics, most of my readers are from mainland China, and the public DNS servers they query are most likely also deployed in mainland China. Whereas Cloudflare/Google Cloud DNS have no authoritative DNS server nodes in mainland China, which will slow things down. So ",[118,3915,3916],{},"if your visitors are primarily from mainland China, you might want to try AliYun (Alibaba Cloud) or Dnspod",". Their main authoritative DNS server nodes are within mainland China, which, in theory, can reduce the communication time between the public DNS server and the authoritative DNS server.",[27,3919,3921],{"id":3920},"conclusion-the-stone-pusher","Conclusion: The Stone Pusher",[17,3923,3924],{},"There has never been a perfect solution to the problem of DNS cold starts. It's like a fated \"poetry of latency\" within the internet's architectureâ€”each visitor starts from their own network topology, pushing their own stone step-by-step along an invisible path, until they reach the summit of your server, in exchange for the first pixel lighting up on their screen.",[17,3926,3927],{},"For small sites, this may be the weight of destiny; but to understand it, optimize it, and monitor it, is how we, on this long uphill road, polish the stone's edges to make them smoother.",[27,3929,1600],{"id":1599},[32,3931,3932,3939],{},[35,3933,3934],{},[201,3935,3938],{"href":3936,"rel":3937},"https://developers.google.com/speed/public-dns/docs/performance",[205],"Performance Benefits | Public DNS | Google for Developers",[35,3940,3941],{},[201,3942,3945],{"href":3943,"rel":3944},"https://falconcloud.ae/about/blog/how-do-dns-queries-affect-website-latency/",[205],"How do DNS queries affect website latency? - falconcloud.ae",[391,3947,3948],{},"html .default .shiki span {color: var(--shiki-default);background: var(--shiki-default-bg);font-style: var(--shiki-default-font-style);font-weight: var(--shiki-default-font-weight);text-decoration: var(--shiki-default-text-decoration);}html .shiki span {color: var(--shiki-default);background: var(--shiki-default-bg);font-style: var(--shiki-default-font-style);font-weight: var(--shiki-default-font-weight);text-decoration: var(--shiki-default-text-decoration);}html .dark .shiki span {color: var(--shiki-dark);background: var(--shiki-dark-bg);font-style: var(--shiki-dark-font-style);font-weight: var(--shiki-dark-font-weight);text-decoration: var(--shiki-dark-text-decoration);}html.dark .shiki span {color: var(--shiki-dark);background: var(--shiki-dark-bg);font-style: var(--shiki-dark-font-style);font-weight: var(--shiki-dark-font-weight);text-decoration: var(--shiki-dark-text-decoration);}",{"title":130,"searchDepth":395,"depth":395,"links":3950},[3951,3952,3953,3954,3958,3959],{"id":3634,"depth":395,"text":3635},{"id":3815,"depth":395,"text":3816},{"id":3854,"depth":395,"text":3855},{"id":3883,"depth":395,"text":3884,"children":3955},[3956,3957],{"id":3890,"depth":403,"text":3891},{"id":3903,"depth":403,"text":3904},{"id":3920,"depth":395,"text":3921},{"id":1599,"depth":395,"text":1600},{"title":3961,"date":3962,"path":3963,"tags":3964,"body":3966},"HTTP/2 Server Push Has Effectively \"Died\" - I Miss It","2025-11-05","/2025/11/05/http-2-server-push-is-practically-obsolete",[890,1394,11,3965,889],"HTML",{"type":14,"value":3967,"toc":4375},[3968,3971,3975,3986,4048,4055,4108,4117,4122,4125,4129,4132,4177,4189,4193,4196,4204,4213,4221,4224,4228,4232,4235,4238,4241,4249,4264,4268,4275,4289,4295,4299,4302,4307,4310,4313,4316,4327,4330,4332,4373],[17,3969,3970],{},"I've been refactoring my blog recently, and while preparing for autumn recruitment and memorizing technical concepts, I came across HTTP/2 server push. I then attempted to configure HTTP/2 server push for my blog during deployment to further optimize first-screen loading speed.",[27,3972,3974],{"id":3973},"why-http2-server-push-could-improve-first-screen-loading-speed","Why HTTP/2 Server Push Could Improve First-Screen Loading Speed",[17,3976,3977,3978,3981,3982,3985],{},"As shown in the diagram below, in traditional HTTP/1.1, the browser first downloads ",[55,3979,3980],{},"index.html"," and completes the initial parsing, then retrieves the URLs for CSS/JS resources from the parsed data before making a second round of requests. After establishing TCP/TLS connections, it requires ",[118,3983,3984],{},"at least two RTTs to retrieve"," all the resources needed to fully render the page.",[125,3987,3989],{"className":1046,"code":3988,"language":1048,"meta":130,"style":130},"sequenceDiagram\n    participant Browser\n    participant Server\n\n    Browser->>Server: GET /index.html\n    Server-->>Browser: 200 OK + HTML\n    Browser->>Server: GET /style.css\n    Browser->>Server: GET /app.js\n    Server-->>Browser: 200 OK + CSS\n    Server-->>Browser: 200 OK + JS\n\n    Note over Browser: Browser must wait for HTML to download\u003Cbr/>and parse before making subsequent requests,\u003Cbr/>increasing round-trip latency (RTT)\n",[55,3990,3991,3995,4000,4005,4009,4014,4019,4024,4029,4034,4039,4043],{"__ignoreMap":130},[134,3992,3993],{"class":136,"line":137},[134,3994,1055],{},[134,3996,3997],{"class":136,"line":395},[134,3998,3999],{},"    participant Browser\n",[134,4001,4002],{"class":136,"line":403},[134,4003,4004],{},"    participant Server\n",[134,4006,4007],{"class":136,"line":832},[134,4008,829],{"emptyLinePlaceholder":828},[134,4010,4011],{"class":136,"line":839},[134,4012,4013],{},"    Browser->>Server: GET /index.html\n",[134,4015,4016],{"class":136,"line":1078},[134,4017,4018],{},"    Server-->>Browser: 200 OK + HTML\n",[134,4020,4021],{"class":136,"line":1084},[134,4022,4023],{},"    Browser->>Server: GET /style.css\n",[134,4025,4026],{"class":136,"line":1090},[134,4027,4028],{},"    Browser->>Server: GET /app.js\n",[134,4030,4031],{"class":136,"line":3},[134,4032,4033],{},"    Server-->>Browser: 200 OK + CSS\n",[134,4035,4036],{"class":136,"line":1205},[134,4037,4038],{},"    Server-->>Browser: 200 OK + JS\n",[134,4040,4041],{"class":136,"line":1211},[134,4042,829],{"emptyLinePlaceholder":828},[134,4044,4045],{"class":136,"line":1217},[134,4046,4047],{},"    Note over Browser: Browser must wait for HTML to download\u003Cbr/>and parse before making subsequent requests,\u003Cbr/>increasing round-trip latency (RTT)\n",[17,4049,4050,4051,4054],{},"In HTTP/2's vision, the process would look like the diagram below. When the browser requests index.html, the server can simultaneously push CSS/JS resources to the client. This way, after establishing the TCP/TLS connection, it only needs ",[118,4052,4053],{},"one RTT"," to retrieve all resources needed for page rendering.",[125,4056,4058],{"className":1046,"code":4057,"language":1048,"meta":130,"style":130},"sequenceDiagram\n    participant Browser\n    participant Server\n\n    Browser->>Server: GET /index.html\n    Server-->>Browser: 200 OK + HTML\n    Server-->>Browser: PUSH_PROMISE /style.css\n    Server-->>Browser: PUSH_PROMISE /app.js\n    Server-->>Browser: (Push) style.css + app.js content\n\n    Note over Browser: Browser receives proactive resource push\u003Cbr/>Reduces request rounds and first-screen latency\n",[55,4059,4060,4064,4068,4072,4076,4080,4084,4089,4094,4099,4103],{"__ignoreMap":130},[134,4061,4062],{"class":136,"line":137},[134,4063,1055],{},[134,4065,4066],{"class":136,"line":395},[134,4067,3999],{},[134,4069,4070],{"class":136,"line":403},[134,4071,4004],{},[134,4073,4074],{"class":136,"line":832},[134,4075,829],{"emptyLinePlaceholder":828},[134,4077,4078],{"class":136,"line":839},[134,4079,4013],{},[134,4081,4082],{"class":136,"line":1078},[134,4083,4018],{},[134,4085,4086],{"class":136,"line":1084},[134,4087,4088],{},"    Server-->>Browser: PUSH_PROMISE /style.css\n",[134,4090,4091],{"class":136,"line":1090},[134,4092,4093],{},"    Server-->>Browser: PUSH_PROMISE /app.js\n",[134,4095,4096],{"class":136,"line":3},[134,4097,4098],{},"    Server-->>Browser: (Push) style.css + app.js content\n",[134,4100,4101],{"class":136,"line":1205},[134,4102,829],{"emptyLinePlaceholder":828},[134,4104,4105],{"class":136,"line":1211},[134,4106,4107],{},"    Note over Browser: Browser receives proactive resource push\u003Cbr/>Reduces request rounds and first-screen latency\n",[17,4109,4110,4111,4116],{},"To minimize subsequent requests in HTTP/1.1, front-end developers have tried numerous optimization techniques. As Sukka mentioned in \"",[201,4112,4115],{"href":4113,"rel":4114},"https://blog.skk.moe/post/http2-server-push/",[205],"Static Resource Delivery Optimization: HTTP/2 and Server Push","\":",[574,4118,4119],{},[17,4120,4121],{},"The concepts of critical resources, critical rendering path, and critical request chain have existed for a long time. Asynchronous resource loading is old news: lazy-loading images, videos, iframes, and even lazy-loading CSS, JS, DOM, and lazy execution of functions. However, the approach to critical resource delivery hasn't changed much.",[17,4123,4124],{},"HTTP/2 Server Push created a new resource delivery paradigm. CSS/JS and other resources don't need to be delivered along with HTML to reach the client within one RTT, and these resources can be cached by the browser without being constrained by HTML's shorter TTL.",[27,4126,4128],{"id":4127},"initial-solution","Initial Solution",[17,4130,4131],{},"Having understood the advantages of HTTP/2 server push, I prepared to implement the optimization. My blog is purely static, using DNS for traffic splitting between domestic and international visitors: domestic traffic accesses a DMIT VPS with cmin2/9929 network optimization, served through Caddy; international traffic goes directly to Vercel, leveraging Amazon's CDN for global edge acceleration. The network architecture looks roughly like this:",[125,4133,4135],{"className":1046,"code":4134,"language":1048,"meta":130,"style":130},"graph TD\n    A[Blog Visitors] --> B[Initiate DNS Resolution]\n    B --> C[DNSPod Service]\n    C -->|Domestic Visitors: Smart Routing| D[Network-Optimized VPS]\n    C -->|International Visitors: Smart Routing| E[Vercel Platform]\n    D --> F[Caddy]\n    F --> G[Return Blog Content to Domestic Visitors]\n    E --> H[Return Blog Content to International Visitors]\n",[55,4136,4137,4142,4147,4152,4157,4162,4167,4172],{"__ignoreMap":130},[134,4138,4139],{"class":136,"line":137},[134,4140,4141],{},"graph TD\n",[134,4143,4144],{"class":136,"line":395},[134,4145,4146],{},"    A[Blog Visitors] --> B[Initiate DNS Resolution]\n",[134,4148,4149],{"class":136,"line":403},[134,4150,4151],{},"    B --> C[DNSPod Service]\n",[134,4153,4154],{"class":136,"line":832},[134,4155,4156],{},"    C -->|Domestic Visitors: Smart Routing| D[Network-Optimized VPS]\n",[134,4158,4159],{"class":136,"line":839},[134,4160,4161],{},"    C -->|International Visitors: Smart Routing| E[Vercel Platform]\n",[134,4163,4164],{"class":136,"line":1078},[134,4165,4166],{},"    D --> F[Caddy]\n",[134,4168,4169],{"class":136,"line":1084},[134,4170,4171],{},"    F --> G[Return Blog Content to Domestic Visitors]\n",[134,4173,4174],{"class":136,"line":1090},[134,4175,4176],{},"    E --> H[Return Blog Content to International Visitors]\n",[17,4178,4179,4180,4183,4184,433],{},"Caddy can implement HTTP/2 server push through the ",[55,4181,4182],{},"http.handlers.push"," module. We can write simple push logic in the Caddyfileâ€”no problem there. However, Vercel doesn't provide configuration options for HTTP/2 server push. Fortunately, since I have a static blog with low platform dependency, I considered migrating to Cloudflare Workers, ",[201,4185,4188],{"href":4186,"rel":4187},"https://brianli.com/cloudflare-workers-sites-http2-server-push/",[205],"which developers implemented five years ago",[27,4190,4192],{"id":4191},"client-support-status","Client Support Status",[17,4194,4195],{},"Historically, mainstream browser engines (Chrome/Chromium, Firefox, Edge, Safari) widely supported server push technology.",[17,4197,4198,4199,433],{},"In November 2020, Google announced ",[201,4200,4203],{"href":4201,"rel":4202},"https://groups.google.com/a/chromium.org/g/blink-dev/c/K3rYLvmQUBY/m/vOWBKZGoAQAJ",[205],"plans to remove server push functionality from Chrome's HTTP/2 and gQUIC (which later evolved into HTTP/3) implementations",[17,4205,4206,4207,4212],{},"In October 2022, Google announced ",[201,4208,4211],{"href":4209,"rel":4210},"https://developer.chrome.com/blog/removing-push/",[205],"plans to remove server push from Chrome",", citing poor real-world performance, low adoption rates, and better alternatives. Chrome 106 became the first version to disable server push by default.",[17,4214,4215,4216],{},"On October 29, 2024, Mozilla released Firefox 132, ",[201,4217,4220],{"href":4218,"rel":4219},"https://www.firefox.com/en-US/firefox/132.0/releasenotes/",[205],"removing support for HTTP/2 server push due to \"compatibility issues with multiple websites.\"",[17,4222,4223],{},"With this, mainstream browser support for HTTP/2 Server Push has completely ended. From initially being viewed as an innovative feature to \"reduce round-trip latency and optimize first-screen loading,\" to its eventual complete deprecation, HTTP/2 push's lifecycle lasted only a few short years, becoming an important experiment in web performance optimization history.",[27,4225,4227],{"id":4226},"alternative-solutions","Alternative Solutions",[100,4229,4231],{"id":4230},"_1-http-103-early-hints","1. HTTP 103 Early Hints",[17,4233,4234],{},"103 Early Hints is the most direct \"successor\" to server push. It's an informational HTTP status code that allows the server to send an \"early hint\" response with Link headers before generating the complete HTML response (e.g., status code 200 OK).",[17,4236,4237],{},"This Link header can tell the browser: \"Hey, I'm still preparing the main course (HTML), but you can start preparing the side dishes (CSS, JS) first.\" This way, the browser can utilize the server's \"thinking time\" to preemptively download critical resources or warm up connections to required origins, significantly reducing first-screen rendering time.",[17,4239,4240],{},"Compared to server push:",[32,4242,4243,4246],{},[35,4244,4245],{},"Decision authority lies with the client: Early Hints are just \"hints.\" The browser can decide whether to adopt them based on its own cache status, network conditions, and other factors. This solves server push's biggest pain pointâ€”servers cannot know about client caches, leading to redundant resource pushes.",[35,4247,4248],{},"Better compatibility: It's a lighter mechanism that's easier for intermediary proxy servers to understand and relay.",[17,4250,4251,4252,4255,4256,4259,4260,4263],{},"103 Early Hints is very meaningful for dynamic blogs. Before backend computation, the 103 response can inform the browser about needed resources, allowing the browser to retrieve other resources first while waiting for the backend to return the final HTML. However, ",[118,4253,4254],{},"for static blogs"," like mine where ",[118,4257,4258],{},"everything is pre-built",", it has ",[118,4261,4262],{},"absolutely no meaning",". The gateway has enough time to send the 103 response that it could just directly send the HTML instead.",[100,4265,4267],{"id":4266},"_2-resource-hints-preload-prefetch","2. Resource Hints: Preload & Prefetch",[17,4269,4270,4271,4274],{},"Even before server push was deprecated, resource hints implemented through ",[55,4272,4273],{},"\u003Clink>"," tags were already common tools for front-end performance optimization. They declare resource loading hints in HTML, with the browser leading the entire process.",[32,4276,4277,4283],{},[35,4278,4279,4282],{},[55,4280,4281],{},"\u003Clink rel=\"preload\">",": Tells the browser about resources that the current page will definitely use, requesting immediate high-priority loading without execution. For example, font files hidden deep in CSS or first-screen images dynamically loaded by JS. Through preload, you can ensure these critical resources are discovered and downloaded early, avoiding render blocking.",[35,4284,4285,4288],{},[55,4286,4287],{},"\u003Clink rel=\"prefetch\">",": Tells the browser about pages or resources the user might access in the future, requesting low-priority background downloads during browser idle time. For example, prefetching article page resources that users are most likely to click on the article list page, achieving near-\"instant\" navigation experience.",[17,4290,4291,4292,433],{},"Preload and Prefetch completely hand over resource loading control to developers and browsers. Through declarative methods, they allow fine-grained management of resource loading priority and timing. They are currently the most mature and widely applied resource preloading solutions, but still ",[118,4293,4294],{},"cannot escape the curse of 2 RTTs",[27,4296,4298],{"id":4297},"epilogue-an-elegy-for-an-idealist","Epilogue: An Elegy for an Idealist",[17,4300,4301],{},"In the end, I couldn't configure HTTP/2 server push for my blog.",[17,4303,4304],{},[118,4305,4306],{},"HTTP/2 Server Push has effectively \"died.\" I miss it.",[17,4308,4309],{},"In an ideal model, when the browser requests HTML, the server conveniently pushes the CSS and JS needed for rendering along with it, cleanly compressing what would originally be at least two round trips (RTT) into one. This is such a direct, such an elegant solutionâ€”almost the \"silver bullet\" that front-end engineers dream of when facing first-screen rendering latency issues. Behind it lies an ambitious spirit: attempting to thoroughly solve the \"critical request chain\" latency problem from the server side, once and for all.",[17,4311,4312],{},"But the Web world is ultimately not an ideal laboratory. It's full of caches, returning users, and all kinds of network environments.",[17,4314,4315],{},"The greatest charm of server push lies in its \"proactivity,\" and its greatest regret also stems precisely from this \"proactivity.\" It cannot know whether the browser's cache already quietly holds that style.css file it's preparing to enthusiastically push. For the sake of the ultimate experience for a small portion of first-time visitors, it might waste precious bandwidth for more returning users.",[17,4317,4318,4319,4322,4323,4326],{},"The Web's evolution ultimately chose a more prudent path with a more collaborative spirit. It returned decision-making authority to the browser, which knows the situation best. The entire interaction changed from the server's \"",[118,4320,4321],{},"I push to you","\" to the server's \"",[118,4324,4325],{},"I suggest you fetch",",\" with the browser making its own judgment. This may not be romantic enough, not extreme enough, but it's more universal and more robust.",[17,4328,4329],{},"So, I still miss that ambitious Server Push. It represented a pure pursuit of ultimate performance, a beautiful technical idealism. Although it has quietly faded from the historical stage, the dream about \"speed\" it pointed toward has long been inherited by 103 Early Hints and preload in a more mature, more balanced way.",[27,4331,1600],{"id":1599},[32,4333,4334,4341,4348,4354,4361,4367],{},[35,4335,4336],{},[201,4337,4340],{"href":4338,"rel":4339},"https://developer.chrome.com/blog/removing-push",[205],"Remove HTTP/2 Server Push from Chrome  |  Blog  |  Chrome for Developers",[35,4342,4343],{},[201,4344,4347],{"href":4345,"rel":4346},"https://en.wikipedia.org/wiki/HTTP/2_Server_Push",[205],"HTTP/2 Server Push - Wikipedia",[35,4349,4350],{},[201,4351,4353],{"href":4113,"rel":4352},[205],"é™æ€èµ„æºé€’é€ä¼˜åŒ–ï¼šHTTP/2 å’Œ Server Push | Sukka's Blog",[35,4355,4356],{},[201,4357,4360],{"href":4358,"rel":4359},"https://caddyserver.com/docs/modules/http.handlers.push",[205],"Module http.handlers.push - Caddy Documentation",[35,4362,4363],{},[201,4364,4366],{"href":4186,"rel":4365},[205],"How to Configure HTTP/2 Server Push on Cloudflare Workers Sites",[35,4368,4369],{},[201,4370,4372],{"href":4201,"rel":4371},[205],"Intent to Remove: HTTP/2 and gQUIC server push",[391,4374,3948],{},{"title":130,"searchDepth":395,"depth":395,"links":4376},[4377,4378,4379,4380,4384,4385],{"id":3973,"depth":395,"text":3974},{"id":4127,"depth":395,"text":4128},{"id":4191,"depth":395,"text":4192},{"id":4226,"depth":395,"text":4227,"children":4381},[4382,4383],{"id":4230,"depth":403,"text":4231},{"id":4266,"depth":403,"text":4267},{"id":4297,"depth":395,"text":4298},{"id":1599,"depth":395,"text":1600},{"title":4387,"date":4388,"path":4389,"tags":4390,"body":4394},"Array Field Filtering Challenges and Performance Optimization in Nuxt Content v3","2025-10-20 21:52:59","/2025/10/20/nuxt-content-v3-z-array-query-challenge",[4391,4392,4393],"Nuxt","Nuxt Content","JavaScript",{"type":14,"value":4395,"toc":5400},[4396,4411,4414,4465,4472,4476,4486,4605,4620,4795,4804,4814,4818,4821,5091,5101,5118,5124,5129,5133,5144,5161,5167,5181,5351,5354,5362,5368,5374,5379,5381,5388,5397],[17,4397,4398,4399,4402,4403,4406,4407,4410],{},"Nuxt Content is a powerful module in the Nuxt ecosystem for handling Markdown, YAML, and other content types. Recently, while migrating my blog from Hexo to ",[118,4400,4401],{},"Nuxt v4 + Nuxt Content v3",", I encountered a tricky issue: the v3 default query API ",[118,4404,4405],{},"does not directly provide"," support for \"contains\" (",[55,4408,4409],{},"$contains",") operations on array fields.",[17,4412,4413],{},"For example, here's the Front Matter of the blog post I'm currently writing:",[125,4415,4419],{"className":4416,"code":4417,"language":4418,"meta":130,"style":130},"language-markdown shiki shiki-themes one-light one-dark-pro","---\ntitle: Array Field Filtering Challenges in Nuxt Content v3\ndate: 2025-10-20 21:52:59\nsticky:\ntags:\n- Nuxt\n- Nuxt Content\n- JavaScript\n---\n","markdown",[55,4420,4421,4426,4431,4436,4441,4446,4451,4456,4461],{"__ignoreMap":130},[134,4422,4423],{"class":136,"line":137},[134,4424,4425],{},"---\n",[134,4427,4428],{"class":136,"line":395},[134,4429,4430],{},"title: Array Field Filtering Challenges in Nuxt Content v3\n",[134,4432,4433],{"class":136,"line":403},[134,4434,4435],{},"date: 2025-10-20 21:52:59\n",[134,4437,4438],{"class":136,"line":832},[134,4439,4440],{},"sticky:\n",[134,4442,4443],{"class":136,"line":839},[134,4444,4445],{},"tags:\n",[134,4447,4448],{"class":136,"line":1078},[134,4449,4450],{},"- Nuxt\n",[134,4452,4453],{"class":136,"line":1084},[134,4454,4455],{},"- Nuxt Content\n",[134,4457,4458],{"class":136,"line":1090},[134,4459,4460],{},"- JavaScript\n",[134,4462,4463],{"class":136,"line":3},[134,4464,4425],{},[17,4466,4467,4468,4471],{},"My goal was to create a ",[118,4469,4470],{},"Tag page"," that lists all articles containing a specific tag (e.g., 'Nuxt').",[27,4473,4475],{"id":4474},"the-convenience-of-v2-and-the-limitations-of-v3","The Convenience of v2 and the Limitations of v3",[17,4477,4478,4479,4482,4483,4485],{},"In Nuxt Content v2, data was stored based on the file system, and the query approach abstracted file content with a syntax similar to ",[118,4480,4481],{},"MongoDB's JSON document queries",". We could easily use the ",[55,4484,4409],{}," method to retrieve all articles with the \"Nuxt\" tag:",[125,4487,4491],{"className":4488,"code":4489,"language":4490,"meta":130,"style":130},"language-typescript shiki shiki-themes one-light one-dark-pro","const tag = decodeURIComponent(route.params.tag as string)\n\nconst articles = await queryContent('posts')\n  .where({ tags: { $contains: tag } })  // âœ… MongoDB-style queries in v2\n  .find()\n","typescript",[55,4492,4493,4535,4539,4561,4595],{"__ignoreMap":130},[134,4494,4495,4498,4502,4505,4508,4510,4514,4516,4520,4522,4525,4529,4533],{"class":136,"line":137},[134,4496,4497],{"class":2219},"const",[134,4499,4501],{"class":4500},"sNmU0"," tag",[134,4503,4504],{"class":1232}," =",[134,4506,4507],{"class":140}," decodeURIComponent",[134,4509,2023],{"class":814},[134,4511,4513],{"class":4512},"s7GmK","route",[134,4515,433],{"class":814},[134,4517,4519],{"class":4518},"s2QsP","params",[134,4521,433],{"class":814},[134,4523,4524],{"class":811},"tag",[134,4526,4528],{"class":4527},"sblXP"," as",[134,4530,4532],{"class":4531},"sN9Y4"," string",[134,4534,2062],{"class":814},[134,4536,4537],{"class":136,"line":395},[134,4538,829],{"emptyLinePlaceholder":828},[134,4540,4541,4543,4546,4548,4551,4554,4556,4559],{"class":136,"line":403},[134,4542,4497],{"class":2219},[134,4544,4545],{"class":4500}," articles",[134,4547,4504],{"class":1232},[134,4549,4550],{"class":2219}," await",[134,4552,4553],{"class":140}," queryContent",[134,4555,2023],{"class":814},[134,4557,4558],{"class":144},"'posts'",[134,4560,2062],{"class":814},[134,4562,4563,4566,4569,4572,4575,4579,4582,4584,4586,4589,4592],{"class":136,"line":832},[134,4564,4565],{"class":814},"  .",[134,4567,4568],{"class":140},"where",[134,4570,4571],{"class":814},"({ ",[134,4573,4574],{"class":811},"tags",[134,4576,4578],{"class":4577},"st7oF",":",[134,4580,4581],{"class":814}," { ",[134,4583,4409],{"class":811},[134,4585,4578],{"class":4577},[134,4587,4501],{"class":4588},"sz0mV",[134,4590,4591],{"class":814}," } })  ",[134,4593,4594],{"class":1953},"// âœ… MongoDB-style queries in v2\n",[134,4596,4597,4599,4602],{"class":136,"line":839},[134,4598,4565],{"class":814},[134,4600,4601],{"class":140},"find",[134,4603,4604],{"class":814},"()\n",[17,4606,4607,4608,4615,4616,4619],{},"However, when using ",[118,4609,4610,4611,4614],{},"Nuxt Content v3's ",[55,4612,4613],{},"queryCollection"," API",", we naturally try to use the ",[55,4617,4618],{},".where()"," method for filtering:",[125,4621,4623],{"className":4488,"code":4622,"language":4490,"meta":130,"style":130},"const tag = decodeURIComponent(route.params.tag as string)\n\nconst { data } = await useAsyncData(`tag-${tag}`, () =>\n    queryCollection('posts')\n        .where(tag, 'in', 'tags')  // âŒ This will error because the first parameter must be a field name\n        .order('date', 'DESC')\n        .select('title', 'date', 'path', 'tags')\n        .all()\n)\n",[55,4624,4625,4653,4657,4697,4708,4736,4755,4782,4791],{"__ignoreMap":130},[134,4626,4627,4629,4631,4633,4635,4637,4639,4641,4643,4645,4647,4649,4651],{"class":136,"line":137},[134,4628,4497],{"class":2219},[134,4630,4501],{"class":4500},[134,4632,4504],{"class":1232},[134,4634,4507],{"class":140},[134,4636,2023],{"class":814},[134,4638,4513],{"class":4512},[134,4640,433],{"class":814},[134,4642,4519],{"class":4518},[134,4644,433],{"class":814},[134,4646,4524],{"class":811},[134,4648,4528],{"class":4527},[134,4650,4532],{"class":4531},[134,4652,2062],{"class":814},[134,4654,4655],{"class":136,"line":395},[134,4656,829],{"emptyLinePlaceholder":828},[134,4658,4659,4661,4663,4666,4669,4671,4673,4676,4678,4681,4684,4686,4688,4691,4694],{"class":136,"line":403},[134,4660,4497],{"class":2219},[134,4662,4581],{"class":814},[134,4664,4665],{"class":4500},"data",[134,4667,4668],{"class":814}," } ",[134,4670,1977],{"class":1232},[134,4672,4550],{"class":2219},[134,4674,4675],{"class":140}," useAsyncData",[134,4677,2023],{"class":814},[134,4679,4680],{"class":144},"`tag-",[134,4682,2268],{"class":4683},"sAOjX",[134,4685,4524],{"class":4588},[134,4687,2274],{"class":4683},[134,4689,4690],{"class":144},"`",[134,4692,4693],{"class":814},", () ",[134,4695,4696],{"class":2219},"=>\n",[134,4698,4699,4702,4704,4706],{"class":136,"line":832},[134,4700,4701],{"class":140},"    queryCollection",[134,4703,2023],{"class":814},[134,4705,4558],{"class":144},[134,4707,2062],{"class":814},[134,4709,4710,4713,4715,4717,4719,4722,4725,4727,4730,4733],{"class":136,"line":839},[134,4711,4712],{"class":814},"        .",[134,4714,4568],{"class":140},[134,4716,2023],{"class":814},[134,4718,4524],{"class":4588},[134,4720,4721],{"class":814},", ",[134,4723,4724],{"class":144},"'in'",[134,4726,4721],{"class":814},[134,4728,4729],{"class":144},"'tags'",[134,4731,4732],{"class":814},")  ",[134,4734,4735],{"class":1953},"// âŒ This will error because the first parameter must be a field name\n",[134,4737,4738,4740,4743,4745,4748,4750,4753],{"class":136,"line":1078},[134,4739,4712],{"class":814},[134,4741,4742],{"class":140},"order",[134,4744,2023],{"class":814},[134,4746,4747],{"class":144},"'date'",[134,4749,4721],{"class":814},[134,4751,4752],{"class":144},"'DESC'",[134,4754,2062],{"class":814},[134,4756,4757,4759,4762,4764,4767,4769,4771,4773,4776,4778,4780],{"class":136,"line":1084},[134,4758,4712],{"class":814},[134,4760,4761],{"class":140},"select",[134,4763,2023],{"class":814},[134,4765,4766],{"class":144},"'title'",[134,4768,4721],{"class":814},[134,4770,4747],{"class":144},[134,4772,4721],{"class":814},[134,4774,4775],{"class":144},"'path'",[134,4777,4721],{"class":814},[134,4779,4729],{"class":144},[134,4781,2062],{"class":814},[134,4783,4784,4786,4789],{"class":136,"line":1090},[134,4785,4712],{"class":814},[134,4787,4788],{"class":140},"all",[134,4790,4604],{"class":814},[134,4792,4793],{"class":136,"line":3},[134,4794,2062],{"class":814},[17,4796,4797,4798,4800,4801,433],{},"Unfortunately, this approach doesn't work. The ",[55,4799,4618],{}," method signature requires the field name as the first parameter: ",[55,4802,4803],{},"where(field: keyof Collection | string, operator: SqlOperator, value?: unknown)",[17,4805,4806,4807,4810,4811,4813],{},"Since Nuxt Content v3 ",[118,4808,4809],{},"uses SQLite as its underlying local database",", all queries must follow SQL-like syntax. If the design doesn't provide built-in operators for array fields (such as an SQL equivalent of ",[55,4812,4409],{},"), the eventual solution often feels somewhat \"awkward.\"",[27,4815,4817],{"id":4816},"initial-implementation-sacrificing-performance-with-fetch-all","Initial Implementation: Sacrificing Performance with \"Fetch All\"",[17,4819,4820],{},"Following a \"migrate quickly, optimize later\" approach, I wrote the following code:",[125,4822,4824],{"className":4488,"code":4823,"language":4490,"meta":130,"style":130},"// Initial implementation: fetch all and filter with JS\nconst allPosts = (\n    await useAsyncData(`tag-${route.params.tag}`, () =>\n        queryCollection('posts')\n            .order('date', 'DESC')\n            .select('title', 'date', 'path', 'tags')\n            .all()\n    )\n).data as Ref\u003CPost[]>\n\nconst Posts = computed(() => {\n    return allPosts.value.filter(post =>\n        typeof post.tags?.map === 'function'\n            ? post.tags?.includes(decodeURIComponent(route.params.tag as string))\n            : false\n    )\n})\n",[55,4825,4826,4831,4843,4875,4886,4903,4927,4935,4940,4961,4965,4985,5010,5035,5074,5082,5086],{"__ignoreMap":130},[134,4827,4828],{"class":136,"line":137},[134,4829,4830],{"class":1953},"// Initial implementation: fetch all and filter with JS\n",[134,4832,4833,4835,4838,4840],{"class":136,"line":395},[134,4834,4497],{"class":2219},[134,4836,4837],{"class":140}," allPosts",[134,4839,4504],{"class":1232},[134,4841,4842],{"class":814}," (\n",[134,4844,4845,4848,4850,4852,4854,4856,4858,4861,4863,4865,4867,4869,4871,4873],{"class":136,"line":403},[134,4846,4847],{"class":2219},"    await",[134,4849,4675],{"class":140},[134,4851,2023],{"class":814},[134,4853,4680],{"class":144},[134,4855,2268],{"class":4683},[134,4857,4513],{"class":4512},[134,4859,433],{"class":4860},"sMj0N",[134,4862,4519],{"class":4518},[134,4864,433],{"class":4860},[134,4866,4524],{"class":811},[134,4868,2274],{"class":4683},[134,4870,4690],{"class":144},[134,4872,4693],{"class":814},[134,4874,4696],{"class":2219},[134,4876,4877,4880,4882,4884],{"class":136,"line":832},[134,4878,4879],{"class":140},"        queryCollection",[134,4881,2023],{"class":814},[134,4883,4558],{"class":144},[134,4885,2062],{"class":814},[134,4887,4888,4891,4893,4895,4897,4899,4901],{"class":136,"line":839},[134,4889,4890],{"class":814},"            .",[134,4892,4742],{"class":140},[134,4894,2023],{"class":814},[134,4896,4747],{"class":144},[134,4898,4721],{"class":814},[134,4900,4752],{"class":144},[134,4902,2062],{"class":814},[134,4904,4905,4907,4909,4911,4913,4915,4917,4919,4921,4923,4925],{"class":136,"line":1078},[134,4906,4890],{"class":814},[134,4908,4761],{"class":140},[134,4910,2023],{"class":814},[134,4912,4766],{"class":144},[134,4914,4721],{"class":814},[134,4916,4747],{"class":144},[134,4918,4721],{"class":814},[134,4920,4775],{"class":144},[134,4922,4721],{"class":814},[134,4924,4729],{"class":144},[134,4926,2062],{"class":814},[134,4928,4929,4931,4933],{"class":136,"line":1084},[134,4930,4890],{"class":814},[134,4932,4788],{"class":140},[134,4934,4604],{"class":814},[134,4936,4937],{"class":136,"line":1090},[134,4938,4939],{"class":814},"    )\n",[134,4941,4942,4944,4946,4948,4952,4955,4958],{"class":136,"line":3},[134,4943,3661],{"class":814},[134,4945,4665],{"class":811},[134,4947,4528],{"class":4527},[134,4949,4951],{"class":4950},"sC09Y"," Ref",[134,4953,4954],{"class":814},"\u003C",[134,4956,4957],{"class":4950},"Post",[134,4959,4960],{"class":814},"[]>\n",[134,4962,4963],{"class":136,"line":1205},[134,4964,829],{"emptyLinePlaceholder":828},[134,4966,4967,4969,4972,4974,4977,4980,4983],{"class":136,"line":1211},[134,4968,4497],{"class":2219},[134,4970,4971],{"class":4500}," Posts",[134,4973,4504],{"class":1232},[134,4975,4976],{"class":140}," computed",[134,4978,4979],{"class":814},"(() ",[134,4981,4982],{"class":2219},"=>",[134,4984,2226],{"class":814},[134,4986,4987,4990,4992,4994,4997,4999,5002,5004,5007],{"class":136,"line":1217},[134,4988,4989],{"class":2219},"    return",[134,4991,4837],{"class":4512},[134,4993,433],{"class":814},[134,4995,4996],{"class":4518},"value",[134,4998,433],{"class":814},[134,5000,5001],{"class":140},"filter",[134,5003,2023],{"class":814},[134,5005,5006],{"class":2245},"post",[134,5008,5009],{"class":2219}," =>\n",[134,5011,5012,5016,5019,5021,5023,5026,5029,5032],{"class":136,"line":1222},[134,5013,5015],{"class":5014},"s7DPa","        typeof",[134,5017,5018],{"class":4512}," post",[134,5020,433],{"class":814},[134,5022,4574],{"class":4518},[134,5024,5025],{"class":814},"?.",[134,5027,5028],{"class":811},"map",[134,5030,5031],{"class":1232}," ===",[134,5033,5034],{"class":144}," 'function'\n",[134,5036,5037,5040,5042,5044,5046,5048,5051,5053,5056,5058,5060,5062,5064,5066,5068,5070,5072],{"class":136,"line":1241},[134,5038,5039],{"class":5014},"            ?",[134,5041,5018],{"class":4512},[134,5043,433],{"class":814},[134,5045,4574],{"class":4518},[134,5047,5025],{"class":814},[134,5049,5050],{"class":140},"includes",[134,5052,2023],{"class":814},[134,5054,5055],{"class":140},"decodeURIComponent",[134,5057,2023],{"class":814},[134,5059,4513],{"class":4512},[134,5061,433],{"class":814},[134,5063,4519],{"class":4518},[134,5065,433],{"class":814},[134,5067,4524],{"class":811},[134,5069,4528],{"class":4527},[134,5071,4532],{"class":4531},[134,5073,2965],{"class":814},[134,5075,5076,5079],{"class":136,"line":1248},[134,5077,5078],{"class":5014},"            :",[134,5080,5081],{"class":154}," false\n",[134,5083,5084],{"class":136,"line":1253},[134,5085,4939],{"class":814},[134,5087,5088],{"class":136,"line":1264},[134,5089,5090],{"class":814},"})\n",[17,5092,5093,5094],{},"While this method met the requirements, it came with obvious performance costs: ",[118,5095,5096,5097,5100],{},"bloated ",[55,5098,5099],{},"_payload.json"," file sizes.",[17,5102,5103,5104,5106,5107,5110,5111,5114,5115,5117],{},"In Nuxt projects, ",[55,5105,5099],{}," stores dynamic data such as ",[55,5108,5109],{},"useAsyncData"," results. With the fetch-all approach, ",[118,5112,5113],{},"every Tag page"," loads a ",[55,5116,5099],{}," containing information for all articles, causing data redundancy. Many tag pages only need data for one or two articles but are forced to load information for all articles, severely impacting performance.",[17,5119,5120],{},[62,5121],{"alt":5122,"src":5123},"The tags directory occupies 2.9MiB, the largest of all directories","https://static.031130.xyz/uploads/2025/10/20/a748878c03c64.webp",[17,5125,5126],{},[62,5127],{"alt":5099,"src":5128},"https://static.031130.xyz/uploads/2025/10/20/8ef786d873da1.webp",[27,5130,5132],{"id":5131},"a-clever-solution-leveraging-sqlites-storage-characteristics-for-optimization","A Clever Solution: Leveraging SQLite's Storage Characteristics for Optimization",[17,5134,5135,5136,5138,5139,433],{},"To reduce the query results returned by ",[55,5137,5109],{},", I searched through Nuxt Content's GitHub Discussions and found ",[201,5140,5143],{"href":5141,"rel":5142},"https://github.com/nuxt/content/discussions/2955",[205],"a \"clever\" solution proposed during v3.alpha.8",[17,5145,5146,5147,5156,5157,5160],{},"Since Nuxt Content v3 uses an SQLite database, the ",[118,5148,5149,5151,5152,5155],{},[55,5150,4574],{}," array originally defined in Front Matter (via ",[55,5153,5154],{},"z.array()",") is ultimately stored as a JSON string"," in the database (you can view the exact format in the ",[55,5158,5159],{},".nuxt/content/sql_dump.txt"," file).",[17,5162,5163],{},[62,5164],{"alt":5165,"src":5166},"sql_dump.txt","https://static.031130.xyz/uploads/2025/10/20/b70036c55bb29.webp",[17,5168,5169,5170,5173,5174,5180],{},"This means we can leverage SQLite's ",[118,5171,5172],{},"string operation"," features by using the ",[118,5175,5176,5179],{},[55,5177,5178],{},"LIKE"," operator with wildcards"," to perform array containment filtering, essentially querying whether the JSON string contains a specific substring:",[125,5182,5184],{"className":4488,"code":5183,"language":4490,"meta":130,"style":130},"const tag = decodeURIComponent(route.params.tag as string)\n\nconst { data } = await useAsyncData(`tag-${route.params.tag}`, () =>\n    queryCollection('posts')\n        .where('tags', 'LIKE', `%\"${tag}\"%`)\n        .order('date', 'DESC')\n        .select('title', 'date', 'path', 'tags')\n        .all()\n)\n",[55,5185,5186,5214,5218,5258,5268,5299,5315,5339,5347],{"__ignoreMap":130},[134,5187,5188,5190,5192,5194,5196,5198,5200,5202,5204,5206,5208,5210,5212],{"class":136,"line":137},[134,5189,4497],{"class":2219},[134,5191,4501],{"class":4500},[134,5193,4504],{"class":1232},[134,5195,4507],{"class":140},[134,5197,2023],{"class":814},[134,5199,4513],{"class":4512},[134,5201,433],{"class":814},[134,5203,4519],{"class":4518},[134,5205,433],{"class":814},[134,5207,4524],{"class":811},[134,5209,4528],{"class":4527},[134,5211,4532],{"class":4531},[134,5213,2062],{"class":814},[134,5215,5216],{"class":136,"line":395},[134,5217,829],{"emptyLinePlaceholder":828},[134,5219,5220,5222,5224,5226,5228,5230,5232,5234,5236,5238,5240,5242,5244,5246,5248,5250,5252,5254,5256],{"class":136,"line":403},[134,5221,4497],{"class":2219},[134,5223,4581],{"class":814},[134,5225,4665],{"class":4500},[134,5227,4668],{"class":814},[134,5229,1977],{"class":1232},[134,5231,4550],{"class":2219},[134,5233,4675],{"class":140},[134,5235,2023],{"class":814},[134,5237,4680],{"class":144},[134,5239,2268],{"class":4683},[134,5241,4513],{"class":4512},[134,5243,433],{"class":4860},[134,5245,4519],{"class":4518},[134,5247,433],{"class":4860},[134,5249,4524],{"class":811},[134,5251,2274],{"class":4683},[134,5253,4690],{"class":144},[134,5255,4693],{"class":814},[134,5257,4696],{"class":2219},[134,5259,5260,5262,5264,5266],{"class":136,"line":832},[134,5261,4701],{"class":140},[134,5263,2023],{"class":814},[134,5265,4558],{"class":144},[134,5267,2062],{"class":814},[134,5269,5270,5272,5274,5276,5278,5280,5283,5285,5288,5290,5292,5294,5297],{"class":136,"line":839},[134,5271,4712],{"class":814},[134,5273,4568],{"class":140},[134,5275,2023],{"class":814},[134,5277,4729],{"class":144},[134,5279,4721],{"class":814},[134,5281,5282],{"class":144},"'LIKE'",[134,5284,4721],{"class":814},[134,5286,5287],{"class":144},"`%\"",[134,5289,2268],{"class":4683},[134,5291,4524],{"class":4588},[134,5293,2274],{"class":4683},[134,5295,5296],{"class":144},"\"%`",[134,5298,2062],{"class":814},[134,5300,5301,5303,5305,5307,5309,5311,5313],{"class":136,"line":1078},[134,5302,4712],{"class":814},[134,5304,4742],{"class":140},[134,5306,2023],{"class":814},[134,5308,4747],{"class":144},[134,5310,4721],{"class":814},[134,5312,4752],{"class":144},[134,5314,2062],{"class":814},[134,5316,5317,5319,5321,5323,5325,5327,5329,5331,5333,5335,5337],{"class":136,"line":1084},[134,5318,4712],{"class":814},[134,5320,4761],{"class":140},[134,5322,2023],{"class":814},[134,5324,4766],{"class":144},[134,5326,4721],{"class":814},[134,5328,4747],{"class":144},[134,5330,4721],{"class":814},[134,5332,4775],{"class":144},[134,5334,4721],{"class":814},[134,5336,4729],{"class":144},[134,5338,2062],{"class":814},[134,5340,5341,5343,5345],{"class":136,"line":1090},[134,5342,4712],{"class":814},[134,5344,4788],{"class":140},[134,5346,4604],{"class":814},[134,5348,5349],{"class":136,"line":3},[134,5350,2062],{"class":814},[17,5352,5353],{},"Below are the file sizes after optimization and regeneration - the reduction is quite significant:",[32,5355,5356,5359],{},[35,5357,5358],{},"Tags directory size: 2.9MiB â†’ 1.4MiB",[35,5360,5361],{},"Individual _payload.json size: 23.1KiB â†’ 1.01 KiB",[17,5363,5364,5365,5367],{},"Through this method, we successfully pushed the query logic down to the database layer, avoided unnecessary full data transfers, significantly reduced the size of ",[55,5366,5099],{}," in individual directories, and achieved performance optimization.",[17,5369,5370],{},[62,5371],{"alt":5372,"src":5373},"Tags directory size reduction","https://static.031130.xyz/uploads/2025/10/20/007e72e7b476d.webp",[17,5375,5376],{},[62,5377],{"alt":5099,"src":5378},"https://static.031130.xyz/uploads/2025/10/20/17ba3ccbbdf9e.webp",[27,5380,1600],{"id":1599},[17,5382,5383],{},[201,5384,5387],{"href":5385,"rel":5386},"https://content.nuxt.com/docs/utils/query-collection#wherefield-keyof-collection-string-operator-sqloperator-value-unknown",[205],"queryCollection - Nuxt Content",[17,5389,5390],{},[201,5391,5393,5394,5396],{"href":5141,"rel":5392},[205],"How do you query ",[55,5395,5154],{}," fields (e.g. tags) in the latest nuxt-content module (v3.alpha.8) Â· nuxt/content Â· Discussion #2955",[391,5398,5399],{},"html .default .shiki span {color: var(--shiki-default);background: var(--shiki-default-bg);font-style: var(--shiki-default-font-style);font-weight: var(--shiki-default-font-weight);text-decoration: var(--shiki-default-text-decoration);}html .shiki span {color: var(--shiki-default);background: var(--shiki-default-bg);font-style: var(--shiki-default-font-style);font-weight: var(--shiki-default-font-weight);text-decoration: var(--shiki-default-text-decoration);}html .dark .shiki span {color: var(--shiki-dark);background: var(--shiki-dark-bg);font-style: var(--shiki-dark-font-style);font-weight: var(--shiki-dark-font-weight);text-decoration: var(--shiki-dark-text-decoration);}html.dark .shiki span {color: var(--shiki-dark);background: var(--shiki-dark-bg);font-style: var(--shiki-dark-font-style);font-weight: var(--shiki-dark-font-weight);text-decoration: var(--shiki-dark-text-decoration);}html pre.shiki code .sLKXg, html code.shiki .sLKXg{--shiki-default:#A626A4;--shiki-dark:#C678DD}html pre.shiki code .sNmU0, html code.shiki .sNmU0{--shiki-default:#986801;--shiki-dark:#E5C07B}html pre.shiki code .s_Sar, html code.shiki .s_Sar{--shiki-default:#0184BC;--shiki-dark:#56B6C2}html pre.shiki code .sAdtL, html code.shiki .sAdtL{--shiki-default:#4078F2;--shiki-dark:#61AFEF}html pre.shiki code .s5ixo, html code.shiki .s5ixo{--shiki-default:#383A42;--shiki-dark:#ABB2BF}html pre.shiki code .s7GmK, html code.shiki .s7GmK{--shiki-default:#383A42;--shiki-dark:#E5C07B}html pre.shiki code .s2QsP, html code.shiki .s2QsP{--shiki-default:#E45649;--shiki-dark:#E5C07B}html pre.shiki code .sJa8x, html code.shiki .sJa8x{--shiki-default:#E45649;--shiki-dark:#E06C75}html pre.shiki code .sblXP, html code.shiki .sblXP{--shiki-default:#383A42;--shiki-dark:#C678DD}html pre.shiki code .sN9Y4, html code.shiki .sN9Y4{--shiki-default:#0184BC;--shiki-dark:#E5C07B}html pre.shiki code .sDhpE, html code.shiki .sDhpE{--shiki-default:#50A14F;--shiki-dark:#98C379}html pre.shiki code .st7oF, html code.shiki .st7oF{--shiki-default:#0184BC;--shiki-dark:#ABB2BF}html pre.shiki code .sz0mV, html code.shiki .sz0mV{--shiki-default:#383A42;--shiki-dark:#E06C75}html pre.shiki code .sW2Sy, html code.shiki .sW2Sy{--shiki-default:#A0A1A7;--shiki-default-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic}html pre.shiki code .sAOjX, html code.shiki .sAOjX{--shiki-default:#CA1243;--shiki-dark:#C678DD}html pre.shiki code .sMj0N, html code.shiki .sMj0N{--shiki-default:#50A14F;--shiki-dark:#ABB2BF}html pre.shiki code .sC09Y, html code.shiki .sC09Y{--shiki-default:#C18401;--shiki-dark:#E5C07B}html pre.shiki code .s8iYz, html code.shiki .s8iYz{--shiki-default:#383A42;--shiki-default-font-style:inherit;--shiki-dark:#E06C75;--shiki-dark-font-style:italic}html pre.shiki code .s7DPa, html code.shiki .s7DPa{--shiki-default:#0184BC;--shiki-dark:#C678DD}html pre.shiki code .sAGMh, html code.shiki .sAGMh{--shiki-default:#986801;--shiki-dark:#D19A66}",{"title":130,"searchDepth":395,"depth":395,"links":5401},[5402,5403,5404,5405],{"id":4474,"depth":395,"text":4475},{"id":4816,"depth":395,"text":4817},{"id":5131,"depth":395,"text":5132},{"id":1599,"depth":395,"text":1600},{"title":5407,"date":5408,"path":5409,"tags":5410,"body":5417},"Post-OCSP Era: How Browsers Address New Certificate Revocation Challenges","2025-10-16 15:38:50","/2025/10/16/how-s-mozilla-crlite-going-now",[5411,5412,5413,5414,5415,5416],"SSL","Firefox","Web PKI","OCSP","CRLSets","CRLite",{"type":14,"value":5418,"toc":5770},[5419,5422,5431,5440,5451,5456,5460,5470,5473,5480,5490,5497,5501,5508,5512,5515,5518,5529,5533,5536,5545,5565,5568,5572,5575,5588,5591,5615,5634,5637,5644,5647,5650,5654,5657,5679,5686,5692,5694],[17,5420,5421],{},"In August 2023, the CA/Browser Forum passed a vote eliminating the requirement for publicly trusted CAs like Let's Encrypt to maintain OCSP servers.",[17,5423,5424,5425,5430],{},"In July 2024, Let's Encrypt published a ",[201,5426,5429],{"href":5427,"rel":5428},"https://letsencrypt.org/2024/07/23/replacing-ocsp-with-crls",[205],"blog post"," disclosing its plans to shut down its OCSP server.",[17,5432,5433,5434,5439],{},"In December of the same year, Let's Encrypt released ",[201,5435,5438],{"href":5436,"rel":5437},"https://letsencrypt.org/2024/12/05/ending-ocsp",[205],"a timeline for shutting down its OCSP server",", with the following key dates:",[32,5441,5442,5445,5448],{},[35,5443,5444],{},"January 30, 2025 - Let's Encrypt will no longer accept new certificate issuance requests containing the OCSP Must-Staple extension, unless your account has previously requested such certificates",[35,5446,5447],{},"May 7, 2025 - Newly issued certificates from Let's Encrypt will include CRL URLs but will no longer contain OCSP URLs, and all new certificate issuance requests with the OCSP Must-Staple extension will be rejected",[35,5449,5450],{},"August 6, 2025 - Let's Encrypt will shut down its OCSP servers",[17,5452,5453],{},[118,5454,5455],{},"Let's Encrypt is the world's largest free SSL certificate authority, and this move marks our gradual transition into the post-OCSP era.",[27,5457,5459],{"id":5458},"ocsps-dilemma-the-trade-off-between-performance-and-privacy","OCSP's Dilemma: The Trade-off Between Performance and Privacy",[17,5461,5462,5463,5466,5467,433],{},"Behind Let's Encrypt's decision lies long-accumulated dissatisfaction with OCSP (Online Certificate Status Protocol). OCSP, as a method for real-time certificate validity queries, had a beautiful initial vision: when a browser accesses a website, it can send a brief request to the ",[118,5464,5465],{},"CA's (Certificate Authority's)"," OCSP server, asking whether the certificate is still valid. This seemed much more efficient than downloading a massive ",[118,5468,5469],{},"CRL (Certificate Revocation List)",[17,5471,5472],{},"However, OCSP has exposed numerous flaws in practical application:",[17,5474,5475,5476,5479],{},"First is the ",[118,5477,5478],{},"performance issue",". Although individual requests are small, when millions of users simultaneously access websites, OCSP servers must handle massive amounts of real-time queries. This not only creates enormous server pressure for CAs but also increases latency for users accessing websites. If OCSP servers respond slowly or even crash, browsers may interrupt connections due to inability to confirm certificate status, or have to \"turn a blind eye\" for the sake of user experience, both of which undermine OCSP's security.",[17,5481,5482,5483,5486,5487],{},"More seriously is the ",[118,5484,5485],{},"privacy issue",". Each OCSP query essentially reports the user's browsing behavior to the CA. This means the CA can know when a user accessed which website. While OCSP queries themselves don't contain personally identifiable information, by combining this information with data like IP addresses, CAs can completely build profiles of users' browsing habits. For privacy-conscious users and developers, this \"silent surveillance\" is unacceptable. ",[118,5488,5489],{},"Even if CAs intentionally don't retain this information, regional laws may force CAs to collect it.",[17,5491,5492,5493,5496],{},"Furthermore, OCSP has ",[118,5494,5495],{},"security flaws"," in its design. Due to concerns about connection timeouts affecting user experience, browsers typically default to a soft-fail mechanism: if they cannot connect to the OCSP server, they choose to allow rather than block the connection. Attackers can exploit this by blocking communication between the client and OCSP server, causing queries to always timeout, thus easily bypassing certificate status verification.",[100,5498,5500],{"id":5499},"ocsp-stapling","OCSP Stapling",[17,5502,5503,5504,433],{},"Based on these flaws, we have the OCSP stapling solution, which ",[201,5505,5507],{"href":5506},"/2024/11/19/firefox-is-the-only-mainstream-brower-doing-online-certificate-revocation-checks/#OCSP-%E8%A3%85%E8%AE%A2-OCSP-stapling","I covered in last year's blog post, feel free to review",[100,5509,5511],{"id":5510},"ocsp-must-staple","OCSP Must-Staple",[17,5513,5514],{},"OCSP Must-Staple is an extension option when applying for SSL certificates. This extension tells the browser: if it recognizes this extension in the certificate, it must not send query requests to the certificate authority, but should obtain the stapled copy during the handshake phase. If a valid copy cannot be obtained, the browser should refuse the connection.",[17,5516,5517],{},"This feature gave browser developers the courage for hard-fail, but before OCSP faded from history, Let's Encrypt seemed to be the only mainstream CA supporting this extension, and this feature was not widely used.",[17,5519,5520,5523,5524,433],{},[267,5521,5522],{},"I originally didn't want to introduce this feature (because literally no one used it), but considering this thing is about to be buried, let's erect a monument for it on the Chinese internet,"," for more information, refer to ",[201,5525,5528],{"href":5526,"rel":5527},"https://letsencrypt.org/2024/12/05/ending-ocsp#must-staple",[205],"Let's Encrypt's blog",[27,5530,5532],{"id":5531},"chromiums-solution-taking-only-a-ladle-from-three-thousand-waters","Chromium's Solution: Taking Only a Ladle from Three Thousand Waters",[17,5534,5535],{},"OCSP's privacy and performance issues are no secret, and browser vendors have long begun their own explorations. In 2012, Chrome disabled CRLs and OCSP checks by default, turning to its own self-designed certificate verification mechanism.",[17,5537,5538,5539,5544],{},"It's well known that revocation lists can be extremely large. If browsers needed to download and parse a complete global revocation list, it would be a performance disaster (Mozilla's team mentioned in ",[201,5540,5543],{"href":5541,"rel":5542},"https://hacks.mozilla.org/2025/08/crlite-fast-private-and-comprehensive-certificate-revocation-checking-in-firefox/",[205],"this year's blog"," that file sizes from downloading 3000 active CRLs would reach 300MB). Through analyzing historical data, the Chromium team discovered that most revoked certificates belong to a few high-risk categories, such as the certificate authority (CA) itself being compromised, or certificates from certain large websites being revoked. Based on this insight, CRLSets adopts the following strategy:",[310,5546,5547,5553,5559],{},[35,5548,5549,5552],{},[118,5550,5551],{},"Tiered Revocation",": Chromium doesn't download all revoked certificate information, but rather the Google team maintains a streamlined list containing the \"most important\" revocation information. This list is regularly updated and pushed to users through Chrome browser updates.",[35,5554,5555,5558],{},[118,5556,5557],{},"Streamlined Efficiency",": This list is very small in size, currently about 600KB. It contains certificates that would cause large-scale security incidents if abused, such as CA intermediate certificates, or certificates from some well-known websites (like Google, Facebook).",[35,5560,5561,5564],{},[118,5562,5563],{},"Sacrificing Partial Security",": The disadvantage of this approach is also obviousâ€”it cannot cover all certificate revocation situations. For an ordinary website's revoked certificate, CRLSets likely cannot detect it. According to Mozilla's blog this year, CRLSets only contains 1%-2% of unexpired revoked certificate information.",[17,5566,5567],{},"While CRLSets is an \"imperfect\" solution, it has found a balance between performance and usability. It ensures basic security for users accessing mainstream websites while avoiding the performance and privacy overhead brought by OCSP. For Chromium, rather than pursuing an OCSP solution that's difficult to implement perfectly in reality, it's better to concentrate efforts on solving the most urgent security threats.",[27,5569,5571],{"id":5570},"firefoxs-solution-from-crls-to-crlite","Firefox's Solution: From CRLs to CRLite",[17,5573,5574],{},"Unlike Chromium's \"taking only a ladle\" strategy, Firefox developers have been searching for a solution that can guarantee comprehensiveness while solving performance issues.",[17,5576,5577,5578,5580,5581,5584,5585,433],{},"To solve this problem, Mozilla proposed an innovative solution: ",[118,5579,5416],{},". CRLite's design philosophy is to use data structures like ",[118,5582,5583],{},"hash functions and Bloom filters"," to compress massive certificate revocation lists into a ",[118,5586,5587],{},"compact, downloadable, and easily locally verifiable format",[17,5589,5590],{},"CRLite's working principle can be simply summarized as:",[310,5592,5593,5599,5609],{},[35,5594,5595,5598],{},[118,5596,5597],{},"Data Compression",": CAs periodically generate lists of all their revoked certificates.",[35,5600,5601,5604,5605,5608],{},[118,5602,5603],{},"Server Processing",": Mozilla's servers collect these lists and use techniques like cryptographic hash functions and Bloom filters to ",[118,5606,5607],{},"encode"," all revoked certificate information into a very compact data structure.",[35,5610,5611,5614],{},[118,5612,5613],{},"Client Verification",": The browser downloads this compressed file, and when accessing a website, it only needs to perform hash calculations on the certificate locally, then query this local file to quickly determine whether the certificate has been revoked.",[17,5616,5617,5618,5621,5622,5625,5626,5629,5630,5633],{},"Compared to CRLSets, CRLite's advantage is that it can achieve ",[118,5619,5620],{},"comprehensive coverage of all revoked certificates"," while maintaining an ",[118,5623,5624],{},"extremely small size",". More importantly, it ",[118,5627,5628],{},"completes verification entirely locally",", which means the browser ",[118,5631,5632],{},"doesn't need to send requests to any third-party servers",", thus completely solving OCSP's privacy problem.",[17,5635,5636],{},"Firefox's current strategy performs incremental updates to CRLite data every 12 hours, with daily downloads of approximately 300KB; it performs a full snapshot sync every 45 days, with downloads of approximately 4MB.",[17,5638,5639,5640],{},"Mozilla has opened their data dashboard, where you can find recent CRLite data sizes: ",[201,5641,5642],{"href":5642,"rel":5643},"https://yardstick.mozilla.org/dashboard/snapshot/c1WZrxGkNxdm9oZp7xVvGUEFJCELfApN",[205],[17,5645,5646],{},"Starting with Firefox Desktop version 137 released on April 1, 2025, Firefox began gradually replacing OCSP validation with CRLite; on August 19 of the same year, Firefox Desktop 142 officially deprecated OCSP verification for DV certificates.",[17,5648,5649],{},"CRLite has become the core solution for Firefox's future certificate revocation verification, representing a comprehensive pursuit of performance, privacy, and security.",[27,5651,5653],{"id":5652},"outlook-for-the-post-ocsp-era","Outlook for the Post-OCSP Era",[17,5655,5656],{},"With major CAs like Let's Encrypt shutting down OCSP services, the OCSP era is rapidly drawing to a close. We can see that browser vendors have already begun exploring more efficient and secure alternative solutions.",[32,5658,5659,5668],{},[35,5660,5661,5664,5665,433],{},[118,5662,5663],{},"Chromium",", with its CRLSets solution, has achieved a pragmatic balance between ",[118,5666,5667],{},"performance and critical security guarantees",[35,5669,5670,5672,5673,5675,5676,433],{},[118,5671,5412],{},", through the technological innovation of ",[118,5674,5416],{},", attempts to find the optimal solution among ",[118,5677,5678],{},"comprehensiveness, privacy, and performance",[17,5680,5681,5682,5685],{},"What these solutions have in common is: ",[118,5683,5684],{},"transforming certificate revocation verification from real-time online queries (OCSP) to localized verification",", thereby avoiding OCSP's inherent performance bottlenecks and privacy risks.",[17,5687,5688,5689],{},"In the future, the certificate revocation ecosystem will no longer rely on a single, centralized OCSP server. Instead, a more diverse, distributed, and intelligent new era is arriving. ",[118,5690,5691],{},"OCSP as a technology may gradually be phased out, but the core security problem of \"certificate revocation\" that it attempted to solve will forever remain a focus of browsers and the network security community.",[27,5693,1600],{"id":1599},[32,5695,5696,5702,5709,5716,5723,5729,5735,5742,5749,5756,5763],{},[35,5697,5698],{},[201,5699,5701],{"href":5541,"rel":5700},[205],"CRLite: Fast, private, and comprehensive certificate revocation checking in Firefox - Mozilla Hacks - the Web developer blog",[35,5703,5704],{},[201,5705,5708],{"href":5706,"rel":5707},"https://www.feistyduck.com/newsletter/issue_121_the_slow_death_of_ocsp",[205],"The Slow Death of OCSP | Feisty Duck",[35,5710,5711],{},[201,5712,5715],{"href":5713,"rel":5714},"https://github.com/mozilla/crlite",[205],"mozilla/crlite: Compact certificate revocation lists for the WebPKI",[35,5717,5718],{},[201,5719,5722],{"href":5720,"rel":5721},"https://letsencrypt.org/2025/08/06/ocsp-service-has-reached-end-of-life",[205],"OCSP Service Has Reached End of Life - Let's Encrypt",[35,5724,5725],{},[201,5726,5728],{"href":5436,"rel":5727},[205],"Ending OCSP Support in 2025 - Let's Encrypt",[35,5730,5731],{},[201,5732,5734],{"href":5427,"rel":5733},[205],"Intent to End OCSP Service - Let's Encrypt",[35,5736,5737],{},[201,5738,5741],{"href":5739,"rel":5740},"https://www.chromium.org/Home/chromium-security/crlsets/",[205],"CRLSets - The Chromium Projects",[35,5743,5744],{},[201,5745,5748],{"href":5746,"rel":5747},"https://www.pcworld.com/article/474296/google_chrome_will_no_longer_check_for_revoked_ssl_certificates_online-2.html",[205],"Google Chrome Will No Longer Check for Revoked SSL Certificates Online | PCWorld",[35,5750,5751],{},[201,5752,5755],{"href":5753,"rel":5754},"https://www.zdnet.com/article/chrome-does-certificate-revocation-better/",[205],"Chrome does certificate revocation better | ZDNET",[35,5757,5758],{},[201,5759,5762],{"href":5760,"rel":5761},"https://www.hats-land.com/WIP/2025-technical-and-analysis-of-mainstream-clientbrowser-certificate-revocation-verification-mechanism.html",[205],"ä¸»æµå®¢æˆ·ç«¯/æµè§ˆå™¨è¯ä¹¦åŠé”€éªŒè¯æœºåˆ¶æŠ€æœ¯å¯¹ä¸Žåˆ†æž | å¸½ä¹‹å²›, Hat's Land",[35,5764,5765],{},[201,5766,5769],{"href":5767,"rel":5768},"https://blog.gslin.org/archives/2025/02/02/12239/ocsp-%E7%9A%84%E6%B7%A1%E5%87%BA/",[205],"OCSP çš„æ·¡å‡ºâ€¦ â€“ Gea-Suan Lin's BLOG",{"title":130,"searchDepth":395,"depth":395,"links":5771},[5772,5776,5777,5778,5779],{"id":5458,"depth":395,"text":5459,"children":5773},[5774,5775],{"id":5499,"depth":403,"text":5500},{"id":5510,"depth":403,"text":5511},{"id":5531,"depth":395,"text":5532},{"id":5570,"depth":395,"text":5571},{"id":5652,"depth":395,"text":5653},{"id":1599,"depth":395,"text":1600},{"title":5781,"date":5782,"path":5783,"tags":5784,"body":5789},"First Experience with GitHub Action Self-hosted Runner: Love is Not Easy","2025-09-05 05:54:17","/2025/09/05/first-try-of-github-action-self-hosted-runner",[5785,5786,5787,5788],"Github","Github Action","CI/CD","Experience",{"type":14,"value":5790,"toc":5989},[5791,5806,5809,5820,5824,5827,5830,5835,5838,5843,5846,5851,5856,5859,5864,5867,5872,5876,5879,5906,5910,5917,5922,5939,5957,5964,5968,5979,5986],[17,5792,5793,5794,5799,5800,5805],{},"In August of this year, a GitHub Organization I'm part of frequently triggered CI during private project development, exhausting the ",[201,5795,5798],{"href":5796,"rel":5797},"https://docs.github.com/en/get-started/learning-about-github/githubs-plans#github-free-for-organizations",[205],"2,000 minutes of monthly Action quota"," provided by GitHub for the Free Plan (shared across all private repositories, public repositories don't count). After reviewing the CI workflow setup, which seemed reasonable, I needed to find alternative solutions to provide more generous resources. This led me to explore the ",[201,5801,5804],{"href":5802,"rel":5803},"https://docs.github.com/en/actions/concepts/runners/self-hosted-runners",[205],"GitHub Action Self-hosted Runner"," mentioned in the article title.",[17,5807,5808],{},"Compared to GitHub's official runners, Self-hosted Runners offer several key advantages:",[32,5810,5811,5814,5817],{},[35,5812,5813],{},"Unlimited Action runtime for private repositories",[35,5815,5816],{},"Ability to configure more powerful hardware computing power and memory",[35,5818,5819],{},"Access to internal network environments, facilitating communication with intranet/LAN devices",[27,5821,5823],{"id":5822},"configuration-and-installation","Configuration and Installation",[17,5825,5826],{},"Since I wasn't sure about the network environment requirements, I directly chose an idle Hong Kong VPS for this test, with specs of 4 cores, 4GB RAM, 80GB disk, and 1Gbps bandwidth. Aside from somewhat lacking disk read/write performance, everything else was maxed out.",[17,5828,5829],{},"The configuration of Self-hosted Runner itself is quite straightforward and clear, following the official guidelines without any issues.",[17,5831,5832],{},[62,5833],{"alt":130,"src":5834},"https://static.031130.xyz/uploads/2025/09/05/7c0475cdb1aa9.webp",[17,5836,5837],{},"All three mainstream platforms are supported, and if utilized properly, it should cover a range of needs including iPhone app packaging.",[17,5839,5840],{},[62,5841],{"alt":130,"src":5842},"https://static.031130.xyz/uploads/2025/09/05/96ff7cb263da1.webp",[17,5844,5845],{},"Looking at the runner installation file I received, version 2.328.0, the compressed package is around 220MB and includes built-in node20 and node24 runtime environments, two versions each.",[17,5847,5848],{},[62,5849],{"alt":130,"src":5850},"https://static.031130.xyz/uploads/2025/09/05/f775e3bcd2cdc.webp",[17,5852,5853],{},[62,5854],{"alt":130,"src":5855},"https://static.031130.xyz/uploads/2025/09/05/d0d4fe4611a40.webp",[17,5857,5858],{},"After executing config.sh, a svc.sh file appears in the current directory, which can be used to leverage systemd for process management and similar needs.",[17,5860,5861],{},[62,5862],{"alt":130,"src":5863},"https://static.031130.xyz/uploads/2025/09/05/43c6b19038def.webp",[17,5865,5866],{},"Refreshing the web page again shows that the Self-hosted Runner is now online.",[17,5868,5869],{},[62,5870],{"alt":130,"src":5871},"https://static.031130.xyz/uploads/2025/09/05/6dad15beff900.webp",[27,5873,5875],{"id":5874},"specifying-actions-to-use-your-own-runner","Specifying Actions to Use Your Own Runner",[17,5877,5878],{},"This step is simple - just change the runs-on field in the original Action's yml file:",[125,5880,5884],{"className":5881,"code":5882,"language":5883,"meta":130,"style":130},"language-diff shiki shiki-themes one-light one-dark-pro","jobs:\n  run:\n+    runs-on: self-hosted\n-    runs-on: ubuntu-latest\n","diff",[55,5885,5886,5891,5896,5901],{"__ignoreMap":130},[134,5887,5888],{"class":136,"line":137},[134,5889,5890],{"class":814},"jobs:\n",[134,5892,5893],{"class":136,"line":395},[134,5894,5895],{"class":814},"  run:\n",[134,5897,5898],{"class":136,"line":403},[134,5899,5900],{"class":144},"+    runs-on: self-hosted\n",[134,5902,5903],{"class":136,"line":832},[134,5904,5905],{"class":811},"-    runs-on: ubuntu-latest\n",[27,5907,5909],{"id":5908},"real-world-testing","Real-World Testing",[17,5911,5912,5913,5916],{},"When I excitedly switched the CI workflow from GitHub's official runner to the self-hosted runner, problems quickly surfaced, and this is the main reason I \"can't love it.\" The issues were concentrated in the ",[55,5914,5915],{},"setup-python"," GitHub Action Flow, which is maintained by GitHub officially, showing an error that version 3.12 wasn't found.",[17,5918,5919],{},[62,5920],{"alt":130,"src":5921},"https://static.031130.xyz/uploads/2025/09/05/1c93947170a85.webp",[17,5923,5924,5925,5928,5929,5932,5933,5938],{},"In GitHub's official virtual environment, these Actions prepare the specified version of the development environment for us. For example, ",[55,5926,5927],{},"uses: actions/setup-python"," combined with ",[55,5930,5931],{},"with: python-version: '3.12'"," automatically installs and configures Python 3.12.x in the environment. I had grown accustomed to this and considered it an \"out-of-the-box\" feature. However, on Self-hosted Runner, the situation is somewhat different. The setup-python ",[201,5934,5937],{"href":5935,"rel":5936},"https://github.com/actions/setup-python/blob/main/docs/advanced-usage.md#using-setup-python-with-a-self-hosted-runner",[205],"documentation"," states:",[574,5940,5941],{},[17,5942,5943,5944,5949,5950,5953,5954,5956],{},"Python distributions are only available for the same ",[201,5945,5948],{"href":5946,"rel":5947},"https://github.com/actions/runner-images#available-images",[205],"environments"," that GitHub Actions hosted environments are available for. If you are using an unsupported version of Ubuntu such as ",[55,5951,5952],{},"19.04"," or another Linux distribution such as Fedora, ",[55,5955,5915],{}," may not work.",[17,5958,5959,5960,5963],{},"The setup-python Action ",[118,5961,5962],{},"only supports the same operating systems used by GitHub Actions",", and my VPS's Debian is not supported, hence this error, which also sealed Debian's fate.",[27,5965,5967],{"id":5966},"the-root-cause-misunderstanding-self-hosted-runner","The Root Cause: Misunderstanding Self-hosted Runner",[17,5969,5970,5971,5974,5975,5978],{},"I subconsciously believed that Self-hosted Runner merely transferred the computational cost from GitHub's servers to local infrastructure, and that official standard actions like ",[55,5972,5973],{},"actions/setup-python"," should elegantly download, install, and configure everything I need, just like in GitHub-hosted Runners. However, ",[118,5976,5977],{},"the essence of Self-hosted Runner is simply receiving tasks from GitHub and executing instructions within the current operating system environment",", without guaranteeing consistency with the runtime environment provided by GitHub's official Runners.",[17,5980,5981,5982,5985],{},"Self-hosted Runner is not an out-of-the-box \"service,\" but rather ",[118,5983,5984],{},"\"infrastructure\" that you need to personally manage",". You are responsible for server installation, configuration, security updates, dependency management, disk cleanup, and a series of operational tasks. It's more suitable for teams or individuals with advanced CI/CD requirements: such as heavy CI/CD consumers, teams needing specific hardware (like ARM, GPU) for builds, or enterprises whose CI workflows deeply depend on internal network resources. For ordinary developers like me who simply want to provide more local computing resources to gain more Action runtime, the operational mental burden it brings seems a bit heavy.",[391,5987,5988],{},"html pre.shiki code .s5ixo, html code.shiki .s5ixo{--shiki-default:#383A42;--shiki-dark:#ABB2BF}html pre.shiki code .sDhpE, html code.shiki .sDhpE{--shiki-default:#50A14F;--shiki-dark:#98C379}html pre.shiki code .sJa8x, html code.shiki .sJa8x{--shiki-default:#E45649;--shiki-dark:#E06C75}html .default .shiki span {color: var(--shiki-default);background: var(--shiki-default-bg);font-style: var(--shiki-default-font-style);font-weight: var(--shiki-default-font-weight);text-decoration: var(--shiki-default-text-decoration);}html .shiki span {color: var(--shiki-default);background: var(--shiki-default-bg);font-style: var(--shiki-default-font-style);font-weight: var(--shiki-default-font-weight);text-decoration: var(--shiki-default-text-decoration);}html .dark .shiki span {color: var(--shiki-dark);background: var(--shiki-dark-bg);font-style: var(--shiki-dark-font-style);font-weight: var(--shiki-dark-font-weight);text-decoration: var(--shiki-dark-text-decoration);}html.dark .shiki span {color: var(--shiki-dark);background: var(--shiki-dark-bg);font-style: var(--shiki-dark-font-style);font-weight: var(--shiki-dark-font-weight);text-decoration: var(--shiki-dark-text-decoration);}",{"title":130,"searchDepth":395,"depth":395,"links":5990},[5991,5992,5993,5994],{"id":5822,"depth":395,"text":5823},{"id":5874,"depth":395,"text":5875},{"id":5908,"depth":395,"text":5909},{"id":5966,"depth":395,"text":5967},"/",1771553309294]