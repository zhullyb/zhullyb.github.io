[{"data":1,"prerenderedAt":969},["ShallowReactive",2],{"post-2025-07-05-node-sass-migration-to-dart-sass":3,"surround-2025-07-05-node-sass-migration-to-dart-sass":957,"randomIndex/2025/07/05/node-sass-migration-to-dart-sass/":968},{"id":4,"title":5,"body":6,"date":942,"description":126,"extension":943,"meta":944,"navigation":507,"path":945,"rawbody":946,"seo":947,"stem":948,"sticky":949,"tags":950,"__hash__":956},"posts/posts/node-sass-migration-to-dart-sass.md","node-sass 迁移至 dart-sass 踩坑实录",{"type":7,"value":8,"toc":920},"minimark",[9,13,26,30,47,50,83,86,91,95,99,108,111,120,187,190,193,196,228,237,240,244,248,277,281,414,418,427,467,471,474,542,545,549,552,555,582,585,628,637,642,646,655,663,715,718,775,778,802,805,808,916],[10,11,12],"h2",{"id":12},"更新目标",[14,15,16,20,23],"ul",{},[17,18,19],"li",{},"node-sass -> sass ( dart-sass )",[17,21,22],{},"减少影响面，非必要不更新其他依赖的版本",[17,24,25],{},"在前两条基础上，看看能否提升 node.js 的版本",[10,27,29],{"id":28},"抛弃-node-sass-的理由","抛弃 node-sass 的理由",[14,31,32,41,44],{},[17,33,34],{},[35,36,40],"a",{"href":37,"rel":38},"https://sass-lang.com/blog/libsass-is-deprecated/",[39],"nofollow","node-sass 已经停止维护，dart-sass 是 sass 官方主推的继任者",[17,42,43],{},"node-sass 在 windows 下的安装非常麻烦，npm 安装时需要开发机上同时装有 python2 和 Microsoft Visual C++",[17,45,46],{},"在安装 node-sass 时，需要从 Github 拉取资源，在特定网络环境下成功率并不高",[10,48,49],{"id":49},"项目依赖版本现状",[14,51,52,58,63,68,73,78],{},[17,53,54],{},[55,56,57],"code",{},"node@^12",[17,59,60],{},[55,61,62],{},"vue@^2",[17,64,65],{},[55,66,67],{},"webpack@^3",[17,69,70],{},[55,71,72],{},"vue-loader@^14",[17,74,75],{},[55,76,77],{},"sass-loader@^7.0.3",[17,79,80],{},[55,81,82],{},"node-sass@^4",[10,84,85],{"id":85},"更新思路",[87,88,90],"h3",{"id":89},"nodejs","node.js",[92,93,94],"p",{},"webpack 官方并没有提供 webpack 3 支持的最高 node 版本，且即使 webpack 官方支持，webpack 的相关插件也未必支持。因此 node 版本能否更新就只能自己试。好在尽管这个项目的 CI/CD 跑在 node 12，但我日常都在用 node 14 开发，因此顺势将 node 版本提升至 14。",[87,96,98],{"id":97},"webpacksass-loader","webpack、sass-loader",[92,100,101,102,107],{},"webpack 的版本目前处于非必要不更新的定时炸弹状态，基于现有的 webpack 3 限制，所支持的最高 sass-loader 版本就是 ^7 （ sass-loader 在 ",[35,103,106],{"href":104,"rel":105},"https://github.com/webpack-contrib/sass-loader/blob/v8.0.0/CHANGELOG.md",[39],"8.0.0 版本的更新日志","中明确指出 8.0.0 版本需要 webpack 4.36.0）。",[92,109,110],{},"如果项目中 sass-loader@^7 支持使用 dart-sass 就可以不更新 sass-loader，也就不必更新 webpack 版本；反之，就需要同步更新 webpack 至 4，再视情况定下 sass-loader 的版本。",[92,112,113,114,119],{},"那么到底支不支持呢？我在 ",[35,115,118],{"href":116,"rel":117},"https://www.webpackjs.com/loaders/sass-loader/",[39],"webpack 官方文档介绍 sass-loader 的页面","找到了这样一段 package.json 片段",[121,122,127],"pre",{"className":123,"code":124,"language":125,"meta":126,"style":126},"language-json shiki shiki-themes github-light github-dark","{\n  \"devDependencies\": {\n    \"sass-loader\": \"^7.2.0\",\n    \"sass\": \"^1.22.10\"\n  }\n}\n","json","",[55,128,129,138,148,164,175,181],{"__ignoreMap":126},[130,131,134],"span",{"class":132,"line":133},"line",1,[130,135,137],{"class":136},"sVt8B","{\n",[130,139,141,145],{"class":132,"line":140},2,[130,142,144],{"class":143},"sj4cs","  \"devDependencies\"",[130,146,147],{"class":136},": {\n",[130,149,151,154,157,161],{"class":132,"line":150},3,[130,152,153],{"class":143},"    \"sass-loader\"",[130,155,156],{"class":136},": ",[130,158,160],{"class":159},"sZZnC","\"^7.2.0\"",[130,162,163],{"class":136},",\n",[130,165,167,170,172],{"class":132,"line":166},4,[130,168,169],{"class":143},"    \"sass\"",[130,171,156],{"class":136},[130,173,174],{"class":159},"\"^1.22.10\"\n",[130,176,178],{"class":132,"line":177},5,[130,179,180],{"class":136},"  }\n",[130,182,184],{"class":132,"line":183},6,[130,185,186],{"class":136},"}\n",[92,188,189],{},"这证明起码在 sass-loader@7.2.0 这一版本就已经支持 dart-sass 了，因此 webpack 版本可以停留在 ^3，而 sass-loader 暂时停留在 7.0.3 版本，如果后续有问题可以更新到 ^7 版本中最新的 7.3.1 版本。",[87,191,192],{"id":192},"dart-sass",[92,194,195],{},"sass-loader@^7 所支持的最高 sass 我并没有查到，Github Copilot 信誓旦旦地告诉我",[197,198,199,205,210,215],"blockquote",{},[92,200,201],{},[202,203,204],"strong",{},"官方文档引用：",[197,206,207],{},[92,208,209],{},"sass-loader@^7.0.0 requires node-sass >=4.0.0 or sass >=1.3.0, \u003C=1.26.5.",[92,211,212],{},[202,213,214],{},"建议：",[14,216,217],{},[17,218,219,220,223,224,227],{},"如果需要使用更高版本的 ",[55,221,222],{},"sass","，请升级到 ",[55,225,226],{},"sass-loader"," 8 或更高版本。",[92,229,230,231,236],{},"但事实上，我并没有在互联网上找到这段文本的蛛丝马迹。并且在 sass 的 ~1.26 版本中最后一个版本是 1.26.11 而非 1.26.5，",[35,232,235],{"href":233,"rel":234},"https://docs.npmjs.com/about-semantic-versioning",[39],"根据常见的 npm 版本号原则","，major version 和 minor version 不变，只改变了 patch version 的发版一般只有 bugfix 而没有 breaking change，不至于从 1.26.5 更新到 1.26.11 就突然不支持 sass-loader 7 了，因此更可能是 AI 幻觉或者是训练数据受限。",[92,238,239],{},"出于谨慎考虑，最终决定采用 webpack 官方文档中提到的 sass 1.22 的最后一个版本，也就是 1.22.12。",[10,241,243],{"id":242},"分析完成动手更新","分析完成，动手更新",[87,245,247],{"id":246},"第一步卸载-node-sass安装-sass12212","第一步，卸载 node-sass，安装 sass@^1.22.12",[121,249,253],{"className":250,"code":251,"language":252,"meta":126,"style":126},"language-bash shiki shiki-themes github-light github-dark","npm uninstall node-sass\nnpm install sass@^1.22.12\n","bash",[55,254,255,267],{"__ignoreMap":126},[130,256,257,261,264],{"class":132,"line":133},[130,258,260],{"class":259},"sScJk","npm",[130,262,263],{"class":159}," uninstall",[130,265,266],{"class":159}," node-sass\n",[130,268,269,271,274],{"class":132,"line":140},[130,270,260],{"class":259},[130,272,273],{"class":159}," install",[130,275,276],{"class":159}," sass@^1.22.12\n",[87,278,280],{"id":279},"第二步更新-webpack-配置非必须","第二步，更新 webpack 配置（非必须）",[121,282,286],{"className":283,"code":284,"language":285,"meta":126,"style":126},"language-diff shiki shiki-themes github-light github-dark","module.exports = {\n  // ...\n  module: {\n    rules: [\n      {\n        test: /\\.(scss|sass)$/,\n        use: [\n          'style-loader',\n          'css-loader',\n          {\n            loader: 'sass-loader',\n+            options: {\n+                // 事实上，这一行在大部分 sass-loader 版本中不用加，sass-loader 能自动检测本地是 sass 还是 node-sass\n+                implementation: require('sass')\n+              },\n            },\n          },\n        ],\n      },\n    ],\n  },\n};\n","diff",[55,287,288,293,298,303,308,313,318,324,330,336,342,348,354,360,366,372,378,384,390,396,402,408],{"__ignoreMap":126},[130,289,290],{"class":132,"line":133},[130,291,292],{},"module.exports = {\n",[130,294,295],{"class":132,"line":140},[130,296,297],{},"  // ...\n",[130,299,300],{"class":132,"line":150},[130,301,302],{},"  module: {\n",[130,304,305],{"class":132,"line":166},[130,306,307],{},"    rules: [\n",[130,309,310],{"class":132,"line":177},[130,311,312],{},"      {\n",[130,314,315],{"class":132,"line":183},[130,316,317],{},"        test: /\\.(scss|sass)$/,\n",[130,319,321],{"class":132,"line":320},7,[130,322,323],{},"        use: [\n",[130,325,327],{"class":132,"line":326},8,[130,328,329],{},"          'style-loader',\n",[130,331,333],{"class":132,"line":332},9,[130,334,335],{},"          'css-loader',\n",[130,337,339],{"class":132,"line":338},10,[130,340,341],{},"          {\n",[130,343,345],{"class":132,"line":344},11,[130,346,347],{},"            loader: 'sass-loader',\n",[130,349,351],{"class":132,"line":350},12,[130,352,353],{},"+            options: {\n",[130,355,357],{"class":132,"line":356},13,[130,358,359],{},"+                // 事实上，这一行在大部分 sass-loader 版本中不用加，sass-loader 能自动检测本地是 sass 还是 node-sass\n",[130,361,363],{"class":132,"line":362},14,[130,364,365],{},"+                implementation: require('sass')\n",[130,367,369],{"class":132,"line":368},15,[130,370,371],{},"+              },\n",[130,373,375],{"class":132,"line":374},16,[130,376,377],{},"            },\n",[130,379,381],{"class":132,"line":380},17,[130,382,383],{},"          },\n",[130,385,387],{"class":132,"line":386},18,[130,388,389],{},"        ],\n",[130,391,393],{"class":132,"line":392},19,[130,394,395],{},"      },\n",[130,397,399],{"class":132,"line":398},20,[130,400,401],{},"    ],\n",[130,403,405],{"class":132,"line":404},21,[130,406,407],{},"  },\n",[130,409,411],{"class":132,"line":410},22,[130,412,413],{},"};\n",[87,415,417],{"id":416},"第三步批量替换-deep-语法为-v-deep","第三步，批量替换 /deep/ 语法为 ::v-deep",[92,419,420,421,426],{},"因为 ",[35,422,425],{"href":423,"rel":424},"https://chromestatus.com/feature/4964279606312960",[39],"/deep/ 写法在 2017 年被弃用"," ，/deep/ 变成了不受支持的深度作用选择器，node-sass 凭借其出色的容错性能够继续提供兼容，但 dart-sass 则不支持这种写法。于是需要将 /deep/ 语法批量替换成 ::v-deep 写法，这种写法虽然在 vue 的后续 rfc 被放弃了，但直至今日依然在事实上被支持。",[121,428,430],{"className":250,"code":429,"language":252,"meta":126,"style":126},"# 大概就是这么个意思，用 vscode 的批量替换其实也行\nsed -i 's#\\s*/deep/\\s*# ::v-deep #g' $(grep -rl '/deep/' .)\n",[55,431,432,438],{"__ignoreMap":126},[130,433,434],{"class":132,"line":133},[130,435,437],{"class":436},"sJ8bj","# 大概就是这么个意思，用 vscode 的批量替换其实也行\n",[130,439,440,443,446,449,452,455,458,461,464],{"class":132,"line":140},[130,441,442],{"class":259},"sed",[130,444,445],{"class":143}," -i",[130,447,448],{"class":159}," 's#\\s*/deep/\\s*# ::v-deep #g'",[130,450,451],{"class":136}," $(",[130,453,454],{"class":259},"grep",[130,456,457],{"class":143}," -rl",[130,459,460],{"class":159}," '/deep/'",[130,462,463],{"class":159}," .",[130,465,466],{"class":136},")\n",[87,468,470],{"id":469},"第四步修复其他-sass-语法错误","第四步，修复其他 sass 语法错误",[92,472,473],{},"在迁移的过程中，我发现项目中有一些不规范的写法，node-sass 凭借出色的鲁棒性不吭一声强行解析，而 dart-sass 则干不了这粗活。因此需要根据编译时的报错手动修复一下这些语法错误，我这里一共遇到两种。",[121,475,477],{"className":283,"code":476,"language":285,"meta":126,"style":126},"// 多打了一个冒号\n.foo {\n-  color:: #fff;\n+  color: #fff;\n}\n\n// :nth-last-child 没指定数字\n.bar {\n-  &:nth-last-child() {\n+  &:nth-last-child(1) {\n      margin-bottom: 0;\n  }\n}\n",[55,478,479,484,489,494,499,503,509,514,519,524,529,534,538],{"__ignoreMap":126},[130,480,481],{"class":132,"line":133},[130,482,483],{},"// 多打了一个冒号\n",[130,485,486],{"class":132,"line":140},[130,487,488],{},".foo {\n",[130,490,491],{"class":132,"line":150},[130,492,493],{},"-  color:: #fff;\n",[130,495,496],{"class":132,"line":166},[130,497,498],{},"+  color: #fff;\n",[130,500,501],{"class":132,"line":177},[130,502,186],{},[130,504,505],{"class":132,"line":183},[130,506,508],{"emptyLinePlaceholder":507},true,"\n",[130,510,511],{"class":132,"line":320},[130,512,513],{},"// :nth-last-child 没指定数字\n",[130,515,516],{"class":132,"line":326},[130,517,518],{},".bar {\n",[130,520,521],{"class":132,"line":332},[130,522,523],{},"-  &:nth-last-child() {\n",[130,525,526],{"class":132,"line":338},[130,527,528],{},"+  &:nth-last-child(1) {\n",[130,530,531],{"class":132,"line":344},[130,532,533],{},"      margin-bottom: 0;\n",[130,535,536],{"class":132,"line":350},[130,537,180],{},[130,539,540],{"class":132,"line":356},[130,541,186],{},[10,543,544],{"id":544},"踩坑",[87,546,548],{"id":547},"v-deep-样式不生效","::v-deep 样式不生效",[92,550,551],{},"依赖更新完后看了两眼好像是没问题，就推测试环境了。结果一天没到就被同事 call 了，::v-deep 这种深度作用选择器居然没有生效？",[92,553,554],{},"抱着试一试的态度，GPT 给了如下回答",[197,556,557],{},[92,558,559,560,563,564,567,568,574,575,578,579,581],{},"在 ",[202,561,562],{},"Vue 2 + vue-loader + Sass"," 的组合下，",[202,565,566],{},"这种写法是正确的","，",[202,569,570,571],{},"前提是你的构建工具链支持 ",[55,572,573],{},"::v-deep"," 语法（如 ",[55,576,577],{},"vue-loader@15"," 及以上版本 + ",[55,580,226],{},"）。",[92,583,584],{},"虽说我依然没有查证到为什么更新 vue-loader@15 才能使用 ::v-deep 语法，但对 vue-loader 进行更新后，::v-deep 语法确实生效了。在撰写本文时，我找到了些许蛛丝马迹，可能能解释这一问题。",[586,587,588,603],"ol",{},[17,589,590,591,596,597,602],{},"vue-loader 在 ",[35,592,595],{"href":593,"rel":594},"https://vue-loader-v14.vuejs.org/en/features/scoped-css.html#deep-selectors",[39],"14 版本的官方文档","就是没有 ::v-deep 写法的示例，",[35,598,601],{"href":599,"rel":600},"https://github.com/vuejs/vue-loader/commit/2585d254fc774386a898887467fbdd30eb864b53",[39],"这一示例一直在 vue-loader 15.7.0 版本发布后才被加入","。",[17,604,605,606,613,616,617,622,623],{},"vue-cli 的 Github Issue 评论区中有人提到",[197,607,608],{},[92,609,610,612],{},[55,611,573],{}," implemented in @vue/component-compiler-utils v2.6.0, should work after you reinstall the deps.",[614,615],"br",{},"而 vue-loader 在 15.0.0-beta.1 版本才",[35,618,621],{"href":619,"rel":620},"https://github.com/vuejs/vue-loader/commit/e32cd0e4372fcc6f13b6c307402713807516d71c#diff-7ae45ad102eab3b6d7e7896acd08c427a9b25b346470d7bc6507b6481575d519",[39],"将 @vue/component-compiler-utils 加入到自己的 dependencies 中","，并直到 vue-loader 15.7.1 中才",[35,624,627],{"href":625,"rel":626},"https://github.com/vuejs/vue-loader/commit/c359a38db0fbb4135fc97114baec3cd557d4123a",[39],"将其 @vue/component-compiler-utils 的版本号更新到满足要求的 ^3.0.0",[92,629,630,631,636],{},"那能否升级到 vue-loader 16 甚至 17 版本呢？不行，在 ",[35,632,635],{"href":633,"rel":634},"https://github.com/vuejs/vue-loader/releases/tag/v16.1.2",[39],"vue-loader v16.1.2 的更新日志","中明确写道",[197,638,639],{},[92,640,641],{},"Note: vue-loader v16 is for Vue 3 only.",[87,643,645],{"id":644},"vue-loader-14-15-breaking-change","vue-loader 14 -> 15 breaking change",[92,647,648,649,654],{},"vue-loader 从 14 往上迁移时，不修改 webpack 配置直接跑会遇到 vue 语法不识别的问题。具体表现为 .vue 文件命名都是正确有效的语法，但构建开发时编译器就是不认，报语法错误。vue-loader 官方有一份",[35,650,653],{"href":651,"rel":652},"https://vue-loader.vuejs.org/migrating.html",[39],"迁移文档","，需要注意一下。",[121,656,661],{"className":657,"code":659,"language":660},[658],"language-text","ERROR in ./src/......\nModule parse failed: Unexpected token(1:0)\nYou may need an appropriate loader to handle this file type.\n","text",[55,662,659],{"__ignoreMap":126},[121,664,666],{"className":283,"code":665,"language":285,"meta":126,"style":126},"// ...\nimport path from 'path'\n+const VueLoaderPlugin = require('vue-loader/lib/plugin')\n\n// ...\n\n  plugins: [\n+    new VueLoaderPlugin()\n    // ...\n  ]\n",[55,667,668,673,678,683,687,691,695,700,705,710],{"__ignoreMap":126},[130,669,670],{"class":132,"line":133},[130,671,672],{},"// ...\n",[130,674,675],{"class":132,"line":140},[130,676,677],{},"import path from 'path'\n",[130,679,680],{"class":132,"line":150},[130,681,682],{},"+const VueLoaderPlugin = require('vue-loader/lib/plugin')\n",[130,684,685],{"class":132,"line":166},[130,686,508],{"emptyLinePlaceholder":507},[130,688,689],{"class":132,"line":177},[130,690,672],{},[130,692,693],{"class":132,"line":183},[130,694,508],{"emptyLinePlaceholder":507},[130,696,697],{"class":132,"line":320},[130,698,699],{},"  plugins: [\n",[130,701,702],{"class":132,"line":326},[130,703,704],{},"+    new VueLoaderPlugin()\n",[130,706,707],{"class":132,"line":332},[130,708,709],{},"    // ...\n",[130,711,712],{"class":132,"line":338},[130,713,714],{},"  ]\n",[92,716,717],{},"除此之外，在我这个项目中需要额外移除 webpack 配置中针对 .vue 文件的 babel-loader",[121,719,721],{"className":283,"code":720,"language":285,"meta":126,"style":126},"{\n  test: /\\.vue$/,\n  use: [\n-    {\n-      loader: 'babel-loader'\n-    },\n    {\n      loader: 'vue-loader',\n    }\n  ]\n}\n",[55,722,723,727,732,737,742,747,752,757,762,767,771],{"__ignoreMap":126},[130,724,725],{"class":132,"line":133},[130,726,137],{},[130,728,729],{"class":132,"line":140},[130,730,731],{},"  test: /\\.vue$/,\n",[130,733,734],{"class":132,"line":150},[130,735,736],{},"  use: [\n",[130,738,739],{"class":132,"line":166},[130,740,741],{},"-    {\n",[130,743,744],{"class":132,"line":177},[130,745,746],{},"-      loader: 'babel-loader'\n",[130,748,749],{"class":132,"line":183},[130,750,751],{},"-    },\n",[130,753,754],{"class":132,"line":320},[130,755,756],{},"    {\n",[130,758,759],{"class":132,"line":326},[130,760,761],{},"      loader: 'vue-loader',\n",[130,763,764],{"class":132,"line":332},[130,765,766],{},"    }\n",[130,768,769],{"class":132,"line":338},[130,770,714],{},[130,772,773],{"class":132,"line":344},[130,774,186],{},[10,776,777],{"id":777},"最终更新情况",[14,779,780,788,795],{},[17,781,782,784,785],{},[55,783,57],{}," -> ",[55,786,787],{},"node@^14",[17,789,790,784,792],{},[55,791,72],{},[55,793,794],{},"vue-loader@^15",[17,796,797,784,799],{},[55,798,82],{},[55,800,801],{},"sass@^1.22.12",[92,803,804],{},"其余依赖版本维持不变",[10,806,807],{"id":807},"参见",[14,809,810,827,834,840,846,853,860,866,872,878,884,890,896,903,910],{},[17,811,812],{},[35,813,816,817,819,820,823,824,826],{"href":814,"rel":815},"https://juejin.cn/post/7327094228350500914",[39],"node-sass更换为dart-sass",[55,818,192],{}," 和 ",[55,821,822],{},"node-sass","都是用来将",[55,825,222],{},"编译成 - 掘金",[17,828,829],{},[35,830,833],{"href":831,"rel":832},"https://sunchenggit.github.io/2021/01/13/node-sass%E8%BF%81%E7%A7%BBdart-sass/",[39],"node-sass迁移dart-sass | Bolg",[17,835,836],{},[35,837,839],{"href":116,"rel":838},[39],"sass-loader | webpack 中文文档 | webpack中文文档 | webpack中文网",[17,841,842],{},[35,843,845],{"href":37,"rel":844},[39],"Sass: LibSass is Deprecated",[17,847,848],{},[35,849,852],{"href":850,"rel":851},"https://www.npmjs.com/package/sass?activeTab=versions",[39],"sass - npm",[17,854,855],{},[35,856,859],{"href":857,"rel":858},"https://www.npmjs.com/package/node-sass",[39],"node-sass - npm",[17,861,862],{},[35,863,865],{"href":233,"rel":864},[39],"About semantic versioning | npm Docs",[17,867,868],{},[35,869,871],{"href":423,"rel":870},[39],"Make /deep/ behave like the descendant combinator \" \" in CSS live profile (in css file or inside of \u003Cstyle>) - Chrome Platform Status",[17,873,874],{},[35,875,877],{"href":104,"rel":876},[39],"sass-loader/CHANGELOG.md at v8.0.0 · webpack-contrib/sass-loader",[17,879,880],{},[35,881,883],{"href":633,"rel":882},[39],"Release v16.1.2 · vuejs/vue-loader",[17,885,886],{},[35,887,889],{"href":619,"rel":888},[39],"refactor: use @vue/component-compiler-utils · vuejs/vue-loader@e32cd0e",[17,891,892],{},[35,893,895],{"href":625,"rel":894},[39],"chore: update @vue/component-compiler-utils to v3 · vuejs/vue-loader@c359a38",[17,897,898],{},[35,899,902],{"href":900,"rel":901},"https://github.com/vuejs/vue-cli/issues/3399#issuecomment-466319019",[39],"dart-sass does not support /deep/ selector · Issue #3399 · vuejs/vue-cli",[17,904,905],{},[35,906,909],{"href":907,"rel":908},"https://vue-loader-v14.vuejs.org/en/features/scoped-css.html",[39],"Scoped CSS · vue-loader v14",[17,911,912],{},[35,913,915],{"href":651,"rel":914},[39],"Migrating from v14 | Vue Loader",[917,918,919],"style",{},"html pre.shiki code .sVt8B, html code.shiki .sVt8B{--shiki-default:#24292E;--shiki-dark:#E1E4E8}html pre.shiki code .sj4cs, html code.shiki .sj4cs{--shiki-default:#005CC5;--shiki-dark:#79B8FF}html pre.shiki code .sZZnC, html code.shiki .sZZnC{--shiki-default:#032F62;--shiki-dark:#9ECBFF}html .default .shiki span {color: var(--shiki-default);background: var(--shiki-default-bg);font-style: var(--shiki-default-font-style);font-weight: var(--shiki-default-font-weight);text-decoration: var(--shiki-default-text-decoration);}html .shiki span {color: var(--shiki-default);background: var(--shiki-default-bg);font-style: var(--shiki-default-font-style);font-weight: var(--shiki-default-font-weight);text-decoration: var(--shiki-default-text-decoration);}html .dark .shiki span {color: var(--shiki-dark);background: var(--shiki-dark-bg);font-style: var(--shiki-dark-font-style);font-weight: var(--shiki-dark-font-weight);text-decoration: var(--shiki-dark-text-decoration);}html.dark .shiki span {color: var(--shiki-dark);background: var(--shiki-dark-bg);font-style: var(--shiki-dark-font-style);font-weight: var(--shiki-dark-font-weight);text-decoration: var(--shiki-dark-text-decoration);}html pre.shiki code .sScJk, html code.shiki .sScJk{--shiki-default:#6F42C1;--shiki-dark:#B392F0}html pre.shiki code .sJ8bj, html code.shiki .sJ8bj{--shiki-default:#6A737D;--shiki-dark:#6A737D}",{"title":126,"searchDepth":140,"depth":140,"links":921},[922,923,924,925,930,936,940,941],{"id":12,"depth":140,"text":12},{"id":28,"depth":140,"text":29},{"id":49,"depth":140,"text":49},{"id":85,"depth":140,"text":85,"children":926},[927,928,929],{"id":89,"depth":150,"text":90},{"id":97,"depth":150,"text":98},{"id":192,"depth":150,"text":192},{"id":242,"depth":140,"text":243,"children":931},[932,933,934,935],{"id":246,"depth":150,"text":247},{"id":279,"depth":150,"text":280},{"id":416,"depth":150,"text":417},{"id":469,"depth":150,"text":470},{"id":544,"depth":140,"text":544,"children":937},[938,939],{"id":547,"depth":150,"text":548},{"id":644,"depth":150,"text":645},{"id":777,"depth":140,"text":777},{"id":807,"depth":140,"text":807},"2025-07-05 17:57:02","md",{},"/2025/07/05/node-sass-migration-to-dart-sass","---\ntitle: node-sass 迁移至 dart-sass 踩坑实录\ndate: 2025-07-05 17:57:02\nsticky:\ntags:\n- Web\n- Vue.js\n- Sass\n- CSS\n- JavaScript\n---\n\n## 更新目标\n\n- node-sass -> sass ( dart-sass )\n- 减少影响面，非必要不更新其他依赖的版本\n- 在前两条基础上，看看能否提升 node.js 的版本\n\n## 抛弃 node-sass 的理由\n\n- [node-sass 已经停止维护，dart-sass 是 sass 官方主推的继任者](https://sass-lang.com/blog/libsass-is-deprecated/)\n- node-sass 在 windows 下的安装非常麻烦，npm 安装时需要开发机上同时装有 python2 和 Microsoft Visual C++\n- 在安装 node-sass 时，需要从 Github 拉取资源，在特定网络环境下成功率并不高\n\n## 项目依赖版本现状\n\n- `node@^12`\n- `vue@^2`\n- `webpack@^3`\n- `vue-loader@^14`\n- `sass-loader@^7.0.3`\n- `node-sass@^4`\n\n## 更新思路\n\n### node.js\n\nwebpack 官方并没有提供 webpack 3 支持的最高 node 版本，且即使 webpack 官方支持，webpack 的相关插件也未必支持。因此 node 版本能否更新就只能自己试。好在尽管这个项目的 CI/CD 跑在 node 12，但我日常都在用 node 14 开发，因此顺势将 node 版本提升至 14。\n\n### webpack、sass-loader\n\nwebpack 的版本目前处于非必要不更新的定时炸弹状态，基于现有的 webpack 3 限制，所支持的最高 sass-loader 版本就是 ^7 （ sass-loader 在 [8.0.0 版本的更新日志](https://github.com/webpack-contrib/sass-loader/blob/v8.0.0/CHANGELOG.md)中明确指出 8.0.0 版本需要 webpack 4.36.0）。\n\n如果项目中 sass-loader@^7 支持使用 dart-sass 就可以不更新 sass-loader，也就不必更新 webpack 版本；反之，就需要同步更新 webpack 至 4，再视情况定下 sass-loader 的版本。\n\n那么到底支不支持呢？我在 [webpack 官方文档介绍 sass-loader 的页面](https://www.webpackjs.com/loaders/sass-loader/)找到了这样一段 package.json 片段\n\n```json\n{\n  \"devDependencies\": {\n    \"sass-loader\": \"^7.2.0\",\n    \"sass\": \"^1.22.10\"\n  }\n}\n```\n\n这证明起码在 sass-loader@7.2.0 这一版本就已经支持 dart-sass 了，因此 webpack 版本可以停留在 ^3，而 sass-loader 暂时停留在 7.0.3 版本，如果后续有问题可以更新到 ^7 版本中最新的 7.3.1 版本。\n\n### dart-sass\n\nsass-loader@^7 所支持的最高 sass 我并没有查到，Github Copilot 信誓旦旦地告诉我\n\n> **官方文档引用：**\n>\n> > sass-loader@^7.0.0 requires node-sass >=4.0.0 or sass >=1.3.0, \u003C=1.26.5.\n>\n> **建议：**\n>\n> - 如果需要使用更高版本的 `sass`，请升级到 `sass-loader` 8 或更高版本。\n\n但事实上，我并没有在互联网上找到这段文本的蛛丝马迹。并且在 sass 的 ~1.26 版本中最后一个版本是 1.26.11 而非 1.26.5，[根据常见的 npm 版本号原则](https://docs.npmjs.com/about-semantic-versioning)，major version 和 minor version 不变，只改变了 patch version 的发版一般只有 bugfix 而没有 breaking change，不至于从 1.26.5 更新到 1.26.11 就突然不支持 sass-loader 7 了，因此更可能是 AI 幻觉或者是训练数据受限。\n\n出于谨慎考虑，最终决定采用 webpack 官方文档中提到的 sass 1.22 的最后一个版本，也就是 1.22.12。\n\n## 分析完成，动手更新\n\n### 第一步，卸载 node-sass，安装 sass@^1.22.12\n\n```bash\nnpm uninstall node-sass\nnpm install sass@^1.22.12\n```\n\n### 第二步，更新 webpack 配置（非必须）\n\n```diff\nmodule.exports = {\n  // ...\n  module: {\n    rules: [\n      {\n        test: /\\.(scss|sass)$/,\n        use: [\n          'style-loader',\n          'css-loader',\n          {\n            loader: 'sass-loader',\n+            options: {\n+                // 事实上，这一行在大部分 sass-loader 版本中不用加，sass-loader 能自动检测本地是 sass 还是 node-sass\n+                implementation: require('sass')\n+              },\n            },\n          },\n        ],\n      },\n    ],\n  },\n};\n```\n\n### 第三步，批量替换 /deep/ 语法为 ::v-deep\n\n因为 [/deep/ 写法在 2017 年被弃用](https://chromestatus.com/feature/4964279606312960) ，/deep/ 变成了不受支持的深度作用选择器，node-sass 凭借其出色的容错性能够继续提供兼容，但 dart-sass 则不支持这种写法。于是需要将 /deep/ 语法批量替换成 ::v-deep 写法，这种写法虽然在 vue 的后续 rfc 被放弃了，但直至今日依然在事实上被支持。\n\n```bash\n# 大概就是这么个意思，用 vscode 的批量替换其实也行\nsed -i 's#\\s*/deep/\\s*# ::v-deep #g' $(grep -rl '/deep/' .)\n```\n\n### 第四步，修复其他 sass 语法错误\n\n在迁移的过程中，我发现项目中有一些不规范的写法，node-sass 凭借出色的鲁棒性不吭一声强行解析，而 dart-sass 则干不了这粗活。因此需要根据编译时的报错手动修复一下这些语法错误，我这里一共遇到两种。\n\n```diff\n// 多打了一个冒号\n.foo {\n-  color:: #fff;\n+  color: #fff;\n}\n\n// :nth-last-child 没指定数字\n.bar {\n-  &:nth-last-child() {\n+  &:nth-last-child(1) {\n      margin-bottom: 0;\n  }\n}\n```\n\n## 踩坑\n\n### ::v-deep 样式不生效\n\n依赖更新完后看了两眼好像是没问题，就推测试环境了。结果一天没到就被同事 call 了，::v-deep 这种深度作用选择器居然没有生效？\n\n抱着试一试的态度，GPT 给了如下回答\n\n> 在 **Vue 2 + vue-loader + Sass** 的组合下，**这种写法是正确的**，**前提是你的构建工具链支持 `::v-deep`** 语法（如 `vue-loader@15` 及以上版本 + `sass-loader`）。\n\n虽说我依然没有查证到为什么更新 vue-loader@15 才能使用 ::v-deep 语法，但对 vue-loader 进行更新后，::v-deep 语法确实生效了。在撰写本文时，我找到了些许蛛丝马迹，可能能解释这一问题。\n\n1. vue-loader 在 [14 版本的官方文档](https://vue-loader-v14.vuejs.org/en/features/scoped-css.html#deep-selectors)就是没有 ::v-deep 写法的示例，[这一示例一直在 vue-loader 15.7.0 版本发布后才被加入](https://github.com/vuejs/vue-loader/commit/2585d254fc774386a898887467fbdd30eb864b53)。\n\n2. vue-cli 的 Github Issue 评论区中有人提到\n\n   > `::v-deep` implemented in @vue/component-compiler-utils v2.6.0, should work after you reinstall the deps.\n\n   而 vue-loader 在 15.0.0-beta.1 版本才[将 @vue/component-compiler-utils 加入到自己的 dependencies 中](https://github.com/vuejs/vue-loader/commit/e32cd0e4372fcc6f13b6c307402713807516d71c#diff-7ae45ad102eab3b6d7e7896acd08c427a9b25b346470d7bc6507b6481575d519)，并直到 vue-loader 15.7.1 中才[将其 @vue/component-compiler-utils 的版本号更新到满足要求的 ^3.0.0](https://github.com/vuejs/vue-loader/commit/c359a38db0fbb4135fc97114baec3cd557d4123a)\n\n那能否升级到 vue-loader 16 甚至 17 版本呢？不行，在 [vue-loader v16.1.2 的更新日志](https://github.com/vuejs/vue-loader/releases/tag/v16.1.2)中明确写道\n\n> Note: vue-loader v16 is for Vue 3 only.\n\n### vue-loader 14 -> 15 breaking change\n\nvue-loader 从 14 往上迁移时，不修改 webpack 配置直接跑会遇到 vue 语法不识别的问题。具体表现为 .vue 文件命名都是正确有效的语法，但构建开发时编译器就是不认，报语法错误。vue-loader 官方有一份[迁移文档](https://vue-loader.vuejs.org/migrating.html)，需要注意一下。\n\n```\nERROR in ./src/......\nModule parse failed: Unexpected token(1:0)\nYou may need an appropriate loader to handle this file type.\n```\n\n```diff\n// ...\nimport path from 'path'\n+const VueLoaderPlugin = require('vue-loader/lib/plugin')\n\n// ...\n\n  plugins: [\n+    new VueLoaderPlugin()\n    // ...\n  ]\n```\n\n除此之外，在我这个项目中需要额外移除 webpack 配置中针对 .vue 文件的 babel-loader\n\n```diff\n{\n  test: /\\.vue$/,\n  use: [\n-    {\n-      loader: 'babel-loader'\n-    },\n    {\n      loader: 'vue-loader',\n    }\n  ]\n}\n```\n\n## 最终更新情况\n\n- `node@^12` -> `node@^14`\n- `vue-loader@^14` -> `vue-loader@^15`\n- `node-sass@^4` -> `sass@^1.22.12`\n\n其余依赖版本维持不变\n\n## 参见\n\n- [node-sass更换为dart-sass`dart-sass` 和 `node-sass`都是用来将`sass`编译成 - 掘金](https://juejin.cn/post/7327094228350500914)\n- [node-sass迁移dart-sass | Bolg](https://sunchenggit.github.io/2021/01/13/node-sass%E8%BF%81%E7%A7%BBdart-sass/)\n- [sass-loader | webpack 中文文档 | webpack中文文档 | webpack中文网](https://www.webpackjs.com/loaders/sass-loader/)\n- [Sass: LibSass is Deprecated](https://sass-lang.com/blog/libsass-is-deprecated/)\n- [sass - npm](https://www.npmjs.com/package/sass?activeTab=versions)\n- [node-sass - npm](https://www.npmjs.com/package/node-sass)\n- [About semantic versioning | npm Docs](https://docs.npmjs.com/about-semantic-versioning)\n- [Make /deep/ behave like the descendant combinator \" \" in CSS live profile (in css file or inside of \\\u003Cstyle>) - Chrome Platform Status](https://chromestatus.com/feature/4964279606312960)\n- [sass-loader/CHANGELOG.md at v8.0.0 · webpack-contrib/sass-loader](https://github.com/webpack-contrib/sass-loader/blob/v8.0.0/CHANGELOG.md)\n- [Release v16.1.2 · vuejs/vue-loader](https://github.com/vuejs/vue-loader/releases/tag/v16.1.2)\n- [refactor: use @vue/component-compiler-utils · vuejs/vue-loader@e32cd0e](https://github.com/vuejs/vue-loader/commit/e32cd0e4372fcc6f13b6c307402713807516d71c#diff-7ae45ad102eab3b6d7e7896acd08c427a9b25b346470d7bc6507b6481575d519)\n- [chore: update @vue/component-compiler-utils to v3 · vuejs/vue-loader@c359a38](https://github.com/vuejs/vue-loader/commit/c359a38db0fbb4135fc97114baec3cd557d4123a)\n- [dart-sass does not support /deep/ selector · Issue #3399 · vuejs/vue-cli](https://github.com/vuejs/vue-cli/issues/3399#issuecomment-466319019)\n- [Scoped CSS · vue-loader v14](https://vue-loader-v14.vuejs.org/en/features/scoped-css.html)\n- [Migrating from v14 | Vue Loader](https://vue-loader.vuejs.org/migrating.html)\n\n",{"title":5,"description":126},"posts/node-sass-migration-to-dart-sass",false,[951,952,953,954,955],"Web","Vue.js","Sass","CSS","JavaScript","0lgzJ1XaGhgOTBuWoyHO-FyReWvQTucYwqLf2BrU7AY",[958,963],{"title":959,"path":960,"stem":961,"date":962,"children":-1},"Vue Markdown 渲染优化实战(上)：从暴力刷新、分块更新到 Morphdom 的华丽变身","/2025/07/12/vue-markdown-render-improvement-1","posts/vue-markdown-render-improvement-1","2025-07-12 20:48:56",{"title":964,"path":965,"stem":966,"date":967,"children":-1},"前端中的量子力学——一打开 F12 就消失的 Bug","/2025/06/08/front-end-bug-gone-when-open-devtool","posts/front-end-bug-gone-when-open-devtool","2025-06-08 01:22:13",25,1761699272067]