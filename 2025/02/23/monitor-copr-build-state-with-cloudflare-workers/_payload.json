[{"data":1,"prerenderedAt":950},["ShallowReactive",2],{"post-2025-02-23-monitor-copr-build-state-with-cloudflare-workers-zh":3,"surround-2025-02-23-monitor-copr-build-state-with-cloudflare-workers-zh":937,"randomIndex/2025/02/23/monitor-copr-build-state-with-cloudflare-workers/":148,"language-switch-/2025/02/23/monitor-copr-build-state-with-cloudflare-workers/-en":949},{"title":4,"date":5,"path":6,"tags":7,"body":11,"description":67},"使用 Cloudflare Workers 监控 Fedora Copr 构建状态","2025-02-23 12:12:53","/2025/02/23/monitor-copr-build-state-with-cloudflare-workers",[8,9,10],"JavaScript","Cloudflare","Fedora",{"type":12,"value":13,"toc":935},"minimark",[14,24,33,48,62,69,72,75,340,343,539,542,912,915,920,931],[15,16,17],"blockquote",{},[18,19,20],"p",{},[21,22,23],"del",{},"确信，是 cloudflare workers 用上瘾了",[18,25,26,27,32],{},"在",[28,29,31],"a",{"href":30},"/2024/04/29/update-a-rpm-spec-by-github-action/","「使用 Github Action 更新用于 rpm 打包的 spec 文件」","一文中，我利用 Github Action 实现了自动化的 spec 版本号更新，配合 Fedora Copr 的 webhook 就可以实现 Copr 软件包更新的自动化构建。看似很完美，但缺少了一个构建状态的监控机制，这导致出现构建错误的时候我不能及时得到通知（无论构建错误是 spec 本身的问题或者是构建时的网络环境问题）。",[18,34,35,41,42,47],{},[28,36,40],{"href":37,"rel":38},"https://yanqiyu.info",[39],"nofollow","西木野羰基"," 提出 ",[28,43,46],{"href":44,"rel":45},"https://notifications.fedoraproject.org/",[39],"notifications.fedoraproject.org"," 可以配置通知，Filters 的 Applications 选项中有 copr，但很可惜，实测没有效果。这里的通知配置的似乎只是邮件的过滤规则——如果 copr 本来就没打算构建失败的时候给你发邮件，那即使建立了过滤规则，依然是不可能收到邮件的。",[18,49,50,51,56,57,61],{},"不过好在 Fedora Copr 本身有非常完备的 ",[28,52,55],{"href":53,"rel":54},"https://copr.fedorainfracloud.org/api_3/docs",[39],"api 文档","，",[58,59,60],"code",{},"/monitor"," 这个 API 能用来获取软件包最新的构建情况。",[18,63,64],{},[65,66],"img",{"alt":67,"src":68},"","https://static.031130.xyz/uploads/2025/02/23/637811d2d85f6.webp",[18,70,71],{},"因此，我们就可以通过 Cloudflare 的 cronjob 定时请求这个接口，查询是否有软件包构建失败。",[18,73,74],{},"先来编写打请求的部分",[76,77,81],"pre",{"className":78,"code":79,"language":80,"meta":67,"style":67},"language-javascript shiki shiki-themes one-light one-dark-pro","async function fetchCopr() {\n    const ownername = \"zhullyb\";\n    const projectname = \"v2rayA\";\n\n    const url = new URL(\"https://copr.fedorainfracloud.org/api_3/monitor\")\n    url.searchParams.set(\"ownername\", ownername)\n    url.searchParams.set(\"projectname\", projectname)\n    const response = await fetch(url)\n    const data = await response.json()\n    if (data.output !== \"ok\") {\n        throw new Error(\"Failed to fetch COPR data\")\n    }\n    return data\n}\n","javascript",[58,82,83,103,124,139,146,171,204,229,252,274,301,319,325,334],{"__ignoreMap":67},[84,85,88,92,95,99],"span",{"class":86,"line":87},"line",1,[84,89,91],{"class":90},"sLKXg","async",[84,93,94],{"class":90}," function",[84,96,98],{"class":97},"sAdtL"," fetchCopr",[84,100,102],{"class":101},"s5ixo","() {\n",[84,104,106,109,113,117,121],{"class":86,"line":105},2,[84,107,108],{"class":90},"    const",[84,110,112],{"class":111},"sNmU0"," ownername",[84,114,116],{"class":115},"s_Sar"," =",[84,118,120],{"class":119},"sDhpE"," \"zhullyb\"",[84,122,123],{"class":101},";\n",[84,125,127,129,132,134,137],{"class":86,"line":126},3,[84,128,108],{"class":90},[84,130,131],{"class":111}," projectname",[84,133,116],{"class":115},[84,135,136],{"class":119}," \"v2rayA\"",[84,138,123],{"class":101},[84,140,142],{"class":86,"line":141},4,[84,143,145],{"emptyLinePlaceholder":144},true,"\n",[84,147,149,151,154,156,159,162,165,168],{"class":86,"line":148},5,[84,150,108],{"class":90},[84,152,153],{"class":111}," url",[84,155,116],{"class":115},[84,157,158],{"class":90}," new",[84,160,161],{"class":97}," URL",[84,163,164],{"class":101},"(",[84,166,167],{"class":119},"\"https://copr.fedorainfracloud.org/api_3/monitor\"",[84,169,170],{"class":101},")\n",[84,172,174,178,181,185,187,190,192,195,198,202],{"class":86,"line":173},6,[84,175,177],{"class":176},"s7GmK","    url",[84,179,180],{"class":101},".",[84,182,184],{"class":183},"s2QsP","searchParams",[84,186,180],{"class":101},[84,188,189],{"class":97},"set",[84,191,164],{"class":101},[84,193,194],{"class":119},"\"ownername\"",[84,196,197],{"class":101},", ",[84,199,201],{"class":200},"sz0mV","ownername",[84,203,170],{"class":101},[84,205,207,209,211,213,215,217,219,222,224,227],{"class":86,"line":206},7,[84,208,177],{"class":176},[84,210,180],{"class":101},[84,212,184],{"class":183},[84,214,180],{"class":101},[84,216,189],{"class":97},[84,218,164],{"class":101},[84,220,221],{"class":119},"\"projectname\"",[84,223,197],{"class":101},[84,225,226],{"class":200},"projectname",[84,228,170],{"class":101},[84,230,232,234,237,239,242,245,247,250],{"class":86,"line":231},8,[84,233,108],{"class":90},[84,235,236],{"class":111}," response",[84,238,116],{"class":115},[84,240,241],{"class":90}," await",[84,243,244],{"class":97}," fetch",[84,246,164],{"class":101},[84,248,249],{"class":200},"url",[84,251,170],{"class":101},[84,253,255,257,260,262,264,266,268,271],{"class":86,"line":254},9,[84,256,108],{"class":90},[84,258,259],{"class":111}," data",[84,261,116],{"class":115},[84,263,241],{"class":90},[84,265,236],{"class":176},[84,267,180],{"class":101},[84,269,270],{"class":97},"json",[84,272,273],{"class":101},"()\n",[84,275,277,280,283,286,288,292,295,298],{"class":86,"line":276},10,[84,278,279],{"class":90},"    if",[84,281,282],{"class":101}," (",[84,284,285],{"class":176},"data",[84,287,180],{"class":101},[84,289,291],{"class":290},"sJa8x","output",[84,293,294],{"class":115}," !==",[84,296,297],{"class":119}," \"ok\"",[84,299,300],{"class":101},") {\n",[84,302,304,307,309,312,314,317],{"class":86,"line":303},11,[84,305,306],{"class":90},"        throw",[84,308,158],{"class":90},[84,310,311],{"class":97}," Error",[84,313,164],{"class":101},[84,315,316],{"class":119},"\"Failed to fetch COPR data\"",[84,318,170],{"class":101},[84,320,322],{"class":86,"line":321},12,[84,323,324],{"class":101},"    }\n",[84,326,328,331],{"class":86,"line":327},13,[84,329,330],{"class":90},"    return",[84,332,333],{"class":200}," data\n",[84,335,337],{"class":86,"line":336},14,[84,338,339],{"class":101},"}\n",[18,341,342],{},"随后编写通知部分，我这里采用的是飞书的 webhook 机器人",[76,344,346],{"className":78,"code":345,"language":80,"meta":67,"style":67},"async function notify(text) {\n    const webhook = \"https://open.feishu.cn/open-apis/bot/v2/hook/ffffffff-ffff-ffff-ffff-ffffffffffff\"\n    const body = {\n        msg_type: \"text\",\n        content: {\n            text: text\n        }\n    }\n    const response = await fetch(webhook, {\n        method: \"POST\",\n        headers: {\n            \"Content-Type\": \"application/json\"\n        },\n        body: JSON.stringify(body)\n    })\n    console.log(response)\n}\n",[58,347,348,365,377,389,404,413,423,428,432,452,464,473,483,488,510,516,534],{"__ignoreMap":67},[84,349,350,352,354,357,359,363],{"class":86,"line":87},[84,351,91],{"class":90},[84,353,94],{"class":90},[84,355,356],{"class":97}," notify",[84,358,164],{"class":101},[84,360,362],{"class":361},"s8iYz","text",[84,364,300],{"class":101},[84,366,367,369,372,374],{"class":86,"line":105},[84,368,108],{"class":90},[84,370,371],{"class":111}," webhook",[84,373,116],{"class":115},[84,375,376],{"class":119}," \"https://open.feishu.cn/open-apis/bot/v2/hook/ffffffff-ffff-ffff-ffff-ffffffffffff\"\n",[84,378,379,381,384,386],{"class":86,"line":126},[84,380,108],{"class":90},[84,382,383],{"class":111}," body",[84,385,116],{"class":115},[84,387,388],{"class":101}," {\n",[84,390,391,394,398,401],{"class":86,"line":141},[84,392,393],{"class":290},"        msg_type",[84,395,397],{"class":396},"st7oF",":",[84,399,400],{"class":119}," \"text\"",[84,402,403],{"class":101},",\n",[84,405,406,409,411],{"class":86,"line":148},[84,407,408],{"class":290},"        content",[84,410,397],{"class":396},[84,412,388],{"class":101},[84,414,415,418,420],{"class":86,"line":173},[84,416,417],{"class":290},"            text",[84,419,397],{"class":396},[84,421,422],{"class":200}," text\n",[84,424,425],{"class":86,"line":206},[84,426,427],{"class":101},"        }\n",[84,429,430],{"class":86,"line":231},[84,431,324],{"class":101},[84,433,434,436,438,440,442,444,446,449],{"class":86,"line":254},[84,435,108],{"class":90},[84,437,236],{"class":111},[84,439,116],{"class":115},[84,441,241],{"class":90},[84,443,244],{"class":97},[84,445,164],{"class":101},[84,447,448],{"class":200},"webhook",[84,450,451],{"class":101},", {\n",[84,453,454,457,459,462],{"class":86,"line":276},[84,455,456],{"class":290},"        method",[84,458,397],{"class":396},[84,460,461],{"class":119}," \"POST\"",[84,463,403],{"class":101},[84,465,466,469,471],{"class":86,"line":303},[84,467,468],{"class":290},"        headers",[84,470,397],{"class":396},[84,472,388],{"class":101},[84,474,475,478,480],{"class":86,"line":321},[84,476,477],{"class":119},"            \"Content-Type\"",[84,479,397],{"class":396},[84,481,482],{"class":119}," \"application/json\"\n",[84,484,485],{"class":86,"line":327},[84,486,487],{"class":101},"        },\n",[84,489,490,493,495,498,500,503,505,508],{"class":86,"line":336},[84,491,492],{"class":290},"        body",[84,494,397],{"class":396},[84,496,497],{"class":111}," JSON",[84,499,180],{"class":101},[84,501,502],{"class":97},"stringify",[84,504,164],{"class":101},[84,506,507],{"class":200},"body",[84,509,170],{"class":101},[84,511,513],{"class":86,"line":512},15,[84,514,515],{"class":101},"    })\n",[84,517,519,522,524,527,529,532],{"class":86,"line":518},16,[84,520,521],{"class":176},"    console",[84,523,180],{"class":101},[84,525,526],{"class":97},"log",[84,528,164],{"class":101},[84,530,531],{"class":200},"response",[84,533,170],{"class":101},[84,535,537],{"class":86,"line":536},17,[84,538,339],{"class":101},[18,540,541],{},"最后就是 cronjob 的调用部分和构建状态解析部分",[76,543,545],{"className":78,"code":544,"language":80,"meta":67,"style":67},"export default {\n    async fetch(request, env, ctx) {\n      return new Response('Hello World!');\n    },\n\n    async scheduled(event, env, ctx) {\n        const data = await fetchCopr()\n        const errorPackages = new Array()\n\n        for (const pkg of data.packages) {\n            for (const chroot of Object.values(pkg.chroots)) {\n                if (chroot.state == \"failed\") {\n                    errorPackages.push(pkg.name)\n                    break\n                }\n            }\n        }\n\n        if (errorPackages.length > 0) {\n            await notify(`COPR 以下包发生构建失败:\\n${errorPackages.join(\"\\n\")}`)\n        } else {\n            console.log(\"COPR 所有包构建成功\")\n        }\n    }\n};\n",[58,546,547,558,582,600,605,609,631,646,662,666,691,726,749,770,775,780,785,789,794,819,868,879,896,901,906],{"__ignoreMap":67},[84,548,549,552,556],{"class":86,"line":87},[84,550,551],{"class":90},"export",[84,553,555],{"class":554},"sq3v1"," default",[84,557,388],{"class":101},[84,559,560,563,565,567,570,572,575,577,580],{"class":86,"line":105},[84,561,562],{"class":90},"    async",[84,564,244],{"class":97},[84,566,164],{"class":101},[84,568,569],{"class":361},"request",[84,571,197],{"class":101},[84,573,574],{"class":361},"env",[84,576,197],{"class":101},[84,578,579],{"class":361},"ctx",[84,581,300],{"class":101},[84,583,584,587,589,592,594,597],{"class":86,"line":126},[84,585,586],{"class":90},"      return",[84,588,158],{"class":90},[84,590,591],{"class":97}," Response",[84,593,164],{"class":101},[84,595,596],{"class":119},"'Hello World!'",[84,598,599],{"class":101},");\n",[84,601,602],{"class":86,"line":141},[84,603,604],{"class":101},"    },\n",[84,606,607],{"class":86,"line":148},[84,608,145],{"emptyLinePlaceholder":144},[84,610,611,613,616,618,621,623,625,627,629],{"class":86,"line":173},[84,612,562],{"class":90},[84,614,615],{"class":97}," scheduled",[84,617,164],{"class":101},[84,619,620],{"class":361},"event",[84,622,197],{"class":101},[84,624,574],{"class":361},[84,626,197],{"class":101},[84,628,579],{"class":361},[84,630,300],{"class":101},[84,632,633,636,638,640,642,644],{"class":86,"line":206},[84,634,635],{"class":90},"        const",[84,637,259],{"class":111},[84,639,116],{"class":115},[84,641,241],{"class":90},[84,643,98],{"class":97},[84,645,273],{"class":101},[84,647,648,650,653,655,657,660],{"class":86,"line":231},[84,649,635],{"class":90},[84,651,652],{"class":111}," errorPackages",[84,654,116],{"class":115},[84,656,158],{"class":90},[84,658,659],{"class":97}," Array",[84,661,273],{"class":101},[84,663,664],{"class":86,"line":254},[84,665,145],{"emptyLinePlaceholder":144},[84,667,668,671,673,676,679,682,684,686,689],{"class":86,"line":276},[84,669,670],{"class":90},"        for",[84,672,282],{"class":101},[84,674,675],{"class":90},"const",[84,677,678],{"class":111}," pkg",[84,680,681],{"class":90}," of",[84,683,259],{"class":176},[84,685,180],{"class":101},[84,687,688],{"class":290},"packages",[84,690,300],{"class":101},[84,692,693,696,698,700,703,705,708,710,713,715,718,720,723],{"class":86,"line":303},[84,694,695],{"class":90},"            for",[84,697,282],{"class":101},[84,699,675],{"class":90},[84,701,702],{"class":111}," chroot",[84,704,681],{"class":90},[84,706,707],{"class":176}," Object",[84,709,180],{"class":101},[84,711,712],{"class":97},"values",[84,714,164],{"class":101},[84,716,717],{"class":176},"pkg",[84,719,180],{"class":101},[84,721,722],{"class":290},"chroots",[84,724,725],{"class":101},")) {\n",[84,727,728,731,733,736,738,741,744,747],{"class":86,"line":321},[84,729,730],{"class":90},"                if",[84,732,282],{"class":101},[84,734,735],{"class":176},"chroot",[84,737,180],{"class":101},[84,739,740],{"class":290},"state",[84,742,743],{"class":115}," ==",[84,745,746],{"class":119}," \"failed\"",[84,748,300],{"class":101},[84,750,751,754,756,759,761,763,765,768],{"class":86,"line":327},[84,752,753],{"class":176},"                    errorPackages",[84,755,180],{"class":101},[84,757,758],{"class":97},"push",[84,760,164],{"class":101},[84,762,717],{"class":176},[84,764,180],{"class":101},[84,766,767],{"class":290},"name",[84,769,170],{"class":101},[84,771,772],{"class":86,"line":336},[84,773,774],{"class":90},"                    break\n",[84,776,777],{"class":86,"line":512},[84,778,779],{"class":101},"                }\n",[84,781,782],{"class":86,"line":518},[84,783,784],{"class":101},"            }\n",[84,786,787],{"class":86,"line":536},[84,788,427],{"class":101},[84,790,792],{"class":86,"line":791},18,[84,793,145],{"emptyLinePlaceholder":144},[84,795,797,800,802,805,807,810,813,817],{"class":86,"line":796},19,[84,798,799],{"class":90},"        if",[84,801,282],{"class":101},[84,803,804],{"class":176},"errorPackages",[84,806,180],{"class":101},[84,808,809],{"class":290},"length",[84,811,812],{"class":115}," >",[84,814,816],{"class":815},"sAGMh"," 0",[84,818,300],{"class":101},[84,820,822,825,827,829,832,835,839,841,844,847,849,853,855,857,860,863,866],{"class":86,"line":821},20,[84,823,824],{"class":90},"            await",[84,826,356],{"class":97},[84,828,164],{"class":101},[84,830,831],{"class":119},"`COPR 以下包发生构建失败:",[84,833,834],{"class":115},"\\n",[84,836,838],{"class":837},"sAOjX","${",[84,840,804],{"class":176},[84,842,180],{"class":843},"sMj0N",[84,845,846],{"class":97},"join",[84,848,164],{"class":101},[84,850,852],{"class":851},"sWwuK","\"",[84,854,834],{"class":115},[84,856,852],{"class":851},[84,858,859],{"class":101},")",[84,861,862],{"class":837},"}",[84,864,865],{"class":119},"`",[84,867,170],{"class":101},[84,869,871,874,877],{"class":86,"line":870},21,[84,872,873],{"class":101},"        } ",[84,875,876],{"class":90},"else",[84,878,388],{"class":101},[84,880,882,885,887,889,891,894],{"class":86,"line":881},22,[84,883,884],{"class":176},"            console",[84,886,180],{"class":101},[84,888,526],{"class":97},[84,890,164],{"class":101},[84,892,893],{"class":119},"\"COPR 所有包构建成功\"",[84,895,170],{"class":101},[84,897,899],{"class":86,"line":898},23,[84,900,427],{"class":101},[84,902,904],{"class":86,"line":903},24,[84,905,324],{"class":101},[84,907,909],{"class":86,"line":908},25,[84,910,911],{"class":101},"};\n",[18,913,914],{},"随后在 Cloudflare Workers 的 Settings 部分设置好 Cron 表达式即可，我这里选择在每小时的 55 分进行一次检测，这样下来一天只会消耗 24 次 workers 次数，简直毫无压力。",[18,916,917],{},[65,918],{"alt":67,"src":919},"https://static.031130.xyz/uploads/2025/02/23/c38edfd637934.webp",[18,921,922,926,927,930],{},[923,924,925],"strong",{},"缺点:"," 我懒得使用持久化数据库记录软件包构建的成功状态，这会导致出现一个包构建失败后，每隔 1 小时都会有一条提醒，",[21,928,929],{},"什么夺命连环 call","。我目前不想修复这个问题，要不然还是降低 cron 的触发频率好了。",[932,933,934],"style",{},"html pre.shiki code .sLKXg, html code.shiki .sLKXg{--shiki-default:#A626A4;--shiki-dark:#C678DD}html pre.shiki code .sAdtL, html code.shiki .sAdtL{--shiki-default:#4078F2;--shiki-dark:#61AFEF}html pre.shiki code .s5ixo, html code.shiki .s5ixo{--shiki-default:#383A42;--shiki-dark:#ABB2BF}html pre.shiki code .sNmU0, html code.shiki .sNmU0{--shiki-default:#986801;--shiki-dark:#E5C07B}html pre.shiki code .s_Sar, html code.shiki .s_Sar{--shiki-default:#0184BC;--shiki-dark:#56B6C2}html pre.shiki code .sDhpE, html code.shiki .sDhpE{--shiki-default:#50A14F;--shiki-dark:#98C379}html pre.shiki code .s7GmK, html code.shiki .s7GmK{--shiki-default:#383A42;--shiki-dark:#E5C07B}html pre.shiki code .s2QsP, html code.shiki .s2QsP{--shiki-default:#E45649;--shiki-dark:#E5C07B}html pre.shiki code .sz0mV, html code.shiki .sz0mV{--shiki-default:#383A42;--shiki-dark:#E06C75}html pre.shiki code .sJa8x, html code.shiki .sJa8x{--shiki-default:#E45649;--shiki-dark:#E06C75}html .default .shiki span {color: var(--shiki-default);background: var(--shiki-default-bg);font-style: var(--shiki-default-font-style);font-weight: var(--shiki-default-font-weight);text-decoration: var(--shiki-default-text-decoration);}html .shiki span {color: var(--shiki-default);background: var(--shiki-default-bg);font-style: var(--shiki-default-font-style);font-weight: var(--shiki-default-font-weight);text-decoration: var(--shiki-default-text-decoration);}html .dark .shiki span {color: var(--shiki-dark);background: var(--shiki-dark-bg);font-style: var(--shiki-dark-font-style);font-weight: var(--shiki-dark-font-weight);text-decoration: var(--shiki-dark-text-decoration);}html.dark .shiki span {color: var(--shiki-dark);background: var(--shiki-dark-bg);font-style: var(--shiki-dark-font-style);font-weight: var(--shiki-dark-font-weight);text-decoration: var(--shiki-dark-text-decoration);}html pre.shiki code .s8iYz, html code.shiki .s8iYz{--shiki-default:#383A42;--shiki-default-font-style:inherit;--shiki-dark:#E06C75;--shiki-dark-font-style:italic}html pre.shiki code .st7oF, html code.shiki .st7oF{--shiki-default:#0184BC;--shiki-dark:#ABB2BF}html pre.shiki code .sq3v1, html code.shiki .sq3v1{--shiki-default:#E45649;--shiki-dark:#C678DD}html pre.shiki code .sAGMh, html code.shiki .sAGMh{--shiki-default:#986801;--shiki-dark:#D19A66}html pre.shiki code .sAOjX, html code.shiki .sAOjX{--shiki-default:#CA1243;--shiki-dark:#C678DD}html pre.shiki code .sMj0N, html code.shiki .sMj0N{--shiki-default:#50A14F;--shiki-dark:#ABB2BF}html pre.shiki code .sWwuK, html code.shiki .sWwuK{--shiki-default:#CA1243;--shiki-dark:#98C379}",{"title":67,"searchDepth":105,"depth":105,"links":936},[],[938,944],{"title":939,"path":940,"stem":941,"date":942,"lang":943,"children":-1},"Cudy TR3000 吃鹅(daed)记","/2025/02/28/cudy-tr3000-daed-install-record","posts/zh/cudy-tr3000-daed-install-record","2025-02-28 21:18:34","zh-CN",{"title":945,"path":946,"stem":947,"date":948,"lang":943,"children":-1},"基于 Cloudflare Workers 实现的在线服务状态检测告警系统","/2025/01/18/service-status-monitor-based-on-cloudflare-workers","posts/zh/service-status-monitor-based-on-cloudflare-workers","2025-01-18 02:00:08",null,1766337206808]