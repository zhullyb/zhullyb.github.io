[{"data":1,"prerenderedAt":547},["ShallowReactive",2],{"post-2025-08-11-dns-resolve-time-destroyed-my-optimization-for-pic-cdn-zh":3,"surround-2025-08-11-dns-resolve-time-destroyed-my-optimization-for-pic-cdn-zh":534,"randomIndex/2025/08/11/dns-resolve-time-destroyed-my-optimization-for-pic-cdn/":115,"language-switch-/2025/08/11/dns-resolve-time-destroyed-my-optimization-for-pic-cdn/-en":546},{"title":4,"date":5,"path":6,"tags":7,"body":14,"description":533},"DNS 解析延迟毁了我的图床优化","2025-08-11 00:06:40","/2025/08/11/dns-resolve-time-destroyed-my-optimization-for-pic-cdn",[8,9,10,11,12,13],"CDN","Image Hosting","DNS","Network","Cloudflare","Dnspod",{"type":15,"value":16,"toc":517},"minimark",[17,26,33,39,44,55,59,67,192,199,202,205,210,217,256,259,263,269,273,283,328,366,369,392,395,398,401,426,430,436,440,443,447,450,494,497,506,513],[18,19,20,21,25],"p",{},"去年夏天，我花了不少时间搭建博客图床，核心目标是",[22,23,24],"strong",{},"分地区解析 DNS","，让国内外访客都能快速加载图片。技术方案看起来完美无缺，直到最近群友反馈首次访问时图片加载很慢，我才发现问题所在。",[18,27,28],{},[29,30],"img",{"alt":31,"src":32},"","https://static.031130.xyz/uploads/2025/08/11/26306b2a483ba.webp",[18,34,35,38],{},[22,36,37],{},"955 毫秒的 DNS 解析时长！"," 这个数字让我大吃一惊。访客点开博客后，光是确定图片服务器位置就要等将近一秒，这完全抵消了 CDN 优化的效果。",[40,41,43],"h2",{"id":42},"为什么之前没发现","为什么之前没发现？",[18,45,46,47,50,51,54],{},"主要是 ",[22,48,49],{},"DNS 缓存","的\"功劳\"。它会为后续访问记住解析结果，让我的本地测试和复访测试看起来都很正常。直到用户反馈，结合最近准备秋招复习的 DNS 解析流程（递归查询、权威查询、根域名、顶级域名等），我才定位到问题：",[22,52,53],{},"首次访问时的 DNS 解析延迟","。",[40,56,58],{"id":57},"dns-解析流程分析","DNS 解析流程分析",[18,60,61,62,66],{},"让我们看看访客访问 ",[63,64,65],"code",{},"static.031130.xyz"," 时，DNS 是如何工作的：",[68,69,73],"pre",{"className":70,"code":71,"language":72,"meta":31,"style":31},"language-mermaid shiki shiki-themes one-light one-dark-pro","sequenceDiagram\n    participant User as 访客浏览器\n    participant Local as 本地 DNS\n    participant CF as Cloudflare\u003Cbr/>(国外权威)\n    participant DP as DNSPod\u003Cbr/>(国内权威)\n    participant CDN as CDN 节点\n\n    User->>Local: 请求 static.031130.xyz\n    Local->>CF: 查询 031130.xyz 权威\n    Note over Local,CF: 跨国查询，延迟高\n    CF->>Local: CNAME: cdn-cname.zhul.in\n    Local->>DP: 查询 zhul.in 权威\n    DP->>Local: CNAME: small-storage-cdn.b0.aicdn.com\n    Local->>DP: 查询 aicdn.com\n    DP->>Local: CNAME: nm.aicdn.com\n    Local->>DP: 查询最终 IP\n    DP->>Local: 返回 CDN IP\n    Local->>User: 返回解析结果\n    User->>CDN: 连接并下载图片\n","mermaid",[63,74,75,83,89,95,101,107,113,120,126,132,138,144,150,156,162,168,174,180,186],{"__ignoreMap":31},[76,77,80],"span",{"class":78,"line":79},"line",1,[76,81,82],{},"sequenceDiagram\n",[76,84,86],{"class":78,"line":85},2,[76,87,88],{},"    participant User as 访客浏览器\n",[76,90,92],{"class":78,"line":91},3,[76,93,94],{},"    participant Local as 本地 DNS\n",[76,96,98],{"class":78,"line":97},4,[76,99,100],{},"    participant CF as Cloudflare\u003Cbr/>(国外权威)\n",[76,102,104],{"class":78,"line":103},5,[76,105,106],{},"    participant DP as DNSPod\u003Cbr/>(国内权威)\n",[76,108,110],{"class":78,"line":109},6,[76,111,112],{},"    participant CDN as CDN 节点\n",[76,114,116],{"class":78,"line":115},7,[76,117,119],{"emptyLinePlaceholder":118},true,"\n",[76,121,123],{"class":78,"line":122},8,[76,124,125],{},"    User->>Local: 请求 static.031130.xyz\n",[76,127,129],{"class":78,"line":128},9,[76,130,131],{},"    Local->>CF: 查询 031130.xyz 权威\n",[76,133,135],{"class":78,"line":134},10,[76,136,137],{},"    Note over Local,CF: 跨国查询，延迟高\n",[76,139,141],{"class":78,"line":140},11,[76,142,143],{},"    CF->>Local: CNAME: cdn-cname.zhul.in\n",[76,145,147],{"class":78,"line":146},12,[76,148,149],{},"    Local->>DP: 查询 zhul.in 权威\n",[76,151,153],{"class":78,"line":152},13,[76,154,155],{},"    DP->>Local: CNAME: small-storage-cdn.b0.aicdn.com\n",[76,157,159],{"class":78,"line":158},14,[76,160,161],{},"    Local->>DP: 查询 aicdn.com\n",[76,163,165],{"class":78,"line":164},15,[76,166,167],{},"    DP->>Local: CNAME: nm.aicdn.com\n",[76,169,171],{"class":78,"line":170},16,[76,172,173],{},"    Local->>DP: 查询最终 IP\n",[76,175,177],{"class":78,"line":176},17,[76,178,179],{},"    DP->>Local: 返回 CDN IP\n",[76,181,183],{"class":78,"line":182},18,[76,184,185],{},"    Local->>User: 返回解析结果\n",[76,187,189],{"class":78,"line":188},19,[76,190,191],{},"    User->>CDN: 连接并下载图片\n",[18,193,194,195,198],{},"问题就在这里：",[22,196,197],{},"前两步查询指向了国外的 Cloudflare 权威服务器","。对于国内用户，虽然最终解析到的 CDN 节点是国内的，但跨国 DNS 查询就足以拖垮首次访问体验。那 955ms 的延迟，基本都耗在与国外 DNS 服务器的通信上了。",[40,200,201],{"id":201},"优化方案",[18,203,204],{},"针对这个问题，我采取了三个措施：",[206,207,209],"h3",{"id":208},"_1-dns-预取","1. DNS 预取",[18,211,212,213,216],{},"在博客 HTML 的 ",[63,214,215],{},"\u003Chead>"," 中添加：",[68,218,222],{"className":219,"code":220,"language":221,"meta":31,"style":31},"language-html shiki shiki-themes one-light one-dark-pro","\u003Clink rel=\"dns-prefetch\" href=\"//static.031130.xyz\">\n","html",[63,223,224],{"__ignoreMap":31},[76,225,226,230,234,238,241,245,248,250,253],{"class":78,"line":79},[76,227,229],{"class":228},"s5ixo","\u003C",[76,231,233],{"class":232},"sJa8x","link",[76,235,237],{"class":236},"sAGMh"," rel",[76,239,240],{"class":228},"=",[76,242,244],{"class":243},"sDhpE","\"dns-prefetch\"",[76,246,247],{"class":236}," href",[76,249,240],{"class":228},[76,251,252],{"class":243},"\"//static.031130.xyz\"",[76,254,255],{"class":228},">\n",[18,257,258],{},"这样浏览器在渲染页面时就会提前解析图床域名，等真正需要加载图片时，DNS 结果可能已经准备好了。",[206,260,262],{"id":261},"_2-延长-ttl","2. 延长 TTL",[18,264,265,266,268],{},"将 ",[63,267,65],{}," 的 CNAME 记录 TTL 值调大（从几分钟延长到几小时甚至一天）。这样本地 DNS 服务器会缓存更久，后续用户可以直接使用缓存结果，省掉权威查询。",[206,270,272],{"id":271},"_3-迁移权威-dns核心","3. 迁移权威 DNS（核心）",[18,274,265,275,278,279,282],{},[63,276,277],{},"031130.xyz"," 域名的",[22,280,281],{},"权威 DNS 服务器","从 Cloudflare 迁移到国内的 DNSPod：",[68,284,286],{"className":70,"code":285,"language":72,"meta":31,"style":31},"graph TB\n    subgraph \"优化前\"\n        A1[访客] --> B1[本地 DNS]\n        B1 --> C1[Cloudflare 权威\u003Cbr/>国外]\n        C1 --> D1[DNSPod 权威\u003Cbr/>国内]\n        D1 --> E1[CDN 节点]\n        style C1 fill:#ffcccc\n    end\n",[63,287,288,293,298,303,308,313,318,323],{"__ignoreMap":31},[76,289,290],{"class":78,"line":79},[76,291,292],{},"graph TB\n",[76,294,295],{"class":78,"line":85},[76,296,297],{},"    subgraph \"优化前\"\n",[76,299,300],{"class":78,"line":91},[76,301,302],{},"        A1[访客] --> B1[本地 DNS]\n",[76,304,305],{"class":78,"line":97},[76,306,307],{},"        B1 --> C1[Cloudflare 权威\u003Cbr/>国外]\n",[76,309,310],{"class":78,"line":103},[76,311,312],{},"        C1 --> D1[DNSPod 权威\u003Cbr/>国内]\n",[76,314,315],{"class":78,"line":109},[76,316,317],{},"        D1 --> E1[CDN 节点]\n",[76,319,320],{"class":78,"line":115},[76,321,322],{},"        style C1 fill:#ffcccc\n",[76,324,325],{"class":78,"line":122},[76,326,327],{},"    end\n",[68,329,331],{"className":70,"code":330,"language":72,"meta":31,"style":31},"graph TB\n    subgraph \"优化后\"\n        A2[访客] --> B2[本地 DNS]\n        B2 --> D2[DNSPod 权威\u003Cbr/>国内]\n        D2 --> E2[CDN 节点]\n        style D2 fill:#ccffcc\n    end\n\n",[63,332,333,337,342,347,352,357,362],{"__ignoreMap":31},[76,334,335],{"class":78,"line":79},[76,336,292],{},[76,338,339],{"class":78,"line":85},[76,340,341],{},"    subgraph \"优化后\"\n",[76,343,344],{"class":78,"line":91},[76,345,346],{},"        A2[访客] --> B2[本地 DNS]\n",[76,348,349],{"class":78,"line":97},[76,350,351],{},"        B2 --> D2[DNSPod 权威\u003Cbr/>国内]\n",[76,353,354],{"class":78,"line":103},[76,355,356],{},"        D2 --> E2[CDN 节点]\n",[76,358,359],{"class":78,"line":109},[76,360,361],{},"        style D2 fill:#ccffcc\n",[76,363,364],{"class":78,"line":115},[76,365,327],{},[18,367,368],{},"迁移后的好处：",[370,371,372,379,389],"ul",{},[373,374,375,376,378],"li",{},"递归 DNS 查询 ",[63,377,277],{}," 时，直接找到国内的 DNSPod，响应快",[373,380,381,382,384,385,388],{},"DNSPod 直接返回 ",[63,383,65],{}," -> ",[63,386,387],{},"small-storage-cdn.b0.aicdn.com","，无需中间跳转",[373,390,391],{},"整个 DNS 解析链路在国内完成，首次访问延迟大幅降低",[40,393,394],{"id":394},"优化效果",[18,396,397],{},"虽然 DNS 缓存给测试带来了困难，但迁移权威 DNS + 调整 TTL + 添加预取后，首次访问的 DNS 解析时间降到了可接受的范围。",[40,399,400],{"id":400},"经验教训",[402,403,404,410,420],"ol",{},[373,405,406,409],{},[22,407,408],{},"DNS 位置很重要","：涉及多地优化时，权威 DNS 的地理位置对首次访问延迟影响很大。优先使用国内权威服务器。",[373,411,412,415,416,419],{},[22,413,414],{},"首次访问是关键","：虽然缓存能帮助后续访问，但首次访问体验直接影响用户印象。善用 ",[63,417,418],{},"dns-prefetch"," 和合理的 TTL 设置。",[373,421,422,425],{},[22,423,424],{},"监控和反馈重要","：本地测试环境往往有缓存加持，真实的首次访问体验需要通过监控和用户反馈来发现。",[40,427,429],{"id":428},"重要提醒警惕-cname-拉平","重要提醒：警惕 CNAME 拉平",[18,431,432,433,54],{},"如果你需要分地区解析来让访客连接到最近的 CDN 节点，",[22,434,435],{},"务必避开 CNAME Flattening（CNAME 拉平）",[206,437,439],{"id":438},"什么是-cname-拉平","什么是 CNAME 拉平？",[18,441,442],{},"权威 DNS 服务器（如 Cloudflare）看到 CNAME 记录后，会主动查询目标域名的最终 IP 地址，然后直接返回 IP 而不是 CNAME。",[206,444,446],{"id":445},"为什么会出问题","为什么会出问题？",[18,448,449],{},"分地区解析（GeoDNS）在权威 DNS 服务器层面实现。当权威服务器执行 CNAME 拉平时，它会在自己的位置查询目标域名的 IP。如果权威 DNS 在美国，它获取的 IP 就是美国最优节点，然后把这个 IP 返回给所有地区的查询者，包括中国用户。这样，你为中国用户配置的国内 CDN IP 策略就完全失效了。",[68,451,453],{"className":70,"code":452,"language":72,"meta":31,"style":31},"graph LR\n    subgraph \"启用 CNAME 拉平的问题\"\n        A[中国用户] --> B[Cloudflare 权威\u003Cbr/>美国节点]\n        B --> C[查询目标 CNAME]\n        C --> D[返回美国 CDN IP]\n        D --> A\n        style D fill:#ffcccc\n    end\n",[63,454,455,460,465,470,475,480,485,490],{"__ignoreMap":31},[76,456,457],{"class":78,"line":79},[76,458,459],{},"graph LR\n",[76,461,462],{"class":78,"line":85},[76,463,464],{},"    subgraph \"启用 CNAME 拉平的问题\"\n",[76,466,467],{"class":78,"line":91},[76,468,469],{},"        A[中国用户] --> B[Cloudflare 权威\u003Cbr/>美国节点]\n",[76,471,472],{"class":78,"line":97},[76,473,474],{},"        B --> C[查询目标 CNAME]\n",[76,476,477],{"class":78,"line":103},[76,478,479],{},"        C --> D[返回美国 CDN IP]\n",[76,481,482],{"class":78,"line":109},[76,483,484],{},"        D --> A\n",[76,486,487],{"class":78,"line":115},[76,488,489],{},"        style D fill:#ffcccc\n",[76,491,492],{"class":78,"line":122},[76,493,327],{},[206,495,496],{"id":496},"正确做法",[18,498,499,500,384,502,505],{},"老实使用 CNAME 指向另一个支持 GeoDNS 的域名（如 ",[63,501,65],{},[63,503,504],{},"cdn-cname.zhul.in","，后者在 DNSPod 上做分地区解析），才能保证分流策略正确执行。",[18,507,508,509,512],{},"如果需要分地区解析功能，",[22,510,511],{},"不要","在相关域名上启用 CNAME Flattening（或 ALIAS、ANAME 等类似功能）。",[514,515,516],"style",{},"html .default .shiki span {color: var(--shiki-default);background: var(--shiki-default-bg);font-style: var(--shiki-default-font-style);font-weight: var(--shiki-default-font-weight);text-decoration: var(--shiki-default-text-decoration);}html .shiki span {color: var(--shiki-default);background: var(--shiki-default-bg);font-style: var(--shiki-default-font-style);font-weight: var(--shiki-default-font-weight);text-decoration: var(--shiki-default-text-decoration);}html .dark .shiki span {color: var(--shiki-dark);background: var(--shiki-dark-bg);font-style: var(--shiki-dark-font-style);font-weight: var(--shiki-dark-font-weight);text-decoration: var(--shiki-dark-text-decoration);}html.dark .shiki span {color: var(--shiki-dark);background: var(--shiki-dark-bg);font-style: var(--shiki-dark-font-style);font-weight: var(--shiki-dark-font-weight);text-decoration: var(--shiki-dark-text-decoration);}html pre.shiki code .s5ixo, html code.shiki .s5ixo{--shiki-default:#383A42;--shiki-dark:#ABB2BF}html pre.shiki code .sJa8x, html code.shiki .sJa8x{--shiki-default:#E45649;--shiki-dark:#E06C75}html pre.shiki code .sAGMh, html code.shiki .sAGMh{--shiki-default:#986801;--shiki-dark:#D19A66}html pre.shiki code .sDhpE, html code.shiki .sDhpE{--shiki-default:#50A14F;--shiki-dark:#98C379}",{"title":31,"searchDepth":85,"depth":85,"links":518},[519,520,521,526,527,528],{"id":42,"depth":85,"text":43},{"id":57,"depth":85,"text":58},{"id":201,"depth":85,"text":201,"children":522},[523,524,525],{"id":208,"depth":91,"text":209},{"id":261,"depth":91,"text":262},{"id":271,"depth":91,"text":272},{"id":394,"depth":85,"text":394},{"id":400,"depth":85,"text":400},{"id":428,"depth":85,"text":429,"children":529},[530,531,532],{"id":438,"depth":91,"text":439},{"id":445,"depth":91,"text":446},{"id":496,"depth":91,"text":496},"去年夏天，我花了不少时间搭建博客图床，核心目标是分地区解析 DNS，让国内外访客都能快速加载图片。技术方案看起来完美无缺，直到最近群友反馈首次访问时图片加载很慢，我才发现问题所在。",[535,541],{"title":536,"path":537,"stem":538,"date":539,"lang":540,"children":-1},"初试 Github Action Self-hosted Runner，想说爱你不容易","/2025/09/05/first-try-of-github-action-self-hosted-runner","posts/zh/first-try-of-github-action-self-hosted-runner","2025-09-05 05:54:17","zh-CN",{"title":542,"path":543,"stem":544,"date":545,"lang":540,"children":-1},"Vue Markdown 渲染优化实战(下)：告别 DOM 操作，拥抱 AST 与函数式渲染","/2025/07/13/vue-markdown-render-improvement-2","posts/zh/vue-markdown-render-improvement-2","2025-07-13 00:01:35","/en/2025/08/11/dns-resolve-time-destroyed-my-optimization-for-pic-cdn/",1765307266480]