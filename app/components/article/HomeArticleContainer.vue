<template>
	<div>
		<div v-for="post in processedPosts" :key="post.path" class="post-item">
			<NuxtLink :to="post.path" class="post-link" :aria-label="post.title"></NuxtLink>
			<h2 class="title">{{ post.title }}</h2>
			<span class="description">{{ post.excerpt }}</span>
			<div class="post-meta">
				<span class="date">{{ post.date?.split(' ')[0] }}</span>
				<NuxtLink
					class="tags"
					v-for="tag in toNormalTags(post.tags)"
					:key="tag"
					:to="`/tags/${encodeURIComponent(tag)}`"
					>{{ '#' + tag }}</NuxtLink
				>
			</div>
		</div>
		<Pagination :currentPage="page" :totalPages="pageCount" />
	</div>
</template>

<script setup lang="ts">
	import type { Post } from '~/types/post'
	import { processExcerpt } from '~/utils/extractExcerpt'

	const route = useRoute()
	const page = route.params.page ? parseInt(route.params.page as string) || 1 : 1

	const pageSize = 10

	const posts = (
		await useAsyncData(`index-page-${page}`, () =>
			queryCollection('posts')
				.order('date', 'DESC')
				.skip((page - 1) * pageSize)
				.limit(pageSize)
				.select('title', 'date', 'path', 'tags', 'body')
				.all()
		)
	).data as Ref<Post[]>

	// 提取纯文本 excerpt 并限制字数到 300
	const processedPosts = computed(() => {
		if (!posts.value) return []
		return posts.value.map(post => ({
			...post,
			excerpt: processExcerpt((post as any).body, 300)
		}))
	})

	const total = (await useAsyncData('posts-total', () => queryCollection('posts').count()))
		.data as Ref<number>

	const pageCount = Math.max(1, Math.ceil((total.value ?? 0) / pageSize))

	if (posts.value && posts.value.length === 0 && page > 1) {
		throw createError({ statusCode: 404, statusMessage: 'Page not found', fatal: true })
	}

	useHead({
		title: '竹林里有冰的博客',
		titleTemplate: '%s' // 首页不加 siteName
	})
</script>

<style lang="less" scoped>
	.post-item {
		position: relative;
		margin-bottom: 20px;

		.desktop-up({
        padding: 20px;
        transition: box-shadow 0.2s;

        &:hover {
            box-shadow: rgba(0, 0, 0, 0.1) 0px 4px 12px;
        }
    });
	}

	.post-link {
		position: absolute;
		top: 0;
		left: 0;
		right: 0;
		bottom: 0;
		z-index: 1;
	}

	.title {
		margin-bottom: 5px;
		font-size: 20px;
		font-weight: bold;
		display: -webkit-box;
		-webkit-box-orient: vertical;
		-webkit-line-clamp: 1;
		overflow: hidden;
		text-overflow: ellipsis;
		word-break: break-word;

		.tablet-down({
        -webkit-line-clamp: 2;
        border-bottom: none;
        padding-bottom: 2px;
    });
	}

	.post-meta {
		display: -webkit-box;
		-webkit-box-orient: vertical;
		-webkit-line-clamp: 1;
		overflow: hidden;
		text-overflow: ellipsis;
		word-break: break-word;

		* + * {
			margin-left: 5px;
		}

		.date {
			color: #666;
			font-size: 0.9em;
		}

		.tags {
			position: relative;
			z-index: 2;
			color: #666;
			text-decoration: none;

			&:hover {
				color: @active-blue;
			}
		}
	}

	.description {
		text-decoration: none;
		display: -webkit-box;
		-webkit-box-orient: vertical;
		-webkit-line-clamp: 3;
		overflow: hidden;
		text-overflow: ellipsis;
		word-break: break-word;
		color: #333;

		.dark-mode({
      color: #ccc;
    });
	}
</style>
