[{"data":1,"prerenderedAt":388},["ShallowReactive",2],{"post-2024-04-29-update-a-rpm-spec-by-github-action-zh":3,"surround-2024-04-29-update-a-rpm-spec-by-github-action-zh":375,"randomIndex/2024/04/29/update-a-rpm-spec-by-github-action/":228,"language-switch-/2024/04/29/update-a-rpm-spec-by-github-action/-en":387},{"title":4,"date":5,"path":6,"tags":7,"body":11,"description":374},"使用 Github Action 更新用于 rpm 打包的 spec 文件","2024-04-29 19:19:54","/2024/04/29/update-a-rpm-spec-by-github-action",[8,9,10],"Fedora","RPM Package","Github Action",{"type":12,"value":13,"toc":372},"minimark",[14,23,34,37,40,43,104,107,144,147,181,184,259,262,320,323,360,368],[15,16,17,18,22],"p",{},"有一些软件包的上游本身就是使用 Github Action 发版的，每次 commit 都会触发 Github Action 去构建并分发新版本，使用构建时的时间日期作为版本号。针对这种包，手动更新费时费力，而规范的 specfile 应当是更新 ",[19,20,21],"code",{},"%changelog"," 的，因此应当是使用 rpmdev-bumpspec 命令。只不过 rpmdev-bumpspec 需要在 rpm 系发行版或者装有 rpm 系列依赖包的发行版下执行，这不是随随便便一个 Linux 环境就能运行的。",[15,24,25,26,33],{},"我找到了 ",[27,28,32],"a",{"href":29,"rel":30},"https://github.com/netoarmando/rpmdev-bumpspec-action",[31],"nofollow","netoarmando/rpmdev-bumpspec-action"," 这个 Github Action，它通过启动一个 Fedora 的 docker 实现了使用 rpmdev-bumpspec 的效果。虽然 release 中只有一个 2021 年构建的 v1 版本，~~但 Fedora 的版本高低不影响 rpmdev-bumpspec 的效果。~~但每次 Github Action 执行时都会使用 fedora:latest 的 docker 重新构建一遍，不用担心 fedora 版本过低。",[15,35,36],{},"于是我们便解决了最核心的问题——处理 spec 文件。接下来只要补充好头尾的步骤即可。",[38,39],"hr",{},[15,41,42],{},"首先使用 actions/checkout 释出仓库内的文件",[44,45,50],"pre",{"className":46,"code":47,"language":48,"meta":49,"style":49},"language-yaml shiki shiki-themes one-light one-dark-pro","- name: Checkout\n  uses: actions/checkout@v2\n  with:\n    fetch-depth: 0\n","yaml","",[19,51,52,72,83,92],{"__ignoreMap":49},[53,54,57,61,65,68],"span",{"class":55,"line":56},"line",1,[53,58,60],{"class":59},"s5ixo","- ",[53,62,64],{"class":63},"sJa8x","name",[53,66,67],{"class":59},": ",[53,69,71],{"class":70},"sDhpE","Checkout\n",[53,73,75,78,80],{"class":55,"line":74},2,[53,76,77],{"class":63},"  uses",[53,79,67],{"class":59},[53,81,82],{"class":70},"actions/checkout@v2\n",[53,84,86,89],{"class":55,"line":85},3,[53,87,88],{"class":63},"  with",[53,90,91],{"class":59},":\n",[53,93,95,98,100],{"class":55,"line":94},4,[53,96,97],{"class":63},"    fetch-depth",[53,99,67],{"class":59},[53,101,103],{"class":102},"sAGMh","0\n",[15,105,106],{},"通过 shell 命令获取仓库内 spec 文件的版本号，存入 $GITHUB_ENV",[44,108,110],{"className":46,"code":109,"language":48,"meta":49,"style":49},"- name: Get Current Version\n  run: |\n    CURRENT_VERSION=`grep -E '^Version:' *.spec | awk '{print $2}'`\n    echo \"CURRENT_VERSION=$CURRENT_VERSION\" >> $GITHUB_ENV\n",[19,111,112,123,134,139],{"__ignoreMap":49},[53,113,114,116,118,120],{"class":55,"line":56},[53,115,60],{"class":59},[53,117,64],{"class":63},[53,119,67],{"class":59},[53,121,122],{"class":70},"Get Current Version\n",[53,124,125,128,130],{"class":55,"line":74},[53,126,127],{"class":63},"  run",[53,129,67],{"class":59},[53,131,133],{"class":132},"sLKXg","|\n",[53,135,136],{"class":55,"line":85},[53,137,138],{"class":70},"    CURRENT_VERSION=`grep -E '^Version:' *.spec | awk '{print $2}'`\n",[53,140,141],{"class":55,"line":94},[53,142,143],{"class":70},"    echo \"CURRENT_VERSION=$CURRENT_VERSION\" >> $GITHUB_ENV\n",[15,145,146],{},"通过 Github API 获取目标软件的最新版本号，存入 $GITHUB_ENV",[44,148,150],{"className":46,"code":149,"language":48,"meta":49,"style":49},"- name: Export latest geoip version\n  run: |\n    NEW_VERSION=`curl -s https://api.github.com/repos/{user_name}/{repo_name}/releases/latest | jq -r '.tag_name' | sed 's/v//g'`\n    echo \"NEW_VERSION=$NEW_VERSION\" >> $GITHUB_ENV\n",[19,151,152,163,171,176],{"__ignoreMap":49},[53,153,154,156,158,160],{"class":55,"line":56},[53,155,60],{"class":59},[53,157,64],{"class":63},[53,159,67],{"class":59},[53,161,162],{"class":70},"Export latest geoip version\n",[53,164,165,167,169],{"class":55,"line":74},[53,166,127],{"class":63},[53,168,67],{"class":59},[53,170,133],{"class":132},[53,172,173],{"class":55,"line":85},[53,174,175],{"class":70},"    NEW_VERSION=`curl -s https://api.github.com/repos/{user_name}/{repo_name}/releases/latest | jq -r '.tag_name' | sed 's/v//g'`\n",[53,177,178],{"class":55,"line":94},[53,179,180],{"class":70},"    echo \"NEW_VERSION=$NEW_VERSION\" >> $GITHUB_ENV\n",[15,182,183],{},"当仓库内 spec 版本号与软件最新版本号不一致时，运行 rpmdev-bumpspec",[44,185,187],{"className":46,"code":186,"language":48,"meta":49,"style":49},"- name: Run rpmdev-bumpspec action\n  if: ${{ env.CURRENT_VERSION != env.NEW_VERSION }}\n  uses: netoarmando/rpmdev-bumpspec-action@v1\n  with: \n    specfile: '{filename}'\n    new: ${{ env.NEW_VERSION }}\n    userstring: \"username \u003Cusername@mail.com>\"\n",[19,188,189,200,210,219,226,237,248],{"__ignoreMap":49},[53,190,191,193,195,197],{"class":55,"line":56},[53,192,60],{"class":59},[53,194,64],{"class":63},[53,196,67],{"class":59},[53,198,199],{"class":70},"Run rpmdev-bumpspec action\n",[53,201,202,205,207],{"class":55,"line":74},[53,203,204],{"class":63},"  if",[53,206,67],{"class":59},[53,208,209],{"class":70},"${{ env.CURRENT_VERSION != env.NEW_VERSION }}\n",[53,211,212,214,216],{"class":55,"line":85},[53,213,77],{"class":63},[53,215,67],{"class":59},[53,217,218],{"class":70},"netoarmando/rpmdev-bumpspec-action@v1\n",[53,220,221,223],{"class":55,"line":94},[53,222,88],{"class":63},[53,224,225],{"class":59},": \n",[53,227,229,232,234],{"class":55,"line":228},5,[53,230,231],{"class":63},"    specfile",[53,233,67],{"class":59},[53,235,236],{"class":70},"'{filename}'\n",[53,238,240,243,245],{"class":55,"line":239},6,[53,241,242],{"class":63},"    new",[53,244,67],{"class":59},[53,246,247],{"class":70},"${{ env.NEW_VERSION }}\n",[53,249,251,254,256],{"class":55,"line":250},7,[53,252,253],{"class":63},"    userstring",[53,255,67],{"class":59},[53,257,258],{"class":70},"\"username \u003Cusername@mail.com>\"\n",[15,260,261],{},"当仓库内 spec 版本号与软件最新版本号不一致时，保存更改，推入仓库。",[44,263,265],{"className":46,"code":264,"language":48,"meta":49,"style":49},"- name: Commit changes\n  if: ${{ env.CURRENT_VERSION != env.NEW_VERSION }}\n  run: |\n    git config --local user.email \"zhullyb@outlook.com\"\n    git config --local user.name \"zhullyb\"\n    git add .\n    git commit -m \"upgpkg: v2ray-geoip@${{ env.NEW_VERSION }}\"\n    git push\n",[19,266,267,278,286,294,299,304,309,314],{"__ignoreMap":49},[53,268,269,271,273,275],{"class":55,"line":56},[53,270,60],{"class":59},[53,272,64],{"class":63},[53,274,67],{"class":59},[53,276,277],{"class":70},"Commit changes\n",[53,279,280,282,284],{"class":55,"line":74},[53,281,204],{"class":63},[53,283,67],{"class":59},[53,285,209],{"class":70},[53,287,288,290,292],{"class":55,"line":85},[53,289,127],{"class":63},[53,291,67],{"class":59},[53,293,133],{"class":132},[53,295,296],{"class":55,"line":94},[53,297,298],{"class":70},"    git config --local user.email \"zhullyb@outlook.com\"\n",[53,300,301],{"class":55,"line":228},[53,302,303],{"class":70},"    git config --local user.name \"zhullyb\"\n",[53,305,306],{"class":55,"line":239},[53,307,308],{"class":70},"    git add .\n",[53,310,311],{"class":55,"line":250},[53,312,313],{"class":70},"    git commit -m \"upgpkg: v2ray-geoip@${{ env.NEW_VERSION }}\"\n",[53,315,317],{"class":55,"line":316},8,[53,318,319],{"class":70},"    git push\n",[15,321,322],{},"（可选）当仓库内 spec 版本号与软件最新版本号不一致时，通过 curl 语句触发 copr 的 webhook，让 copr 进行构建。",[44,324,326],{"className":46,"code":325,"language":48,"meta":49,"style":49},"- name: trigger copr webhook\n  if: ${{ env.CURRENT_VERSION != env.NEW_VERSION }}\n  run: |\n    curl -X POST ${{ secrets.COPR_HOOK_URL }}v2ray-geoip/\n",[19,327,328,339,347,355],{"__ignoreMap":49},[53,329,330,332,334,336],{"class":55,"line":56},[53,331,60],{"class":59},[53,333,64],{"class":63},[53,335,67],{"class":59},[53,337,338],{"class":70},"trigger copr webhook\n",[53,340,341,343,345],{"class":55,"line":74},[53,342,204],{"class":63},[53,344,67],{"class":59},[53,346,209],{"class":70},[53,348,349,351,353],{"class":55,"line":85},[53,350,127],{"class":63},[53,352,67],{"class":59},[53,354,133],{"class":132},[53,356,357],{"class":55,"line":94},[53,358,359],{"class":70},"    curl -X POST ${{ secrets.COPR_HOOK_URL }}v2ray-geoip/\n",[15,361,362,363],{},"最终的 yml 文件可以参考",[27,364,367],{"href":365,"rel":366},"https://github.com/v2rayA/v2raya-copr/blob/master/.github/workflows/upgpkg-v2ray-geoip.yml",[31],"这里",[369,370,371],"style",{},"html pre.shiki code .s5ixo, html code.shiki .s5ixo{--shiki-default:#383A42;--shiki-dark:#ABB2BF}html pre.shiki code .sJa8x, html code.shiki .sJa8x{--shiki-default:#E45649;--shiki-dark:#E06C75}html pre.shiki code .sDhpE, html code.shiki .sDhpE{--shiki-default:#50A14F;--shiki-dark:#98C379}html pre.shiki code .sAGMh, html code.shiki .sAGMh{--shiki-default:#986801;--shiki-dark:#D19A66}html .default .shiki span {color: var(--shiki-default);background: var(--shiki-default-bg);font-style: var(--shiki-default-font-style);font-weight: var(--shiki-default-font-weight);text-decoration: var(--shiki-default-text-decoration);}html .shiki span {color: var(--shiki-default);background: var(--shiki-default-bg);font-style: var(--shiki-default-font-style);font-weight: var(--shiki-default-font-weight);text-decoration: var(--shiki-default-text-decoration);}html .dark .shiki span {color: var(--shiki-dark);background: var(--shiki-dark-bg);font-style: var(--shiki-dark-font-style);font-weight: var(--shiki-dark-font-weight);text-decoration: var(--shiki-dark-text-decoration);}html.dark .shiki span {color: var(--shiki-dark);background: var(--shiki-dark-bg);font-style: var(--shiki-dark-font-style);font-weight: var(--shiki-dark-font-weight);text-decoration: var(--shiki-dark-text-decoration);}html pre.shiki code .sLKXg, html code.shiki .sLKXg{--shiki-default:#A626A4;--shiki-dark:#C678DD}",{"title":49,"searchDepth":74,"depth":74,"links":373},[],"有一些软件包的上游本身就是使用 Github Action 发版的，每次 commit 都会触发 Github Action 去构建并分发新版本，使用构建时的时间日期作为版本号。针对这种包，手动更新费时费力，而规范的 specfile 应当是更新 %changelog 的，因此应当是使用 rpmdev-bumpspec 命令。只不过 rpmdev-bumpspec 需要在 rpm 系发行版或者装有 rpm 系列依赖包的发行版下执行，这不是随随便便一个 Linux 环境就能运行的。",[376,382],{"title":377,"path":378,"stem":379,"date":380,"lang":381,"children":-1},"以 Archlinux 中 makepkg 的方式打开 rpmbuild","/2024/05/03/open-rpmbuild-in-the-way-of-archlinux-makepkg","posts/zh/open-rpmbuild-in-the-way-of-archlinux-makepkg","2024-05-03 22:48:39","zh-CN",{"title":383,"path":384,"stem":385,"date":386,"lang":381,"children":-1},"使用 Python 生成甘特图(Gantt Chart)","/2024/04/24/generate-gantt-chart-with-python","posts/zh/generate-gantt-chart-with-python","2024-04-24 12:02:58",null,1765307569118]