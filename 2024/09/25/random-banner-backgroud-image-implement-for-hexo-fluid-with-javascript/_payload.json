[{"data":1,"prerenderedAt":560},["ShallowReactive",2],{"post-2024-09-25-random-banner-backgroud-image-implement-for-hexo-fluid-with-javascript":3,"surround-2024-09-25-random-banner-backgroud-image-implement-for-hexo-fluid-with-javascript":549,"randomIndex/2024/09/25/random-banner-backgroud-image-implement-for-hexo-fluid-with-javascript/":227},{"id":4,"title":5,"body":6,"date":537,"description":113,"extension":538,"meta":539,"navigation":380,"path":540,"rawbody":541,"seo":542,"stem":543,"sticky":544,"tags":545,"__hash__":548},"posts/posts/random-banner-backgroud-image-implement-for-hexo-fluid-with-javascript.md","基于 JavaScript 的 Hexo Fluid 主题 banner 随机背景图实现",{"type":7,"value":8,"toc":524},"minimark",[9,14,26,33,38,46,52,55,58,61,65,68,72,75,78,94,100,104,107,172,175,184,496,499,507,510,521],[10,11,13],"h2",{"id":12},"为什么要换掉随机图片-api","为什么要换掉随机图片 API",[15,16,17,18,25],"p",{},"因为 API 太慢了。根据 ",[19,20,24],"a",{"href":21,"rel":22},"https://pagespeed.web.dev/",[23],"nofollow","PageSpeed"," 的测速，使用 API 的图片加载时间来到了整整 2.5s，这似乎有些不可忍受。",[15,27,28],{},[29,30],"img",{"alt":31,"src":32},"PageSpeed 测速","https://static.031130.xyz/uploads/2024/09/25/3ef1a17bca955.webp",[34,35,37],"h3",{"id":36},"vercel-冷启动问题","Vercel 冷启动问题",[15,39,40,41,45],{},"当初年少无知，为了实现 banner 随机背景图，选择了",[19,42,44],{"href":43},"/2021/05/21/create-a-random-picture-api-with-vercel/","使用 vercel 创建随机图片 API","。这带来了一些问题，首先 vercel 在站点一段时间没人访问以后会进入一种类似休眠的模式，下一次启动将会经历一个冷启动（cold start）的过程。我认为这对于一个图片背景的随机 API 而言是不可忍受的。",[15,47,48],{},[29,49],{"alt":50,"src":51},"冷启动","https://static.031130.xyz/uploads/2024/09/24/f8cb9fd7a963e.webp",[15,53,54],{},"观察图上就可以发现，第一次访问时花费了 1.9 秒，第二次只需要 0.5 秒，这是因为第一次是冷启动，需要花费更多时间。",[34,56,57],{"id":57},"多一次网络请求",[15,59,60],{},"抛开冷启动不谈，引入 API 就会导致一次额外的网络请求。访客的浏览器将会先请求随机图片 API，然后根据 API 返回的 302 相应去请求真正的图片，而且这一过程是没法并行的，只能串行执行，这会浪费更多的等待时间。",[34,62,64],{"id":63},"vercel-在大陆境内的访问质量","Vercel 在大陆境内的访问质量",[15,66,67],{},"Vercel 在大陆境内的访问质量其实并不算好，即使是使用了所谓的优选节点，也不一定能保证整个大陆境内大部分访客都有不错的访问质量，因此使用 Vercel 搭建 API 的行为并不是最优解。",[10,69,71],{"id":70},"转向-javascript-实现","转向 JavaScript 实现",[15,73,74],{},"这个方案本身没多少复杂的，只不过是三年前的我对前端一无所知不敢操刀罢了。",[34,76,77],{"id":77},"删除原有的背景图",[15,79,80,81,85,86,89,90,93],{},"在 ",[82,83,84],"code",{},"_config.fluid.yml"," 中，将所有的 ",[82,87,88],{},"banner_img:"," 字段全部置空，防止其加载默认的 ",[82,91,92],{},"/img/default.png"," 而白白浪费用户的流量。这个字段一共在配置文件中出现了九次。",[15,95,96],{},[29,97],{"alt":98,"src":99},"字段置空","https://static.031130.xyz/uploads/2024/09/25/70bd0b27f5aad.webp",[34,101,103],{"id":102},"添加-js","添加 js",[15,105,106],{},"我们的目标是修改 id 为 banner 的 div 块的 backgroud 的 css 属性，Hexo Fluid 默认的生成内容是这样的",[108,109,114],"pre",{"className":110,"code":111,"language":112,"meta":113,"style":113},"language-html shiki shiki-themes one-light one-dark-pro","\u003Cdiv id=\"banner\" class=\"banner\" parallax=true style=\"background: url('/img/default.png') no-repeat center center; background-size: cover;\">\n","html","",[82,115,116],{"__ignoreMap":113},[117,118,121,125,129,133,136,140,143,145,147,150,152,155,158,160,163,167,169],"span",{"class":119,"line":120},"line",1,[117,122,124],{"class":123},"s5ixo","\u003C",[117,126,128],{"class":127},"sJa8x","div",[117,130,132],{"class":131},"sAGMh"," id",[117,134,135],{"class":123},"=",[117,137,139],{"class":138},"sDhpE","\"banner\"",[117,141,142],{"class":131}," class",[117,144,135],{"class":123},[117,146,139],{"class":138},[117,148,149],{"class":131}," parallax",[117,151,135],{"class":123},[117,153,154],{"class":138},"true",[117,156,157],{"class":131}," style",[117,159,135],{"class":123},[117,161,162],{"class":138},"\"",[117,164,166],{"class":165},"s-4uI","background: url('/img/default.png') no-repeat center center; background-size: cover;",[117,168,162],{"class":138},[117,170,171],{"class":123},">\n",[15,173,174],{},"我们可以通过 id 来定位这个元素，修改其 style.background 属性。",[15,176,177,178,183],{},"可以在任何地方引入下面的 js 代码，在这篇名为",[19,179,182],{"href":180,"rel":181},"https://www.zywvvd.com/notes/hexo/theme/fluid/fluid-add-umami/fluid-add-umami/",[23],"《Fluid -23- 添加 Umami 统计》"," 的文章里的方案是可供参考的。",[108,185,189],{"className":186,"code":187,"language":188,"meta":113,"style":113},"language-javascript shiki shiki-themes one-light one-dark-pro","const imgs = [\n    \"https://example.com/1.jpg\",\n    \"https://example.com/2.jpg\",\n    \"https://example.com/3.jpg\",\n    \"https://example.com/4.jpg\",\n    \"https://example.com/5.jpg\",\n    \"https://example.com/6.jpg\",\n    \"https://example.com/7.jpg\",\n    \"https://example.com/8.jpg\",\n    \"https://example.com/9.jpg\",\n    \"https://example.com/10.jpg\",\n    \"https://example.com/11.jpg\",\n    \"https://example.com/12.jpg\",\n    \"https://example.com/13.jpg\",\n    \"https://example.com/14.jpg\",\n    \"https://example.com/15.jpg\",\n    \"https://example.com/16.jpg\",\n    \"https://example.com/17.jpg\",\n    \"https://example.com/18.jpg\",\n    \"https://example.com/19.jpg\",\n    \"https://example.com/20.jpg\",\n]\n\nconst luck_img = imgs[Math.floor(Math.random() * imgs.length)]\nconst banner = document.getElementById('banner')\nbanner.style.background = `url(${luck_img}) center center / cover no-repeat`\n","javascript",[82,190,191,208,217,225,233,241,249,257,265,273,281,289,297,305,313,321,329,337,345,353,361,369,375,382,435,461],{"__ignoreMap":113},[117,192,193,197,201,205],{"class":119,"line":120},[117,194,196],{"class":195},"sLKXg","const",[117,198,200],{"class":199},"sNmU0"," imgs",[117,202,204],{"class":203},"s_Sar"," =",[117,206,207],{"class":123}," [\n",[117,209,211,214],{"class":119,"line":210},2,[117,212,213],{"class":138},"    \"https://example.com/1.jpg\"",[117,215,216],{"class":123},",\n",[117,218,220,223],{"class":119,"line":219},3,[117,221,222],{"class":138},"    \"https://example.com/2.jpg\"",[117,224,216],{"class":123},[117,226,228,231],{"class":119,"line":227},4,[117,229,230],{"class":138},"    \"https://example.com/3.jpg\"",[117,232,216],{"class":123},[117,234,236,239],{"class":119,"line":235},5,[117,237,238],{"class":138},"    \"https://example.com/4.jpg\"",[117,240,216],{"class":123},[117,242,244,247],{"class":119,"line":243},6,[117,245,246],{"class":138},"    \"https://example.com/5.jpg\"",[117,248,216],{"class":123},[117,250,252,255],{"class":119,"line":251},7,[117,253,254],{"class":138},"    \"https://example.com/6.jpg\"",[117,256,216],{"class":123},[117,258,260,263],{"class":119,"line":259},8,[117,261,262],{"class":138},"    \"https://example.com/7.jpg\"",[117,264,216],{"class":123},[117,266,268,271],{"class":119,"line":267},9,[117,269,270],{"class":138},"    \"https://example.com/8.jpg\"",[117,272,216],{"class":123},[117,274,276,279],{"class":119,"line":275},10,[117,277,278],{"class":138},"    \"https://example.com/9.jpg\"",[117,280,216],{"class":123},[117,282,284,287],{"class":119,"line":283},11,[117,285,286],{"class":138},"    \"https://example.com/10.jpg\"",[117,288,216],{"class":123},[117,290,292,295],{"class":119,"line":291},12,[117,293,294],{"class":138},"    \"https://example.com/11.jpg\"",[117,296,216],{"class":123},[117,298,300,303],{"class":119,"line":299},13,[117,301,302],{"class":138},"    \"https://example.com/12.jpg\"",[117,304,216],{"class":123},[117,306,308,311],{"class":119,"line":307},14,[117,309,310],{"class":138},"    \"https://example.com/13.jpg\"",[117,312,216],{"class":123},[117,314,316,319],{"class":119,"line":315},15,[117,317,318],{"class":138},"    \"https://example.com/14.jpg\"",[117,320,216],{"class":123},[117,322,324,327],{"class":119,"line":323},16,[117,325,326],{"class":138},"    \"https://example.com/15.jpg\"",[117,328,216],{"class":123},[117,330,332,335],{"class":119,"line":331},17,[117,333,334],{"class":138},"    \"https://example.com/16.jpg\"",[117,336,216],{"class":123},[117,338,340,343],{"class":119,"line":339},18,[117,341,342],{"class":138},"    \"https://example.com/17.jpg\"",[117,344,216],{"class":123},[117,346,348,351],{"class":119,"line":347},19,[117,349,350],{"class":138},"    \"https://example.com/18.jpg\"",[117,352,216],{"class":123},[117,354,356,359],{"class":119,"line":355},20,[117,357,358],{"class":138},"    \"https://example.com/19.jpg\"",[117,360,216],{"class":123},[117,362,364,367],{"class":119,"line":363},21,[117,365,366],{"class":138},"    \"https://example.com/20.jpg\"",[117,368,216],{"class":123},[117,370,372],{"class":119,"line":371},22,[117,373,374],{"class":123},"]\n",[117,376,378],{"class":119,"line":377},23,[117,379,381],{"emptyLinePlaceholder":380},true,"\n",[117,383,385,387,390,392,395,398,402,405,409,412,414,416,419,422,425,427,429,432],{"class":119,"line":384},24,[117,386,196],{"class":195},[117,388,389],{"class":199}," luck_img",[117,391,204],{"class":203},[117,393,200],{"class":394},"sz0mV",[117,396,397],{"class":123},"[",[117,399,401],{"class":400},"s7GmK","Math",[117,403,404],{"class":123},".",[117,406,408],{"class":407},"sAdtL","floor",[117,410,411],{"class":123},"(",[117,413,401],{"class":400},[117,415,404],{"class":123},[117,417,418],{"class":407},"random",[117,420,421],{"class":123},"() ",[117,423,424],{"class":203},"*",[117,426,200],{"class":400},[117,428,404],{"class":123},[117,430,431],{"class":127},"length",[117,433,434],{"class":123},")]\n",[117,436,438,440,443,445,448,450,453,455,458],{"class":119,"line":437},25,[117,439,196],{"class":195},[117,441,442],{"class":199}," banner",[117,444,204],{"class":203},[117,446,447],{"class":400}," document",[117,449,404],{"class":123},[117,451,452],{"class":407},"getElementById",[117,454,411],{"class":123},[117,456,457],{"class":138},"'banner'",[117,459,460],{"class":123},")\n",[117,462,464,467,469,473,475,478,480,483,487,490,493],{"class":119,"line":463},26,[117,465,466],{"class":400},"banner",[117,468,404],{"class":123},[117,470,472],{"class":471},"s2QsP","style",[117,474,404],{"class":123},[117,476,477],{"class":127},"background",[117,479,204],{"class":203},[117,481,482],{"class":138}," `url(",[117,484,486],{"class":485},"sAOjX","${",[117,488,489],{"class":394},"luck_img",[117,491,492],{"class":485},"}",[117,494,495],{"class":138},") center center / cover no-repeat`\n",[10,497,498],{"id":498},"成果",[15,500,501,502,506],{},"博客能够在不引入外部 api 的情况下通过 js 自主实现随机的 banner 背景图，",[503,504,505],"del",{},"但 pagespeed 的测速结果并没有明显好转","，因为 pagespeed 模拟了低速 4G 的访问速度，无论如何都无法提升大文件的加载速度。不过避免了多一次网络请求后，打开页面时的加载速度确实有提升。",[10,508,509],{"id":509},"参见",[511,512,513],"ul",{},[514,515,516],"li",{},[19,517,520],{"href":518,"rel":519},"https://vercel.com/guides/how-can-i-improve-serverless-function-lambda-cold-start-performance-on-vercel",[23],"How can I improve function cold start performance on Vercel?",[472,522,523],{},"html pre.shiki code .s5ixo, html code.shiki .s5ixo{--shiki-default:#383A42;--shiki-dark:#ABB2BF}html pre.shiki code .sJa8x, html code.shiki .sJa8x{--shiki-default:#E45649;--shiki-dark:#E06C75}html pre.shiki code .sAGMh, html code.shiki .sAGMh{--shiki-default:#986801;--shiki-dark:#D19A66}html pre.shiki code .sDhpE, html code.shiki .sDhpE{--shiki-default:#50A14F;--shiki-dark:#98C379}html pre.shiki code .s-4uI, html code.shiki .s-4uI{--shiki-default:#383A42;--shiki-dark:#98C379}html .default .shiki span {color: var(--shiki-default);background: var(--shiki-default-bg);font-style: var(--shiki-default-font-style);font-weight: var(--shiki-default-font-weight);text-decoration: var(--shiki-default-text-decoration);}html .shiki span {color: var(--shiki-default);background: var(--shiki-default-bg);font-style: var(--shiki-default-font-style);font-weight: var(--shiki-default-font-weight);text-decoration: var(--shiki-default-text-decoration);}html .dark .shiki span {color: var(--shiki-dark);background: var(--shiki-dark-bg);font-style: var(--shiki-dark-font-style);font-weight: var(--shiki-dark-font-weight);text-decoration: var(--shiki-dark-text-decoration);}html.dark .shiki span {color: var(--shiki-dark);background: var(--shiki-dark-bg);font-style: var(--shiki-dark-font-style);font-weight: var(--shiki-dark-font-weight);text-decoration: var(--shiki-dark-text-decoration);}html pre.shiki code .sLKXg, html code.shiki .sLKXg{--shiki-default:#A626A4;--shiki-dark:#C678DD}html pre.shiki code .sNmU0, html code.shiki .sNmU0{--shiki-default:#986801;--shiki-dark:#E5C07B}html pre.shiki code .s_Sar, html code.shiki .s_Sar{--shiki-default:#0184BC;--shiki-dark:#56B6C2}html pre.shiki code .sz0mV, html code.shiki .sz0mV{--shiki-default:#383A42;--shiki-dark:#E06C75}html pre.shiki code .s7GmK, html code.shiki .s7GmK{--shiki-default:#383A42;--shiki-dark:#E5C07B}html pre.shiki code .sAdtL, html code.shiki .sAdtL{--shiki-default:#4078F2;--shiki-dark:#61AFEF}html pre.shiki code .s2QsP, html code.shiki .s2QsP{--shiki-default:#E45649;--shiki-dark:#E5C07B}html pre.shiki code .sAOjX, html code.shiki .sAOjX{--shiki-default:#CA1243;--shiki-dark:#C678DD}",{"title":113,"searchDepth":210,"depth":210,"links":525},[526,531,535,536],{"id":12,"depth":210,"text":13,"children":527},[528,529,530],{"id":36,"depth":219,"text":37},{"id":57,"depth":219,"text":57},{"id":63,"depth":219,"text":64},{"id":70,"depth":210,"text":71,"children":532},[533,534],{"id":77,"depth":219,"text":77},{"id":102,"depth":219,"text":103},{"id":498,"depth":210,"text":498},{"id":509,"depth":210,"text":509},"2024-09-25 00:00:42","md",{},"/2024/09/25/random-banner-backgroud-image-implement-for-hexo-fluid-with-javascript","---\ntitle: 基于 JavaScript 的 Hexo Fluid 主题 banner 随机背景图实现\ndate: 2024-09-25 00:00:42\nsticky:\ntags:\n- JavaScript\n- Hexo\n---\n\n## 为什么要换掉随机图片 API\n\n因为 API 太慢了。根据 [PageSpeed](https://pagespeed.web.dev/) 的测速，使用 API 的图片加载时间来到了整整 2.5s，这似乎有些不可忍受。\n\n![PageSpeed 测速](https://static.031130.xyz/uploads/2024/09/25/3ef1a17bca955.webp)\n\n### Vercel 冷启动问题\n\n当初年少无知，为了实现 banner 随机背景图，选择了[使用 vercel 创建随机图片 API](/2021/05/21/create-a-random-picture-api-with-vercel/)。这带来了一些问题，首先 vercel 在站点一段时间没人访问以后会进入一种类似休眠的模式，下一次启动将会经历一个冷启动（cold start）的过程。我认为这对于一个图片背景的随机 API 而言是不可忍受的。\n\n![冷启动](https://static.031130.xyz/uploads/2024/09/24/f8cb9fd7a963e.webp)\n\n观察图上就可以发现，第一次访问时花费了 1.9 秒，第二次只需要 0.5 秒，这是因为第一次是冷启动，需要花费更多时间。\n\n### 多一次网络请求\n\n抛开冷启动不谈，引入 API 就会导致一次额外的网络请求。访客的浏览器将会先请求随机图片 API，然后根据 API 返回的 302 相应去请求真正的图片，而且这一过程是没法并行的，只能串行执行，这会浪费更多的等待时间。\n\n### Vercel 在大陆境内的访问质量\n\nVercel 在大陆境内的访问质量其实并不算好，即使是使用了所谓的优选节点，也不一定能保证整个大陆境内大部分访客都有不错的访问质量，因此使用 Vercel 搭建 API 的行为并不是最优解。\n\n## 转向 JavaScript 实现\n\n这个方案本身没多少复杂的，只不过是三年前的我对前端一无所知不敢操刀罢了。\n\n### 删除原有的背景图\n\n在 `_config.fluid.yml` 中，将所有的 `banner_img:` 字段全部置空，防止其加载默认的 `/img/default.png` 而白白浪费用户的流量。这个字段一共在配置文件中出现了九次。\n\n![字段置空](https://static.031130.xyz/uploads/2024/09/25/70bd0b27f5aad.webp)\n\n### 添加 js\n\n我们的目标是修改 id 为 banner 的 div 块的 backgroud 的 css 属性，Hexo Fluid 默认的生成内容是这样的\n\n```html\n\u003Cdiv id=\"banner\" class=\"banner\" parallax=true style=\"background: url('/img/default.png') no-repeat center center; background-size: cover;\">\n```\n\n我们可以通过 id 来定位这个元素，修改其 style.background 属性。\n\n可以在任何地方引入下面的 js 代码，在这篇名为[《Fluid -23- 添加 Umami 统计》](https://www.zywvvd.com/notes/hexo/theme/fluid/fluid-add-umami/fluid-add-umami/) 的文章里的方案是可供参考的。\n\n```javascript\nconst imgs = [\n    \"https://example.com/1.jpg\",\n    \"https://example.com/2.jpg\",\n    \"https://example.com/3.jpg\",\n    \"https://example.com/4.jpg\",\n    \"https://example.com/5.jpg\",\n    \"https://example.com/6.jpg\",\n    \"https://example.com/7.jpg\",\n    \"https://example.com/8.jpg\",\n    \"https://example.com/9.jpg\",\n    \"https://example.com/10.jpg\",\n    \"https://example.com/11.jpg\",\n    \"https://example.com/12.jpg\",\n    \"https://example.com/13.jpg\",\n    \"https://example.com/14.jpg\",\n    \"https://example.com/15.jpg\",\n    \"https://example.com/16.jpg\",\n    \"https://example.com/17.jpg\",\n    \"https://example.com/18.jpg\",\n    \"https://example.com/19.jpg\",\n    \"https://example.com/20.jpg\",\n]\n\nconst luck_img = imgs[Math.floor(Math.random() * imgs.length)]\nconst banner = document.getElementById('banner')\nbanner.style.background = `url(${luck_img}) center center / cover no-repeat`\n```\n\n## 成果\n\n博客能够在不引入外部 api 的情况下通过 js 自主实现随机的 banner 背景图，~~但 pagespeed 的测速结果并没有明显好转~~，因为 pagespeed 模拟了低速 4G 的访问速度，无论如何都无法提升大文件的加载速度。不过避免了多一次网络请求后，打开页面时的加载速度确实有提升。\n\n## 参见\n\n- [How can I improve function cold start performance on Vercel?](https://vercel.com/guides/how-can-i-improve-serverless-function-lambda-cold-start-performance-on-vercel)\n",{"title":5,"description":113},"posts/random-banner-backgroud-image-implement-for-hexo-fluid-with-javascript",false,[546,547],"JavaScript","Hexo","TC5cNdl0cBMAstXel5o0RbKCFuAF5KIK9o4QBJTXVNU",[550,555],{"title":551,"path":552,"stem":553,"date":554,"children":-1},"使用 GPT 对 waline 的评论进行审查","/2024/10/12/use-gpt-to-review-waline-comments","posts/use-gpt-to-review-waline-comments","2024-10-12 16:11:06",{"title":556,"path":557,"stem":558,"date":559,"children":-1},"使用向日葵智能插座 C2 用电记录推算宿舍上次烧水时间","/2024/09/24/log-last-water-boiling-water-with-sunlogin-adapter-power-consumption","posts/log-last-water-boiling-water-with-sunlogin-adapter-power-consumption","2024-09-24 05:17:47",1762358123670]