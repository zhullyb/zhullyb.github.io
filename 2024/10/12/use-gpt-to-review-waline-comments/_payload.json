[{"data":1,"prerenderedAt":1267},["ShallowReactive",2],{"post-2024-10-12-use-gpt-to-review-waline-comments":3,"surround-2024-10-12-use-gpt-to-review-waline-comments":1256,"randomIndex/2024/10/12/use-gpt-to-review-waline-comments/":115},{"id":4,"title":5,"body":6,"date":1243,"description":12,"extension":1244,"meta":1245,"navigation":82,"path":1247,"rawbody":1248,"seo":1249,"stem":1250,"sticky":1251,"tags":1252,"__hash__":1255},"posts/posts/use-gpt-to-review-waline-comments.md","使用 GPT 对 waline 的评论进行审查",{"type":7,"value":8,"toc":1241},"minimark",[9,13,30,33,40,49,58,697,712,715,718,721,1003,1006,1017,1023,1041,1046,1176,1181,1229,1232,1237],[10,11,12],"p",{},"前一阵子收到了这么一条来自 waline 的评论提醒。",[14,15,16],"blockquote",{},[10,17,18,19,24,25],{},"New comment on 竹林里有冰的博客\n【网站名称】：竹林里有冰的博客\n【评论者昵称】：专业数据库\n【评论者邮箱】：",[20,21,23],"a",{"href":22},"mailto:rakhiranijhhg@gmail.com","rakhiranijhhg@gmail.com","\n【内容】：总之，优化专业数据库对于保持数据准确性、提高系统性能和推动业务成功至关重要。通过遵循本文中概述的策略，您可以提高数据库操作的效率并释放新的增长机会。\n【地址】：",[20,26,27],{"href":27,"rel":28},"https://zhul.in/2021/04/04/yay-more/#66f7a8889ab78865d5f5ae19",[29],"nofollow",[10,31,32],{},"评论的内容不仅透露着一股 AI 味，还和文章内容可谓是一点关系都没有，点开评论者的网站一看，一股塑料机翻味，怕是又是个来蹭 SEO 的广告哥。",[10,34,35],{},[36,37],"img",{"alt":38,"src":39},"广告哥留下的网站","https://static.031130.xyz/uploads/2024/10/07/4673580090861.webp",[10,41,42,43,48],{},"根据 ",[20,44,47],{"href":45,"rel":46},"https://waline.js.org/advanced/faq.html#%E5%8F%91%E5%B8%83%E8%AF%84%E8%AE%BA%E5%BE%88%E6%85%A2%E6%80%8E%E4%B9%88%E5%8A%9E",[29],"waline 的官方文档","所言，waline 是使用了 Akismet 提供的垃圾内容检测服务的。可惜它似乎对 AI 生成的垃圾没有分辨能力。因此我计划使用 GPT 代替 Akismet 对 waline 的新评论进行审核。",[10,50,51,52,57],{},"walinejs/plugin 提供了一个 ",[20,53,56],{"href":54,"rel":55},"https://github.com/walinejs/plugins/blob/master/packages/tencent-tms/index.js",[29],"tencent-cms"," 的插件，功能是使用腾讯云的内容审查接口审查评论内容，这和我们需要的功能很像，主体部分和调用方法可以直接借鉴。",[59,60,65],"pre",{"className":61,"code":62,"language":63,"meta":64,"style":64},"language-javascript shiki shiki-themes github-light github-dark","// index.js\n\nconst tencentcloud = require(\"tencentcloud-sdk-nodejs-tms\");\nconst TmsClient = tencentcloud.tms.v20201229.Client;\n\n\nmodule.exports = function({secretId, secretKey, region}) {\n  if (!secretId || !secretKey || !region) {\n    return {};\n  }\n\n  const clientConfig = {\n    credential: {\n      secretId,\n      secretKey,\n    },\n    region,\n    profile: {\n      httpProfile: {\n        endpoint: \"tms.tencentcloudapi.com\",\n      },\n    },\n  };\n  \n  return {\n    hooks: {\n      async preSave(data) {\n        const { userInfo } = this.ctx.state;\n        const isAdmin = userInfo.type === 'administrator';\n        // ignore admin comment\n        if (isAdmin) {\n          return;\n        }\n\n        const client = new TmsClient(clientConfig);\n        try {\n          const resp = await client.TextModeration({ Content: data.comment });\n          if (!resp.Suggestion) {\n            throw new Error('Suggestion is empty. Tencent Cloud TMS info:', resp);\n          }\n\n          switch(resp.Suggestion) {\n            case 'Pass':\n              data.status = 'approved';\n              break;\n            case 'Block':\n              data.status = 'spam';\n              break;\n              case 'Review':\n              default:\n                data.status = 'waiting';\n                break;\n          }\n        } catch(e) {\n          console.log(e);\n          data.status = 'waiting';\n        }\n      },\n    },\n  };\n}\n","javascript","",[66,67,68,77,84,113,126,131,136,174,205,214,220,225,239,245,251,257,263,269,275,281,293,299,304,310,316,324,330,347,371,393,399,408,416,422,427,445,453,476,489,508,514,519,528,540,553,561,571,583,590,601,609,622,630,635,647,659,671,676,681,686,691],"code",{"__ignoreMap":64},[69,70,73],"span",{"class":71,"line":72},"line",1,[69,74,76],{"class":75},"sJ8bj","// index.js\n",[69,78,80],{"class":71,"line":79},2,[69,81,83],{"emptyLinePlaceholder":82},true,"\n",[69,85,87,91,95,98,102,106,110],{"class":71,"line":86},3,[69,88,90],{"class":89},"szBVR","const",[69,92,94],{"class":93},"sj4cs"," tencentcloud",[69,96,97],{"class":89}," =",[69,99,101],{"class":100},"sScJk"," require",[69,103,105],{"class":104},"sVt8B","(",[69,107,109],{"class":108},"sZZnC","\"tencentcloud-sdk-nodejs-tms\"",[69,111,112],{"class":104},");\n",[69,114,116,118,121,123],{"class":71,"line":115},4,[69,117,90],{"class":89},[69,119,120],{"class":93}," TmsClient",[69,122,97],{"class":89},[69,124,125],{"class":104}," tencentcloud.tms.v20201229.Client;\n",[69,127,129],{"class":71,"line":128},5,[69,130,83],{"emptyLinePlaceholder":82},[69,132,134],{"class":71,"line":133},6,[69,135,83],{"emptyLinePlaceholder":82},[69,137,139,142,145,148,150,153,156,160,163,166,168,171],{"class":71,"line":138},7,[69,140,141],{"class":93},"module",[69,143,144],{"class":104},".",[69,146,147],{"class":93},"exports",[69,149,97],{"class":89},[69,151,152],{"class":89}," function",[69,154,155],{"class":104},"({",[69,157,159],{"class":158},"s4XuR","secretId",[69,161,162],{"class":104},", ",[69,164,165],{"class":158},"secretKey",[69,167,162],{"class":104},[69,169,170],{"class":158},"region",[69,172,173],{"class":104},"}) {\n",[69,175,177,180,183,186,189,192,195,198,200,202],{"class":71,"line":176},8,[69,178,179],{"class":89},"  if",[69,181,182],{"class":104}," (",[69,184,185],{"class":89},"!",[69,187,188],{"class":104},"secretId ",[69,190,191],{"class":89},"||",[69,193,194],{"class":89}," !",[69,196,197],{"class":104},"secretKey ",[69,199,191],{"class":89},[69,201,194],{"class":89},[69,203,204],{"class":104},"region) {\n",[69,206,208,211],{"class":71,"line":207},9,[69,209,210],{"class":89},"    return",[69,212,213],{"class":104}," {};\n",[69,215,217],{"class":71,"line":216},10,[69,218,219],{"class":104},"  }\n",[69,221,223],{"class":71,"line":222},11,[69,224,83],{"emptyLinePlaceholder":82},[69,226,228,231,234,236],{"class":71,"line":227},12,[69,229,230],{"class":89},"  const",[69,232,233],{"class":93}," clientConfig",[69,235,97],{"class":89},[69,237,238],{"class":104}," {\n",[69,240,242],{"class":71,"line":241},13,[69,243,244],{"class":104},"    credential: {\n",[69,246,248],{"class":71,"line":247},14,[69,249,250],{"class":104},"      secretId,\n",[69,252,254],{"class":71,"line":253},15,[69,255,256],{"class":104},"      secretKey,\n",[69,258,260],{"class":71,"line":259},16,[69,261,262],{"class":104},"    },\n",[69,264,266],{"class":71,"line":265},17,[69,267,268],{"class":104},"    region,\n",[69,270,272],{"class":71,"line":271},18,[69,273,274],{"class":104},"    profile: {\n",[69,276,278],{"class":71,"line":277},19,[69,279,280],{"class":104},"      httpProfile: {\n",[69,282,284,287,290],{"class":71,"line":283},20,[69,285,286],{"class":104},"        endpoint: ",[69,288,289],{"class":108},"\"tms.tencentcloudapi.com\"",[69,291,292],{"class":104},",\n",[69,294,296],{"class":71,"line":295},21,[69,297,298],{"class":104},"      },\n",[69,300,302],{"class":71,"line":301},22,[69,303,262],{"class":104},[69,305,307],{"class":71,"line":306},23,[69,308,309],{"class":104},"  };\n",[69,311,313],{"class":71,"line":312},24,[69,314,315],{"class":104},"  \n",[69,317,319,322],{"class":71,"line":318},25,[69,320,321],{"class":89},"  return",[69,323,238],{"class":104},[69,325,327],{"class":71,"line":326},26,[69,328,329],{"class":104},"    hooks: {\n",[69,331,333,336,339,341,344],{"class":71,"line":332},27,[69,334,335],{"class":89},"      async",[69,337,338],{"class":100}," preSave",[69,340,105],{"class":104},[69,342,343],{"class":158},"data",[69,345,346],{"class":104},") {\n",[69,348,350,353,356,359,362,365,368],{"class":71,"line":349},28,[69,351,352],{"class":89},"        const",[69,354,355],{"class":104}," { ",[69,357,358],{"class":93},"userInfo",[69,360,361],{"class":104}," } ",[69,363,364],{"class":89},"=",[69,366,367],{"class":93}," this",[69,369,370],{"class":104},".ctx.state;\n",[69,372,374,376,379,381,384,387,390],{"class":71,"line":373},29,[69,375,352],{"class":89},[69,377,378],{"class":93}," isAdmin",[69,380,97],{"class":89},[69,382,383],{"class":104}," userInfo.type ",[69,385,386],{"class":89},"===",[69,388,389],{"class":108}," 'administrator'",[69,391,392],{"class":104},";\n",[69,394,396],{"class":71,"line":395},30,[69,397,398],{"class":75},"        // ignore admin comment\n",[69,400,402,405],{"class":71,"line":401},31,[69,403,404],{"class":89},"        if",[69,406,407],{"class":104}," (isAdmin) {\n",[69,409,411,414],{"class":71,"line":410},32,[69,412,413],{"class":89},"          return",[69,415,392],{"class":104},[69,417,419],{"class":71,"line":418},33,[69,420,421],{"class":104},"        }\n",[69,423,425],{"class":71,"line":424},34,[69,426,83],{"emptyLinePlaceholder":82},[69,428,430,432,435,437,440,442],{"class":71,"line":429},35,[69,431,352],{"class":89},[69,433,434],{"class":93}," client",[69,436,97],{"class":89},[69,438,439],{"class":89}," new",[69,441,120],{"class":100},[69,443,444],{"class":104},"(clientConfig);\n",[69,446,448,451],{"class":71,"line":447},36,[69,449,450],{"class":89},"        try",[69,452,238],{"class":104},[69,454,456,459,462,464,467,470,473],{"class":71,"line":455},37,[69,457,458],{"class":89},"          const",[69,460,461],{"class":93}," resp",[69,463,97],{"class":89},[69,465,466],{"class":89}," await",[69,468,469],{"class":104}," client.",[69,471,472],{"class":100},"TextModeration",[69,474,475],{"class":104},"({ Content: data.comment });\n",[69,477,479,482,484,486],{"class":71,"line":478},38,[69,480,481],{"class":89},"          if",[69,483,182],{"class":104},[69,485,185],{"class":89},[69,487,488],{"class":104},"resp.Suggestion) {\n",[69,490,492,495,497,500,502,505],{"class":71,"line":491},39,[69,493,494],{"class":89},"            throw",[69,496,439],{"class":89},[69,498,499],{"class":100}," Error",[69,501,105],{"class":104},[69,503,504],{"class":108},"'Suggestion is empty. Tencent Cloud TMS info:'",[69,506,507],{"class":104},", resp);\n",[69,509,511],{"class":71,"line":510},40,[69,512,513],{"class":104},"          }\n",[69,515,517],{"class":71,"line":516},41,[69,518,83],{"emptyLinePlaceholder":82},[69,520,522,525],{"class":71,"line":521},42,[69,523,524],{"class":89},"          switch",[69,526,527],{"class":104},"(resp.Suggestion) {\n",[69,529,531,534,537],{"class":71,"line":530},43,[69,532,533],{"class":89},"            case",[69,535,536],{"class":108}," 'Pass'",[69,538,539],{"class":104},":\n",[69,541,543,546,548,551],{"class":71,"line":542},44,[69,544,545],{"class":104},"              data.status ",[69,547,364],{"class":89},[69,549,550],{"class":108}," 'approved'",[69,552,392],{"class":104},[69,554,556,559],{"class":71,"line":555},45,[69,557,558],{"class":89},"              break",[69,560,392],{"class":104},[69,562,564,566,569],{"class":71,"line":563},46,[69,565,533],{"class":89},[69,567,568],{"class":108}," 'Block'",[69,570,539],{"class":104},[69,572,574,576,578,581],{"class":71,"line":573},47,[69,575,545],{"class":104},[69,577,364],{"class":89},[69,579,580],{"class":108}," 'spam'",[69,582,392],{"class":104},[69,584,586,588],{"class":71,"line":585},48,[69,587,558],{"class":89},[69,589,392],{"class":104},[69,591,593,596,599],{"class":71,"line":592},49,[69,594,595],{"class":89},"              case",[69,597,598],{"class":108}," 'Review'",[69,600,539],{"class":104},[69,602,604,607],{"class":71,"line":603},50,[69,605,606],{"class":89},"              default",[69,608,539],{"class":104},[69,610,612,615,617,620],{"class":71,"line":611},51,[69,613,614],{"class":104},"                data.status ",[69,616,364],{"class":89},[69,618,619],{"class":108}," 'waiting'",[69,621,392],{"class":104},[69,623,625,628],{"class":71,"line":624},52,[69,626,627],{"class":89},"                break",[69,629,392],{"class":104},[69,631,633],{"class":71,"line":632},53,[69,634,513],{"class":104},[69,636,638,641,644],{"class":71,"line":637},54,[69,639,640],{"class":104},"        } ",[69,642,643],{"class":89},"catch",[69,645,646],{"class":104},"(e) {\n",[69,648,650,653,656],{"class":71,"line":649},55,[69,651,652],{"class":104},"          console.",[69,654,655],{"class":100},"log",[69,657,658],{"class":104},"(e);\n",[69,660,662,665,667,669],{"class":71,"line":661},56,[69,663,664],{"class":104},"          data.status ",[69,666,364],{"class":89},[69,668,619],{"class":108},[69,670,392],{"class":104},[69,672,674],{"class":71,"line":673},57,[69,675,421],{"class":104},[69,677,679],{"class":71,"line":678},58,[69,680,298],{"class":104},[69,682,684],{"class":71,"line":683},59,[69,685,262],{"class":104},[69,687,689],{"class":71,"line":688},60,[69,690,309],{"class":104},[69,692,694],{"class":71,"line":693},61,[69,695,696],{"class":104},"}\n",[10,698,699,700,705,706,711],{},"可以看到，我们需要在这个被 module.exports 导出的函数中，return 一个对象，如果使用 hooks 编写的话可以调用",[20,701,704],{"href":702,"rel":703},"https://waline.js.org/reference/server/config.html#%E8%AF%84%E8%AE%BA-hooks",[29],"一些生命周期 hook",": 在 preSave 阶段，我们可以通过标注 data.status 参数来反馈评论类型。approved 为接受，spam 为垃圾邮件，waiting 为等待人工审核；除此之外，还可以",[20,707,710],{"href":708,"rel":709},"https://waline.js.org/reference/server/plugin.html#%E5%9F%BA%E4%BA%8E%E4%B8%AD%E9%97%B4%E4%BB%B6%E5%88%B6%E4%BD%9C",[29],"基于 Koa 中间件制作插件","，文档中有具体的描述。",[10,713,714],{},"index.js 顶部是需要引入的依赖。当然，如果需要引入外部的第三方包的话，需要在 packages.json 中加入需要的依赖（使用包管理器的命令进行安装）。",[10,716,717],{},"有了这些基础知识，就能手搓一个基于 GPT 的评论审查插件。",[10,719,720],{},"OpenAI 提供的是标准的 Restful API，本身的鉴权逻辑也不复杂，其实没必要调用 SDK，直接使用 fetch 调用就行。",[59,722,724],{"className":61,"code":723,"language":63,"meta":64,"style":64},"const doReview = async (comment) => {\n  const response = await fetch(openaiBaseUrl + '/v1/chat/completions', {\n    method: 'POST',\n    headers: {\n      'Content-Type': 'application/json',\n      'Authorization': `Bearer ${openaiApiKey}`,\n    },\n    body: JSON.stringify({\n      model: openaiModel,\n      messages: [\n        {\n          role: 'system',\n          content: prompt\n        },\n        {\n          role: 'user',\n          content: comment,\n        },\n      ],\n    }),\n  });\n  const data = await response.json();\n  if (data && data.choices && data.choices.length > 0) {\n    return data.choices[0].message.content;\n  } else {\n    return 'waiting';\n  }\n}\n",[66,725,726,751,777,787,792,805,823,827,843,848,853,858,868,873,878,882,891,896,900,905,910,915,935,964,977,987,995,999],{"__ignoreMap":64},[69,727,728,730,733,735,738,740,743,746,749],{"class":71,"line":72},[69,729,90],{"class":89},[69,731,732],{"class":100}," doReview",[69,734,97],{"class":89},[69,736,737],{"class":89}," async",[69,739,182],{"class":104},[69,741,742],{"class":158},"comment",[69,744,745],{"class":104},") ",[69,747,748],{"class":89},"=>",[69,750,238],{"class":104},[69,752,753,755,758,760,762,765,768,771,774],{"class":71,"line":79},[69,754,230],{"class":89},[69,756,757],{"class":93}," response",[69,759,97],{"class":89},[69,761,466],{"class":89},[69,763,764],{"class":100}," fetch",[69,766,767],{"class":104},"(openaiBaseUrl ",[69,769,770],{"class":89},"+",[69,772,773],{"class":108}," '/v1/chat/completions'",[69,775,776],{"class":104},", {\n",[69,778,779,782,785],{"class":71,"line":86},[69,780,781],{"class":104},"    method: ",[69,783,784],{"class":108},"'POST'",[69,786,292],{"class":104},[69,788,789],{"class":71,"line":115},[69,790,791],{"class":104},"    headers: {\n",[69,793,794,797,800,803],{"class":71,"line":128},[69,795,796],{"class":108},"      'Content-Type'",[69,798,799],{"class":104},": ",[69,801,802],{"class":108},"'application/json'",[69,804,292],{"class":104},[69,806,807,810,812,815,818,821],{"class":71,"line":133},[69,808,809],{"class":108},"      'Authorization'",[69,811,799],{"class":104},[69,813,814],{"class":108},"`Bearer ${",[69,816,817],{"class":104},"openaiApiKey",[69,819,820],{"class":108},"}`",[69,822,292],{"class":104},[69,824,825],{"class":71,"line":138},[69,826,262],{"class":104},[69,828,829,832,835,837,840],{"class":71,"line":176},[69,830,831],{"class":104},"    body: ",[69,833,834],{"class":93},"JSON",[69,836,144],{"class":104},[69,838,839],{"class":100},"stringify",[69,841,842],{"class":104},"({\n",[69,844,845],{"class":71,"line":207},[69,846,847],{"class":104},"      model: openaiModel,\n",[69,849,850],{"class":71,"line":216},[69,851,852],{"class":104},"      messages: [\n",[69,854,855],{"class":71,"line":222},[69,856,857],{"class":104},"        {\n",[69,859,860,863,866],{"class":71,"line":227},[69,861,862],{"class":104},"          role: ",[69,864,865],{"class":108},"'system'",[69,867,292],{"class":104},[69,869,870],{"class":71,"line":241},[69,871,872],{"class":104},"          content: prompt\n",[69,874,875],{"class":71,"line":247},[69,876,877],{"class":104},"        },\n",[69,879,880],{"class":71,"line":253},[69,881,857],{"class":104},[69,883,884,886,889],{"class":71,"line":259},[69,885,862],{"class":104},[69,887,888],{"class":108},"'user'",[69,890,292],{"class":104},[69,892,893],{"class":71,"line":265},[69,894,895],{"class":104},"          content: comment,\n",[69,897,898],{"class":71,"line":271},[69,899,877],{"class":104},[69,901,902],{"class":71,"line":277},[69,903,904],{"class":104},"      ],\n",[69,906,907],{"class":71,"line":283},[69,908,909],{"class":104},"    }),\n",[69,911,912],{"class":71,"line":295},[69,913,914],{"class":104},"  });\n",[69,916,917,919,922,924,926,929,932],{"class":71,"line":301},[69,918,230],{"class":89},[69,920,921],{"class":93}," data",[69,923,97],{"class":89},[69,925,466],{"class":89},[69,927,928],{"class":104}," response.",[69,930,931],{"class":100},"json",[69,933,934],{"class":104},"();\n",[69,936,937,939,942,945,948,950,953,956,959,962],{"class":71,"line":306},[69,938,179],{"class":89},[69,940,941],{"class":104}," (data ",[69,943,944],{"class":89},"&&",[69,946,947],{"class":104}," data.choices ",[69,949,944],{"class":89},[69,951,952],{"class":104}," data.choices.",[69,954,955],{"class":93},"length",[69,957,958],{"class":89}," >",[69,960,961],{"class":93}," 0",[69,963,346],{"class":104},[69,965,966,968,971,974],{"class":71,"line":312},[69,967,210],{"class":89},[69,969,970],{"class":104}," data.choices[",[69,972,973],{"class":93},"0",[69,975,976],{"class":104},"].message.content;\n",[69,978,979,982,985],{"class":71,"line":318},[69,980,981],{"class":104},"  } ",[69,983,984],{"class":89},"else",[69,986,238],{"class":104},[69,988,989,991,993],{"class":71,"line":326},[69,990,210],{"class":89},[69,992,619],{"class":108},[69,994,392],{"class":104},[69,996,997],{"class":71,"line":332},[69,998,219],{"class":104},[69,1000,1001],{"class":71,"line":349},[69,1002,696],{"class":104},[10,1004,1005],{},"再配合相应的封装，一款基于 GPT 的 waline 评论审核插件就完成了",[1007,1008,1009],"ul",{},[1010,1011,1012],"li",{},[20,1013,1016],{"href":1014,"rel":1015},"https://github.com/zhullyb/waline-plugin-llm-reviewer",[29],"zhullyb/waline-plugin-llm-reviewer",[10,1018,1019],{},[1020,1021,1022],"strong",{},"如何安装",[59,1024,1028],{"className":1025,"code":1026,"language":1027,"meta":64,"style":64},"language-bash shiki shiki-themes github-light github-dark","npm install waline-plugin-llm-reviewer\n","bash",[66,1029,1030],{"__ignoreMap":64},[69,1031,1032,1035,1038],{"class":71,"line":72},[69,1033,1034],{"class":100},"npm",[69,1036,1037],{"class":108}," install",[69,1039,1040],{"class":108}," waline-plugin-llm-reviewer\n",[10,1042,1043],{},[1020,1044,1045],{},"如何使用",[59,1047,1049],{"className":61,"code":1048,"language":63,"meta":64,"style":64},"// index.js\nconst Waline = require('@waline/vercel');\nconst GPTReviewer = require('waline-plugin-llm-reviewer');\n\nmodule.exports = Waline({\n  plugins: [\n    GptReviewer({\n        openaiBaseUrl: process.env.OPENAI_BASE_URL,\n        openaiModel: process.env.OPENAI_MODEL,\n        openaiApiKey: process.env.OPENAI_API_KEY,\n        openaiPrompt: process.env.OPENAI_PROMPT,\n    })\n  ]\n});\n",[66,1050,1051,1055,1073,1091,1095,1109,1114,1121,1131,1141,1151,1161,1166,1171],{"__ignoreMap":64},[69,1052,1053],{"class":71,"line":72},[69,1054,76],{"class":75},[69,1056,1057,1059,1062,1064,1066,1068,1071],{"class":71,"line":79},[69,1058,90],{"class":89},[69,1060,1061],{"class":93}," Waline",[69,1063,97],{"class":89},[69,1065,101],{"class":100},[69,1067,105],{"class":104},[69,1069,1070],{"class":108},"'@waline/vercel'",[69,1072,112],{"class":104},[69,1074,1075,1077,1080,1082,1084,1086,1089],{"class":71,"line":86},[69,1076,90],{"class":89},[69,1078,1079],{"class":93}," GPTReviewer",[69,1081,97],{"class":89},[69,1083,101],{"class":100},[69,1085,105],{"class":104},[69,1087,1088],{"class":108},"'waline-plugin-llm-reviewer'",[69,1090,112],{"class":104},[69,1092,1093],{"class":71,"line":115},[69,1094,83],{"emptyLinePlaceholder":82},[69,1096,1097,1099,1101,1103,1105,1107],{"class":71,"line":128},[69,1098,141],{"class":93},[69,1100,144],{"class":104},[69,1102,147],{"class":93},[69,1104,97],{"class":89},[69,1106,1061],{"class":100},[69,1108,842],{"class":104},[69,1110,1111],{"class":71,"line":133},[69,1112,1113],{"class":104},"  plugins: [\n",[69,1115,1116,1119],{"class":71,"line":138},[69,1117,1118],{"class":100},"    GptReviewer",[69,1120,842],{"class":104},[69,1122,1123,1126,1129],{"class":71,"line":176},[69,1124,1125],{"class":104},"        openaiBaseUrl: process.env.",[69,1127,1128],{"class":93},"OPENAI_BASE_URL",[69,1130,292],{"class":104},[69,1132,1133,1136,1139],{"class":71,"line":207},[69,1134,1135],{"class":104},"        openaiModel: process.env.",[69,1137,1138],{"class":93},"OPENAI_MODEL",[69,1140,292],{"class":104},[69,1142,1143,1146,1149],{"class":71,"line":216},[69,1144,1145],{"class":104},"        openaiApiKey: process.env.",[69,1147,1148],{"class":93},"OPENAI_API_KEY",[69,1150,292],{"class":104},[69,1152,1153,1156,1159],{"class":71,"line":222},[69,1154,1155],{"class":104},"        openaiPrompt: process.env.",[69,1157,1158],{"class":93},"OPENAI_PROMPT",[69,1160,292],{"class":104},[69,1162,1163],{"class":71,"line":227},[69,1164,1165],{"class":104},"    })\n",[69,1167,1168],{"class":71,"line":241},[69,1169,1170],{"class":104},"  ]\n",[69,1172,1173],{"class":71,"line":247},[69,1174,1175],{"class":104},"});\n",[10,1177,1178],{},[1020,1179,1180],{},"环境变量",[1007,1182,1183,1197,1205,1213,1221],{},[1010,1184,1185,1188,1189,1196],{},[66,1186,1187],{},"ASISMET_KEY",": Waline 使用的反垃圾评论服务，",[1020,1190,1191,1192,1195],{},"建议设置为 ",[66,1193,1194],{},"false"," 以禁用","。",[1010,1198,1199,1201,1202],{},[66,1200,1128],{},": API 基础 URL。例如 ",[66,1203,1204],{},"https://api.openai.com",[1010,1206,1207,1209,1210],{},[66,1208,1138],{},": 模型名称。例如 ",[66,1211,1212],{},"gpt-4o-mini",[1010,1214,1215,1217,1218],{},[66,1216,1148],{},": API 密钥。例如 ",[66,1219,1220],{},"ak-xxxxxx",[1010,1222,1223,1225,1226],{},[66,1224,1158],{},"(可选): 模型的提示。例如 ",[66,1227,1228],{},"这是一个评论审查: ",[10,1230,1231],{},"在 waline 中设置好对应的环境变量，使用 npm 安装好对应的包，就算大功告成了。",[10,1233,1234],{},[36,1235],{"alt":64,"src":1236},"https://static.031130.xyz/uploads/2024/10/12/45f06a78286de.webp",[1238,1239,1240],"style",{},"html pre.shiki code .sJ8bj, html code.shiki .sJ8bj{--shiki-default:#6A737D;--shiki-dark:#6A737D}html pre.shiki code .szBVR, html code.shiki .szBVR{--shiki-default:#D73A49;--shiki-dark:#F97583}html pre.shiki code .sj4cs, html code.shiki .sj4cs{--shiki-default:#005CC5;--shiki-dark:#79B8FF}html pre.shiki code .sScJk, html code.shiki .sScJk{--shiki-default:#6F42C1;--shiki-dark:#B392F0}html pre.shiki code .sVt8B, html code.shiki .sVt8B{--shiki-default:#24292E;--shiki-dark:#E1E4E8}html pre.shiki code .sZZnC, html code.shiki .sZZnC{--shiki-default:#032F62;--shiki-dark:#9ECBFF}html pre.shiki code .s4XuR, html code.shiki .s4XuR{--shiki-default:#E36209;--shiki-dark:#FFAB70}html .default .shiki span {color: var(--shiki-default);background: var(--shiki-default-bg);font-style: var(--shiki-default-font-style);font-weight: var(--shiki-default-font-weight);text-decoration: var(--shiki-default-text-decoration);}html .shiki span {color: var(--shiki-default);background: var(--shiki-default-bg);font-style: var(--shiki-default-font-style);font-weight: var(--shiki-default-font-weight);text-decoration: var(--shiki-default-text-decoration);}html .dark .shiki span {color: var(--shiki-dark);background: var(--shiki-dark-bg);font-style: var(--shiki-dark-font-style);font-weight: var(--shiki-dark-font-weight);text-decoration: var(--shiki-dark-text-decoration);}html.dark .shiki span {color: var(--shiki-dark);background: var(--shiki-dark-bg);font-style: var(--shiki-dark-font-style);font-weight: var(--shiki-dark-font-weight);text-decoration: var(--shiki-dark-text-decoration);}",{"title":64,"searchDepth":79,"depth":79,"links":1242},[],"2024-10-12 16:11:06","md",{"index_img":1246},"https://static.031130.xyz/uploads/2024/11/01/d1b5a5c058a43.png","/2024/10/12/use-gpt-to-review-waline-comments","---\ntitle: 使用 GPT 对 waline 的评论进行审查\ndate: 2024-10-12 16:11:06\nsticky:\nindex_img: https://static.031130.xyz/uploads/2024/11/01/d1b5a5c058a43.png\ntags:\n- waline\n- GPT\n---\n\n前一阵子收到了这么一条来自 waline 的评论提醒。\n\n> New comment on 竹林里有冰的博客\n> 【网站名称】：竹林里有冰的博客 \n> 【评论者昵称】：专业数据库\n> 【评论者邮箱】：rakhiranijhhg@gmail.com\n> 【内容】：总之，优化专业数据库对于保持数据准确性、提高系统性能和推动业务成功至关重要。通过遵循本文中概述的策略，您可以提高数据库操作的效率并释放新的增长机会。\n> 【地址】：https://zhul.in/2021/04/04/yay-more/#66f7a8889ab78865d5f5ae19\n\n评论的内容不仅透露着一股 AI 味，还和文章内容可谓是一点关系都没有，点开评论者的网站一看，一股塑料机翻味，怕是又是个来蹭 SEO 的广告哥。\n\n![广告哥留下的网站](https://static.031130.xyz/uploads/2024/10/07/4673580090861.webp)\n\n根据 [waline 的官方文档](https://waline.js.org/advanced/faq.html#%E5%8F%91%E5%B8%83%E8%AF%84%E8%AE%BA%E5%BE%88%E6%85%A2%E6%80%8E%E4%B9%88%E5%8A%9E)所言，waline 是使用了 Akismet 提供的垃圾内容检测服务的。可惜它似乎对 AI 生成的垃圾没有分辨能力。因此我计划使用 GPT 代替 Akismet 对 waline 的新评论进行审核。\n\nwalinejs/plugin 提供了一个 [tencent-cms](https://github.com/walinejs/plugins/blob/master/packages/tencent-tms/index.js) 的插件，功能是使用腾讯云的内容审查接口审查评论内容，这和我们需要的功能很像，主体部分和调用方法可以直接借鉴。\n\n```javascript\n// index.js\n\nconst tencentcloud = require(\"tencentcloud-sdk-nodejs-tms\");\nconst TmsClient = tencentcloud.tms.v20201229.Client;\n\n\nmodule.exports = function({secretId, secretKey, region}) {\n  if (!secretId || !secretKey || !region) {\n    return {};\n  }\n\n  const clientConfig = {\n    credential: {\n      secretId,\n      secretKey,\n    },\n    region,\n    profile: {\n      httpProfile: {\n        endpoint: \"tms.tencentcloudapi.com\",\n      },\n    },\n  };\n  \n  return {\n    hooks: {\n      async preSave(data) {\n        const { userInfo } = this.ctx.state;\n        const isAdmin = userInfo.type === 'administrator';\n        // ignore admin comment\n        if (isAdmin) {\n          return;\n        }\n\n        const client = new TmsClient(clientConfig);\n        try {\n          const resp = await client.TextModeration({ Content: data.comment });\n          if (!resp.Suggestion) {\n            throw new Error('Suggestion is empty. Tencent Cloud TMS info:', resp);\n          }\n\n          switch(resp.Suggestion) {\n            case 'Pass':\n              data.status = 'approved';\n              break;\n            case 'Block':\n              data.status = 'spam';\n              break;\n              case 'Review':\n              default:\n                data.status = 'waiting';\n                break;\n          }\n        } catch(e) {\n          console.log(e);\n          data.status = 'waiting';\n        }\n      },\n    },\n  };\n}\n```\n\n可以看到，我们需要在这个被 module.exports 导出的函数中，return 一个对象，如果使用 hooks 编写的话可以调用[一些生命周期 hook](https://waline.js.org/reference/server/config.html#%E8%AF%84%E8%AE%BA-hooks): 在 preSave 阶段，我们可以通过标注 data.status 参数来反馈评论类型。approved 为接受，spam 为垃圾邮件，waiting 为等待人工审核；除此之外，还可以[基于 Koa 中间件制作插件](https://waline.js.org/reference/server/plugin.html#%E5%9F%BA%E4%BA%8E%E4%B8%AD%E9%97%B4%E4%BB%B6%E5%88%B6%E4%BD%9C)，文档中有具体的描述。\n\nindex.js 顶部是需要引入的依赖。当然，如果需要引入外部的第三方包的话，需要在 packages.json 中加入需要的依赖（使用包管理器的命令进行安装）。\n\n有了这些基础知识，就能手搓一个基于 GPT 的评论审查插件。\n\nOpenAI 提供的是标准的 Restful API，本身的鉴权逻辑也不复杂，其实没必要调用 SDK，直接使用 fetch 调用就行。\n\n```javascript\nconst doReview = async (comment) => {\n  const response = await fetch(openaiBaseUrl + '/v1/chat/completions', {\n    method: 'POST',\n    headers: {\n      'Content-Type': 'application/json',\n      'Authorization': `Bearer ${openaiApiKey}`,\n    },\n    body: JSON.stringify({\n      model: openaiModel,\n      messages: [\n        {\n          role: 'system',\n          content: prompt\n        },\n        {\n          role: 'user',\n          content: comment,\n        },\n      ],\n    }),\n  });\n  const data = await response.json();\n  if (data && data.choices && data.choices.length > 0) {\n    return data.choices[0].message.content;\n  } else {\n    return 'waiting';\n  }\n}\n```\n\n再配合相应的封装，一款基于 GPT 的 waline 评论审核插件就完成了\n\n- [zhullyb/waline-plugin-llm-reviewer](https://github.com/zhullyb/waline-plugin-llm-reviewer)\n\n**如何安装**\n\n```bash\nnpm install waline-plugin-llm-reviewer\n```\n\n**如何使用**\n\n```javascript\n// index.js\nconst Waline = require('@waline/vercel');\nconst GPTReviewer = require('waline-plugin-llm-reviewer');\n\nmodule.exports = Waline({\n  plugins: [\n    GptReviewer({\n        openaiBaseUrl: process.env.OPENAI_BASE_URL,\n        openaiModel: process.env.OPENAI_MODEL,\n        openaiApiKey: process.env.OPENAI_API_KEY,\n        openaiPrompt: process.env.OPENAI_PROMPT,\n    })\n  ]\n});\n```\n\n**环境变量**\n\n- `ASISMET_KEY`: Waline 使用的反垃圾评论服务，**建议设置为 `false` 以禁用**。\n- `OPENAI_BASE_URL`: API 基础 URL。例如 `https://api.openai.com`\n- `OPENAI_MODEL`: 模型名称。例如 `gpt-4o-mini`\n- `OPENAI_API_KEY`: API 密钥。例如 `ak-xxxxxx`\n- `OPENAI_PROMPT`(可选): 模型的提示。例如 `这是一个评论审查: `\n\n在 waline 中设置好对应的环境变量，使用 npm 安装好对应的包，就算大功告成了。\n\n![](https://static.031130.xyz/uploads/2024/10/12/45f06a78286de.webp)\n",{"title":5,"description":12},"posts/use-gpt-to-review-waline-comments",false,[1253,1254],"waline","GPT","IEiQd5zoWLrBQxzSvIvcAmlQcjsYpeoYPI3Q0ouZbXY",[1257,1262],{"title":1258,"path":1259,"stem":1260,"date":1261,"children":-1},"为 Hexo 添加 follow 认证","/2024/10/23/follow-cert-for-hexo-feed","posts/follow-cert-for-hexo-feed","2024-10-23 23:11:32",{"title":1263,"path":1264,"stem":1265,"date":1266,"children":-1},"基于 JavaScript 的 Hexo Fluid 主题 banner 随机背景图实现","/2024/09/25/random-banner-backgroud-image-implement-for-hexo-fluid-with-javascript","posts/random-banner-backgroud-image-implement-for-hexo-fluid-with-javascript","2024-09-25 00:00:42",1761735720952]