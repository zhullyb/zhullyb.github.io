[{"data":1,"prerenderedAt":1512},["ShallowReactive",2],{"post-2024-10-12-use-gpt-to-review-waline-comments":3,"surround-2024-10-12-use-gpt-to-review-waline-comments":1501,"randomIndex/2024/10/12/use-gpt-to-review-waline-comments/":362},{"id":4,"title":5,"body":6,"date":1488,"description":12,"extension":1489,"meta":1490,"navigation":82,"path":1492,"rawbody":1493,"seo":1494,"stem":1495,"sticky":1496,"tags":1497,"__hash__":1500},"posts/posts/use-gpt-to-review-waline-comments.md","使用 GPT 对 waline 的评论进行审查",{"type":7,"value":8,"toc":1486},"minimark",[9,13,30,33,40,49,58,825,840,843,846,849,1200,1203,1214,1220,1238,1243,1421,1426,1474,1477,1482],[10,11,12],"p",{},"前一阵子收到了这么一条来自 waline 的评论提醒。",[14,15,16],"blockquote",{},[10,17,18,19,24,25],{},"New comment on 竹林里有冰的博客\n【网站名称】：竹林里有冰的博客\n【评论者昵称】：专业数据库\n【评论者邮箱】：",[20,21,23],"a",{"href":22},"mailto:rakhiranijhhg@gmail.com","rakhiranijhhg@gmail.com","\n【内容】：总之，优化专业数据库对于保持数据准确性、提高系统性能和推动业务成功至关重要。通过遵循本文中概述的策略，您可以提高数据库操作的效率并释放新的增长机会。\n【地址】：",[20,26,27],{"href":27,"rel":28},"https://zhul.in/2021/04/04/yay-more/#66f7a8889ab78865d5f5ae19",[29],"nofollow",[10,31,32],{},"评论的内容不仅透露着一股 AI 味，还和文章内容可谓是一点关系都没有，点开评论者的网站一看，一股塑料机翻味，怕是又是个来蹭 SEO 的广告哥。",[10,34,35],{},[36,37],"img",{"alt":38,"src":39},"广告哥留下的网站","https://static.031130.xyz/uploads/2024/10/07/4673580090861.webp",[10,41,42,43,48],{},"根据 ",[20,44,47],{"href":45,"rel":46},"https://waline.js.org/advanced/faq.html#%E5%8F%91%E5%B8%83%E8%AF%84%E8%AE%BA%E5%BE%88%E6%85%A2%E6%80%8E%E4%B9%88%E5%8A%9E",[29],"waline 的官方文档","所言，waline 是使用了 Akismet 提供的垃圾内容检测服务的。可惜它似乎对 AI 生成的垃圾没有分辨能力。因此我计划使用 GPT 代替 Akismet 对 waline 的新评论进行审核。",[10,50,51,52,57],{},"walinejs/plugin 提供了一个 ",[20,53,56],{"href":54,"rel":55},"https://github.com/walinejs/plugins/blob/master/packages/tencent-tms/index.js",[29],"tencent-cms"," 的插件，功能是使用腾讯云的内容审查接口审查评论内容，这和我们需要的功能很像，主体部分和调用方法可以直接借鉴。",[59,60,65],"pre",{"className":61,"code":62,"language":63,"meta":64,"style":64},"language-javascript shiki shiki-themes one-light one-dark-pro","// index.js\n\nconst tencentcloud = require(\"tencentcloud-sdk-nodejs-tms\");\nconst TmsClient = tencentcloud.tms.v20201229.Client;\n\n\nmodule.exports = function({secretId, secretKey, region}) {\n  if (!secretId || !secretKey || !region) {\n    return {};\n  }\n\n  const clientConfig = {\n    credential: {\n      secretId,\n      secretKey,\n    },\n    region,\n    profile: {\n      httpProfile: {\n        endpoint: \"tms.tencentcloudapi.com\",\n      },\n    },\n  };\n  \n  return {\n    hooks: {\n      async preSave(data) {\n        const { userInfo } = this.ctx.state;\n        const isAdmin = userInfo.type === 'administrator';\n        // ignore admin comment\n        if (isAdmin) {\n          return;\n        }\n\n        const client = new TmsClient(clientConfig);\n        try {\n          const resp = await client.TextModeration({ Content: data.comment });\n          if (!resp.Suggestion) {\n            throw new Error('Suggestion is empty. Tencent Cloud TMS info:', resp);\n          }\n\n          switch(resp.Suggestion) {\n            case 'Pass':\n              data.status = 'approved';\n              break;\n            case 'Block':\n              data.status = 'spam';\n              break;\n              case 'Review':\n              default:\n                data.status = 'waiting';\n                break;\n          }\n        } catch(e) {\n          console.log(e);\n          data.status = 'waiting';\n        }\n      },\n    },\n  };\n}\n","javascript","",[66,67,68,77,84,114,148,153,158,195,227,236,242,247,261,273,282,290,296,304,314,324,337,343,348,354,360,368,378,394,427,453,459,472,480,486,491,513,521,561,581,603,609,614,630,642,660,668,678,694,701,712,720,737,745,750,766,783,799,804,809,814,819],"code",{"__ignoreMap":64},[69,70,73],"span",{"class":71,"line":72},"line",1,[69,74,76],{"class":75},"sW2Sy","// index.js\n",[69,78,80],{"class":71,"line":79},2,[69,81,83],{"emptyLinePlaceholder":82},true,"\n",[69,85,87,91,95,99,103,107,111],{"class":71,"line":86},3,[69,88,90],{"class":89},"sLKXg","const",[69,92,94],{"class":93},"sNmU0"," tencentcloud",[69,96,98],{"class":97},"s_Sar"," =",[69,100,102],{"class":101},"sAdtL"," require",[69,104,106],{"class":105},"s5ixo","(",[69,108,110],{"class":109},"sDhpE","\"tencentcloud-sdk-nodejs-tms\"",[69,112,113],{"class":105},");\n",[69,115,117,119,122,124,127,130,134,136,139,141,145],{"class":71,"line":116},4,[69,118,90],{"class":89},[69,120,121],{"class":93}," TmsClient",[69,123,98],{"class":97},[69,125,94],{"class":126},"s7GmK",[69,128,129],{"class":105},".",[69,131,133],{"class":132},"s2QsP","tms",[69,135,129],{"class":105},[69,137,138],{"class":132},"v20201229",[69,140,129],{"class":105},[69,142,144],{"class":143},"sJa8x","Client",[69,146,147],{"class":105},";\n",[69,149,151],{"class":71,"line":150},5,[69,152,83],{"emptyLinePlaceholder":82},[69,154,156],{"class":71,"line":155},6,[69,157,83],{"emptyLinePlaceholder":82},[69,159,161,164,166,169,171,174,177,181,184,187,189,192],{"class":71,"line":160},7,[69,162,163],{"class":132},"module",[69,165,129],{"class":105},[69,167,168],{"class":132},"exports",[69,170,98],{"class":97},[69,172,173],{"class":89}," function",[69,175,176],{"class":105},"({",[69,178,180],{"class":179},"s8iYz","secretId",[69,182,183],{"class":105},", ",[69,185,186],{"class":179},"secretKey",[69,188,183],{"class":105},[69,190,191],{"class":179},"region",[69,193,194],{"class":105},"}) {\n",[69,196,198,201,204,207,210,213,216,218,220,222,224],{"class":71,"line":197},8,[69,199,200],{"class":89},"  if",[69,202,203],{"class":105}," (",[69,205,206],{"class":97},"!",[69,208,180],{"class":209},"sz0mV",[69,211,212],{"class":97}," ||",[69,214,215],{"class":97}," !",[69,217,186],{"class":209},[69,219,212],{"class":97},[69,221,215],{"class":97},[69,223,191],{"class":209},[69,225,226],{"class":105},") {\n",[69,228,230,233],{"class":71,"line":229},9,[69,231,232],{"class":89},"    return",[69,234,235],{"class":105}," {};\n",[69,237,239],{"class":71,"line":238},10,[69,240,241],{"class":105},"  }\n",[69,243,245],{"class":71,"line":244},11,[69,246,83],{"emptyLinePlaceholder":82},[69,248,250,253,256,258],{"class":71,"line":249},12,[69,251,252],{"class":89},"  const",[69,254,255],{"class":93}," clientConfig",[69,257,98],{"class":97},[69,259,260],{"class":105}," {\n",[69,262,264,267,271],{"class":71,"line":263},13,[69,265,266],{"class":143},"    credential",[69,268,270],{"class":269},"st7oF",":",[69,272,260],{"class":105},[69,274,276,279],{"class":71,"line":275},14,[69,277,278],{"class":209},"      secretId",[69,280,281],{"class":105},",\n",[69,283,285,288],{"class":71,"line":284},15,[69,286,287],{"class":209},"      secretKey",[69,289,281],{"class":105},[69,291,293],{"class":71,"line":292},16,[69,294,295],{"class":105},"    },\n",[69,297,299,302],{"class":71,"line":298},17,[69,300,301],{"class":209},"    region",[69,303,281],{"class":105},[69,305,307,310,312],{"class":71,"line":306},18,[69,308,309],{"class":143},"    profile",[69,311,270],{"class":269},[69,313,260],{"class":105},[69,315,317,320,322],{"class":71,"line":316},19,[69,318,319],{"class":143},"      httpProfile",[69,321,270],{"class":269},[69,323,260],{"class":105},[69,325,327,330,332,335],{"class":71,"line":326},20,[69,328,329],{"class":143},"        endpoint",[69,331,270],{"class":269},[69,333,334],{"class":109}," \"tms.tencentcloudapi.com\"",[69,336,281],{"class":105},[69,338,340],{"class":71,"line":339},21,[69,341,342],{"class":105},"      },\n",[69,344,346],{"class":71,"line":345},22,[69,347,295],{"class":105},[69,349,351],{"class":71,"line":350},23,[69,352,353],{"class":105},"  };\n",[69,355,357],{"class":71,"line":356},24,[69,358,359],{"class":105},"  \n",[69,361,363,366],{"class":71,"line":362},25,[69,364,365],{"class":89},"  return",[69,367,260],{"class":105},[69,369,371,374,376],{"class":71,"line":370},26,[69,372,373],{"class":143},"    hooks",[69,375,270],{"class":269},[69,377,260],{"class":105},[69,379,381,384,387,389,392],{"class":71,"line":380},27,[69,382,383],{"class":89},"      async",[69,385,386],{"class":101}," preSave",[69,388,106],{"class":105},[69,390,391],{"class":179},"data",[69,393,226],{"class":105},[69,395,397,400,403,406,409,412,415,417,420,422,425],{"class":71,"line":396},28,[69,398,399],{"class":89},"        const",[69,401,402],{"class":105}," { ",[69,404,405],{"class":93},"userInfo",[69,407,408],{"class":105}," } ",[69,410,411],{"class":97},"=",[69,413,414],{"class":132}," this",[69,416,129],{"class":105},[69,418,419],{"class":132},"ctx",[69,421,129],{"class":105},[69,423,424],{"class":143},"state",[69,426,147],{"class":105},[69,428,430,432,435,437,440,442,445,448,451],{"class":71,"line":429},29,[69,431,399],{"class":89},[69,433,434],{"class":93}," isAdmin",[69,436,98],{"class":97},[69,438,439],{"class":126}," userInfo",[69,441,129],{"class":105},[69,443,444],{"class":143},"type",[69,446,447],{"class":97}," ===",[69,449,450],{"class":109}," 'administrator'",[69,452,147],{"class":105},[69,454,456],{"class":71,"line":455},30,[69,457,458],{"class":75},"        // ignore admin comment\n",[69,460,462,465,467,470],{"class":71,"line":461},31,[69,463,464],{"class":89},"        if",[69,466,203],{"class":105},[69,468,469],{"class":209},"isAdmin",[69,471,226],{"class":105},[69,473,475,478],{"class":71,"line":474},32,[69,476,477],{"class":89},"          return",[69,479,147],{"class":105},[69,481,483],{"class":71,"line":482},33,[69,484,485],{"class":105},"        }\n",[69,487,489],{"class":71,"line":488},34,[69,490,83],{"emptyLinePlaceholder":82},[69,492,494,496,499,501,504,506,508,511],{"class":71,"line":493},35,[69,495,399],{"class":89},[69,497,498],{"class":93}," client",[69,500,98],{"class":97},[69,502,503],{"class":89}," new",[69,505,121],{"class":101},[69,507,106],{"class":105},[69,509,510],{"class":209},"clientConfig",[69,512,113],{"class":105},[69,514,516,519],{"class":71,"line":515},36,[69,517,518],{"class":89},"        try",[69,520,260],{"class":105},[69,522,524,527,530,532,535,537,539,542,545,548,550,553,555,558],{"class":71,"line":523},37,[69,525,526],{"class":89},"          const",[69,528,529],{"class":93}," resp",[69,531,98],{"class":97},[69,533,534],{"class":89}," await",[69,536,498],{"class":126},[69,538,129],{"class":105},[69,540,541],{"class":101},"TextModeration",[69,543,544],{"class":105},"({ ",[69,546,547],{"class":143},"Content",[69,549,270],{"class":269},[69,551,552],{"class":126}," data",[69,554,129],{"class":105},[69,556,557],{"class":143},"comment",[69,559,560],{"class":105}," });\n",[69,562,564,567,569,571,574,576,579],{"class":71,"line":563},38,[69,565,566],{"class":89},"          if",[69,568,203],{"class":105},[69,570,206],{"class":97},[69,572,573],{"class":126},"resp",[69,575,129],{"class":105},[69,577,578],{"class":143},"Suggestion",[69,580,226],{"class":105},[69,582,584,587,589,592,594,597,599,601],{"class":71,"line":583},39,[69,585,586],{"class":89},"            throw",[69,588,503],{"class":89},[69,590,591],{"class":101}," Error",[69,593,106],{"class":105},[69,595,596],{"class":109},"'Suggestion is empty. Tencent Cloud TMS info:'",[69,598,183],{"class":105},[69,600,573],{"class":209},[69,602,113],{"class":105},[69,604,606],{"class":71,"line":605},40,[69,607,608],{"class":105},"          }\n",[69,610,612],{"class":71,"line":611},41,[69,613,83],{"emptyLinePlaceholder":82},[69,615,617,620,622,624,626,628],{"class":71,"line":616},42,[69,618,619],{"class":89},"          switch",[69,621,106],{"class":105},[69,623,573],{"class":126},[69,625,129],{"class":105},[69,627,578],{"class":143},[69,629,226],{"class":105},[69,631,633,636,639],{"class":71,"line":632},43,[69,634,635],{"class":89},"            case",[69,637,638],{"class":109}," 'Pass'",[69,640,641],{"class":105},":\n",[69,643,645,648,650,653,655,658],{"class":71,"line":644},44,[69,646,647],{"class":126},"              data",[69,649,129],{"class":105},[69,651,652],{"class":143},"status",[69,654,98],{"class":97},[69,656,657],{"class":109}," 'approved'",[69,659,147],{"class":105},[69,661,663,666],{"class":71,"line":662},45,[69,664,665],{"class":89},"              break",[69,667,147],{"class":105},[69,669,671,673,676],{"class":71,"line":670},46,[69,672,635],{"class":89},[69,674,675],{"class":109}," 'Block'",[69,677,641],{"class":105},[69,679,681,683,685,687,689,692],{"class":71,"line":680},47,[69,682,647],{"class":126},[69,684,129],{"class":105},[69,686,652],{"class":143},[69,688,98],{"class":97},[69,690,691],{"class":109}," 'spam'",[69,693,147],{"class":105},[69,695,697,699],{"class":71,"line":696},48,[69,698,665],{"class":89},[69,700,147],{"class":105},[69,702,704,707,710],{"class":71,"line":703},49,[69,705,706],{"class":89},"              case",[69,708,709],{"class":109}," 'Review'",[69,711,641],{"class":105},[69,713,715,718],{"class":71,"line":714},50,[69,716,717],{"class":89},"              default",[69,719,641],{"class":105},[69,721,723,726,728,730,732,735],{"class":71,"line":722},51,[69,724,725],{"class":126},"                data",[69,727,129],{"class":105},[69,729,652],{"class":143},[69,731,98],{"class":97},[69,733,734],{"class":109}," 'waiting'",[69,736,147],{"class":105},[69,738,740,743],{"class":71,"line":739},52,[69,741,742],{"class":89},"                break",[69,744,147],{"class":105},[69,746,748],{"class":71,"line":747},53,[69,749,608],{"class":105},[69,751,753,756,759,761,764],{"class":71,"line":752},54,[69,754,755],{"class":105},"        } ",[69,757,758],{"class":89},"catch",[69,760,106],{"class":105},[69,762,763],{"class":209},"e",[69,765,226],{"class":105},[69,767,769,772,774,777,779,781],{"class":71,"line":768},55,[69,770,771],{"class":126},"          console",[69,773,129],{"class":105},[69,775,776],{"class":101},"log",[69,778,106],{"class":105},[69,780,763],{"class":209},[69,782,113],{"class":105},[69,784,786,789,791,793,795,797],{"class":71,"line":785},56,[69,787,788],{"class":126},"          data",[69,790,129],{"class":105},[69,792,652],{"class":143},[69,794,98],{"class":97},[69,796,734],{"class":109},[69,798,147],{"class":105},[69,800,802],{"class":71,"line":801},57,[69,803,485],{"class":105},[69,805,807],{"class":71,"line":806},58,[69,808,342],{"class":105},[69,810,812],{"class":71,"line":811},59,[69,813,295],{"class":105},[69,815,817],{"class":71,"line":816},60,[69,818,353],{"class":105},[69,820,822],{"class":71,"line":821},61,[69,823,824],{"class":105},"}\n",[10,826,827,828,833,834,839],{},"可以看到，我们需要在这个被 module.exports 导出的函数中，return 一个对象，如果使用 hooks 编写的话可以调用",[20,829,832],{"href":830,"rel":831},"https://waline.js.org/reference/server/config.html#%E8%AF%84%E8%AE%BA-hooks",[29],"一些生命周期 hook",": 在 preSave 阶段，我们可以通过标注 data.status 参数来反馈评论类型。approved 为接受，spam 为垃圾邮件，waiting 为等待人工审核；除此之外，还可以",[20,835,838],{"href":836,"rel":837},"https://waline.js.org/reference/server/plugin.html#%E5%9F%BA%E4%BA%8E%E4%B8%AD%E9%97%B4%E4%BB%B6%E5%88%B6%E4%BD%9C",[29],"基于 Koa 中间件制作插件","，文档中有具体的描述。",[10,841,842],{},"index.js 顶部是需要引入的依赖。当然，如果需要引入外部的第三方包的话，需要在 packages.json 中加入需要的依赖（使用包管理器的命令进行安装）。",[10,844,845],{},"有了这些基础知识，就能手搓一个基于 GPT 的评论审查插件。",[10,847,848],{},"OpenAI 提供的是标准的 Restful API，本身的鉴权逻辑也不复杂，其实没必要调用 SDK，直接使用 fetch 调用就行。",[59,850,852],{"className":61,"code":851,"language":63,"meta":64,"style":64},"const doReview = async (comment) => {\n  const response = await fetch(openaiBaseUrl + '/v1/chat/completions', {\n    method: 'POST',\n    headers: {\n      'Content-Type': 'application/json',\n      'Authorization': `Bearer ${openaiApiKey}`,\n    },\n    body: JSON.stringify({\n      model: openaiModel,\n      messages: [\n        {\n          role: 'system',\n          content: prompt\n        },\n        {\n          role: 'user',\n          content: comment,\n        },\n      ],\n    }),\n  });\n  const data = await response.json();\n  if (data && data.choices && data.choices.length > 0) {\n    return data.choices[0].message.content;\n  } else {\n    return 'waiting';\n  }\n}\n",[66,853,854,878,906,918,927,939,964,968,986,998,1008,1013,1025,1035,1040,1044,1055,1066,1070,1075,1080,1085,1105,1145,1174,1184,1192,1196],{"__ignoreMap":64},[69,855,856,858,861,863,866,868,870,873,876],{"class":71,"line":72},[69,857,90],{"class":89},[69,859,860],{"class":101}," doReview",[69,862,98],{"class":97},[69,864,865],{"class":89}," async",[69,867,203],{"class":105},[69,869,557],{"class":179},[69,871,872],{"class":105},") ",[69,874,875],{"class":89},"=>",[69,877,260],{"class":105},[69,879,880,882,885,887,889,892,894,897,900,903],{"class":71,"line":79},[69,881,252],{"class":89},[69,883,884],{"class":93}," response",[69,886,98],{"class":97},[69,888,534],{"class":89},[69,890,891],{"class":101}," fetch",[69,893,106],{"class":105},[69,895,896],{"class":209},"openaiBaseUrl",[69,898,899],{"class":97}," +",[69,901,902],{"class":109}," '/v1/chat/completions'",[69,904,905],{"class":105},", {\n",[69,907,908,911,913,916],{"class":71,"line":86},[69,909,910],{"class":143},"    method",[69,912,270],{"class":269},[69,914,915],{"class":109}," 'POST'",[69,917,281],{"class":105},[69,919,920,923,925],{"class":71,"line":116},[69,921,922],{"class":143},"    headers",[69,924,270],{"class":269},[69,926,260],{"class":105},[69,928,929,932,934,937],{"class":71,"line":150},[69,930,931],{"class":109},"      'Content-Type'",[69,933,270],{"class":269},[69,935,936],{"class":109}," 'application/json'",[69,938,281],{"class":105},[69,940,941,944,946,949,953,956,959,962],{"class":71,"line":155},[69,942,943],{"class":109},"      'Authorization'",[69,945,270],{"class":269},[69,947,948],{"class":109}," `Bearer ",[69,950,952],{"class":951},"sAOjX","${",[69,954,955],{"class":209},"openaiApiKey",[69,957,958],{"class":951},"}",[69,960,961],{"class":109},"`",[69,963,281],{"class":105},[69,965,966],{"class":71,"line":160},[69,967,295],{"class":105},[69,969,970,973,975,978,980,983],{"class":71,"line":197},[69,971,972],{"class":143},"    body",[69,974,270],{"class":269},[69,976,977],{"class":93}," JSON",[69,979,129],{"class":105},[69,981,982],{"class":101},"stringify",[69,984,985],{"class":105},"({\n",[69,987,988,991,993,996],{"class":71,"line":229},[69,989,990],{"class":143},"      model",[69,992,270],{"class":269},[69,994,995],{"class":209}," openaiModel",[69,997,281],{"class":105},[69,999,1000,1003,1005],{"class":71,"line":238},[69,1001,1002],{"class":143},"      messages",[69,1004,270],{"class":269},[69,1006,1007],{"class":105}," [\n",[69,1009,1010],{"class":71,"line":244},[69,1011,1012],{"class":105},"        {\n",[69,1014,1015,1018,1020,1023],{"class":71,"line":249},[69,1016,1017],{"class":143},"          role",[69,1019,270],{"class":269},[69,1021,1022],{"class":109}," 'system'",[69,1024,281],{"class":105},[69,1026,1027,1030,1032],{"class":71,"line":263},[69,1028,1029],{"class":143},"          content",[69,1031,270],{"class":269},[69,1033,1034],{"class":209}," prompt\n",[69,1036,1037],{"class":71,"line":275},[69,1038,1039],{"class":105},"        },\n",[69,1041,1042],{"class":71,"line":284},[69,1043,1012],{"class":105},[69,1045,1046,1048,1050,1053],{"class":71,"line":292},[69,1047,1017],{"class":143},[69,1049,270],{"class":269},[69,1051,1052],{"class":109}," 'user'",[69,1054,281],{"class":105},[69,1056,1057,1059,1061,1064],{"class":71,"line":298},[69,1058,1029],{"class":143},[69,1060,270],{"class":269},[69,1062,1063],{"class":209}," comment",[69,1065,281],{"class":105},[69,1067,1068],{"class":71,"line":306},[69,1069,1039],{"class":105},[69,1071,1072],{"class":71,"line":316},[69,1073,1074],{"class":105},"      ],\n",[69,1076,1077],{"class":71,"line":326},[69,1078,1079],{"class":105},"    }),\n",[69,1081,1082],{"class":71,"line":339},[69,1083,1084],{"class":105},"  });\n",[69,1086,1087,1089,1091,1093,1095,1097,1099,1102],{"class":71,"line":345},[69,1088,252],{"class":89},[69,1090,552],{"class":93},[69,1092,98],{"class":97},[69,1094,534],{"class":89},[69,1096,884],{"class":126},[69,1098,129],{"class":105},[69,1100,1101],{"class":101},"json",[69,1103,1104],{"class":105},"();\n",[69,1106,1107,1109,1111,1113,1116,1118,1120,1123,1125,1127,1129,1131,1133,1136,1139,1143],{"class":71,"line":350},[69,1108,200],{"class":89},[69,1110,203],{"class":105},[69,1112,391],{"class":209},[69,1114,1115],{"class":97}," &&",[69,1117,552],{"class":126},[69,1119,129],{"class":105},[69,1121,1122],{"class":143},"choices",[69,1124,1115],{"class":97},[69,1126,552],{"class":126},[69,1128,129],{"class":105},[69,1130,1122],{"class":132},[69,1132,129],{"class":105},[69,1134,1135],{"class":143},"length",[69,1137,1138],{"class":97}," >",[69,1140,1142],{"class":1141},"sAGMh"," 0",[69,1144,226],{"class":105},[69,1146,1147,1149,1151,1153,1155,1158,1161,1164,1167,1169,1172],{"class":71,"line":356},[69,1148,232],{"class":89},[69,1150,552],{"class":126},[69,1152,129],{"class":105},[69,1154,1122],{"class":143},[69,1156,1157],{"class":105},"[",[69,1159,1160],{"class":1141},"0",[69,1162,1163],{"class":105},"].",[69,1165,1166],{"class":132},"message",[69,1168,129],{"class":105},[69,1170,1171],{"class":143},"content",[69,1173,147],{"class":105},[69,1175,1176,1179,1182],{"class":71,"line":362},[69,1177,1178],{"class":105},"  } ",[69,1180,1181],{"class":89},"else",[69,1183,260],{"class":105},[69,1185,1186,1188,1190],{"class":71,"line":370},[69,1187,232],{"class":89},[69,1189,734],{"class":109},[69,1191,147],{"class":105},[69,1193,1194],{"class":71,"line":380},[69,1195,241],{"class":105},[69,1197,1198],{"class":71,"line":396},[69,1199,824],{"class":105},[10,1201,1202],{},"再配合相应的封装，一款基于 GPT 的 waline 评论审核插件就完成了",[1204,1205,1206],"ul",{},[1207,1208,1209],"li",{},[20,1210,1213],{"href":1211,"rel":1212},"https://github.com/zhullyb/waline-plugin-llm-reviewer",[29],"zhullyb/waline-plugin-llm-reviewer",[10,1215,1216],{},[1217,1218,1219],"strong",{},"如何安装",[59,1221,1225],{"className":1222,"code":1223,"language":1224,"meta":64,"style":64},"language-bash shiki shiki-themes one-light one-dark-pro","npm install waline-plugin-llm-reviewer\n","bash",[66,1226,1227],{"__ignoreMap":64},[69,1228,1229,1232,1235],{"class":71,"line":72},[69,1230,1231],{"class":101},"npm",[69,1233,1234],{"class":109}," install",[69,1236,1237],{"class":109}," waline-plugin-llm-reviewer\n",[10,1239,1240],{},[1217,1241,1242],{},"如何使用",[59,1244,1246],{"className":61,"code":1245,"language":63,"meta":64,"style":64},"// index.js\nconst Waline = require('@waline/vercel');\nconst GPTReviewer = require('waline-plugin-llm-reviewer');\n\nmodule.exports = Waline({\n  plugins: [\n    GptReviewer({\n        openaiBaseUrl: process.env.OPENAI_BASE_URL,\n        openaiModel: process.env.OPENAI_MODEL,\n        openaiApiKey: process.env.OPENAI_API_KEY,\n        openaiPrompt: process.env.OPENAI_PROMPT,\n    })\n  ]\n});\n",[66,1247,1248,1252,1270,1288,1292,1306,1315,1322,1346,1366,1386,1406,1411,1416],{"__ignoreMap":64},[69,1249,1250],{"class":71,"line":72},[69,1251,76],{"class":75},[69,1253,1254,1256,1259,1261,1263,1265,1268],{"class":71,"line":79},[69,1255,90],{"class":89},[69,1257,1258],{"class":93}," Waline",[69,1260,98],{"class":97},[69,1262,102],{"class":101},[69,1264,106],{"class":105},[69,1266,1267],{"class":109},"'@waline/vercel'",[69,1269,113],{"class":105},[69,1271,1272,1274,1277,1279,1281,1283,1286],{"class":71,"line":86},[69,1273,90],{"class":89},[69,1275,1276],{"class":93}," GPTReviewer",[69,1278,98],{"class":97},[69,1280,102],{"class":101},[69,1282,106],{"class":105},[69,1284,1285],{"class":109},"'waline-plugin-llm-reviewer'",[69,1287,113],{"class":105},[69,1289,1290],{"class":71,"line":116},[69,1291,83],{"emptyLinePlaceholder":82},[69,1293,1294,1296,1298,1300,1302,1304],{"class":71,"line":150},[69,1295,163],{"class":132},[69,1297,129],{"class":105},[69,1299,168],{"class":132},[69,1301,98],{"class":97},[69,1303,1258],{"class":101},[69,1305,985],{"class":105},[69,1307,1308,1311,1313],{"class":71,"line":155},[69,1309,1310],{"class":143},"  plugins",[69,1312,270],{"class":269},[69,1314,1007],{"class":105},[69,1316,1317,1320],{"class":71,"line":160},[69,1318,1319],{"class":101},"    GptReviewer",[69,1321,985],{"class":105},[69,1323,1324,1327,1329,1332,1334,1338,1340,1344],{"class":71,"line":197},[69,1325,1326],{"class":143},"        openaiBaseUrl",[69,1328,270],{"class":269},[69,1330,1331],{"class":126}," process",[69,1333,129],{"class":105},[69,1335,1337],{"class":1336},"sC09Y","env",[69,1339,129],{"class":105},[69,1341,1343],{"class":1342},"sRZ4U","OPENAI_BASE_URL",[69,1345,281],{"class":105},[69,1347,1348,1351,1353,1355,1357,1359,1361,1364],{"class":71,"line":229},[69,1349,1350],{"class":143},"        openaiModel",[69,1352,270],{"class":269},[69,1354,1331],{"class":126},[69,1356,129],{"class":105},[69,1358,1337],{"class":1336},[69,1360,129],{"class":105},[69,1362,1363],{"class":1342},"OPENAI_MODEL",[69,1365,281],{"class":105},[69,1367,1368,1371,1373,1375,1377,1379,1381,1384],{"class":71,"line":238},[69,1369,1370],{"class":143},"        openaiApiKey",[69,1372,270],{"class":269},[69,1374,1331],{"class":126},[69,1376,129],{"class":105},[69,1378,1337],{"class":1336},[69,1380,129],{"class":105},[69,1382,1383],{"class":1342},"OPENAI_API_KEY",[69,1385,281],{"class":105},[69,1387,1388,1391,1393,1395,1397,1399,1401,1404],{"class":71,"line":244},[69,1389,1390],{"class":143},"        openaiPrompt",[69,1392,270],{"class":269},[69,1394,1331],{"class":126},[69,1396,129],{"class":105},[69,1398,1337],{"class":1336},[69,1400,129],{"class":105},[69,1402,1403],{"class":1342},"OPENAI_PROMPT",[69,1405,281],{"class":105},[69,1407,1408],{"class":71,"line":249},[69,1409,1410],{"class":105},"    })\n",[69,1412,1413],{"class":71,"line":263},[69,1414,1415],{"class":105},"  ]\n",[69,1417,1418],{"class":71,"line":275},[69,1419,1420],{"class":105},"});\n",[10,1422,1423],{},[1217,1424,1425],{},"环境变量",[1204,1427,1428,1442,1450,1458,1466],{},[1207,1429,1430,1433,1434,1441],{},[66,1431,1432],{},"ASISMET_KEY",": Waline 使用的反垃圾评论服务，",[1217,1435,1436,1437,1440],{},"建议设置为 ",[66,1438,1439],{},"false"," 以禁用","。",[1207,1443,1444,1446,1447],{},[66,1445,1343],{},": API 基础 URL。例如 ",[66,1448,1449],{},"https://api.openai.com",[1207,1451,1452,1454,1455],{},[66,1453,1363],{},": 模型名称。例如 ",[66,1456,1457],{},"gpt-4o-mini",[1207,1459,1460,1462,1463],{},[66,1461,1383],{},": API 密钥。例如 ",[66,1464,1465],{},"ak-xxxxxx",[1207,1467,1468,1470,1471],{},[66,1469,1403],{},"(可选): 模型的提示。例如 ",[66,1472,1473],{},"这是一个评论审查: ",[10,1475,1476],{},"在 waline 中设置好对应的环境变量，使用 npm 安装好对应的包，就算大功告成了。",[10,1478,1479],{},[36,1480],{"alt":64,"src":1481},"https://static.031130.xyz/uploads/2024/10/12/45f06a78286de.webp",[1483,1484,1485],"style",{},"html pre.shiki code .sW2Sy, html code.shiki .sW2Sy{--shiki-default:#A0A1A7;--shiki-default-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic}html pre.shiki code .sLKXg, html code.shiki .sLKXg{--shiki-default:#A626A4;--shiki-dark:#C678DD}html pre.shiki code .sNmU0, html code.shiki .sNmU0{--shiki-default:#986801;--shiki-dark:#E5C07B}html pre.shiki code .s_Sar, html code.shiki .s_Sar{--shiki-default:#0184BC;--shiki-dark:#56B6C2}html pre.shiki code .sAdtL, html code.shiki .sAdtL{--shiki-default:#4078F2;--shiki-dark:#61AFEF}html pre.shiki code .s5ixo, html code.shiki .s5ixo{--shiki-default:#383A42;--shiki-dark:#ABB2BF}html pre.shiki code .sDhpE, html code.shiki .sDhpE{--shiki-default:#50A14F;--shiki-dark:#98C379}html pre.shiki code .s7GmK, html code.shiki .s7GmK{--shiki-default:#383A42;--shiki-dark:#E5C07B}html pre.shiki code .s2QsP, html code.shiki .s2QsP{--shiki-default:#E45649;--shiki-dark:#E5C07B}html pre.shiki code .sJa8x, html code.shiki .sJa8x{--shiki-default:#E45649;--shiki-dark:#E06C75}html pre.shiki code .s8iYz, html code.shiki .s8iYz{--shiki-default:#383A42;--shiki-default-font-style:inherit;--shiki-dark:#E06C75;--shiki-dark-font-style:italic}html pre.shiki code .sz0mV, html code.shiki .sz0mV{--shiki-default:#383A42;--shiki-dark:#E06C75}html pre.shiki code .st7oF, html code.shiki .st7oF{--shiki-default:#0184BC;--shiki-dark:#ABB2BF}html .default .shiki span {color: var(--shiki-default);background: var(--shiki-default-bg);font-style: var(--shiki-default-font-style);font-weight: var(--shiki-default-font-weight);text-decoration: var(--shiki-default-text-decoration);}html .shiki span {color: var(--shiki-default);background: var(--shiki-default-bg);font-style: var(--shiki-default-font-style);font-weight: var(--shiki-default-font-weight);text-decoration: var(--shiki-default-text-decoration);}html .dark .shiki span {color: var(--shiki-dark);background: var(--shiki-dark-bg);font-style: var(--shiki-dark-font-style);font-weight: var(--shiki-dark-font-weight);text-decoration: var(--shiki-dark-text-decoration);}html.dark .shiki span {color: var(--shiki-dark);background: var(--shiki-dark-bg);font-style: var(--shiki-dark-font-style);font-weight: var(--shiki-dark-font-weight);text-decoration: var(--shiki-dark-text-decoration);}html pre.shiki code .sAOjX, html code.shiki .sAOjX{--shiki-default:#CA1243;--shiki-dark:#C678DD}html pre.shiki code .sAGMh, html code.shiki .sAGMh{--shiki-default:#986801;--shiki-dark:#D19A66}html pre.shiki code .sC09Y, html code.shiki .sC09Y{--shiki-default:#C18401;--shiki-dark:#E5C07B}html pre.shiki code .sRZ4U, html code.shiki .sRZ4U{--shiki-default:#986801;--shiki-dark:#E06C75}",{"title":64,"searchDepth":79,"depth":79,"links":1487},[],"2024-10-12 16:11:06","md",{"index_img":1491},"https://static.031130.xyz/uploads/2024/11/01/d1b5a5c058a43.png","/2024/10/12/use-gpt-to-review-waline-comments","---\ntitle: 使用 GPT 对 waline 的评论进行审查\ndate: 2024-10-12 16:11:06\nsticky:\nindex_img: https://static.031130.xyz/uploads/2024/11/01/d1b5a5c058a43.png\ntags:\n- waline\n- GPT\n---\n\n前一阵子收到了这么一条来自 waline 的评论提醒。\n\n> New comment on 竹林里有冰的博客\n> 【网站名称】：竹林里有冰的博客 \n> 【评论者昵称】：专业数据库\n> 【评论者邮箱】：rakhiranijhhg@gmail.com\n> 【内容】：总之，优化专业数据库对于保持数据准确性、提高系统性能和推动业务成功至关重要。通过遵循本文中概述的策略，您可以提高数据库操作的效率并释放新的增长机会。\n> 【地址】：https://zhul.in/2021/04/04/yay-more/#66f7a8889ab78865d5f5ae19\n\n评论的内容不仅透露着一股 AI 味，还和文章内容可谓是一点关系都没有，点开评论者的网站一看，一股塑料机翻味，怕是又是个来蹭 SEO 的广告哥。\n\n![广告哥留下的网站](https://static.031130.xyz/uploads/2024/10/07/4673580090861.webp)\n\n根据 [waline 的官方文档](https://waline.js.org/advanced/faq.html#%E5%8F%91%E5%B8%83%E8%AF%84%E8%AE%BA%E5%BE%88%E6%85%A2%E6%80%8E%E4%B9%88%E5%8A%9E)所言，waline 是使用了 Akismet 提供的垃圾内容检测服务的。可惜它似乎对 AI 生成的垃圾没有分辨能力。因此我计划使用 GPT 代替 Akismet 对 waline 的新评论进行审核。\n\nwalinejs/plugin 提供了一个 [tencent-cms](https://github.com/walinejs/plugins/blob/master/packages/tencent-tms/index.js) 的插件，功能是使用腾讯云的内容审查接口审查评论内容，这和我们需要的功能很像，主体部分和调用方法可以直接借鉴。\n\n```javascript\n// index.js\n\nconst tencentcloud = require(\"tencentcloud-sdk-nodejs-tms\");\nconst TmsClient = tencentcloud.tms.v20201229.Client;\n\n\nmodule.exports = function({secretId, secretKey, region}) {\n  if (!secretId || !secretKey || !region) {\n    return {};\n  }\n\n  const clientConfig = {\n    credential: {\n      secretId,\n      secretKey,\n    },\n    region,\n    profile: {\n      httpProfile: {\n        endpoint: \"tms.tencentcloudapi.com\",\n      },\n    },\n  };\n  \n  return {\n    hooks: {\n      async preSave(data) {\n        const { userInfo } = this.ctx.state;\n        const isAdmin = userInfo.type === 'administrator';\n        // ignore admin comment\n        if (isAdmin) {\n          return;\n        }\n\n        const client = new TmsClient(clientConfig);\n        try {\n          const resp = await client.TextModeration({ Content: data.comment });\n          if (!resp.Suggestion) {\n            throw new Error('Suggestion is empty. Tencent Cloud TMS info:', resp);\n          }\n\n          switch(resp.Suggestion) {\n            case 'Pass':\n              data.status = 'approved';\n              break;\n            case 'Block':\n              data.status = 'spam';\n              break;\n              case 'Review':\n              default:\n                data.status = 'waiting';\n                break;\n          }\n        } catch(e) {\n          console.log(e);\n          data.status = 'waiting';\n        }\n      },\n    },\n  };\n}\n```\n\n可以看到，我们需要在这个被 module.exports 导出的函数中，return 一个对象，如果使用 hooks 编写的话可以调用[一些生命周期 hook](https://waline.js.org/reference/server/config.html#%E8%AF%84%E8%AE%BA-hooks): 在 preSave 阶段，我们可以通过标注 data.status 参数来反馈评论类型。approved 为接受，spam 为垃圾邮件，waiting 为等待人工审核；除此之外，还可以[基于 Koa 中间件制作插件](https://waline.js.org/reference/server/plugin.html#%E5%9F%BA%E4%BA%8E%E4%B8%AD%E9%97%B4%E4%BB%B6%E5%88%B6%E4%BD%9C)，文档中有具体的描述。\n\nindex.js 顶部是需要引入的依赖。当然，如果需要引入外部的第三方包的话，需要在 packages.json 中加入需要的依赖（使用包管理器的命令进行安装）。\n\n有了这些基础知识，就能手搓一个基于 GPT 的评论审查插件。\n\nOpenAI 提供的是标准的 Restful API，本身的鉴权逻辑也不复杂，其实没必要调用 SDK，直接使用 fetch 调用就行。\n\n```javascript\nconst doReview = async (comment) => {\n  const response = await fetch(openaiBaseUrl + '/v1/chat/completions', {\n    method: 'POST',\n    headers: {\n      'Content-Type': 'application/json',\n      'Authorization': `Bearer ${openaiApiKey}`,\n    },\n    body: JSON.stringify({\n      model: openaiModel,\n      messages: [\n        {\n          role: 'system',\n          content: prompt\n        },\n        {\n          role: 'user',\n          content: comment,\n        },\n      ],\n    }),\n  });\n  const data = await response.json();\n  if (data && data.choices && data.choices.length > 0) {\n    return data.choices[0].message.content;\n  } else {\n    return 'waiting';\n  }\n}\n```\n\n再配合相应的封装，一款基于 GPT 的 waline 评论审核插件就完成了\n\n- [zhullyb/waline-plugin-llm-reviewer](https://github.com/zhullyb/waline-plugin-llm-reviewer)\n\n**如何安装**\n\n```bash\nnpm install waline-plugin-llm-reviewer\n```\n\n**如何使用**\n\n```javascript\n// index.js\nconst Waline = require('@waline/vercel');\nconst GPTReviewer = require('waline-plugin-llm-reviewer');\n\nmodule.exports = Waline({\n  plugins: [\n    GptReviewer({\n        openaiBaseUrl: process.env.OPENAI_BASE_URL,\n        openaiModel: process.env.OPENAI_MODEL,\n        openaiApiKey: process.env.OPENAI_API_KEY,\n        openaiPrompt: process.env.OPENAI_PROMPT,\n    })\n  ]\n});\n```\n\n**环境变量**\n\n- `ASISMET_KEY`: Waline 使用的反垃圾评论服务，**建议设置为 `false` 以禁用**。\n- `OPENAI_BASE_URL`: API 基础 URL。例如 `https://api.openai.com`\n- `OPENAI_MODEL`: 模型名称。例如 `gpt-4o-mini`\n- `OPENAI_API_KEY`: API 密钥。例如 `ak-xxxxxx`\n- `OPENAI_PROMPT`(可选): 模型的提示。例如 `这是一个评论审查: `\n\n在 waline 中设置好对应的环境变量，使用 npm 安装好对应的包，就算大功告成了。\n\n![](https://static.031130.xyz/uploads/2024/10/12/45f06a78286de.webp)\n",{"title":5,"description":12},"posts/use-gpt-to-review-waline-comments",false,[1498,1499],"waline","GPT","LJxWEQnqp5aj78KPYswH3eipZR9fgYzrI6Ey_fwDWHI",[1502,1507],{"title":1503,"path":1504,"stem":1505,"date":1506,"children":-1},"为 Hexo 添加 follow 认证","/2024/10/23/follow-cert-for-hexo-feed","posts/follow-cert-for-hexo-feed","2024-10-23 23:11:32",{"title":1508,"path":1509,"stem":1510,"date":1511,"children":-1},"基于 JavaScript 的 Hexo Fluid 主题 banner 随机背景图实现","/2024/09/25/random-banner-backgroud-image-implement-for-hexo-fluid-with-javascript","posts/random-banner-backgroud-image-implement-for-hexo-fluid-with-javascript","2024-09-25 00:00:42",1761738776333]