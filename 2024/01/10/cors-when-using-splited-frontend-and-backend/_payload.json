[{"data":1,"prerenderedAt":555},["ShallowReactive",2],{"post-2024-01-10-cors-when-using-splited-frontend-and-backend-zh":3,"surround-2024-01-10-cors-when-using-splited-frontend-and-backend-zh":542,"randomIndex/2024/01/10/cors-when-using-splited-frontend-and-backend/":93,"language-switch-/2024/01/10/cors-when-using-splited-frontend-and-backend/-en":554},{"title":4,"date":5,"path":6,"tags":7,"body":13,"description":541},"结合 Vue.js 与 php 完成的 web 期末大作业，讲讲前后端分离站点开发与部署中可能遇到的 CORS 跨域问题","2024-01-10 23:55:36","/2024/01/10/cors-when-using-splited-frontend-and-backend",[8,9,10,11,12],"Vue.js","PHP","Network","Notes","Web",{"type":14,"value":15,"toc":531},"minimark",[16,26,29,34,38,46,52,63,77,80,109,112,125,134,150,156,161,164,180,183,186,199,202,205,208,211,218,268,271,501,508,515,518,527],[17,18,19,20,25],"p",{},"在",[21,22,24],"a",{"href":23},"/2023/12/27/php-and-vuejs-project-deploy-on-caddy/","上一篇博客","中，我讲到了 web 期末大作业的上云部署。整个项目是使用 Vue.js 作为前端，php 作为后端，mysql 作为数据库实现的。",[17,27,28],{},"在使用 Vue.js 开发前端界面时，我选择了使用 vite 脚手架帮助开发，这意味着我的作品将使用前后端分离的架构实现。因此在开发部署过程中均遇到了跨域的问题，故写下这篇博客记录下解决方案。",[30,31,33],"h2",{"id":32},"基于后端返回对应-http-响应头的解决方案","基于后端返回对应 http 响应头的解决方案",[35,36,37],"h3",{"id":37},"开发阶段",[17,39,40,41,45],{},"在我完成前后端的开发，并且经过 Apifox 的 mock 测试后，第一次在浏览器尝试前后端对接，遇到了 ",[42,43,44],"code",{},"CORS Missing Allow Origin"," 的报错。",[17,47,48],{},[49,50],"img",{"alt":44,"src":51},"https://static.031130.xyz/uploads/2024/08/12/659ec607c69af.webp",[17,53,54,55,58,59,62],{},"vite 启动的 dev 开发服务器使用的域是 ",[42,56,57],{},"http://localhost:5173"," ，而 php 后端我指定的是 ",[42,60,61],{},"http://127.0.0.1:8080"," ，前后端并不运行在一个域下，前端使用 Axios(AJAX) 向后端发送请求获取资源输入 CORS 跨域资源共享的范畴。",[17,64,65,66,72,73,76],{},"关于跨域资源共享 CORS 的相关内容，",[21,67,71],{"href":68,"rel":69},"https://www.ruanyifeng.com/blog/2016/04/cors.html",[70],"nofollow","阮一峰老师在 2016 年就已经在他的博客中有过解释","，看了下也是全网中文内容中解释得比较通俗易懂的，因此本文在这方面不过多做解释。错误的提示信息是 Missing Allow Origin，结合阮一峰老师的博文，我们应该在后端向前端发送的 http 响应头中添加 ",[42,74,75],{},"Access-Control-Allow-Origin"," 这一字段。",[17,78,79],{},"在一般的前后端分离项目（不涉及 cookie 等 Credentials 属性）中，我们可以将这一字段设置为 * 通配符，默认允许所有的域向自己发起跨域资源请求。php 可以通过下面这行代码很方便地进行设置:",[81,82,87],"pre",{"className":83,"code":84,"language":85,"meta":86,"style":86},"language-php shiki shiki-themes one-light one-dark-pro","header('Access-Control-Allow-Origin: *');\n","php","",[42,88,89],{"__ignoreMap":86},[90,91,94,98,102,106],"span",{"class":92,"line":93},"line",1,[90,95,97],{"class":96},"s_Sar","header",[90,99,101],{"class":100},"s5ixo","(",[90,103,105],{"class":104},"sDhpE","'Access-Control-Allow-Origin: *'",[90,107,108],{"class":100},");\n",[17,110,111],{},"但在用户的注册登录方面，我使用了 session 作为用户的登录凭据。阮一峰老师关于 CORS 的博文中有这样一句话:",[113,114,115],"blockquote",{},[17,116,117,118,120,121,124],{},"需要注意的是，如果要发送Cookie，",[42,119,75],{},"就不能设为星号，必须指定明确的、与请求网页一致的域名。同时，Cookie依然遵循同源政策，只有用服务器域名设置的Cookie才会上传，其他域名的Cookie并不会上传，且（跨源）原网页代码中的",[42,122,123],{},"document.cookie","也无法读取服务器域名下的Cookie。",[17,126,127,128,130,131,133],{},"因此，我们必须明确指定 ",[42,129,75],{}," 字段为前端所使用的域，写上 ",[42,132,57],{}," 才行。",[81,135,137],{"className":83,"code":136,"language":85,"meta":86,"style":86},"header('Access-Control-Allow-Origin: http://localhost:5173');\n",[42,138,139],{"__ignoreMap":86},[90,140,141,143,145,148],{"class":92,"line":93},[90,142,97],{"class":96},[90,144,101],{"class":100},[90,146,147],{"class":104},"'Access-Control-Allow-Origin: http://localhost:5173'",[90,149,108],{"class":100},[17,151,152,153],{},"再次刷新网页，获得了新的错误 ",[42,154,155],{},"CORS Missing Allow Credentials",[17,157,158],{},[49,159],{"alt":155,"src":160},"https://static.031130.xyz/uploads/2024/08/12/659ec95acc0bc.webp",[17,162,163],{},"这个问题处理起来也简单",[81,165,167],{"className":83,"code":166,"language":85,"meta":86,"style":86},"header('Access-Control-Allow-Credentials: true');\n",[42,168,169],{"__ignoreMap":86},[90,170,171,173,175,178],{"class":92,"line":93},[90,172,97],{"class":96},[90,174,101],{"class":100},[90,176,177],{"class":104},"'Access-Control-Allow-Credentials: true'",[90,179,108],{"class":100},[17,181,182],{},"再次运行网页，跨域问题成功解决。",[35,184,185],{"id":185},"部署阶段",[17,187,188,189,191,192,195,196,198],{},"顺着这个思路进行下去，我们在部署阶段解决跨域问题需要做的事情很简单。提前将前端部署起来，将前端的域写到后端返回给前端的 http 相应头中即可。需要注意的是，",[42,190,75],{}," 字段仅允许填写一个值，如果需要同时允许来自多个不同域的跨域资源共享，后端部分需要根据前端发来的请求头中的 ",[42,193,194],{},"Origin"," 字段相应地设置响应头中的 ",[42,197,75],{}," 。当然，nginx 等先进的 static server 也支持劫持 http 请求，添加相关的 Access-Control 语句，也可以在这一层解决这个问题。",[30,200,201],{"id":201},"直接规避跨域的方案",[17,203,204],{},"上面通过后端返回带有 Access-Control 语句相应头的解决方案确实可以解决问题，却显得不够优雅。开发和部署阶段都要手动的去指定前端的域来允许跨域资源共享，这一点过于麻烦了，因此引出了下面的解决方案。",[35,206,37],{"id":207},"开发阶段-1",[17,209,210],{},"在 vite（或者其他同类开发服务器）的帮助下，我们可以使用前端的开发服务器去反向代理后端服务，也就是让前端的请求打到前端服务器上，由前端服务器去返回后端服务器返回的结果。",[17,212,213,214,217],{},"在 ",[42,215,216],{},"vite.config.ts"," 配置文件下，我将原本的",[81,219,223],{"className":220,"code":221,"language":222,"meta":86,"style":86},"language-typescript shiki shiki-themes one-light one-dark-pro","export default defineConfig({\n  plugins: [vue()],\n})\n","typescript",[42,224,225,242,262],{"__ignoreMap":86},[90,226,227,231,235,239],{"class":92,"line":93},[90,228,230],{"class":229},"sLKXg","export",[90,232,234],{"class":233},"sq3v1"," default",[90,236,238],{"class":237},"sAdtL"," defineConfig",[90,240,241],{"class":100},"({\n",[90,243,245,249,253,256,259],{"class":92,"line":244},2,[90,246,248],{"class":247},"sJa8x","  plugins",[90,250,252],{"class":251},"st7oF",":",[90,254,255],{"class":100}," [",[90,257,258],{"class":237},"vue",[90,260,261],{"class":100},"()],\n",[90,263,265],{"class":92,"line":264},3,[90,266,267],{"class":100},"})\n",[17,269,270],{},"换成了",[81,272,274],{"className":220,"code":273,"language":222,"meta":86,"style":86},"export default () => {\n  process.env = { ...process.env, ...loadEnv(process.cwd(),'') };\n\n  const config = {\n    plugins: [vue()],\n    server: {\n      proxy: {\n        '/api': {\n          target: http://127.0.0.1:8080,\n          changeOrigin: true,\n          secure: false,\n        }\n      }\n    }\n  }\n  return defineConfig(config)\n};\n",[42,275,276,291,345,351,365,379,389,399,409,426,442,455,461,467,473,479,495],{"__ignoreMap":86},[90,277,278,280,282,285,288],{"class":92,"line":93},[90,279,230],{"class":229},[90,281,234],{"class":233},[90,283,284],{"class":100}," () ",[90,286,287],{"class":229},"=>",[90,289,290],{"class":100}," {\n",[90,292,293,297,300,303,306,309,312,315,317,319,322,324,327,329,331,333,336,339,342],{"class":92,"line":244},[90,294,296],{"class":295},"s7GmK","  process",[90,298,299],{"class":100},".",[90,301,302],{"class":247},"env",[90,304,305],{"class":96}," =",[90,307,308],{"class":100}," { ",[90,310,311],{"class":251},"...",[90,313,314],{"class":295},"process",[90,316,299],{"class":100},[90,318,302],{"class":247},[90,320,321],{"class":100},", ",[90,323,311],{"class":251},[90,325,326],{"class":237},"loadEnv",[90,328,101],{"class":100},[90,330,314],{"class":295},[90,332,299],{"class":100},[90,334,335],{"class":237},"cwd",[90,337,338],{"class":100},"(),",[90,340,341],{"class":104},"''",[90,343,344],{"class":100},") };\n",[90,346,347],{"class":92,"line":264},[90,348,350],{"emptyLinePlaceholder":349},true,"\n",[90,352,354,357,361,363],{"class":92,"line":353},4,[90,355,356],{"class":229},"  const",[90,358,360],{"class":359},"sNmU0"," config",[90,362,305],{"class":96},[90,364,290],{"class":100},[90,366,368,371,373,375,377],{"class":92,"line":367},5,[90,369,370],{"class":247},"    plugins",[90,372,252],{"class":251},[90,374,255],{"class":100},[90,376,258],{"class":237},[90,378,261],{"class":100},[90,380,382,385,387],{"class":92,"line":381},6,[90,383,384],{"class":247},"    server",[90,386,252],{"class":251},[90,388,290],{"class":100},[90,390,392,395,397],{"class":92,"line":391},7,[90,393,394],{"class":247},"      proxy",[90,396,252],{"class":251},[90,398,290],{"class":100},[90,400,402,405,407],{"class":92,"line":401},8,[90,403,404],{"class":104},"        '/api'",[90,406,252],{"class":251},[90,408,290],{"class":100},[90,410,412,415,417,420,422],{"class":92,"line":411},9,[90,413,414],{"class":247},"          target",[90,416,252],{"class":251},[90,418,419],{"class":247}," http",[90,421,252],{"class":100},[90,423,425],{"class":424},"sW2Sy","//127.0.0.1:8080,\n",[90,427,429,432,435,439],{"class":92,"line":428},10,[90,430,431],{"class":247},"          changeOrigin",[90,433,434],{"class":100},": ",[90,436,438],{"class":437},"sAGMh","true",[90,440,441],{"class":100},",\n",[90,443,445,448,450,453],{"class":92,"line":444},11,[90,446,447],{"class":247},"          secure",[90,449,252],{"class":251},[90,451,452],{"class":437}," false",[90,454,441],{"class":100},[90,456,458],{"class":92,"line":457},12,[90,459,460],{"class":100},"        }\n",[90,462,464],{"class":92,"line":463},13,[90,465,466],{"class":100},"      }\n",[90,468,470],{"class":92,"line":469},14,[90,471,472],{"class":100},"    }\n",[90,474,476],{"class":92,"line":475},15,[90,477,478],{"class":100},"  }\n",[90,480,482,485,487,489,492],{"class":92,"line":481},16,[90,483,484],{"class":229},"  return",[90,486,238],{"class":237},[90,488,101],{"class":100},[90,490,491],{"class":247},"config",[90,493,494],{"class":100},")\n",[90,496,498],{"class":92,"line":497},17,[90,499,500],{"class":100},"};\n",[17,502,503,504,507],{},"同时将 Axios create 时的 ",[42,505,506],{},"baseURL"," 参数去除。",[17,509,510,511,514],{},"这样一套组合拳下来，将所有打向 ",[42,512,513],{},"/api*"," 的请求和响应通过前端的开发服务器作为中介做了中转，让浏览器以为并没有跨域（事实上也没有跨域），从而解决了相关的问题。",[35,516,185],{"id":517},"部署阶段-1",[17,519,520,521,526],{},"在开发阶段，我们通过 vite 的开发服务器做反向代理规避了跨域请求，但在部署阶段就用不了了。由于 vite 服务器的性能太弱，一般情况下我们是不会在生产环境中使用 vite 作为正式的服务器的，而是使用 vite build 出网站的静态网页资源，通过 nginx 等 static server 去向用户提供前端网页。而通过 vite build 出来的静态网页资源本身是不具备反向代理的能力的，这意味着没法在前端侧规避跨域问题。此时，我们应该配置 nginx 规避跨域问题。我一向不怎么使用 nginx，使用的是它的平替品 caddy，因此 nginx 的配置文件需要大家自行搜索，",[21,522,525],{"href":523,"rel":524},"https://zhul.in/2023/12/27/php-and-vuejs-project-deploy-on-caddy/#Caddy-%E9%85%8D%E7%BD%AE",[70],"我的 caddyfile 在上一篇博客中已经给出","，仅供参考。",[528,529,530],"style",{},"html pre.shiki code .sLKXg, html code.shiki .sLKXg{--shiki-default:#A626A4;--shiki-dark:#C678DD}html pre.shiki code .sq3v1, html code.shiki .sq3v1{--shiki-default:#E45649;--shiki-dark:#C678DD}html pre.shiki code .sAdtL, html code.shiki .sAdtL{--shiki-default:#4078F2;--shiki-dark:#61AFEF}html pre.shiki code .s5ixo, html code.shiki .s5ixo{--shiki-default:#383A42;--shiki-dark:#ABB2BF}html pre.shiki code .sJa8x, html code.shiki .sJa8x{--shiki-default:#E45649;--shiki-dark:#E06C75}html pre.shiki code .st7oF, html code.shiki .st7oF{--shiki-default:#0184BC;--shiki-dark:#ABB2BF}html .default .shiki span {color: var(--shiki-default);background: var(--shiki-default-bg);font-style: var(--shiki-default-font-style);font-weight: var(--shiki-default-font-weight);text-decoration: var(--shiki-default-text-decoration);}html .shiki span {color: var(--shiki-default);background: var(--shiki-default-bg);font-style: var(--shiki-default-font-style);font-weight: var(--shiki-default-font-weight);text-decoration: var(--shiki-default-text-decoration);}html .dark .shiki span {color: var(--shiki-dark);background: var(--shiki-dark-bg);font-style: var(--shiki-dark-font-style);font-weight: var(--shiki-dark-font-weight);text-decoration: var(--shiki-dark-text-decoration);}html.dark .shiki span {color: var(--shiki-dark);background: var(--shiki-dark-bg);font-style: var(--shiki-dark-font-style);font-weight: var(--shiki-dark-font-weight);text-decoration: var(--shiki-dark-text-decoration);}html pre.shiki code .s7GmK, html code.shiki .s7GmK{--shiki-default:#383A42;--shiki-dark:#E5C07B}html pre.shiki code .s_Sar, html code.shiki .s_Sar{--shiki-default:#0184BC;--shiki-dark:#56B6C2}html pre.shiki code .sDhpE, html code.shiki .sDhpE{--shiki-default:#50A14F;--shiki-dark:#98C379}html pre.shiki code .sNmU0, html code.shiki .sNmU0{--shiki-default:#986801;--shiki-dark:#E5C07B}html pre.shiki code .sW2Sy, html code.shiki .sW2Sy{--shiki-default:#A0A1A7;--shiki-default-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic}html pre.shiki code .sAGMh, html code.shiki .sAGMh{--shiki-default:#986801;--shiki-dark:#D19A66}",{"title":86,"searchDepth":244,"depth":244,"links":532},[533,537],{"id":32,"depth":244,"text":33,"children":534},[535,536],{"id":37,"depth":264,"text":37},{"id":185,"depth":264,"text":185},{"id":201,"depth":244,"text":201,"children":538},[539,540],{"id":207,"depth":264,"text":37},{"id":517,"depth":264,"text":185},"在上一篇博客中，我讲到了 web 期末大作业的上云部署。整个项目是使用 Vue.js 作为前端，php 作为后端，mysql 作为数据库实现的。",[543,549],{"title":544,"path":545,"stem":546,"date":547,"lang":548,"children":-1},"在 JavaScript 中，箭头函数中的 this 指针到底指向哪里？","/2024/01/14/where-does-this-refer-in-arrow-function-in-js","posts/zh/where-does-this-refer-in-arrow-function-in-js","2024-01-14 02:50:03","zh-CN",{"title":550,"path":551,"stem":552,"date":553,"lang":548,"children":-1},"vuejs、php、caddy 与 docker —— web 期末大作业上云部署","/2023/12/27/php-and-vuejs-project-deploy-on-caddy","posts/zh/php-and-vuejs-project-deploy-on-caddy","2023-12-27 22:09:00",null,1766437461562]