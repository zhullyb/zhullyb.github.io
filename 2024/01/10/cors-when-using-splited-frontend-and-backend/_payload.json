[{"data":1,"prerenderedAt":563},["ShallowReactive",2],{"post-2024-01-10-cors-when-using-splited-frontend-and-backend-zh":3,"surround-2024-01-10-cors-when-using-splited-frontend-and-backend-zh":551,"randomIndex/2024/01/10/cors-when-using-splited-frontend-and-backend/":404,"language-switch-/2024/01/10/cors-when-using-splited-frontend-and-backend/-en":562},{"id":4,"title":5,"body":6,"date":534,"description":535,"extension":536,"lang":537,"meta":538,"navigation":342,"path":539,"rawbody":540,"seo":541,"stem":542,"sticky":543,"tags":544,"__hash__":550},"posts/posts/zh/cors-when-using-splited-frontend-and-backend.md","结合 Vue.js 与 php 完成的 web 期末大作业，讲讲前后端分离站点开发与部署中可能遇到的 CORS 跨域问题",{"type":7,"value":8,"toc":524},"minimark",[9,19,22,27,31,39,45,56,70,73,102,105,118,127,143,149,154,157,173,176,179,192,195,198,201,204,211,261,264,494,501,508,511,520],[10,11,12,13,18],"p",{},"在",[14,15,17],"a",{"href":16},"/2023/12/27/php-and-vuejs-project-deploy-on-caddy/","上一篇博客","中，我讲到了 web 期末大作业的上云部署。整个项目是使用 Vue.js 作为前端，php 作为后端，mysql 作为数据库实现的。",[10,20,21],{},"在使用 Vue.js 开发前端界面时，我选择了使用 vite 脚手架帮助开发，这意味着我的作品将使用前后端分离的架构实现。因此在开发部署过程中均遇到了跨域的问题，故写下这篇博客记录下解决方案。",[23,24,26],"h2",{"id":25},"基于后端返回对应-http-响应头的解决方案","基于后端返回对应 http 响应头的解决方案",[28,29,30],"h3",{"id":30},"开发阶段",[10,32,33,34,38],{},"在我完成前后端的开发，并且经过 Apifox 的 mock 测试后，第一次在浏览器尝试前后端对接，遇到了 ",[35,36,37],"code",{},"CORS Missing Allow Origin"," 的报错。",[10,40,41],{},[42,43],"img",{"alt":37,"src":44},"https://static.031130.xyz/uploads/2024/08/12/659ec607c69af.webp",[10,46,47,48,51,52,55],{},"vite 启动的 dev 开发服务器使用的域是 ",[35,49,50],{},"http://localhost:5173"," ，而 php 后端我指定的是 ",[35,53,54],{},"http://127.0.0.1:8080"," ，前后端并不运行在一个域下，前端使用 Axios(AJAX) 向后端发送请求获取资源输入 CORS 跨域资源共享的范畴。",[10,57,58,59,65,66,69],{},"关于跨域资源共享 CORS 的相关内容，",[14,60,64],{"href":61,"rel":62},"https://www.ruanyifeng.com/blog/2016/04/cors.html",[63],"nofollow","阮一峰老师在 2016 年就已经在他的博客中有过解释","，看了下也是全网中文内容中解释得比较通俗易懂的，因此本文在这方面不过多做解释。错误的提示信息是 Missing Allow Origin，结合阮一峰老师的博文，我们应该在后端向前端发送的 http 响应头中添加 ",[35,67,68],{},"Access-Control-Allow-Origin"," 这一字段。",[10,71,72],{},"在一般的前后端分离项目（不涉及 cookie 等 Credentials 属性）中，我们可以将这一字段设置为 * 通配符，默认允许所有的域向自己发起跨域资源请求。php 可以通过下面这行代码很方便地进行设置:",[74,75,80],"pre",{"className":76,"code":77,"language":78,"meta":79,"style":79},"language-php shiki shiki-themes one-light one-dark-pro","header('Access-Control-Allow-Origin: *');\n","php","",[35,81,82],{"__ignoreMap":79},[83,84,87,91,95,99],"span",{"class":85,"line":86},"line",1,[83,88,90],{"class":89},"s_Sar","header",[83,92,94],{"class":93},"s5ixo","(",[83,96,98],{"class":97},"sDhpE","'Access-Control-Allow-Origin: *'",[83,100,101],{"class":93},");\n",[10,103,104],{},"但在用户的注册登录方面，我使用了 session 作为用户的登录凭据。阮一峰老师关于 CORS 的博文中有这样一句话:",[106,107,108],"blockquote",{},[10,109,110,111,113,114,117],{},"需要注意的是，如果要发送Cookie，",[35,112,68],{},"就不能设为星号，必须指定明确的、与请求网页一致的域名。同时，Cookie依然遵循同源政策，只有用服务器域名设置的Cookie才会上传，其他域名的Cookie并不会上传，且（跨源）原网页代码中的",[35,115,116],{},"document.cookie","也无法读取服务器域名下的Cookie。",[10,119,120,121,123,124,126],{},"因此，我们必须明确指定 ",[35,122,68],{}," 字段为前端所使用的域，写上 ",[35,125,50],{}," 才行。",[74,128,130],{"className":76,"code":129,"language":78,"meta":79,"style":79},"header('Access-Control-Allow-Origin: http://localhost:5173');\n",[35,131,132],{"__ignoreMap":79},[83,133,134,136,138,141],{"class":85,"line":86},[83,135,90],{"class":89},[83,137,94],{"class":93},[83,139,140],{"class":97},"'Access-Control-Allow-Origin: http://localhost:5173'",[83,142,101],{"class":93},[10,144,145,146],{},"再次刷新网页，获得了新的错误 ",[35,147,148],{},"CORS Missing Allow Credentials",[10,150,151],{},[42,152],{"alt":148,"src":153},"https://static.031130.xyz/uploads/2024/08/12/659ec95acc0bc.webp",[10,155,156],{},"这个问题处理起来也简单",[74,158,160],{"className":76,"code":159,"language":78,"meta":79,"style":79},"header('Access-Control-Allow-Credentials: true');\n",[35,161,162],{"__ignoreMap":79},[83,163,164,166,168,171],{"class":85,"line":86},[83,165,90],{"class":89},[83,167,94],{"class":93},[83,169,170],{"class":97},"'Access-Control-Allow-Credentials: true'",[83,172,101],{"class":93},[10,174,175],{},"再次运行网页，跨域问题成功解决。",[28,177,178],{"id":178},"部署阶段",[10,180,181,182,184,185,188,189,191],{},"顺着这个思路进行下去，我们在部署阶段解决跨域问题需要做的事情很简单。提前将前端部署起来，将前端的域写到后端返回给前端的 http 相应头中即可。需要注意的是，",[35,183,68],{}," 字段仅允许填写一个值，如果需要同时允许来自多个不同域的跨域资源共享，后端部分需要根据前端发来的请求头中的 ",[35,186,187],{},"Origin"," 字段相应地设置响应头中的 ",[35,190,68],{}," 。当然，nginx 等先进的 static server 也支持劫持 http 请求，添加相关的 Access-Control 语句，也可以在这一层解决这个问题。",[23,193,194],{"id":194},"直接规避跨域的方案",[10,196,197],{},"上面通过后端返回带有 Access-Control 语句相应头的解决方案确实可以解决问题，却显得不够优雅。开发和部署阶段都要手动的去指定前端的域来允许跨域资源共享，这一点过于麻烦了，因此引出了下面的解决方案。",[28,199,30],{"id":200},"开发阶段-1",[10,202,203],{},"在 vite（或者其他同类开发服务器）的帮助下，我们可以使用前端的开发服务器去反向代理后端服务，也就是让前端的请求打到前端服务器上，由前端服务器去返回后端服务器返回的结果。",[10,205,206,207,210],{},"在 ",[35,208,209],{},"vite.config.ts"," 配置文件下，我将原本的",[74,212,216],{"className":213,"code":214,"language":215,"meta":79,"style":79},"language-typescript shiki shiki-themes one-light one-dark-pro","export default defineConfig({\n  plugins: [vue()],\n})\n","typescript",[35,217,218,235,255],{"__ignoreMap":79},[83,219,220,224,228,232],{"class":85,"line":86},[83,221,223],{"class":222},"sLKXg","export",[83,225,227],{"class":226},"sq3v1"," default",[83,229,231],{"class":230},"sAdtL"," defineConfig",[83,233,234],{"class":93},"({\n",[83,236,238,242,246,249,252],{"class":85,"line":237},2,[83,239,241],{"class":240},"sJa8x","  plugins",[83,243,245],{"class":244},"st7oF",":",[83,247,248],{"class":93}," [",[83,250,251],{"class":230},"vue",[83,253,254],{"class":93},"()],\n",[83,256,258],{"class":85,"line":257},3,[83,259,260],{"class":93},"})\n",[10,262,263],{},"换成了",[74,265,267],{"className":213,"code":266,"language":215,"meta":79,"style":79},"export default () => {\n  process.env = { ...process.env, ...loadEnv(process.cwd(),'') };\n\n  const config = {\n    plugins: [vue()],\n    server: {\n      proxy: {\n        '/api': {\n          target: http://127.0.0.1:8080,\n          changeOrigin: true,\n          secure: false,\n        }\n      }\n    }\n  }\n  return defineConfig(config)\n};\n",[35,268,269,284,338,344,358,372,382,392,402,419,435,448,454,460,466,472,488],{"__ignoreMap":79},[83,270,271,273,275,278,281],{"class":85,"line":86},[83,272,223],{"class":222},[83,274,227],{"class":226},[83,276,277],{"class":93}," () ",[83,279,280],{"class":222},"=>",[83,282,283],{"class":93}," {\n",[83,285,286,290,293,296,299,302,305,308,310,312,315,317,320,322,324,326,329,332,335],{"class":85,"line":237},[83,287,289],{"class":288},"s7GmK","  process",[83,291,292],{"class":93},".",[83,294,295],{"class":240},"env",[83,297,298],{"class":89}," =",[83,300,301],{"class":93}," { ",[83,303,304],{"class":244},"...",[83,306,307],{"class":288},"process",[83,309,292],{"class":93},[83,311,295],{"class":240},[83,313,314],{"class":93},", ",[83,316,304],{"class":244},[83,318,319],{"class":230},"loadEnv",[83,321,94],{"class":93},[83,323,307],{"class":288},[83,325,292],{"class":93},[83,327,328],{"class":230},"cwd",[83,330,331],{"class":93},"(),",[83,333,334],{"class":97},"''",[83,336,337],{"class":93},") };\n",[83,339,340],{"class":85,"line":257},[83,341,343],{"emptyLinePlaceholder":342},true,"\n",[83,345,347,350,354,356],{"class":85,"line":346},4,[83,348,349],{"class":222},"  const",[83,351,353],{"class":352},"sNmU0"," config",[83,355,298],{"class":89},[83,357,283],{"class":93},[83,359,361,364,366,368,370],{"class":85,"line":360},5,[83,362,363],{"class":240},"    plugins",[83,365,245],{"class":244},[83,367,248],{"class":93},[83,369,251],{"class":230},[83,371,254],{"class":93},[83,373,375,378,380],{"class":85,"line":374},6,[83,376,377],{"class":240},"    server",[83,379,245],{"class":244},[83,381,283],{"class":93},[83,383,385,388,390],{"class":85,"line":384},7,[83,386,387],{"class":240},"      proxy",[83,389,245],{"class":244},[83,391,283],{"class":93},[83,393,395,398,400],{"class":85,"line":394},8,[83,396,397],{"class":97},"        '/api'",[83,399,245],{"class":244},[83,401,283],{"class":93},[83,403,405,408,410,413,415],{"class":85,"line":404},9,[83,406,407],{"class":240},"          target",[83,409,245],{"class":244},[83,411,412],{"class":240}," http",[83,414,245],{"class":93},[83,416,418],{"class":417},"sW2Sy","//127.0.0.1:8080,\n",[83,420,422,425,428,432],{"class":85,"line":421},10,[83,423,424],{"class":240},"          changeOrigin",[83,426,427],{"class":93},": ",[83,429,431],{"class":430},"sAGMh","true",[83,433,434],{"class":93},",\n",[83,436,438,441,443,446],{"class":85,"line":437},11,[83,439,440],{"class":240},"          secure",[83,442,245],{"class":244},[83,444,445],{"class":430}," false",[83,447,434],{"class":93},[83,449,451],{"class":85,"line":450},12,[83,452,453],{"class":93},"        }\n",[83,455,457],{"class":85,"line":456},13,[83,458,459],{"class":93},"      }\n",[83,461,463],{"class":85,"line":462},14,[83,464,465],{"class":93},"    }\n",[83,467,469],{"class":85,"line":468},15,[83,470,471],{"class":93},"  }\n",[83,473,475,478,480,482,485],{"class":85,"line":474},16,[83,476,477],{"class":222},"  return",[83,479,231],{"class":230},[83,481,94],{"class":93},[83,483,484],{"class":240},"config",[83,486,487],{"class":93},")\n",[83,489,491],{"class":85,"line":490},17,[83,492,493],{"class":93},"};\n",[10,495,496,497,500],{},"同时将 Axios create 时的 ",[35,498,499],{},"baseURL"," 参数去除。",[10,502,503,504,507],{},"这样一套组合拳下来，将所有打向 ",[35,505,506],{},"/api*"," 的请求和响应通过前端的开发服务器作为中介做了中转，让浏览器以为并没有跨域（事实上也没有跨域），从而解决了相关的问题。",[28,509,178],{"id":510},"部署阶段-1",[10,512,513,514,519],{},"在开发阶段，我们通过 vite 的开发服务器做反向代理规避了跨域请求，但在部署阶段就用不了了。由于 vite 服务器的性能太弱，一般情况下我们是不会在生产环境中使用 vite 作为正式的服务器的，而是使用 vite build 出网站的静态网页资源，通过 nginx 等 static server 去向用户提供前端网页。而通过 vite build 出来的静态网页资源本身是不具备反向代理的能力的，这意味着没法在前端侧规避跨域问题。此时，我们应该配置 nginx 规避跨域问题。我一向不怎么使用 nginx，使用的是它的平替品 caddy，因此 nginx 的配置文件需要大家自行搜索，",[14,515,518],{"href":516,"rel":517},"https://zhul.in/2023/12/27/php-and-vuejs-project-deploy-on-caddy/#Caddy-%E9%85%8D%E7%BD%AE",[63],"我的 caddyfile 在上一篇博客中已经给出","，仅供参考。",[521,522,523],"style",{},"html pre.shiki code .sLKXg, html code.shiki .sLKXg{--shiki-default:#A626A4;--shiki-dark:#C678DD}html pre.shiki code .sq3v1, html code.shiki .sq3v1{--shiki-default:#E45649;--shiki-dark:#C678DD}html pre.shiki code .sAdtL, html code.shiki .sAdtL{--shiki-default:#4078F2;--shiki-dark:#61AFEF}html pre.shiki code .s5ixo, html code.shiki .s5ixo{--shiki-default:#383A42;--shiki-dark:#ABB2BF}html pre.shiki code .sJa8x, html code.shiki .sJa8x{--shiki-default:#E45649;--shiki-dark:#E06C75}html pre.shiki code .st7oF, html code.shiki .st7oF{--shiki-default:#0184BC;--shiki-dark:#ABB2BF}html .default .shiki span {color: var(--shiki-default);background: var(--shiki-default-bg);font-style: var(--shiki-default-font-style);font-weight: var(--shiki-default-font-weight);text-decoration: var(--shiki-default-text-decoration);}html .shiki span {color: var(--shiki-default);background: var(--shiki-default-bg);font-style: var(--shiki-default-font-style);font-weight: var(--shiki-default-font-weight);text-decoration: var(--shiki-default-text-decoration);}html .dark .shiki span {color: var(--shiki-dark);background: var(--shiki-dark-bg);font-style: var(--shiki-dark-font-style);font-weight: var(--shiki-dark-font-weight);text-decoration: var(--shiki-dark-text-decoration);}html.dark .shiki span {color: var(--shiki-dark);background: var(--shiki-dark-bg);font-style: var(--shiki-dark-font-style);font-weight: var(--shiki-dark-font-weight);text-decoration: var(--shiki-dark-text-decoration);}html pre.shiki code .s7GmK, html code.shiki .s7GmK{--shiki-default:#383A42;--shiki-dark:#E5C07B}html pre.shiki code .s_Sar, html code.shiki .s_Sar{--shiki-default:#0184BC;--shiki-dark:#56B6C2}html pre.shiki code .sDhpE, html code.shiki .sDhpE{--shiki-default:#50A14F;--shiki-dark:#98C379}html pre.shiki code .sNmU0, html code.shiki .sNmU0{--shiki-default:#986801;--shiki-dark:#E5C07B}html pre.shiki code .sW2Sy, html code.shiki .sW2Sy{--shiki-default:#A0A1A7;--shiki-default-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic}html pre.shiki code .sAGMh, html code.shiki .sAGMh{--shiki-default:#986801;--shiki-dark:#D19A66}",{"title":79,"searchDepth":237,"depth":237,"links":525},[526,530],{"id":25,"depth":237,"text":26,"children":527},[528,529],{"id":30,"depth":257,"text":30},{"id":178,"depth":257,"text":178},{"id":194,"depth":237,"text":194,"children":531},[532,533],{"id":200,"depth":257,"text":30},{"id":510,"depth":257,"text":178},"2024-01-10 23:55:36","在上一篇博客中，我讲到了 web 期末大作业的上云部署。整个项目是使用 Vue.js 作为前端，php 作为后端，mysql 作为数据库实现的。","md","zh-CN",{},"/2024/01/10/cors-when-using-splited-frontend-and-backend","---\ntitle: 结合 Vue.js 与 php 完成的 web 期末大作业，讲讲前后端分离站点开发与部署中可能遇到的 CORS 跨域问题\ndate: 2024-01-10 23:55:36\nsticky:\ntags:\n- Vue.js\n- PHP\n- Network\n- Notes\n- Web\n---\n\n在[上一篇博客](/2023/12/27/php-and-vuejs-project-deploy-on-caddy/)中，我讲到了 web 期末大作业的上云部署。整个项目是使用 Vue.js 作为前端，php 作为后端，mysql 作为数据库实现的。\n\n在使用 Vue.js 开发前端界面时，我选择了使用 vite 脚手架帮助开发，这意味着我的作品将使用前后端分离的架构实现。因此在开发部署过程中均遇到了跨域的问题，故写下这篇博客记录下解决方案。\n\n## 基于后端返回对应 http 响应头的解决方案\n\n### 开发阶段\n\n在我完成前后端的开发，并且经过 Apifox 的 mock 测试后，第一次在浏览器尝试前后端对接，遇到了 `CORS Missing Allow Origin` 的报错。\n\n![CORS Missing Allow Origin](https://static.031130.xyz/uploads/2024/08/12/659ec607c69af.webp)\n\nvite 启动的 dev 开发服务器使用的域是 `http://localhost:5173` ，而 php 后端我指定的是 `http://127.0.0.1:8080` ，前后端并不运行在一个域下，前端使用 Axios(AJAX) 向后端发送请求获取资源输入 CORS 跨域资源共享的范畴。\n\n关于跨域资源共享 CORS 的相关内容，[阮一峰老师在 2016 年就已经在他的博客中有过解释](https://www.ruanyifeng.com/blog/2016/04/cors.html)，看了下也是全网中文内容中解释得比较通俗易懂的，因此本文在这方面不过多做解释。错误的提示信息是 Missing Allow Origin，结合阮一峰老师的博文，我们应该在后端向前端发送的 http 响应头中添加 `Access-Control-Allow-Origin` 这一字段。\n\n在一般的前后端分离项目（不涉及 cookie 等 Credentials 属性）中，我们可以将这一字段设置为 * 通配符，默认允许所有的域向自己发起跨域资源请求。php 可以通过下面这行代码很方便地进行设置:\n\n```php\nheader('Access-Control-Allow-Origin: *');\n```\n\n但在用户的注册登录方面，我使用了 session 作为用户的登录凭据。阮一峰老师关于 CORS 的博文中有这样一句话:\n\n> 需要注意的是，如果要发送Cookie，`Access-Control-Allow-Origin`就不能设为星号，必须指定明确的、与请求网页一致的域名。同时，Cookie依然遵循同源政策，只有用服务器域名设置的Cookie才会上传，其他域名的Cookie并不会上传，且（跨源）原网页代码中的`document.cookie`也无法读取服务器域名下的Cookie。\n\n因此，我们必须明确指定 `Access-Control-Allow-Origin` 字段为前端所使用的域，写上 `http://localhost:5173` 才行。\n\n```php\nheader('Access-Control-Allow-Origin: http://localhost:5173');\n```\n\n再次刷新网页，获得了新的错误 `CORS Missing Allow Credentials`\n\n![CORS Missing Allow Credentials](https://static.031130.xyz/uploads/2024/08/12/659ec95acc0bc.webp)\n\n这个问题处理起来也简单\n\n```php\nheader('Access-Control-Allow-Credentials: true');\n```\n\n再次运行网页，跨域问题成功解决。\n\n### 部署阶段\n\n顺着这个思路进行下去，我们在部署阶段解决跨域问题需要做的事情很简单。提前将前端部署起来，将前端的域写到后端返回给前端的 http 相应头中即可。需要注意的是，`Access-Control-Allow-Origin` 字段仅允许填写一个值，如果需要同时允许来自多个不同域的跨域资源共享，后端部分需要根据前端发来的请求头中的 `Origin` 字段相应地设置响应头中的 `Access-Control-Allow-Origin` 。当然，nginx 等先进的 static server 也支持劫持 http 请求，添加相关的 Access-Control 语句，也可以在这一层解决这个问题。\n\n## 直接规避跨域的方案\n\n上面通过后端返回带有 Access-Control 语句相应头的解决方案确实可以解决问题，却显得不够优雅。开发和部署阶段都要手动的去指定前端的域来允许跨域资源共享，这一点过于麻烦了，因此引出了下面的解决方案。\n\n### 开发阶段\n\n在 vite（或者其他同类开发服务器）的帮助下，我们可以使用前端的开发服务器去反向代理后端服务，也就是让前端的请求打到前端服务器上，由前端服务器去返回后端服务器返回的结果。\n\n在 `vite.config.ts` 配置文件下，我将原本的\n\n```typescript\nexport default defineConfig({\n  plugins: [vue()],\n})\n```\n\n换成了\n\n```typescript\nexport default () => {\n  process.env = { ...process.env, ...loadEnv(process.cwd(),'') };\n\n  const config = {\n    plugins: [vue()],\n    server: {\n      proxy: {\n        '/api': {\n          target: http://127.0.0.1:8080,\n          changeOrigin: true,\n          secure: false,\n        }\n      }\n    }\n  }\n  return defineConfig(config)\n};\n```\n\n同时将 Axios create 时的 `baseURL` 参数去除。\n\n这样一套组合拳下来，将所有打向 `/api*` 的请求和响应通过前端的开发服务器作为中介做了中转，让浏览器以为并没有跨域（事实上也没有跨域），从而解决了相关的问题。\n\n### 部署阶段\n\n在开发阶段，我们通过 vite 的开发服务器做反向代理规避了跨域请求，但在部署阶段就用不了了。由于 vite 服务器的性能太弱，一般情况下我们是不会在生产环境中使用 vite 作为正式的服务器的，而是使用 vite build 出网站的静态网页资源，通过 nginx 等 static server 去向用户提供前端网页。而通过 vite build 出来的静态网页资源本身是不具备反向代理的能力的，这意味着没法在前端侧规避跨域问题。此时，我们应该配置 nginx 规避跨域问题。我一向不怎么使用 nginx，使用的是它的平替品 caddy，因此 nginx 的配置文件需要大家自行搜索，[我的 caddyfile 在上一篇博客中已经给出](https://zhul.in/2023/12/27/php-and-vuejs-project-deploy-on-caddy/#Caddy-%E9%85%8D%E7%BD%AE)，仅供参考。\n",{"title":5,"description":535},"posts/zh/cors-when-using-splited-frontend-and-backend",false,[545,546,547,548,549],"Vue.js","PHP","Network","Notes","Web","1oTLkgBaYHOlSLwP9zd8wcQh9ZnJPNGqteUnYO1eQl8",[552,557],{"title":553,"path":554,"stem":555,"date":556,"lang":537,"children":-1},"在 JavaScript 中，箭头函数中的 this 指针到底指向哪里？","/2024/01/14/where-does-this-refer-in-arrow-function-in-js","posts/zh/where-does-this-refer-in-arrow-function-in-js","2024-01-14 02:50:03",{"title":558,"path":559,"stem":560,"date":561,"lang":537,"children":-1},"vuejs、php、caddy 与 docker —— web 期末大作业上云部署","/2023/12/27/php-and-vuejs-project-deploy-on-caddy","posts/zh/php-and-vuejs-project-deploy-on-caddy","2023-12-27 22:09:00",null,1763672458635]