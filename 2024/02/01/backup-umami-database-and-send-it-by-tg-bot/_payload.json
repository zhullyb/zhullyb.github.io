[{"data":1,"prerenderedAt":406},["ShallowReactive",2],{"post-2024-02-01-backup-umami-database-and-send-it-by-tg-bot-zh":3,"surround-2024-02-01-backup-umami-database-and-send-it-by-tg-bot-zh":393,"randomIndex/2024/02/01/backup-umami-database-and-send-it-by-tg-bot/":128,"language-switch-/2024/02/01/backup-umami-database-and-send-it-by-tg-bot/-en":405},{"title":4,"date":5,"path":6,"tags":7,"body":11,"description":392},"备份 umami 数据库，并使用 TG Bot 保存 dump 文件","2024-02-01 00:00:01","/2024/02/01/backup-umami-database-and-send-it-by-tg-bot",[8,9,10],"umami","Shell Script","Bot",{"type":12,"value":13,"toc":390},"minimark",[14,26,34,41,44,47,231,242,245,254,257,265,274,349,356,380,386],[15,16,17,18,25],"p",{},"前一阵子看到点墨的博客",[19,20,24],"a",{"href":21,"rel":22},"https://blog.m-l.cc/2023/11/09/ding-shi-bei-fen-mysql-mariadb-shu-ju-ku-bing-shang-chuan-zhi-tgbot/",[23],"nofollow","「定时备份mysql/mariadb数据库并上传至tgbot」","，我意识到个人站点的数据库 dump 使用 TG Bot 存放是一个非常合适的做法。个人站点的数据库体积本身就不大，TG Bot 又有官方提供的 api，非常适合自动化任务。我就寻思着给我的 umami 数据库也写个定时任务备份一下，也不至于之前做一次迁移数据全部爆炸的悲剧重演。",[15,27,28,29,33],{},"我的 umami 是",[19,30,32],{"href":31},"/2022/11/08/free-umami-deploy-plan/","「使用 vercel+supabase 免费部署 umami」","部署出来的，数据库在 supabase 上，因此我们先打开 supabase 的 dashboard，获取到数据库的 url。",[15,35,36],{},[37,38],"img",{"alt":39,"src":40},"supabase 操作面板","https://static.031130.xyz/uploads/2024/08/12/65ba6aae157e6.webp",[15,42,43],{},"密码我自然是不记得了，不过好在 Firefox 的密码管理器帮我记住了，直接去设置里就能找到。即使密码忘了也不要紧，往下翻有重置密码的按钮。",[15,45,46],{},"随后就要开始编写我们的教本了，这是我的",[48,49,54],"pre",{"className":50,"code":51,"language":52,"meta":53,"style":53},"language-bash shiki shiki-themes one-light one-dark-pro","#!/bin/bash\n\nDATABASE_URL=\"postgres://\"\nDATE=$(date '+%F')\n\nTG_BOT_TOKEN='1145141919:ABCDEFGHIJKLVMNOPQRSTUVWXYZabcdefgh'\nTG_CHAT_ID='9191415411'\n\npg_dump ${DATABASE_URL} > umami_dump_${DATE}.sql\ncurl -F document=@umami_dump_${DATE}.sql https://api.telegram.org/bot${TG_BOT_TOKEN}/sendDocument?chat_id=${TG_CHAT_ID}\nrm umami_dump_${DATE}.sql\n","bash","",[55,56,57,66,73,88,110,115,126,137,142,173,214],"code",{"__ignoreMap":53},[58,59,62],"span",{"class":60,"line":61},"line",1,[58,63,65],{"class":64},"sW2Sy","#!/bin/bash\n",[58,67,69],{"class":60,"line":68},2,[58,70,72],{"emptyLinePlaceholder":71},true,"\n",[58,74,76,80,84],{"class":60,"line":75},3,[58,77,79],{"class":78},"sJa8x","DATABASE_URL",[58,81,83],{"class":82},"sknuh","=",[58,85,87],{"class":86},"sDhpE","\"postgres://\"\n",[58,89,91,94,96,100,104,107],{"class":60,"line":90},4,[58,92,93],{"class":78},"DATE",[58,95,83],{"class":82},[58,97,99],{"class":98},"s5ixo","$(",[58,101,103],{"class":102},"sAdtL","date",[58,105,106],{"class":86}," '+%F'",[58,108,109],{"class":98},")\n",[58,111,113],{"class":60,"line":112},5,[58,114,72],{"emptyLinePlaceholder":71},[58,116,118,121,123],{"class":60,"line":117},6,[58,119,120],{"class":78},"TG_BOT_TOKEN",[58,122,83],{"class":82},[58,124,125],{"class":86},"'1145141919:ABCDEFGHIJKLVMNOPQRSTUVWXYZabcdefgh'\n",[58,127,129,132,134],{"class":60,"line":128},7,[58,130,131],{"class":78},"TG_CHAT_ID",[58,133,83],{"class":82},[58,135,136],{"class":86},"'9191415411'\n",[58,138,140],{"class":60,"line":139},8,[58,141,72],{"emptyLinePlaceholder":71},[58,143,145,148,152,154,157,160,163,166,168,170],{"class":60,"line":144},9,[58,146,147],{"class":102},"pg_dump",[58,149,151],{"class":150},"sr1Ac"," ${",[58,153,79],{"class":78},[58,155,156],{"class":150},"}",[58,158,159],{"class":98}," > ",[58,161,162],{"class":86},"umami_dump_",[58,164,165],{"class":150},"${",[58,167,93],{"class":78},[58,169,156],{"class":150},[58,171,172],{"class":86},".sql\n",[58,174,176,179,183,186,188,190,192,195,198,200,202,204,207,209,211],{"class":60,"line":175},10,[58,177,178],{"class":102},"curl",[58,180,182],{"class":181},"sAGMh"," -F",[58,184,185],{"class":86}," document=@umami_dump_",[58,187,165],{"class":150},[58,189,93],{"class":78},[58,191,156],{"class":150},[58,193,194],{"class":86},".sql",[58,196,197],{"class":86}," https://api.telegram.org/bot",[58,199,165],{"class":150},[58,201,120],{"class":78},[58,203,156],{"class":150},[58,205,206],{"class":86},"/sendDocument?chat_id=",[58,208,165],{"class":150},[58,210,131],{"class":78},[58,212,213],{"class":150},"}\n",[58,215,217,220,223,225,227,229],{"class":60,"line":216},11,[58,218,219],{"class":102},"rm",[58,221,222],{"class":86}," umami_dump_",[58,224,165],{"class":150},[58,226,93],{"class":78},[58,228,156],{"class":150},[58,230,172],{"class":86},[15,232,233,234,237,238,241],{},"将这段代码保存为 ",[55,235,236],{},"umami_db_dumper.sh","，随后 ",[55,239,240],{},"chmod +x ./umami_db_dumper.sh"," 授予可执行权限。",[15,243,244],{},"可以先在命令行中执行命令试一下这段脚本是否正常工作",[48,246,248],{"className":50,"code":247,"language":52,"meta":53,"style":53},"./umami_db_dumper.sh\n",[55,249,250],{"__ignoreMap":53},[58,251,252],{"class":60,"line":61},[58,253,247],{"class":102},[15,255,256],{},"这段代码在我本机正常工作，可惜在我的 Ubuntu VPS 上报错",[48,258,263],{"className":259,"code":261,"language":262},[260],"language-text","pg_dump: error: server version: 14.1; pg_dump version: 12.17 (Ubuntu 12.17-0ubuntu0.20.04.1)\npg_dump: error: aborting because of server version mismatch\n","text",[55,264,261],{"__ignoreMap":53},[15,266,267,268,273],{},"看上去是 VPS 上的 PostgreSQL 版本过低，Google 搜索一顿后，我在一篇",[19,269,272],{"href":270,"rel":271},"https://devopsworld.medium.com/upgrade-pg-dump-version-in-ubuntu-545d691d4695",[23],"「Upgrade pg_dump version in ubuntu | by Anushareddy」"," 文章中找到了方案，添加 PostgreSQL 官方提供的 apt 源将 VPS 上的 PostgreSQL 更新到新版即可解决。",[48,275,277],{"className":50,"code":276,"language":52,"meta":53,"style":53},"wget --quiet -O - https://www.postgresql.org/media/keys/ACCC4CF8.asc | apt-key add -\necho \"deb http://apt.postgresql.org/pub/repos/apt/ $(lsb_release -cs)-pgdg main\" > /etc/apt/sources.list.d/pgdg.list\napt update\napt install postgresql-client\n",[55,278,279,308,331,339],{"__ignoreMap":53},[58,280,281,284,287,290,293,296,299,302,305],{"class":60,"line":61},[58,282,283],{"class":102},"wget",[58,285,286],{"class":181}," --quiet",[58,288,289],{"class":181}," -O",[58,291,292],{"class":86}," -",[58,294,295],{"class":86}," https://www.postgresql.org/media/keys/ACCC4CF8.asc",[58,297,298],{"class":98}," | ",[58,300,301],{"class":102},"apt-key",[58,303,304],{"class":86}," add",[58,306,307],{"class":86}," -\n",[58,309,310,314,317,320,323,326,328],{"class":60,"line":68},[58,311,313],{"class":312},"s_Sar","echo",[58,315,316],{"class":86}," \"deb http://apt.postgresql.org/pub/repos/apt/ $(",[58,318,319],{"class":102},"lsb_release",[58,321,322],{"class":181}," -cs",[58,324,325],{"class":86},")-pgdg main\"",[58,327,159],{"class":98},[58,329,330],{"class":86},"/etc/apt/sources.list.d/pgdg.list\n",[58,332,333,336],{"class":60,"line":75},[58,334,335],{"class":102},"apt",[58,337,338],{"class":86}," update\n",[58,340,341,343,346],{"class":60,"line":90},[58,342,335],{"class":102},[58,344,345],{"class":86}," install",[58,347,348],{"class":86}," postgresql-client\n",[15,350,351,352,355],{},"确保脚本正常工作后，使用 ",[55,353,354],{},"crontab -e"," 设置自动任务",[48,357,359],{"className":50,"code":358,"language":52,"meta":53,"style":53},"0 2 * * * /root/umami_db_dumper.sh\n",[55,360,361],{"__ignoreMap":53},[58,362,363,366,369,373,375,377],{"class":60,"line":61},[58,364,365],{"class":102},"0",[58,367,368],{"class":181}," 2",[58,370,372],{"class":371},"s2QsP"," *",[58,374,372],{"class":371},[58,376,372],{"class":371},[58,378,379],{"class":86}," /root/umami_db_dumper.sh\n",[15,381,382],{},[37,383],{"alt":384,"src":385},"数据库备份","https://static.031130.xyz/uploads/2024/08/12/65c79455b2e40.webp",[387,388,389],"style",{},"html pre.shiki code .sW2Sy, html code.shiki .sW2Sy{--shiki-default:#A0A1A7;--shiki-default-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic}html pre.shiki code .sJa8x, html code.shiki .sJa8x{--shiki-default:#E45649;--shiki-dark:#E06C75}html pre.shiki code .sknuh, html code.shiki .sknuh{--shiki-default:#383A42;--shiki-dark:#56B6C2}html pre.shiki code .sDhpE, html code.shiki .sDhpE{--shiki-default:#50A14F;--shiki-dark:#98C379}html pre.shiki code .s5ixo, html code.shiki .s5ixo{--shiki-default:#383A42;--shiki-dark:#ABB2BF}html pre.shiki code .sAdtL, html code.shiki .sAdtL{--shiki-default:#4078F2;--shiki-dark:#61AFEF}html pre.shiki code .sr1Ac, html code.shiki .sr1Ac{--shiki-default:#E45649;--shiki-dark:#ABB2BF}html pre.shiki code .sAGMh, html code.shiki .sAGMh{--shiki-default:#986801;--shiki-dark:#D19A66}html .default .shiki span {color: var(--shiki-default);background: var(--shiki-default-bg);font-style: var(--shiki-default-font-style);font-weight: var(--shiki-default-font-weight);text-decoration: var(--shiki-default-text-decoration);}html .shiki span {color: var(--shiki-default);background: var(--shiki-default-bg);font-style: var(--shiki-default-font-style);font-weight: var(--shiki-default-font-weight);text-decoration: var(--shiki-default-text-decoration);}html .dark .shiki span {color: var(--shiki-dark);background: var(--shiki-dark-bg);font-style: var(--shiki-dark-font-style);font-weight: var(--shiki-dark-font-weight);text-decoration: var(--shiki-dark-text-decoration);}html.dark .shiki span {color: var(--shiki-dark);background: var(--shiki-dark-bg);font-style: var(--shiki-dark-font-style);font-weight: var(--shiki-dark-font-weight);text-decoration: var(--shiki-dark-text-decoration);}html pre.shiki code .s_Sar, html code.shiki .s_Sar{--shiki-default:#0184BC;--shiki-dark:#56B6C2}html pre.shiki code .s2QsP, html code.shiki .s2QsP{--shiki-default:#E45649;--shiki-dark:#E5C07B}",{"title":53,"searchDepth":68,"depth":68,"links":391},[],"前一阵子看到点墨的博客「定时备份mysql/mariadb数据库并上传至tgbot」，我意识到个人站点的数据库 dump 使用 TG Bot 存放是一个非常合适的做法。个人站点的数据库体积本身就不大，TG Bot 又有官方提供的 api，非常适合自动化任务。我就寻思着给我的 umami 数据库也写个定时任务备份一下，也不至于之前做一次迁移数据全部爆炸的悲剧重演。",[394,400],{"title":395,"path":396,"stem":397,"date":398,"lang":399,"children":-1},"crontab 中简单的@语法糖","/2024/02/08/extra-usage-for-crontab","posts/zh/extra-usage-for-crontab","2024-02-08 17:21:31","zh-CN",{"title":401,"path":402,"stem":403,"date":404,"lang":399,"children":-1},"在 JavaScript 中，箭头函数中的 this 指针到底指向哪里？","/2024/01/14/where-does-this-refer-in-arrow-function-in-js","posts/zh/where-does-this-refer-in-arrow-function-in-js","2024-01-14 02:50:03",null,1771555475694]