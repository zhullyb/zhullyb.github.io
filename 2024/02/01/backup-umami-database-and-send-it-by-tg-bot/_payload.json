[{"data":1,"prerenderedAt":385},["ShallowReactive",2],{"post-2024-02-01-backup-umami-database-and-send-it-by-tg-bot":3,"surround-2024-02-01-backup-umami-database-and-send-it-by-tg-bot":373,"randomIndex/2024/02/01/backup-umami-database-and-send-it-by-tg-bot/":384},{"id":4,"title":5,"body":6,"date":359,"description":360,"extension":361,"meta":362,"navigation":66,"path":363,"rawbody":364,"seo":365,"stem":366,"sticky":367,"tags":368,"__hash__":372},"posts/posts/backup-umami-database-and-send-it-by-tg-bot.md","备份 umami 数据库，并使用 TG Bot 保存 dump 文件",{"type":7,"value":8,"toc":357},"minimark",[9,21,29,36,39,42,199,210,213,222,225,233,242,317,324,347,353],[10,11,12,13,20],"p",{},"前一阵子看到点墨的博客",[14,15,19],"a",{"href":16,"rel":17},"https://blog.m-l.cc/2023/11/09/ding-shi-bei-fen-mysql-mariadb-shu-ju-ku-bing-shang-chuan-zhi-tgbot/",[18],"nofollow","「定时备份mysql/mariadb数据库并上传至tgbot」","，我意识到个人站点的数据库 dump 使用 TG Bot 存放是一个非常合适的做法。个人站点的数据库体积本身就不大，TG Bot 又有官方提供的 api，非常适合自动化任务。我就寻思着给我的 umami 数据库也写个定时任务备份一下，也不至于之前做一次迁移数据全部爆炸的悲剧重演。",[10,22,23,24,28],{},"我的 umami 是",[14,25,27],{"href":26},"/2022/11/08/free-umami-deploy-plan/","「使用 vercel+supabase 免费部署 umami」","部署出来的，数据库在 supabase 上，因此我们先打开 supabase 的 dashboard，获取到数据库的 url。",[10,30,31],{},[32,33],"img",{"alt":34,"src":35},"supabase 操作面板","https://static.031130.xyz/uploads/2024/08/12/65ba6aae157e6.webp",[10,37,38],{},"密码我自然是不记得了，不过好在 Firefox 的密码管理器帮我记住了，直接去设置里就能找到。即使密码忘了也不要紧，往下翻有重置密码的按钮。",[10,40,41],{},"随后就要开始编写我们的教本了，这是我的",[43,44,49],"pre",{"className":45,"code":46,"language":47,"meta":48,"style":48},"language-bash shiki shiki-themes github-light github-dark","#!/bin/bash\n\nDATABASE_URL=\"postgres://\"\nDATE=$(date '+%F')\n\nTG_BOT_TOKEN='1145141919:ABCDEFGHIJKLVMNOPQRSTUVWXYZabcdefgh'\nTG_CHAT_ID='9191415411'\n\npg_dump ${DATABASE_URL} > umami_dump_${DATE}.sql\ncurl -F document=@umami_dump_${DATE}.sql https://api.telegram.org/bot${TG_BOT_TOKEN}/sendDocument?chat_id=${TG_CHAT_ID}\nrm umami_dump_${DATE}.sql\n","bash","",[50,51,52,61,68,83,104,109,120,131,136,157,187],"code",{"__ignoreMap":48},[53,54,57],"span",{"class":55,"line":56},"line",1,[53,58,60],{"class":59},"sJ8bj","#!/bin/bash\n",[53,62,64],{"class":55,"line":63},2,[53,65,67],{"emptyLinePlaceholder":66},true,"\n",[53,69,71,75,79],{"class":55,"line":70},3,[53,72,74],{"class":73},"sVt8B","DATABASE_URL",[53,76,78],{"class":77},"szBVR","=",[53,80,82],{"class":81},"sZZnC","\"postgres://\"\n",[53,84,86,89,91,94,98,101],{"class":55,"line":85},4,[53,87,88],{"class":73},"DATE",[53,90,78],{"class":77},[53,92,93],{"class":73},"$(",[53,95,97],{"class":96},"sScJk","date",[53,99,100],{"class":81}," '+%F'",[53,102,103],{"class":73},")\n",[53,105,107],{"class":55,"line":106},5,[53,108,67],{"emptyLinePlaceholder":66},[53,110,112,115,117],{"class":55,"line":111},6,[53,113,114],{"class":73},"TG_BOT_TOKEN",[53,116,78],{"class":77},[53,118,119],{"class":81},"'1145141919:ABCDEFGHIJKLVMNOPQRSTUVWXYZabcdefgh'\n",[53,121,123,126,128],{"class":55,"line":122},7,[53,124,125],{"class":73},"TG_CHAT_ID",[53,127,78],{"class":77},[53,129,130],{"class":81},"'9191415411'\n",[53,132,134],{"class":55,"line":133},8,[53,135,67],{"emptyLinePlaceholder":66},[53,137,139,142,145,148,151,154],{"class":55,"line":138},9,[53,140,141],{"class":96},"pg_dump",[53,143,144],{"class":73}," ${DATABASE_URL} ",[53,146,147],{"class":77},">",[53,149,150],{"class":81}," umami_dump_",[53,152,153],{"class":73},"${DATE}",[53,155,156],{"class":81},".sql\n",[53,158,160,163,167,170,172,175,178,181,184],{"class":55,"line":159},10,[53,161,162],{"class":96},"curl",[53,164,166],{"class":165},"sj4cs"," -F",[53,168,169],{"class":81}," document=@umami_dump_",[53,171,153],{"class":73},[53,173,174],{"class":81},".sql",[53,176,177],{"class":81}," https://api.telegram.org/bot",[53,179,180],{"class":73},"${TG_BOT_TOKEN}",[53,182,183],{"class":81},"/sendDocument?chat_id=",[53,185,186],{"class":73},"${TG_CHAT_ID}\n",[53,188,190,193,195,197],{"class":55,"line":189},11,[53,191,192],{"class":96},"rm",[53,194,150],{"class":81},[53,196,153],{"class":73},[53,198,156],{"class":81},[10,200,201,202,205,206,209],{},"将这段代码保存为 ",[50,203,204],{},"umami_db_dumper.sh","，随后 ",[50,207,208],{},"chmod +x ./umami_db_dumper.sh"," 授予可执行权限。",[10,211,212],{},"可以先在命令行中执行命令试一下这段脚本是否正常工作",[43,214,216],{"className":45,"code":215,"language":47,"meta":48,"style":48},"./umami_db_dumper.sh\n",[50,217,218],{"__ignoreMap":48},[53,219,220],{"class":55,"line":56},[53,221,215],{"class":96},[10,223,224],{},"这段代码在我本机正常工作，可惜在我的 Ubuntu VPS 上报错",[43,226,231],{"className":227,"code":229,"language":230},[228],"language-text","pg_dump: error: server version: 14.1; pg_dump version: 12.17 (Ubuntu 12.17-0ubuntu0.20.04.1)\npg_dump: error: aborting because of server version mismatch\n","text",[50,232,229],{"__ignoreMap":48},[10,234,235,236,241],{},"看上去是 VPS 上的 PostgreSQL 版本过低，Google 搜索一顿后，我在一篇",[14,237,240],{"href":238,"rel":239},"https://devopsworld.medium.com/upgrade-pg-dump-version-in-ubuntu-545d691d4695",[18],"「Upgrade pg_dump version in ubuntu | by Anushareddy」"," 文章中找到了方案，添加 PostgreSQL 官方提供的 apt 源将 VPS 上的 PostgreSQL 更新到新版即可解决。",[43,243,245],{"className":45,"code":244,"language":47,"meta":48,"style":48},"wget --quiet -O - https://www.postgresql.org/media/keys/ACCC4CF8.asc | apt-key add -\necho \"deb http://apt.postgresql.org/pub/repos/apt/ $(lsb_release -cs)-pgdg main\" > /etc/apt/sources.list.d/pgdg.list\napt update\napt install postgresql-client\n",[50,246,247,276,299,307],{"__ignoreMap":48},[53,248,249,252,255,258,261,264,267,270,273],{"class":55,"line":56},[53,250,251],{"class":96},"wget",[53,253,254],{"class":165}," --quiet",[53,256,257],{"class":165}," -O",[53,259,260],{"class":81}," -",[53,262,263],{"class":81}," https://www.postgresql.org/media/keys/ACCC4CF8.asc",[53,265,266],{"class":77}," |",[53,268,269],{"class":96}," apt-key",[53,271,272],{"class":81}," add",[53,274,275],{"class":81}," -\n",[53,277,278,281,284,287,290,293,296],{"class":55,"line":63},[53,279,280],{"class":165},"echo",[53,282,283],{"class":81}," \"deb http://apt.postgresql.org/pub/repos/apt/ $(",[53,285,286],{"class":96},"lsb_release",[53,288,289],{"class":165}," -cs",[53,291,292],{"class":81},")-pgdg main\"",[53,294,295],{"class":77}," >",[53,297,298],{"class":81}," /etc/apt/sources.list.d/pgdg.list\n",[53,300,301,304],{"class":55,"line":70},[53,302,303],{"class":96},"apt",[53,305,306],{"class":81}," update\n",[53,308,309,311,314],{"class":55,"line":85},[53,310,303],{"class":96},[53,312,313],{"class":81}," install",[53,315,316],{"class":81}," postgresql-client\n",[10,318,319,320,323],{},"确保脚本正常工作后，使用 ",[50,321,322],{},"crontab -e"," 设置自动任务",[43,325,327],{"className":45,"code":326,"language":47,"meta":48,"style":48},"0 2 * * * /root/umami_db_dumper.sh\n",[50,328,329],{"__ignoreMap":48},[53,330,331,334,337,340,342,344],{"class":55,"line":56},[53,332,333],{"class":96},"0",[53,335,336],{"class":165}," 2",[53,338,339],{"class":165}," *",[53,341,339],{"class":165},[53,343,339],{"class":165},[53,345,346],{"class":81}," /root/umami_db_dumper.sh\n",[10,348,349],{},[32,350],{"alt":351,"src":352},"数据库备份","https://static.031130.xyz/uploads/2024/08/12/65c79455b2e40.webp",[354,355,356],"style",{},"html pre.shiki code .sJ8bj, html code.shiki .sJ8bj{--shiki-default:#6A737D;--shiki-dark:#6A737D}html pre.shiki code .sVt8B, html code.shiki .sVt8B{--shiki-default:#24292E;--shiki-dark:#E1E4E8}html pre.shiki code .szBVR, html code.shiki .szBVR{--shiki-default:#D73A49;--shiki-dark:#F97583}html pre.shiki code .sZZnC, html code.shiki .sZZnC{--shiki-default:#032F62;--shiki-dark:#9ECBFF}html pre.shiki code .sScJk, html code.shiki .sScJk{--shiki-default:#6F42C1;--shiki-dark:#B392F0}html pre.shiki code .sj4cs, html code.shiki .sj4cs{--shiki-default:#005CC5;--shiki-dark:#79B8FF}html .default .shiki span {color: var(--shiki-default);background: var(--shiki-default-bg);font-style: var(--shiki-default-font-style);font-weight: var(--shiki-default-font-weight);text-decoration: var(--shiki-default-text-decoration);}html .shiki span {color: var(--shiki-default);background: var(--shiki-default-bg);font-style: var(--shiki-default-font-style);font-weight: var(--shiki-default-font-weight);text-decoration: var(--shiki-default-text-decoration);}html .dark .shiki span {color: var(--shiki-dark);background: var(--shiki-dark-bg);font-style: var(--shiki-dark-font-style);font-weight: var(--shiki-dark-font-weight);text-decoration: var(--shiki-dark-text-decoration);}html.dark .shiki span {color: var(--shiki-dark);background: var(--shiki-dark-bg);font-style: var(--shiki-dark-font-style);font-weight: var(--shiki-dark-font-weight);text-decoration: var(--shiki-dark-text-decoration);}",{"title":48,"searchDepth":63,"depth":63,"links":358},[],"2024-02-01 00:00:01","前一阵子看到点墨的博客「定时备份mysql/mariadb数据库并上传至tgbot」，我意识到个人站点的数据库 dump 使用 TG Bot 存放是一个非常合适的做法。个人站点的数据库体积本身就不大，TG Bot 又有官方提供的 api，非常适合自动化任务。我就寻思着给我的 umami 数据库也写个定时任务备份一下，也不至于之前做一次迁移数据全部爆炸的悲剧重演。","md",{},"/2024/02/01/backup-umami-database-and-send-it-by-tg-bot","---\ntitle: 备份 umami 数据库，并使用 TG Bot 保存 dump 文件\ndate: 2024-02-01 00:00:01\nsticky:\ntags:\n- umami\n- Shell Script\n- Bot\n---\n\n前一阵子看到点墨的博客[「定时备份mysql/mariadb数据库并上传至tgbot」](https://blog.m-l.cc/2023/11/09/ding-shi-bei-fen-mysql-mariadb-shu-ju-ku-bing-shang-chuan-zhi-tgbot/)，我意识到个人站点的数据库 dump 使用 TG Bot 存放是一个非常合适的做法。个人站点的数据库体积本身就不大，TG Bot 又有官方提供的 api，非常适合自动化任务。我就寻思着给我的 umami 数据库也写个定时任务备份一下，也不至于之前做一次迁移数据全部爆炸的悲剧重演。\n\n我的 umami 是[「使用 vercel+supabase 免费部署 umami」](/2022/11/08/free-umami-deploy-plan/)部署出来的，数据库在 supabase 上，因此我们先打开 supabase 的 dashboard，获取到数据库的 url。\n\n![supabase 操作面板](https://static.031130.xyz/uploads/2024/08/12/65ba6aae157e6.webp)\n\n密码我自然是不记得了，不过好在 Firefox 的密码管理器帮我记住了，直接去设置里就能找到。即使密码忘了也不要紧，往下翻有重置密码的按钮。\n\n随后就要开始编写我们的教本了，这是我的\n\n```bash\n#!/bin/bash\n\nDATABASE_URL=\"postgres://\"\nDATE=$(date '+%F')\n\nTG_BOT_TOKEN='1145141919:ABCDEFGHIJKLVMNOPQRSTUVWXYZabcdefgh'\nTG_CHAT_ID='9191415411'\n\npg_dump ${DATABASE_URL} > umami_dump_${DATE}.sql\ncurl -F document=@umami_dump_${DATE}.sql https://api.telegram.org/bot${TG_BOT_TOKEN}/sendDocument?chat_id=${TG_CHAT_ID}\nrm umami_dump_${DATE}.sql\n```\n\n将这段代码保存为 `umami_db_dumper.sh`，随后 `chmod +x ./umami_db_dumper.sh` 授予可执行权限。\n\n可以先在命令行中执行命令试一下这段脚本是否正常工作\n\n```bash\n./umami_db_dumper.sh\n```\n\n这段代码在我本机正常工作，可惜在我的 Ubuntu VPS 上报错\n\n```\npg_dump: error: server version: 14.1; pg_dump version: 12.17 (Ubuntu 12.17-0ubuntu0.20.04.1)\npg_dump: error: aborting because of server version mismatch\n```\n\n看上去是 VPS 上的 PostgreSQL 版本过低，Google 搜索一顿后，我在一篇[「Upgrade pg_dump version in ubuntu | by Anushareddy」](https://devopsworld.medium.com/upgrade-pg-dump-version-in-ubuntu-545d691d4695) 文章中找到了方案，添加 PostgreSQL 官方提供的 apt 源将 VPS 上的 PostgreSQL 更新到新版即可解决。\n\n```bash\nwget --quiet -O - https://www.postgresql.org/media/keys/ACCC4CF8.asc | apt-key add -\necho \"deb http://apt.postgresql.org/pub/repos/apt/ $(lsb_release -cs)-pgdg main\" > /etc/apt/sources.list.d/pgdg.list\napt update\napt install postgresql-client\n```\n\n确保脚本正常工作后，使用 `crontab -e` 设置自动任务\n\n```bash\n0 2 * * * /root/umami_db_dumper.sh\n```\n\n![数据库备份](https://static.031130.xyz/uploads/2024/08/12/65c79455b2e40.webp)\n",{"title":5,"description":360},"posts/backup-umami-database-and-send-it-by-tg-bot",false,[369,370,371],"umami","Shell Script","Bot","VCJNktsd0BerrdfBAYd267RfCDqGPcqqF37qp9dJlMw",[374,379],{"title":375,"path":376,"stem":377,"date":378,"children":-1},"crontab 中简单的@语法糖","/2024/02/08/extra-usage-for-crontab","posts/extra-usage-for-crontab","2024-02-08 17:21:31",{"title":380,"path":381,"stem":382,"date":383,"children":-1},"在 JavaScript 中，箭头函数中的 this 指针到底指向哪里？","/2024/01/14/where-does-this-refer-in-arrow-function-in-js","posts/where-does-this-refer-in-arrow-function-in-js","2024-01-14 02:50:03",17,1761699628596]