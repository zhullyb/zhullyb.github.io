[{"data":1,"prerenderedAt":412},["ShallowReactive",2],{"post-2024-02-01-backup-umami-database-and-send-it-by-tg-bot":3,"surround-2024-02-01-backup-umami-database-and-send-it-by-tg-bot":401,"randomIndex/2024/02/01/backup-umami-database-and-send-it-by-tg-bot/":139},{"id":4,"title":5,"body":6,"date":387,"description":388,"extension":389,"meta":390,"navigation":66,"path":391,"rawbody":392,"seo":393,"stem":394,"sticky":395,"tags":396,"__hash__":400},"posts/posts/backup-umami-database-and-send-it-by-tg-bot.md","备份 umami 数据库，并使用 TG Bot 保存 dump 文件",{"type":7,"value":8,"toc":385},"minimark",[9,21,29,36,39,42,226,237,240,249,252,260,269,344,351,375,381],[10,11,12,13,20],"p",{},"前一阵子看到点墨的博客",[14,15,19],"a",{"href":16,"rel":17},"https://blog.m-l.cc/2023/11/09/ding-shi-bei-fen-mysql-mariadb-shu-ju-ku-bing-shang-chuan-zhi-tgbot/",[18],"nofollow","「定时备份mysql/mariadb数据库并上传至tgbot」","，我意识到个人站点的数据库 dump 使用 TG Bot 存放是一个非常合适的做法。个人站点的数据库体积本身就不大，TG Bot 又有官方提供的 api，非常适合自动化任务。我就寻思着给我的 umami 数据库也写个定时任务备份一下，也不至于之前做一次迁移数据全部爆炸的悲剧重演。",[10,22,23,24,28],{},"我的 umami 是",[14,25,27],{"href":26},"/2022/11/08/free-umami-deploy-plan/","「使用 vercel+supabase 免费部署 umami」","部署出来的，数据库在 supabase 上，因此我们先打开 supabase 的 dashboard，获取到数据库的 url。",[10,30,31],{},[32,33],"img",{"alt":34,"src":35},"supabase 操作面板","https://static.031130.xyz/uploads/2024/08/12/65ba6aae157e6.webp",[10,37,38],{},"密码我自然是不记得了，不过好在 Firefox 的密码管理器帮我记住了，直接去设置里就能找到。即使密码忘了也不要紧，往下翻有重置密码的按钮。",[10,40,41],{},"随后就要开始编写我们的教本了，这是我的",[43,44,49],"pre",{"className":45,"code":46,"language":47,"meta":48,"style":48},"language-bash shiki shiki-themes one-light one-dark-pro","#!/bin/bash\n\nDATABASE_URL=\"postgres://\"\nDATE=$(date '+%F')\n\nTG_BOT_TOKEN='1145141919:ABCDEFGHIJKLVMNOPQRSTUVWXYZabcdefgh'\nTG_CHAT_ID='9191415411'\n\npg_dump ${DATABASE_URL} > umami_dump_${DATE}.sql\ncurl -F document=@umami_dump_${DATE}.sql https://api.telegram.org/bot${TG_BOT_TOKEN}/sendDocument?chat_id=${TG_CHAT_ID}\nrm umami_dump_${DATE}.sql\n","bash","",[50,51,52,61,68,83,105,110,121,132,137,168,209],"code",{"__ignoreMap":48},[53,54,57],"span",{"class":55,"line":56},"line",1,[53,58,60],{"class":59},"sW2Sy","#!/bin/bash\n",[53,62,64],{"class":55,"line":63},2,[53,65,67],{"emptyLinePlaceholder":66},true,"\n",[53,69,71,75,79],{"class":55,"line":70},3,[53,72,74],{"class":73},"sJa8x","DATABASE_URL",[53,76,78],{"class":77},"sknuh","=",[53,80,82],{"class":81},"sDhpE","\"postgres://\"\n",[53,84,86,89,91,95,99,102],{"class":55,"line":85},4,[53,87,88],{"class":73},"DATE",[53,90,78],{"class":77},[53,92,94],{"class":93},"s5ixo","$(",[53,96,98],{"class":97},"sAdtL","date",[53,100,101],{"class":81}," '+%F'",[53,103,104],{"class":93},")\n",[53,106,108],{"class":55,"line":107},5,[53,109,67],{"emptyLinePlaceholder":66},[53,111,113,116,118],{"class":55,"line":112},6,[53,114,115],{"class":73},"TG_BOT_TOKEN",[53,117,78],{"class":77},[53,119,120],{"class":81},"'1145141919:ABCDEFGHIJKLVMNOPQRSTUVWXYZabcdefgh'\n",[53,122,124,127,129],{"class":55,"line":123},7,[53,125,126],{"class":73},"TG_CHAT_ID",[53,128,78],{"class":77},[53,130,131],{"class":81},"'9191415411'\n",[53,133,135],{"class":55,"line":134},8,[53,136,67],{"emptyLinePlaceholder":66},[53,138,140,143,147,149,152,155,158,161,163,165],{"class":55,"line":139},9,[53,141,142],{"class":97},"pg_dump",[53,144,146],{"class":145},"sr1Ac"," ${",[53,148,74],{"class":73},[53,150,151],{"class":145},"}",[53,153,154],{"class":93}," > ",[53,156,157],{"class":81},"umami_dump_",[53,159,160],{"class":145},"${",[53,162,88],{"class":73},[53,164,151],{"class":145},[53,166,167],{"class":81},".sql\n",[53,169,171,174,178,181,183,185,187,190,193,195,197,199,202,204,206],{"class":55,"line":170},10,[53,172,173],{"class":97},"curl",[53,175,177],{"class":176},"sAGMh"," -F",[53,179,180],{"class":81}," document=@umami_dump_",[53,182,160],{"class":145},[53,184,88],{"class":73},[53,186,151],{"class":145},[53,188,189],{"class":81},".sql",[53,191,192],{"class":81}," https://api.telegram.org/bot",[53,194,160],{"class":145},[53,196,115],{"class":73},[53,198,151],{"class":145},[53,200,201],{"class":81},"/sendDocument?chat_id=",[53,203,160],{"class":145},[53,205,126],{"class":73},[53,207,208],{"class":145},"}\n",[53,210,212,215,218,220,222,224],{"class":55,"line":211},11,[53,213,214],{"class":97},"rm",[53,216,217],{"class":81}," umami_dump_",[53,219,160],{"class":145},[53,221,88],{"class":73},[53,223,151],{"class":145},[53,225,167],{"class":81},[10,227,228,229,232,233,236],{},"将这段代码保存为 ",[50,230,231],{},"umami_db_dumper.sh","，随后 ",[50,234,235],{},"chmod +x ./umami_db_dumper.sh"," 授予可执行权限。",[10,238,239],{},"可以先在命令行中执行命令试一下这段脚本是否正常工作",[43,241,243],{"className":45,"code":242,"language":47,"meta":48,"style":48},"./umami_db_dumper.sh\n",[50,244,245],{"__ignoreMap":48},[53,246,247],{"class":55,"line":56},[53,248,242],{"class":97},[10,250,251],{},"这段代码在我本机正常工作，可惜在我的 Ubuntu VPS 上报错",[43,253,258],{"className":254,"code":256,"language":257},[255],"language-text","pg_dump: error: server version: 14.1; pg_dump version: 12.17 (Ubuntu 12.17-0ubuntu0.20.04.1)\npg_dump: error: aborting because of server version mismatch\n","text",[50,259,256],{"__ignoreMap":48},[10,261,262,263,268],{},"看上去是 VPS 上的 PostgreSQL 版本过低，Google 搜索一顿后，我在一篇",[14,264,267],{"href":265,"rel":266},"https://devopsworld.medium.com/upgrade-pg-dump-version-in-ubuntu-545d691d4695",[18],"「Upgrade pg_dump version in ubuntu | by Anushareddy」"," 文章中找到了方案，添加 PostgreSQL 官方提供的 apt 源将 VPS 上的 PostgreSQL 更新到新版即可解决。",[43,270,272],{"className":45,"code":271,"language":47,"meta":48,"style":48},"wget --quiet -O - https://www.postgresql.org/media/keys/ACCC4CF8.asc | apt-key add -\necho \"deb http://apt.postgresql.org/pub/repos/apt/ $(lsb_release -cs)-pgdg main\" > /etc/apt/sources.list.d/pgdg.list\napt update\napt install postgresql-client\n",[50,273,274,303,326,334],{"__ignoreMap":48},[53,275,276,279,282,285,288,291,294,297,300],{"class":55,"line":56},[53,277,278],{"class":97},"wget",[53,280,281],{"class":176}," --quiet",[53,283,284],{"class":176}," -O",[53,286,287],{"class":81}," -",[53,289,290],{"class":81}," https://www.postgresql.org/media/keys/ACCC4CF8.asc",[53,292,293],{"class":93}," | ",[53,295,296],{"class":97},"apt-key",[53,298,299],{"class":81}," add",[53,301,302],{"class":81}," -\n",[53,304,305,309,312,315,318,321,323],{"class":55,"line":63},[53,306,308],{"class":307},"s_Sar","echo",[53,310,311],{"class":81}," \"deb http://apt.postgresql.org/pub/repos/apt/ $(",[53,313,314],{"class":97},"lsb_release",[53,316,317],{"class":176}," -cs",[53,319,320],{"class":81},")-pgdg main\"",[53,322,154],{"class":93},[53,324,325],{"class":81},"/etc/apt/sources.list.d/pgdg.list\n",[53,327,328,331],{"class":55,"line":70},[53,329,330],{"class":97},"apt",[53,332,333],{"class":81}," update\n",[53,335,336,338,341],{"class":55,"line":85},[53,337,330],{"class":97},[53,339,340],{"class":81}," install",[53,342,343],{"class":81}," postgresql-client\n",[10,345,346,347,350],{},"确保脚本正常工作后，使用 ",[50,348,349],{},"crontab -e"," 设置自动任务",[43,352,354],{"className":45,"code":353,"language":47,"meta":48,"style":48},"0 2 * * * /root/umami_db_dumper.sh\n",[50,355,356],{"__ignoreMap":48},[53,357,358,361,364,368,370,372],{"class":55,"line":56},[53,359,360],{"class":97},"0",[53,362,363],{"class":176}," 2",[53,365,367],{"class":366},"s2QsP"," *",[53,369,367],{"class":366},[53,371,367],{"class":366},[53,373,374],{"class":81}," /root/umami_db_dumper.sh\n",[10,376,377],{},[32,378],{"alt":379,"src":380},"数据库备份","https://static.031130.xyz/uploads/2024/08/12/65c79455b2e40.webp",[382,383,384],"style",{},"html pre.shiki code .sW2Sy, html code.shiki .sW2Sy{--shiki-default:#A0A1A7;--shiki-default-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic}html pre.shiki code .sJa8x, html code.shiki .sJa8x{--shiki-default:#E45649;--shiki-dark:#E06C75}html pre.shiki code .sknuh, html code.shiki .sknuh{--shiki-default:#383A42;--shiki-dark:#56B6C2}html pre.shiki code .sDhpE, html code.shiki .sDhpE{--shiki-default:#50A14F;--shiki-dark:#98C379}html pre.shiki code .s5ixo, html code.shiki .s5ixo{--shiki-default:#383A42;--shiki-dark:#ABB2BF}html pre.shiki code .sAdtL, html code.shiki .sAdtL{--shiki-default:#4078F2;--shiki-dark:#61AFEF}html pre.shiki code .sr1Ac, html code.shiki .sr1Ac{--shiki-default:#E45649;--shiki-dark:#ABB2BF}html pre.shiki code .sAGMh, html code.shiki .sAGMh{--shiki-default:#986801;--shiki-dark:#D19A66}html .default .shiki span {color: var(--shiki-default);background: var(--shiki-default-bg);font-style: var(--shiki-default-font-style);font-weight: var(--shiki-default-font-weight);text-decoration: var(--shiki-default-text-decoration);}html .shiki span {color: var(--shiki-default);background: var(--shiki-default-bg);font-style: var(--shiki-default-font-style);font-weight: var(--shiki-default-font-weight);text-decoration: var(--shiki-default-text-decoration);}html .dark .shiki span {color: var(--shiki-dark);background: var(--shiki-dark-bg);font-style: var(--shiki-dark-font-style);font-weight: var(--shiki-dark-font-weight);text-decoration: var(--shiki-dark-text-decoration);}html.dark .shiki span {color: var(--shiki-dark);background: var(--shiki-dark-bg);font-style: var(--shiki-dark-font-style);font-weight: var(--shiki-dark-font-weight);text-decoration: var(--shiki-dark-text-decoration);}html pre.shiki code .s_Sar, html code.shiki .s_Sar{--shiki-default:#0184BC;--shiki-dark:#56B6C2}html pre.shiki code .s2QsP, html code.shiki .s2QsP{--shiki-default:#E45649;--shiki-dark:#E5C07B}",{"title":48,"searchDepth":63,"depth":63,"links":386},[],"2024-02-01 00:00:01","前一阵子看到点墨的博客「定时备份mysql/mariadb数据库并上传至tgbot」，我意识到个人站点的数据库 dump 使用 TG Bot 存放是一个非常合适的做法。个人站点的数据库体积本身就不大，TG Bot 又有官方提供的 api，非常适合自动化任务。我就寻思着给我的 umami 数据库也写个定时任务备份一下，也不至于之前做一次迁移数据全部爆炸的悲剧重演。","md",{},"/2024/02/01/backup-umami-database-and-send-it-by-tg-bot","---\ntitle: 备份 umami 数据库，并使用 TG Bot 保存 dump 文件\ndate: 2024-02-01 00:00:01\nsticky:\ntags:\n- umami\n- Shell Script\n- Bot\n---\n\n前一阵子看到点墨的博客[「定时备份mysql/mariadb数据库并上传至tgbot」](https://blog.m-l.cc/2023/11/09/ding-shi-bei-fen-mysql-mariadb-shu-ju-ku-bing-shang-chuan-zhi-tgbot/)，我意识到个人站点的数据库 dump 使用 TG Bot 存放是一个非常合适的做法。个人站点的数据库体积本身就不大，TG Bot 又有官方提供的 api，非常适合自动化任务。我就寻思着给我的 umami 数据库也写个定时任务备份一下，也不至于之前做一次迁移数据全部爆炸的悲剧重演。\n\n我的 umami 是[「使用 vercel+supabase 免费部署 umami」](/2022/11/08/free-umami-deploy-plan/)部署出来的，数据库在 supabase 上，因此我们先打开 supabase 的 dashboard，获取到数据库的 url。\n\n![supabase 操作面板](https://static.031130.xyz/uploads/2024/08/12/65ba6aae157e6.webp)\n\n密码我自然是不记得了，不过好在 Firefox 的密码管理器帮我记住了，直接去设置里就能找到。即使密码忘了也不要紧，往下翻有重置密码的按钮。\n\n随后就要开始编写我们的教本了，这是我的\n\n```bash\n#!/bin/bash\n\nDATABASE_URL=\"postgres://\"\nDATE=$(date '+%F')\n\nTG_BOT_TOKEN='1145141919:ABCDEFGHIJKLVMNOPQRSTUVWXYZabcdefgh'\nTG_CHAT_ID='9191415411'\n\npg_dump ${DATABASE_URL} > umami_dump_${DATE}.sql\ncurl -F document=@umami_dump_${DATE}.sql https://api.telegram.org/bot${TG_BOT_TOKEN}/sendDocument?chat_id=${TG_CHAT_ID}\nrm umami_dump_${DATE}.sql\n```\n\n将这段代码保存为 `umami_db_dumper.sh`，随后 `chmod +x ./umami_db_dumper.sh` 授予可执行权限。\n\n可以先在命令行中执行命令试一下这段脚本是否正常工作\n\n```bash\n./umami_db_dumper.sh\n```\n\n这段代码在我本机正常工作，可惜在我的 Ubuntu VPS 上报错\n\n```\npg_dump: error: server version: 14.1; pg_dump version: 12.17 (Ubuntu 12.17-0ubuntu0.20.04.1)\npg_dump: error: aborting because of server version mismatch\n```\n\n看上去是 VPS 上的 PostgreSQL 版本过低，Google 搜索一顿后，我在一篇[「Upgrade pg_dump version in ubuntu | by Anushareddy」](https://devopsworld.medium.com/upgrade-pg-dump-version-in-ubuntu-545d691d4695) 文章中找到了方案，添加 PostgreSQL 官方提供的 apt 源将 VPS 上的 PostgreSQL 更新到新版即可解决。\n\n```bash\nwget --quiet -O - https://www.postgresql.org/media/keys/ACCC4CF8.asc | apt-key add -\necho \"deb http://apt.postgresql.org/pub/repos/apt/ $(lsb_release -cs)-pgdg main\" > /etc/apt/sources.list.d/pgdg.list\napt update\napt install postgresql-client\n```\n\n确保脚本正常工作后，使用 `crontab -e` 设置自动任务\n\n```bash\n0 2 * * * /root/umami_db_dumper.sh\n```\n\n![数据库备份](https://static.031130.xyz/uploads/2024/08/12/65c79455b2e40.webp)\n",{"title":5,"description":388},"posts/backup-umami-database-and-send-it-by-tg-bot",false,[397,398,399],"umami","Shell Script","Bot","EKGHOg436a16oeJcBJLof1y4abPy6sOXgxQ-mS5TZnU",[402,407],{"title":403,"path":404,"stem":405,"date":406,"children":-1},"crontab 中简单的@语法糖","/2024/02/08/extra-usage-for-crontab","posts/extra-usage-for-crontab","2024-02-08 17:21:31",{"title":408,"path":409,"stem":410,"date":411,"children":-1},"在 JavaScript 中，箭头函数中的 this 指针到底指向哪里？","/2024/01/14/where-does-this-refer-in-arrow-function-in-js","posts/where-does-this-refer-in-arrow-function-in-js","2024-01-14 02:50:03",1761836960406]