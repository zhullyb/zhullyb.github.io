[{"data":1,"prerenderedAt":308},["ShallowReactive",2],{"post-2024-02-29-capture-https-traffic-on-linux-with-mitmproxy-zh":3,"surround-2024-02-29-capture-https-traffic-on-linux-with-mitmproxy-zh":295,"randomIndex/2024/02/29/capture-https-traffic-on-linux-with-mitmproxy/":288,"language-switch-/2024/02/29/capture-https-traffic-on-linux-with-mitmproxy/-en":307},{"title":4,"date":5,"path":6,"tags":7,"body":12,"description":18},"在 Linux 下使用 mitmproxy 抓取 HTTPS 流量","2024-02-29 22:03:58","/2024/02/29/capture-https-traffic-on-linux-with-mitmproxy",[8,9,10,11],"Linux","Archlinux","Network","mitmproxy",{"type":13,"value":14,"toc":287},"minimark",[15,19,22,27,35,64,68,71,83,93,100,110,115,119,122,129,137,148,155,175,184,206,211,223,226,230,233,240,246,255,258,264,267,270,280,283],[16,17,18],"p",{},"作为部分 AUR Package 的 maintainer，一直以来我都有在 Linux 下抓取 https 流量的需求，比如抓取应用内的更新检测时访问的 url 地址。之前一直没有空去研究，趁着最近课少，总算是完成了这个目标。",[16,20,21],{},"在这里我使用的 mitmproxy，基于 python 和 webui 的一款开源简洁的流量代理软件，可以用于抓取 https 流量信息。",[23,24,26],"h2",{"id":25},"安装-mitmproxy","安装 mitmproxy",[16,28,29,30,34],{},"在 Arch Linux 下，官方 ",[31,32,33],"code",{},"extra"," 源中已经打包好了这款软件，直接使用下面的命令即可完成安装。",[36,37,42],"pre",{"className":38,"code":39,"language":40,"meta":41,"style":41},"language-bash shiki shiki-themes one-light one-dark-pro","sudo pacman -S mitmproxy\n","bash","",[31,43,44],{"__ignoreMap":41},[45,46,49,53,57,61],"span",{"class":47,"line":48},"line",1,[45,50,52],{"class":51},"sAdtL","sudo",[45,54,56],{"class":55},"sDhpE"," pacman",[45,58,60],{"class":59},"sAGMh"," -S",[45,62,63],{"class":55}," mitmproxy\n",[23,65,67],{"id":66},"尝试运行-mitmweb","尝试运行 mitmweb",[16,69,70],{},"安装完成后，我们将会获得三个新的命令可用：",[72,73,74,78,80],"ul",{},[75,76,77],"li",{},"mitmdump",[75,79,11],{},[75,81,82],{},"mitmweb",[16,84,85,86,92],{},"我们只要使用 mitmweb 即可同时打开 8080 的代理端口和 8081 端口的 webui。访问 ",[87,88,89],"a",{"href":89,"rel":90},"http://127.0.0.1:8081",[91],"nofollow"," 即可看到 mitmproxy 的网页。",[16,94,95],{},[96,97],"img",{"alt":98,"src":99},"mitmweb 的界面","https://static.031130.xyz/uploads/2024/08/12/65e092503d5bb.webp",[16,101,102,103],{},"当然，也可以在 mitmweb 命令后面追加 -p ",[104,105,106,107],"port",{}," 和 --web-port=",[104,108,109],{}," 分别设置代理端口和 webui 的端口。",[16,111,112,113],{},"首先，我们先运行一次 ",[31,114,82],{},[23,116,118],{"id":117},"安装-ca-证书","安装 ca 证书",[16,120,121],{},"为了解密 https 流量，我们需要为系统安装上 mitmproxy 自己的证书文件，让系统信任我们的证书。",[16,123,124,125,128],{},"先来看看 ",[31,126,127],{},"/usr/share/ca-certificates/trust-source/README"," 这个文件",[36,130,135],{"className":131,"code":133,"language":134},[132],"language-text","This directory /usr/share/ca-certificates/trust-source/ contains CA certificates\nand trust settings in the PEM file format. The trust settings found here will be\ninterpreted with a low priority - lower than the ones found in \n/etc/ca-certificates/trust-source/ .\n\n=============================================================================\nQUICK HELP: To add a certificate in the simple PEM or DER file formats to the\n            list of CAs trusted on the system:\n\n            Copy it to the\n                    /usr/share/ca-certificates/trust-source/anchors/\n            subdirectory, and run the\n                    update-ca-trust\n            command.\n\n            If your certificate is in the extended BEGIN TRUSTED file format,\n            then place it into the main trust-source/ directory instead.\n=============================================================================\n\nPlease refer to the update-ca-trust(8) manual page for additional information.\n","text",[31,136,133],{"__ignoreMap":41},[16,138,139,140,143,144,147],{},"这份文件告诉我们可以在 ",[31,141,142],{},"/usr/share/ca-certificates/trust-source/anchors/"," 路径下放置 PEM 证书文件，并使用 ",[31,145,146],{},"update-ca-trust"," 命令更新系统的信任。",[16,149,150,151,154],{},"mitmproxy 软件第一次运行时，将会在当前用户的 ",[31,152,153],{},"$HOME/.mitmproxy/"," 文件夹下生成证书，我们打开这个文件夹，发现一共有六个文件：",[72,156,157,160,163,166,169,172],{},[75,158,159],{},"mitmproxy-ca-cert.cer",[75,161,162],{},"mitmproxy-ca-cert.p12",[75,164,165],{},"mitmproxy-ca-cert.pem",[75,167,168],{},"mitmproxy-ca.p12",[75,170,171],{},"mitmproxy-ca.pem",[75,173,174],{},"mitmproxy-dhparam.pem",[16,176,177,178,180,181,183],{},"我们这里需要将 ",[31,179,165],{}," 文件复制到 ",[31,182,142],{}," 路径下",[36,185,187],{"className":38,"code":186,"language":40,"meta":41,"style":41},"sudo cp $HOME/.mitmproxy/mitmproxy-ca-cert.pem /usr/share/ca-certificates/trust-source/anchors/\n",[31,188,189],{"__ignoreMap":41},[45,190,191,193,196,200,203],{"class":47,"line":48},[45,192,52],{"class":51},[45,194,195],{"class":55}," cp",[45,197,199],{"class":198},"sJa8x"," $HOME",[45,201,202],{"class":55},"/.mitmproxy/mitmproxy-ca-cert.pem",[45,204,205],{"class":55}," /usr/share/ca-certificates/trust-source/anchors/\n",[16,207,208,209],{},"随后执行 ",[31,210,146],{},[36,212,214],{"className":38,"code":213,"language":40,"meta":41,"style":41},"sudo update-ca-trust\n",[31,215,216],{"__ignoreMap":41},[45,217,218,220],{"class":47,"line":48},[45,219,52],{"class":51},[45,221,222],{"class":55}," update-ca-trust\n",[16,224,225],{},"这样便完成了 ca 证书的安装",[23,227,229],{"id":228},"使目标软件使用-8080-端口通信","使目标软件使用 8080 端口通信",[16,231,232],{},"其实我试过使用透明代理进行抓包，只不过我的 Archlinux 是作为日常主力机使用的，系统无时无刻不在向外通信，透明代理以后 mitmproxy 的 webui 各种刷屏，便放弃了这个想法，选择指定目标软件使用 8080 端口通信。",[16,234,235,236,239],{},"网上比较常见的做法是使用 ",[31,237,238],{},"proxychains-ng"," 代理目标软件。这个方案是可行的，只不过我这边测试下来，部分软件使用 proxychains 代理以后出现了仍然不使用代理、无法联网、甚至直接崩溃的情况。",[16,241,242],{},[96,243],{"alt":244,"src":245},"程序崩溃","https://static.031130.xyz/uploads/2024/08/12/65e09559dceef.webp",[16,247,248,249,254],{},"因此我转向了 ",[87,250,253],{"href":251,"rel":252},"https://github.com/mzz2017/gg",[91],"gg","。gg 和 proxychains-ng 的定位相同，都是使目标命令通过指定的代理进行通信，只不过 gg 解决了部分 golang 编写的软件无法被 proxychains 代理的问题，并支持一些常见的用来国际联网的协议。",[16,256,257],{},"在不对 gg 进行配置的情况下，每次启动时，gg 都会要求我们输入代理地址，这正合我意。",[16,259,260],{},[96,261],{"alt":262,"src":263},"gg 要求输入代理地址","https://static.031130.xyz/uploads/2024/08/12/65e0963840449.webp",[16,265,266],{},"此时，软件正常启动，流量全部经过 mitmproxy，可以在 webui 上看到具体情况",[23,268,269],{"id":269},"抓包成功",[16,271,272,276],{},[96,273],{"alt":274,"src":275},"命令行下看到流量信息","https://static.031130.xyz/uploads/2024/08/12/65e097dfe1f17.webp",[96,277],{"alt":278,"src":279},"mitmweb 正常获取解密后的流量信息","https://static.031130.xyz/uploads/2024/08/12/65e09780dd2c0.webp",[16,281,282],{},"我们可以看到 mitmproxy 成功捕获并解密的 https 流量，针对图片等信息甚至可以直接实现预览。",[284,285,286],"style",{},"html pre.shiki code .sAdtL, html code.shiki .sAdtL{--shiki-default:#4078F2;--shiki-dark:#61AFEF}html pre.shiki code .sDhpE, html code.shiki .sDhpE{--shiki-default:#50A14F;--shiki-dark:#98C379}html pre.shiki code .sAGMh, html code.shiki .sAGMh{--shiki-default:#986801;--shiki-dark:#D19A66}html .default .shiki span {color: var(--shiki-default);background: var(--shiki-default-bg);font-style: var(--shiki-default-font-style);font-weight: var(--shiki-default-font-weight);text-decoration: var(--shiki-default-text-decoration);}html .shiki span {color: var(--shiki-default);background: var(--shiki-default-bg);font-style: var(--shiki-default-font-style);font-weight: var(--shiki-default-font-weight);text-decoration: var(--shiki-default-text-decoration);}html .dark .shiki span {color: var(--shiki-dark);background: var(--shiki-dark-bg);font-style: var(--shiki-dark-font-style);font-weight: var(--shiki-dark-font-weight);text-decoration: var(--shiki-dark-text-decoration);}html.dark .shiki span {color: var(--shiki-dark);background: var(--shiki-dark-bg);font-style: var(--shiki-dark-font-style);font-weight: var(--shiki-dark-font-weight);text-decoration: var(--shiki-dark-text-decoration);}html pre.shiki code .sJa8x, html code.shiki .sJa8x{--shiki-default:#E45649;--shiki-dark:#E06C75}",{"title":41,"searchDepth":288,"depth":288,"links":289},2,[290,291,292,293,294],{"id":25,"depth":288,"text":26},{"id":66,"depth":288,"text":67},{"id":117,"depth":288,"text":118},{"id":228,"depth":288,"text":229},{"id":269,"depth":288,"text":269},[296,302],{"title":297,"path":298,"stem":299,"date":300,"lang":301,"children":-1},"小记 - 尝试拼凑出 apt 仓库中的 deb 包下载地址","/2024/03/13/try-to-compose-download-links-of-deb-packages-in-apt-repository","posts/zh/try-to-compose-download-links-of-deb-packages-in-apt-repository","2024-03-13 21:55:04","zh-CN",{"title":303,"path":304,"stem":305,"date":306,"lang":301,"children":-1},"如何使用 docker 部署 onemanager","/2024/02/11/how-to-deploy-onemanager-with-docker","posts/zh/how-to-deploy-onemanager-with-docker","2024-02-11 16:30:29",null,1765307311836]