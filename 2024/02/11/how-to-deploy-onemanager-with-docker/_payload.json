[{"data":1,"prerenderedAt":307},["ShallowReactive",2],{"post-2024-02-11-how-to-deploy-onemanager-with-docker-zh":3,"surround-2024-02-11-how-to-deploy-onemanager-with-docker-zh":293,"randomIndex/2024/02/11/how-to-deploy-onemanager-with-docker/":305,"language-switch-/2024/02/11/how-to-deploy-onemanager-with-docker/-en":306},{"title":4,"date":5,"path":6,"tags":7,"body":12,"description":158},"如何使用 docker 部署 onemanager","2024-02-11 16:30:29","/2024/02/11/how-to-deploy-onemanager-with-docker",[8,9,10,11],"PHP","OneDrive","OpenSource Project","Docker",{"type":13,"value":14,"toc":283},"minimark",[15,18,22,32,34,43,48,79,83,98,101,105,130,137,143,152,168,184,193,202,205,208,218,242,246,276,279],[16,17],"hr",{},[19,20,21],"h2",{"id":21},"部署方法",[23,24,25,26],"p",{},"如果你只是想找一个 OneManager-php 的 Docker 部署方法，直接看 ",[27,28,29],"a",{"href":29,"rel":30},"https://github.com/zhullyb/OneManager-php-docker",[31],"nofollow",[16,33],{},[23,35,36,37,42],{},"一直以来，我都是 ",[27,38,41],{"href":39,"rel":40},"https://github.com/qkqpttgf/OneManager-php",[31],"OneManager-php"," 的忠实用户。这些年来，尽管有 alist 这种 UI 好看，多种网盘高度聚合的项目逐渐取代了 onemanager 的生态位，但 onemanager 支持文件分片上传、上传流量不经服务器的特点还是让我非常满意。前一阵子，glitch 暂停了针对项目自定义域名的支持，因此在我手贱地取消了项目原本绑定的域名后，迫切地需要寻找一个新的部署的平台，只不过 onemanager 项目现在列出的方案都不太让我满意，因此我就萌生出了在 vps 上自己部署的想法。",[44,45,47],"h3",{"id":46},"docker-镜像选用","Docker 镜像选用",[23,49,50,51,55,56,61,62,66,67,70,71,74,75,78],{},"vps 上自己部署 php 项目，最简单的方法是使用 Docker，",[52,53,54],"del",{},"使用 Docker 就可以免去配置 nginx 或者同类产品的 php-fpm 配置","才怪。我打开 Docker 提供的 ",[27,57,60],{"href":58,"rel":59},"https://hub.docker.com/_/php",[31],"php 官方镜像","，最小的镜像是带",[63,64,65],"code",{},"-cli","后缀的，这个镜像就不适合进行部署，php 内置的开发服务器是单线程的，当同时打开两个网页访问开发服务器的时候，其中一个网页就会卡住；以",[63,68,69],{},"-fpm","结尾的镜像变体很明显，仍然需要去 nginx 或同类产品的配置文件那边去配置 fpm，这给部署了好几次 php 项目的我带来的心理阴影；剩下一个就是",[63,72,73],{},"-apache","后缀、使用 apache server 提供 php 服务的镜像，体积虽然大了点，但好在操作简单，只需要将 php 文件放进 ",[63,76,77],{},"/var/www/html","，启用 php 的相关拓展，启用 apache 的相关功能即可。",[19,80,82],{"id":81},"php-拓展","php 拓展",[23,84,85,86,89,90,93,94,97],{},"php 的拓展可以使用镜像自带的 ",[63,87,88],{},"docker-php-ext-install"," 和 ",[63,91,92],{},"docker-php-ext-enable"," 命令进行操作，此外还有一个 ",[63,95,96],{},"docker-php-ext-configure"," 命令可以配置相关的拓展，不过我并不是 php 开发者，不熟悉拓展有什么好配置的。",[23,99,100],{},"OneManager-php 没有依赖任何的 php 拓展，因此这个步骤可以直接跳过。",[19,102,104],{"id":103},"apache-server-配置","Apache Server 配置",[23,106,107,108,111,112,111,115,111,118,111,121,111,124,111,127,129],{},"和 php 拓展一样，镜像内也提供了几个命令进行 Apache Server 的配置，分别为 ",[63,109,110],{},"a2disconf","、",[63,113,114],{},"a2dismod",[63,116,117],{},"a2dissite",[63,119,120],{},"a2enconf",[63,122,123],{},"a2enmod",[63,125,126],{},"a2ensite",[63,128,126],{},"。",[23,131,132,133,136],{},"OneManager-php 在部署的时候依赖于 Apache Server 的 rewrite 的模块，因此在 Dockerfile 中需要使用 ",[63,134,135],{},"a2enmod rewrite"," 开启 rewrite 支持。至于别的 Apache Server 配置，都可以通过项目中的 .htaccess 文件进行配置。",[19,138,140],{"id":139},"htaccess-文件纠错",[52,141,142],{},".htaccess 文件纠错",[23,144,145],{},[52,146,147,148,151],{},"在 OneManager-php 仓库中，",[63,149,150],{},".htaccess"," 文件有一些小问题。",[153,154,159],"pre",{"className":155,"code":156,"language":157,"meta":158,"style":158},"language-htaccess shiki shiki-themes one-light one-dark-pro","RewriteRule ^(.*) index.php?/$1 [L]\n","htaccess","",[63,160,161],{"__ignoreMap":158},[162,163,166],"span",{"class":164,"line":165},"line",1,[162,167,156],{},[23,169,170],{},[52,171,172,173,176,177,111,180,183],{},"这行配置原本是将访问的路径追加到 ",[63,174,175],{},"index.php?/"," 后面的意思，但 一旦路径中出现了 ",[63,178,179],{},"[",[63,181,182],{},"]"," 或者空格等字符时，会触发 Apache 自带的保护，因此我们将这行改成下面这个样子即可。",[153,185,187],{"className":155,"code":186,"language":157,"meta":158,"style":158},"RewriteRule ^(.*) index.php [QSA,L]\n",[63,188,189],{"__ignoreMap":158},[162,190,191],{"class":164,"line":165},[162,192,186],{},[23,194,195,196,201],{},"原项目合并了",[27,197,200],{"href":198,"rel":199},"https://github.com/qkqpttgf/OneManager-php/pull/716",[31],"我的 PR","，因此这一过程不再需要。",[19,203,204],{"id":204},"处理文件权限问题",[23,206,207],{},"OneManager-php 在运行过程中，会有针对配置文件的读写操作，此外还内置了一键更新的功能，因此会对路径内的文件进行读写，我们需要确保 php 在运行过程中有权限对这些文件进行读写。",[23,209,210,211,213,214,217],{},"可以直接将 ",[63,212,77],{}," 路径的所有权转给 ",[63,215,216],{},"www-data"," 用户。",[153,219,223],{"className":220,"code":221,"language":222,"meta":158,"style":158},"language-bash shiki shiki-themes one-light one-dark-pro","chown -R www-data:www-data /var/www/html\n","bash",[63,224,225],{"__ignoreMap":158},[162,226,227,231,235,239],{"class":164,"line":165},[162,228,230],{"class":229},"sAdtL","chown",[162,232,234],{"class":233},"sAGMh"," -R",[162,236,238],{"class":237},"sDhpE"," www-data:www-data",[162,240,241],{"class":237}," /var/www/html\n",[19,243,245],{"id":244},"最终的-dockerfile","最终的 Dockerfile",[153,247,251],{"className":248,"code":249,"language":250,"meta":158,"style":158},"language-dockerfile shiki shiki-themes one-light one-dark-pro","FROM php:8-apache\nRUN a2enmod rewrite\nCOPY OneManager-php /var/www/html\nRUN chown -R www-data:www-data /var/www/html\n","dockerfile",[63,252,253,258,264,270],{"__ignoreMap":158},[162,254,255],{"class":164,"line":165},[162,256,257],{},"FROM php:8-apache\n",[162,259,261],{"class":164,"line":260},2,[162,262,263],{},"RUN a2enmod rewrite\n",[162,265,267],{"class":164,"line":266},3,[162,268,269],{},"COPY OneManager-php /var/www/html\n",[162,271,273],{"class":164,"line":272},4,[162,274,275],{},"RUN chown -R www-data:www-data /var/www/html\n",[23,277,278],{},"其实一共就 4 行，还是挺简单的。",[280,281,282],"style",{},"html .default .shiki span {color: var(--shiki-default);background: var(--shiki-default-bg);font-style: var(--shiki-default-font-style);font-weight: var(--shiki-default-font-weight);text-decoration: var(--shiki-default-text-decoration);}html .shiki span {color: var(--shiki-default);background: var(--shiki-default-bg);font-style: var(--shiki-default-font-style);font-weight: var(--shiki-default-font-weight);text-decoration: var(--shiki-default-text-decoration);}html .dark .shiki span {color: var(--shiki-dark);background: var(--shiki-dark-bg);font-style: var(--shiki-dark-font-style);font-weight: var(--shiki-dark-font-weight);text-decoration: var(--shiki-dark-text-decoration);}html.dark .shiki span {color: var(--shiki-dark);background: var(--shiki-dark-bg);font-style: var(--shiki-dark-font-style);font-weight: var(--shiki-dark-font-weight);text-decoration: var(--shiki-dark-text-decoration);}html pre.shiki code .sAdtL, html code.shiki .sAdtL{--shiki-default:#4078F2;--shiki-dark:#61AFEF}html pre.shiki code .sAGMh, html code.shiki .sAGMh{--shiki-default:#986801;--shiki-dark:#D19A66}html pre.shiki code .sDhpE, html code.shiki .sDhpE{--shiki-default:#50A14F;--shiki-dark:#98C379}",{"title":158,"searchDepth":260,"depth":260,"links":284},[285,288,289,290,291,292],{"id":21,"depth":260,"text":21,"children":286},[287],{"id":46,"depth":266,"text":47},{"id":81,"depth":260,"text":82},{"id":103,"depth":260,"text":104},{"id":139,"depth":260,"text":142},{"id":204,"depth":260,"text":204},{"id":244,"depth":260,"text":245},[294,300],{"title":295,"path":296,"stem":297,"date":298,"lang":299,"children":-1},"在 Linux 下使用 mitmproxy 抓取 HTTPS 流量","/2024/02/29/capture-https-traffic-on-linux-with-mitmproxy","posts/zh/capture-https-traffic-on-linux-with-mitmproxy","2024-02-29 22:03:58","zh-CN",{"title":301,"path":302,"stem":303,"date":304,"lang":299,"children":-1},"crontab 中简单的@语法糖","/2024/02/08/extra-usage-for-crontab","posts/zh/extra-usage-for-crontab","2024-02-08 17:21:31",10,null,1766566739420]