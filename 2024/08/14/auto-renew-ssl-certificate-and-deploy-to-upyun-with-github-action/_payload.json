[{"data":1,"prerenderedAt":626},["ShallowReactive",2],{"post-2024-08-14-auto-renew-ssl-certificate-and-deploy-to-upyun-with-github-action-zh":3,"surround-2024-08-14-auto-renew-ssl-certificate-and-deploy-to-upyun-with-github-action-zh":613,"randomIndex/2024/08/14/auto-renew-ssl-certificate-and-deploy-to-upyun-with-github-action/":144,"language-switch-/2024/08/14/auto-renew-ssl-certificate-and-deploy-to-upyun-with-github-action/-en":625},{"title":4,"date":5,"path":6,"tags":7,"body":15,"description":117},"自建图床小记三—— SSL 证书的自动更新与部署","2024-08-14 10:35:18","/2024/08/14/auto-renew-ssl-certificate-and-deploy-to-upyun-with-github-action",[8,9,10,11,12,13,14],"Bot","CDN","Github Action","Network","Linux","SSL","Image Hosting",{"type":16,"value":17,"toc":601},"minimark",[18,23,27,30,34,38,41,48,51,54,60,63,67,70,81,84,87,93,99,102,108,111,166,169,177,183,187,196,203,208,249,253,284,288,318,322,375,378,407,411,450,453,462,563,569,572,597],[19,20,22],"h2",{"id":21},"为什么要自动更新","为什么要自动更新？",[24,25,26],"p",{},"众所周知，为站点开启 https 访问需要获得对应 host 的 ssl 证书，而如果希望证书被访客的浏览器所信任，需要拿到由 Certificate Authority (CA) 签发的 ssl 证书。在前一阵子那波 BAT 等大厂提供的云服务停止发放免费的由 TrustAsia/DigiCert 签发的一年有效期免费 ssl 证书之后，市面上已经没有被广泛信任的 CA 签发的免费的一年有效期的 ssl 证书了，于是不得不用回由 Let's Encrypt/ZeroSSL 等 CA 签发三个月免费证书。",[24,28,29],{},"但话又说回来，三个月有效期确实不太够，一年有效期的证书就一年一更，手动申请部署也不麻烦；三个月有效期的证书手动就有点麻烦了——我一般会在证书到期的前 15 天进行更新，防止最后几天自己太忙了没时间管。",[19,31,33],{"id":32},"这套图床架构的自动更新有没有困难","这套图床架构的自动更新有没有困难？",[35,36,37],"h3",{"id":37},"境外",[24,39,40],{},"通过 Cloudflare SaaS 接入的域名通过验证后会自动获得由 Cloudflare 提供的由 Google Trust Services 签发的证书，不需要我们操心。",[24,42,43],{},[44,45],"img",{"alt":46,"src":47},"SSL Certificate provided by Cloudflare","https://static.031130.xyz/uploads/2024/08/14/831d714565906.webp",[35,49,50],{"id":50},"境内",[24,52,53],{},"咱选用的又拍云 CDN 提供了免费的 Let's Encrypt 证书及其自动续期服务，但需要我们把图床访问域名的 DNS CNAME 解析到他们家。",[24,55,56],{},[44,57],{"alt":58,"src":59},"SSL Certificate provided by upyun","https://static.031130.xyz/uploads/2024/08/14/b16f7752ef522.webp",[24,61,62],{},"这里有个问题，我们这套图床架构在境外的解析是解析到 Cloudflare 的，不可能通过 Let's Encrypt 的 acme challenge。如果使用 upyun 申请 ssl 证书，则意味着每次更新都要我们手动将境外的 dns 解析记录暂时解析到又拍云，待证书更新成功后再解析回 Cloudflare，非常麻烦。",[19,64,66],{"id":65},"使用-github-action-跑-acmesh-获取-ssl-证书","使用 Github Action 跑 acme.sh 获取 ssl 证书",[24,68,69],{},"本着「能使用长期免费稳定服务就使用长期免费稳定服务」的思想，决定使用 Github Action 申请 ssl 证书。",[24,71,72,73,80],{},"在 Github Action 跑 acme.sh 获取 ssl 证书意味着不能使用 http 文件检验的方式检验域名所有权，需要使用 dns 检验。截至本文写作时间，acme.sh 已经支持了 150+ 个主流的 DNS 解析商（Managed DNS providers）的 api，针对不支持 api 修改 dns 解析记录的，还可以使用 ",[74,75,79],"a",{"href":76,"rel":77},"https://github.com/acmesh-official/acme.sh/wiki/DNS-alias-mode",[78],"nofollow","DNS alias 模式","——即将需要申请 ssl 证书的域名先 cname 到一个工具人域名上，将工具人域名通过 NS 解析到 acme.sh 支持的 DNS 解析商，进而实现 CA 对域名所有权的验证。",[35,82,83],{"id":83},"先在本地跑起来",[24,85,86],{},"我采用的是 Cloudflare，直接在个人资料页创建一个具有编辑 DNS 权限的 API 令牌",[24,88,89],{},[44,90],{"alt":91,"src":92},"创建令牌","https://static.031130.xyz/uploads/2024/08/14/c0262d4aea708.webp",[24,94,95],{},[44,96],{"alt":97,"src":98},"获得令牌","https://static.031130.xyz/uploads/2024/08/14/f30bfc93970bc.webp",[24,100,101],{},"随后在自己的域名页面，找到区域 ID 和 账户 ID",[24,103,104],{},[44,105],{"alt":106,"src":107},"区域 ID 和 账户 ID","https://static.031130.xyz/uploads/2024/08/14/4c8d4a2019812.webp",[24,109,110],{},"在自己的本机安装 acme.sh,设置好 Cloudflare DNS 的几个变量",[112,113,118],"pre",{"className":114,"code":115,"language":116,"meta":117,"style":117},"language-bash shiki shiki-themes one-light one-dark-pro","export CF_Token=\"\"\nexport CF_Account_ID=\"\"\nexport CF_Zone_ID=\"\"\n","bash","",[119,120,121,142,154],"code",{"__ignoreMap":117},[122,123,126,130,134,138],"span",{"class":124,"line":125},"line",1,[122,127,129],{"class":128},"sLKXg","export",[122,131,133],{"class":132},"sJa8x"," CF_Token",[122,135,137],{"class":136},"sknuh","=",[122,139,141],{"class":140},"sDhpE","\"\"\n",[122,143,145,147,150,152],{"class":124,"line":144},2,[122,146,129],{"class":128},[122,148,149],{"class":132}," CF_Account_ID",[122,151,137],{"class":136},[122,153,141],{"class":140},[122,155,157,159,162,164],{"class":124,"line":156},3,[122,158,129],{"class":128},[122,160,161],{"class":132}," CF_Zone_ID",[122,163,137],{"class":136},[122,165,141],{"class":140},[24,167,168],{},"随后可以尝试使用 acme.sh 签发 ssl 证书",[112,170,175],{"className":171,"code":173,"language":174},[172],"language-text","acme.sh --issue --dns dns_cf -d cdn.example.com\n","text",[119,176,173],{"__ignoreMap":117},[24,178,179],{},[44,180],{"alt":181,"src":182},"ssl 证书到手","https://static.031130.xyz/uploads/2024/08/14/c78bc5afa3641.webp",[35,184,186],{"id":185},"上-github-action","上 Github Action",[24,188,189,190,195],{},"原本是打算直接用 ",[74,191,194],{"href":192,"rel":193},"https://github.com/Menci/acme",[78],"Menci/acme"," 这个 Action的，可惜遇到了点问题。",[24,197,198,199,202],{},"在我本地，Cloudflare 相关的 Token 和 ID 并没有被写入到 account.conf，而是被写在 ",[119,200,201],{},"cdn.example.com_ecc/cdn.exampe.com.conf","，大概就没办法直接用这个 Action 了，不得不转去手搓。不过好在 Menci/acme 中还是能抄到不少的。",[204,205,207],"h4",{"id":206},"压缩本地的-ca-文件夹","压缩本地的 ca 文件夹",[112,209,211],{"className":114,"code":210,"language":116,"meta":117,"style":117},"cd $HOME/.acme.sh/ && tar cz ca | base64 -w0\n",[119,212,213],{"__ignoreMap":117},[122,214,215,219,222,225,229,233,236,239,242,245],{"class":124,"line":125},[122,216,218],{"class":217},"s_Sar","cd",[122,220,221],{"class":132}," $HOME",[122,223,224],{"class":140},"/.acme.sh/",[122,226,228],{"class":227},"s5ixo"," && ",[122,230,232],{"class":231},"sAdtL","tar",[122,234,235],{"class":140}," cz",[122,237,238],{"class":140}," ca",[122,240,241],{"class":227}," | ",[122,243,244],{"class":231},"base64",[122,246,248],{"class":247},"sAGMh"," -w0\n",[204,250,252],{"id":251},"安装-acmesh","安装 acme.sh",[112,254,258],{"className":255,"code":256,"language":257,"meta":117,"style":117},"language-yaml shiki shiki-themes one-light one-dark-pro","- name: Install acme.sh\n  run: curl https://get.acme.sh | sh\n","yaml",[119,259,260,274],{"__ignoreMap":117},[122,261,262,265,268,271],{"class":124,"line":125},[122,263,264],{"class":227},"- ",[122,266,267],{"class":132},"name",[122,269,270],{"class":227},": ",[122,272,273],{"class":140},"Install acme.sh\n",[122,275,276,279,281],{"class":124,"line":144},[122,277,278],{"class":132},"  run",[122,280,270],{"class":227},[122,282,283],{"class":140},"curl https://get.acme.sh | sh\n",[204,285,287],{"id":286},"解压-ca-文件夹","解压 ca 文件夹",[112,289,291],{"className":255,"code":290,"language":257,"meta":117,"style":117},"- name: Extract account files for acme.sh\n  run: |\n    echo \"${{ secrets.ACME_SH_ACCOUNT_TAR }}\" | base64 -d | tar -C ~/.acme.sh -xz\n",[119,292,293,304,313],{"__ignoreMap":117},[122,294,295,297,299,301],{"class":124,"line":125},[122,296,264],{"class":227},[122,298,267],{"class":132},[122,300,270],{"class":227},[122,302,303],{"class":140},"Extract account files for acme.sh\n",[122,305,306,308,310],{"class":124,"line":144},[122,307,278],{"class":132},[122,309,270],{"class":227},[122,311,312],{"class":128},"|\n",[122,314,315],{"class":124,"line":156},[122,316,317],{"class":140},"    echo \"${{ secrets.ACME_SH_ACCOUNT_TAR }}\" | base64 -d | tar -C ~/.acme.sh -xz\n",[204,319,321],{"id":320},"执行-acmesh-申请证书","执行 acme.sh 申请证书",[112,323,325],{"className":255,"code":324,"language":257,"meta":117,"style":117},"- name: Issue Certificate\n  run: |\n    export CF_Token=\"${{ secrets.CF_TOKEN }}\"\n    export CF_Zone_ID=\"${{ secrets.CF_ZONE_ID }}\"\n    export CF_Account_ID=\"${{ secrets.CF_ACCOUNT_ID }}\"\n    mkdir -p output\n    ~/.acme.sh/acme.sh --issue --dns dns_cf --force -d ${{ env.domain }} --fullchain-file output/fullchain.pem --key-file output/key.pem\n",[119,326,327,338,346,351,357,363,369],{"__ignoreMap":117},[122,328,329,331,333,335],{"class":124,"line":125},[122,330,264],{"class":227},[122,332,267],{"class":132},[122,334,270],{"class":227},[122,336,337],{"class":140},"Issue Certificate\n",[122,339,340,342,344],{"class":124,"line":144},[122,341,278],{"class":132},[122,343,270],{"class":227},[122,345,312],{"class":128},[122,347,348],{"class":124,"line":156},[122,349,350],{"class":140},"    export CF_Token=\"${{ secrets.CF_TOKEN }}\"\n",[122,352,354],{"class":124,"line":353},4,[122,355,356],{"class":140},"    export CF_Zone_ID=\"${{ secrets.CF_ZONE_ID }}\"\n",[122,358,360],{"class":124,"line":359},5,[122,361,362],{"class":140},"    export CF_Account_ID=\"${{ secrets.CF_ACCOUNT_ID }}\"\n",[122,364,366],{"class":124,"line":365},6,[122,367,368],{"class":140},"    mkdir -p output\n",[122,370,372],{"class":124,"line":371},7,[122,373,374],{"class":140},"    ~/.acme.sh/acme.sh --issue --dns dns_cf --force -d ${{ env.domain }} --fullchain-file output/fullchain.pem --key-file output/key.pem\n",[204,376,377],{"id":377},"压缩证书",[112,379,381],{"className":255,"code":380,"language":257,"meta":117,"style":117},"- name: zip Certificate\n  run: |\n    zip -j output/${{ env.domain }}_$(date +%Y%m%d).zip output/fullchain.pem output/key.pem\n",[119,382,383,394,402],{"__ignoreMap":117},[122,384,385,387,389,391],{"class":124,"line":125},[122,386,264],{"class":227},[122,388,267],{"class":132},[122,390,270],{"class":227},[122,392,393],{"class":140},"zip Certificate\n",[122,395,396,398,400],{"class":124,"line":144},[122,397,278],{"class":132},[122,399,270],{"class":227},[122,401,312],{"class":128},[122,403,404],{"class":124,"line":156},[122,405,406],{"class":140},"    zip -j output/${{ env.domain }}_$(date +%Y%m%d).zip output/fullchain.pem output/key.pem\n",[204,408,410],{"id":409},"通过-tg-bot-发送压缩包给自己","通过 tg bot 发送压缩包给自己",[112,412,414],{"className":255,"code":413,"language":257,"meta":117,"style":117},"- name: Push Certificate\n  run: |\n    TG_BOT_TOKEN=\"${{ secrets.TG_BOT_TOKEN }}\"\n    TG_CHAT_ID=\"${{ secrets.TG_CHAT_ID }}\"\n    curl -s -X POST https://api.telegram.org/bot${TG_BOT_TOKEN}/sendDocument -F chat_id=${TG_CHAT_ID} -F document=\"@output/${{ env.domain }}_$(date +%Y%m%d).zip\"\n",[119,415,416,427,435,440,445],{"__ignoreMap":117},[122,417,418,420,422,424],{"class":124,"line":125},[122,419,264],{"class":227},[122,421,267],{"class":132},[122,423,270],{"class":227},[122,425,426],{"class":140},"Push Certificate\n",[122,428,429,431,433],{"class":124,"line":144},[122,430,278],{"class":132},[122,432,270],{"class":227},[122,434,312],{"class":128},[122,436,437],{"class":124,"line":156},[122,438,439],{"class":140},"    TG_BOT_TOKEN=\"${{ secrets.TG_BOT_TOKEN }}\"\n",[122,441,442],{"class":124,"line":353},[122,443,444],{"class":140},"    TG_CHAT_ID=\"${{ secrets.TG_CHAT_ID }}\"\n",[122,446,447],{"class":124,"line":359},[122,448,449],{"class":140},"    curl -s -X POST https://api.telegram.org/bot${TG_BOT_TOKEN}/sendDocument -F chat_id=${TG_CHAT_ID} -F document=\"@output/${{ env.domain }}_$(date +%Y%m%d).zip\"\n",[204,451,452],{"id":452},"部署到又拍云",[24,454,455,456,461],{},"这里使用的是 ",[74,457,460],{"href":458,"rel":459},"https://github.com/Menci/deploy-certificate-to-upyun/",[78],"menci/deploy-certificate-to-upyun","。由于又拍云没有提供上传 ssl 证书的 api，因此只能通过模拟用户登陆的方式实现。",[112,463,465],{"className":255,"code":464,"language":257,"meta":117,"style":117},"- name: Deploy To Upyun\n  uses: Menci/deploy-certificate-to-upyun@beta-v2\n  with:\n    subaccount-username: ${{ secrets.UPYUN_SUBACCOUNT_USERNAME }}\n    subaccount-password: ${{ secrets.UPYUN_SUBACCOUNT_PASSWORD }}\n    fullchain-file: output/fullchain.pem\n    key-file: output/key.pem\n    domains: |\n      ${{ env.domain }}\n    delete-unused-certificates: true\n",[119,466,467,478,488,496,506,516,526,536,546,552],{"__ignoreMap":117},[122,468,469,471,473,475],{"class":124,"line":125},[122,470,264],{"class":227},[122,472,267],{"class":132},[122,474,270],{"class":227},[122,476,477],{"class":140},"Deploy To Upyun\n",[122,479,480,483,485],{"class":124,"line":144},[122,481,482],{"class":132},"  uses",[122,484,270],{"class":227},[122,486,487],{"class":140},"Menci/deploy-certificate-to-upyun@beta-v2\n",[122,489,490,493],{"class":124,"line":156},[122,491,492],{"class":132},"  with",[122,494,495],{"class":227},":\n",[122,497,498,501,503],{"class":124,"line":353},[122,499,500],{"class":132},"    subaccount-username",[122,502,270],{"class":227},[122,504,505],{"class":140},"${{ secrets.UPYUN_SUBACCOUNT_USERNAME }}\n",[122,507,508,511,513],{"class":124,"line":359},[122,509,510],{"class":132},"    subaccount-password",[122,512,270],{"class":227},[122,514,515],{"class":140},"${{ secrets.UPYUN_SUBACCOUNT_PASSWORD }}\n",[122,517,518,521,523],{"class":124,"line":365},[122,519,520],{"class":132},"    fullchain-file",[122,522,270],{"class":227},[122,524,525],{"class":140},"output/fullchain.pem\n",[122,527,528,531,533],{"class":124,"line":371},[122,529,530],{"class":132},"    key-file",[122,532,270],{"class":227},[122,534,535],{"class":140},"output/key.pem\n",[122,537,539,542,544],{"class":124,"line":538},8,[122,540,541],{"class":132},"    domains",[122,543,270],{"class":227},[122,545,312],{"class":128},[122,547,549],{"class":124,"line":548},9,[122,550,551],{"class":140},"      ${{ env.domain }}\n",[122,553,555,558,560],{"class":124,"line":554},10,[122,556,557],{"class":132},"    delete-unused-certificates",[122,559,270],{"class":227},[122,561,562],{"class":247},"true\n",[24,564,565],{},[44,566],{"alt":567,"src":568},"SSL 证书成功部署到又拍云","https://static.031130.xyz/uploads/2024/08/14/222a754d25c97.webp",[19,570,571],{"id":571},"参见",[573,574,575,583,590],"ul",{},[576,577,578],"li",{},[74,579,582],{"href":580,"rel":581},"https://blog.men.ci/ssl-with-github-actions/",[78],"使用 GitHub Actions 自动申请与部署 ACME SSL 证书",[576,584,585],{},[74,586,589],{"href":587,"rel":588},"https://shiping.date/82.html",[78],"（续）acme.sh脚本使用新cloudflare api令牌申请证书",[576,591,592],{},[74,593,596],{"href":594,"rel":595},"https://github.com/acmesh-official/acme.sh",[78],"acmesh-official/acme.sh",[598,599,600],"style",{},"html pre.shiki code .sLKXg, html code.shiki .sLKXg{--shiki-default:#A626A4;--shiki-dark:#C678DD}html pre.shiki code .sJa8x, html code.shiki .sJa8x{--shiki-default:#E45649;--shiki-dark:#E06C75}html pre.shiki code .sknuh, html code.shiki .sknuh{--shiki-default:#383A42;--shiki-dark:#56B6C2}html pre.shiki code .sDhpE, html code.shiki .sDhpE{--shiki-default:#50A14F;--shiki-dark:#98C379}html .default .shiki span {color: var(--shiki-default);background: var(--shiki-default-bg);font-style: var(--shiki-default-font-style);font-weight: var(--shiki-default-font-weight);text-decoration: var(--shiki-default-text-decoration);}html .shiki span {color: var(--shiki-default);background: var(--shiki-default-bg);font-style: var(--shiki-default-font-style);font-weight: var(--shiki-default-font-weight);text-decoration: var(--shiki-default-text-decoration);}html .dark .shiki span {color: var(--shiki-dark);background: var(--shiki-dark-bg);font-style: var(--shiki-dark-font-style);font-weight: var(--shiki-dark-font-weight);text-decoration: var(--shiki-dark-text-decoration);}html.dark .shiki span {color: var(--shiki-dark);background: var(--shiki-dark-bg);font-style: var(--shiki-dark-font-style);font-weight: var(--shiki-dark-font-weight);text-decoration: var(--shiki-dark-text-decoration);}html pre.shiki code .s_Sar, html code.shiki .s_Sar{--shiki-default:#0184BC;--shiki-dark:#56B6C2}html pre.shiki code .s5ixo, html code.shiki .s5ixo{--shiki-default:#383A42;--shiki-dark:#ABB2BF}html pre.shiki code .sAdtL, html code.shiki .sAdtL{--shiki-default:#4078F2;--shiki-dark:#61AFEF}html pre.shiki code .sAGMh, html code.shiki .sAGMh{--shiki-default:#986801;--shiki-dark:#D19A66}",{"title":117,"searchDepth":144,"depth":144,"links":602},[603,604,608,612],{"id":21,"depth":144,"text":22},{"id":32,"depth":144,"text":33,"children":605},[606,607],{"id":37,"depth":156,"text":37},{"id":50,"depth":156,"text":50},{"id":65,"depth":144,"text":66,"children":609},[610,611],{"id":83,"depth":156,"text":83},{"id":185,"depth":156,"text":186},{"id":571,"depth":144,"text":571},[614,620],{"title":615,"path":616,"stem":617,"date":618,"lang":619,"children":-1},"自建图床小记四——上传脚本编写与图片迁移","/2024/08/20/picbed-upload-script-and-image-migration","posts/zh/picbed-upload-script-and-image-migration","2024-08-20 23:12:30","zh-CN",{"title":621,"path":622,"stem":623,"date":624,"lang":619,"children":-1},"自建图床小记二——使用 Workers 为 R2 构建 Restful API","/2024/08/13/build-restful-api-for-cloudflare-r2-with-cloudflare-workers","posts/zh/build-restful-api-for-cloudflare-r2-with-cloudflare-workers","2024-08-13 22:58:26",null,1771555474836]