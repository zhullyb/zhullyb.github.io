[{"data":1,"prerenderedAt":2151},["ShallowReactive",2],{"post-2024-08-20-picbed-upload-script-and-image-migration":3,"has-en-2024-08-20-picbed-upload-script-and-image-migration":2132,"surround-2024-08-20-picbed-upload-script-and-image-migration":2140,"randomIndex/2024/08/20/picbed-upload-script-and-image-migration/":57},{"id":4,"title":5,"body":6,"date":2123,"description":2124,"extension":2125,"lang":2126,"meta":2127,"navigation":67,"path":2128,"rawbody":2129,"seo":2130,"stem":2131,"sticky":2132,"tags":2133,"__hash__":2139},"posts/posts/picbed-upload-script-and-image-migration.md","自建图床小记四——上传脚本编写与图片迁移",{"type":7,"value":8,"toc":2119},"minimark",[9,29,33,36,43,1141,1168,1206,1216,1219,1319,1340,1348,1351,1354,1357,2115],[10,11,12,13,18,19,23,24,28],"p",{},"前面三篇小记分别讲述了",[14,15,17],"a",{"href":16},"/2024/08/12/new-picbed-based-on-cloudflare-and-upyun/","图床的整体架构","、",[14,20,22],{"href":21},"/2024/08/13/build-restful-api-for-cloudflare-r2-with-cloudflare-workers/","用 Workers 构建 Restful API"," 和 ",[14,25,27],{"href":26},"/2024/08/14/auto-renew-ssl-certificate-and-deploy-to-upyun-with-github-action/","自动更新部署 SSL 证书","，这一篇c处理由此带来的图片上传问题，主要是要为 Typora 编写自动上传脚本，并为博客原有的图片进行迁移。",[30,31,32],"h2",{"id":32},"自动上传脚本",[10,34,35],{},"主要还是给 Typora 用，实现这种效果",[10,37,38],{},[39,40],"img",{"alt":41,"src":42},"Typora 自动上传","https://static.031130.xyz/uploads/2024/08/12/62f3b881e3c4c.gif",[44,45,50],"pre",{"className":46,"code":47,"language":48,"meta":49,"style":49},"language-bash shiki shiki-themes one-light one-dark-pro","#!/bin/bash\n\nHOST=\"upload.example.com\"\nCDN_HOST=\"cdn.example.com\"\nUPLOAD_PATH=\"uploads/$(date +%Y/%m/%d)\"\n\nAUTH_TOKEN=\"1145141919810\"\n\nwebp=false\nmarkdown=false\nforce=false\nkeep=false\n\nwhile getopts \":mwfkp:\" opt; do\n    case $opt in\n        m|markdown) markdown=true ;;\n        w|webp) webp=true ;;\n        f|force) force=true ;;\n        k|keep) keep=true ;;\n        p|path) UPLOAD_PATH=$OPTARG ;;\n        \\?) echo \"Invalid option: -$OPTARG\" ;;\n    esac\ndone\nshift $((OPTIND - 1))\n\nUPLOAD_URL=\"https://$HOST/$UPLOAD_PATH\"\nif [[ \"$UPLOAD_URL\" == */ ]]; then\n    UPLOAD_URL=\"${UPLOAD_URL%?}\"\nfi\n\nfor image in \"$@\"; do\n    if [ \"$webp\" = true ]; then\n        cwebp -quiet \"$image\" -o \"${image%.*}.webp\"\n        image=\"${image%.*}.webp\"\n    fi\n\n    if [ \"$keep\" = true ]; then\n        FILENAME=$(basename \"$image\")\n    else\n        FILENAME=\"$(md5sum $image | cut -c 1-13).$(basename $image | cut -d. -f2)\"\n    fi\n\n    if [ \"$force\" = true ]; then\n        UPLOAD_RESPONSE=$(curl -s -X PUT \"${UPLOAD_URL}/$FILENAME\" \\\n            -w \"%{http_code}\" \\\n            --data-binary @\"$image\" \\\n            -H \"X-Custom-Auth-Key: $AUTH_TOKEN\" \\\n            -H \"Overwrite: true\" \\\n        )\n    else\n        UPLOAD_RESPONSE=$(curl -s -X PUT \"${UPLOAD_URL}/$FILENAME\" \\\n            -w \"%{http_code}\" \\\n            --data-binary @\"$image\" \\\n            -H \"X-Custom-Auth-Key: $AUTH_TOKEN\" \\\n        )\n    fi\n\n    UPLOAD_HTTP_CODE=$(echo \"$UPLOAD_RESPONSE\" | tail -n1)\n\n    if [ -n \"$UPLOAD_PATH\" ]; then\n        CDN_URL=\"https://$CDN_HOST/$UPLOAD_PATH/$FILENAME\"\n    else\n        CDN_URL=\"https://$CDN_HOST/$FILENAME\"\n    fi\n\n    if [ \"$UPLOAD_HTTP_CODE\" != \"200\" ]; then\n        echo \"上传失败: $UPLOAD_RESPONSE\"\n        continue\n    fi\n\n    if [ \"$markdown\" = true ]; then\n        echo \"![](${CDN_URL})\"\n    else\n        echo \"${CDN_URL}\"\n    fi\ndone\n","bash","",[51,52,53,62,69,84,95,113,118,129,134,145,155,165,175,180,204,216,241,261,281,301,323,344,350,356,378,383,406,431,458,464,469,494,521,560,584,590,595,617,640,646,691,696,701,723,763,774,789,805,815,821,826,859,868,881,894,899,904,909,939,944,964,987,992,1009,1014,1019,1043,1056,1062,1067,1072,1094,1111,1116,1131,1136],"code",{"__ignoreMap":49},[54,55,58],"span",{"class":56,"line":57},"line",1,[54,59,61],{"class":60},"sW2Sy","#!/bin/bash\n",[54,63,65],{"class":56,"line":64},2,[54,66,68],{"emptyLinePlaceholder":67},true,"\n",[54,70,72,76,80],{"class":56,"line":71},3,[54,73,75],{"class":74},"sJa8x","HOST",[54,77,79],{"class":78},"sknuh","=",[54,81,83],{"class":82},"sDhpE","\"upload.example.com\"\n",[54,85,87,90,92],{"class":56,"line":86},4,[54,88,89],{"class":74},"CDN_HOST",[54,91,79],{"class":78},[54,93,94],{"class":82},"\"cdn.example.com\"\n",[54,96,98,101,103,106,110],{"class":56,"line":97},5,[54,99,100],{"class":74},"UPLOAD_PATH",[54,102,79],{"class":78},[54,104,105],{"class":82},"\"uploads/$(",[54,107,109],{"class":108},"sAdtL","date",[54,111,112],{"class":82}," +%Y/%m/%d)\"\n",[54,114,116],{"class":56,"line":115},6,[54,117,68],{"emptyLinePlaceholder":67},[54,119,121,124,126],{"class":56,"line":120},7,[54,122,123],{"class":74},"AUTH_TOKEN",[54,125,79],{"class":78},[54,127,128],{"class":82},"\"1145141919810\"\n",[54,130,132],{"class":56,"line":131},8,[54,133,68],{"emptyLinePlaceholder":67},[54,135,137,140,142],{"class":56,"line":136},9,[54,138,139],{"class":74},"webp",[54,141,79],{"class":78},[54,143,144],{"class":82},"false\n",[54,146,148,151,153],{"class":56,"line":147},10,[54,149,150],{"class":74},"markdown",[54,152,79],{"class":78},[54,154,144],{"class":82},[54,156,158,161,163],{"class":56,"line":157},11,[54,159,160],{"class":74},"force",[54,162,79],{"class":78},[54,164,144],{"class":82},[54,166,168,171,173],{"class":56,"line":167},12,[54,169,170],{"class":74},"keep",[54,172,79],{"class":78},[54,174,144],{"class":82},[54,176,178],{"class":56,"line":177},13,[54,179,68],{"emptyLinePlaceholder":67},[54,181,183,187,191,194,197,201],{"class":56,"line":182},14,[54,184,186],{"class":185},"sLKXg","while",[54,188,190],{"class":189},"s_Sar"," getopts",[54,192,193],{"class":82}," \":mwfkp:\"",[54,195,196],{"class":82}," opt",[54,198,200],{"class":199},"s5ixo","; ",[54,202,203],{"class":185},"do\n",[54,205,207,210,213],{"class":56,"line":206},15,[54,208,209],{"class":185},"    case",[54,211,212],{"class":74}," $opt",[54,214,215],{"class":185}," in\n",[54,217,219,223,226,228,231,233,235,238],{"class":56,"line":218},16,[54,220,222],{"class":221},"sDaw7","        m",[54,224,225],{"class":199},"|",[54,227,150],{"class":221},[54,229,230],{"class":199},") ",[54,232,150],{"class":74},[54,234,79],{"class":78},[54,236,237],{"class":82},"true",[54,239,240],{"class":199}," ;;\n",[54,242,244,247,249,251,253,255,257,259],{"class":56,"line":243},17,[54,245,246],{"class":221},"        w",[54,248,225],{"class":199},[54,250,139],{"class":221},[54,252,230],{"class":199},[54,254,139],{"class":74},[54,256,79],{"class":78},[54,258,237],{"class":82},[54,260,240],{"class":199},[54,262,264,267,269,271,273,275,277,279],{"class":56,"line":263},18,[54,265,266],{"class":221},"        f",[54,268,225],{"class":199},[54,270,160],{"class":221},[54,272,230],{"class":199},[54,274,160],{"class":74},[54,276,79],{"class":78},[54,278,237],{"class":82},[54,280,240],{"class":199},[54,282,284,287,289,291,293,295,297,299],{"class":56,"line":283},19,[54,285,286],{"class":221},"        k",[54,288,225],{"class":199},[54,290,170],{"class":221},[54,292,230],{"class":199},[54,294,170],{"class":74},[54,296,79],{"class":78},[54,298,237],{"class":82},[54,300,240],{"class":199},[54,302,304,307,309,312,314,316,318,321],{"class":56,"line":303},20,[54,305,306],{"class":221},"        p",[54,308,225],{"class":199},[54,310,311],{"class":221},"path",[54,313,230],{"class":199},[54,315,100],{"class":74},[54,317,79],{"class":78},[54,319,320],{"class":74},"$OPTARG",[54,322,240],{"class":199},[54,324,326,329,331,334,337,339,342],{"class":56,"line":325},21,[54,327,328],{"class":189},"        \\?",[54,330,230],{"class":199},[54,332,333],{"class":189},"echo",[54,335,336],{"class":82}," \"Invalid option: -",[54,338,320],{"class":74},[54,340,341],{"class":82},"\"",[54,343,240],{"class":199},[54,345,347],{"class":56,"line":346},22,[54,348,349],{"class":185},"    esac\n",[54,351,353],{"class":56,"line":352},23,[54,354,355],{"class":185},"done\n",[54,357,359,362,365,368,371,375],{"class":56,"line":358},24,[54,360,361],{"class":189},"shift",[54,363,364],{"class":199}," $((",[54,366,367],{"class":108},"OPTIND",[54,369,370],{"class":82}," -",[54,372,374],{"class":373},"sAGMh"," 1",[54,376,377],{"class":199},"))\n",[54,379,381],{"class":56,"line":380},25,[54,382,68],{"emptyLinePlaceholder":67},[54,384,386,389,391,394,397,400,403],{"class":56,"line":385},26,[54,387,388],{"class":74},"UPLOAD_URL",[54,390,79],{"class":78},[54,392,393],{"class":82},"\"https://",[54,395,396],{"class":74},"$HOST",[54,398,399],{"class":82},"/",[54,401,402],{"class":74},"$UPLOAD_PATH",[54,404,405],{"class":82},"\"\n",[54,407,409,412,415,417,420,422,425,428],{"class":56,"line":408},27,[54,410,411],{"class":185},"if",[54,413,414],{"class":199}," [[ ",[54,416,341],{"class":82},[54,418,419],{"class":74},"$UPLOAD_URL",[54,421,341],{"class":82},[54,423,424],{"class":78}," ==",[54,426,427],{"class":199}," */ ]]; ",[54,429,430],{"class":185},"then\n",[54,432,434,437,439,441,445,447,450,453,456],{"class":56,"line":433},28,[54,435,436],{"class":74},"    UPLOAD_URL",[54,438,79],{"class":78},[54,440,341],{"class":82},[54,442,444],{"class":443},"sTIpt","${",[54,446,388],{"class":74},[54,448,449],{"class":199},"%",[54,451,452],{"class":82},"?",[54,454,455],{"class":443},"}",[54,457,405],{"class":82},[54,459,461],{"class":56,"line":460},29,[54,462,463],{"class":185},"fi\n",[54,465,467],{"class":56,"line":466},30,[54,468,68],{"emptyLinePlaceholder":67},[54,470,472,475,478,481,484,488,490,492],{"class":56,"line":471},31,[54,473,474],{"class":185},"for",[54,476,477],{"class":74}," image",[54,479,480],{"class":185}," in",[54,482,483],{"class":82}," \"",[54,485,487],{"class":486},"s8iYz","$@",[54,489,341],{"class":82},[54,491,200],{"class":199},[54,493,203],{"class":185},[54,495,497,500,503,505,508,510,513,516,519],{"class":56,"line":496},32,[54,498,499],{"class":185},"    if",[54,501,502],{"class":199}," [ ",[54,504,341],{"class":82},[54,506,507],{"class":74},"$webp",[54,509,341],{"class":82},[54,511,512],{"class":78}," =",[54,514,515],{"class":373}," true",[54,517,518],{"class":199}," ]; ",[54,520,430],{"class":185},[54,522,524,527,530,532,535,537,540,542,544,547,549,552,555,557],{"class":56,"line":523},33,[54,525,526],{"class":108},"        cwebp",[54,528,529],{"class":373}," -quiet",[54,531,483],{"class":82},[54,533,534],{"class":74},"$image",[54,536,341],{"class":82},[54,538,539],{"class":373}," -o",[54,541,483],{"class":82},[54,543,444],{"class":443},[54,545,546],{"class":74},"image",[54,548,449],{"class":199},[54,550,551],{"class":82},".",[54,553,554],{"class":199},"*",[54,556,455],{"class":443},[54,558,559],{"class":82},".webp\"\n",[54,561,563,566,568,570,572,574,576,578,580,582],{"class":56,"line":562},34,[54,564,565],{"class":74},"        image",[54,567,79],{"class":78},[54,569,341],{"class":82},[54,571,444],{"class":443},[54,573,546],{"class":74},[54,575,449],{"class":199},[54,577,551],{"class":82},[54,579,554],{"class":199},[54,581,455],{"class":443},[54,583,559],{"class":82},[54,585,587],{"class":56,"line":586},35,[54,588,589],{"class":185},"    fi\n",[54,591,593],{"class":56,"line":592},36,[54,594,68],{"emptyLinePlaceholder":67},[54,596,598,600,602,604,607,609,611,613,615],{"class":56,"line":597},37,[54,599,499],{"class":185},[54,601,502],{"class":199},[54,603,341],{"class":82},[54,605,606],{"class":74},"$keep",[54,608,341],{"class":82},[54,610,512],{"class":78},[54,612,515],{"class":373},[54,614,518],{"class":199},[54,616,430],{"class":185},[54,618,620,623,625,628,631,633,635,637],{"class":56,"line":619},38,[54,621,622],{"class":74},"        FILENAME",[54,624,79],{"class":78},[54,626,627],{"class":199},"$(",[54,629,630],{"class":108},"basename",[54,632,483],{"class":82},[54,634,534],{"class":74},[54,636,341],{"class":82},[54,638,639],{"class":199},")\n",[54,641,643],{"class":56,"line":642},39,[54,644,645],{"class":185},"    else\n",[54,647,649,651,653,656,659,662,665,668,671,674,676,678,680,682,685,688],{"class":56,"line":648},40,[54,650,622],{"class":74},[54,652,79],{"class":78},[54,654,655],{"class":82},"\"$(",[54,657,658],{"class":108},"md5sum",[54,660,661],{"class":74}," $image",[54,663,664],{"class":199}," |",[54,666,667],{"class":108}," cut",[54,669,670],{"class":373}," -c",[54,672,673],{"class":82}," 1-13).$(",[54,675,630],{"class":108},[54,677,661],{"class":74},[54,679,664],{"class":199},[54,681,667],{"class":108},[54,683,684],{"class":373}," -d.",[54,686,687],{"class":373}," -f2",[54,689,690],{"class":82},")\"\n",[54,692,694],{"class":56,"line":693},41,[54,695,589],{"class":185},[54,697,699],{"class":56,"line":698},42,[54,700,68],{"emptyLinePlaceholder":67},[54,702,704,706,708,710,713,715,717,719,721],{"class":56,"line":703},43,[54,705,499],{"class":185},[54,707,502],{"class":199},[54,709,341],{"class":82},[54,711,712],{"class":74},"$force",[54,714,341],{"class":82},[54,716,512],{"class":78},[54,718,515],{"class":373},[54,720,518],{"class":199},[54,722,430],{"class":185},[54,724,726,729,731,733,736,739,742,745,747,749,751,753,755,758,760],{"class":56,"line":725},44,[54,727,728],{"class":74},"        UPLOAD_RESPONSE",[54,730,79],{"class":78},[54,732,627],{"class":199},[54,734,735],{"class":108},"curl",[54,737,738],{"class":373}," -s",[54,740,741],{"class":373}," -X",[54,743,744],{"class":82}," PUT",[54,746,483],{"class":82},[54,748,444],{"class":443},[54,750,388],{"class":74},[54,752,455],{"class":443},[54,754,399],{"class":82},[54,756,757],{"class":74},"$FILENAME",[54,759,341],{"class":82},[54,761,762],{"class":189}," \\\n",[54,764,766,769,772],{"class":56,"line":765},45,[54,767,768],{"class":373},"            -w",[54,770,771],{"class":82}," \"%{http_code}\"",[54,773,762],{"class":189},[54,775,777,780,783,785,787],{"class":56,"line":776},46,[54,778,779],{"class":373},"            --data-binary",[54,781,782],{"class":82}," @\"",[54,784,534],{"class":74},[54,786,341],{"class":82},[54,788,762],{"class":189},[54,790,792,795,798,801,803],{"class":56,"line":791},47,[54,793,794],{"class":373},"            -H",[54,796,797],{"class":82}," \"X-Custom-Auth-Key: ",[54,799,800],{"class":74},"$AUTH_TOKEN",[54,802,341],{"class":82},[54,804,762],{"class":189},[54,806,808,810,813],{"class":56,"line":807},48,[54,809,794],{"class":373},[54,811,812],{"class":82}," \"Overwrite: true\"",[54,814,762],{"class":189},[54,816,818],{"class":56,"line":817},49,[54,819,820],{"class":199},"        )\n",[54,822,824],{"class":56,"line":823},50,[54,825,645],{"class":185},[54,827,829,831,833,835,837,839,841,843,845,847,849,851,853,855,857],{"class":56,"line":828},51,[54,830,728],{"class":74},[54,832,79],{"class":78},[54,834,627],{"class":199},[54,836,735],{"class":108},[54,838,738],{"class":373},[54,840,741],{"class":373},[54,842,744],{"class":82},[54,844,483],{"class":82},[54,846,444],{"class":443},[54,848,388],{"class":74},[54,850,455],{"class":443},[54,852,399],{"class":82},[54,854,757],{"class":74},[54,856,341],{"class":82},[54,858,762],{"class":189},[54,860,862,864,866],{"class":56,"line":861},52,[54,863,768],{"class":373},[54,865,771],{"class":82},[54,867,762],{"class":189},[54,869,871,873,875,877,879],{"class":56,"line":870},53,[54,872,779],{"class":373},[54,874,782],{"class":82},[54,876,534],{"class":74},[54,878,341],{"class":82},[54,880,762],{"class":189},[54,882,884,886,888,890,892],{"class":56,"line":883},54,[54,885,794],{"class":373},[54,887,797],{"class":82},[54,889,800],{"class":74},[54,891,341],{"class":82},[54,893,762],{"class":189},[54,895,897],{"class":56,"line":896},55,[54,898,820],{"class":199},[54,900,902],{"class":56,"line":901},56,[54,903,589],{"class":185},[54,905,907],{"class":56,"line":906},57,[54,908,68],{"emptyLinePlaceholder":67},[54,910,912,915,917,919,921,923,926,928,931,934,937],{"class":56,"line":911},58,[54,913,914],{"class":74},"    UPLOAD_HTTP_CODE",[54,916,79],{"class":78},[54,918,627],{"class":199},[54,920,333],{"class":189},[54,922,483],{"class":82},[54,924,925],{"class":74},"$UPLOAD_RESPONSE",[54,927,341],{"class":82},[54,929,930],{"class":199}," | ",[54,932,933],{"class":108},"tail",[54,935,936],{"class":373}," -n1",[54,938,639],{"class":199},[54,940,942],{"class":56,"line":941},59,[54,943,68],{"emptyLinePlaceholder":67},[54,945,947,949,951,954,956,958,960,962],{"class":56,"line":946},60,[54,948,499],{"class":185},[54,950,502],{"class":199},[54,952,953],{"class":78},"-n",[54,955,483],{"class":82},[54,957,402],{"class":74},[54,959,341],{"class":82},[54,961,518],{"class":199},[54,963,430],{"class":185},[54,965,967,970,972,974,977,979,981,983,985],{"class":56,"line":966},61,[54,968,969],{"class":74},"        CDN_URL",[54,971,79],{"class":78},[54,973,393],{"class":82},[54,975,976],{"class":74},"$CDN_HOST",[54,978,399],{"class":82},[54,980,402],{"class":74},[54,982,399],{"class":82},[54,984,757],{"class":74},[54,986,405],{"class":82},[54,988,990],{"class":56,"line":989},62,[54,991,645],{"class":185},[54,993,995,997,999,1001,1003,1005,1007],{"class":56,"line":994},63,[54,996,969],{"class":74},[54,998,79],{"class":78},[54,1000,393],{"class":82},[54,1002,976],{"class":74},[54,1004,399],{"class":82},[54,1006,757],{"class":74},[54,1008,405],{"class":82},[54,1010,1012],{"class":56,"line":1011},64,[54,1013,589],{"class":185},[54,1015,1017],{"class":56,"line":1016},65,[54,1018,68],{"emptyLinePlaceholder":67},[54,1020,1022,1024,1026,1028,1031,1033,1036,1039,1041],{"class":56,"line":1021},66,[54,1023,499],{"class":185},[54,1025,502],{"class":199},[54,1027,341],{"class":82},[54,1029,1030],{"class":74},"$UPLOAD_HTTP_CODE",[54,1032,341],{"class":82},[54,1034,1035],{"class":78}," !=",[54,1037,1038],{"class":82}," \"200\"",[54,1040,518],{"class":199},[54,1042,430],{"class":185},[54,1044,1046,1049,1052,1054],{"class":56,"line":1045},67,[54,1047,1048],{"class":189},"        echo",[54,1050,1051],{"class":82}," \"上传失败: ",[54,1053,925],{"class":74},[54,1055,405],{"class":82},[54,1057,1059],{"class":56,"line":1058},68,[54,1060,1061],{"class":185},"        continue\n",[54,1063,1065],{"class":56,"line":1064},69,[54,1066,589],{"class":185},[54,1068,1070],{"class":56,"line":1069},70,[54,1071,68],{"emptyLinePlaceholder":67},[54,1073,1075,1077,1079,1081,1084,1086,1088,1090,1092],{"class":56,"line":1074},71,[54,1076,499],{"class":185},[54,1078,502],{"class":199},[54,1080,341],{"class":82},[54,1082,1083],{"class":74},"$markdown",[54,1085,341],{"class":82},[54,1087,512],{"class":78},[54,1089,515],{"class":373},[54,1091,518],{"class":199},[54,1093,430],{"class":185},[54,1095,1097,1099,1102,1104,1107,1109],{"class":56,"line":1096},72,[54,1098,1048],{"class":189},[54,1100,1101],{"class":82}," \"![](",[54,1103,444],{"class":443},[54,1105,1106],{"class":74},"CDN_URL",[54,1108,455],{"class":443},[54,1110,690],{"class":82},[54,1112,1114],{"class":56,"line":1113},73,[54,1115,645],{"class":185},[54,1117,1119,1121,1123,1125,1127,1129],{"class":56,"line":1118},74,[54,1120,1048],{"class":189},[54,1122,483],{"class":82},[54,1124,444],{"class":443},[54,1126,1106],{"class":74},[54,1128,455],{"class":443},[54,1130,405],{"class":82},[54,1132,1134],{"class":56,"line":1133},75,[54,1135,589],{"class":185},[54,1137,1139],{"class":56,"line":1138},76,[54,1140,355],{"class":185},[10,1142,1143,1144,18,1147,23,1150,1153,1154,1156,1157,23,1159,1161,1162,23,1164,1167],{},"这一次使用 Cloudflare Workers 构建的 Restful API 很有意思，使用了 ",[51,1145,1146],{},"GET",[51,1148,1149],{},"PUT",[51,1151,1152],{},"DELETE"," 三个请求类型。",[51,1155,1146],{}," 请求很常见，是用来获取图片的，",[51,1158,1149],{},[51,1160,1152],{}," 在 web 开发就不如 ",[51,1163,1146],{},[51,1165,1166],{},"POST"," 常见了，这一次也是让我体会到了这两个 http verb 在 Storage Bucket 操作中是有多么形象了。",[1169,1170,1171,1195],"ul",{},[1172,1173,1174,1176,1177,1180,1181,1184,1185,1188,1189,1191,1192,1194],"li",{},[51,1175,1149],{}," - 从直观上来讲，就是将某个文件放到目标位置",[1178,1179],"br",{},"打个比方，我向 ",[51,1182,1183],{},"https://cdn.example.com/img/avatar.webp"," 打了一个请求，并带上了要上传的文件，那就意味着我将这个文件放到了 Storage Bucket 的 ",[51,1186,1187],{},"/img/avatar.webp"," 这个位置，所以我在上传后，应该就能用 ",[51,1190,1146],{}," 请求我刚才 ",[51,1193,1149],{}," 的那个 URL 获取我刚才上传的东西。如果那个路径存在文件，那么默认行为是直接覆盖。",[1172,1196,1197,1199,1200,1202,1203,1205],{},[51,1198,1152],{}," - 删除目标路径的文件",[1178,1201],{},"和 ",[51,1204,1149],{}," 一样，我在请求对应 URL 后，Storage Bucket 中对应 URL 路径的资源应该被删除。",[10,1207,1208,23,1210,1212,1213,1215],{},[51,1209,1149],{},[51,1211,1152],{}," 这两个 Http Verb 让我们更像是在对一个真实的文件系统进行操作，而非那种传统的使用 ",[51,1214,1166],{}," 上传的图床那样，我们并不通过 POST 请求上传一个文件，然后获取资源最终被放置位置的 URL —— 我们自己决定资源被存放的位置。",[10,1217,1218],{},"在这个 Shell 脚本中，引入了四个可选选项",[44,1220,1222],{"className":46,"code":1221,"language":48,"meta":49,"style":49},"    m|markdown) markdown=true ;;\n    w|webp) webp=true ;;\n    f|force) force=true ;;\n    k|keep) keep=true ;;\n    p|path) UPLOAD_PATH=$OPTARG ;;\n",[51,1223,1224,1243,1262,1281,1300],{"__ignoreMap":49},[54,1225,1226,1229,1231,1233,1235,1237,1239,1241],{"class":56,"line":57},[54,1227,1228],{"class":108},"    m",[54,1230,225],{"class":199},[54,1232,150],{"class":108},[54,1234,230],{"class":199},[54,1236,150],{"class":74},[54,1238,79],{"class":78},[54,1240,237],{"class":82},[54,1242,240],{"class":199},[54,1244,1245,1248,1250,1252,1254,1256,1258,1260],{"class":56,"line":64},[54,1246,1247],{"class":108},"    w",[54,1249,225],{"class":199},[54,1251,139],{"class":108},[54,1253,230],{"class":199},[54,1255,139],{"class":74},[54,1257,79],{"class":78},[54,1259,237],{"class":82},[54,1261,240],{"class":199},[54,1263,1264,1267,1269,1271,1273,1275,1277,1279],{"class":56,"line":71},[54,1265,1266],{"class":108},"    f",[54,1268,225],{"class":199},[54,1270,160],{"class":108},[54,1272,230],{"class":199},[54,1274,160],{"class":74},[54,1276,79],{"class":78},[54,1278,237],{"class":82},[54,1280,240],{"class":199},[54,1282,1283,1286,1288,1290,1292,1294,1296,1298],{"class":56,"line":86},[54,1284,1285],{"class":108},"    k",[54,1287,225],{"class":199},[54,1289,170],{"class":108},[54,1291,230],{"class":199},[54,1293,170],{"class":74},[54,1295,79],{"class":78},[54,1297,237],{"class":82},[54,1299,240],{"class":199},[54,1301,1302,1305,1307,1309,1311,1313,1315,1317],{"class":56,"line":97},[54,1303,1304],{"class":108},"    p",[54,1306,225],{"class":199},[54,1308,311],{"class":108},[54,1310,230],{"class":199},[54,1312,100],{"class":74},[54,1314,79],{"class":78},[54,1316,320],{"class":74},[54,1318,240],{"class":199},[1169,1320,1321,1328,1331,1334,1337],{},[1172,1322,1323,1324,1327],{},"markdown 选项决定返回值是否以 ",[51,1325,1326],{},"![]()"," 这种 URL 格式返回",[1172,1329,1330],{},"webp 决定上传过程中是否将图片转为 webp 后再上传",[1172,1332,1333],{},"force 决定如果遇到文件路径冲突，是否强制覆盖云端的文件",[1172,1335,1336],{},"keep 决定是否保留文件原有的文件名进行上传",[1172,1338,1339],{},"path 决定文件具体被存放的路径（或者使用默认的路径）",[10,1341,1342,1344,1345,1347],{},[51,1343,75],{}," 是图床用于上传的地址，",[51,1346,89],{}," 是图床用于被方可访问的地址。",[10,1349,1350],{},"由于急着用，也没考虑协程的处理方式，等等看后期有没有时间用 Python 重写吧。",[30,1352,1353],{"id":1353},"博客图床迁移脚本",[10,1355,1356],{},"因为只用一次，所以也没使用协程或者多线程的方式去上传文件——毕竟图片不多，也就两三百张。",[44,1358,1362],{"className":1359,"code":1360,"language":1361,"meta":49,"style":49},"language-python shiki shiki-themes one-light one-dark-pro","import os\nimport re\nimport requests\n\n# 哪些后缀的文件需要检测是否存在老图床的 URL 并进行迁移？\nfile_extension = [\n    '.md',\n    '.yml',\n    '.html'\n]\n\npic_urls = []\n\n_files = []\n\n# 用于匹配老图床的正则表达式，这里是按照 lsky pro 的格式编写的\npattern = r'https://cdn.example.com/\\d{4}/\\d{2}/\\d{2}/[a-z0-9]{13}\\.[a-z]{3,4}'\n\n# 图片的上传部分，需要先从原 url 中下载图片，在上传到新图床中，如果需要的话可以在中途转换为 webp 格式\ndef upload(url):\n    \"\"\"\n    此处的返回值应该是新的 url\n    \"\"\"\n\n# 遍历目标后缀文件名的文件，如果存在老图床的 url，则将 url 加入到 pic_urls 列表中，并将这个文件的文件名（相对路径）添加到 _files 列表中\nfor root, dirs, files in os.walk(\".\"):\n    for file in files:\n        if file.endswith(tuple(file_extension)):\n            file_name = os.path.join(root, file)\n            with open(file_name, 'r') as f:\n                content = f.read()\n            urls = re.findall(pattern, content)\n            if urls:\n                pic_urls.extend(urls)\n                _files.append(file_name)\n\n# 先转为集合，再转回列表，进行去重\npic_urls = list(set(pic_urls))\nprint(\"共找到图片：\", len(pic_urls))\n\nurl_dict = {}\n\n# 将列表中的图片进行上传，每张图片最多尝试三次上传，如果三次都失败，则保留原连接\nfor i,u in enumerate(pci_urls, start=1):\n    for t in range(1,4):\n        try:\n            new_u = upload(u)\n            continue\n        except:\n            if t == 3:\n                new_u = u\n                print(f\"{u} 无法上传：{e}\")\n    url_dict[u] = new_u\n    print(f\"{i} / {len(pic_urls)}\")\n\n# 对 _files 列表中的文件一一完成替换\nfor file in _files:\n    with open(file, 'r') as f:\n        content = f.read()\n    for k, v in url_dict.items():\n        content = content.replace(k, v)\n    with open(file, 'w') as f:\n        f.write(content)\n    print(\"完成替换：\", file)\n","python",[51,1363,1364,1372,1379,1386,1390,1395,1405,1413,1420,1425,1430,1434,1444,1448,1457,1461,1466,1518,1522,1527,1545,1550,1555,1559,1563,1568,1592,1605,1625,1646,1668,1684,1700,1708,1719,1730,1734,1739,1756,1774,1778,1788,1792,1797,1823,1847,1855,1867,1872,1879,1893,1903,1937,1947,1981,1985,1990,2001,2022,2035,2053,2068,2089,2100],{"__ignoreMap":49},[54,1365,1366,1369],{"class":56,"line":57},[54,1367,1368],{"class":185},"import",[54,1370,1371],{"class":199}," os\n",[54,1373,1374,1376],{"class":56,"line":64},[54,1375,1368],{"class":185},[54,1377,1378],{"class":199}," re\n",[54,1380,1381,1383],{"class":56,"line":71},[54,1382,1368],{"class":185},[54,1384,1385],{"class":199}," requests\n",[54,1387,1388],{"class":56,"line":86},[54,1389,68],{"emptyLinePlaceholder":67},[54,1391,1392],{"class":56,"line":97},[54,1393,1394],{"class":60},"# 哪些后缀的文件需要检测是否存在老图床的 URL 并进行迁移？\n",[54,1396,1397,1400,1402],{"class":56,"line":115},[54,1398,1399],{"class":199},"file_extension ",[54,1401,79],{"class":78},[54,1403,1404],{"class":199}," [\n",[54,1406,1407,1410],{"class":56,"line":120},[54,1408,1409],{"class":82},"    '.md'",[54,1411,1412],{"class":199},",\n",[54,1414,1415,1418],{"class":56,"line":131},[54,1416,1417],{"class":82},"    '.yml'",[54,1419,1412],{"class":199},[54,1421,1422],{"class":56,"line":136},[54,1423,1424],{"class":82},"    '.html'\n",[54,1426,1427],{"class":56,"line":147},[54,1428,1429],{"class":199},"]\n",[54,1431,1432],{"class":56,"line":157},[54,1433,68],{"emptyLinePlaceholder":67},[54,1435,1436,1439,1441],{"class":56,"line":167},[54,1437,1438],{"class":199},"pic_urls ",[54,1440,79],{"class":78},[54,1442,1443],{"class":199}," []\n",[54,1445,1446],{"class":56,"line":177},[54,1447,68],{"emptyLinePlaceholder":67},[54,1449,1450,1453,1455],{"class":56,"line":182},[54,1451,1452],{"class":199},"_files ",[54,1454,79],{"class":78},[54,1456,1443],{"class":199},[54,1458,1459],{"class":56,"line":206},[54,1460,68],{"emptyLinePlaceholder":67},[54,1462,1463],{"class":56,"line":218},[54,1464,1465],{"class":60},"# 用于匹配老图床的正则表达式，这里是按照 lsky pro 的格式编写的\n",[54,1467,1468,1471,1473,1476,1479,1483,1486,1489,1491,1493,1495,1498,1501,1504,1507,1509,1512,1515],{"class":56,"line":243},[54,1469,1470],{"class":199},"pattern ",[54,1472,79],{"class":78},[54,1474,1475],{"class":185}," r",[54,1477,1478],{"class":221},"'https://cdn.example.com/\\d",[54,1480,1482],{"class":1481},"sYebD","{4}",[54,1484,1485],{"class":221},"/\\d",[54,1487,1488],{"class":1481},"{2}",[54,1490,1485],{"class":221},[54,1492,1488],{"class":1481},[54,1494,399],{"class":221},[54,1496,1497],{"class":1481},"[",[54,1499,1500],{"class":373},"a-z0-9",[54,1502,1503],{"class":1481},"]{13}",[54,1505,1506],{"class":189},"\\.",[54,1508,1497],{"class":1481},[54,1510,1511],{"class":373},"a-z",[54,1513,1514],{"class":1481},"]{3,4}",[54,1516,1517],{"class":221},"'\n",[54,1519,1520],{"class":56,"line":263},[54,1521,68],{"emptyLinePlaceholder":67},[54,1523,1524],{"class":56,"line":283},[54,1525,1526],{"class":60},"# 图片的上传部分，需要先从原 url 中下载图片，在上传到新图床中，如果需要的话可以在中途转换为 webp 格式\n",[54,1528,1529,1532,1535,1538,1542],{"class":56,"line":303},[54,1530,1531],{"class":185},"def",[54,1533,1534],{"class":108}," upload",[54,1536,1537],{"class":199},"(",[54,1539,1541],{"class":1540},"so_Uh","url",[54,1543,1544],{"class":199},"):\n",[54,1546,1547],{"class":56,"line":325},[54,1548,1549],{"class":82},"    \"\"\"\n",[54,1551,1552],{"class":56,"line":346},[54,1553,1554],{"class":82},"    此处的返回值应该是新的 url\n",[54,1556,1557],{"class":56,"line":352},[54,1558,1549],{"class":82},[54,1560,1561],{"class":56,"line":358},[54,1562,68],{"emptyLinePlaceholder":67},[54,1564,1565],{"class":56,"line":380},[54,1566,1567],{"class":60},"# 遍历目标后缀文件名的文件，如果存在老图床的 url，则将 url 加入到 pic_urls 列表中，并将这个文件的文件名（相对路径）添加到 _files 列表中\n",[54,1569,1570,1572,1575,1578,1581,1585,1587,1590],{"class":56,"line":385},[54,1571,474],{"class":185},[54,1573,1574],{"class":199}," root, dirs, files ",[54,1576,1577],{"class":185},"in",[54,1579,1580],{"class":199}," os.",[54,1582,1584],{"class":1583},"slOjB","walk",[54,1586,1537],{"class":199},[54,1588,1589],{"class":82},"\".\"",[54,1591,1544],{"class":199},[54,1593,1594,1597,1600,1602],{"class":56,"line":408},[54,1595,1596],{"class":185},"    for",[54,1598,1599],{"class":74}," file",[54,1601,480],{"class":185},[54,1603,1604],{"class":199}," files:\n",[54,1606,1607,1610,1612,1614,1617,1619,1622],{"class":56,"line":433},[54,1608,1609],{"class":185},"        if",[54,1611,1599],{"class":74},[54,1613,551],{"class":199},[54,1615,1616],{"class":1583},"endswith",[54,1618,1537],{"class":199},[54,1620,1621],{"class":189},"tuple",[54,1623,1624],{"class":199},"(file_extension)):\n",[54,1626,1627,1630,1632,1635,1638,1641,1644],{"class":56,"line":460},[54,1628,1629],{"class":199},"            file_name ",[54,1631,79],{"class":78},[54,1633,1634],{"class":199}," os.path.",[54,1636,1637],{"class":1583},"join",[54,1639,1640],{"class":199},"(root, ",[54,1642,1643],{"class":74},"file",[54,1645,639],{"class":199},[54,1647,1648,1651,1654,1657,1660,1662,1665],{"class":56,"line":466},[54,1649,1650],{"class":185},"            with",[54,1652,1653],{"class":189}," open",[54,1655,1656],{"class":199},"(file_name, ",[54,1658,1659],{"class":82},"'r'",[54,1661,230],{"class":199},[54,1663,1664],{"class":185},"as",[54,1666,1667],{"class":199}," f:\n",[54,1669,1670,1673,1675,1678,1681],{"class":56,"line":471},[54,1671,1672],{"class":199},"                content ",[54,1674,79],{"class":78},[54,1676,1677],{"class":199}," f.",[54,1679,1680],{"class":1583},"read",[54,1682,1683],{"class":199},"()\n",[54,1685,1686,1689,1691,1694,1697],{"class":56,"line":496},[54,1687,1688],{"class":199},"            urls ",[54,1690,79],{"class":78},[54,1692,1693],{"class":199}," re.",[54,1695,1696],{"class":1583},"findall",[54,1698,1699],{"class":199},"(pattern, content)\n",[54,1701,1702,1705],{"class":56,"line":523},[54,1703,1704],{"class":185},"            if",[54,1706,1707],{"class":199}," urls:\n",[54,1709,1710,1713,1716],{"class":56,"line":562},[54,1711,1712],{"class":199},"                pic_urls.",[54,1714,1715],{"class":1583},"extend",[54,1717,1718],{"class":199},"(urls)\n",[54,1720,1721,1724,1727],{"class":56,"line":586},[54,1722,1723],{"class":199},"                _files.",[54,1725,1726],{"class":1583},"append",[54,1728,1729],{"class":199},"(file_name)\n",[54,1731,1732],{"class":56,"line":592},[54,1733,68],{"emptyLinePlaceholder":67},[54,1735,1736],{"class":56,"line":597},[54,1737,1738],{"class":60},"# 先转为集合，再转回列表，进行去重\n",[54,1740,1741,1743,1745,1748,1750,1753],{"class":56,"line":619},[54,1742,1438],{"class":199},[54,1744,79],{"class":78},[54,1746,1747],{"class":189}," list",[54,1749,1537],{"class":199},[54,1751,1752],{"class":189},"set",[54,1754,1755],{"class":199},"(pic_urls))\n",[54,1757,1758,1761,1763,1766,1769,1772],{"class":56,"line":642},[54,1759,1760],{"class":189},"print",[54,1762,1537],{"class":199},[54,1764,1765],{"class":82},"\"共找到图片：\"",[54,1767,1768],{"class":199},", ",[54,1770,1771],{"class":189},"len",[54,1773,1755],{"class":199},[54,1775,1776],{"class":56,"line":648},[54,1777,68],{"emptyLinePlaceholder":67},[54,1779,1780,1783,1785],{"class":56,"line":693},[54,1781,1782],{"class":199},"url_dict ",[54,1784,79],{"class":78},[54,1786,1787],{"class":199}," {}\n",[54,1789,1790],{"class":56,"line":698},[54,1791,68],{"emptyLinePlaceholder":67},[54,1793,1794],{"class":56,"line":703},[54,1795,1796],{"class":60},"# 将列表中的图片进行上传，每张图片最多尝试三次上传，如果三次都失败，则保留原连接\n",[54,1798,1799,1801,1804,1806,1809,1812,1816,1818,1821],{"class":56,"line":725},[54,1800,474],{"class":185},[54,1802,1803],{"class":199}," i,u ",[54,1805,1577],{"class":185},[54,1807,1808],{"class":189}," enumerate",[54,1810,1811],{"class":199},"(pci_urls, ",[54,1813,1815],{"class":1814},"sp7wS","start",[54,1817,79],{"class":78},[54,1819,1820],{"class":373},"1",[54,1822,1544],{"class":199},[54,1824,1825,1827,1830,1832,1835,1837,1839,1842,1845],{"class":56,"line":765},[54,1826,1596],{"class":185},[54,1828,1829],{"class":199}," t ",[54,1831,1577],{"class":185},[54,1833,1834],{"class":189}," range",[54,1836,1537],{"class":199},[54,1838,1820],{"class":373},[54,1840,1841],{"class":199},",",[54,1843,1844],{"class":373},"4",[54,1846,1544],{"class":199},[54,1848,1849,1852],{"class":56,"line":776},[54,1850,1851],{"class":185},"        try",[54,1853,1854],{"class":199},":\n",[54,1856,1857,1860,1862,1864],{"class":56,"line":791},[54,1858,1859],{"class":199},"            new_u ",[54,1861,79],{"class":78},[54,1863,1534],{"class":1583},[54,1865,1866],{"class":199},"(u)\n",[54,1868,1869],{"class":56,"line":807},[54,1870,1871],{"class":185},"            continue\n",[54,1873,1874,1877],{"class":56,"line":817},[54,1875,1876],{"class":185},"        except",[54,1878,1854],{"class":199},[54,1880,1881,1883,1885,1888,1891],{"class":56,"line":823},[54,1882,1704],{"class":185},[54,1884,1829],{"class":199},[54,1886,1887],{"class":78},"==",[54,1889,1890],{"class":373}," 3",[54,1892,1854],{"class":199},[54,1894,1895,1898,1900],{"class":56,"line":828},[54,1896,1897],{"class":199},"                new_u ",[54,1899,79],{"class":78},[54,1901,1902],{"class":199}," u\n",[54,1904,1905,1908,1910,1913,1915,1918,1921,1923,1926,1928,1931,1933,1935],{"class":56,"line":861},[54,1906,1907],{"class":189},"                print",[54,1909,1537],{"class":199},[54,1911,1912],{"class":185},"f",[54,1914,341],{"class":82},[54,1916,1917],{"class":373},"{",[54,1919,1920],{"class":199},"u",[54,1922,455],{"class":373},[54,1924,1925],{"class":82}," 无法上传：",[54,1927,1917],{"class":373},[54,1929,1930],{"class":199},"e",[54,1932,455],{"class":373},[54,1934,341],{"class":82},[54,1936,639],{"class":199},[54,1938,1939,1942,1944],{"class":56,"line":870},[54,1940,1941],{"class":199},"    url_dict[u] ",[54,1943,79],{"class":78},[54,1945,1946],{"class":199}," new_u\n",[54,1948,1949,1952,1954,1956,1958,1960,1963,1965,1968,1970,1972,1975,1977,1979],{"class":56,"line":883},[54,1950,1951],{"class":189},"    print",[54,1953,1537],{"class":199},[54,1955,1912],{"class":185},[54,1957,341],{"class":82},[54,1959,1917],{"class":373},[54,1961,1962],{"class":199},"i",[54,1964,455],{"class":373},[54,1966,1967],{"class":82}," / ",[54,1969,1917],{"class":373},[54,1971,1771],{"class":189},[54,1973,1974],{"class":199},"(pic_urls)",[54,1976,455],{"class":373},[54,1978,341],{"class":82},[54,1980,639],{"class":199},[54,1982,1983],{"class":56,"line":896},[54,1984,68],{"emptyLinePlaceholder":67},[54,1986,1987],{"class":56,"line":901},[54,1988,1989],{"class":60},"# 对 _files 列表中的文件一一完成替换\n",[54,1991,1992,1994,1996,1998],{"class":56,"line":906},[54,1993,474],{"class":185},[54,1995,1599],{"class":74},[54,1997,480],{"class":185},[54,1999,2000],{"class":199}," _files:\n",[54,2002,2003,2006,2008,2010,2012,2014,2016,2018,2020],{"class":56,"line":911},[54,2004,2005],{"class":185},"    with",[54,2007,1653],{"class":189},[54,2009,1537],{"class":199},[54,2011,1643],{"class":74},[54,2013,1768],{"class":199},[54,2015,1659],{"class":82},[54,2017,230],{"class":199},[54,2019,1664],{"class":185},[54,2021,1667],{"class":199},[54,2023,2024,2027,2029,2031,2033],{"class":56,"line":941},[54,2025,2026],{"class":199},"        content ",[54,2028,79],{"class":78},[54,2030,1677],{"class":199},[54,2032,1680],{"class":1583},[54,2034,1683],{"class":199},[54,2036,2037,2039,2042,2044,2047,2050],{"class":56,"line":946},[54,2038,1596],{"class":185},[54,2040,2041],{"class":199}," k, v ",[54,2043,1577],{"class":185},[54,2045,2046],{"class":199}," url_dict.",[54,2048,2049],{"class":1583},"items",[54,2051,2052],{"class":199},"():\n",[54,2054,2055,2057,2059,2062,2065],{"class":56,"line":966},[54,2056,2026],{"class":199},[54,2058,79],{"class":78},[54,2060,2061],{"class":199}," content.",[54,2063,2064],{"class":1583},"replace",[54,2066,2067],{"class":199},"(k, v)\n",[54,2069,2070,2072,2074,2076,2078,2080,2083,2085,2087],{"class":56,"line":989},[54,2071,2005],{"class":185},[54,2073,1653],{"class":189},[54,2075,1537],{"class":199},[54,2077,1643],{"class":74},[54,2079,1768],{"class":199},[54,2081,2082],{"class":82},"'w'",[54,2084,230],{"class":199},[54,2086,1664],{"class":185},[54,2088,1667],{"class":199},[54,2090,2091,2094,2097],{"class":56,"line":994},[54,2092,2093],{"class":199},"        f.",[54,2095,2096],{"class":1583},"write",[54,2098,2099],{"class":199},"(content)\n",[54,2101,2102,2104,2106,2109,2111,2113],{"class":56,"line":1011},[54,2103,1951],{"class":189},[54,2105,1537],{"class":199},[54,2107,2108],{"class":82},"\"完成替换：\"",[54,2110,1768],{"class":199},[54,2112,1643],{"class":74},[54,2114,639],{"class":199},[2116,2117,2118],"style",{},"html pre.shiki code .sW2Sy, html code.shiki .sW2Sy{--shiki-default:#A0A1A7;--shiki-default-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic}html pre.shiki code .sJa8x, html code.shiki .sJa8x{--shiki-default:#E45649;--shiki-dark:#E06C75}html pre.shiki code .sknuh, html code.shiki .sknuh{--shiki-default:#383A42;--shiki-dark:#56B6C2}html pre.shiki code .sDhpE, html code.shiki .sDhpE{--shiki-default:#50A14F;--shiki-dark:#98C379}html pre.shiki code .sAdtL, html code.shiki .sAdtL{--shiki-default:#4078F2;--shiki-dark:#61AFEF}html pre.shiki code .sLKXg, html code.shiki .sLKXg{--shiki-default:#A626A4;--shiki-dark:#C678DD}html pre.shiki code .s_Sar, html code.shiki .s_Sar{--shiki-default:#0184BC;--shiki-dark:#56B6C2}html pre.shiki code .s5ixo, html code.shiki .s5ixo{--shiki-default:#383A42;--shiki-dark:#ABB2BF}html pre.shiki code .sDaw7, html code.shiki .sDaw7{--shiki-default:#0184BC;--shiki-dark:#E06C75}html pre.shiki code .sAGMh, html code.shiki .sAGMh{--shiki-default:#986801;--shiki-dark:#D19A66}html pre.shiki code .sTIpt, html code.shiki .sTIpt{--shiki-default:#E45649;--shiki-dark:#98C379}html pre.shiki code .s8iYz, html code.shiki .s8iYz{--shiki-default:#383A42;--shiki-default-font-style:inherit;--shiki-dark:#E06C75;--shiki-dark-font-style:italic}html .default .shiki span {color: var(--shiki-default);background: var(--shiki-default-bg);font-style: var(--shiki-default-font-style);font-weight: var(--shiki-default-font-weight);text-decoration: var(--shiki-default-text-decoration);}html .shiki span {color: var(--shiki-default);background: var(--shiki-default-bg);font-style: var(--shiki-default-font-style);font-weight: var(--shiki-default-font-weight);text-decoration: var(--shiki-default-text-decoration);}html .dark .shiki span {color: var(--shiki-dark);background: var(--shiki-dark-bg);font-style: var(--shiki-dark-font-style);font-weight: var(--shiki-dark-font-weight);text-decoration: var(--shiki-dark-text-decoration);}html.dark .shiki span {color: var(--shiki-dark);background: var(--shiki-dark-bg);font-style: var(--shiki-dark-font-style);font-weight: var(--shiki-dark-font-weight);text-decoration: var(--shiki-dark-text-decoration);}html pre.shiki code .sYebD, html code.shiki .sYebD{--shiki-default:#383A42;--shiki-dark:#D19A66}html pre.shiki code .so_Uh, html code.shiki .so_Uh{--shiki-default:#986801;--shiki-default-font-style:inherit;--shiki-dark:#D19A66;--shiki-dark-font-style:italic}html pre.shiki code .slOjB, html code.shiki .slOjB{--shiki-default:#383A42;--shiki-dark:#61AFEF}html pre.shiki code .sp7wS, html code.shiki .sp7wS{--shiki-default:#986801;--shiki-default-font-style:inherit;--shiki-dark:#E06C75;--shiki-dark-font-style:italic}",{"title":49,"searchDepth":64,"depth":64,"links":2120},[2121,2122],{"id":32,"depth":64,"text":32},{"id":1353,"depth":64,"text":1353},"2024-08-20 23:12:30","前面三篇小记分别讲述了图床的整体架构、用 Workers 构建 Restful API 和 自动更新部署 SSL 证书，这一篇c处理由此带来的图片上传问题，主要是要为 Typora 编写自动上传脚本，并为博客原有的图片进行迁移。","md","zh-CN",{},"/2024/08/20/picbed-upload-script-and-image-migration","---\ntitle: 自建图床小记四——上传脚本编写与图片迁移\ndate: 2024-08-20 23:12:30\nsticky:\ntags:\n- Python\n- Image Hosting\n- Linux\n- Network\n- Shell Script\n---\n\n前面三篇小记分别讲述了[图床的整体架构](/2024/08/12/new-picbed-based-on-cloudflare-and-upyun/)、[用 Workers 构建 Restful API](/2024/08/13/build-restful-api-for-cloudflare-r2-with-cloudflare-workers/) 和 [自动更新部署 SSL 证书](/2024/08/14/auto-renew-ssl-certificate-and-deploy-to-upyun-with-github-action/)，这一篇c处理由此带来的图片上传问题，主要是要为 Typora 编写自动上传脚本，并为博客原有的图片进行迁移。\n\n## 自动上传脚本\n\n主要还是给 Typora 用，实现这种效果\n\n![Typora 自动上传](https://static.031130.xyz/uploads/2024/08/12/62f3b881e3c4c.gif)\n\n```bash\n#!/bin/bash\n\nHOST=\"upload.example.com\"\nCDN_HOST=\"cdn.example.com\"\nUPLOAD_PATH=\"uploads/$(date +%Y/%m/%d)\"\n\nAUTH_TOKEN=\"1145141919810\"\n\nwebp=false\nmarkdown=false\nforce=false\nkeep=false\n\nwhile getopts \":mwfkp:\" opt; do\n    case $opt in\n        m|markdown) markdown=true ;;\n        w|webp) webp=true ;;\n        f|force) force=true ;;\n        k|keep) keep=true ;;\n        p|path) UPLOAD_PATH=$OPTARG ;;\n        \\?) echo \"Invalid option: -$OPTARG\" ;;\n    esac\ndone\nshift $((OPTIND - 1))\n\nUPLOAD_URL=\"https://$HOST/$UPLOAD_PATH\"\nif [[ \"$UPLOAD_URL\" == */ ]]; then\n    UPLOAD_URL=\"${UPLOAD_URL%?}\"\nfi\n\nfor image in \"$@\"; do\n    if [ \"$webp\" = true ]; then\n        cwebp -quiet \"$image\" -o \"${image%.*}.webp\"\n        image=\"${image%.*}.webp\"\n    fi\n\n    if [ \"$keep\" = true ]; then\n        FILENAME=$(basename \"$image\")\n    else\n        FILENAME=\"$(md5sum $image | cut -c 1-13).$(basename $image | cut -d. -f2)\"\n    fi\n\n    if [ \"$force\" = true ]; then\n        UPLOAD_RESPONSE=$(curl -s -X PUT \"${UPLOAD_URL}/$FILENAME\" \\\n            -w \"%{http_code}\" \\\n            --data-binary @\"$image\" \\\n            -H \"X-Custom-Auth-Key: $AUTH_TOKEN\" \\\n            -H \"Overwrite: true\" \\\n        )\n    else\n        UPLOAD_RESPONSE=$(curl -s -X PUT \"${UPLOAD_URL}/$FILENAME\" \\\n            -w \"%{http_code}\" \\\n            --data-binary @\"$image\" \\\n            -H \"X-Custom-Auth-Key: $AUTH_TOKEN\" \\\n        )\n    fi\n\n    UPLOAD_HTTP_CODE=$(echo \"$UPLOAD_RESPONSE\" | tail -n1)\n\n    if [ -n \"$UPLOAD_PATH\" ]; then\n        CDN_URL=\"https://$CDN_HOST/$UPLOAD_PATH/$FILENAME\"\n    else\n        CDN_URL=\"https://$CDN_HOST/$FILENAME\"\n    fi\n\n    if [ \"$UPLOAD_HTTP_CODE\" != \"200\" ]; then\n        echo \"上传失败: $UPLOAD_RESPONSE\"\n        continue\n    fi\n\n    if [ \"$markdown\" = true ]; then\n        echo \"![](${CDN_URL})\"\n    else\n        echo \"${CDN_URL}\"\n    fi\ndone\n```\n\n这一次使用 Cloudflare Workers 构建的 Restful API 很有意思，使用了 `GET`、`PUT` 和 `DELETE` 三个请求类型。`GET` 请求很常见，是用来获取图片的，`PUT` 和 `DELETE` 在 web 开发就不如 `GET` 和 `POST` 常见了，这一次也是让我体会到了这两个 http verb 在 Storage Bucket 操作中是有多么形象了。\n\n- `PUT` - 从直观上来讲，就是将某个文件放到目标位置\n\n  打个比方，我向 `https://cdn.example.com/img/avatar.webp` 打了一个请求，并带上了要上传的文件，那就意味着我将这个文件放到了 Storage Bucket 的 `/img/avatar.webp` 这个位置，所以我在上传后，应该就能用 `GET` 请求我刚才 `PUT` 的那个 URL 获取我刚才上传的东西。如果那个路径存在文件，那么默认行为是直接覆盖。\n\n- `DELETE` - 删除目标路径的文件\n\n  和 `PUT` 一样，我在请求对应 URL 后，Storage Bucket 中对应 URL 路径的资源应该被删除。\n\n`PUT` 和 `DELETE` 这两个 Http Verb 让我们更像是在对一个真实的文件系统进行操作，而非那种传统的使用 `POST` 上传的图床那样，我们并不通过 POST 请求上传一个文件，然后获取资源最终被放置位置的 URL —— 我们自己决定资源被存放的位置。\n\n在这个 Shell 脚本中，引入了四个可选选项\n\n```bash\n    m|markdown) markdown=true ;;\n    w|webp) webp=true ;;\n    f|force) force=true ;;\n    k|keep) keep=true ;;\n    p|path) UPLOAD_PATH=$OPTARG ;;\n```\n\n- markdown 选项决定返回值是否以 `![]()` 这种 URL 格式返回\n- webp 决定上传过程中是否将图片转为 webp 后再上传\n- force 决定如果遇到文件路径冲突，是否强制覆盖云端的文件\n- keep 决定是否保留文件原有的文件名进行上传\n- path 决定文件具体被存放的路径（或者使用默认的路径）\n\n`HOST` 是图床用于上传的地址，`CDN_HOST` 是图床用于被方可访问的地址。\n\n由于急着用，也没考虑协程的处理方式，等等看后期有没有时间用 Python 重写吧。\n\n## 博客图床迁移脚本\n\n因为只用一次，所以也没使用协程或者多线程的方式去上传文件——毕竟图片不多，也就两三百张。\n\n```python\nimport os\nimport re\nimport requests\n\n# 哪些后缀的文件需要检测是否存在老图床的 URL 并进行迁移？\nfile_extension = [\n    '.md',\n    '.yml',\n    '.html'\n]\n\npic_urls = []\n\n_files = []\n\n# 用于匹配老图床的正则表达式，这里是按照 lsky pro 的格式编写的\npattern = r'https://cdn.example.com/\\d{4}/\\d{2}/\\d{2}/[a-z0-9]{13}\\.[a-z]{3,4}'\n\n# 图片的上传部分，需要先从原 url 中下载图片，在上传到新图床中，如果需要的话可以在中途转换为 webp 格式\ndef upload(url):\n    \"\"\"\n    此处的返回值应该是新的 url\n    \"\"\"\n\n# 遍历目标后缀文件名的文件，如果存在老图床的 url，则将 url 加入到 pic_urls 列表中，并将这个文件的文件名（相对路径）添加到 _files 列表中\nfor root, dirs, files in os.walk(\".\"):\n    for file in files:\n        if file.endswith(tuple(file_extension)):\n            file_name = os.path.join(root, file)\n            with open(file_name, 'r') as f:\n                content = f.read()\n            urls = re.findall(pattern, content)\n            if urls:\n                pic_urls.extend(urls)\n                _files.append(file_name)\n\n# 先转为集合，再转回列表，进行去重\npic_urls = list(set(pic_urls))\nprint(\"共找到图片：\", len(pic_urls))\n\nurl_dict = {}\n\n# 将列表中的图片进行上传，每张图片最多尝试三次上传，如果三次都失败，则保留原连接\nfor i,u in enumerate(pci_urls, start=1):\n    for t in range(1,4):\n        try:\n            new_u = upload(u)\n            continue\n        except:\n            if t == 3:\n                new_u = u\n                print(f\"{u} 无法上传：{e}\")\n\turl_dict[u] = new_u\n    print(f\"{i} / {len(pic_urls)}\")\n\n# 对 _files 列表中的文件一一完成替换\nfor file in _files:\n    with open(file, 'r') as f:\n        content = f.read()\n    for k, v in url_dict.items():\n        content = content.replace(k, v)\n    with open(file, 'w') as f:\n        f.write(content)\n    print(\"完成替换：\", file)\n```\n\n",{"title":5,"description":2124},"posts/picbed-upload-script-and-image-migration",false,[2134,2135,2136,2137,2138],"Python","Image Hosting","Linux","Network","Shell Script","DfE2yJKoBJPOZFkRhCoP_L1tUwssPmlONqHj3N2NJ3Y",[2141,2146],{"title":2142,"path":2143,"stem":2144,"date":2145,"children":-1},"自建图床小记五——费用","/2024/08/21/self-host-cdn-expense","posts/self-host-cdn-expense","2024-08-21 00:05:15",{"title":2147,"path":2148,"stem":2149,"date":2150,"children":-1},"自建图床小记三—— SSL 证书的自动更新与部署","/2024/08/14/auto-renew-ssl-certificate-and-deploy-to-upyun-with-github-action","posts/auto-renew-ssl-certificate-and-deploy-to-upyun-with-github-action","2024-08-14 10:35:18",1762960742443]