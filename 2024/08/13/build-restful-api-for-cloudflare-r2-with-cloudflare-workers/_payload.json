[{"data":1,"prerenderedAt":1584},["ShallowReactive",2],{"post-2024-08-13-build-restful-api-for-cloudflare-r2-with-cloudflare-workers-zh":3,"surround-2024-08-13-build-restful-api-for-cloudflare-r2-with-cloudflare-workers-zh":1571,"randomIndex/2024/08/13/build-restful-api-for-cloudflare-r2-with-cloudflare-workers/":360,"language-switch-/2024/08/13/build-restful-api-for-cloudflare-r2-with-cloudflare-workers/-en":1583},{"title":4,"date":5,"path":6,"tags":7,"body":12,"description":212},"自建图床小记二——使用 Workers 为 R2 构建 Restful API","2024-08-13 22:58:26","/2024/08/13/build-restful-api-for-cloudflare-r2-with-cloudflare-workers",[8,9,10,11],"Image Hosting","Cloudflare","JavaScript","Python",{"type":13,"value":14,"toc":1553},"minimark",[15,20,24,29,36,40,46,49,55,59,62,65,74,80,83,90,92,97,101,105,108,114,118,123,139,144,148,151,155,169,175,177,182,186,189,199,203,206,1212,1215,1229,1232,1236,1239,1244,1248,1251,1254,1400,1403,1410,1413,1416,1518,1521,1549],[16,17,19],"h2",{"id":18},"访问-r2-的两种方式","访问 R2 的两种方式",[21,22,23],"p",{},"一般来说，想要访问 Cloudflare R2 中的文件，会有两种方式。",[25,26,28],"h3",{"id":27},"一种是在-r2-的设置界面设置自定义域","一种是在 R2 的设置界面设置自定义域",[21,30,31],{},[32,33],"img",{"alt":34,"src":35},"设置自定义域","https://static.031130.xyz/uploads/2024/08/13/61fe9ede194af.webp",[25,37,39],{"id":38},"另一种是通过-cloudflare-workers-进行访问","另一种是通过 Cloudflare Workers 进行访问",[21,41,42],{},[32,43],{"alt":44,"src":45},"通过 Cloudflare Workers","https://static.031130.xyz/uploads/2024/08/13/846164273571d.webp",[47,48],"hr",{},[21,50,51],{},[52,53,54],"strong",{},"那么应该选择哪种？选择 Cloudflare Workers！",[16,56,58],{"id":57},"为什么是-cloudflare-workers","为什么是 Cloudflare Workers？",[21,60,61],{},"要回答这个问题比较困难，但可以回答另一个问题——「为什么不设置自定义域实现直接访问？」",[25,63,64],{"id":64},"自定义域的访问存在限制",[21,66,67,68,73],{},"设置自定义域的访问方式存在较多的限制，让我们先来复习一下",[69,70,72],"a",{"href":71},"/2024/08/12/new-picbed-based-on-cloudflare-and-upyun/","上一篇博客中","提到的 DNS 解析方案 1",[21,75,76],{},[32,77],{"alt":78,"src":79},"DNS 解析方案 1","https://static.031130.xyz/uploads/2024/08/13/03d8243b67593.webp",[21,81,82],{},"在这里，我们需要将图床访问域名通过 NS 接入 DnsPod 实现境内外的分流，但 R2 所允许设置的自定义域必须是通过 NS 接入 Cloudflare 的，这存在冲突。那如果我们先将自定义域设置为通过 NS 接入 Cloudflare 的工具人域名，再将图床访问域名通过 CNAME 解析到工具人域名会不会有问题呢？恭喜你获得 403 Forbidden。",[21,84,85,86,89],{},"如果通过",[69,87,88],{"href":71},"上一篇文章","中的 DNS 解析方案 2 来进行 DNS 解析，能不能成功设置为 Cloudflare R2 的自定义域呢？也不行，Cloudflare R2 的自定义域会占用域名的解析，这意味着你无法将图床访问域名解析到用于分流的工具人域名。",[47,91],{},[21,93,94],{},[52,95,96],{},"结论：截至本文写作时间，设置自定义域的方案不适用于 DNS 分流的图床架构。",[25,98,100],{"id":99},"如何上传文件到-cloudflare-r2","如何上传文件到 Cloudflare R2？",[102,103,104],"h4",{"id":104},"网页端直接上传",[21,106,107],{},"最简单的上传方式是直接在 Cloudflare 进行网页上传，但这种方案不适合自动化脚本，也没法接入 Typora",[21,109,110],{},[32,111],{"alt":112,"src":113},"直接在网页端进行上传","https://static.031130.xyz/uploads/2024/08/13/b4d1b5b3edfae.webp",[102,115,117],{"id":116},"使用-amazon-s3-的兼容-api","使用 Amazon S3 的兼容 API",[119,120,122],"h5",{"id":121},"手动调用-s3-api","手动调用 S3 API",[21,124,125,126,132,133,138],{},"Cloudflare R2 被设计为兼容 Amazon S3 的存储方案，自然兼容 Amazon S3 的上传 API，在 ",[69,127,131],{"href":128,"rel":129},"https://developers.cloudflare.com/r2/api/s3/api/",[130],"nofollow","Cloudflare Docs 中有关于 S3 API 的实现情况","记载，大部分接口功能都是实现了的。但。。。但 S3 使用的是 ",[69,134,137],{"href":135,"rel":136},"https://docs.aws.amazon.com/zh_cn/IAM/latest/UserGuide/create-signed-request.html",[130],"AWS Signature"," 作为鉴权，你不会希望在每个自动化程序中都自己实现一次的。。。",[21,140,141],{},[32,142],{"alt":143,"src":143},"https://docs.aws.amazon.com/zh_cn/IAM/latest/UserGuide/images/sigV4-using-auth-header.png",[119,145,147],{"id":146},"使用-aws-cli-等-sdk","使用 aws-cli 等 SDK",[21,149,150],{},"使用 aws-cli 可以自动实现计算 AWS Signature，这是一种可行的方案，但我可能会在别的服务中使用到我的图床，不是所有的服务所处的环境都能够执行 shell 命令，也不是所有的编程语言都有现成的 SDK 可用。",[102,152,154],{"id":153},"使用-cloudflare-workers-构建-restful-api","使用 Cloudflare Workers 构建 Restful API",[21,156,157,162,163,168],{},[69,158,161],{"href":159,"rel":160},"https://developers.cloudflare.com/r2/api/workers/workers-api-usage/#5-access-your-r2-bucket-from-your-worker",[130],"在 Cloudflare Docs 中明确提出可以使用 Cloudflare Workers 访问 Cloudflare R2 Bucket，","通过 Workers 设置界面的按钮，可以非常方便的将 R2 Bucket 作为一个 R2Object 绑定到 JavaScript 的一个变量中，",[69,164,167],{"href":165,"rel":166},"https://developers.cloudflare.com/r2/api/workers/workers-api-reference/",[130],"这里有相关的开发文档","。",[21,170,171],{},[32,172],{"alt":173,"src":174},"绑定为变量","https://static.031130.xyz/uploads/2024/08/13/45e58b47f3aeb.webp",[47,176],{},[21,178,179],{},[52,180,181],{},"结论: 从易用性上来看，使用 Cloudflare Workers 构建 Restful API 这种上传文件的方案是最为合适的。",[16,183,185],{"id":184},"使用-cloudflare-workers-构建-restful-api-的方案有没有什么缺点","使用 Cloudflare Workers 构建 Restful API 的方案有没有什么缺点？",[21,187,188],{},"有。",[190,191,192,196],"ul",{},[193,194,195],"li",{},"Cloudflare Workers 的每日额度是有限的，在极端的流量下可能会用完（应该不会吧？）",[193,197,198],{},"Cloudflare Workers 的内存限制为 128MB，在上传下载 > 100MB 的文件时可能会出错。有这种体积上传需求的场景建议使用别的上传方案。",[16,200,202],{"id":201},"如何构建","如何构建？",[21,204,205],{},"直接贴代码",[207,208,213],"pre",{"className":209,"code":210,"language":211,"meta":212,"style":212},"language-javascript shiki shiki-themes one-light one-dark-pro","const hasValidHeader = (request, env) => {\n    return request.headers.get('X-Custom-Auth-Key') === env.AUTH_KEY_SECRET;\n};\n\nfunction authorizeRequest(request, env, key) {\n    switch (request.method) {\n        case 'PUT':\n        case 'DELETE':\n            return hasValidHeader(request, env);\n        case 'GET':\n            return true;\n        default:\n            return false;\n    }\n}\n\nexport default {\n    async fetch(request, env) {\n        const url = new URL(request.url);\n        const key = decodeURI(url.pathname.slice(1));\n\n        if (!authorizeRequest(request, env, key)) {\n            return new Response('Forbidden\\n', { status: 403 });\n        }\n\n        switch (request.method) {\n            case 'PUT':\n                const objectExists = await env.MY_BUCKET.get(key);\n\n                if (objectExists !== null) {\n                    if (request.headers.get('Overwrite') !== 'true') {\n                        return new Response('Object Already Exists\\n', { status: 409 });\n                    }\n                }\n\n                await env.MY_BUCKET.put(key, request.body);\n                return new Response(`Put ${key} successfully!\\n`);\n\n            case 'GET':\n                const object = await env.MY_BUCKET.get(key);\n\n                if (object === null) {\n                    return new Response('Object Not Found\\n', { status: 404 });\n                }\n\n                const headers = new Headers();\n                object.writeHttpMetadata(headers);\n                headers.set('etag', object.httpEtag);\n\n                return new Response(object.body, {\n                    headers,\n                });\n            case 'DELETE':\n                await env.MY_BUCKET.delete(key);\n                return new Response('Deleted!\\n');\n\n            default:\n                return new Response('Method Not Allowed\\n', {\n                    status: 405,\n                    headers: {\n                        Allow: 'PUT, GET, DELETE',\n                    },\n                });\n        }\n    },\n};\n","javascript","",[214,215,216,256,302,308,315,340,358,370,380,400,410,421,429,439,445,451,456,468,487,516,551,556,585,622,628,633,649,659,690,695,714,747,777,783,789,794,826,860,865,874,902,907,924,954,959,964,982,999,1026,1031,1051,1060,1066,1075,1097,1117,1122,1130,1150,1163,1172,1185,1191,1196,1201,1207],"code",{"__ignoreMap":212},[217,218,221,225,229,233,237,241,244,247,250,253],"span",{"class":219,"line":220},"line",1,[217,222,224],{"class":223},"sLKXg","const",[217,226,228],{"class":227},"sAdtL"," hasValidHeader",[217,230,232],{"class":231},"s_Sar"," =",[217,234,236],{"class":235},"s5ixo"," (",[217,238,240],{"class":239},"s8iYz","request",[217,242,243],{"class":235},", ",[217,245,246],{"class":239},"env",[217,248,249],{"class":235},") ",[217,251,252],{"class":223},"=>",[217,254,255],{"class":235}," {\n",[217,257,259,262,266,269,273,275,278,281,285,287,290,293,295,299],{"class":219,"line":258},2,[217,260,261],{"class":223},"    return",[217,263,265],{"class":264},"s7GmK"," request",[217,267,268],{"class":235},".",[217,270,272],{"class":271},"s2QsP","headers",[217,274,268],{"class":235},[217,276,277],{"class":227},"get",[217,279,280],{"class":235},"(",[217,282,284],{"class":283},"sDhpE","'X-Custom-Auth-Key'",[217,286,249],{"class":235},[217,288,289],{"class":231},"===",[217,291,292],{"class":264}," env",[217,294,268],{"class":235},[217,296,298],{"class":297},"sRZ4U","AUTH_KEY_SECRET",[217,300,301],{"class":235},";\n",[217,303,305],{"class":219,"line":304},3,[217,306,307],{"class":235},"};\n",[217,309,311],{"class":219,"line":310},4,[217,312,314],{"emptyLinePlaceholder":313},true,"\n",[217,316,318,321,324,326,328,330,332,334,337],{"class":219,"line":317},5,[217,319,320],{"class":223},"function",[217,322,323],{"class":227}," authorizeRequest",[217,325,280],{"class":235},[217,327,240],{"class":239},[217,329,243],{"class":235},[217,331,246],{"class":239},[217,333,243],{"class":235},[217,335,336],{"class":239},"key",[217,338,339],{"class":235},") {\n",[217,341,343,346,348,350,352,356],{"class":219,"line":342},6,[217,344,345],{"class":223},"    switch",[217,347,236],{"class":235},[217,349,240],{"class":264},[217,351,268],{"class":235},[217,353,355],{"class":354},"sJa8x","method",[217,357,339],{"class":235},[217,359,361,364,367],{"class":219,"line":360},7,[217,362,363],{"class":223},"        case",[217,365,366],{"class":283}," 'PUT'",[217,368,369],{"class":235},":\n",[217,371,373,375,378],{"class":219,"line":372},8,[217,374,363],{"class":223},[217,376,377],{"class":283}," 'DELETE'",[217,379,369],{"class":235},[217,381,383,386,388,390,393,395,397],{"class":219,"line":382},9,[217,384,385],{"class":223},"            return",[217,387,228],{"class":227},[217,389,280],{"class":235},[217,391,240],{"class":392},"sz0mV",[217,394,243],{"class":235},[217,396,246],{"class":392},[217,398,399],{"class":235},");\n",[217,401,403,405,408],{"class":219,"line":402},10,[217,404,363],{"class":223},[217,406,407],{"class":283}," 'GET'",[217,409,369],{"class":235},[217,411,413,415,419],{"class":219,"line":412},11,[217,414,385],{"class":223},[217,416,418],{"class":417},"sAGMh"," true",[217,420,301],{"class":235},[217,422,424,427],{"class":219,"line":423},12,[217,425,426],{"class":223},"        default",[217,428,369],{"class":235},[217,430,432,434,437],{"class":219,"line":431},13,[217,433,385],{"class":223},[217,435,436],{"class":417}," false",[217,438,301],{"class":235},[217,440,442],{"class":219,"line":441},14,[217,443,444],{"class":235},"    }\n",[217,446,448],{"class":219,"line":447},15,[217,449,450],{"class":235},"}\n",[217,452,454],{"class":219,"line":453},16,[217,455,314],{"emptyLinePlaceholder":313},[217,457,459,462,466],{"class":219,"line":458},17,[217,460,461],{"class":223},"export",[217,463,465],{"class":464},"sq3v1"," default",[217,467,255],{"class":235},[217,469,471,474,477,479,481,483,485],{"class":219,"line":470},18,[217,472,473],{"class":223},"    async",[217,475,476],{"class":227}," fetch",[217,478,280],{"class":235},[217,480,240],{"class":239},[217,482,243],{"class":235},[217,484,246],{"class":239},[217,486,339],{"class":235},[217,488,490,493,497,499,502,505,507,509,511,514],{"class":219,"line":489},19,[217,491,492],{"class":223},"        const",[217,494,496],{"class":495},"sNmU0"," url",[217,498,232],{"class":231},[217,500,501],{"class":223}," new",[217,503,504],{"class":227}," URL",[217,506,280],{"class":235},[217,508,240],{"class":264},[217,510,268],{"class":235},[217,512,513],{"class":354},"url",[217,515,399],{"class":235},[217,517,519,521,524,526,529,531,533,535,538,540,543,545,548],{"class":219,"line":518},20,[217,520,492],{"class":223},[217,522,523],{"class":495}," key",[217,525,232],{"class":231},[217,527,528],{"class":227}," decodeURI",[217,530,280],{"class":235},[217,532,513],{"class":264},[217,534,268],{"class":235},[217,536,537],{"class":271},"pathname",[217,539,268],{"class":235},[217,541,542],{"class":227},"slice",[217,544,280],{"class":235},[217,546,547],{"class":417},"1",[217,549,550],{"class":235},"));\n",[217,552,554],{"class":219,"line":553},21,[217,555,314],{"emptyLinePlaceholder":313},[217,557,559,562,564,567,570,572,574,576,578,580,582],{"class":219,"line":558},22,[217,560,561],{"class":223},"        if",[217,563,236],{"class":235},[217,565,566],{"class":231},"!",[217,568,569],{"class":227},"authorizeRequest",[217,571,280],{"class":235},[217,573,240],{"class":354},[217,575,243],{"class":235},[217,577,246],{"class":354},[217,579,243],{"class":235},[217,581,336],{"class":354},[217,583,584],{"class":235},")) {\n",[217,586,588,590,592,595,597,600,603,606,609,612,616,619],{"class":219,"line":587},23,[217,589,385],{"class":223},[217,591,501],{"class":223},[217,593,594],{"class":227}," Response",[217,596,280],{"class":235},[217,598,599],{"class":283},"'Forbidden",[217,601,602],{"class":231},"\\n",[217,604,605],{"class":283},"'",[217,607,608],{"class":235},", { ",[217,610,611],{"class":354},"status",[217,613,615],{"class":614},"st7oF",":",[217,617,618],{"class":417}," 403",[217,620,621],{"class":235}," });\n",[217,623,625],{"class":219,"line":624},24,[217,626,627],{"class":235},"        }\n",[217,629,631],{"class":219,"line":630},25,[217,632,314],{"emptyLinePlaceholder":313},[217,634,636,639,641,643,645,647],{"class":219,"line":635},26,[217,637,638],{"class":223},"        switch",[217,640,236],{"class":235},[217,642,240],{"class":264},[217,644,268],{"class":235},[217,646,355],{"class":354},[217,648,339],{"class":235},[217,650,652,655,657],{"class":219,"line":651},27,[217,653,654],{"class":223},"            case",[217,656,366],{"class":283},[217,658,369],{"class":235},[217,660,662,665,668,670,673,675,677,680,682,684,686,688],{"class":219,"line":661},28,[217,663,664],{"class":223},"                const",[217,666,667],{"class":495}," objectExists",[217,669,232],{"class":231},[217,671,672],{"class":223}," await",[217,674,292],{"class":264},[217,676,268],{"class":235},[217,678,679],{"class":271},"MY_BUCKET",[217,681,268],{"class":235},[217,683,277],{"class":227},[217,685,280],{"class":235},[217,687,336],{"class":354},[217,689,399],{"class":235},[217,691,693],{"class":219,"line":692},29,[217,694,314],{"emptyLinePlaceholder":313},[217,696,698,701,703,706,709,712],{"class":219,"line":697},30,[217,699,700],{"class":223},"                if",[217,702,236],{"class":235},[217,704,705],{"class":354},"objectExists",[217,707,708],{"class":231}," !==",[217,710,711],{"class":417}," null",[217,713,339],{"class":235},[217,715,717,720,722,724,726,728,730,732,734,737,739,742,745],{"class":219,"line":716},31,[217,718,719],{"class":223},"                    if",[217,721,236],{"class":235},[217,723,240],{"class":264},[217,725,268],{"class":235},[217,727,272],{"class":271},[217,729,268],{"class":235},[217,731,277],{"class":227},[217,733,280],{"class":235},[217,735,736],{"class":283},"'Overwrite'",[217,738,249],{"class":235},[217,740,741],{"class":231},"!==",[217,743,744],{"class":283}," 'true'",[217,746,339],{"class":235},[217,748,750,753,755,757,759,762,764,766,768,770,772,775],{"class":219,"line":749},32,[217,751,752],{"class":223},"                        return",[217,754,501],{"class":223},[217,756,594],{"class":227},[217,758,280],{"class":235},[217,760,761],{"class":283},"'Object Already Exists",[217,763,602],{"class":231},[217,765,605],{"class":283},[217,767,608],{"class":235},[217,769,611],{"class":354},[217,771,615],{"class":614},[217,773,774],{"class":417}," 409",[217,776,621],{"class":235},[217,778,780],{"class":219,"line":779},33,[217,781,782],{"class":235},"                    }\n",[217,784,786],{"class":219,"line":785},34,[217,787,788],{"class":235},"                }\n",[217,790,792],{"class":219,"line":791},35,[217,793,314],{"emptyLinePlaceholder":313},[217,795,797,800,802,804,806,808,811,813,815,817,819,821,824],{"class":219,"line":796},36,[217,798,799],{"class":223},"                await",[217,801,292],{"class":264},[217,803,268],{"class":235},[217,805,679],{"class":271},[217,807,268],{"class":235},[217,809,810],{"class":227},"put",[217,812,280],{"class":235},[217,814,336],{"class":354},[217,816,243],{"class":235},[217,818,240],{"class":264},[217,820,268],{"class":235},[217,822,823],{"class":354},"body",[217,825,399],{"class":235},[217,827,829,832,834,836,838,841,845,847,850,853,855,858],{"class":219,"line":828},37,[217,830,831],{"class":223},"                return",[217,833,501],{"class":223},[217,835,594],{"class":227},[217,837,280],{"class":235},[217,839,840],{"class":283},"`Put ",[217,842,844],{"class":843},"sAOjX","${",[217,846,336],{"class":354},[217,848,849],{"class":843},"}",[217,851,852],{"class":283}," successfully!",[217,854,602],{"class":231},[217,856,857],{"class":283},"`",[217,859,399],{"class":235},[217,861,863],{"class":219,"line":862},38,[217,864,314],{"emptyLinePlaceholder":313},[217,866,868,870,872],{"class":219,"line":867},39,[217,869,654],{"class":223},[217,871,407],{"class":283},[217,873,369],{"class":235},[217,875,877,879,882,884,886,888,890,892,894,896,898,900],{"class":219,"line":876},40,[217,878,664],{"class":223},[217,880,881],{"class":495}," object",[217,883,232],{"class":231},[217,885,672],{"class":223},[217,887,292],{"class":264},[217,889,268],{"class":235},[217,891,679],{"class":271},[217,893,268],{"class":235},[217,895,277],{"class":227},[217,897,280],{"class":235},[217,899,336],{"class":354},[217,901,399],{"class":235},[217,903,905],{"class":219,"line":904},41,[217,906,314],{"emptyLinePlaceholder":313},[217,908,910,912,914,917,920,922],{"class":219,"line":909},42,[217,911,700],{"class":223},[217,913,236],{"class":235},[217,915,916],{"class":354},"object",[217,918,919],{"class":231}," ===",[217,921,711],{"class":417},[217,923,339],{"class":235},[217,925,927,930,932,934,936,939,941,943,945,947,949,952],{"class":219,"line":926},43,[217,928,929],{"class":223},"                    return",[217,931,501],{"class":223},[217,933,594],{"class":227},[217,935,280],{"class":235},[217,937,938],{"class":283},"'Object Not Found",[217,940,602],{"class":231},[217,942,605],{"class":283},[217,944,608],{"class":235},[217,946,611],{"class":354},[217,948,615],{"class":614},[217,950,951],{"class":417}," 404",[217,953,621],{"class":235},[217,955,957],{"class":219,"line":956},44,[217,958,788],{"class":235},[217,960,962],{"class":219,"line":961},45,[217,963,314],{"emptyLinePlaceholder":313},[217,965,967,969,972,974,976,979],{"class":219,"line":966},46,[217,968,664],{"class":223},[217,970,971],{"class":495}," headers",[217,973,232],{"class":231},[217,975,501],{"class":223},[217,977,978],{"class":227}," Headers",[217,980,981],{"class":235},"();\n",[217,983,985,988,990,993,995,997],{"class":219,"line":984},47,[217,986,987],{"class":264},"                object",[217,989,268],{"class":235},[217,991,992],{"class":227},"writeHttpMetadata",[217,994,280],{"class":235},[217,996,272],{"class":354},[217,998,399],{"class":235},[217,1000,1002,1005,1007,1010,1012,1015,1017,1019,1021,1024],{"class":219,"line":1001},48,[217,1003,1004],{"class":264},"                headers",[217,1006,268],{"class":235},[217,1008,1009],{"class":227},"set",[217,1011,280],{"class":235},[217,1013,1014],{"class":283},"'etag'",[217,1016,243],{"class":235},[217,1018,916],{"class":264},[217,1020,268],{"class":235},[217,1022,1023],{"class":354},"httpEtag",[217,1025,399],{"class":235},[217,1027,1029],{"class":219,"line":1028},49,[217,1030,314],{"emptyLinePlaceholder":313},[217,1032,1034,1036,1038,1040,1042,1044,1046,1048],{"class":219,"line":1033},50,[217,1035,831],{"class":223},[217,1037,501],{"class":223},[217,1039,594],{"class":227},[217,1041,280],{"class":235},[217,1043,916],{"class":264},[217,1045,268],{"class":235},[217,1047,823],{"class":354},[217,1049,1050],{"class":235},", {\n",[217,1052,1054,1057],{"class":219,"line":1053},51,[217,1055,1056],{"class":354},"                    headers",[217,1058,1059],{"class":235},",\n",[217,1061,1063],{"class":219,"line":1062},52,[217,1064,1065],{"class":235},"                });\n",[217,1067,1069,1071,1073],{"class":219,"line":1068},53,[217,1070,654],{"class":223},[217,1072,377],{"class":283},[217,1074,369],{"class":235},[217,1076,1078,1080,1082,1084,1086,1088,1091,1093,1095],{"class":219,"line":1077},54,[217,1079,799],{"class":223},[217,1081,292],{"class":264},[217,1083,268],{"class":235},[217,1085,679],{"class":271},[217,1087,268],{"class":235},[217,1089,1090],{"class":227},"delete",[217,1092,280],{"class":235},[217,1094,336],{"class":354},[217,1096,399],{"class":235},[217,1098,1100,1102,1104,1106,1108,1111,1113,1115],{"class":219,"line":1099},55,[217,1101,831],{"class":223},[217,1103,501],{"class":223},[217,1105,594],{"class":227},[217,1107,280],{"class":235},[217,1109,1110],{"class":283},"'Deleted!",[217,1112,602],{"class":231},[217,1114,605],{"class":283},[217,1116,399],{"class":235},[217,1118,1120],{"class":219,"line":1119},56,[217,1121,314],{"emptyLinePlaceholder":313},[217,1123,1125,1128],{"class":219,"line":1124},57,[217,1126,1127],{"class":223},"            default",[217,1129,369],{"class":235},[217,1131,1133,1135,1137,1139,1141,1144,1146,1148],{"class":219,"line":1132},58,[217,1134,831],{"class":223},[217,1136,501],{"class":223},[217,1138,594],{"class":227},[217,1140,280],{"class":235},[217,1142,1143],{"class":283},"'Method Not Allowed",[217,1145,602],{"class":231},[217,1147,605],{"class":283},[217,1149,1050],{"class":235},[217,1151,1153,1156,1158,1161],{"class":219,"line":1152},59,[217,1154,1155],{"class":354},"                    status",[217,1157,615],{"class":614},[217,1159,1160],{"class":417}," 405",[217,1162,1059],{"class":235},[217,1164,1166,1168,1170],{"class":219,"line":1165},60,[217,1167,1056],{"class":354},[217,1169,615],{"class":614},[217,1171,255],{"class":235},[217,1173,1175,1178,1180,1183],{"class":219,"line":1174},61,[217,1176,1177],{"class":354},"                        Allow",[217,1179,615],{"class":614},[217,1181,1182],{"class":283}," 'PUT, GET, DELETE'",[217,1184,1059],{"class":235},[217,1186,1188],{"class":219,"line":1187},62,[217,1189,1190],{"class":235},"                    },\n",[217,1192,1194],{"class":219,"line":1193},63,[217,1195,1065],{"class":235},[217,1197,1199],{"class":219,"line":1198},64,[217,1200,627],{"class":235},[217,1202,1204],{"class":219,"line":1203},65,[217,1205,1206],{"class":235},"    },\n",[217,1208,1210],{"class":219,"line":1209},66,[217,1211,307],{"class":235},[21,1213,1214],{},"代码的大部分都是基于 Cloudflare Docs 中给出的样例，修改了几个小的优化点",[190,1216,1217,1220,1226],{},[193,1218,1219],{},"删除了 ALLOW_LIST 部分代码，默认所有文件都是可以被访问的",[193,1221,1222,1223],{},"在上传一个文件时，如果目标路径存在同名文件，则不直接覆盖，而是返回 409 的异常 HTTP 相应，如果想要强制覆盖，则需要在 Http Header 中加入 ",[214,1224,1225],{},"Overwrite: true",[193,1227,1228],{},"解出请求路径时，使用 decodeURI( ) 方法先进行解码，解决文件路径中含有中文时会导致请求失败的问题。",[21,1230,1231],{},"填入代码后，还需要绑定两个变量，一个是 R2 Bucket",[21,1233,1234],{},[32,1235],{"alt":212,"src":174},[21,1237,1238],{},"另一个是自己的管理密码",[21,1240,1241],{},[32,1242],{"alt":212,"src":1243},"https://static.031130.xyz/uploads/2024/08/14/96da1f62f5fe7.webp",[16,1245,1247],{"id":1246},"如何使用-cloudflare-workers-构建的-restful-api-进行文件操作","如何使用 Cloudflare Workers 构建的 Restful API 进行文件操作？",[25,1249,1250],{"id":1250},"上传",[21,1252,1253],{},"以 python 为例，上传一个文件 1MB.bin 到 /example/ 目录下，上传的 url 就是文件最终的存在路径。",[207,1255,1259],{"className":1256,"code":1257,"language":1258,"meta":212,"style":212},"language-python shiki shiki-themes one-light one-dark-pro","import requests\n\nAUTH_KEY_SECRET='1145141919810'\n\nwith open('1MB.bin', ''rb) as f:\n    file_content = f.read()\n\nrequests.put(\n    'https://r2.example.workers.dev/example/1MB.bin',\n    headers={\n        'X-Custom-Auth-Key': AUTH_KEY_SECRET,\n        'Overwrite': True   # 如果不需要强制覆盖可以删除这一行\n    }\n)\n","python",[214,1260,1261,1269,1273,1285,1289,1316,1333,1337,1347,1354,1365,1377,1391,1395],{"__ignoreMap":212},[217,1262,1263,1266],{"class":219,"line":220},[217,1264,1265],{"class":223},"import",[217,1267,1268],{"class":235}," requests\n",[217,1270,1271],{"class":219,"line":258},[217,1272,314],{"emptyLinePlaceholder":313},[217,1274,1275,1278,1282],{"class":219,"line":304},[217,1276,298],{"class":1277},"sYebD",[217,1279,1281],{"class":1280},"sknuh","=",[217,1283,1284],{"class":283},"'1145141919810'\n",[217,1286,1287],{"class":219,"line":310},[217,1288,314],{"emptyLinePlaceholder":313},[217,1290,1291,1294,1297,1299,1302,1304,1307,1310,1313],{"class":219,"line":317},[217,1292,1293],{"class":223},"with",[217,1295,1296],{"class":231}," open",[217,1298,280],{"class":235},[217,1300,1301],{"class":283},"'1MB.bin'",[217,1303,243],{"class":235},[217,1305,1306],{"class":283},"''",[217,1308,1309],{"class":235},"rb) ",[217,1311,1312],{"class":223},"as",[217,1314,1315],{"class":235}," f:\n",[217,1317,1318,1321,1323,1326,1330],{"class":219,"line":342},[217,1319,1320],{"class":235},"    file_content ",[217,1322,1281],{"class":1280},[217,1324,1325],{"class":235}," f.",[217,1327,1329],{"class":1328},"slOjB","read",[217,1331,1332],{"class":235},"()\n",[217,1334,1335],{"class":219,"line":360},[217,1336,314],{"emptyLinePlaceholder":313},[217,1338,1339,1342,1344],{"class":219,"line":372},[217,1340,1341],{"class":235},"requests.",[217,1343,810],{"class":1328},[217,1345,1346],{"class":235},"(\n",[217,1348,1349,1352],{"class":219,"line":382},[217,1350,1351],{"class":283},"    'https://r2.example.workers.dev/example/1MB.bin'",[217,1353,1059],{"class":235},[217,1355,1356,1360,1362],{"class":219,"line":402},[217,1357,1359],{"class":1358},"sp7wS","    headers",[217,1361,1281],{"class":1280},[217,1363,1364],{"class":235},"{\n",[217,1366,1367,1370,1373,1375],{"class":219,"line":412},[217,1368,1369],{"class":283},"        'X-Custom-Auth-Key'",[217,1371,1372],{"class":235},": ",[217,1374,298],{"class":1277},[217,1376,1059],{"class":235},[217,1378,1379,1382,1384,1387],{"class":219,"line":423},[217,1380,1381],{"class":283},"        'Overwrite'",[217,1383,1372],{"class":235},[217,1385,1386],{"class":417},"True",[217,1388,1390],{"class":1389},"sW2Sy","   # 如果不需要强制覆盖可以删除这一行\n",[217,1392,1393],{"class":219,"line":431},[217,1394,444],{"class":235},[217,1396,1397],{"class":219,"line":441},[217,1398,1399],{"class":235},")\n",[25,1401,1402],{"id":1402},"访问",[21,1404,1405,1406,1409],{},"通过浏览器直接访问 ",[214,1407,1408],{},"https://r2.example.workers.dev/example/1MB.bin"," 应该就能访问到",[25,1411,1412],{"id":1412},"删除",[21,1414,1415],{},"仍然以 python 为例，删除刚才的文件",[207,1417,1419],{"className":1256,"code":1418,"language":1258,"meta":212,"style":212},"import requests\n\nAUTH_KEY_SECRET='1145141919810'\n\nwith open('1MB.bin', ''rb) as f:\n    file_content = f.read()\n\nrequests.delete(\n    'https://r2.example.workers.dev/example/1MB.bin',\n    headers={\n        'X-Custom-Auth-Key': AUTH_KEY_SECRET\n    }\n)\n",[214,1420,1421,1427,1431,1439,1443,1463,1475,1479,1487,1493,1501,1510,1514],{"__ignoreMap":212},[217,1422,1423,1425],{"class":219,"line":220},[217,1424,1265],{"class":223},[217,1426,1268],{"class":235},[217,1428,1429],{"class":219,"line":258},[217,1430,314],{"emptyLinePlaceholder":313},[217,1432,1433,1435,1437],{"class":219,"line":304},[217,1434,298],{"class":1277},[217,1436,1281],{"class":1280},[217,1438,1284],{"class":283},[217,1440,1441],{"class":219,"line":310},[217,1442,314],{"emptyLinePlaceholder":313},[217,1444,1445,1447,1449,1451,1453,1455,1457,1459,1461],{"class":219,"line":317},[217,1446,1293],{"class":223},[217,1448,1296],{"class":231},[217,1450,280],{"class":235},[217,1452,1301],{"class":283},[217,1454,243],{"class":235},[217,1456,1306],{"class":283},[217,1458,1309],{"class":235},[217,1460,1312],{"class":223},[217,1462,1315],{"class":235},[217,1464,1465,1467,1469,1471,1473],{"class":219,"line":342},[217,1466,1320],{"class":235},[217,1468,1281],{"class":1280},[217,1470,1325],{"class":235},[217,1472,1329],{"class":1328},[217,1474,1332],{"class":235},[217,1476,1477],{"class":219,"line":360},[217,1478,314],{"emptyLinePlaceholder":313},[217,1480,1481,1483,1485],{"class":219,"line":372},[217,1482,1341],{"class":235},[217,1484,1090],{"class":1328},[217,1486,1346],{"class":235},[217,1488,1489,1491],{"class":219,"line":382},[217,1490,1351],{"class":283},[217,1492,1059],{"class":235},[217,1494,1495,1497,1499],{"class":219,"line":402},[217,1496,1359],{"class":1358},[217,1498,1281],{"class":1280},[217,1500,1364],{"class":235},[217,1502,1503,1505,1507],{"class":219,"line":412},[217,1504,1369],{"class":283},[217,1506,1372],{"class":235},[217,1508,1509],{"class":1277},"AUTH_KEY_SECRET\n",[217,1511,1512],{"class":219,"line":423},[217,1513,444],{"class":235},[217,1515,1516],{"class":219,"line":431},[217,1517,1399],{"class":235},[16,1519,1520],{"id":1520},"参见",[190,1522,1523,1530,1536,1543],{},[193,1524,1525],{},[69,1526,1529],{"href":1527,"rel":1528},"https://blog.yswtrue.com/yong-cloudflare-de-r2-he-worker-lai-zuo-wen-jian-tuo-guan/",[130],"用 cloudflare 的 R2 和 worker 来做文件托管",[193,1531,1532],{},[69,1533,1535],{"href":165,"rel":1534},[130],"Workers API reference",[193,1537,1538],{},[69,1539,1542],{"href":1540,"rel":1541},"https://developers.cloudflare.com/r2/api/workers/workers-api-usage/",[130],"Use R2 from Workers",[193,1544,1545],{},[69,1546,1548],{"href":135,"rel":1547},[130],"创建已签名的 AWS API 请求",[1550,1551,1552],"style",{},"html pre.shiki code .sLKXg, html code.shiki .sLKXg{--shiki-default:#A626A4;--shiki-dark:#C678DD}html pre.shiki code .sAdtL, html code.shiki .sAdtL{--shiki-default:#4078F2;--shiki-dark:#61AFEF}html pre.shiki code .s_Sar, html code.shiki .s_Sar{--shiki-default:#0184BC;--shiki-dark:#56B6C2}html pre.shiki code .s5ixo, html code.shiki .s5ixo{--shiki-default:#383A42;--shiki-dark:#ABB2BF}html pre.shiki code .s8iYz, html code.shiki .s8iYz{--shiki-default:#383A42;--shiki-default-font-style:inherit;--shiki-dark:#E06C75;--shiki-dark-font-style:italic}html pre.shiki code .s7GmK, html code.shiki .s7GmK{--shiki-default:#383A42;--shiki-dark:#E5C07B}html pre.shiki code .s2QsP, html code.shiki .s2QsP{--shiki-default:#E45649;--shiki-dark:#E5C07B}html pre.shiki code .sDhpE, html code.shiki .sDhpE{--shiki-default:#50A14F;--shiki-dark:#98C379}html pre.shiki code .sRZ4U, html code.shiki .sRZ4U{--shiki-default:#986801;--shiki-dark:#E06C75}html pre.shiki code .sJa8x, html code.shiki .sJa8x{--shiki-default:#E45649;--shiki-dark:#E06C75}html pre.shiki code .sz0mV, html code.shiki .sz0mV{--shiki-default:#383A42;--shiki-dark:#E06C75}html pre.shiki code .sAGMh, html code.shiki .sAGMh{--shiki-default:#986801;--shiki-dark:#D19A66}html pre.shiki code .sq3v1, html code.shiki .sq3v1{--shiki-default:#E45649;--shiki-dark:#C678DD}html pre.shiki code .sNmU0, html code.shiki .sNmU0{--shiki-default:#986801;--shiki-dark:#E5C07B}html pre.shiki code .st7oF, html code.shiki .st7oF{--shiki-default:#0184BC;--shiki-dark:#ABB2BF}html pre.shiki code .sAOjX, html code.shiki .sAOjX{--shiki-default:#CA1243;--shiki-dark:#C678DD}html .default .shiki span {color: var(--shiki-default);background: var(--shiki-default-bg);font-style: var(--shiki-default-font-style);font-weight: var(--shiki-default-font-weight);text-decoration: var(--shiki-default-text-decoration);}html .shiki span {color: var(--shiki-default);background: var(--shiki-default-bg);font-style: var(--shiki-default-font-style);font-weight: var(--shiki-default-font-weight);text-decoration: var(--shiki-default-text-decoration);}html .dark .shiki span {color: var(--shiki-dark);background: var(--shiki-dark-bg);font-style: var(--shiki-dark-font-style);font-weight: var(--shiki-dark-font-weight);text-decoration: var(--shiki-dark-text-decoration);}html.dark .shiki span {color: var(--shiki-dark);background: var(--shiki-dark-bg);font-style: var(--shiki-dark-font-style);font-weight: var(--shiki-dark-font-weight);text-decoration: var(--shiki-dark-text-decoration);}html pre.shiki code .sYebD, html code.shiki .sYebD{--shiki-default:#383A42;--shiki-dark:#D19A66}html pre.shiki code .sknuh, html code.shiki .sknuh{--shiki-default:#383A42;--shiki-dark:#56B6C2}html pre.shiki code .slOjB, html code.shiki .slOjB{--shiki-default:#383A42;--shiki-dark:#61AFEF}html pre.shiki code .sp7wS, html code.shiki .sp7wS{--shiki-default:#986801;--shiki-default-font-style:inherit;--shiki-dark:#E06C75;--shiki-dark-font-style:italic}html pre.shiki code .sW2Sy, html code.shiki .sW2Sy{--shiki-default:#A0A1A7;--shiki-default-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic}",{"title":212,"searchDepth":258,"depth":258,"links":1554},[1555,1559,1563,1564,1565,1570],{"id":18,"depth":258,"text":19,"children":1556},[1557,1558],{"id":27,"depth":304,"text":28},{"id":38,"depth":304,"text":39},{"id":57,"depth":258,"text":58,"children":1560},[1561,1562],{"id":64,"depth":304,"text":64},{"id":99,"depth":304,"text":100},{"id":184,"depth":258,"text":185},{"id":201,"depth":258,"text":202},{"id":1246,"depth":258,"text":1247,"children":1566},[1567,1568,1569],{"id":1250,"depth":304,"text":1250},{"id":1402,"depth":304,"text":1402},{"id":1412,"depth":304,"text":1412},{"id":1520,"depth":258,"text":1520},[1572,1578],{"title":1573,"path":1574,"stem":1575,"date":1576,"lang":1577,"children":-1},"自建图床小记三—— SSL 证书的自动更新与部署","/2024/08/14/auto-renew-ssl-certificate-and-deploy-to-upyun-with-github-action","posts/zh/auto-renew-ssl-certificate-and-deploy-to-upyun-with-github-action","2024-08-14 10:35:18","zh-CN",{"title":1579,"path":1580,"stem":1581,"date":1582,"lang":1577,"children":-1},"自建图床小记一——图床架构与 DNS 解析","/2024/08/12/new-picbed-based-on-cloudflare-and-upyun","posts/zh/new-picbed-based-on-cloudflare-and-upyun","2024-08-12 17:07:11",null,1765307310735]