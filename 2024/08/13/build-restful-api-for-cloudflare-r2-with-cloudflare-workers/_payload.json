[{"data":1,"prerenderedAt":1592},["ShallowReactive",2],{"post-2024-08-13-build-restful-api-for-cloudflare-r2-with-cloudflare-workers-zh":3,"surround-2024-08-13-build-restful-api-for-cloudflare-r2-with-cloudflare-workers-zh":1580,"randomIndex/2024/08/13/build-restful-api-for-cloudflare-r2-with-cloudflare-workers/":311,"language-switch-/2024/08/13/build-restful-api-for-cloudflare-r2-with-cloudflare-workers/-en":1591},{"id":4,"title":5,"body":6,"date":1565,"description":206,"extension":1566,"lang":1567,"meta":1568,"navigation":307,"path":1569,"rawbody":1570,"seo":1571,"stem":1572,"sticky":1573,"tags":1574,"__hash__":1579},"posts/posts/zh/build-restful-api-for-cloudflare-r2-with-cloudflare-workers.md","自建图床小记二——使用 Workers 为 R2 构建 Restful API",{"type":7,"value":8,"toc":1547},"minimark",[9,14,18,23,30,34,40,43,49,53,56,59,68,74,77,84,86,91,95,99,102,108,112,117,133,138,142,145,149,163,169,171,176,180,183,193,197,200,1206,1209,1223,1226,1230,1233,1238,1242,1245,1248,1394,1397,1404,1407,1410,1512,1515,1543],[10,11,13],"h2",{"id":12},"访问-r2-的两种方式","访问 R2 的两种方式",[15,16,17],"p",{},"一般来说，想要访问 Cloudflare R2 中的文件，会有两种方式。",[19,20,22],"h3",{"id":21},"一种是在-r2-的设置界面设置自定义域","一种是在 R2 的设置界面设置自定义域",[15,24,25],{},[26,27],"img",{"alt":28,"src":29},"设置自定义域","https://static.031130.xyz/uploads/2024/08/13/61fe9ede194af.webp",[19,31,33],{"id":32},"另一种是通过-cloudflare-workers-进行访问","另一种是通过 Cloudflare Workers 进行访问",[15,35,36],{},[26,37],{"alt":38,"src":39},"通过 Cloudflare Workers","https://static.031130.xyz/uploads/2024/08/13/846164273571d.webp",[41,42],"hr",{},[15,44,45],{},[46,47,48],"strong",{},"那么应该选择哪种？选择 Cloudflare Workers！",[10,50,52],{"id":51},"为什么是-cloudflare-workers","为什么是 Cloudflare Workers？",[15,54,55],{},"要回答这个问题比较困难，但可以回答另一个问题——「为什么不设置自定义域实现直接访问？」",[19,57,58],{"id":58},"自定义域的访问存在限制",[15,60,61,62,67],{},"设置自定义域的访问方式存在较多的限制，让我们先来复习一下",[63,64,66],"a",{"href":65},"/2024/08/12/new-picbed-based-on-cloudflare-and-upyun/","上一篇博客中","提到的 DNS 解析方案 1",[15,69,70],{},[26,71],{"alt":72,"src":73},"DNS 解析方案 1","https://static.031130.xyz/uploads/2024/08/13/03d8243b67593.webp",[15,75,76],{},"在这里，我们需要将图床访问域名通过 NS 接入 DnsPod 实现境内外的分流，但 R2 所允许设置的自定义域必须是通过 NS 接入 Cloudflare 的，这存在冲突。那如果我们先将自定义域设置为通过 NS 接入 Cloudflare 的工具人域名，再将图床访问域名通过 CNAME 解析到工具人域名会不会有问题呢？恭喜你获得 403 Forbidden。",[15,78,79,80,83],{},"如果通过",[63,81,82],{"href":65},"上一篇文章","中的 DNS 解析方案 2 来进行 DNS 解析，能不能成功设置为 Cloudflare R2 的自定义域呢？也不行，Cloudflare R2 的自定义域会占用域名的解析，这意味着你无法将图床访问域名解析到用于分流的工具人域名。",[41,85],{},[15,87,88],{},[46,89,90],{},"结论：截至本文写作时间，设置自定义域的方案不适用于 DNS 分流的图床架构。",[19,92,94],{"id":93},"如何上传文件到-cloudflare-r2","如何上传文件到 Cloudflare R2？",[96,97,98],"h4",{"id":98},"网页端直接上传",[15,100,101],{},"最简单的上传方式是直接在 Cloudflare 进行网页上传，但这种方案不适合自动化脚本，也没法接入 Typora",[15,103,104],{},[26,105],{"alt":106,"src":107},"直接在网页端进行上传","https://static.031130.xyz/uploads/2024/08/13/b4d1b5b3edfae.webp",[96,109,111],{"id":110},"使用-amazon-s3-的兼容-api","使用 Amazon S3 的兼容 API",[113,114,116],"h5",{"id":115},"手动调用-s3-api","手动调用 S3 API",[15,118,119,120,126,127,132],{},"Cloudflare R2 被设计为兼容 Amazon S3 的存储方案，自然兼容 Amazon S3 的上传 API，在 ",[63,121,125],{"href":122,"rel":123},"https://developers.cloudflare.com/r2/api/s3/api/",[124],"nofollow","Cloudflare Docs 中有关于 S3 API 的实现情况","记载，大部分接口功能都是实现了的。但。。。但 S3 使用的是 ",[63,128,131],{"href":129,"rel":130},"https://docs.aws.amazon.com/zh_cn/IAM/latest/UserGuide/create-signed-request.html",[124],"AWS Signature"," 作为鉴权，你不会希望在每个自动化程序中都自己实现一次的。。。",[15,134,135],{},[26,136],{"alt":137,"src":137},"https://docs.aws.amazon.com/zh_cn/IAM/latest/UserGuide/images/sigV4-using-auth-header.png",[113,139,141],{"id":140},"使用-aws-cli-等-sdk","使用 aws-cli 等 SDK",[15,143,144],{},"使用 aws-cli 可以自动实现计算 AWS Signature，这是一种可行的方案，但我可能会在别的服务中使用到我的图床，不是所有的服务所处的环境都能够执行 shell 命令，也不是所有的编程语言都有现成的 SDK 可用。",[96,146,148],{"id":147},"使用-cloudflare-workers-构建-restful-api","使用 Cloudflare Workers 构建 Restful API",[15,150,151,156,157,162],{},[63,152,155],{"href":153,"rel":154},"https://developers.cloudflare.com/r2/api/workers/workers-api-usage/#5-access-your-r2-bucket-from-your-worker",[124],"在 Cloudflare Docs 中明确提出可以使用 Cloudflare Workers 访问 Cloudflare R2 Bucket，","通过 Workers 设置界面的按钮，可以非常方便的将 R2 Bucket 作为一个 R2Object 绑定到 JavaScript 的一个变量中，",[63,158,161],{"href":159,"rel":160},"https://developers.cloudflare.com/r2/api/workers/workers-api-reference/",[124],"这里有相关的开发文档","。",[15,164,165],{},[26,166],{"alt":167,"src":168},"绑定为变量","https://static.031130.xyz/uploads/2024/08/13/45e58b47f3aeb.webp",[41,170],{},[15,172,173],{},[46,174,175],{},"结论: 从易用性上来看，使用 Cloudflare Workers 构建 Restful API 这种上传文件的方案是最为合适的。",[10,177,179],{"id":178},"使用-cloudflare-workers-构建-restful-api-的方案有没有什么缺点","使用 Cloudflare Workers 构建 Restful API 的方案有没有什么缺点？",[15,181,182],{},"有。",[184,185,186,190],"ul",{},[187,188,189],"li",{},"Cloudflare Workers 的每日额度是有限的，在极端的流量下可能会用完（应该不会吧？）",[187,191,192],{},"Cloudflare Workers 的内存限制为 128MB，在上传下载 > 100MB 的文件时可能会出错。有这种体积上传需求的场景建议使用别的上传方案。",[10,194,196],{"id":195},"如何构建","如何构建？",[15,198,199],{},"直接贴代码",[201,202,207],"pre",{"className":203,"code":204,"language":205,"meta":206,"style":206},"language-javascript shiki shiki-themes one-light one-dark-pro","const hasValidHeader = (request, env) => {\n    return request.headers.get('X-Custom-Auth-Key') === env.AUTH_KEY_SECRET;\n};\n\nfunction authorizeRequest(request, env, key) {\n    switch (request.method) {\n        case 'PUT':\n        case 'DELETE':\n            return hasValidHeader(request, env);\n        case 'GET':\n            return true;\n        default:\n            return false;\n    }\n}\n\nexport default {\n    async fetch(request, env) {\n        const url = new URL(request.url);\n        const key = decodeURI(url.pathname.slice(1));\n\n        if (!authorizeRequest(request, env, key)) {\n            return new Response('Forbidden\\n', { status: 403 });\n        }\n\n        switch (request.method) {\n            case 'PUT':\n                const objectExists = await env.MY_BUCKET.get(key);\n\n                if (objectExists !== null) {\n                    if (request.headers.get('Overwrite') !== 'true') {\n                        return new Response('Object Already Exists\\n', { status: 409 });\n                    }\n                }\n\n                await env.MY_BUCKET.put(key, request.body);\n                return new Response(`Put ${key} successfully!\\n`);\n\n            case 'GET':\n                const object = await env.MY_BUCKET.get(key);\n\n                if (object === null) {\n                    return new Response('Object Not Found\\n', { status: 404 });\n                }\n\n                const headers = new Headers();\n                object.writeHttpMetadata(headers);\n                headers.set('etag', object.httpEtag);\n\n                return new Response(object.body, {\n                    headers,\n                });\n            case 'DELETE':\n                await env.MY_BUCKET.delete(key);\n                return new Response('Deleted!\\n');\n\n            default:\n                return new Response('Method Not Allowed\\n', {\n                    status: 405,\n                    headers: {\n                        Allow: 'PUT, GET, DELETE',\n                    },\n                });\n        }\n    },\n};\n","javascript","",[208,209,210,250,296,302,309,334,352,364,374,394,404,415,423,433,439,445,450,462,481,510,545,550,579,616,622,627,643,653,684,689,708,741,771,777,783,788,820,854,859,868,896,901,918,948,953,958,976,993,1020,1025,1045,1054,1060,1069,1091,1111,1116,1124,1144,1157,1166,1179,1185,1190,1195,1201],"code",{"__ignoreMap":206},[211,212,215,219,223,227,231,235,238,241,244,247],"span",{"class":213,"line":214},"line",1,[211,216,218],{"class":217},"sLKXg","const",[211,220,222],{"class":221},"sAdtL"," hasValidHeader",[211,224,226],{"class":225},"s_Sar"," =",[211,228,230],{"class":229},"s5ixo"," (",[211,232,234],{"class":233},"s8iYz","request",[211,236,237],{"class":229},", ",[211,239,240],{"class":233},"env",[211,242,243],{"class":229},") ",[211,245,246],{"class":217},"=>",[211,248,249],{"class":229}," {\n",[211,251,253,256,260,263,267,269,272,275,279,281,284,287,289,293],{"class":213,"line":252},2,[211,254,255],{"class":217},"    return",[211,257,259],{"class":258},"s7GmK"," request",[211,261,262],{"class":229},".",[211,264,266],{"class":265},"s2QsP","headers",[211,268,262],{"class":229},[211,270,271],{"class":221},"get",[211,273,274],{"class":229},"(",[211,276,278],{"class":277},"sDhpE","'X-Custom-Auth-Key'",[211,280,243],{"class":229},[211,282,283],{"class":225},"===",[211,285,286],{"class":258}," env",[211,288,262],{"class":229},[211,290,292],{"class":291},"sRZ4U","AUTH_KEY_SECRET",[211,294,295],{"class":229},";\n",[211,297,299],{"class":213,"line":298},3,[211,300,301],{"class":229},"};\n",[211,303,305],{"class":213,"line":304},4,[211,306,308],{"emptyLinePlaceholder":307},true,"\n",[211,310,312,315,318,320,322,324,326,328,331],{"class":213,"line":311},5,[211,313,314],{"class":217},"function",[211,316,317],{"class":221}," authorizeRequest",[211,319,274],{"class":229},[211,321,234],{"class":233},[211,323,237],{"class":229},[211,325,240],{"class":233},[211,327,237],{"class":229},[211,329,330],{"class":233},"key",[211,332,333],{"class":229},") {\n",[211,335,337,340,342,344,346,350],{"class":213,"line":336},6,[211,338,339],{"class":217},"    switch",[211,341,230],{"class":229},[211,343,234],{"class":258},[211,345,262],{"class":229},[211,347,349],{"class":348},"sJa8x","method",[211,351,333],{"class":229},[211,353,355,358,361],{"class":213,"line":354},7,[211,356,357],{"class":217},"        case",[211,359,360],{"class":277}," 'PUT'",[211,362,363],{"class":229},":\n",[211,365,367,369,372],{"class":213,"line":366},8,[211,368,357],{"class":217},[211,370,371],{"class":277}," 'DELETE'",[211,373,363],{"class":229},[211,375,377,380,382,384,387,389,391],{"class":213,"line":376},9,[211,378,379],{"class":217},"            return",[211,381,222],{"class":221},[211,383,274],{"class":229},[211,385,234],{"class":386},"sz0mV",[211,388,237],{"class":229},[211,390,240],{"class":386},[211,392,393],{"class":229},");\n",[211,395,397,399,402],{"class":213,"line":396},10,[211,398,357],{"class":217},[211,400,401],{"class":277}," 'GET'",[211,403,363],{"class":229},[211,405,407,409,413],{"class":213,"line":406},11,[211,408,379],{"class":217},[211,410,412],{"class":411},"sAGMh"," true",[211,414,295],{"class":229},[211,416,418,421],{"class":213,"line":417},12,[211,419,420],{"class":217},"        default",[211,422,363],{"class":229},[211,424,426,428,431],{"class":213,"line":425},13,[211,427,379],{"class":217},[211,429,430],{"class":411}," false",[211,432,295],{"class":229},[211,434,436],{"class":213,"line":435},14,[211,437,438],{"class":229},"    }\n",[211,440,442],{"class":213,"line":441},15,[211,443,444],{"class":229},"}\n",[211,446,448],{"class":213,"line":447},16,[211,449,308],{"emptyLinePlaceholder":307},[211,451,453,456,460],{"class":213,"line":452},17,[211,454,455],{"class":217},"export",[211,457,459],{"class":458},"sq3v1"," default",[211,461,249],{"class":229},[211,463,465,468,471,473,475,477,479],{"class":213,"line":464},18,[211,466,467],{"class":217},"    async",[211,469,470],{"class":221}," fetch",[211,472,274],{"class":229},[211,474,234],{"class":233},[211,476,237],{"class":229},[211,478,240],{"class":233},[211,480,333],{"class":229},[211,482,484,487,491,493,496,499,501,503,505,508],{"class":213,"line":483},19,[211,485,486],{"class":217},"        const",[211,488,490],{"class":489},"sNmU0"," url",[211,492,226],{"class":225},[211,494,495],{"class":217}," new",[211,497,498],{"class":221}," URL",[211,500,274],{"class":229},[211,502,234],{"class":258},[211,504,262],{"class":229},[211,506,507],{"class":348},"url",[211,509,393],{"class":229},[211,511,513,515,518,520,523,525,527,529,532,534,537,539,542],{"class":213,"line":512},20,[211,514,486],{"class":217},[211,516,517],{"class":489}," key",[211,519,226],{"class":225},[211,521,522],{"class":221}," decodeURI",[211,524,274],{"class":229},[211,526,507],{"class":258},[211,528,262],{"class":229},[211,530,531],{"class":265},"pathname",[211,533,262],{"class":229},[211,535,536],{"class":221},"slice",[211,538,274],{"class":229},[211,540,541],{"class":411},"1",[211,543,544],{"class":229},"));\n",[211,546,548],{"class":213,"line":547},21,[211,549,308],{"emptyLinePlaceholder":307},[211,551,553,556,558,561,564,566,568,570,572,574,576],{"class":213,"line":552},22,[211,554,555],{"class":217},"        if",[211,557,230],{"class":229},[211,559,560],{"class":225},"!",[211,562,563],{"class":221},"authorizeRequest",[211,565,274],{"class":229},[211,567,234],{"class":348},[211,569,237],{"class":229},[211,571,240],{"class":348},[211,573,237],{"class":229},[211,575,330],{"class":348},[211,577,578],{"class":229},")) {\n",[211,580,582,584,586,589,591,594,597,600,603,606,610,613],{"class":213,"line":581},23,[211,583,379],{"class":217},[211,585,495],{"class":217},[211,587,588],{"class":221}," Response",[211,590,274],{"class":229},[211,592,593],{"class":277},"'Forbidden",[211,595,596],{"class":225},"\\n",[211,598,599],{"class":277},"'",[211,601,602],{"class":229},", { ",[211,604,605],{"class":348},"status",[211,607,609],{"class":608},"st7oF",":",[211,611,612],{"class":411}," 403",[211,614,615],{"class":229}," });\n",[211,617,619],{"class":213,"line":618},24,[211,620,621],{"class":229},"        }\n",[211,623,625],{"class":213,"line":624},25,[211,626,308],{"emptyLinePlaceholder":307},[211,628,630,633,635,637,639,641],{"class":213,"line":629},26,[211,631,632],{"class":217},"        switch",[211,634,230],{"class":229},[211,636,234],{"class":258},[211,638,262],{"class":229},[211,640,349],{"class":348},[211,642,333],{"class":229},[211,644,646,649,651],{"class":213,"line":645},27,[211,647,648],{"class":217},"            case",[211,650,360],{"class":277},[211,652,363],{"class":229},[211,654,656,659,662,664,667,669,671,674,676,678,680,682],{"class":213,"line":655},28,[211,657,658],{"class":217},"                const",[211,660,661],{"class":489}," objectExists",[211,663,226],{"class":225},[211,665,666],{"class":217}," await",[211,668,286],{"class":258},[211,670,262],{"class":229},[211,672,673],{"class":265},"MY_BUCKET",[211,675,262],{"class":229},[211,677,271],{"class":221},[211,679,274],{"class":229},[211,681,330],{"class":348},[211,683,393],{"class":229},[211,685,687],{"class":213,"line":686},29,[211,688,308],{"emptyLinePlaceholder":307},[211,690,692,695,697,700,703,706],{"class":213,"line":691},30,[211,693,694],{"class":217},"                if",[211,696,230],{"class":229},[211,698,699],{"class":348},"objectExists",[211,701,702],{"class":225}," !==",[211,704,705],{"class":411}," null",[211,707,333],{"class":229},[211,709,711,714,716,718,720,722,724,726,728,731,733,736,739],{"class":213,"line":710},31,[211,712,713],{"class":217},"                    if",[211,715,230],{"class":229},[211,717,234],{"class":258},[211,719,262],{"class":229},[211,721,266],{"class":265},[211,723,262],{"class":229},[211,725,271],{"class":221},[211,727,274],{"class":229},[211,729,730],{"class":277},"'Overwrite'",[211,732,243],{"class":229},[211,734,735],{"class":225},"!==",[211,737,738],{"class":277}," 'true'",[211,740,333],{"class":229},[211,742,744,747,749,751,753,756,758,760,762,764,766,769],{"class":213,"line":743},32,[211,745,746],{"class":217},"                        return",[211,748,495],{"class":217},[211,750,588],{"class":221},[211,752,274],{"class":229},[211,754,755],{"class":277},"'Object Already Exists",[211,757,596],{"class":225},[211,759,599],{"class":277},[211,761,602],{"class":229},[211,763,605],{"class":348},[211,765,609],{"class":608},[211,767,768],{"class":411}," 409",[211,770,615],{"class":229},[211,772,774],{"class":213,"line":773},33,[211,775,776],{"class":229},"                    }\n",[211,778,780],{"class":213,"line":779},34,[211,781,782],{"class":229},"                }\n",[211,784,786],{"class":213,"line":785},35,[211,787,308],{"emptyLinePlaceholder":307},[211,789,791,794,796,798,800,802,805,807,809,811,813,815,818],{"class":213,"line":790},36,[211,792,793],{"class":217},"                await",[211,795,286],{"class":258},[211,797,262],{"class":229},[211,799,673],{"class":265},[211,801,262],{"class":229},[211,803,804],{"class":221},"put",[211,806,274],{"class":229},[211,808,330],{"class":348},[211,810,237],{"class":229},[211,812,234],{"class":258},[211,814,262],{"class":229},[211,816,817],{"class":348},"body",[211,819,393],{"class":229},[211,821,823,826,828,830,832,835,839,841,844,847,849,852],{"class":213,"line":822},37,[211,824,825],{"class":217},"                return",[211,827,495],{"class":217},[211,829,588],{"class":221},[211,831,274],{"class":229},[211,833,834],{"class":277},"`Put ",[211,836,838],{"class":837},"sAOjX","${",[211,840,330],{"class":348},[211,842,843],{"class":837},"}",[211,845,846],{"class":277}," successfully!",[211,848,596],{"class":225},[211,850,851],{"class":277},"`",[211,853,393],{"class":229},[211,855,857],{"class":213,"line":856},38,[211,858,308],{"emptyLinePlaceholder":307},[211,860,862,864,866],{"class":213,"line":861},39,[211,863,648],{"class":217},[211,865,401],{"class":277},[211,867,363],{"class":229},[211,869,871,873,876,878,880,882,884,886,888,890,892,894],{"class":213,"line":870},40,[211,872,658],{"class":217},[211,874,875],{"class":489}," object",[211,877,226],{"class":225},[211,879,666],{"class":217},[211,881,286],{"class":258},[211,883,262],{"class":229},[211,885,673],{"class":265},[211,887,262],{"class":229},[211,889,271],{"class":221},[211,891,274],{"class":229},[211,893,330],{"class":348},[211,895,393],{"class":229},[211,897,899],{"class":213,"line":898},41,[211,900,308],{"emptyLinePlaceholder":307},[211,902,904,906,908,911,914,916],{"class":213,"line":903},42,[211,905,694],{"class":217},[211,907,230],{"class":229},[211,909,910],{"class":348},"object",[211,912,913],{"class":225}," ===",[211,915,705],{"class":411},[211,917,333],{"class":229},[211,919,921,924,926,928,930,933,935,937,939,941,943,946],{"class":213,"line":920},43,[211,922,923],{"class":217},"                    return",[211,925,495],{"class":217},[211,927,588],{"class":221},[211,929,274],{"class":229},[211,931,932],{"class":277},"'Object Not Found",[211,934,596],{"class":225},[211,936,599],{"class":277},[211,938,602],{"class":229},[211,940,605],{"class":348},[211,942,609],{"class":608},[211,944,945],{"class":411}," 404",[211,947,615],{"class":229},[211,949,951],{"class":213,"line":950},44,[211,952,782],{"class":229},[211,954,956],{"class":213,"line":955},45,[211,957,308],{"emptyLinePlaceholder":307},[211,959,961,963,966,968,970,973],{"class":213,"line":960},46,[211,962,658],{"class":217},[211,964,965],{"class":489}," headers",[211,967,226],{"class":225},[211,969,495],{"class":217},[211,971,972],{"class":221}," Headers",[211,974,975],{"class":229},"();\n",[211,977,979,982,984,987,989,991],{"class":213,"line":978},47,[211,980,981],{"class":258},"                object",[211,983,262],{"class":229},[211,985,986],{"class":221},"writeHttpMetadata",[211,988,274],{"class":229},[211,990,266],{"class":348},[211,992,393],{"class":229},[211,994,996,999,1001,1004,1006,1009,1011,1013,1015,1018],{"class":213,"line":995},48,[211,997,998],{"class":258},"                headers",[211,1000,262],{"class":229},[211,1002,1003],{"class":221},"set",[211,1005,274],{"class":229},[211,1007,1008],{"class":277},"'etag'",[211,1010,237],{"class":229},[211,1012,910],{"class":258},[211,1014,262],{"class":229},[211,1016,1017],{"class":348},"httpEtag",[211,1019,393],{"class":229},[211,1021,1023],{"class":213,"line":1022},49,[211,1024,308],{"emptyLinePlaceholder":307},[211,1026,1028,1030,1032,1034,1036,1038,1040,1042],{"class":213,"line":1027},50,[211,1029,825],{"class":217},[211,1031,495],{"class":217},[211,1033,588],{"class":221},[211,1035,274],{"class":229},[211,1037,910],{"class":258},[211,1039,262],{"class":229},[211,1041,817],{"class":348},[211,1043,1044],{"class":229},", {\n",[211,1046,1048,1051],{"class":213,"line":1047},51,[211,1049,1050],{"class":348},"                    headers",[211,1052,1053],{"class":229},",\n",[211,1055,1057],{"class":213,"line":1056},52,[211,1058,1059],{"class":229},"                });\n",[211,1061,1063,1065,1067],{"class":213,"line":1062},53,[211,1064,648],{"class":217},[211,1066,371],{"class":277},[211,1068,363],{"class":229},[211,1070,1072,1074,1076,1078,1080,1082,1085,1087,1089],{"class":213,"line":1071},54,[211,1073,793],{"class":217},[211,1075,286],{"class":258},[211,1077,262],{"class":229},[211,1079,673],{"class":265},[211,1081,262],{"class":229},[211,1083,1084],{"class":221},"delete",[211,1086,274],{"class":229},[211,1088,330],{"class":348},[211,1090,393],{"class":229},[211,1092,1094,1096,1098,1100,1102,1105,1107,1109],{"class":213,"line":1093},55,[211,1095,825],{"class":217},[211,1097,495],{"class":217},[211,1099,588],{"class":221},[211,1101,274],{"class":229},[211,1103,1104],{"class":277},"'Deleted!",[211,1106,596],{"class":225},[211,1108,599],{"class":277},[211,1110,393],{"class":229},[211,1112,1114],{"class":213,"line":1113},56,[211,1115,308],{"emptyLinePlaceholder":307},[211,1117,1119,1122],{"class":213,"line":1118},57,[211,1120,1121],{"class":217},"            default",[211,1123,363],{"class":229},[211,1125,1127,1129,1131,1133,1135,1138,1140,1142],{"class":213,"line":1126},58,[211,1128,825],{"class":217},[211,1130,495],{"class":217},[211,1132,588],{"class":221},[211,1134,274],{"class":229},[211,1136,1137],{"class":277},"'Method Not Allowed",[211,1139,596],{"class":225},[211,1141,599],{"class":277},[211,1143,1044],{"class":229},[211,1145,1147,1150,1152,1155],{"class":213,"line":1146},59,[211,1148,1149],{"class":348},"                    status",[211,1151,609],{"class":608},[211,1153,1154],{"class":411}," 405",[211,1156,1053],{"class":229},[211,1158,1160,1162,1164],{"class":213,"line":1159},60,[211,1161,1050],{"class":348},[211,1163,609],{"class":608},[211,1165,249],{"class":229},[211,1167,1169,1172,1174,1177],{"class":213,"line":1168},61,[211,1170,1171],{"class":348},"                        Allow",[211,1173,609],{"class":608},[211,1175,1176],{"class":277}," 'PUT, GET, DELETE'",[211,1178,1053],{"class":229},[211,1180,1182],{"class":213,"line":1181},62,[211,1183,1184],{"class":229},"                    },\n",[211,1186,1188],{"class":213,"line":1187},63,[211,1189,1059],{"class":229},[211,1191,1193],{"class":213,"line":1192},64,[211,1194,621],{"class":229},[211,1196,1198],{"class":213,"line":1197},65,[211,1199,1200],{"class":229},"    },\n",[211,1202,1204],{"class":213,"line":1203},66,[211,1205,301],{"class":229},[15,1207,1208],{},"代码的大部分都是基于 Cloudflare Docs 中给出的样例，修改了几个小的优化点",[184,1210,1211,1214,1220],{},[187,1212,1213],{},"删除了 ALLOW_LIST 部分代码，默认所有文件都是可以被访问的",[187,1215,1216,1217],{},"在上传一个文件时，如果目标路径存在同名文件，则不直接覆盖，而是返回 409 的异常 HTTP 相应，如果想要强制覆盖，则需要在 Http Header 中加入 ",[208,1218,1219],{},"Overwrite: true",[187,1221,1222],{},"解出请求路径时，使用 decodeURI( ) 方法先进行解码，解决文件路径中含有中文时会导致请求失败的问题。",[15,1224,1225],{},"填入代码后，还需要绑定两个变量，一个是 R2 Bucket",[15,1227,1228],{},[26,1229],{"alt":206,"src":168},[15,1231,1232],{},"另一个是自己的管理密码",[15,1234,1235],{},[26,1236],{"alt":206,"src":1237},"https://static.031130.xyz/uploads/2024/08/14/96da1f62f5fe7.webp",[10,1239,1241],{"id":1240},"如何使用-cloudflare-workers-构建的-restful-api-进行文件操作","如何使用 Cloudflare Workers 构建的 Restful API 进行文件操作？",[19,1243,1244],{"id":1244},"上传",[15,1246,1247],{},"以 python 为例，上传一个文件 1MB.bin 到 /example/ 目录下，上传的 url 就是文件最终的存在路径。",[201,1249,1253],{"className":1250,"code":1251,"language":1252,"meta":206,"style":206},"language-python shiki shiki-themes one-light one-dark-pro","import requests\n\nAUTH_KEY_SECRET='1145141919810'\n\nwith open('1MB.bin', ''rb) as f:\n    file_content = f.read()\n\nrequests.put(\n    'https://r2.example.workers.dev/example/1MB.bin',\n    headers={\n        'X-Custom-Auth-Key': AUTH_KEY_SECRET,\n        'Overwrite': True   # 如果不需要强制覆盖可以删除这一行\n    }\n)\n","python",[208,1254,1255,1263,1267,1279,1283,1310,1327,1331,1341,1348,1359,1371,1385,1389],{"__ignoreMap":206},[211,1256,1257,1260],{"class":213,"line":214},[211,1258,1259],{"class":217},"import",[211,1261,1262],{"class":229}," requests\n",[211,1264,1265],{"class":213,"line":252},[211,1266,308],{"emptyLinePlaceholder":307},[211,1268,1269,1272,1276],{"class":213,"line":298},[211,1270,292],{"class":1271},"sYebD",[211,1273,1275],{"class":1274},"sknuh","=",[211,1277,1278],{"class":277},"'1145141919810'\n",[211,1280,1281],{"class":213,"line":304},[211,1282,308],{"emptyLinePlaceholder":307},[211,1284,1285,1288,1291,1293,1296,1298,1301,1304,1307],{"class":213,"line":311},[211,1286,1287],{"class":217},"with",[211,1289,1290],{"class":225}," open",[211,1292,274],{"class":229},[211,1294,1295],{"class":277},"'1MB.bin'",[211,1297,237],{"class":229},[211,1299,1300],{"class":277},"''",[211,1302,1303],{"class":229},"rb) ",[211,1305,1306],{"class":217},"as",[211,1308,1309],{"class":229}," f:\n",[211,1311,1312,1315,1317,1320,1324],{"class":213,"line":336},[211,1313,1314],{"class":229},"    file_content ",[211,1316,1275],{"class":1274},[211,1318,1319],{"class":229}," f.",[211,1321,1323],{"class":1322},"slOjB","read",[211,1325,1326],{"class":229},"()\n",[211,1328,1329],{"class":213,"line":354},[211,1330,308],{"emptyLinePlaceholder":307},[211,1332,1333,1336,1338],{"class":213,"line":366},[211,1334,1335],{"class":229},"requests.",[211,1337,804],{"class":1322},[211,1339,1340],{"class":229},"(\n",[211,1342,1343,1346],{"class":213,"line":376},[211,1344,1345],{"class":277},"    'https://r2.example.workers.dev/example/1MB.bin'",[211,1347,1053],{"class":229},[211,1349,1350,1354,1356],{"class":213,"line":396},[211,1351,1353],{"class":1352},"sp7wS","    headers",[211,1355,1275],{"class":1274},[211,1357,1358],{"class":229},"{\n",[211,1360,1361,1364,1367,1369],{"class":213,"line":406},[211,1362,1363],{"class":277},"        'X-Custom-Auth-Key'",[211,1365,1366],{"class":229},": ",[211,1368,292],{"class":1271},[211,1370,1053],{"class":229},[211,1372,1373,1376,1378,1381],{"class":213,"line":417},[211,1374,1375],{"class":277},"        'Overwrite'",[211,1377,1366],{"class":229},[211,1379,1380],{"class":411},"True",[211,1382,1384],{"class":1383},"sW2Sy","   # 如果不需要强制覆盖可以删除这一行\n",[211,1386,1387],{"class":213,"line":425},[211,1388,438],{"class":229},[211,1390,1391],{"class":213,"line":435},[211,1392,1393],{"class":229},")\n",[19,1395,1396],{"id":1396},"访问",[15,1398,1399,1400,1403],{},"通过浏览器直接访问 ",[208,1401,1402],{},"https://r2.example.workers.dev/example/1MB.bin"," 应该就能访问到",[19,1405,1406],{"id":1406},"删除",[15,1408,1409],{},"仍然以 python 为例，删除刚才的文件",[201,1411,1413],{"className":1250,"code":1412,"language":1252,"meta":206,"style":206},"import requests\n\nAUTH_KEY_SECRET='1145141919810'\n\nwith open('1MB.bin', ''rb) as f:\n    file_content = f.read()\n\nrequests.delete(\n    'https://r2.example.workers.dev/example/1MB.bin',\n    headers={\n        'X-Custom-Auth-Key': AUTH_KEY_SECRET\n    }\n)\n",[208,1414,1415,1421,1425,1433,1437,1457,1469,1473,1481,1487,1495,1504,1508],{"__ignoreMap":206},[211,1416,1417,1419],{"class":213,"line":214},[211,1418,1259],{"class":217},[211,1420,1262],{"class":229},[211,1422,1423],{"class":213,"line":252},[211,1424,308],{"emptyLinePlaceholder":307},[211,1426,1427,1429,1431],{"class":213,"line":298},[211,1428,292],{"class":1271},[211,1430,1275],{"class":1274},[211,1432,1278],{"class":277},[211,1434,1435],{"class":213,"line":304},[211,1436,308],{"emptyLinePlaceholder":307},[211,1438,1439,1441,1443,1445,1447,1449,1451,1453,1455],{"class":213,"line":311},[211,1440,1287],{"class":217},[211,1442,1290],{"class":225},[211,1444,274],{"class":229},[211,1446,1295],{"class":277},[211,1448,237],{"class":229},[211,1450,1300],{"class":277},[211,1452,1303],{"class":229},[211,1454,1306],{"class":217},[211,1456,1309],{"class":229},[211,1458,1459,1461,1463,1465,1467],{"class":213,"line":336},[211,1460,1314],{"class":229},[211,1462,1275],{"class":1274},[211,1464,1319],{"class":229},[211,1466,1323],{"class":1322},[211,1468,1326],{"class":229},[211,1470,1471],{"class":213,"line":354},[211,1472,308],{"emptyLinePlaceholder":307},[211,1474,1475,1477,1479],{"class":213,"line":366},[211,1476,1335],{"class":229},[211,1478,1084],{"class":1322},[211,1480,1340],{"class":229},[211,1482,1483,1485],{"class":213,"line":376},[211,1484,1345],{"class":277},[211,1486,1053],{"class":229},[211,1488,1489,1491,1493],{"class":213,"line":396},[211,1490,1353],{"class":1352},[211,1492,1275],{"class":1274},[211,1494,1358],{"class":229},[211,1496,1497,1499,1501],{"class":213,"line":406},[211,1498,1363],{"class":277},[211,1500,1366],{"class":229},[211,1502,1503],{"class":1271},"AUTH_KEY_SECRET\n",[211,1505,1506],{"class":213,"line":417},[211,1507,438],{"class":229},[211,1509,1510],{"class":213,"line":425},[211,1511,1393],{"class":229},[10,1513,1514],{"id":1514},"参见",[184,1516,1517,1524,1530,1537],{},[187,1518,1519],{},[63,1520,1523],{"href":1521,"rel":1522},"https://blog.yswtrue.com/yong-cloudflare-de-r2-he-worker-lai-zuo-wen-jian-tuo-guan/",[124],"用 cloudflare 的 R2 和 worker 来做文件托管",[187,1525,1526],{},[63,1527,1529],{"href":159,"rel":1528},[124],"Workers API reference",[187,1531,1532],{},[63,1533,1536],{"href":1534,"rel":1535},"https://developers.cloudflare.com/r2/api/workers/workers-api-usage/",[124],"Use R2 from Workers",[187,1538,1539],{},[63,1540,1542],{"href":129,"rel":1541},[124],"创建已签名的 AWS API 请求",[1544,1545,1546],"style",{},"html pre.shiki code .sLKXg, html code.shiki .sLKXg{--shiki-default:#A626A4;--shiki-dark:#C678DD}html pre.shiki code .sAdtL, html code.shiki .sAdtL{--shiki-default:#4078F2;--shiki-dark:#61AFEF}html pre.shiki code .s_Sar, html code.shiki .s_Sar{--shiki-default:#0184BC;--shiki-dark:#56B6C2}html pre.shiki code .s5ixo, html code.shiki .s5ixo{--shiki-default:#383A42;--shiki-dark:#ABB2BF}html pre.shiki code .s8iYz, html code.shiki .s8iYz{--shiki-default:#383A42;--shiki-default-font-style:inherit;--shiki-dark:#E06C75;--shiki-dark-font-style:italic}html pre.shiki code .s7GmK, html code.shiki .s7GmK{--shiki-default:#383A42;--shiki-dark:#E5C07B}html pre.shiki code .s2QsP, html code.shiki .s2QsP{--shiki-default:#E45649;--shiki-dark:#E5C07B}html pre.shiki code .sDhpE, html code.shiki .sDhpE{--shiki-default:#50A14F;--shiki-dark:#98C379}html pre.shiki code .sRZ4U, html code.shiki .sRZ4U{--shiki-default:#986801;--shiki-dark:#E06C75}html pre.shiki code .sJa8x, html code.shiki .sJa8x{--shiki-default:#E45649;--shiki-dark:#E06C75}html pre.shiki code .sz0mV, html code.shiki .sz0mV{--shiki-default:#383A42;--shiki-dark:#E06C75}html pre.shiki code .sAGMh, html code.shiki .sAGMh{--shiki-default:#986801;--shiki-dark:#D19A66}html pre.shiki code .sq3v1, html code.shiki .sq3v1{--shiki-default:#E45649;--shiki-dark:#C678DD}html pre.shiki code .sNmU0, html code.shiki .sNmU0{--shiki-default:#986801;--shiki-dark:#E5C07B}html pre.shiki code .st7oF, html code.shiki .st7oF{--shiki-default:#0184BC;--shiki-dark:#ABB2BF}html pre.shiki code .sAOjX, html code.shiki .sAOjX{--shiki-default:#CA1243;--shiki-dark:#C678DD}html .default .shiki span {color: var(--shiki-default);background: var(--shiki-default-bg);font-style: var(--shiki-default-font-style);font-weight: var(--shiki-default-font-weight);text-decoration: var(--shiki-default-text-decoration);}html .shiki span {color: var(--shiki-default);background: var(--shiki-default-bg);font-style: var(--shiki-default-font-style);font-weight: var(--shiki-default-font-weight);text-decoration: var(--shiki-default-text-decoration);}html .dark .shiki span {color: var(--shiki-dark);background: var(--shiki-dark-bg);font-style: var(--shiki-dark-font-style);font-weight: var(--shiki-dark-font-weight);text-decoration: var(--shiki-dark-text-decoration);}html.dark .shiki span {color: var(--shiki-dark);background: var(--shiki-dark-bg);font-style: var(--shiki-dark-font-style);font-weight: var(--shiki-dark-font-weight);text-decoration: var(--shiki-dark-text-decoration);}html pre.shiki code .sYebD, html code.shiki .sYebD{--shiki-default:#383A42;--shiki-dark:#D19A66}html pre.shiki code .sknuh, html code.shiki .sknuh{--shiki-default:#383A42;--shiki-dark:#56B6C2}html pre.shiki code .slOjB, html code.shiki .slOjB{--shiki-default:#383A42;--shiki-dark:#61AFEF}html pre.shiki code .sp7wS, html code.shiki .sp7wS{--shiki-default:#986801;--shiki-default-font-style:inherit;--shiki-dark:#E06C75;--shiki-dark-font-style:italic}html pre.shiki code .sW2Sy, html code.shiki .sW2Sy{--shiki-default:#A0A1A7;--shiki-default-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic}",{"title":206,"searchDepth":252,"depth":252,"links":1548},[1549,1553,1557,1558,1559,1564],{"id":12,"depth":252,"text":13,"children":1550},[1551,1552],{"id":21,"depth":298,"text":22},{"id":32,"depth":298,"text":33},{"id":51,"depth":252,"text":52,"children":1554},[1555,1556],{"id":58,"depth":298,"text":58},{"id":93,"depth":298,"text":94},{"id":178,"depth":252,"text":179},{"id":195,"depth":252,"text":196},{"id":1240,"depth":252,"text":1241,"children":1560},[1561,1562,1563],{"id":1244,"depth":298,"text":1244},{"id":1396,"depth":298,"text":1396},{"id":1406,"depth":298,"text":1406},{"id":1514,"depth":252,"text":1514},"2024-08-13 22:58:26","md","zh-CN",{},"/2024/08/13/build-restful-api-for-cloudflare-r2-with-cloudflare-workers","---\ntitle: 自建图床小记二——使用 Workers 为 R2 构建 Restful API\ndate: 2024-08-13 22:58:26\nsticky:\ntags:\n- Image Hosting\n- Cloudflare\n- JavaScript\n- Python\n---\n\n## 访问 R2 的两种方式\n\n一般来说，想要访问 Cloudflare R2 中的文件，会有两种方式。\n\n### 一种是在 R2 的设置界面设置自定义域\n\n![设置自定义域](https://static.031130.xyz/uploads/2024/08/13/61fe9ede194af.webp)\n\n### 另一种是通过 Cloudflare Workers 进行访问\n\n![通过 Cloudflare Workers](https://static.031130.xyz/uploads/2024/08/13/846164273571d.webp)\n\n***\n\n**那么应该选择哪种？选择 Cloudflare Workers！**\n\n## 为什么是 Cloudflare Workers？\n\n要回答这个问题比较困难，但可以回答另一个问题——「为什么不设置自定义域实现直接访问？」\n\n### 自定义域的访问存在限制\n\n设置自定义域的访问方式存在较多的限制，让我们先来复习一下[上一篇博客中](/2024/08/12/new-picbed-based-on-cloudflare-and-upyun/)提到的 DNS 解析方案 1\n\n![DNS 解析方案 1](https://static.031130.xyz/uploads/2024/08/13/03d8243b67593.webp)\n\n在这里，我们需要将图床访问域名通过 NS 接入 DnsPod 实现境内外的分流，但 R2 所允许设置的自定义域必须是通过 NS 接入 Cloudflare 的，这存在冲突。那如果我们先将自定义域设置为通过 NS 接入 Cloudflare 的工具人域名，再将图床访问域名通过 CNAME 解析到工具人域名会不会有问题呢？恭喜你获得 403 Forbidden。\n\n如果通过[上一篇文章](/2024/08/12/new-picbed-based-on-cloudflare-and-upyun/)中的 DNS 解析方案 2 来进行 DNS 解析，能不能成功设置为 Cloudflare R2 的自定义域呢？也不行，Cloudflare R2 的自定义域会占用域名的解析，这意味着你无法将图床访问域名解析到用于分流的工具人域名。\n\n***\n\n**结论：截至本文写作时间，设置自定义域的方案不适用于 DNS 分流的图床架构。**\n\n### 如何上传文件到 Cloudflare R2？\n\n#### 网页端直接上传\n\n最简单的上传方式是直接在 Cloudflare 进行网页上传，但这种方案不适合自动化脚本，也没法接入 Typora\n\n![直接在网页端进行上传](https://static.031130.xyz/uploads/2024/08/13/b4d1b5b3edfae.webp)\n\n#### 使用 Amazon S3 的兼容 API\n\n##### 手动调用 S3 API\n\nCloudflare R2 被设计为兼容 Amazon S3 的存储方案，自然兼容 Amazon S3 的上传 API，在 [Cloudflare Docs 中有关于 S3 API 的实现情况](https://developers.cloudflare.com/r2/api/s3/api/)记载，大部分接口功能都是实现了的。但。。。但 S3 使用的是 [AWS Signature](https://docs.aws.amazon.com/zh_cn/IAM/latest/UserGuide/create-signed-request.html) 作为鉴权，你不会希望在每个自动化程序中都自己实现一次的。。。\n\n![https://docs.aws.amazon.com/zh_cn/IAM/latest/UserGuide/images/sigV4-using-auth-header.png](https://docs.aws.amazon.com/zh_cn/IAM/latest/UserGuide/images/sigV4-using-auth-header.png)\n\n##### 使用 aws-cli 等 SDK\n\n使用 aws-cli 可以自动实现计算 AWS Signature，这是一种可行的方案，但我可能会在别的服务中使用到我的图床，不是所有的服务所处的环境都能够执行 shell 命令，也不是所有的编程语言都有现成的 SDK 可用。\n\n#### 使用 Cloudflare Workers 构建 Restful API\n\n[在 Cloudflare Docs 中明确提出可以使用 Cloudflare Workers 访问 Cloudflare R2 Bucket，](https://developers.cloudflare.com/r2/api/workers/workers-api-usage/#5-access-your-r2-bucket-from-your-worker)通过 Workers 设置界面的按钮，可以非常方便的将 R2 Bucket 作为一个 R2Object 绑定到 JavaScript 的一个变量中，[这里有相关的开发文档](https://developers.cloudflare.com/r2/api/workers/workers-api-reference/)。\n\n![绑定为变量](https://static.031130.xyz/uploads/2024/08/13/45e58b47f3aeb.webp)\n\n***\n\n**结论: 从易用性上来看，使用 Cloudflare Workers 构建 Restful API 这种上传文件的方案是最为合适的。**\n\n## 使用 Cloudflare Workers 构建 Restful API 的方案有没有什么缺点？\n\n有。\n\n- Cloudflare Workers 的每日额度是有限的，在极端的流量下可能会用完（应该不会吧？）\n- Cloudflare Workers 的内存限制为 128MB，在上传下载 > 100MB 的文件时可能会出错。有这种体积上传需求的场景建议使用别的上传方案。\n\n## 如何构建？\n\n直接贴代码\n\n```javascript\nconst hasValidHeader = (request, env) => {\n\treturn request.headers.get('X-Custom-Auth-Key') === env.AUTH_KEY_SECRET;\n};\n\nfunction authorizeRequest(request, env, key) {\n\tswitch (request.method) {\n\t\tcase 'PUT':\n\t\tcase 'DELETE':\n\t\t\treturn hasValidHeader(request, env);\n\t\tcase 'GET':\n\t\t\treturn true;\n\t\tdefault:\n\t\t\treturn false;\n\t}\n}\n\nexport default {\n\tasync fetch(request, env) {\n\t\tconst url = new URL(request.url);\n\t\tconst key = decodeURI(url.pathname.slice(1));\n\n\t\tif (!authorizeRequest(request, env, key)) {\n\t\t\treturn new Response('Forbidden\\n', { status: 403 });\n\t\t}\n\n\t\tswitch (request.method) {\n\t\t\tcase 'PUT':\n\t\t\t\tconst objectExists = await env.MY_BUCKET.get(key);\n\n\t\t\t\tif (objectExists !== null) {\n\t\t\t\t\tif (request.headers.get('Overwrite') !== 'true') {\n\t\t\t\t\t\treturn new Response('Object Already Exists\\n', { status: 409 });\n\t\t\t\t\t}\n\t\t\t\t}\n\n\t\t\t\tawait env.MY_BUCKET.put(key, request.body);\n\t\t\t\treturn new Response(`Put ${key} successfully!\\n`);\n\n\t\t\tcase 'GET':\n\t\t\t\tconst object = await env.MY_BUCKET.get(key);\n\n\t\t\t\tif (object === null) {\n\t\t\t\t\treturn new Response('Object Not Found\\n', { status: 404 });\n\t\t\t\t}\n\n\t\t\t\tconst headers = new Headers();\n\t\t\t\tobject.writeHttpMetadata(headers);\n\t\t\t\theaders.set('etag', object.httpEtag);\n\n\t\t\t\treturn new Response(object.body, {\n\t\t\t\t\theaders,\n\t\t\t\t});\n\t\t\tcase 'DELETE':\n\t\t\t\tawait env.MY_BUCKET.delete(key);\n\t\t\t\treturn new Response('Deleted!\\n');\n\n\t\t\tdefault:\n\t\t\t\treturn new Response('Method Not Allowed\\n', {\n\t\t\t\t\tstatus: 405,\n\t\t\t\t\theaders: {\n\t\t\t\t\t\tAllow: 'PUT, GET, DELETE',\n\t\t\t\t\t},\n\t\t\t\t});\n\t\t}\n\t},\n};\n```\n\n代码的大部分都是基于 Cloudflare Docs 中给出的样例，修改了几个小的优化点\n\n- 删除了 ALLOW_LIST 部分代码，默认所有文件都是可以被访问的\n- 在上传一个文件时，如果目标路径存在同名文件，则不直接覆盖，而是返回 409 的异常 HTTP 相应，如果想要强制覆盖，则需要在 Http Header 中加入 `Overwrite: true`\n- 解出请求路径时，使用 decodeURI( ) 方法先进行解码，解决文件路径中含有中文时会导致请求失败的问题。\n\n填入代码后，还需要绑定两个变量，一个是 R2 Bucket\n\n![](https://static.031130.xyz/uploads/2024/08/13/45e58b47f3aeb.webp)\n\n另一个是自己的管理密码\n\n![](https://static.031130.xyz/uploads/2024/08/14/96da1f62f5fe7.webp)\n\n## 如何使用 Cloudflare Workers 构建的 Restful API 进行文件操作？\n\n### 上传\n\n以 python 为例，上传一个文件 1MB.bin 到 /example/ 目录下，上传的 url 就是文件最终的存在路径。\n\n```python\nimport requests\n\nAUTH_KEY_SECRET='1145141919810'\n\nwith open('1MB.bin', ''rb) as f:\n    file_content = f.read()\n\nrequests.put(\n\t'https://r2.example.workers.dev/example/1MB.bin',\n    headers={\n        'X-Custom-Auth-Key': AUTH_KEY_SECRET,\n        'Overwrite': True\t# 如果不需要强制覆盖可以删除这一行\n    }\n)\n```\n\n### 访问\n\n通过浏览器直接访问 `https://r2.example.workers.dev/example/1MB.bin` 应该就能访问到\n\n### 删除\n\n仍然以 python 为例，删除刚才的文件\n\n```python\nimport requests\n\nAUTH_KEY_SECRET='1145141919810'\n\nwith open('1MB.bin', ''rb) as f:\n    file_content = f.read()\n\nrequests.delete(\n\t'https://r2.example.workers.dev/example/1MB.bin',\n    headers={\n        'X-Custom-Auth-Key': AUTH_KEY_SECRET\n    }\n)\n```\n\n## 参见\n\n- [用 cloudflare 的 R2 和 worker 来做文件托管](https://blog.yswtrue.com/yong-cloudflare-de-r2-he-worker-lai-zuo-wen-jian-tuo-guan/)\n- [Workers API reference](https://developers.cloudflare.com/r2/api/workers/workers-api-reference/)\n- [Use R2 from Workers](https://developers.cloudflare.com/r2/api/workers/workers-api-usage/)\n- [创建已签名的 AWS API 请求](https://docs.aws.amazon.com/zh_cn/IAM/latest/UserGuide/create-signed-request.html)\n",{"title":5,"description":206},"posts/zh/build-restful-api-for-cloudflare-r2-with-cloudflare-workers",false,[1575,1576,1577,1578],"Image Hosting","Cloudflare","JavaScript","Python","7naEbnZvslHgNUh3s6ktQawFWuu3sHAPAmcYVMq6bt0",[1581,1586],{"title":1582,"path":1583,"stem":1584,"date":1585,"lang":1567,"children":-1},"自建图床小记三—— SSL 证书的自动更新与部署","/2024/08/14/auto-renew-ssl-certificate-and-deploy-to-upyun-with-github-action","posts/zh/auto-renew-ssl-certificate-and-deploy-to-upyun-with-github-action","2024-08-14 10:35:18",{"title":1587,"path":1588,"stem":1589,"date":1590,"lang":1567,"children":-1},"自建图床小记一——图床架构与 DNS 解析","/2024/08/12/new-picbed-based-on-cloudflare-and-upyun","posts/zh/new-picbed-based-on-cloudflare-and-upyun","2024-08-12 17:07:11",null,1763654600755]