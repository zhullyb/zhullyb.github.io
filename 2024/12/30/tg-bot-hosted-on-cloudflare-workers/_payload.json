[{"data":1,"prerenderedAt":1235},["ShallowReactive",2],{"post-2024-12-30-tg-bot-hosted-on-cloudflare-workers":3,"surround-2024-12-30-tg-bot-hosted-on-cloudflare-workers":1224,"randomIndex/2024/12/30/tg-bot-hosted-on-cloudflare-workers":615},{"id":4,"title":5,"body":6,"date":1212,"description":97,"extension":1213,"meta":1214,"navigation":474,"path":1215,"rawbody":1216,"seo":1217,"stem":1218,"sticky":1219,"tags":1220,"__hash__":1223},"posts/posts/tg-bot-hosted-on-cloudflare-workers.md","构建部署在 Cloudflare Workers 上的 TG Bot",{"type":7,"value":8,"toc":1201},"minimark",[9,13,27,40,43,47,55,64,67,70,73,76,80,83,91,153,156,159,364,367,370,804,807,1173,1177,1180,1183,1189,1192,1197],[10,11,12],"h2",{"id":12},"起因",[14,15,16,17,22,23],"p",{},"早在去年 10 月，我就写过一篇",[18,19,21],"a",{"href":20},"/2023/10/29/create-b23tv-remover-bot/","《创建 b23.tv 追踪参数移除 bot》","。记录了部署 b23.tv 的追踪参数移除 Bot 的部署方案。其中提到的 TG Bot 随着服务器到期不再续费也一同落灰了——",[24,25,26],"strong",{},"公益服务总是这样，开始时满腔热血，随着时间散去没有多少人能坚持投入成本，徒留下一地鸡毛。",[14,28,29,30,36,37],{},"大概半个月前，我在群里看见 ",[18,31,35],{"href":32,"rel":33},"https://asukaminato.eu.org/",[34],"nofollow","Asuka Minato"," 开发的群消息总结 Bot，整体部署在 Cloudflare Workers 上，在保证零运营成本的情况下有着相当非常不错的在线率保证，因此便考虑将这个 Bot 迁移到 Cloudflare Workers 上。",[24,38,39],{},"选用免费的 serverless 能够有效延长服务的可持续性，它不需要额外投入时间精力和财力进行维护，通常可以活很久。",[14,41,42],{},"之所以可以把 TG Bot 部署到 Cloudflare Workers 上，主要是得益于 TG 平台支持 webhook 的方式让 Bot 程序提供服务。我们所需要提供的是一个公网能访问的 http 地址，在成功注册 webhook 服务后，TG 的官方服务器会将所有 Bot 所在群或者和所有对个人的对话以 http 请求的方式打到这个 url 上，而 Cloudflare Workers 平台就能提供一个 workers.dev 结尾的公网 url 作为 webhook 提供给 TG 服务器。",[10,44,46],{"id":45},"怎么做","怎么做？",[14,48,49,54],{},[18,50,53],{"href":51,"rel":52},"https://github.com/cvzi/telegram-bot-cloudflare",[34],"在这个 Github 仓库中","，给出了不少例子，用以讲述如何利用 Cloudflare Workers 构建 TG Bot。",[14,56,57,58,63],{},"在 ",[18,59,62],{"href":60,"rel":61},"https://github.com/cvzi/telegram-bot-cloudflare/blob/main/bot.js",[34],"bot.js"," 这个文件中编写了一个最简单的 TG Bot，其功能是: 将受到的所有消息在头部添加「Echo:」字符串，并发送回刚才的对话。",[14,65,66],{},"例: 用户发送 「Hello」，bot 回复 「Echo: Hello」",[68,69],"hr",{},[10,71,72],{"id":72},"代码分析",[14,74,75],{},"代码整体分为四个部分",[77,78,79],"h3",{"id":79},"顶部变量",[14,81,82],{},"文件顶部定义了 Bot 的 token、webhook 的 url 路径以及一个简易的 webhook 密码。",[14,84,85,86,90],{},"TOKEN 是从 botfather 那里获得的 bot token，SECRET 是自己设置的 webhook 密码，TG 的 webhook 服务器会通过把这个字段添加到名为 ",[87,88,89],"code",{},"X-Telegram-Bot-Api-Secret-Token"," 的请求头中来证明自己的官方身份。",[92,93,98],"pre",{"className":94,"code":95,"language":96,"meta":97,"style":97},"language-javascript shiki shiki-themes github-light github-dark","const TOKEN = ENV_BOT_TOKEN // Get it from @BotFather https://core.telegram.org/bots#6-botfather\nconst WEBHOOK = '/endpoint'\nconst SECRET = ENV_BOT_SECRET // A-Z, a-z, 0-9, _ and -\n","javascript","",[87,99,100,123,137],{"__ignoreMap":97},[101,102,105,109,113,116,119],"span",{"class":103,"line":104},"line",1,[101,106,108],{"class":107},"szBVR","const",[101,110,112],{"class":111},"sj4cs"," TOKEN",[101,114,115],{"class":107}," =",[101,117,118],{"class":111}," ENV_BOT_TOKEN",[101,120,122],{"class":121},"sJ8bj"," // Get it from @BotFather https://core.telegram.org/bots#6-botfather\n",[101,124,126,128,131,133],{"class":103,"line":125},2,[101,127,108],{"class":107},[101,129,130],{"class":111}," WEBHOOK",[101,132,115],{"class":107},[101,134,136],{"class":135},"sZZnC"," '/endpoint'\n",[101,138,140,142,145,147,150],{"class":103,"line":139},3,[101,141,108],{"class":107},[101,143,144],{"class":111}," SECRET",[101,146,115],{"class":107},[101,148,149],{"class":111}," ENV_BOT_SECRET",[101,151,152],{"class":121}," // A-Z, a-z, 0-9, _ and -\n",[77,154,155],{"id":155},"简易路由",[14,157,158],{},"紧接着定义了一个简易的路由",[92,160,162],{"className":94,"code":161,"language":96,"meta":97,"style":97},"addEventListener('fetch', event => {\n  const url = new URL(event.request.url)\n  if (url.pathname === WEBHOOK) {\n    event.respondWith(handleWebhook(event))\n  } else if (url.pathname === '/registerWebhook') {\n    event.respondWith(registerWebhook(event, url, WEBHOOK, SECRET))\n  } else if (url.pathname === '/unRegisterWebhook') {\n    event.respondWith(unRegisterWebhook(event))\n  } else {\n    event.respondWith(new Response('No handler for this request'))\n  }\n})\n",[87,163,164,190,209,225,242,263,289,307,321,330,352,358],{"__ignoreMap":97},[101,165,166,170,174,177,180,184,187],{"class":103,"line":104},[101,167,169],{"class":168},"sScJk","addEventListener",[101,171,173],{"class":172},"sVt8B","(",[101,175,176],{"class":135},"'fetch'",[101,178,179],{"class":172},", ",[101,181,183],{"class":182},"s4XuR","event",[101,185,186],{"class":107}," =>",[101,188,189],{"class":172}," {\n",[101,191,192,195,198,200,203,206],{"class":103,"line":125},[101,193,194],{"class":107},"  const",[101,196,197],{"class":111}," url",[101,199,115],{"class":107},[101,201,202],{"class":107}," new",[101,204,205],{"class":168}," URL",[101,207,208],{"class":172},"(event.request.url)\n",[101,210,211,214,217,220,222],{"class":103,"line":139},[101,212,213],{"class":107},"  if",[101,215,216],{"class":172}," (url.pathname ",[101,218,219],{"class":107},"===",[101,221,130],{"class":111},[101,223,224],{"class":172},") {\n",[101,226,228,231,234,236,239],{"class":103,"line":227},4,[101,229,230],{"class":172},"    event.",[101,232,233],{"class":168},"respondWith",[101,235,173],{"class":172},[101,237,238],{"class":168},"handleWebhook",[101,240,241],{"class":172},"(event))\n",[101,243,245,248,251,254,256,258,261],{"class":103,"line":244},5,[101,246,247],{"class":172},"  } ",[101,249,250],{"class":107},"else",[101,252,253],{"class":107}," if",[101,255,216],{"class":172},[101,257,219],{"class":107},[101,259,260],{"class":135}," '/registerWebhook'",[101,262,224],{"class":172},[101,264,266,268,270,272,275,278,281,283,286],{"class":103,"line":265},6,[101,267,230],{"class":172},[101,269,233],{"class":168},[101,271,173],{"class":172},[101,273,274],{"class":168},"registerWebhook",[101,276,277],{"class":172},"(event, url, ",[101,279,280],{"class":111},"WEBHOOK",[101,282,179],{"class":172},[101,284,285],{"class":111},"SECRET",[101,287,288],{"class":172},"))\n",[101,290,292,294,296,298,300,302,305],{"class":103,"line":291},7,[101,293,247],{"class":172},[101,295,250],{"class":107},[101,297,253],{"class":107},[101,299,216],{"class":172},[101,301,219],{"class":107},[101,303,304],{"class":135}," '/unRegisterWebhook'",[101,306,224],{"class":172},[101,308,310,312,314,316,319],{"class":103,"line":309},8,[101,311,230],{"class":172},[101,313,233],{"class":168},[101,315,173],{"class":172},[101,317,318],{"class":168},"unRegisterWebhook",[101,320,241],{"class":172},[101,322,324,326,328],{"class":103,"line":323},9,[101,325,247],{"class":172},[101,327,250],{"class":107},[101,329,189],{"class":172},[101,331,333,335,337,339,342,345,347,350],{"class":103,"line":332},10,[101,334,230],{"class":172},[101,336,233],{"class":168},[101,338,173],{"class":172},[101,340,341],{"class":107},"new",[101,343,344],{"class":168}," Response",[101,346,173],{"class":172},[101,348,349],{"class":135},"'No handler for this request'",[101,351,288],{"class":172},[101,353,355],{"class":103,"line":354},11,[101,356,357],{"class":172},"  }\n",[101,359,361],{"class":103,"line":360},12,[101,362,363],{"class":172},"})\n",[77,365,366],{"id":366},"核心功能",[14,368,369],{},"随后的三个函数，会先进行 SECRET 的校验，并将 message 类型消息从 TG 的所有消息类型中分离开单独处理",[92,371,373],{"className":94,"code":372,"language":96,"meta":97,"style":97},"/**\n * Handle requests to WEBHOOK\n * https://core.telegram.org/bots/api#update\n */\nasync function handleWebhook (event) {\n  // Check secret\n  if (event.request.headers.get('X-Telegram-Bot-Api-Secret-Token') !== SECRET) {\n    return new Response('Unauthorized', { status: 403 })\n  }\n\n  // Read request body synchronously\n  const update = await event.request.json()\n  // Deal with response asynchronously\n  event.waitUntil(onUpdate(update))\n\n  return new Response('Ok')\n}\n\n/**\n * Handle incoming Update\n * https://core.telegram.org/bots/api#update\n */\nasync function onUpdate (update) {\n  if ('message' in update) {\n    await onMessage(update.message)\n  }\n}\n\n/**\n * Handle incoming Message\n * https://core.telegram.org/bots/api#message\n */\nfunction onMessage (message) {\n  return sendPlainText(message.chat.id, 'Echo:\\n' + message.text)\n}\n\n/**\n * Send plain text message\n * https://core.telegram.org/bots/api#sendmessage\n */\nasync function sendPlainText (chatId, text) {\n  return (await fetch(apiUrl('sendMessage', {\n    chat_id: chatId,\n    text\n  }))).json()\n",[87,374,375,380,385,390,395,413,418,443,466,470,476,481,502,508,525,530,548,554,559,564,570,575,580,597,613,625,630,635,640,645,651,657,662,677,703,708,713,718,724,730,735,756,782,788,794],{"__ignoreMap":97},[101,376,377],{"class":103,"line":104},[101,378,379],{"class":121},"/**\n",[101,381,382],{"class":103,"line":125},[101,383,384],{"class":121}," * Handle requests to WEBHOOK\n",[101,386,387],{"class":103,"line":139},[101,388,389],{"class":121}," * https://core.telegram.org/bots/api#update\n",[101,391,392],{"class":103,"line":227},[101,393,394],{"class":121}," */\n",[101,396,397,400,403,406,409,411],{"class":103,"line":244},[101,398,399],{"class":107},"async",[101,401,402],{"class":107}," function",[101,404,405],{"class":168}," handleWebhook",[101,407,408],{"class":172}," (",[101,410,183],{"class":182},[101,412,224],{"class":172},[101,414,415],{"class":103,"line":265},[101,416,417],{"class":121},"  // Check secret\n",[101,419,420,422,425,428,430,433,436,439,441],{"class":103,"line":291},[101,421,213],{"class":107},[101,423,424],{"class":172}," (event.request.headers.",[101,426,427],{"class":168},"get",[101,429,173],{"class":172},[101,431,432],{"class":135},"'X-Telegram-Bot-Api-Secret-Token'",[101,434,435],{"class":172},") ",[101,437,438],{"class":107},"!==",[101,440,144],{"class":111},[101,442,224],{"class":172},[101,444,445,448,450,452,454,457,460,463],{"class":103,"line":309},[101,446,447],{"class":107},"    return",[101,449,202],{"class":107},[101,451,344],{"class":168},[101,453,173],{"class":172},[101,455,456],{"class":135},"'Unauthorized'",[101,458,459],{"class":172},", { status: ",[101,461,462],{"class":111},"403",[101,464,465],{"class":172}," })\n",[101,467,468],{"class":103,"line":323},[101,469,357],{"class":172},[101,471,472],{"class":103,"line":332},[101,473,475],{"emptyLinePlaceholder":474},true,"\n",[101,477,478],{"class":103,"line":354},[101,479,480],{"class":121},"  // Read request body synchronously\n",[101,482,483,485,488,490,493,496,499],{"class":103,"line":360},[101,484,194],{"class":107},[101,486,487],{"class":111}," update",[101,489,115],{"class":107},[101,491,492],{"class":107}," await",[101,494,495],{"class":172}," event.request.",[101,497,498],{"class":168},"json",[101,500,501],{"class":172},"()\n",[101,503,505],{"class":103,"line":504},13,[101,506,507],{"class":121},"  // Deal with response asynchronously\n",[101,509,511,514,517,519,522],{"class":103,"line":510},14,[101,512,513],{"class":172},"  event.",[101,515,516],{"class":168},"waitUntil",[101,518,173],{"class":172},[101,520,521],{"class":168},"onUpdate",[101,523,524],{"class":172},"(update))\n",[101,526,528],{"class":103,"line":527},15,[101,529,475],{"emptyLinePlaceholder":474},[101,531,533,536,538,540,542,545],{"class":103,"line":532},16,[101,534,535],{"class":107},"  return",[101,537,202],{"class":107},[101,539,344],{"class":168},[101,541,173],{"class":172},[101,543,544],{"class":135},"'Ok'",[101,546,547],{"class":172},")\n",[101,549,551],{"class":103,"line":550},17,[101,552,553],{"class":172},"}\n",[101,555,557],{"class":103,"line":556},18,[101,558,475],{"emptyLinePlaceholder":474},[101,560,562],{"class":103,"line":561},19,[101,563,379],{"class":121},[101,565,567],{"class":103,"line":566},20,[101,568,569],{"class":121}," * Handle incoming Update\n",[101,571,573],{"class":103,"line":572},21,[101,574,389],{"class":121},[101,576,578],{"class":103,"line":577},22,[101,579,394],{"class":121},[101,581,583,585,587,590,592,595],{"class":103,"line":582},23,[101,584,399],{"class":107},[101,586,402],{"class":107},[101,588,589],{"class":168}," onUpdate",[101,591,408],{"class":172},[101,593,594],{"class":182},"update",[101,596,224],{"class":172},[101,598,600,602,604,607,610],{"class":103,"line":599},24,[101,601,213],{"class":107},[101,603,408],{"class":172},[101,605,606],{"class":135},"'message'",[101,608,609],{"class":107}," in",[101,611,612],{"class":172}," update) {\n",[101,614,616,619,622],{"class":103,"line":615},25,[101,617,618],{"class":107},"    await",[101,620,621],{"class":168}," onMessage",[101,623,624],{"class":172},"(update.message)\n",[101,626,628],{"class":103,"line":627},26,[101,629,357],{"class":172},[101,631,633],{"class":103,"line":632},27,[101,634,553],{"class":172},[101,636,638],{"class":103,"line":637},28,[101,639,475],{"emptyLinePlaceholder":474},[101,641,643],{"class":103,"line":642},29,[101,644,379],{"class":121},[101,646,648],{"class":103,"line":647},30,[101,649,650],{"class":121}," * Handle incoming Message\n",[101,652,654],{"class":103,"line":653},31,[101,655,656],{"class":121}," * https://core.telegram.org/bots/api#message\n",[101,658,660],{"class":103,"line":659},32,[101,661,394],{"class":121},[101,663,665,668,670,672,675],{"class":103,"line":664},33,[101,666,667],{"class":107},"function",[101,669,621],{"class":168},[101,671,408],{"class":172},[101,673,674],{"class":182},"message",[101,676,224],{"class":172},[101,678,680,682,685,688,691,694,697,700],{"class":103,"line":679},34,[101,681,535],{"class":107},[101,683,684],{"class":168}," sendPlainText",[101,686,687],{"class":172},"(message.chat.id, ",[101,689,690],{"class":135},"'Echo:",[101,692,693],{"class":111},"\\n",[101,695,696],{"class":135},"'",[101,698,699],{"class":107}," +",[101,701,702],{"class":172}," message.text)\n",[101,704,706],{"class":103,"line":705},35,[101,707,553],{"class":172},[101,709,711],{"class":103,"line":710},36,[101,712,475],{"emptyLinePlaceholder":474},[101,714,716],{"class":103,"line":715},37,[101,717,379],{"class":121},[101,719,721],{"class":103,"line":720},38,[101,722,723],{"class":121}," * Send plain text message\n",[101,725,727],{"class":103,"line":726},39,[101,728,729],{"class":121}," * https://core.telegram.org/bots/api#sendmessage\n",[101,731,733],{"class":103,"line":732},40,[101,734,394],{"class":121},[101,736,738,740,742,744,746,749,751,754],{"class":103,"line":737},41,[101,739,399],{"class":107},[101,741,402],{"class":107},[101,743,684],{"class":168},[101,745,408],{"class":172},[101,747,748],{"class":182},"chatId",[101,750,179],{"class":172},[101,752,753],{"class":182},"text",[101,755,224],{"class":172},[101,757,759,761,763,766,769,771,774,776,779],{"class":103,"line":758},42,[101,760,535],{"class":107},[101,762,408],{"class":172},[101,764,765],{"class":107},"await",[101,767,768],{"class":168}," fetch",[101,770,173],{"class":172},[101,772,773],{"class":168},"apiUrl",[101,775,173],{"class":172},[101,777,778],{"class":135},"'sendMessage'",[101,780,781],{"class":172},", {\n",[101,783,785],{"class":103,"line":784},43,[101,786,787],{"class":172},"    chat_id: chatId,\n",[101,789,791],{"class":103,"line":790},44,[101,792,793],{"class":172},"    text\n",[101,795,797,800,802],{"class":103,"line":796},45,[101,798,799],{"class":172},"  }))).",[101,801,498],{"class":168},[101,803,501],{"class":172},[14,805,806],{},"我们需要更改的就是这个 onMessage 函数，用户输入的文本信息通过 message.text 获取，我们可以很轻易的把 b23 remover 的逻辑用 js 实现",[92,808,810],{"className":94,"code":809,"language":96,"meta":97,"style":97},"async function onMessage(message) {\n    if (!message.text) {\n        return;\n    }\n    const b23Reg = /b23\\.tv\\/[a-zA-Z0-9]+/g;\n    if (!b23Reg.test(message.text)) {\n        console.log('No match found');\n    }\n    const b23Links = message.text.match(b23Reg);\n    const cleanLinks = [];\n    await Promise.all(\n        b23Links.map(link => b23Remover('https://' + link))\n    ).then(result => {\n        cleanLinks.push(...result);\n    });\n\n    const text2Send = \"Track ID removed:\\n\" + cleanLinks.join(\"\\n\");\n    return sendPlainText(message.chat.id, text2Send);\n}\n\nasync function b23Remover (url) {\n    const r = await fetch(url)\n    const v = r.url\n    const u = new URL(v)\n    return u.origin + u.pathname\n}\n",[87,811,812,826,839,847,852,893,910,926,930,948,960,976,1004,1021,1037,1042,1046,1081,1090,1094,1098,1113,1129,1141,1157,1169],{"__ignoreMap":97},[101,813,814,816,818,820,822,824],{"class":103,"line":104},[101,815,399],{"class":107},[101,817,402],{"class":107},[101,819,621],{"class":168},[101,821,173],{"class":172},[101,823,674],{"class":182},[101,825,224],{"class":172},[101,827,828,831,833,836],{"class":103,"line":125},[101,829,830],{"class":107},"    if",[101,832,408],{"class":172},[101,834,835],{"class":107},"!",[101,837,838],{"class":172},"message.text) {\n",[101,840,841,844],{"class":103,"line":139},[101,842,843],{"class":107},"        return",[101,845,846],{"class":172},";\n",[101,848,849],{"class":103,"line":227},[101,850,851],{"class":172},"    }\n",[101,853,854,857,860,862,865,869,873,876,879,882,885,888,891],{"class":103,"line":244},[101,855,856],{"class":107},"    const",[101,858,859],{"class":111}," b23Reg",[101,861,115],{"class":107},[101,863,864],{"class":135}," /",[101,866,868],{"class":867},"sA_wV","b23",[101,870,872],{"class":871},"snhLl","\\.",[101,874,875],{"class":867},"tv",[101,877,878],{"class":871},"\\/",[101,880,881],{"class":111},"[a-zA-Z0-9]",[101,883,884],{"class":107},"+",[101,886,887],{"class":135},"/",[101,889,890],{"class":107},"g",[101,892,846],{"class":172},[101,894,895,897,899,901,904,907],{"class":103,"line":265},[101,896,830],{"class":107},[101,898,408],{"class":172},[101,900,835],{"class":107},[101,902,903],{"class":172},"b23Reg.",[101,905,906],{"class":168},"test",[101,908,909],{"class":172},"(message.text)) {\n",[101,911,912,915,918,920,923],{"class":103,"line":291},[101,913,914],{"class":172},"        console.",[101,916,917],{"class":168},"log",[101,919,173],{"class":172},[101,921,922],{"class":135},"'No match found'",[101,924,925],{"class":172},");\n",[101,927,928],{"class":103,"line":309},[101,929,851],{"class":172},[101,931,932,934,937,939,942,945],{"class":103,"line":323},[101,933,856],{"class":107},[101,935,936],{"class":111}," b23Links",[101,938,115],{"class":107},[101,940,941],{"class":172}," message.text.",[101,943,944],{"class":168},"match",[101,946,947],{"class":172},"(b23Reg);\n",[101,949,950,952,955,957],{"class":103,"line":332},[101,951,856],{"class":107},[101,953,954],{"class":111}," cleanLinks",[101,956,115],{"class":107},[101,958,959],{"class":172}," [];\n",[101,961,962,964,967,970,973],{"class":103,"line":354},[101,963,618],{"class":107},[101,965,966],{"class":111}," Promise",[101,968,969],{"class":172},".",[101,971,972],{"class":168},"all",[101,974,975],{"class":172},"(\n",[101,977,978,981,984,986,989,991,994,996,999,1001],{"class":103,"line":360},[101,979,980],{"class":172},"        b23Links.",[101,982,983],{"class":168},"map",[101,985,173],{"class":172},[101,987,988],{"class":182},"link",[101,990,186],{"class":107},[101,992,993],{"class":168}," b23Remover",[101,995,173],{"class":172},[101,997,998],{"class":135},"'https://'",[101,1000,699],{"class":107},[101,1002,1003],{"class":172}," link))\n",[101,1005,1006,1009,1012,1014,1017,1019],{"class":103,"line":504},[101,1007,1008],{"class":172},"    ).",[101,1010,1011],{"class":168},"then",[101,1013,173],{"class":172},[101,1015,1016],{"class":182},"result",[101,1018,186],{"class":107},[101,1020,189],{"class":172},[101,1022,1023,1026,1029,1031,1034],{"class":103,"line":510},[101,1024,1025],{"class":172},"        cleanLinks.",[101,1027,1028],{"class":168},"push",[101,1030,173],{"class":172},[101,1032,1033],{"class":107},"...",[101,1035,1036],{"class":172},"result);\n",[101,1038,1039],{"class":103,"line":527},[101,1040,1041],{"class":172},"    });\n",[101,1043,1044],{"class":103,"line":532},[101,1045,475],{"emptyLinePlaceholder":474},[101,1047,1048,1050,1053,1055,1058,1060,1063,1065,1068,1071,1073,1075,1077,1079],{"class":103,"line":550},[101,1049,856],{"class":107},[101,1051,1052],{"class":111}," text2Send",[101,1054,115],{"class":107},[101,1056,1057],{"class":135}," \"Track ID removed:",[101,1059,693],{"class":111},[101,1061,1062],{"class":135},"\"",[101,1064,699],{"class":107},[101,1066,1067],{"class":172}," cleanLinks.",[101,1069,1070],{"class":168},"join",[101,1072,173],{"class":172},[101,1074,1062],{"class":135},[101,1076,693],{"class":111},[101,1078,1062],{"class":135},[101,1080,925],{"class":172},[101,1082,1083,1085,1087],{"class":103,"line":556},[101,1084,447],{"class":107},[101,1086,684],{"class":168},[101,1088,1089],{"class":172},"(message.chat.id, text2Send);\n",[101,1091,1092],{"class":103,"line":561},[101,1093,553],{"class":172},[101,1095,1096],{"class":103,"line":566},[101,1097,475],{"emptyLinePlaceholder":474},[101,1099,1100,1102,1104,1106,1108,1111],{"class":103,"line":572},[101,1101,399],{"class":107},[101,1103,402],{"class":107},[101,1105,993],{"class":168},[101,1107,408],{"class":172},[101,1109,1110],{"class":182},"url",[101,1112,224],{"class":172},[101,1114,1115,1117,1120,1122,1124,1126],{"class":103,"line":577},[101,1116,856],{"class":107},[101,1118,1119],{"class":111}," r",[101,1121,115],{"class":107},[101,1123,492],{"class":107},[101,1125,768],{"class":168},[101,1127,1128],{"class":172},"(url)\n",[101,1130,1131,1133,1136,1138],{"class":103,"line":582},[101,1132,856],{"class":107},[101,1134,1135],{"class":111}," v",[101,1137,115],{"class":107},[101,1139,1140],{"class":172}," r.url\n",[101,1142,1143,1145,1148,1150,1152,1154],{"class":103,"line":599},[101,1144,856],{"class":107},[101,1146,1147],{"class":111}," u",[101,1149,115],{"class":107},[101,1151,202],{"class":107},[101,1153,205],{"class":168},[101,1155,1156],{"class":172},"(v)\n",[101,1158,1159,1161,1164,1166],{"class":103,"line":615},[101,1160,447],{"class":107},[101,1162,1163],{"class":172}," u.origin ",[101,1165,884],{"class":107},[101,1167,1168],{"class":172}," u.pathname\n",[101,1170,1171],{"class":103,"line":627},[101,1172,553],{"class":172},[77,1174,1176],{"id":1175},"webhook-注册相关","webhook 注册相关",[14,1178,1179],{},"后面的 registerWebhook、unRegisterWebhook、apiUrl 在没有特定需求的情况下不需要变动。",[14,1181,1182],{},"在 Cloudflare 部署后，就可以访问 aaa.bbb.workers.dev/registerWebhook 这个 url 注册 TG 的 webhook 服务。收到 Ok 就代表注册好了。",[14,1184,1185],{},[1186,1187],"img",{"alt":97,"src":1188},"https://static.031130.xyz/uploads/2024/12/30/5fd442bb18064.webp",[10,1190,1191],{"id":1191},"成果展示",[14,1193,1194],{},[1186,1195],{"alt":97,"src":1196},"https://static.031130.xyz/uploads/2024/12/30/3b0b929960840.webp",[1198,1199,1200],"style",{},"html pre.shiki code .szBVR, html code.shiki .szBVR{--shiki-default:#D73A49;--shiki-dark:#F97583}html pre.shiki code .sj4cs, html code.shiki .sj4cs{--shiki-default:#005CC5;--shiki-dark:#79B8FF}html pre.shiki code .sJ8bj, html code.shiki .sJ8bj{--shiki-default:#6A737D;--shiki-dark:#6A737D}html pre.shiki code .sZZnC, html code.shiki .sZZnC{--shiki-default:#032F62;--shiki-dark:#9ECBFF}html .default .shiki span {color: var(--shiki-default);background: var(--shiki-default-bg);font-style: var(--shiki-default-font-style);font-weight: var(--shiki-default-font-weight);text-decoration: var(--shiki-default-text-decoration);}html .shiki span {color: var(--shiki-default);background: var(--shiki-default-bg);font-style: var(--shiki-default-font-style);font-weight: var(--shiki-default-font-weight);text-decoration: var(--shiki-default-text-decoration);}html .dark .shiki span {color: var(--shiki-dark);background: var(--shiki-dark-bg);font-style: var(--shiki-dark-font-style);font-weight: var(--shiki-dark-font-weight);text-decoration: var(--shiki-dark-text-decoration);}html.dark .shiki span {color: var(--shiki-dark);background: var(--shiki-dark-bg);font-style: var(--shiki-dark-font-style);font-weight: var(--shiki-dark-font-weight);text-decoration: var(--shiki-dark-text-decoration);}html pre.shiki code .sScJk, html code.shiki .sScJk{--shiki-default:#6F42C1;--shiki-dark:#B392F0}html pre.shiki code .sVt8B, html code.shiki .sVt8B{--shiki-default:#24292E;--shiki-dark:#E1E4E8}html pre.shiki code .s4XuR, html code.shiki .s4XuR{--shiki-default:#E36209;--shiki-dark:#FFAB70}html pre.shiki code .sA_wV, html code.shiki .sA_wV{--shiki-default:#032F62;--shiki-dark:#DBEDFF}html pre.shiki code .snhLl, html code.shiki .snhLl{--shiki-default:#22863A;--shiki-default-font-weight:bold;--shiki-dark:#85E89D;--shiki-dark-font-weight:bold}",{"title":97,"searchDepth":125,"depth":125,"links":1202},[1203,1204,1205,1211],{"id":12,"depth":125,"text":12},{"id":45,"depth":125,"text":46},{"id":72,"depth":125,"text":72,"children":1206},[1207,1208,1209,1210],{"id":79,"depth":139,"text":79},{"id":155,"depth":139,"text":155},{"id":366,"depth":139,"text":366},{"id":1175,"depth":139,"text":1176},{"id":1191,"depth":125,"text":1191},"2024-12-30 19:45:43","md",{},"/2024/12/30/tg-bot-hosted-on-cloudflare-workers","---\ntitle: 构建部署在 Cloudflare Workers 上的 TG Bot\ndate: 2024-12-30 19:45:43\nsticky:\ntags:\n- Bot\n- Cloudflare\n---\n\n## 起因\n\n早在去年 10 月，我就写过一篇[《创建 b23.tv 追踪参数移除 bot》](/2023/10/29/create-b23tv-remover-bot/)。记录了部署 b23.tv 的追踪参数移除 Bot 的部署方案。其中提到的 TG Bot 随着服务器到期不再续费也一同落灰了——**公益服务总是这样，开始时满腔热血，随着时间散去没有多少人能坚持投入成本，徒留下一地鸡毛。**\n\n大概半个月前，我在群里看见 [Asuka Minato](https://asukaminato.eu.org/) 开发的群消息总结 Bot，整体部署在 Cloudflare Workers 上，在保证零运营成本的情况下有着相当非常不错的在线率保证，因此便考虑将这个 Bot 迁移到 Cloudflare Workers 上。**选用免费的 serverless 能够有效延长服务的可持续性，它不需要额外投入时间精力和财力进行维护，通常可以活很久。**\n\n之所以可以把 TG Bot 部署到 Cloudflare Workers 上，主要是得益于 TG 平台支持 webhook 的方式让 Bot 程序提供服务。我们所需要提供的是一个公网能访问的 http 地址，在成功注册 webhook 服务后，TG 的官方服务器会将所有 Bot 所在群或者和所有对个人的对话以 http 请求的方式打到这个 url 上，而 Cloudflare Workers 平台就能提供一个 workers.dev 结尾的公网 url 作为 webhook 提供给 TG 服务器。\n\n## 怎么做？\n\n[在这个 Github 仓库中](https://github.com/cvzi/telegram-bot-cloudflare)，给出了不少例子，用以讲述如何利用 Cloudflare Workers 构建 TG Bot。\n\n在 [bot.js](https://github.com/cvzi/telegram-bot-cloudflare/blob/main/bot.js) 这个文件中编写了一个最简单的 TG Bot，其功能是: 将受到的所有消息在头部添加「Echo:」字符串，并发送回刚才的对话。\n\n例: 用户发送 「Hello」，bot 回复 「Echo: Hello」\n\n***\n\n## 代码分析\n\n代码整体分为四个部分\n\n### 顶部变量\n\n文件顶部定义了 Bot 的 token、webhook 的 url 路径以及一个简易的 webhook 密码。\n\nTOKEN 是从 botfather 那里获得的 bot token，SECRET 是自己设置的 webhook 密码，TG 的 webhook 服务器会通过把这个字段添加到名为 `X-Telegram-Bot-Api-Secret-Token` 的请求头中来证明自己的官方身份。\n\n```javascript\nconst TOKEN = ENV_BOT_TOKEN // Get it from @BotFather https://core.telegram.org/bots#6-botfather\nconst WEBHOOK = '/endpoint'\nconst SECRET = ENV_BOT_SECRET // A-Z, a-z, 0-9, _ and -\n```\n\n### 简易路由\n\n紧接着定义了一个简易的路由\n\n```javascript\naddEventListener('fetch', event => {\n  const url = new URL(event.request.url)\n  if (url.pathname === WEBHOOK) {\n    event.respondWith(handleWebhook(event))\n  } else if (url.pathname === '/registerWebhook') {\n    event.respondWith(registerWebhook(event, url, WEBHOOK, SECRET))\n  } else if (url.pathname === '/unRegisterWebhook') {\n    event.respondWith(unRegisterWebhook(event))\n  } else {\n    event.respondWith(new Response('No handler for this request'))\n  }\n})\n```\n\n### 核心功能\n\n随后的三个函数，会先进行 SECRET 的校验，并将 message 类型消息从 TG 的所有消息类型中分离开单独处理\n\n```javascript\n/**\n * Handle requests to WEBHOOK\n * https://core.telegram.org/bots/api#update\n */\nasync function handleWebhook (event) {\n  // Check secret\n  if (event.request.headers.get('X-Telegram-Bot-Api-Secret-Token') !== SECRET) {\n    return new Response('Unauthorized', { status: 403 })\n  }\n\n  // Read request body synchronously\n  const update = await event.request.json()\n  // Deal with response asynchronously\n  event.waitUntil(onUpdate(update))\n\n  return new Response('Ok')\n}\n\n/**\n * Handle incoming Update\n * https://core.telegram.org/bots/api#update\n */\nasync function onUpdate (update) {\n  if ('message' in update) {\n    await onMessage(update.message)\n  }\n}\n\n/**\n * Handle incoming Message\n * https://core.telegram.org/bots/api#message\n */\nfunction onMessage (message) {\n  return sendPlainText(message.chat.id, 'Echo:\\n' + message.text)\n}\n\n/**\n * Send plain text message\n * https://core.telegram.org/bots/api#sendmessage\n */\nasync function sendPlainText (chatId, text) {\n  return (await fetch(apiUrl('sendMessage', {\n    chat_id: chatId,\n    text\n  }))).json()\n```\n\n我们需要更改的就是这个 onMessage 函数，用户输入的文本信息通过 message.text 获取，我们可以很轻易的把 b23 remover 的逻辑用 js 实现\n\n```javascript\nasync function onMessage(message) {\n    if (!message.text) {\n        return;\n    }\n    const b23Reg = /b23\\.tv\\/[a-zA-Z0-9]+/g;\n    if (!b23Reg.test(message.text)) {\n        console.log('No match found');\n    }\n    const b23Links = message.text.match(b23Reg);\n    const cleanLinks = [];\n    await Promise.all(\n        b23Links.map(link => b23Remover('https://' + link))\n    ).then(result => {\n        cleanLinks.push(...result);\n    });\n\n    const text2Send = \"Track ID removed:\\n\" + cleanLinks.join(\"\\n\");\n    return sendPlainText(message.chat.id, text2Send);\n}\n\nasync function b23Remover (url) {\n    const r = await fetch(url)\n    const v = r.url\n    const u = new URL(v)\n    return u.origin + u.pathname\n}\n```\n\n### webhook 注册相关\n\n后面的 registerWebhook、unRegisterWebhook、apiUrl 在没有特定需求的情况下不需要变动。\n\n在 Cloudflare 部署后，就可以访问 aaa.bbb.workers.dev/registerWebhook 这个 url 注册 TG 的 webhook 服务。收到 Ok 就代表注册好了。\n\n![](https://static.031130.xyz/uploads/2024/12/30/5fd442bb18064.webp)\n\n## 成果展示\n\n![](https://static.031130.xyz/uploads/2024/12/30/3b0b929960840.webp)\n",{"title":5,"description":97},"posts/tg-bot-hosted-on-cloudflare-workers",false,[1221,1222],"Bot","Cloudflare","QYL3kceeBSne6lQKrD9v1ow9mY7KHcO_eN0D_N76uYs",[1225,1230],{"title":1226,"path":1227,"stem":1228,"date":1229,"children":-1},"基于 Cloudflare Workers 实现的在线服务状态检测告警系统","/2025/01/18/service-status-monitor-based-on-cloudflare-workers","posts/service-status-monitor-based-on-cloudflare-workers","2025-01-18 02:00:08",{"title":1231,"path":1232,"stem":1233,"date":1234,"children":-1},"2024年，Firefox 是唯一还在坚持执行在线的 SSL 证书吊销状态检查的主流浏览器","/2024/11/19/firefox-is-the-only-mainstream-brower-doing-online-certificate-revocation-checks","posts/firefox-is-the-only-mainstream-brower-doing-online-certificate-revocation-checks","2024-11-19 17:58:14",1761696666102]