[{"data":1,"prerenderedAt":376},["ShallowReactive",2],{"post-2024-07-31-capture-android-https-traffic-on-linux-with-mitmproxy-zh":3,"surround-2024-07-31-capture-android-https-traffic-on-linux-with-mitmproxy-zh":362,"randomIndex/2024/07/31/capture-android-https-traffic-on-linux-with-mitmproxy/":374,"language-switch-/2024/07/31/capture-android-https-traffic-on-linux-with-mitmproxy/-en":375},{"title":4,"date":5,"path":6,"tags":7,"body":13,"description":19},"在 Linux 下使用 mitmproxy 抓取安卓手机上的 HTTPS 流量","2024-07-31 16:02:28","/2024/07/31/capture-android-https-traffic-on-linux-with-mitmproxy",[8,9,10,11,12],"mitmproxy","Network","Linux","Archlinux","Android",{"type":14,"value":15,"toc":356},"minimark",[16,20,23,65,77,80,84,92,96,161,167,170,201,205,208,277,285,288,294,297,300,305,308,313,316,352],[17,18,19],"p",{},"纵使安卓下有小黄鸟 HttpCanary 这种抓包神器，但手机一块 6 英寸的小屏实在是不方便分析流量情况，还得是 PC 的屏幕更大一些，处理起流量信息来更得心应手一些。",[17,21,22],{},"把话说在前面，目前的安卓抓包有不小的限制",[24,25,26,30],"ul",{},[27,28,29],"li",{},"Android 7 以下的版本: 直接以普通用户的权限安装 ssl 证书即可被信任",[27,31,32,33],{},"Android 7 以上的版本:\n",[24,34,35,48],{},[27,36,37,38,42,43,47],{},"安全性较低的应用: ",[39,40,41],"strong",{},"需要使用 root 权限","将证书移动至 ",[44,45,46],"code",{},"/system/etc/security/cacerts","使证书被系统信任",[27,49,50,51,58,59,64],{},"安全性较高的应用（比如微信 7.0 以上的版本）: 在满足上一条条件的情况下，需要阻止第三方应用使用自带的 ssl 证书信任范围（绕过 SSL Pinning）。通常情况下需要额外的手段对目标应用进行篡改，比如使用 ",[52,53,57],"a",{"href":54,"rel":55},"https://github.com/Fuzion24/JustTrustMe",[56],"nofollow","justTrustMe"," 这个 xposed 模块，或者 ",[52,60,63],{"href":61,"rel":62},"https://github.com/frida/frida/",[56],"frida","。",[66,67,68],"blockquote",{},[17,69,70,71,76],{},"除此之外，Linux 版本 >= 5.5 的安卓设备也可以使用 ",[52,72,75],{"href":73,"rel":74},"https://github.com/gojue/ecapture",[56],"eCapture"," 这款基于 eBPF Linux 内核模块实现的抓包软件，算是种奇技淫巧。",[17,78,79],{},"本文只讨论 Android 7 以上版本中安全性较低的应用，因为我当前的抓包目标局限于一款安全性不高的外包软件。",[81,82,83],"h2",{"id":83},"基本操作",[17,85,86,87,91],{},"见「",[52,88,90],{"href":89},"/2024/02/29/capture-https-traffic-on-linux-with-mitmproxy/","在 Linux 下使用 mitmproxy 抓取 HTTPS 流量","」",[81,93,95],{"id":94},"安装-ssl-证书","安装 ssl 证书",[97,98,103],"pre",{"className":99,"code":100,"language":101,"meta":102,"style":102},"language-bash shiki shiki-themes one-light one-dark-pro","cp $HOME/.mitmproxy/mitmproxy-ca-cert.pem $(openssl x509 -subject_hash_old -in $HOME/.mitmproxy/mitmproxy-ca-cert.pem | head -n 1).0\n","bash","",[44,104,105],{"__ignoreMap":102},[106,107,110,114,118,122,126,129,132,136,139,141,143,146,149,152,155,158],"span",{"class":108,"line":109},"line",1,[106,111,113],{"class":112},"sAdtL","cp",[106,115,117],{"class":116},"sJa8x"," $HOME",[106,119,121],{"class":120},"sDhpE","/.mitmproxy/mitmproxy-ca-cert.pem",[106,123,125],{"class":124},"s5ixo"," $(",[106,127,128],{"class":112},"openssl",[106,130,131],{"class":120}," x509",[106,133,135],{"class":134},"sAGMh"," -subject_hash_old",[106,137,138],{"class":134}," -in",[106,140,117],{"class":116},[106,142,121],{"class":120},[106,144,145],{"class":124}," | ",[106,147,148],{"class":112},"head",[106,150,151],{"class":134}," -n",[106,153,154],{"class":134}," 1",[106,156,157],{"class":124},")",[106,159,160],{"class":120},".0\n",[17,162,163,164,166],{},"此时我们就可以在家目录下找到一个以 .0 结尾的证书文件，我们的目标是将其放到手机的 ",[44,165,46],{}," 路径下。",[17,168,169],{},"对于一些出厂安卓版本较低、system 分区采用可变文件系统的手机，我们可以很轻松的使用带有 root 权限的文件管理器将证书文件移动到对应的目录（我这里就是）；而对于出厂版本较高的手机，system 分区可能是不可写的，需要采用额外的奇技淫巧。",[66,171,172,175,178,181,184,187],{},[17,173,174],{},"1、通过 ADB 将 HTTP Toolkit CA 证书推送到设备上。",[17,176,177],{},"2、从 /system/etc/security/cacerts/ 中复制所有系统证书到临时目录。",[17,179,180],{},"3、在 /system/etc/security/cacerts/ 上面挂载一个 tmpfs 内存文件系统。这实际上将一个可写的全新空文件系统放在了 /system 的一小部分上面。 将复制的系统证书移回到该挂载点。",[17,182,183],{},"4、将 HTTP Toolkit CA 证书也移动到该挂载点。",[17,185,186],{},"5、更新临时挂载点中所有文件的权限为 644，并将系统文件的 SELinux 标签设置为 system_file，以使其看起来像是合法的 Android 系统文件。",[17,188,189,190,195,196,91],{},"——",[52,191,194],{"href":192,"rel":193},"http://91fans.com.cn/post/certificate/",[56],"《安卓高版本安装系统证书 HTTPS 抓包 - 终极解决方案》"," 「",[52,197,200],{"href":198,"rel":199},"http://web.archive.org/web/20240801045307/http://91fans.com.cn/post/certificate/#gsc.tab=0",[56],"archived here",[81,202,204],{"id":203},"让被抓包的应用流量经过-mitm-代理服务器","让被抓包的应用流量经过 mitm 代理服务器",[17,206,207],{},"mitmproxy 默认会在 pc 端的 8080 端口开启一个 http 代理服务器，我们要做的就是想办法让待抓包的应用流量被这个 http 代理服务器所代理。",[97,209,211],{"className":99,"code":210,"language":101,"meta":102,"style":102},"[zhullyb@Archlinux ~]$ ip -br a\nlo               UNKNOWN        127.0.0.1/8 ::1/128\nenp0s31f6        UP             172.16.0.255/25 fe80::2df9:2927:cd44:65c/64\nwlp0s20f3        UP             192.168.20.212/24 fe80::a6bc:919:281e:dcab/64\ndocker0          DOWN           172.17.0.1/16 fe80::42:d1ff:febe:d513/64\n",[44,212,213,218,233,248,262],{"__ignoreMap":102},[106,214,215],{"class":108,"line":109},[106,216,217],{"class":124},"[zhullyb@Archlinux ~]$ ip -br a\n",[106,219,221,224,227,230],{"class":108,"line":220},2,[106,222,223],{"class":112},"lo",[106,225,226],{"class":120},"               UNKNOWN",[106,228,229],{"class":120},"        127.0.0.1/8",[106,231,232],{"class":120}," ::1/128\n",[106,234,236,239,242,245],{"class":108,"line":235},3,[106,237,238],{"class":112},"enp0s31f6",[106,240,241],{"class":120},"        UP",[106,243,244],{"class":120},"             172.16.0.255/25",[106,246,247],{"class":120}," fe80::2df9:2927:cd44:65c/64\n",[106,249,251,254,256,259],{"class":108,"line":250},4,[106,252,253],{"class":112},"wlp0s20f3",[106,255,241],{"class":120},[106,257,258],{"class":120},"             192.168.20.212/24",[106,260,261],{"class":120}," fe80::a6bc:919:281e:dcab/64\n",[106,263,265,268,271,274],{"class":108,"line":264},5,[106,266,267],{"class":112},"docker0",[106,269,270],{"class":120},"          DOWN",[106,272,273],{"class":120},"           172.17.0.1/16",[106,275,276],{"class":120}," fe80::42:d1ff:febe:d513/64\n",[17,278,279,280,284],{},"在这里我们能看到本机的无线网卡地址是 192.168.20.212，所以 http 代理服务器的地址就是 ",[52,281,282],{"href":282,"rel":283},"http://192.168.20.212:8080",[56]," 。（如果你的有线网卡和手机在同一局域网下，当然也可以用有线网卡的 ip 地址）",[17,286,287],{},"我们当然可以在安卓手机的 WIFI 连接页面填入 http 代理地址。",[17,289,290],{},[291,292],"img",{"alt":102,"src":293},"https://static.031130.xyz/uploads/2024/08/12/66ab548080ed6.webp",[17,295,296],{},"但这对我来说似乎并不是一个好主意：一来并不是所有的应用都会默认使用 http 代理服务器，二来这回导致抓包目标不明确，非目标应用的流量也会经过代理服务器。",[17,298,299],{},"我选择了 Nekobox 这个常见的代理软件，它支持 http 代理服务器，且允许分应用代理。",[17,301,302],{},[291,303],{"alt":102,"src":304},"https://static.031130.xyz/uploads/2024/08/12/66ab54f08dfd6.webp",[17,306,307],{},"可以看到能正常抓取 https 流量",[17,309,310],{},[291,311],{"alt":102,"src":312},"https://static.031130.xyz/uploads/2024/08/12/66ab5970a6ac7.webp",[81,314,315],{"id":315},"参见",[24,317,318,325,332,339,345],{},[27,319,320],{},[52,321,324],{"href":322,"rel":323},"https://ibukifalling.github.io/2023/06/07/Android-app-packet-capture/",[56],"安卓应用防抓包机制及一些绕过",[27,326,327],{},[52,328,331],{"href":329,"rel":330},"https://chorer.github.io/2022/05/19/A-%E5%AE%89%E5%8D%937.0%E7%B3%BB%E7%BB%9F%E6%8A%93%E5%8C%85%E6%96%B9%E6%A1%88/",[56],"安卓7.0+系统抓包方案",[27,333,334],{},[52,335,338],{"href":336,"rel":337},"https://www.cnblogs.com/snad/p/17449454.html",[56],"frida抓包",[27,340,341],{},[52,342,344],{"href":73,"rel":343},[56],"gojue/ecapture",[27,346,347],{},[52,348,351],{"href":349,"rel":350},"http://91fans.com.cn/post/certificate/#gsc.tab=0",[56],"安卓高版本安装系统证书 HTTPS 抓包 - 终极解决方案",[353,354,355],"style",{},"html pre.shiki code .sAdtL, html code.shiki .sAdtL{--shiki-default:#4078F2;--shiki-dark:#61AFEF}html pre.shiki code .sJa8x, html code.shiki .sJa8x{--shiki-default:#E45649;--shiki-dark:#E06C75}html pre.shiki code .sDhpE, html code.shiki .sDhpE{--shiki-default:#50A14F;--shiki-dark:#98C379}html pre.shiki code .s5ixo, html code.shiki .s5ixo{--shiki-default:#383A42;--shiki-dark:#ABB2BF}html pre.shiki code .sAGMh, html code.shiki .sAGMh{--shiki-default:#986801;--shiki-dark:#D19A66}html .default .shiki span {color: var(--shiki-default);background: var(--shiki-default-bg);font-style: var(--shiki-default-font-style);font-weight: var(--shiki-default-font-weight);text-decoration: var(--shiki-default-text-decoration);}html .shiki span {color: var(--shiki-default);background: var(--shiki-default-bg);font-style: var(--shiki-default-font-style);font-weight: var(--shiki-default-font-weight);text-decoration: var(--shiki-default-text-decoration);}html .dark .shiki span {color: var(--shiki-dark);background: var(--shiki-dark-bg);font-style: var(--shiki-dark-font-style);font-weight: var(--shiki-dark-font-weight);text-decoration: var(--shiki-dark-text-decoration);}html.dark .shiki span {color: var(--shiki-dark);background: var(--shiki-dark-bg);font-style: var(--shiki-dark-font-style);font-weight: var(--shiki-dark-font-weight);text-decoration: var(--shiki-dark-text-decoration);}",{"title":102,"searchDepth":220,"depth":220,"links":357},[358,359,360,361],{"id":83,"depth":220,"text":83},{"id":94,"depth":220,"text":95},{"id":203,"depth":220,"text":204},{"id":315,"depth":220,"text":315},[363,369],{"title":364,"path":365,"stem":366,"date":367,"lang":368,"children":-1},"自建图床小记一——图床架构与 DNS 解析","/2024/08/12/new-picbed-based-on-cloudflare-and-upyun","posts/zh/new-picbed-based-on-cloudflare-and-upyun","2024-08-12 17:07:11","zh-CN",{"title":370,"path":371,"stem":372,"date":373,"lang":368,"children":-1},"为中柏 N100 小主机开启来电自启","/2024/07/22/enable-ac-power-loss-for-jumper-n100","posts/zh/enable-ac-power-loss-for-jumper-n100","2024-07-22 23:31:51",7,null,1771555480444]