[{"data":1,"prerenderedAt":584},["ShallowReactive",2],{"post-2024-11-15-upgrade-waline-from-v2-to-v3-zh":3,"surround-2024-11-15-upgrade-waline-from-v2-to-v3-zh":572,"randomIndex/2024/11/15/upgrade-waline-from-v2-to-v3/":447,"language-switch-/2024/11/15/upgrade-waline-from-v2-to-v3/-en":583},{"id":4,"title":5,"body":6,"date":558,"description":30,"extension":559,"lang":560,"meta":561,"navigation":231,"path":562,"rawbody":563,"seo":564,"stem":565,"sticky":566,"tags":567,"__hash__":571},"posts/posts/zh/upgrade-waline-from-v2-to-v3.md","将博客从 waline v2 更新到 waline v3",{"type":7,"value":8,"toc":554},"minimark",[9,16,24,49,54,57,63,69,80,96,104,107,113,117,120,125,134,139,142,145,150,153,156,161,164,167,183,186,193,200,207,210,533,540,545,550],[10,11,12],"blockquote",{},[13,14,15],"p",{},"waline 更新到 V3 版本已经是九个月前的事情了，眼瞅着 hexo fluid 主题并没有带我更新的意思，我就打算自己更新到最新版，结果遇到了两个坑，写文供大家参考。",[13,17,18,19,23],{},"在 Hexo 目录下的 ",[20,21,22],"code",{},"_config.fluid.yml"," 文件中找到 waline 的 cdn，将版本号指向最新版。",[25,26,31],"pre",{"className":27,"code":28,"language":29,"meta":30,"style":30},"language-diff shiki shiki-themes one-light one-dark-pro","-  waline: https://registry.npmmirror.com/@waline/client/2.15.8/files/dist/\n+  waline: https://registry.npmmirror.com/@waline/client/^3/files/dist/\n","diff","",[20,32,33,42],{"__ignoreMap":30},[34,35,38],"span",{"class":36,"line":37},"line",1,[34,39,41],{"class":40},"sJa8x","-  waline: https://registry.npmmirror.com/@waline/client/2.15.8/files/dist/\n",[34,43,45],{"class":36,"line":44},2,[34,46,48],{"class":47},"sDhpE","+  waline: https://registry.npmmirror.com/@waline/client/^3/files/dist/\n",[50,51,53],"h2",{"id":52},"插曲一waline-不加载","插曲一——waline 不加载",[13,55,56],{},"再次部署博客，我遇到了第一个坑：waline 没有在页面上正常加载。",[13,58,59,60],{},"打开控制台一看，报错给得很明白：",[20,61,62],{},"Waline is not defined",[13,64,65],{},[66,67],"img",{"alt":30,"src":68},"https://static.031130.xyz/uploads/2024/11/16/663e910db29b7.webp",[13,70,71,72,79],{},"根据 ",[73,74,78],"a",{"href":75,"rel":76},"https://github.com/walinejs/waline/issues/2483",[77],"nofollow","issue#2483","，",[10,81,82,89],{},[13,83,84,88],{},[73,85,86],{"href":86,"rel":87},"https://unpkg.com/@waline/client@3.1.3/dist/waline.umd.js",[77]," 用这个地址",[13,90,91,92,95],{},"本质是 ...... 没有使用 ES Module 的加载方式 ",[20,93,94],{},"\u003Cscript type=\"module\">","，所以需要使用 UMD 的模块",[13,97,98,99],{},"那么按照正常的脑回路，我们应该修改主题中的引入 waline 部分的 js 文件，把针对 waline.js 的引用改成 waline.umd.js，具体的修改处",[73,100,103],{"href":101,"rel":102},"https://github.com/fluid-dev/hexo-theme-fluid/blob/94049b2e6da5ae865f5cf7088f0c53917a6dc8bc/layout/_partials/comments/waline.ejs#L5-L6",[77],"在这里",[13,105,106],{},"但是，我是使用 npm 安装的主题，方便在主题更新时直接同步上游的更改，如果使用这种修改源文件引用的方式将会导致我不得不放弃原有的主题安装方式，改用下载主题源码的方式。",[13,108,109,110,112],{},"那么有没有办法，既能够成功加载带 umd 的 js，又不用改动主题源码呢？还真有，我自己部署 cdn 就好了。从 npmjs 下载带 umd 的 waline.umd.js，重命名成 waline.js，和 waline.css 一起放在同一路径下，在把自己的 cdn 链接前缀填入 ",[20,111,22],{}," 中，就可以实现移花接木——表面上访问的是 waline.js，实际上内容是 waline.umd.js 。",[50,114,116],{"id":115},"插曲二重复显示的","插曲二——重复显示的 @",[13,118,119],{},"更新到 v3 版本以后，我发现所有的评论都出现了重复两遍的 @",[13,121,122],{},[66,123],{"alt":30,"src":124},"https://static.031130.xyz/uploads/2024/11/16/f6fbaa99a784e.webp",[13,126,127,128,133],{},"我去群里提问，管理员 ",[73,129,132],{"href":130,"rel":131},"https://imnerd.org/",[77],"li zheming"," 给出了这样的答复:",[10,135,136],{},[13,137,138],{},"这个是 feature 了，早版本 @ 是渲染在评论内容里的，这块后来重构了下，@ 是 Waline 自己渲染了。不过历史数据我们并没有处理，所以会出现这种情况。如果比较介意的话可以手动去数据库里删除下。",[13,140,141],{},"那么很显然，我很介意这点，我需要删除数据库中的 @ 信息。",[13,143,144],{},"打开 waline 的后台管理站点，我发现我有整整 30 页的评论——很显然我是 waline 的牢用户了，我不太可能一个一个手动去掉评论中的 @",[13,146,147],{},[66,148],{"alt":30,"src":149},"https://static.031130.xyz/uploads/2024/11/16/c4487502542e5.webp",[13,151,152],{},"我的 waline 数据库是 leancloud，对方的 webui 没办法帮助我批量去除 html 或者 markdown 形式的内容（就算对方支持 sql 语句，处理这个问题都够呛），我需要一个脚本来直接处理数据库中的信息。",[13,154,155],{},"首先，我们需要导出数据库数据，自然是登陆 leancloud，然后找到 数据存储 - 导入导出 - 数据导出，选择 Comment 单个 Class，单击导出按钮。",[13,157,158],{},[66,159],{"alt":30,"src":160},"https://static.031130.xyz/uploads/2024/11/16/d2cd564739120.webp",[13,162,163],{},"err，我寻思凌晨 1 点应该是 16 点前吧，怎么导出不了，而我昨晚 23 点反而可以导出，leancloud 到底是哪门子时区。所以我直接拿了 23 点时导出的数据进行处理。",[13,165,166],{},"leancloud 导出的数据是 jsonl 格式的，我们对需要去除的 @ 信息进行归纳总结，发现一共有两种 @ 的渲染方式",[168,169,170,177],"ul",{},[171,172,173,176],"li",{},[20,174,175],{},"\u003Ca class=\"at\" href=\"#id\">@username\u003C/a>","  的 html 风格（有时 class 和 href 顺序还会反过来）",[171,178,179,182],{},[20,180,181],{},"[@username](#id)"," 的 markdown 风格",[13,184,185],{},"而 html 风格还有两种结尾方式，",[13,187,188,189,192],{},"一种是如 ",[20,190,191],{},"\u003Ca class=\"at\" href=\"#id\">@username\u003C/a> , "," 这样以 空格 + 半角逗号 + 空格 结尾的形式，",[13,194,195,196,199],{},"令一种是如 ",[20,197,198],{},"\u003Ca class=\"at\" href=\"#id\">@username\u003C/a>: "," 这样以 半角冒号 + 空格结尾的形式。",[13,201,202,203,206],{},"markdown 风格的结尾方式我就只看到一种，如 ",[20,204,205],{},"[@username](#id): ","这样以 半角冒号 + 空格结尾的形式。",[13,208,209],{},"因此，我们需要对三种形式分别编写正则表达式进行匹配并删除，参考代码如下",[25,211,215],{"className":212,"code":213,"language":214,"meta":30,"style":30},"language-python shiki shiki-themes one-light one-dark-pro","import re\n\nwith open('Comment.0.jsonl', 'r') as f:\n    s = f.read()\n\npatterns = [\n    r'\u003Ca class=\\\\\"at\\\\\" href=\\\\\"#(?:.*?)\\\\\">@(?:.*?)\u003C/a>: ',\n    r'\u003Ca class=\\\\\"at\\\\\" href=\\\\\"#(?:.*?)\\\\\">@(?:.*?)\u003C/a> , ',\n    r'\\[@(?:.*?)\\]\\(#(?:.*?)\\):'\n]\n\nfor pattern in patterns:\n    s = re.sub(pattern, \"\", s)\n\nwith open('Comment.1.jsonl', 'w') as f:\n    f.write(s)\n","python",[20,216,217,227,233,264,284,289,300,359,403,445,451,456,471,493,498,521],{"__ignoreMap":30},[34,218,219,223],{"class":36,"line":37},[34,220,222],{"class":221},"sLKXg","import",[34,224,226],{"class":225},"s5ixo"," re\n",[34,228,229],{"class":36,"line":44},[34,230,232],{"emptyLinePlaceholder":231},true,"\n",[34,234,236,239,243,246,249,252,255,258,261],{"class":36,"line":235},3,[34,237,238],{"class":221},"with",[34,240,242],{"class":241},"s_Sar"," open",[34,244,245],{"class":225},"(",[34,247,248],{"class":47},"'Comment.0.jsonl'",[34,250,251],{"class":225},", ",[34,253,254],{"class":47},"'r'",[34,256,257],{"class":225},") ",[34,259,260],{"class":221},"as",[34,262,263],{"class":225}," f:\n",[34,265,267,270,274,277,281],{"class":36,"line":266},4,[34,268,269],{"class":225},"    s ",[34,271,273],{"class":272},"sknuh","=",[34,275,276],{"class":225}," f.",[34,278,280],{"class":279},"slOjB","read",[34,282,283],{"class":225},"()\n",[34,285,287],{"class":36,"line":286},5,[34,288,232],{"emptyLinePlaceholder":231},[34,290,292,295,297],{"class":36,"line":291},6,[34,293,294],{"class":225},"patterns ",[34,296,273],{"class":272},[34,298,299],{"class":225}," [\n",[34,301,303,306,310,313,316,318,321,323,326,330,333,337,340,342,345,347,349,351,353,356],{"class":36,"line":302},7,[34,304,305],{"class":221},"    r",[34,307,309],{"class":308},"sDaw7","'\u003Ca class=",[34,311,312],{"class":241},"\\\\",[34,314,315],{"class":308},"\"at",[34,317,312],{"class":241},[34,319,320],{"class":308},"\" href=",[34,322,312],{"class":241},[34,324,325],{"class":308},"\"#",[34,327,329],{"class":328},"sYoRg","(?:",[34,331,332],{"class":308},".",[34,334,336],{"class":335},"sYebD","*?",[34,338,339],{"class":328},")",[34,341,312],{"class":241},[34,343,344],{"class":308},"\">@",[34,346,329],{"class":328},[34,348,332],{"class":308},[34,350,336],{"class":335},[34,352,339],{"class":328},[34,354,355],{"class":308},"\u003C/a>: '",[34,357,358],{"class":225},",\n",[34,360,362,364,366,368,370,372,374,376,378,380,382,384,386,388,390,392,394,396,398,401],{"class":36,"line":361},8,[34,363,305],{"class":221},[34,365,309],{"class":308},[34,367,312],{"class":241},[34,369,315],{"class":308},[34,371,312],{"class":241},[34,373,320],{"class":308},[34,375,312],{"class":241},[34,377,325],{"class":308},[34,379,329],{"class":328},[34,381,332],{"class":308},[34,383,336],{"class":335},[34,385,339],{"class":328},[34,387,312],{"class":241},[34,389,344],{"class":308},[34,391,329],{"class":328},[34,393,332],{"class":308},[34,395,336],{"class":335},[34,397,339],{"class":328},[34,399,400],{"class":308},"\u003C/a> , '",[34,402,358],{"class":225},[34,404,406,408,411,414,417,419,421,423,425,428,431,433,435,437,439,442],{"class":36,"line":405},9,[34,407,305],{"class":221},[34,409,410],{"class":308},"'",[34,412,413],{"class":241},"\\[",[34,415,416],{"class":308},"@",[34,418,329],{"class":328},[34,420,332],{"class":308},[34,422,336],{"class":335},[34,424,339],{"class":328},[34,426,427],{"class":241},"\\]\\(",[34,429,430],{"class":308},"#",[34,432,329],{"class":328},[34,434,332],{"class":308},[34,436,336],{"class":335},[34,438,339],{"class":328},[34,440,441],{"class":241},"\\)",[34,443,444],{"class":308},":'\n",[34,446,448],{"class":36,"line":447},10,[34,449,450],{"class":225},"]\n",[34,452,454],{"class":36,"line":453},11,[34,455,232],{"emptyLinePlaceholder":231},[34,457,459,462,465,468],{"class":36,"line":458},12,[34,460,461],{"class":221},"for",[34,463,464],{"class":225}," pattern ",[34,466,467],{"class":221},"in",[34,469,470],{"class":225}," patterns:\n",[34,472,474,476,478,481,484,487,490],{"class":36,"line":473},13,[34,475,269],{"class":225},[34,477,273],{"class":272},[34,479,480],{"class":225}," re.",[34,482,483],{"class":279},"sub",[34,485,486],{"class":225},"(pattern, ",[34,488,489],{"class":47},"\"\"",[34,491,492],{"class":225},", s)\n",[34,494,496],{"class":36,"line":495},14,[34,497,232],{"emptyLinePlaceholder":231},[34,499,501,503,505,507,510,512,515,517,519],{"class":36,"line":500},15,[34,502,238],{"class":221},[34,504,242],{"class":241},[34,506,245],{"class":225},[34,508,509],{"class":47},"'Comment.1.jsonl'",[34,511,251],{"class":225},[34,513,514],{"class":47},"'w'",[34,516,257],{"class":225},[34,518,260],{"class":221},[34,520,263],{"class":225},[34,522,524,527,530],{"class":36,"line":523},16,[34,525,526],{"class":225},"    f.",[34,528,529],{"class":279},"write",[34,531,532],{"class":225},"(s)\n",[13,534,535,536,539],{},"随后删除 Comment 表中所有数据，把生成的 ",[20,537,538],{},"Comment.1.jsonl"," 导入 leancloud，就算是大功告成了。",[13,541,542],{},[66,543],{"alt":30,"src":544},"https://static.031130.xyz/uploads/2024/11/16/d248ae2eac74c.webp",[13,546,547],{},[66,548],{"alt":30,"src":549},"https://static.031130.xyz/uploads/2024/11/16/c3875dcde1d97.webp",[551,552,553],"style",{},"html pre.shiki code .sJa8x, html code.shiki .sJa8x{--shiki-default:#E45649;--shiki-dark:#E06C75}html pre.shiki code .sDhpE, html code.shiki .sDhpE{--shiki-default:#50A14F;--shiki-dark:#98C379}html .default .shiki span {color: var(--shiki-default);background: var(--shiki-default-bg);font-style: var(--shiki-default-font-style);font-weight: var(--shiki-default-font-weight);text-decoration: var(--shiki-default-text-decoration);}html .shiki span {color: var(--shiki-default);background: var(--shiki-default-bg);font-style: var(--shiki-default-font-style);font-weight: var(--shiki-default-font-weight);text-decoration: var(--shiki-default-text-decoration);}html .dark .shiki span {color: var(--shiki-dark);background: var(--shiki-dark-bg);font-style: var(--shiki-dark-font-style);font-weight: var(--shiki-dark-font-weight);text-decoration: var(--shiki-dark-text-decoration);}html.dark .shiki span {color: var(--shiki-dark);background: var(--shiki-dark-bg);font-style: var(--shiki-dark-font-style);font-weight: var(--shiki-dark-font-weight);text-decoration: var(--shiki-dark-text-decoration);}html pre.shiki code .sLKXg, html code.shiki .sLKXg{--shiki-default:#A626A4;--shiki-dark:#C678DD}html pre.shiki code .s5ixo, html code.shiki .s5ixo{--shiki-default:#383A42;--shiki-dark:#ABB2BF}html pre.shiki code .s_Sar, html code.shiki .s_Sar{--shiki-default:#0184BC;--shiki-dark:#56B6C2}html pre.shiki code .sknuh, html code.shiki .sknuh{--shiki-default:#383A42;--shiki-dark:#56B6C2}html pre.shiki code .slOjB, html code.shiki .slOjB{--shiki-default:#383A42;--shiki-dark:#61AFEF}html pre.shiki code .sDaw7, html code.shiki .sDaw7{--shiki-default:#0184BC;--shiki-dark:#E06C75}html pre.shiki code .sYoRg, html code.shiki .sYoRg{--shiki-default:#0184BC;--shiki-dark:#D19A66}html pre.shiki code .sYebD, html code.shiki .sYebD{--shiki-default:#383A42;--shiki-dark:#D19A66}",{"title":30,"searchDepth":44,"depth":44,"links":555},[556,557],{"id":52,"depth":44,"text":53},{"id":115,"depth":44,"text":116},"2024-11-15 23:49:43","md","zh-CN",{},"/2024/11/15/upgrade-waline-from-v2-to-v3","---\ntitle: 将博客从 waline v2 更新到 waline v3\ndate: 2024-11-15 23:49:43\nsticky:\ntags:\n- Python\n- waline\n- Hexo\n---\n\n> waline 更新到 V3 版本已经是九个月前的事情了，眼瞅着 hexo fluid 主题并没有带我更新的意思，我就打算自己更新到最新版，结果遇到了两个坑，写文供大家参考。\n\n在 Hexo 目录下的 `_config.fluid.yml` 文件中找到 waline 的 cdn，将版本号指向最新版。\n\n```diff\n-  waline: https://registry.npmmirror.com/@waline/client/2.15.8/files/dist/\n+  waline: https://registry.npmmirror.com/@waline/client/^3/files/dist/\n```\n\n## 插曲一——waline 不加载\n\n再次部署博客，我遇到了第一个坑：waline 没有在页面上正常加载。\n\n打开控制台一看，报错给得很明白：`Waline is not defined`\n\n![](https://static.031130.xyz/uploads/2024/11/16/663e910db29b7.webp)\n\n根据 [issue#2483](https://github.com/walinejs/waline/issues/2483)，\n\n> https://unpkg.com/@waline/client@3.1.3/dist/waline.umd.js 用这个地址\n>\n> 本质是 ...... 没有使用 ES Module 的加载方式 `\u003Cscript type=\"module\">`，所以需要使用 UMD 的模块\n\n那么按照正常的脑回路，我们应该修改主题中的引入 waline 部分的 js 文件，把针对 waline.js 的引用改成 waline.umd.js，具体的修改处[在这里](https://github.com/fluid-dev/hexo-theme-fluid/blob/94049b2e6da5ae865f5cf7088f0c53917a6dc8bc/layout/_partials/comments/waline.ejs#L5-L6)\n\n但是，我是使用 npm 安装的主题，方便在主题更新时直接同步上游的更改，如果使用这种修改源文件引用的方式将会导致我不得不放弃原有的主题安装方式，改用下载主题源码的方式。\n\n那么有没有办法，既能够成功加载带 umd 的 js，又不用改动主题源码呢？还真有，我自己部署 cdn 就好了。从 npmjs 下载带 umd 的 waline.umd.js，重命名成 waline.js，和 waline.css 一起放在同一路径下，在把自己的 cdn 链接前缀填入 `_config.fluid.yml` 中，就可以实现移花接木——表面上访问的是 waline.js，实际上内容是 waline.umd.js 。\n\n## 插曲二——重复显示的 @\n\n更新到 v3 版本以后，我发现所有的评论都出现了重复两遍的 @\n\n![](https://static.031130.xyz/uploads/2024/11/16/f6fbaa99a784e.webp)\n\n我去群里提问，管理员 [li zheming](https://imnerd.org/) 给出了这样的答复:\n\n> 这个是 feature 了，早版本 @ 是渲染在评论内容里的，这块后来重构了下，@ 是 Waline 自己渲染了。不过历史数据我们并没有处理，所以会出现这种情况。如果比较介意的话可以手动去数据库里删除下。\n\n那么很显然，我很介意这点，我需要删除数据库中的 @ 信息。\n\n打开 waline 的后台管理站点，我发现我有整整 30 页的评论——很显然我是 waline 的牢用户了，我不太可能一个一个手动去掉评论中的 @\n\n![](https://static.031130.xyz/uploads/2024/11/16/c4487502542e5.webp)\n\n我的 waline 数据库是 leancloud，对方的 webui 没办法帮助我批量去除 html 或者 markdown 形式的内容（就算对方支持 sql 语句，处理这个问题都够呛），我需要一个脚本来直接处理数据库中的信息。\n\n首先，我们需要导出数据库数据，自然是登陆 leancloud，然后找到 数据存储 - 导入导出 - 数据导出，选择 Comment 单个 Class，单击导出按钮。\n\n![](https://static.031130.xyz/uploads/2024/11/16/d2cd564739120.webp)\n\nerr，我寻思凌晨 1 点应该是 16 点前吧，怎么导出不了，而我昨晚 23 点反而可以导出，leancloud 到底是哪门子时区。所以我直接拿了 23 点时导出的数据进行处理。\n\nleancloud 导出的数据是 jsonl 格式的，我们对需要去除的 @ 信息进行归纳总结，发现一共有两种 @ 的渲染方式\n\n- `\u003Ca class=\"at\" href=\"#id\">@username\u003C/a>`  的 html 风格（有时 class 和 href 顺序还会反过来）\n- `[@username](#id)` 的 markdown 风格\n\n而 html 风格还有两种结尾方式，\n\n一种是如 `\u003Ca class=\"at\" href=\"#id\">@username\u003C/a> , ` 这样以 空格 + 半角逗号 + 空格 结尾的形式，\n\n令一种是如 `\u003Ca class=\"at\" href=\"#id\">@username\u003C/a>: ` 这样以 半角冒号 + 空格结尾的形式。\n\nmarkdown 风格的结尾方式我就只看到一种，如 `[@username](#id): `这样以 半角冒号 + 空格结尾的形式。\n\n因此，我们需要对三种形式分别编写正则表达式进行匹配并删除，参考代码如下\n\n```python\nimport re\n\nwith open('Comment.0.jsonl', 'r') as f:\n    s = f.read()\n\npatterns = [\n    r'\u003Ca class=\\\\\"at\\\\\" href=\\\\\"#(?:.*?)\\\\\">@(?:.*?)\u003C/a>: ',\n    r'\u003Ca class=\\\\\"at\\\\\" href=\\\\\"#(?:.*?)\\\\\">@(?:.*?)\u003C/a> , ',\n    r'\\[@(?:.*?)\\]\\(#(?:.*?)\\):'\n]\n\nfor pattern in patterns:\n    s = re.sub(pattern, \"\", s)\n\nwith open('Comment.1.jsonl', 'w') as f:\n    f.write(s)\n```\n\n随后删除 Comment 表中所有数据，把生成的 `Comment.1.jsonl` 导入 leancloud，就算是大功告成了。\n\n![](https://static.031130.xyz/uploads/2024/11/16/d248ae2eac74c.webp)\n\n![](https://static.031130.xyz/uploads/2024/11/16/c3875dcde1d97.webp)\n",{"title":5,"description":30},"posts/zh/upgrade-waline-from-v2-to-v3",false,[568,569,570],"Python","waline","Hexo","YhQ7AQ-GVVFoKLtd17TI6bOANzoi1bYcY46oJ42VnSQ",[573,578],{"title":574,"path":575,"stem":576,"date":577,"lang":560,"children":-1},"小爱课程表适配不完全指北——以 ZJUT 本科正方教务系统为例","/2024/11/18/mi-ai-class-schedule-adapter-for-zjut","posts/zh/mi-ai-class-schedule-adapter-for-zjut","2024-11-18 21:13:56",{"title":579,"path":580,"stem":581,"date":582,"lang":560,"children":-1},"给家里云装上 Fedora 41 KDE 后，我是如何配置的","/2024/11/01/my-config-for-fedora-kde-41","posts/zh/my-config-for-fedora-kde-41","2024-11-01 23:35:08",null,1763998127397]