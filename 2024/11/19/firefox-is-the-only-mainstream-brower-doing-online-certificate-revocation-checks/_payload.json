[{"data":1,"prerenderedAt":564},["ShallowReactive",2],{"post-2024-11-19-firefox-is-the-only-mainstream-brower-doing-online-certificate-revocation-checks-zh":3,"surround-2024-11-19-firefox-is-the-only-mainstream-brower-doing-online-certificate-revocation-checks-zh":550,"randomIndex/2024/11/19/firefox-is-the-only-mainstream-brower-doing-online-certificate-revocation-checks/":562,"language-switch-/2024/11/19/firefox-is-the-only-mainstream-brower-doing-online-certificate-revocation-checks/-en":563},{"title":4,"date":5,"path":6,"tags":7,"body":11,"description":57},"2024年，Firefox 是唯一还在坚持执行在线的 SSL 证书吊销状态检查的主流浏览器","2024-11-19 17:58:14","/2024/11/19/firefox-is-the-only-mainstream-brower-doing-online-certificate-revocation-checks",[8,9,10],"Firefox","SSL","OpenSSL",{"type":12,"value":13,"toc":538},"minimark",[14,19,23,41,49,52,59,62,69,83,92,97,100,105,109,118,122,125,130,133,136,185,190,196,200,203,215,218,224,228,235,280,290,293,309,313,316,319,322,340,343,348,352,369,372,389,392,395,398,404,407,410,419,422,534],[15,16,18],"h2",{"id":17},"小试一下","小试一下？",[20,21,22],"p",{},"在开始阅读后面的内容之前，或许你可以试试看你正在使用的浏览器能不能访问下面两个链接:",[24,25,26,35],"ul",{},[27,28,29],"li",{},[30,31,32],"a",{"href":32,"rel":33},"https://digicert-tls-ecc-p384-root-g5-revoked.chain-demos.digicert.com/",[34],"nofollow",[27,36,37],{},[30,38,39],{"href":39,"rel":40},"https://revoked-isrgrootx1.letsencrypt.org/",[34],[20,42,43,44,48],{},"这两个链接分别是由 digicert 和 Let's Encrypt 维护的，特意维持了一个",[45,46,47],"strong",{},"证书没过期，但被 CA 吊销","的状态。",[20,50,51],{},"在我的 Firefox for Linux 上，两个链接我都无法打开。",[20,53,54],{},[55,56],"img",{"alt":57,"src":58},"","https://static.031130.xyz/uploads/2024/11/19/f7785db60b2c8.webp",[20,60,61],{},"这是预期行为。Firefox 在与目标站点建立 https 链接之前，先向 CA 提供的 OCSP 服务器打了一个 http 请求来判断目标站点的 ssl 证书是否有效（是否没有被 CA 主动吊销）。",[20,63,64,65],{},"在 Firefox for Android 上，我无法打开第一个链接，但可以打开第二个，这是因为 Mozilla 给 Android 用户设置的策略为「只对 EV 证书进行 ocsp 校验，跳过 DV 证书和 OV 证书」，",[66,67,68],"em",{},"似乎在竞争更加激烈的移动端，Firefox 为了加载速度做出了安全性上的妥协。",[70,71,72,76,80],"div",{},[55,73],{"src":74,"style":75},"https://static.031130.xyz/uploads/2024/11/19/b097e954f766f.webp","zoom:33%;",[77,78],"span",{"style":79},"width: 20%;",[55,81],{"src":82,"style":75},"https://static.031130.xyz/uploads/2024/11/19/a5f58dbb50cfe.webp",[20,84,85,86,91],{},"而在 Google Chrome / Microsoft Edge 上，OCSP 是不被支持的，chromium 团队在 2014 年就禁用了 OCSP 校验，且目前没有设置项允许用户手动开启，目前它只支持",[30,87,90],{"href":88,"rel":89},"https://www.chromium.org/Home/chromium-security/crlsets/",[34],"本地的 CRLSets 规则集","。",[20,93,94],{},[55,95],{"alt":57,"src":96},"https://static.031130.xyz/uploads/2024/11/19/bd84e9aff71d0.webp",[20,98,99],{},"Safari 经我本人测试默认只对 EV 证书进行有效性检验。",[20,101,102],{},[55,103],{"alt":57,"src":104},"https://static.031130.xyz/uploads/2024/11/19/50352339f7473.webp",[15,106,108],{"id":107},"ssl-证书被吊销是怎么回事","SSL 证书被吊销是怎么回事？",[20,110,111,112,117],{},"在某些情况下（比如用户告知 CA 颁发给自己的证书私钥不慎被泄漏了，或者 ",[30,113,116],{"href":114,"rel":115},"https://www.trustasia.com/view-security-lets-encrypt/",[34],"CA 的颁发程序出现漏洞被人滥用，需要吊销在此期间发出去的所有证书","），CA 需要吊销一些证书，并通过自己的渠道将被吊销的证书尽快告知所有用户——需要被吊销的证书和正常的证书在外观上没有任何区别，用户的浏览器必须依赖 CA 的外部消息通知才能知道哪些证书是被吊销的。",[15,119,121],{"id":120},"firefox-是如何接收来自-ca-的吊销信息的","Firefox 是如何接收来自 CA 的吊销信息的？",[20,123,124],{},"Firefox 通过提供了两种方案，以便用户从 CA 处得知目标站点的证书是否被吊销。",[126,127,129],"h3",{"id":128},"ocsp","OCSP",[20,131,132],{},"正如我前文所说的，Firefox 的 PC 端在与目标站点建立 https 连接之前，会先通过 http 协议向 CA 的 OCSP 服务器打一个 POST 请求来确认证书是否被吊销。",[20,134,135],{},"我们可以通过 openssl 拿到目标站点的 ssl 公钥，查看 CA 指定的 OCSP Server",[137,138,142],"pre",{"className":139,"code":140,"language":141,"meta":57,"style":57},"language-bash shiki shiki-themes one-light one-dark-pro","openssl s_client -connect example.com:443 -servername example.com | openssl x509 -text -noout\n\n","bash",[143,144,145],"code",{"__ignoreMap":57},[77,146,149,153,157,161,164,167,170,174,176,179,182],{"class":147,"line":148},"line",1,[77,150,152],{"class":151},"sAdtL","openssl",[77,154,156],{"class":155},"sDhpE"," s_client",[77,158,160],{"class":159},"sAGMh"," -connect",[77,162,163],{"class":155}," example.com:443",[77,165,166],{"class":159}," -servername",[77,168,169],{"class":155}," example.com",[77,171,173],{"class":172},"s5ixo"," | ",[77,175,152],{"class":151},[77,177,178],{"class":155}," x509",[77,180,181],{"class":159}," -text",[77,183,184],{"class":159}," -noout\n",[20,186,187],{},[55,188],{"alt":57,"src":189},"https://static.031130.xyz/uploads/2024/11/19/32579fb56b77b.webp",[20,191,192],{},[55,193],{"alt":194,"src":195},"访问第二个链接时的抓包结果","https://static.031130.xyz/uploads/2024/11/19/244704705924f.webp",[197,198,199],"h4",{"id":199},"软失败",[20,201,202],{},"这个请求一共有三种结果:",[204,205,206,209,212],"ol",{},[27,207,208],{},"请求结果正常，证书没有被吊销：Firefox 继续和目标站点建立 https 连接",[27,210,211],{},"请求结果正常，证书被吊销：Firefox 拒绝和目标站点建立 https 连接，如同我在博客开头贴的图",[27,213,214],{},"请求结果异常（请求超时）：Firefox 继续和目标站点建立 https 连接",[20,216,217],{},"透过在第三种情况，我们可以发现，Firefox 对 OCSP 检查的结果是软失败 (soft fail) 态度——即如果在 OCSP 过程中发生异常，Firefox 将不得不放弃 OCSP 检查并放行。根据 Mozilla Blog 的说法，如今有 9.9% 的 OCSP 检查都是超时的。",[20,219,220],{},[55,221],{"alt":222,"src":223},"https://blog.mozilla.org/security/files/2020/01/figure4-ocsp_results.png","https://static.031130.xyz/uploads/2024/11/19/4a6c899a41128.webp",[197,225,227],{"id":226},"firefox-中的相关配置项","Firefox 中的相关配置项",[20,229,230,231,234],{},"在 Firefox 的 ",[143,232,233],{},"about:config"," 配置中搜索，我们可以看到一些关于 OCSP 的配置项",[24,236,237,254,268,274],{},[27,238,239,242,243],{},[143,240,241],{},"security.OCSP.enabled",": 是否开启 OCSP 检查，默认为 1",[24,244,245,248,251],{},[27,246,247],{},"0: 关闭 OCSP 检查",[27,249,250],{},"1: 开启 OCSP 检查",[27,252,253],{},"2: 只对 EV 证书进行 OCSP 检查",[27,255,256,259,260],{},[143,257,258],{},"security.OCSP.required",": 是否一定要通过 OCSP 才允许建立连接（即是否不允许“软失败”），默认为 false",[24,261,262,265],{},[27,263,264],{},"false: 允许软失败",[27,266,267],{},"true: 不允许软失败",[27,269,270,273],{},[143,271,272],{},"security.OCSP.timeoutMilliseconds.hard",": 针对 EV 证书，OCSP 检查的超时时间，默认为 10000 (10 秒)",[27,275,276,279],{},[143,277,278],{},"security.OCSP.timeoutMilliseconds.soft",": 针对 DV 和 OV 证书，OCSP 检查的超时时间，默认为 2000（2 秒），移动端为 1 秒。",[20,281,282],{},[66,283,284,285],{},"EV 证书相比 DV 和 OV 有更严苛的申请条件，区别可以参考",[30,286,289],{"href":287,"rel":288},"https://www.digicert.com/cn/difference-between-dv-ov-and-ev-ssl-certificates",[34],"DV、OV和EV SSL证书之间有什么区别？",[197,291,292],{"id":292},"弊端",[24,294,295,298,306],{},[27,296,297],{},"ocsp 不能在不增加用户负担的情况下使用硬失败(hard fail)，对于无响应或者超时的 ocsp 验证只能直接放行，这意味着攻击者可以直接屏蔽浏览器和 CA 之间的连接，拖到 ocsp 超时，并不能有效保障用户免受攻击。",[27,299,300,301,91],{},"在 ocsp server 响应或者连接超时前，与目标站点的 https 连接会被阻塞，这带来了更大的访问延迟。有时还会出现",[30,302,305],{"href":303,"rel":304},"https://blog.wolfogre.com/posts/letsencrypt-ocsp-breakdown/",[34],"用户与 ocsp server 无法连接的情况",[27,307,308],{},"ocsp 是由用户浏览器主动向 CA 发起 http 请求，可能会导致用户隐私泄漏（IP 地址、位置、用户的部分浏览历史记录等）。即使 CA 故意不保留这些信息，地区法律也可能强制 CA 收集这些信息。",[197,310,312],{"id":311},"ocsp-装订-ocsp-stapling","OCSP 装订 (OCSP stapling)",[20,314,315],{},"这是一种新的方式，由目标站点的服务器主动向 CA 的 ocsp 服务器缓存 ocsp 信息（有效期最长为 7 天），并将其在用户访问时将相关信息一起提供给用户，避免用户直接向 CA 的服务器发起查询请求，能够规避部分弊端（避免 CA 收集用户信息，规避用户与 CA OCSP 服务器连接性不好等问题）。",[20,317,318],{},"目前，caddy 是默认开启 OCSP 装订的，而 nginx 可以在配置后手动开启。",[20,320,321],{},"可以采用 openssl 来查询目标站点是否开启了 OCSP 装订：",[137,323,325],{"className":139,"code":324,"language":141,"meta":57,"style":57},"openssl s_client -connect example.com:443 -status\n",[143,326,327],{"__ignoreMap":57},[77,328,329,331,333,335,337],{"class":147,"line":148},[77,330,152],{"class":151},[77,332,156],{"class":155},[77,334,160],{"class":159},[77,336,163],{"class":155},[77,338,339],{"class":159}," -status\n",[20,341,342],{},"如果开启了 OCSP 装订，那么返回的数据中会有 OCSP Response Data 相关的描述",[20,344,345],{},[55,346],{"alt":57,"src":347},"https://static.031130.xyz/uploads/2024/11/19/71f252c97e96e.webp",[126,349,351],{"id":350},"crlite-wip","CRLite (WIP)",[20,353,354,359,360,365,366],{},[30,355,358],{"href":356,"rel":357},"https://obj.umiacs.umd.edu/papers_for_stories/crlite_oakland17.pdf",[34],"CRLite"," 是 ",[30,361,364],{"href":362,"rel":363},"https://www.ieee-security.org/TC/SP2017/",[34],"2017 年 IEEE 安全和隐私研讨会","上一组研究人员提出的一项技术，该技术可以有效地压缩吊销信息，使 300 兆字节的吊销数据可以变成 1 兆字节。CRLite 数据由 Mozilla 收集处理后推送给浏览器实现证书状态的本地查找，",[66,367,368],{},"这项技术仍然处于开发阶段。",[20,370,371],{},"当浏览器使用 CRLite 查询对应站点的 ssl 证书的有效状态时，一般会有 5 种查询结果",[204,373,374,377,380,383,386],{},[27,375,376],{},"Certificate Valid，表示 CRLite 权威返回证书有效。",[27,378,379],{},"Certificate Revoked，表示 CRLite 权威返回证书已被吊销。",[27,381,382],{},"Issuer Not Enrolled, 这意味着正在评估的证书未包含在 CRLite 筛选器集中，可能是因为颁发证书的证书颁发机构 （CA） 未发布 CRL。",[27,384,385],{},"Certificate Too New，表示正在评估的证书比 CRLite 筛选器新。",[27,387,388],{},"Filter Not Available，这意味着 CRLite 过滤器要么尚未从 Remote Settings 下载，要么已经过时以至于停止服务。",[20,390,391],{},"Mozilla 计划每天发布 4 次 CRLite 的更新，以减少第 4 种情况。",[197,393,394],{"id":394},"速度优势",[20,396,397],{},"CRLite 的本地数据查询相比起 OCSP 的在线查询拥有天然的优势，99% 的情况下，CRLite 会比 OCSP 快，其中 56% 的情况下，CRLite 会比 OCSP 快 100 毫秒以上。",[20,399,400],{},[55,401],{"alt":402,"src":403},"https://blog.mozilla.org/security/files/2020/01/figure3-speedup_vs_ocsp.png","https://static.031130.xyz/uploads/2024/11/19/bfba9ba3515ca.webp",[20,405,406],{},"此外，当 CRLite 不可用时，Firefox 仍然可以回退到传统的 OCSP 检测机制。",[15,408,409],{"id":409},"其他",[20,411,412,413,418],{},"Let's Encrypt 在 2024 年 7 月",[30,414,417],{"href":415,"rel":416},"https://letsencrypt.org/2024/07/23/replacing-ocsp-with-crls/",[34],"发布博客","，CA/Browser Forum在上一年 8 月通过了一向投票允许 Let's Encrypt 等公开信任的 CA 将设立 OCSP server 作为可选选项。他们计划在未来 6~12 月内宣布关闭 OCSP 服务的时间表。",[15,420,421],{"id":421},"参见",[24,423,424,431,438,445,452,459,466,473,484,491,498,504,511,517,523,529],{},[27,425,426],{},[30,427,430],{"href":428,"rel":429},"https://wiki.mozilla.org/CA/Revocation_Checking_in_Firefox",[34],"CA/Revocation Checking in Firefox - MozillaWiki",[27,432,433],{},[30,434,437],{"href":435,"rel":436},"https://discourse.mozilla.org/t/firefox-ocsp-policy/83150",[34],"Firefox OCSP policy - Firefox Development - Mozilla Discourse",[27,439,440],{},[30,441,444],{"href":442,"rel":443},"https://knowledge.digicert.com/nl/nl/quovadis/ssl-certificates/ssl-general-topics/in-which-browsers-is-ocsp-online-certificates-status-protocol-supported-in",[34],"In which browsers is OCSP (Online Certificates Status Protocol) supported in?",[27,446,447],{},[30,448,451],{"href":449,"rel":450},"https://blog.mozilla.org/security/2020/01/09/crlite-part-1-all-web-pki-revocations-compressed/",[34],"Introducing CRLite: All of the Web PKI’s revocations, compressed - Mozilla Security Blog",[27,453,454],{},[30,455,458],{"href":456,"rel":457},"https://blog.mozilla.org/security/2020/01/21/crlite-part-3-speeding-up-secure-browsing/",[34],"CRLite: Speeding Up Secure Browsing - Mozilla Security Blog",[27,460,461],{},[30,462,465],{"href":463,"rel":464},"https://blog.cloudflare.com/high-reliability-ocsp-stapling/",[34],"High-reliability OCSP stapling and why it matters - The Cloudflare Blog",[27,467,468],{},[30,469,472],{"href":470,"rel":471},"https://en.wikipedia.org/wiki/Online_Certificate_Status_Protocol",[34],"Online Certificate Status Protocol - Wikipedia",[27,474,475],{},[30,476,479,480,483],{"href":477,"rel":478},"https://bugzilla.mozilla.org/show_bug.cgi?id=1429800",[34],"1429800 - (crlite) ",[77,481,482],{},"meta"," Implement a CRLite based revocation mechanism",[27,485,486],{},[30,487,490],{"href":488,"rel":489},"https://bugzilla.mozilla.org/show_bug.cgi?id=1761109",[34],"1761109 - Make check-revocations mode the default CRLite mode",[27,492,493],{},[30,494,497],{"href":495,"rel":496},"https://www.reddit.com/r/browsers/comments/1bb81y8/firefox_the_only_browser_doing_certificate/",[34],"Firefox - The only browser doing certificate revocation checks right : r/browsers",[27,499,500],{},[30,501,503],{"href":415,"rel":502},[34],"Intent to End OCSP Service - Let's Encrypt",[27,505,506],{},[30,507,510],{"href":508,"rel":509},"https://groups.google.com/a/mozilla.org/g/dev-security-policy/c/S6A14e_X-T0/m/T4WxWgajAAAJ",[34],"Revocation checking for EV server certificates in Chrome - Google Groups",[27,512,513],{},[30,514,516],{"href":88,"rel":515},[34],"CRLSets - The Chromium Projects",[27,518,519],{},[30,520,522],{"href":114,"rel":521},[34],"由于Bug，Let's Encrypt决定吊销300多万张证书！",[27,524,525],{},[30,526,528],{"href":303,"rel":527},[34],"Let’s Encrypt OCSP 域名被封",[27,530,531],{},[30,532,289],{"href":287,"rel":533},[34],[535,536,537],"style",{},"html pre.shiki code .sAdtL, html code.shiki .sAdtL{--shiki-default:#4078F2;--shiki-dark:#61AFEF}html pre.shiki code .sDhpE, html code.shiki .sDhpE{--shiki-default:#50A14F;--shiki-dark:#98C379}html pre.shiki code .sAGMh, html code.shiki .sAGMh{--shiki-default:#986801;--shiki-dark:#D19A66}html pre.shiki code .s5ixo, html code.shiki .s5ixo{--shiki-default:#383A42;--shiki-dark:#ABB2BF}html .default .shiki span {color: var(--shiki-default);background: var(--shiki-default-bg);font-style: var(--shiki-default-font-style);font-weight: var(--shiki-default-font-weight);text-decoration: var(--shiki-default-text-decoration);}html .shiki span {color: var(--shiki-default);background: var(--shiki-default-bg);font-style: var(--shiki-default-font-style);font-weight: var(--shiki-default-font-weight);text-decoration: var(--shiki-default-text-decoration);}html .dark .shiki span {color: var(--shiki-dark);background: var(--shiki-dark-bg);font-style: var(--shiki-dark-font-style);font-weight: var(--shiki-dark-font-weight);text-decoration: var(--shiki-dark-text-decoration);}html.dark .shiki span {color: var(--shiki-dark);background: var(--shiki-dark-bg);font-style: var(--shiki-dark-font-style);font-weight: var(--shiki-dark-font-weight);text-decoration: var(--shiki-dark-text-decoration);}",{"title":57,"searchDepth":539,"depth":539,"links":540},2,[541,542,543,548,549],{"id":17,"depth":539,"text":18},{"id":107,"depth":539,"text":108},{"id":120,"depth":539,"text":121,"children":544},[545,547],{"id":128,"depth":546,"text":129},3,{"id":350,"depth":546,"text":351},{"id":409,"depth":539,"text":409},{"id":421,"depth":539,"text":421},[551,557],{"title":552,"path":553,"stem":554,"date":555,"lang":556,"children":-1},"构建部署在 Cloudflare Workers 上的 TG Bot","/2024/12/30/tg-bot-hosted-on-cloudflare-workers","posts/zh/tg-bot-hosted-on-cloudflare-workers","2024-12-30 19:45:43","zh-CN",{"title":558,"path":559,"stem":560,"date":561,"lang":556,"children":-1},"小爱课程表适配不完全指北——以 ZJUT 本科正方教务系统为例","/2024/11/18/mi-ai-class-schedule-adapter-for-zjut","posts/zh/mi-ai-class-schedule-adapter-for-zjut","2024-11-18 21:13:56",9,null,1765307574851]