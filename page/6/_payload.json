[{"data":1,"prerenderedAt":7208},["ShallowReactive",2],{"randomIndex/page/6/":3,"language-switch-/page/6/-en":4,"index-page-6-zh":5,"posts-total-zh":7207},5,"/en/",[6,543,872,3970,4206,4507,5260,5377,6475,6786],{"title":7,"date":8,"path":9,"tags":10,"body":16},"结合 Vue.js 与 php 完成的 web 期末大作业，讲讲前后端分离站点开发与部署中可能遇到的 CORS 跨域问题","2024-01-10 23:55:36","/2024/01/10/cors-when-using-splited-frontend-and-backend",[11,12,13,14,15],"Vue.js","PHP","Network","Notes","Web",{"type":17,"value":18,"toc":533},"minimark",[19,29,32,37,41,49,55,66,80,83,112,115,128,137,153,159,164,167,183,186,189,202,205,208,211,214,221,271,274,503,510,517,520,529],[20,21,22,23,28],"p",{},"在",[24,25,27],"a",{"href":26},"/2023/12/27/php-and-vuejs-project-deploy-on-caddy/","上一篇博客","中，我讲到了 web 期末大作业的上云部署。整个项目是使用 Vue.js 作为前端，php 作为后端，mysql 作为数据库实现的。",[20,30,31],{},"在使用 Vue.js 开发前端界面时，我选择了使用 vite 脚手架帮助开发，这意味着我的作品将使用前后端分离的架构实现。因此在开发部署过程中均遇到了跨域的问题，故写下这篇博客记录下解决方案。",[33,34,36],"h2",{"id":35},"基于后端返回对应-http-响应头的解决方案","基于后端返回对应 http 响应头的解决方案",[38,39,40],"h3",{"id":40},"开发阶段",[20,42,43,44,48],{},"在我完成前后端的开发，并且经过 Apifox 的 mock 测试后，第一次在浏览器尝试前后端对接，遇到了 ",[45,46,47],"code",{},"CORS Missing Allow Origin"," 的报错。",[20,50,51],{},[52,53],"img",{"alt":47,"src":54},"https://static.031130.xyz/uploads/2024/08/12/659ec607c69af.webp",[20,56,57,58,61,62,65],{},"vite 启动的 dev 开发服务器使用的域是 ",[45,59,60],{},"http://localhost:5173"," ，而 php 后端我指定的是 ",[45,63,64],{},"http://127.0.0.1:8080"," ，前后端并不运行在一个域下，前端使用 Axios(AJAX) 向后端发送请求获取资源输入 CORS 跨域资源共享的范畴。",[20,67,68,69,75,76,79],{},"关于跨域资源共享 CORS 的相关内容，",[24,70,74],{"href":71,"rel":72},"https://www.ruanyifeng.com/blog/2016/04/cors.html",[73],"nofollow","阮一峰老师在 2016 年就已经在他的博客中有过解释","，看了下也是全网中文内容中解释得比较通俗易懂的，因此本文在这方面不过多做解释。错误的提示信息是 Missing Allow Origin，结合阮一峰老师的博文，我们应该在后端向前端发送的 http 响应头中添加 ",[45,77,78],{},"Access-Control-Allow-Origin"," 这一字段。",[20,81,82],{},"在一般的前后端分离项目（不涉及 cookie 等 Credentials 属性）中，我们可以将这一字段设置为 * 通配符，默认允许所有的域向自己发起跨域资源请求。php 可以通过下面这行代码很方便地进行设置:",[84,85,90],"pre",{"className":86,"code":87,"language":88,"meta":89,"style":89},"language-php shiki shiki-themes one-light one-dark-pro","header('Access-Control-Allow-Origin: *');\n","php","",[45,91,92],{"__ignoreMap":89},[93,94,97,101,105,109],"span",{"class":95,"line":96},"line",1,[93,98,100],{"class":99},"s_Sar","header",[93,102,104],{"class":103},"s5ixo","(",[93,106,108],{"class":107},"sDhpE","'Access-Control-Allow-Origin: *'",[93,110,111],{"class":103},");\n",[20,113,114],{},"但在用户的注册登录方面，我使用了 session 作为用户的登录凭据。阮一峰老师关于 CORS 的博文中有这样一句话:",[116,117,118],"blockquote",{},[20,119,120,121,123,124,127],{},"需要注意的是，如果要发送Cookie，",[45,122,78],{},"就不能设为星号，必须指定明确的、与请求网页一致的域名。同时，Cookie依然遵循同源政策，只有用服务器域名设置的Cookie才会上传，其他域名的Cookie并不会上传，且（跨源）原网页代码中的",[45,125,126],{},"document.cookie","也无法读取服务器域名下的Cookie。",[20,129,130,131,133,134,136],{},"因此，我们必须明确指定 ",[45,132,78],{}," 字段为前端所使用的域，写上 ",[45,135,60],{}," 才行。",[84,138,140],{"className":86,"code":139,"language":88,"meta":89,"style":89},"header('Access-Control-Allow-Origin: http://localhost:5173');\n",[45,141,142],{"__ignoreMap":89},[93,143,144,146,148,151],{"class":95,"line":96},[93,145,100],{"class":99},[93,147,104],{"class":103},[93,149,150],{"class":107},"'Access-Control-Allow-Origin: http://localhost:5173'",[93,152,111],{"class":103},[20,154,155,156],{},"再次刷新网页，获得了新的错误 ",[45,157,158],{},"CORS Missing Allow Credentials",[20,160,161],{},[52,162],{"alt":158,"src":163},"https://static.031130.xyz/uploads/2024/08/12/659ec95acc0bc.webp",[20,165,166],{},"这个问题处理起来也简单",[84,168,170],{"className":86,"code":169,"language":88,"meta":89,"style":89},"header('Access-Control-Allow-Credentials: true');\n",[45,171,172],{"__ignoreMap":89},[93,173,174,176,178,181],{"class":95,"line":96},[93,175,100],{"class":99},[93,177,104],{"class":103},[93,179,180],{"class":107},"'Access-Control-Allow-Credentials: true'",[93,182,111],{"class":103},[20,184,185],{},"再次运行网页，跨域问题成功解决。",[38,187,188],{"id":188},"部署阶段",[20,190,191,192,194,195,198,199,201],{},"顺着这个思路进行下去，我们在部署阶段解决跨域问题需要做的事情很简单。提前将前端部署起来，将前端的域写到后端返回给前端的 http 相应头中即可。需要注意的是，",[45,193,78],{}," 字段仅允许填写一个值，如果需要同时允许来自多个不同域的跨域资源共享，后端部分需要根据前端发来的请求头中的 ",[45,196,197],{},"Origin"," 字段相应地设置响应头中的 ",[45,200,78],{}," 。当然，nginx 等先进的 static server 也支持劫持 http 请求，添加相关的 Access-Control 语句，也可以在这一层解决这个问题。",[33,203,204],{"id":204},"直接规避跨域的方案",[20,206,207],{},"上面通过后端返回带有 Access-Control 语句相应头的解决方案确实可以解决问题，却显得不够优雅。开发和部署阶段都要手动的去指定前端的域来允许跨域资源共享，这一点过于麻烦了，因此引出了下面的解决方案。",[38,209,40],{"id":210},"开发阶段-1",[20,212,213],{},"在 vite（或者其他同类开发服务器）的帮助下，我们可以使用前端的开发服务器去反向代理后端服务，也就是让前端的请求打到前端服务器上，由前端服务器去返回后端服务器返回的结果。",[20,215,216,217,220],{},"在 ",[45,218,219],{},"vite.config.ts"," 配置文件下，我将原本的",[84,222,226],{"className":223,"code":224,"language":225,"meta":89,"style":89},"language-typescript shiki shiki-themes one-light one-dark-pro","export default defineConfig({\n  plugins: [vue()],\n})\n","typescript",[45,227,228,245,265],{"__ignoreMap":89},[93,229,230,234,238,242],{"class":95,"line":96},[93,231,233],{"class":232},"sLKXg","export",[93,235,237],{"class":236},"sq3v1"," default",[93,239,241],{"class":240},"sAdtL"," defineConfig",[93,243,244],{"class":103},"({\n",[93,246,248,252,256,259,262],{"class":95,"line":247},2,[93,249,251],{"class":250},"sJa8x","  plugins",[93,253,255],{"class":254},"st7oF",":",[93,257,258],{"class":103}," [",[93,260,261],{"class":240},"vue",[93,263,264],{"class":103},"()],\n",[93,266,268],{"class":95,"line":267},3,[93,269,270],{"class":103},"})\n",[20,272,273],{},"换成了",[84,275,277],{"className":223,"code":276,"language":225,"meta":89,"style":89},"export default () => {\n  process.env = { ...process.env, ...loadEnv(process.cwd(),'') };\n\n  const config = {\n    plugins: [vue()],\n    server: {\n      proxy: {\n        '/api': {\n          target: http://127.0.0.1:8080,\n          changeOrigin: true,\n          secure: false,\n        }\n      }\n    }\n  }\n  return defineConfig(config)\n};\n",[45,278,279,294,348,354,368,381,391,401,411,428,444,457,463,469,475,481,497],{"__ignoreMap":89},[93,280,281,283,285,288,291],{"class":95,"line":96},[93,282,233],{"class":232},[93,284,237],{"class":236},[93,286,287],{"class":103}," () ",[93,289,290],{"class":232},"=>",[93,292,293],{"class":103}," {\n",[93,295,296,300,303,306,309,312,315,318,320,322,325,327,330,332,334,336,339,342,345],{"class":95,"line":247},[93,297,299],{"class":298},"s7GmK","  process",[93,301,302],{"class":103},".",[93,304,305],{"class":250},"env",[93,307,308],{"class":99}," =",[93,310,311],{"class":103}," { ",[93,313,314],{"class":254},"...",[93,316,317],{"class":298},"process",[93,319,302],{"class":103},[93,321,305],{"class":250},[93,323,324],{"class":103},", ",[93,326,314],{"class":254},[93,328,329],{"class":240},"loadEnv",[93,331,104],{"class":103},[93,333,317],{"class":298},[93,335,302],{"class":103},[93,337,338],{"class":240},"cwd",[93,340,341],{"class":103},"(),",[93,343,344],{"class":107},"''",[93,346,347],{"class":103},") };\n",[93,349,350],{"class":95,"line":267},[93,351,353],{"emptyLinePlaceholder":352},true,"\n",[93,355,357,360,364,366],{"class":95,"line":356},4,[93,358,359],{"class":232},"  const",[93,361,363],{"class":362},"sNmU0"," config",[93,365,308],{"class":99},[93,367,293],{"class":103},[93,369,370,373,375,377,379],{"class":95,"line":3},[93,371,372],{"class":250},"    plugins",[93,374,255],{"class":254},[93,376,258],{"class":103},[93,378,261],{"class":240},[93,380,264],{"class":103},[93,382,384,387,389],{"class":95,"line":383},6,[93,385,386],{"class":250},"    server",[93,388,255],{"class":254},[93,390,293],{"class":103},[93,392,394,397,399],{"class":95,"line":393},7,[93,395,396],{"class":250},"      proxy",[93,398,255],{"class":254},[93,400,293],{"class":103},[93,402,404,407,409],{"class":95,"line":403},8,[93,405,406],{"class":107},"        '/api'",[93,408,255],{"class":254},[93,410,293],{"class":103},[93,412,414,417,419,422,424],{"class":95,"line":413},9,[93,415,416],{"class":250},"          target",[93,418,255],{"class":254},[93,420,421],{"class":250}," http",[93,423,255],{"class":103},[93,425,427],{"class":426},"sW2Sy","//127.0.0.1:8080,\n",[93,429,431,434,437,441],{"class":95,"line":430},10,[93,432,433],{"class":250},"          changeOrigin",[93,435,436],{"class":103},": ",[93,438,440],{"class":439},"sAGMh","true",[93,442,443],{"class":103},",\n",[93,445,447,450,452,455],{"class":95,"line":446},11,[93,448,449],{"class":250},"          secure",[93,451,255],{"class":254},[93,453,454],{"class":439}," false",[93,456,443],{"class":103},[93,458,460],{"class":95,"line":459},12,[93,461,462],{"class":103},"        }\n",[93,464,466],{"class":95,"line":465},13,[93,467,468],{"class":103},"      }\n",[93,470,472],{"class":95,"line":471},14,[93,473,474],{"class":103},"    }\n",[93,476,478],{"class":95,"line":477},15,[93,479,480],{"class":103},"  }\n",[93,482,484,487,489,491,494],{"class":95,"line":483},16,[93,485,486],{"class":232},"  return",[93,488,241],{"class":240},[93,490,104],{"class":103},[93,492,493],{"class":250},"config",[93,495,496],{"class":103},")\n",[93,498,500],{"class":95,"line":499},17,[93,501,502],{"class":103},"};\n",[20,504,505,506,509],{},"同时将 Axios create 时的 ",[45,507,508],{},"baseURL"," 参数去除。",[20,511,512,513,516],{},"这样一套组合拳下来，将所有打向 ",[45,514,515],{},"/api*"," 的请求和响应通过前端的开发服务器作为中介做了中转，让浏览器以为并没有跨域（事实上也没有跨域），从而解决了相关的问题。",[38,518,188],{"id":519},"部署阶段-1",[20,521,522,523,528],{},"在开发阶段，我们通过 vite 的开发服务器做反向代理规避了跨域请求，但在部署阶段就用不了了。由于 vite 服务器的性能太弱，一般情况下我们是不会在生产环境中使用 vite 作为正式的服务器的，而是使用 vite build 出网站的静态网页资源，通过 nginx 等 static server 去向用户提供前端网页。而通过 vite build 出来的静态网页资源本身是不具备反向代理的能力的，这意味着没法在前端侧规避跨域问题。此时，我们应该配置 nginx 规避跨域问题。我一向不怎么使用 nginx，使用的是它的平替品 caddy，因此 nginx 的配置文件需要大家自行搜索，",[24,524,527],{"href":525,"rel":526},"https://zhul.in/2023/12/27/php-and-vuejs-project-deploy-on-caddy/#Caddy-%E9%85%8D%E7%BD%AE",[73],"我的 caddyfile 在上一篇博客中已经给出","，仅供参考。",[530,531,532],"style",{},"html pre.shiki code .sLKXg, html code.shiki .sLKXg{--shiki-default:#A626A4;--shiki-dark:#C678DD}html pre.shiki code .sq3v1, html code.shiki .sq3v1{--shiki-default:#E45649;--shiki-dark:#C678DD}html pre.shiki code .sAdtL, html code.shiki .sAdtL{--shiki-default:#4078F2;--shiki-dark:#61AFEF}html pre.shiki code .s5ixo, html code.shiki .s5ixo{--shiki-default:#383A42;--shiki-dark:#ABB2BF}html pre.shiki code .sJa8x, html code.shiki .sJa8x{--shiki-default:#E45649;--shiki-dark:#E06C75}html pre.shiki code .st7oF, html code.shiki .st7oF{--shiki-default:#0184BC;--shiki-dark:#ABB2BF}html .default .shiki span {color: var(--shiki-default);background: var(--shiki-default-bg);font-style: var(--shiki-default-font-style);font-weight: var(--shiki-default-font-weight);text-decoration: var(--shiki-default-text-decoration);}html .shiki span {color: var(--shiki-default);background: var(--shiki-default-bg);font-style: var(--shiki-default-font-style);font-weight: var(--shiki-default-font-weight);text-decoration: var(--shiki-default-text-decoration);}html .dark .shiki span {color: var(--shiki-dark);background: var(--shiki-dark-bg);font-style: var(--shiki-dark-font-style);font-weight: var(--shiki-dark-font-weight);text-decoration: var(--shiki-dark-text-decoration);}html.dark .shiki span {color: var(--shiki-dark);background: var(--shiki-dark-bg);font-style: var(--shiki-dark-font-style);font-weight: var(--shiki-dark-font-weight);text-decoration: var(--shiki-dark-text-decoration);}html pre.shiki code .s7GmK, html code.shiki .s7GmK{--shiki-default:#383A42;--shiki-dark:#E5C07B}html pre.shiki code .s_Sar, html code.shiki .s_Sar{--shiki-default:#0184BC;--shiki-dark:#56B6C2}html pre.shiki code .sDhpE, html code.shiki .sDhpE{--shiki-default:#50A14F;--shiki-dark:#98C379}html pre.shiki code .sNmU0, html code.shiki .sNmU0{--shiki-default:#986801;--shiki-dark:#E5C07B}html pre.shiki code .sW2Sy, html code.shiki .sW2Sy{--shiki-default:#A0A1A7;--shiki-default-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic}html pre.shiki code .sAGMh, html code.shiki .sAGMh{--shiki-default:#986801;--shiki-dark:#D19A66}",{"title":89,"searchDepth":247,"depth":247,"links":534},[535,539],{"id":35,"depth":247,"text":36,"children":536},[537,538],{"id":40,"depth":267,"text":40},{"id":188,"depth":267,"text":188},{"id":204,"depth":247,"text":204,"children":540},[541,542],{"id":210,"depth":267,"text":40},{"id":519,"depth":267,"text":188},{"title":544,"date":545,"path":546,"tags":547,"body":550},"vuejs、php、caddy 与 docker —— web 期末大作业上云部署","2023-12-27 22:09:00","/2023/12/27/php-and-vuejs-project-deploy-on-caddy",[12,548,11,13,549,15],"Caddy","Docker",{"type":17,"value":551,"toc":864},[552,569,572,581,584,616,624,641,648,714,729,733,736,743,751,754,757,764,790,793,796,807,811,814,820,843,847,854,861],[116,553,554,557,563,566],{},[20,555,556],{},"这学期修了一门叫《用HTML5 和 PHP编写JavaScript，jQuery 和 AJAX脚本》的 web 课（对，听起来很奇怪的名字）。期末大作业是写一个影评系统，前端允许使用框架，后端仅允许使用 php，具体的作业要求如下",[20,558,559],{},[52,560],{"alt":561,"src":562},"作业要求","https://static.031130.xyz/uploads/2024/08/12/658c4c3128ae4.webp",[20,564,565],{},"（源码会在验收结束以后开源）",[20,567,568],{},"大作业写了得要有三个礼拜，工作时长加起来得有 30 个小时，想着验收之前上线一段时间积累一些评论数据，验收的时候也会更加顺利一些，于是就开始尝试在服务器上部署。部署的过程还是比较复杂的，所以写下这篇博客记录一下。",[33,570,571],{"id":571},"后端部分",[20,573,574,575,580],{},"早前有",[24,576,579],{"href":577,"rel":578},"https://zhul.in/2021/10/21/picuploader-on-archlinux-with-caddy/",[73],"《PicUploader使用系列（一）——在Archlinux上使用Caddy部署PicUploader》","的经验，便觉得使用 Caddy + php-fpm 部署的方式多少有点麻烦了，这次便尝试了使用 Docker 部署、Caddy 反代的方式。",[20,582,583],{},"Dockerfile 如下:",[84,585,589],{"className":586,"code":587,"language":588,"meta":89,"style":89},"language-dockerfile shiki shiki-themes one-light one-dark-pro","FROM php:8-apache\nRUN docker-php-ext-install mysqli\nRUN a2enmod rewrite\nCOPY . /var/www/html\nEXPOSE 80\n","dockerfile",[45,590,591,596,601,606,611],{"__ignoreMap":89},[93,592,593],{"class":95,"line":96},[93,594,595],{},"FROM php:8-apache\n",[93,597,598],{"class":95,"line":247},[93,599,600],{},"RUN docker-php-ext-install mysqli\n",[93,602,603],{"class":95,"line":267},[93,604,605],{},"RUN a2enmod rewrite\n",[93,607,608],{"class":95,"line":356},[93,609,610],{},"COPY . /var/www/html\n",[93,612,613],{"class":95,"line":3},[93,614,615],{},"EXPOSE 80\n",[20,617,618,619,623],{},"在后端的根目录下有一个 .htaccess 文件，将所有的请求都交给 index.php 来处理，这样就可以根据我的",[24,620,27],{"href":621,"rel":622},"https://zhul.in/2023/12/12/php-simple-rest-api/",[73],"中所提到的方式去构建不使用任何 php 框架实现的简易 router 效果",[84,625,629],{"className":626,"code":627,"language":628,"meta":89,"style":89},"language-htaccess shiki shiki-themes one-light one-dark-pro","RewriteEngine On\nRewriteRule ^(.*) index.php [QSA,L]\n","htaccess",[45,630,631,636],{"__ignoreMap":89},[93,632,633],{"class":95,"line":96},[93,634,635],{},"RewriteEngine On\n",[93,637,638],{"class":95,"line":247},[93,639,640],{},"RewriteRule ^(.*) index.php [QSA,L]\n",[20,642,643,644,647],{},"构建 Docker 镜像时使用 ",[45,645,646],{},"docker build . -t mrs-php"," 命令，运行 docker 容器时使用命令",[84,649,653],{"className":650,"code":651,"language":652,"meta":89,"style":89},"language-bash shiki shiki-themes one-light one-dark-pro","docker run -d \\\n    -p 7788:80 \\\n    --name mrs-php \\\n    -v /path/to/uploads:/var/www/html/uploads \\\n    --restart unless-stopped \\\n    mrs-php\n","bash",[45,654,655,669,679,689,699,709],{"__ignoreMap":89},[93,656,657,660,663,666],{"class":95,"line":96},[93,658,659],{"class":240},"docker",[93,661,662],{"class":107}," run",[93,664,665],{"class":439}," -d",[93,667,668],{"class":99}," \\\n",[93,670,671,674,677],{"class":95,"line":247},[93,672,673],{"class":439},"    -p",[93,675,676],{"class":107}," 7788:80",[93,678,668],{"class":99},[93,680,681,684,687],{"class":95,"line":267},[93,682,683],{"class":439},"    --name",[93,685,686],{"class":107}," mrs-php",[93,688,668],{"class":99},[93,690,691,694,697],{"class":95,"line":356},[93,692,693],{"class":439},"    -v",[93,695,696],{"class":107}," /path/to/uploads:/var/www/html/uploads",[93,698,668],{"class":99},[93,700,701,704,707],{"class":95,"line":3},[93,702,703],{"class":439},"    --restart",[93,705,706],{"class":107}," unless-stopped",[93,708,668],{"class":99},[93,710,711],{"class":95,"line":383},[93,712,713],{"class":107},"    mrs-php\n",[20,715,716,717,720,721,724,725,728],{},"这样，后端就在 7788 端口上开起来了，后续 Caddy 只要将打到 ",[45,718,719],{},"/api/*"," 和 ",[45,722,723],{},"/uploads/*"," 的请求转发到 7788 端口即可，避免了使用 php-fpm 时需要的配置。",[45,726,727],{},"uploads"," 目录是用来存放图片的，我将这个路径挂在在宿主机的目录下，方便备份导入等操作。",[38,730,732],{"id":731},"mysql-连接时的小插曲","mysql 连接时的小插曲",[20,734,735],{},"需要注意的是，在 Docker 容器中运行的 php 如果想要访问宿主机上的 mysql，需要注意修改 mysql 服务器的 ip 地址，并允许 mysql 接收来自非本机的请求。",[20,737,738,739,742],{},"在宿主机中运行 ",[45,740,741],{},"ip -br a"," 命令可以看到 docker 所采用的虚拟网卡的 ip 地址",[84,744,749],{"className":745,"code":747,"language":748},[746],"language-text","docker0          UP             172.17.0.1/16 fe80::42:eff:febf:b26c/64\n","text",[45,750,747],{"__ignoreMap":89},[20,752,753],{},"我这边得到的 ip 地址是 172.17.0.1，所以在 php 那边访问的数据库 ip 地址就应该是 172.17.0.1，而非 localhost 或者 127.0.0.1",[20,755,756],{},"此外，需要允许宿主机的 mysql 接收来自 Docker 容器的请求",[20,758,759,760,763],{},"使用 ",[45,761,762],{},"docker network inspect bridge"," 命令可以查到 docker 容器的 ip 地址，接着需要去允许来自这个 ip 的请求。建议去网上自行搜索，因为 mysql 语句我自己也不熟悉。我使用的 mysql 版本是 8，语句似乎和以前的版本不兼容？我使用下面三个命令轮着输就好了（有时候报错，有时侯又不报错），有大佬懂的话评论区讲讲。",[84,765,769],{"className":766,"code":767,"language":768,"meta":89,"style":89},"language-mysql shiki shiki-themes one-light one-dark-pro","use mysql;\nGRANT ALL ON *.* TO 'root'@'%';\nupdate user set host='%' where user='root';\nGRANT ALL ON *.* TO 'root'@'%';\n","mysql",[45,770,771,776,781,786],{"__ignoreMap":89},[93,772,773],{"class":95,"line":96},[93,774,775],{},"use mysql;\n",[93,777,778],{"class":95,"line":247},[93,779,780],{},"GRANT ALL ON *.* TO 'root'@'%';\n",[93,782,783],{"class":95,"line":267},[93,784,785],{},"update user set host='%' where user='root';\n",[93,787,788],{"class":95,"line":356},[93,789,780],{},[33,791,792],{"id":792},"前端部分",[20,794,795],{},"前端部分部署起来没什么难度",[20,797,798,799,802,803,806],{},"我使用的是 vite 开发的 vuejs 项目，直接使用 ",[45,800,801],{},"pnpm build"," 构建出静态文件，然后放入了 ",[45,804,805],{},"/var/www/mrs"," 目录，这部分没什么可说的",[33,808,810],{"id":809},"caddy-配置","Caddy 配置",[20,812,813],{},"Caddy 配置如下",[84,815,818],{"className":816,"code":817,"language":748},[746],"example.com {\n    handle /api/* {\n        reverse_proxy localhost:7788\n    }\n\n    handle /uploads/* {\n        reverse_proxy localhost:7788\n    }\n\n    handle /* {\n        root * /var/www/mrs\n        file_server\n        try_files {path} /\n    }\n}\n",[45,819,817],{"__ignoreMap":89},[20,821,822,823,720,825,827,828,831,832,835,836,839,840,842],{},"将打到 ",[45,824,719],{},[45,826,723],{}," 都交给 7788 端口的后端进行处理，前端部分要使用 ",[45,829,830],{},"try_files"," 将请求都指向 ",[45,833,834],{},"/"," 或 ",[45,837,838],{},"/index.html"," 交由 vue-router 处理，否则 caddy 就找不到对应的文件了。这里我尝试过使用 route 关键词代替 handle，但 ",[45,841,830],{}," 的功能没有生效，这两者的区别官方文档中有提到，但我没看懂，等我以后看看有没有机会去折腾了。",[33,844,846],{"id":845},"参考","参考:",[20,848,849],{},[24,850,853],{"href":851,"rel":852},"https://homeboyc.cn/blog/%E4%BD%BF%E7%94%A8caddy%E9%85%8D%E7%BD%AE%E5%90%8C%E4%B8%80%E5%9F%9F%E5%90%8D%E4%B8%8B%E7%9A%84%E5%89%8D%E5%90%8E%E5%88%86%E7%A6%BB/",[73],"使用Caddy配置同一域名下的前后分离",[20,855,856],{},[24,857,860],{"href":858,"rel":859},"https://blog.lyh543.cn/notes/linux/caddy.html",[73],"Caddy 2",[530,862,863],{},"html .default .shiki span {color: var(--shiki-default);background: var(--shiki-default-bg);font-style: var(--shiki-default-font-style);font-weight: var(--shiki-default-font-weight);text-decoration: var(--shiki-default-text-decoration);}html .shiki span {color: var(--shiki-default);background: var(--shiki-default-bg);font-style: var(--shiki-default-font-style);font-weight: var(--shiki-default-font-weight);text-decoration: var(--shiki-default-text-decoration);}html .dark .shiki span {color: var(--shiki-dark);background: var(--shiki-dark-bg);font-style: var(--shiki-dark-font-style);font-weight: var(--shiki-dark-font-weight);text-decoration: var(--shiki-dark-text-decoration);}html.dark .shiki span {color: var(--shiki-dark);background: var(--shiki-dark-bg);font-style: var(--shiki-dark-font-style);font-weight: var(--shiki-dark-font-weight);text-decoration: var(--shiki-dark-text-decoration);}html pre.shiki code .sAdtL, html code.shiki .sAdtL{--shiki-default:#4078F2;--shiki-dark:#61AFEF}html pre.shiki code .sDhpE, html code.shiki .sDhpE{--shiki-default:#50A14F;--shiki-dark:#98C379}html pre.shiki code .sAGMh, html code.shiki .sAGMh{--shiki-default:#986801;--shiki-dark:#D19A66}html pre.shiki code .s_Sar, html code.shiki .s_Sar{--shiki-default:#0184BC;--shiki-dark:#56B6C2}",{"title":89,"searchDepth":247,"depth":247,"links":865},[866,869,870,871],{"id":571,"depth":247,"text":571,"children":867},[868],{"id":731,"depth":267,"text":732},{"id":792,"depth":247,"text":792},{"id":809,"depth":247,"text":810},{"id":845,"depth":247,"text":846},{"title":873,"date":874,"path":875,"tags":876,"body":878},"【翻译】使用 PHP 构建简单的 REST API","2023-12-12 13:07:32","/2023/12/12/php-simple-rest-api",[877,12],"Translation",{"type":17,"value":879,"toc":3948},[880,889,892,901,910,913,916,929,932,935,938,946,949,953,956,959,962,965,971,974,980,983,986,994,997,1000,1003,1006,1009,1038,1041,1044,1050,1053,1061,1065,1068,1071,1074,1158,1161,1164,1171,1174,1177,1180,1198,1201,1237,1240,1243,1261,1264,1658,1661,1668,1671,1674,1677,1715,1722,1725,1728,1745,1748,1769,1772,1775,1778,1846,1851,1854,2045,2052,2058,2063,2066,2268,2275,2280,2283,2562,2567,2570,2770,2775,2778,2781,2784,3826,3829,3832,3901,3904,3913,3916,3919,3922,3925,3928,3945],[116,881,882],{},[20,883,884,885],{},"我这学期有一门偏向前端的 WEB 课程，期末大作业要求使用 PHP 作为后端语言实现一个简单的影评系统，应该是不允许使用框架，使用中文关键字在搜索引擎上搜了一阵子似乎没有可供参考的案例，后来就找到了这篇博客，当中的许多观点与我不谋而合，因此我将这篇博客翻译成中文，原文戳这里: ",[24,886,887],{"href":887,"rel":888},"https://amirkamizi.com/blog/php-simple-rest-api",[73],[33,890,891],{"id":891},"介绍",[20,893,894,895,900],{},"上周 @rapid_api 发了一个非常好的关于",[24,896,899],{"href":897,"rel":898},"https://twitter.com/Rapid_API/status/1486423046424563714",[73],"使用 nodejs 和 express 创建 REST API"," 的教程帖子。我想要帮助你使用 PHP 开发同样简单的 REST API。",[20,902,903,904,909],{},"首先，如果你不了解 REST API，请务必查看这个 ",[24,905,908],{"href":906,"rel":907},"https://twitter.com/Rapid_API/status/1452932706967461890",[73],"Twitter 帖子","。",[33,911,912],{"id":912},"目标",[20,914,915],{},"在我们开始之前，我想提一句，当我写这篇帖子的时候，我想确保：",[917,918,919,923,926],"ol",{},[920,921,922],"li",{},"我使用单纯的 PHP，不使用框架",[920,924,925],{},"我使用最简单的函数和结构体以便所有人都可以理解并跟上",[920,927,928],{},"我将主体部分分开",[20,930,931],{},"现在让我们开始吧",[33,933,934],{"id":934},"准备",[20,936,937],{},"在我本地的机器上，我创建了一个叫 api 的文件夹于 xampp > htdocs，在里面有一个叫 index.php 的文件",[20,939,940,941],{},"如果你没有 xampp 或者你不知道如何把 php 跑起来，请务必查看",[24,942,945],{"href":943,"rel":944},"https://amirkamizi.com/blog/introduction-to-php",[73],"这篇文章",[20,947,948],{},"现在，如果你尝试访问 localhost/api，你将得到一个空的响应，因为 index.php 文件是空的",[33,950,952],{"id":951},"优雅的-url","优雅的 URL",[20,954,955],{},"项目中，我们需要处理的第一件事是 url",[20,957,958],{},"REST API 的关键特性之一是每一个 url 负责一个资源和一个操作",[38,960,961],{"id":961},"问题",[20,963,964],{},"这时候如果我创建一个 users.php，我需要访问",[84,966,969],{"className":967,"code":968,"language":748},[746],"localhost/api/users.php\n",[45,970,968],{"__ignoreMap":89},[20,972,973],{},"我需要为每一个 user id 创建一个新的文件",[84,975,978],{"className":976,"code":977,"language":748},[746],"localhost/api/users/1.php\nlocalhost/api/users/2.php\n",[45,979,977],{"__ignoreMap":89},[20,981,982],{},"以此类推。",[20,984,985],{},"这种方案有两个问题",[917,987,988,991],{},[920,989,990],{},"为每个用户创建一个新文件是非常无聊和耗时的",[920,992,993],{},"路由不优雅，每个路径后面都带有 .php",[38,995,996],{"id":996},"解决方案",[20,998,999],{},"让我们解决这个问题。",[20,1001,1002],{},"正如我所提到的，我不想使用任何框架，并且我想使用最简单的、最让人能够理解的方案",[20,1004,1005],{},"让我们看看如何解决这个问题",[20,1007,1008],{},"在 api 文件夹下创建一个叫 .htaccess 的文件，并且将下面的文本复制进去",[84,1010,1012],{"className":626,"code":1011,"language":628,"meta":89,"style":89},"RewriteEngine On\nRewriteBase /api\nRewriteCond %{REQUEST_FILENAME} !-d\nRewriteCond %{REQUEST_FILENAME} !-f\nRewriteRule ^(.+)$ index.php [QSA,L]\n",[45,1013,1014,1018,1023,1028,1033],{"__ignoreMap":89},[93,1015,1016],{"class":95,"line":96},[93,1017,635],{},[93,1019,1020],{"class":95,"line":247},[93,1021,1022],{},"RewriteBase /api\n",[93,1024,1025],{"class":95,"line":267},[93,1026,1027],{},"RewriteCond %{REQUEST_FILENAME} !-d\n",[93,1029,1030],{"class":95,"line":356},[93,1031,1032],{},"RewriteCond %{REQUEST_FILENAME} !-f\n",[93,1034,1035],{"class":95,"line":3},[93,1036,1037],{},"RewriteRule ^(.+)$ index.php [QSA,L]\n",[20,1039,1040],{},"我们告诉服务器，将所有指向 /api 的请求都转发到 index.php 文件",[20,1042,1043],{},"现在，所有的 url 都指向 index.php 了，比如下面的 url 都是指向 index.php 的",[84,1045,1048],{"className":1046,"code":1047,"language":748},[746],"api/users\napi/users/10\napi/users/5\n",[45,1049,1047],{"__ignoreMap":89},[20,1051,1052],{},"现在我们同时解决了这两个问题",[917,1054,1055,1058],{},[920,1056,1057],{},"所有的 url 都被一个文件处理",[920,1059,1060],{},"url 都很优雅，结尾处没有 .php",[33,1062,1064],{"id":1063},"uri","URI",[20,1066,1067],{},"但如何知道用户请求的是哪个 uri 呢？",[20,1069,1070],{},"很简单，使用 $_SERVER 超全局变量",[20,1072,1073],{},"让我们来看一些例子",[84,1075,1077],{"className":86,"code":1076,"language":88,"meta":89,"style":89},"// url api/users\necho $_SERVER['REQUEST_URI'];\n// /api/users\n\n// url api/users/5\necho $_SERVER['REQUEST_URI'];\n// /api/users/5\n\n// url api\necho $_SERVER['REQUEST_URI'];\n// /api\n",[45,1078,1079,1084,1101,1106,1110,1115,1127,1132,1136,1141,1153],{"__ignoreMap":89},[93,1080,1081],{"class":95,"line":96},[93,1082,1083],{"class":426},"// url api/users\n",[93,1085,1086,1089,1092,1095,1098],{"class":95,"line":247},[93,1087,1088],{"class":99},"echo",[93,1090,1091],{"class":250}," $_SERVER",[93,1093,1094],{"class":103},"[",[93,1096,1097],{"class":107},"'REQUEST_URI'",[93,1099,1100],{"class":103},"];\n",[93,1102,1103],{"class":95,"line":267},[93,1104,1105],{"class":426},"// /api/users\n",[93,1107,1108],{"class":95,"line":356},[93,1109,353],{"emptyLinePlaceholder":352},[93,1111,1112],{"class":95,"line":3},[93,1113,1114],{"class":426},"// url api/users/5\n",[93,1116,1117,1119,1121,1123,1125],{"class":95,"line":383},[93,1118,1088],{"class":99},[93,1120,1091],{"class":250},[93,1122,1094],{"class":103},[93,1124,1097],{"class":107},[93,1126,1100],{"class":103},[93,1128,1129],{"class":95,"line":393},[93,1130,1131],{"class":426},"// /api/users/5\n",[93,1133,1134],{"class":95,"line":403},[93,1135,353],{"emptyLinePlaceholder":352},[93,1137,1138],{"class":95,"line":413},[93,1139,1140],{"class":426},"// url api\n",[93,1142,1143,1145,1147,1149,1151],{"class":95,"line":430},[93,1144,1088],{"class":99},[93,1146,1091],{"class":250},[93,1148,1094],{"class":103},[93,1150,1097],{"class":107},[93,1152,1100],{"class":103},[93,1154,1155],{"class":95,"line":446},[93,1156,1157],{"class":426},"// /api\n",[20,1159,1160],{},"看见了吗？这就是我们所需要的",[20,1162,1163],{},"现在，使用一个简单的 if 或者 switch 语句，我们就可以处理不同的路径了",[20,1165,1166,1167,909],{},"如果你从来没有用过这些语句，去读",[24,1168,945],{"href":1169,"rel":1170},"https://amirkamizi.com/blog/php-conditionals",[73],[33,1172,1173],{"id":1173},"请求方法",[20,1175,1176],{},"接下来，我们需要从请求中获取请求的方法，以查看它是GET、POST、PUT、PATCH还是DELETE。",[20,1178,1179],{},"你可以从 $_SERVER 超全局数组中获取这个信息。",[84,1181,1183],{"className":86,"code":1182,"language":88,"meta":89,"style":89},"$_SERVER['REQUEST_METHOD']\n",[45,1184,1185],{"__ignoreMap":89},[93,1186,1187,1190,1192,1195],{"class":95,"line":96},[93,1188,1189],{"class":250},"$_SERVER",[93,1191,1094],{"class":103},[93,1193,1194],{"class":107},"'REQUEST_METHOD'",[93,1196,1197],{"class":103},"]\n",[20,1199,1200],{},"让我们将这两个值存储在变量中：",[84,1202,1204],{"className":86,"code":1203,"language":88,"meta":89,"style":89},"$uri = $_SERVER['REQUEST_URI'];\n$method = $_SERVER['REQUEST_METHOD'];\n",[45,1205,1206,1222],{"__ignoreMap":89},[93,1207,1208,1211,1214,1216,1218,1220],{"class":95,"line":96},[93,1209,1210],{"class":250},"$uri",[93,1212,308],{"class":1213},"sknuh",[93,1215,1091],{"class":250},[93,1217,1094],{"class":103},[93,1219,1097],{"class":107},[93,1221,1100],{"class":103},[93,1223,1224,1227,1229,1231,1233,1235],{"class":95,"line":247},[93,1225,1226],{"class":250},"$method",[93,1228,308],{"class":1213},[93,1230,1091],{"class":250},[93,1232,1094],{"class":103},[93,1234,1194],{"class":107},[93,1236,1100],{"class":103},[20,1238,1239],{},"我们可以在一个简单的 switch 语句中使用这两个变量来处理不同的请求。",[20,1241,1242],{},"我们需要判断以下请求",[1244,1245,1246,1249,1252,1255,1258],"ul",{},[920,1247,1248],{},"api/users 的 GET 请求",[920,1250,1251],{},"api/users/{id} 的 GET 请求",[920,1253,1254],{},"api/users 的 POST 请求",[920,1256,1257],{},"api/users/{id} 的 PUT 请求",[920,1259,1260],{},"api/users/{id} 的 DELETE 请求",[20,1262,1263],{},"让我们编写针对上述请求的 switch 语句",[84,1265,1267],{"className":86,"code":1266,"language":88,"meta":89,"style":89},"switch ($method | $uri) {\n   /*\n   * Path: GET /api/users\n   * Task: show all the users\n   */\n   case ($method == 'GET' && $uri == '/api/users'):\n       break;\n   /*\n   * Path: GET /api/users/{id}\n   * Task: get one user\n   */\n   case ($method == 'GET' && preg_match('/\\/api\\/users\\/[1-9]/', $uri)):\n       break;\n   /*\n   * Path: POST /api/users\n   * Task: store one user\n   */\n   case ($method == 'POST' && $uri == '/api/users'):\n       break;\n   /*\n   * Path: PUT /api/users/{id}\n   * Task: update one user\n   */\n   case ($method == 'PUT' && preg_match('/\\/api\\/users\\/[1-9]/', $uri)):\n       break;\n   /*\n   * Path: DELETE /api/users/{id}\n   * Task: delete one user\n   */\n   case ($method == 'DELETE' && preg_match('/\\/api\\/users\\/[1-9]/', $uri)):\n       break;\n   /*\n   * Path: ?\n   * Task: this path doesn't match any of the defined paths\n   *      throw an error\n   */\n   default:\n       break;\n}\n",[45,1268,1269,1288,1293,1298,1303,1308,1336,1344,1348,1353,1358,1362,1409,1415,1419,1424,1429,1433,1457,1464,1469,1475,1481,1486,1526,1533,1538,1544,1550,1555,1601,1608,1613,1619,1625,1631,1636,1645,1652],{"__ignoreMap":89},[93,1270,1271,1274,1277,1279,1282,1285],{"class":95,"line":96},[93,1272,1273],{"class":232},"switch",[93,1275,1276],{"class":103}," (",[93,1278,1226],{"class":250},[93,1280,1281],{"class":1213}," |",[93,1283,1284],{"class":250}," $uri",[93,1286,1287],{"class":103},") {\n",[93,1289,1290],{"class":95,"line":247},[93,1291,1292],{"class":426},"   /*\n",[93,1294,1295],{"class":95,"line":267},[93,1296,1297],{"class":426},"   * Path: GET /api/users\n",[93,1299,1300],{"class":95,"line":356},[93,1301,1302],{"class":426},"   * Task: show all the users\n",[93,1304,1305],{"class":95,"line":3},[93,1306,1307],{"class":426},"   */\n",[93,1309,1310,1313,1315,1317,1320,1323,1326,1328,1330,1333],{"class":95,"line":383},[93,1311,1312],{"class":232},"   case",[93,1314,1276],{"class":103},[93,1316,1226],{"class":250},[93,1318,1319],{"class":1213}," ==",[93,1321,1322],{"class":107}," 'GET'",[93,1324,1325],{"class":1213}," &&",[93,1327,1284],{"class":250},[93,1329,1319],{"class":1213},[93,1331,1332],{"class":107}," '/api/users'",[93,1334,1335],{"class":103},"):\n",[93,1337,1338,1341],{"class":95,"line":393},[93,1339,1340],{"class":232},"       break",[93,1342,1343],{"class":103},";\n",[93,1345,1346],{"class":95,"line":403},[93,1347,1292],{"class":426},[93,1349,1350],{"class":95,"line":413},[93,1351,1352],{"class":426},"   * Path: GET /api/users/{id}\n",[93,1354,1355],{"class":95,"line":430},[93,1356,1357],{"class":426},"   * Task: get one user\n",[93,1359,1360],{"class":95,"line":446},[93,1361,1307],{"class":426},[93,1363,1364,1366,1368,1370,1372,1374,1376,1379,1381,1385,1388,1391,1393,1396,1398,1401,1404,1406],{"class":95,"line":459},[93,1365,1312],{"class":232},[93,1367,1276],{"class":103},[93,1369,1226],{"class":250},[93,1371,1319],{"class":1213},[93,1373,1322],{"class":107},[93,1375,1325],{"class":1213},[93,1377,1378],{"class":99}," preg_match",[93,1380,104],{"class":103},[93,1382,1384],{"class":1383},"sDaw7","'/",[93,1386,1387],{"class":99},"\\/",[93,1389,1390],{"class":1383},"api",[93,1392,1387],{"class":99},[93,1394,1395],{"class":1383},"users",[93,1397,1387],{"class":99},[93,1399,1400],{"class":1383},"[1-9]/'",[93,1402,1403],{"class":103},",",[93,1405,1284],{"class":250},[93,1407,1408],{"class":103},")):\n",[93,1410,1411,1413],{"class":95,"line":465},[93,1412,1340],{"class":232},[93,1414,1343],{"class":103},[93,1416,1417],{"class":95,"line":471},[93,1418,1292],{"class":426},[93,1420,1421],{"class":95,"line":477},[93,1422,1423],{"class":426},"   * Path: POST /api/users\n",[93,1425,1426],{"class":95,"line":483},[93,1427,1428],{"class":426},"   * Task: store one user\n",[93,1430,1431],{"class":95,"line":499},[93,1432,1307],{"class":426},[93,1434,1436,1438,1440,1442,1444,1447,1449,1451,1453,1455],{"class":95,"line":1435},18,[93,1437,1312],{"class":232},[93,1439,1276],{"class":103},[93,1441,1226],{"class":250},[93,1443,1319],{"class":1213},[93,1445,1446],{"class":107}," 'POST'",[93,1448,1325],{"class":1213},[93,1450,1284],{"class":250},[93,1452,1319],{"class":1213},[93,1454,1332],{"class":107},[93,1456,1335],{"class":103},[93,1458,1460,1462],{"class":95,"line":1459},19,[93,1461,1340],{"class":232},[93,1463,1343],{"class":103},[93,1465,1467],{"class":95,"line":1466},20,[93,1468,1292],{"class":426},[93,1470,1472],{"class":95,"line":1471},21,[93,1473,1474],{"class":426},"   * Path: PUT /api/users/{id}\n",[93,1476,1478],{"class":95,"line":1477},22,[93,1479,1480],{"class":426},"   * Task: update one user\n",[93,1482,1484],{"class":95,"line":1483},23,[93,1485,1307],{"class":426},[93,1487,1489,1491,1493,1495,1497,1500,1502,1504,1506,1508,1510,1512,1514,1516,1518,1520,1522,1524],{"class":95,"line":1488},24,[93,1490,1312],{"class":232},[93,1492,1276],{"class":103},[93,1494,1226],{"class":250},[93,1496,1319],{"class":1213},[93,1498,1499],{"class":107}," 'PUT'",[93,1501,1325],{"class":1213},[93,1503,1378],{"class":99},[93,1505,104],{"class":103},[93,1507,1384],{"class":1383},[93,1509,1387],{"class":99},[93,1511,1390],{"class":1383},[93,1513,1387],{"class":99},[93,1515,1395],{"class":1383},[93,1517,1387],{"class":99},[93,1519,1400],{"class":1383},[93,1521,1403],{"class":103},[93,1523,1284],{"class":250},[93,1525,1408],{"class":103},[93,1527,1529,1531],{"class":95,"line":1528},25,[93,1530,1340],{"class":232},[93,1532,1343],{"class":103},[93,1534,1536],{"class":95,"line":1535},26,[93,1537,1292],{"class":426},[93,1539,1541],{"class":95,"line":1540},27,[93,1542,1543],{"class":426},"   * Path: DELETE /api/users/{id}\n",[93,1545,1547],{"class":95,"line":1546},28,[93,1548,1549],{"class":426},"   * Task: delete one user\n",[93,1551,1553],{"class":95,"line":1552},29,[93,1554,1307],{"class":426},[93,1556,1558,1560,1562,1564,1566,1569,1572,1575,1577,1579,1581,1583,1585,1587,1589,1591,1593,1595,1597,1599],{"class":95,"line":1557},30,[93,1559,1312],{"class":232},[93,1561,1276],{"class":103},[93,1563,1226],{"class":250},[93,1565,1319],{"class":1213},[93,1567,1568],{"class":107}," '",[93,1570,1571],{"class":232},"DELETE",[93,1573,1574],{"class":107},"'",[93,1576,1325],{"class":1213},[93,1578,1378],{"class":99},[93,1580,104],{"class":103},[93,1582,1384],{"class":1383},[93,1584,1387],{"class":99},[93,1586,1390],{"class":1383},[93,1588,1387],{"class":99},[93,1590,1395],{"class":1383},[93,1592,1387],{"class":99},[93,1594,1400],{"class":1383},[93,1596,1403],{"class":103},[93,1598,1284],{"class":250},[93,1600,1408],{"class":103},[93,1602,1604,1606],{"class":95,"line":1603},31,[93,1605,1340],{"class":232},[93,1607,1343],{"class":103},[93,1609,1611],{"class":95,"line":1610},32,[93,1612,1292],{"class":426},[93,1614,1616],{"class":95,"line":1615},33,[93,1617,1618],{"class":426},"   * Path: ?\n",[93,1620,1622],{"class":95,"line":1621},34,[93,1623,1624],{"class":426},"   * Task: this path doesn't match any of the defined paths\n",[93,1626,1628],{"class":95,"line":1627},35,[93,1629,1630],{"class":426},"   *      throw an error\n",[93,1632,1634],{"class":95,"line":1633},36,[93,1635,1307],{"class":426},[93,1637,1639,1642],{"class":95,"line":1638},37,[93,1640,1641],{"class":232},"   default",[93,1643,1644],{"class":103},":\n",[93,1646,1648,1650],{"class":95,"line":1647},38,[93,1649,1340],{"class":232},[93,1651,1343],{"class":103},[93,1653,1655],{"class":95,"line":1654},39,[93,1656,1657],{"class":103},"}\n",[20,1659,1660],{},"当我们想要在 switch 语句中使用两个变量，我们可以使用 | 符号",[20,1662,1663,1664,909],{},"如果你想知道 preg_match 是如何工作的，看",[24,1665,945],{"href":1666,"rel":1667},"https://amirkamizi.com/blog/php-regular-expressions",[73],[33,1669,1670],{"id":1670},"数据库",[20,1672,1673],{},"现在是说说数据。储存数据的最好方法是将数据储存在数据库中。但在这篇教程中，我不想使用数据库。因此，我们使用一个 json 文件当作数据库来保证数据的持久性。",[20,1675,1676],{},"我的 json 文件看起来长成这个样子：",[84,1678,1682],{"className":1679,"code":1680,"language":1681,"meta":89,"style":89},"language-json shiki shiki-themes one-light one-dark-pro","{\n   \"1\": \"Pratham\",\n   \"2\": \"Amir\"\n}\n","json",[45,1683,1684,1689,1701,1711],{"__ignoreMap":89},[93,1685,1686],{"class":95,"line":96},[93,1687,1688],{"class":103},"{\n",[93,1690,1691,1694,1696,1699],{"class":95,"line":247},[93,1692,1693],{"class":250},"   \"1\"",[93,1695,436],{"class":103},[93,1697,1698],{"class":107},"\"Pratham\"",[93,1700,443],{"class":103},[93,1702,1703,1706,1708],{"class":95,"line":267},[93,1704,1705],{"class":250},"   \"2\"",[93,1707,436],{"class":103},[93,1709,1710],{"class":107},"\"Amir\"\n",[93,1712,1713],{"class":95,"line":356},[93,1714,1657],{"class":103},[20,1716,1717,1718],{},"如果你想知道如何使用 json，看",[24,1719,945],{"href":1720,"rel":1721},"https://amirkamizi.com/blog/php-xml-and-json",[73],[20,1723,1724],{},"我加载 json 数据并将其转换为数组，然后在 php 使用他们。如果我想要更改数据，我将数组转换回 json 并将其重新写入文件。",[20,1726,1727],{},"要将整个文件作为一个字符串读取并存储在变量中，我使用：",[84,1729,1731],{"className":86,"code":1730,"language":88,"meta":89,"style":89},"file_get_contents($jsonFile);\n",[45,1732,1733],{"__ignoreMap":89},[93,1734,1735,1738,1740,1743],{"class":95,"line":96},[93,1736,1737],{"class":99},"file_get_contents",[93,1739,104],{"class":103},[93,1741,1742],{"class":250},"$jsonFile",[93,1744,111],{"class":103},[20,1746,1747],{},"而要将json写入文件，我使用：",[84,1749,1751],{"className":86,"code":1750,"language":88,"meta":89,"style":89},"file_put_contents($jsonFile, $data);\n",[45,1752,1753],{"__ignoreMap":89},[93,1754,1755,1758,1760,1762,1764,1767],{"class":95,"line":96},[93,1756,1757],{"class":99},"file_put_contents",[93,1759,104],{"class":103},[93,1761,1742],{"class":250},[93,1763,1403],{"class":103},[93,1765,1766],{"class":250}," $data",[93,1768,111],{"class":103},[20,1770,1771],{},"好了，现在我们的数据库处理好了，让我们开始处理所有的路径。",[20,1773,1774],{},"我使用 Postman 发送请求并查看响应。",[33,1776,1777],{"id":1777},"获取所有用户",[84,1779,1781],{"className":86,"code":1780,"language":88,"meta":89,"style":89},"case ($method == 'GET' && $uri == '/api/users'):\n   header('Content-Type: application/json');\n   echo json_encode($users, JSON_PRETTY_PRINT);\n   break;\n",[45,1782,1783,1806,1818,1839],{"__ignoreMap":89},[93,1784,1785,1788,1790,1792,1794,1796,1798,1800,1802,1804],{"class":95,"line":96},[93,1786,1787],{"class":232},"case",[93,1789,1276],{"class":103},[93,1791,1226],{"class":250},[93,1793,1319],{"class":1213},[93,1795,1322],{"class":107},[93,1797,1325],{"class":1213},[93,1799,1284],{"class":250},[93,1801,1319],{"class":1213},[93,1803,1332],{"class":107},[93,1805,1335],{"class":103},[93,1807,1808,1811,1813,1816],{"class":95,"line":247},[93,1809,1810],{"class":99},"   header",[93,1812,104],{"class":103},[93,1814,1815],{"class":107},"'Content-Type: application/json'",[93,1817,111],{"class":103},[93,1819,1820,1823,1826,1828,1831,1833,1837],{"class":95,"line":267},[93,1821,1822],{"class":99},"   echo",[93,1824,1825],{"class":99}," json_encode",[93,1827,104],{"class":103},[93,1829,1830],{"class":250},"$users",[93,1832,1403],{"class":103},[93,1834,1836],{"class":1835},"sxymB"," JSON_PRETTY_PRINT",[93,1838,111],{"class":103},[93,1840,1841,1844],{"class":95,"line":356},[93,1842,1843],{"class":232},"   break",[93,1845,1343],{"class":103},[20,1847,1848],{},[52,1849],{"alt":89,"src":1850},"https://static.031130.xyz/uploads/2024/08/12/6577fcdf64a96.webp",[33,1852,1853],{"id":1853},"获取单个用户",[84,1855,1857],{"className":86,"code":1856,"language":88,"meta":89,"style":89},"case ($method == 'GET' && preg_match('/\\/api\\/users\\/[1-9]/', $uri)):\n   header('Content-Type: application/json');\n   // get the id\n   $id = basename($uri);\n   if (!array_key_exists($id, $users)) {\n       http_response_code(404);\n       echo json_encode(['error' => 'user does not exist']);\n       break;\n   }\n   $responseData = [$id => $users[$id]];\n   echo json_encode($responseData, JSON_PRETTY_PRINT);\n   break;\n",[45,1858,1859,1897,1907,1912,1928,1954,1966,1988,1994,1999,2022,2039],{"__ignoreMap":89},[93,1860,1861,1863,1865,1867,1869,1871,1873,1875,1877,1879,1881,1883,1885,1887,1889,1891,1893,1895],{"class":95,"line":96},[93,1862,1787],{"class":232},[93,1864,1276],{"class":103},[93,1866,1226],{"class":250},[93,1868,1319],{"class":1213},[93,1870,1322],{"class":107},[93,1872,1325],{"class":1213},[93,1874,1378],{"class":99},[93,1876,104],{"class":103},[93,1878,1384],{"class":1383},[93,1880,1387],{"class":99},[93,1882,1390],{"class":1383},[93,1884,1387],{"class":99},[93,1886,1395],{"class":1383},[93,1888,1387],{"class":99},[93,1890,1400],{"class":1383},[93,1892,1403],{"class":103},[93,1894,1284],{"class":250},[93,1896,1408],{"class":103},[93,1898,1899,1901,1903,1905],{"class":95,"line":247},[93,1900,1810],{"class":99},[93,1902,104],{"class":103},[93,1904,1815],{"class":107},[93,1906,111],{"class":103},[93,1908,1909],{"class":95,"line":267},[93,1910,1911],{"class":426},"   // get the id\n",[93,1913,1914,1917,1919,1922,1924,1926],{"class":95,"line":356},[93,1915,1916],{"class":250},"   $id",[93,1918,308],{"class":1213},[93,1920,1921],{"class":99}," basename",[93,1923,104],{"class":103},[93,1925,1210],{"class":250},[93,1927,111],{"class":103},[93,1929,1930,1933,1935,1938,1941,1943,1946,1948,1951],{"class":95,"line":3},[93,1931,1932],{"class":232},"   if",[93,1934,1276],{"class":103},[93,1936,1937],{"class":1213},"!",[93,1939,1940],{"class":99},"array_key_exists",[93,1942,104],{"class":103},[93,1944,1945],{"class":250},"$id",[93,1947,1403],{"class":103},[93,1949,1950],{"class":250}," $users",[93,1952,1953],{"class":103},")) {\n",[93,1955,1956,1959,1961,1964],{"class":95,"line":383},[93,1957,1958],{"class":99},"       http_response_code",[93,1960,104],{"class":103},[93,1962,1963],{"class":439},"404",[93,1965,111],{"class":103},[93,1967,1968,1971,1973,1976,1979,1982,1985],{"class":95,"line":393},[93,1969,1970],{"class":99},"       echo",[93,1972,1825],{"class":99},[93,1974,1975],{"class":103},"([",[93,1977,1978],{"class":107},"'error'",[93,1980,1981],{"class":103}," =>",[93,1983,1984],{"class":107}," 'user does not exist'",[93,1986,1987],{"class":103},"]);\n",[93,1989,1990,1992],{"class":95,"line":403},[93,1991,1340],{"class":232},[93,1993,1343],{"class":103},[93,1995,1996],{"class":95,"line":413},[93,1997,1998],{"class":103},"   }\n",[93,2000,2001,2004,2006,2008,2010,2013,2015,2017,2019],{"class":95,"line":430},[93,2002,2003],{"class":250},"   $responseData",[93,2005,308],{"class":1213},[93,2007,258],{"class":103},[93,2009,1945],{"class":250},[93,2011,2012],{"class":103}," => ",[93,2014,1830],{"class":250},[93,2016,1094],{"class":103},[93,2018,1945],{"class":250},[93,2020,2021],{"class":103},"]];\n",[93,2023,2024,2026,2028,2030,2033,2035,2037],{"class":95,"line":446},[93,2025,1822],{"class":99},[93,2027,1825],{"class":99},[93,2029,104],{"class":103},[93,2031,2032],{"class":250},"$responseData",[93,2034,1403],{"class":103},[93,2036,1836],{"class":1835},[93,2038,111],{"class":103},[93,2040,2041,2043],{"class":95,"line":459},[93,2042,1843],{"class":232},[93,2044,1343],{"class":103},[20,2046,2047,2051],{},[2048,2049,2050],"strong",{},"basename","($uri) 会将 uri 的最后一部分给我。比如一个 api/users/10 这样的路径，它会返回 10.",[20,2053,2054,2055,2057],{},"然后我使用 ",[2048,2056,1940],{}," 检查是否存在一个 id 为 10 的用户",[20,2059,2060],{},[52,2061],{"alt":89,"src":2062},"https://static.031130.xyz/uploads/2024/08/12/6577fd77c3d06.webp",[33,2064,2065],{"id":2065},"添加一个新用户",[84,2067,2069],{"className":86,"code":2068,"language":88,"meta":89,"style":89},"case ($method == 'POST' && $uri == '/api/users'):\n   header('Content-Type: application/json');\n   $requestBody = json_decode(file_get_contents('php://input'), true);\n   $name = $requestBody['name'];\n   if (empty($name)) {\n       http_response_code(404);\n       echo json_encode(['error' => 'Please add name of the user']);\n   }\n   $users[] = $name;\n   $data = json_encode($users, JSON_PRETTY_PRINT);\n   file_put_contents($jsonFile, $data);\n   echo json_encode(['message' => 'user added successfully']);\n   break;\n",[45,2070,2071,2093,2103,2130,2147,2163,2173,2190,2194,2210,2229,2244,2262],{"__ignoreMap":89},[93,2072,2073,2075,2077,2079,2081,2083,2085,2087,2089,2091],{"class":95,"line":96},[93,2074,1787],{"class":232},[93,2076,1276],{"class":103},[93,2078,1226],{"class":250},[93,2080,1319],{"class":1213},[93,2082,1446],{"class":107},[93,2084,1325],{"class":1213},[93,2086,1284],{"class":250},[93,2088,1319],{"class":1213},[93,2090,1332],{"class":107},[93,2092,1335],{"class":103},[93,2094,2095,2097,2099,2101],{"class":95,"line":247},[93,2096,1810],{"class":99},[93,2098,104],{"class":103},[93,2100,1815],{"class":107},[93,2102,111],{"class":103},[93,2104,2105,2108,2110,2113,2115,2117,2119,2122,2125,2128],{"class":95,"line":267},[93,2106,2107],{"class":250},"   $requestBody",[93,2109,308],{"class":1213},[93,2111,2112],{"class":99}," json_decode",[93,2114,104],{"class":103},[93,2116,1737],{"class":99},[93,2118,104],{"class":103},[93,2120,2121],{"class":107},"'php://input'",[93,2123,2124],{"class":103},"),",[93,2126,2127],{"class":439}," true",[93,2129,111],{"class":103},[93,2131,2132,2135,2137,2140,2142,2145],{"class":95,"line":356},[93,2133,2134],{"class":250},"   $name",[93,2136,308],{"class":1213},[93,2138,2139],{"class":250}," $requestBody",[93,2141,1094],{"class":103},[93,2143,2144],{"class":107},"'name'",[93,2146,1100],{"class":103},[93,2148,2149,2151,2153,2156,2158,2161],{"class":95,"line":3},[93,2150,1932],{"class":232},[93,2152,1276],{"class":103},[93,2154,2155],{"class":99},"empty",[93,2157,104],{"class":103},[93,2159,2160],{"class":250},"$name",[93,2162,1953],{"class":103},[93,2164,2165,2167,2169,2171],{"class":95,"line":383},[93,2166,1958],{"class":99},[93,2168,104],{"class":103},[93,2170,1963],{"class":439},[93,2172,111],{"class":103},[93,2174,2175,2177,2179,2181,2183,2185,2188],{"class":95,"line":393},[93,2176,1970],{"class":99},[93,2178,1825],{"class":99},[93,2180,1975],{"class":103},[93,2182,1978],{"class":107},[93,2184,1981],{"class":103},[93,2186,2187],{"class":107}," 'Please add name of the user'",[93,2189,1987],{"class":103},[93,2191,2192],{"class":95,"line":403},[93,2193,1998],{"class":103},[93,2195,2196,2199,2202,2205,2208],{"class":95,"line":413},[93,2197,2198],{"class":250},"   $users",[93,2200,2201],{"class":103},"[] ",[93,2203,2204],{"class":1213},"=",[93,2206,2207],{"class":250}," $name",[93,2209,1343],{"class":103},[93,2211,2212,2215,2217,2219,2221,2223,2225,2227],{"class":95,"line":430},[93,2213,2214],{"class":250},"   $data",[93,2216,308],{"class":1213},[93,2218,1825],{"class":99},[93,2220,104],{"class":103},[93,2222,1830],{"class":250},[93,2224,1403],{"class":103},[93,2226,1836],{"class":1835},[93,2228,111],{"class":103},[93,2230,2231,2234,2236,2238,2240,2242],{"class":95,"line":446},[93,2232,2233],{"class":99},"   file_put_contents",[93,2235,104],{"class":103},[93,2237,1742],{"class":250},[93,2239,1403],{"class":103},[93,2241,1766],{"class":250},[93,2243,111],{"class":103},[93,2245,2246,2248,2250,2252,2255,2257,2260],{"class":95,"line":459},[93,2247,1822],{"class":99},[93,2249,1825],{"class":99},[93,2251,1975],{"class":103},[93,2253,2254],{"class":107},"'message'",[93,2256,1981],{"class":103},[93,2258,2259],{"class":107}," 'user added successfully'",[93,2261,1987],{"class":103},[93,2263,2264,2266],{"class":95,"line":465},[93,2265,1843],{"class":232},[93,2267,1343],{"class":103},[20,2269,2270,2271,2274],{},"我使用 ",[2048,2272,2273],{},"file_get_contents('php://input')"," 以获取请求的 body 部分。由于在这个例子中我使用的是 json，我将会解码 json 以便我可以获取到名字。",[20,2276,2277],{},[52,2278],{"alt":89,"src":2279},"https://static.031130.xyz/uploads/2024/08/12/6577fdca88f76.webp",[33,2281,2282],{"id":2282},"更新一个用户",[84,2284,2286],{"className":86,"code":2285,"language":88,"meta":89,"style":89},"case ($method == 'PUT' && preg_match('/\\/api\\/users\\/[1-9]/', $uri)):\n   header('Content-Type: application/json');\n   // get the id\n   $id = basename($uri);\n   if (!array_key_exists($id, $users)) {\n       http_response_code(404);\n       echo json_encode(['error' => 'user does not exist']);\n       break;\n   }\n   $requestBody = json_decode(file_get_contents('php://input'), true);\n   $name = $requestBody['name'];\n   if (empty($name)) {\n       http_response_code(404);\n       echo json_encode(['error' => 'Please add name of the user']);\n   }\n   $users[$id] = $name;\n   $data = json_encode($users, JSON_PRETTY_PRINT);\n   file_put_contents($jsonFile, $data);\n   echo json_encode(['message' => 'user updated successfully']);\n   break;\n",[45,2287,2288,2326,2336,2340,2354,2374,2384,2400,2406,2410,2432,2446,2460,2470,2486,2490,2507,2525,2539,2556],{"__ignoreMap":89},[93,2289,2290,2292,2294,2296,2298,2300,2302,2304,2306,2308,2310,2312,2314,2316,2318,2320,2322,2324],{"class":95,"line":96},[93,2291,1787],{"class":232},[93,2293,1276],{"class":103},[93,2295,1226],{"class":250},[93,2297,1319],{"class":1213},[93,2299,1499],{"class":107},[93,2301,1325],{"class":1213},[93,2303,1378],{"class":99},[93,2305,104],{"class":103},[93,2307,1384],{"class":1383},[93,2309,1387],{"class":99},[93,2311,1390],{"class":1383},[93,2313,1387],{"class":99},[93,2315,1395],{"class":1383},[93,2317,1387],{"class":99},[93,2319,1400],{"class":1383},[93,2321,1403],{"class":103},[93,2323,1284],{"class":250},[93,2325,1408],{"class":103},[93,2327,2328,2330,2332,2334],{"class":95,"line":247},[93,2329,1810],{"class":99},[93,2331,104],{"class":103},[93,2333,1815],{"class":107},[93,2335,111],{"class":103},[93,2337,2338],{"class":95,"line":267},[93,2339,1911],{"class":426},[93,2341,2342,2344,2346,2348,2350,2352],{"class":95,"line":356},[93,2343,1916],{"class":250},[93,2345,308],{"class":1213},[93,2347,1921],{"class":99},[93,2349,104],{"class":103},[93,2351,1210],{"class":250},[93,2353,111],{"class":103},[93,2355,2356,2358,2360,2362,2364,2366,2368,2370,2372],{"class":95,"line":3},[93,2357,1932],{"class":232},[93,2359,1276],{"class":103},[93,2361,1937],{"class":1213},[93,2363,1940],{"class":99},[93,2365,104],{"class":103},[93,2367,1945],{"class":250},[93,2369,1403],{"class":103},[93,2371,1950],{"class":250},[93,2373,1953],{"class":103},[93,2375,2376,2378,2380,2382],{"class":95,"line":383},[93,2377,1958],{"class":99},[93,2379,104],{"class":103},[93,2381,1963],{"class":439},[93,2383,111],{"class":103},[93,2385,2386,2388,2390,2392,2394,2396,2398],{"class":95,"line":393},[93,2387,1970],{"class":99},[93,2389,1825],{"class":99},[93,2391,1975],{"class":103},[93,2393,1978],{"class":107},[93,2395,1981],{"class":103},[93,2397,1984],{"class":107},[93,2399,1987],{"class":103},[93,2401,2402,2404],{"class":95,"line":403},[93,2403,1340],{"class":232},[93,2405,1343],{"class":103},[93,2407,2408],{"class":95,"line":413},[93,2409,1998],{"class":103},[93,2411,2412,2414,2416,2418,2420,2422,2424,2426,2428,2430],{"class":95,"line":430},[93,2413,2107],{"class":250},[93,2415,308],{"class":1213},[93,2417,2112],{"class":99},[93,2419,104],{"class":103},[93,2421,1737],{"class":99},[93,2423,104],{"class":103},[93,2425,2121],{"class":107},[93,2427,2124],{"class":103},[93,2429,2127],{"class":439},[93,2431,111],{"class":103},[93,2433,2434,2436,2438,2440,2442,2444],{"class":95,"line":446},[93,2435,2134],{"class":250},[93,2437,308],{"class":1213},[93,2439,2139],{"class":250},[93,2441,1094],{"class":103},[93,2443,2144],{"class":107},[93,2445,1100],{"class":103},[93,2447,2448,2450,2452,2454,2456,2458],{"class":95,"line":459},[93,2449,1932],{"class":232},[93,2451,1276],{"class":103},[93,2453,2155],{"class":99},[93,2455,104],{"class":103},[93,2457,2160],{"class":250},[93,2459,1953],{"class":103},[93,2461,2462,2464,2466,2468],{"class":95,"line":465},[93,2463,1958],{"class":99},[93,2465,104],{"class":103},[93,2467,1963],{"class":439},[93,2469,111],{"class":103},[93,2471,2472,2474,2476,2478,2480,2482,2484],{"class":95,"line":471},[93,2473,1970],{"class":99},[93,2475,1825],{"class":99},[93,2477,1975],{"class":103},[93,2479,1978],{"class":107},[93,2481,1981],{"class":103},[93,2483,2187],{"class":107},[93,2485,1987],{"class":103},[93,2487,2488],{"class":95,"line":477},[93,2489,1998],{"class":103},[93,2491,2492,2494,2496,2498,2501,2503,2505],{"class":95,"line":483},[93,2493,2198],{"class":250},[93,2495,1094],{"class":103},[93,2497,1945],{"class":250},[93,2499,2500],{"class":103},"] ",[93,2502,2204],{"class":1213},[93,2504,2207],{"class":250},[93,2506,1343],{"class":103},[93,2508,2509,2511,2513,2515,2517,2519,2521,2523],{"class":95,"line":499},[93,2510,2214],{"class":250},[93,2512,308],{"class":1213},[93,2514,1825],{"class":99},[93,2516,104],{"class":103},[93,2518,1830],{"class":250},[93,2520,1403],{"class":103},[93,2522,1836],{"class":1835},[93,2524,111],{"class":103},[93,2526,2527,2529,2531,2533,2535,2537],{"class":95,"line":1435},[93,2528,2233],{"class":99},[93,2530,104],{"class":103},[93,2532,1742],{"class":250},[93,2534,1403],{"class":103},[93,2536,1766],{"class":250},[93,2538,111],{"class":103},[93,2540,2541,2543,2545,2547,2549,2551,2554],{"class":95,"line":1459},[93,2542,1822],{"class":99},[93,2544,1825],{"class":99},[93,2546,1975],{"class":103},[93,2548,2254],{"class":107},[93,2550,1981],{"class":103},[93,2552,2553],{"class":107}," 'user updated successfully'",[93,2555,1987],{"class":103},[93,2557,2558,2560],{"class":95,"line":1466},[93,2559,1843],{"class":232},[93,2561,1343],{"class":103},[20,2563,2564],{},[52,2565],{"alt":89,"src":2566},"https://static.031130.xyz/uploads/2024/08/12/6577fdf646402.webp",[33,2568,2569],{"id":2569},"删除一个用户",[84,2571,2573],{"className":86,"code":2572,"language":88,"meta":89,"style":89},"case ($method == 'DELETE' && preg_match('/\\/api\\/users\\/[1-9]/', $uri)):\n   header('Content-Type: application/json');\n   // get the id\n   $id = basename($uri);\n   if (empty($users[$id])) {\n       http_response_code(404);\n       echo json_encode(['error' => 'user does not exist']);\n       break;\n   }\n   unset($users[$id]);\n   $data = json_encode($users, JSON_PRETTY_PRINT);\n   file_put_contents($jsonFile, $data);\n   echo json_encode(['message' => 'user deleted successfully']);\n   break;\n",[45,2574,2575,2617,2627,2631,2645,2664,2674,2690,2696,2700,2715,2733,2747,2764],{"__ignoreMap":89},[93,2576,2577,2579,2581,2583,2585,2587,2589,2591,2593,2595,2597,2599,2601,2603,2605,2607,2609,2611,2613,2615],{"class":95,"line":96},[93,2578,1787],{"class":232},[93,2580,1276],{"class":103},[93,2582,1226],{"class":250},[93,2584,1319],{"class":1213},[93,2586,1568],{"class":107},[93,2588,1571],{"class":232},[93,2590,1574],{"class":107},[93,2592,1325],{"class":1213},[93,2594,1378],{"class":99},[93,2596,104],{"class":103},[93,2598,1384],{"class":1383},[93,2600,1387],{"class":99},[93,2602,1390],{"class":1383},[93,2604,1387],{"class":99},[93,2606,1395],{"class":1383},[93,2608,1387],{"class":99},[93,2610,1400],{"class":1383},[93,2612,1403],{"class":103},[93,2614,1284],{"class":250},[93,2616,1408],{"class":103},[93,2618,2619,2621,2623,2625],{"class":95,"line":247},[93,2620,1810],{"class":99},[93,2622,104],{"class":103},[93,2624,1815],{"class":107},[93,2626,111],{"class":103},[93,2628,2629],{"class":95,"line":267},[93,2630,1911],{"class":426},[93,2632,2633,2635,2637,2639,2641,2643],{"class":95,"line":356},[93,2634,1916],{"class":250},[93,2636,308],{"class":1213},[93,2638,1921],{"class":99},[93,2640,104],{"class":103},[93,2642,1210],{"class":250},[93,2644,111],{"class":103},[93,2646,2647,2649,2651,2653,2655,2657,2659,2661],{"class":95,"line":3},[93,2648,1932],{"class":232},[93,2650,1276],{"class":103},[93,2652,2155],{"class":99},[93,2654,104],{"class":103},[93,2656,1830],{"class":250},[93,2658,1094],{"class":103},[93,2660,1945],{"class":250},[93,2662,2663],{"class":103},"])) {\n",[93,2665,2666,2668,2670,2672],{"class":95,"line":383},[93,2667,1958],{"class":99},[93,2669,104],{"class":103},[93,2671,1963],{"class":439},[93,2673,111],{"class":103},[93,2675,2676,2678,2680,2682,2684,2686,2688],{"class":95,"line":393},[93,2677,1970],{"class":99},[93,2679,1825],{"class":99},[93,2681,1975],{"class":103},[93,2683,1978],{"class":107},[93,2685,1981],{"class":103},[93,2687,1984],{"class":107},[93,2689,1987],{"class":103},[93,2691,2692,2694],{"class":95,"line":403},[93,2693,1340],{"class":232},[93,2695,1343],{"class":103},[93,2697,2698],{"class":95,"line":413},[93,2699,1998],{"class":103},[93,2701,2702,2705,2707,2709,2711,2713],{"class":95,"line":430},[93,2703,2704],{"class":99},"   unset",[93,2706,104],{"class":103},[93,2708,1830],{"class":250},[93,2710,1094],{"class":103},[93,2712,1945],{"class":250},[93,2714,1987],{"class":103},[93,2716,2717,2719,2721,2723,2725,2727,2729,2731],{"class":95,"line":446},[93,2718,2214],{"class":250},[93,2720,308],{"class":1213},[93,2722,1825],{"class":99},[93,2724,104],{"class":103},[93,2726,1830],{"class":250},[93,2728,1403],{"class":103},[93,2730,1836],{"class":1835},[93,2732,111],{"class":103},[93,2734,2735,2737,2739,2741,2743,2745],{"class":95,"line":459},[93,2736,2233],{"class":99},[93,2738,104],{"class":103},[93,2740,1742],{"class":250},[93,2742,1403],{"class":103},[93,2744,1766],{"class":250},[93,2746,111],{"class":103},[93,2748,2749,2751,2753,2755,2757,2759,2762],{"class":95,"line":465},[93,2750,1822],{"class":99},[93,2752,1825],{"class":99},[93,2754,1975],{"class":103},[93,2756,2254],{"class":107},[93,2758,1981],{"class":103},[93,2760,2761],{"class":107}," 'user deleted successfully'",[93,2763,1987],{"class":103},[93,2765,2766,2768],{"class":95,"line":471},[93,2767,1843],{"class":232},[93,2769,1343],{"class":103},[20,2771,2772],{},[52,2773],{"alt":89,"src":2774},"https://static.031130.xyz/uploads/2024/08/12/6577fe0c3a95b.webp",[33,2776,2777],{"id":2777},"最终文件",[20,2779,2780],{},"现在我们的 index.php 文件看起来是这样的",[20,2782,2783],{},"在 70 行左右的代码中，我们使用 PHP 创建了一个 RESTful API，很神奇吧？",[84,2785,2787],{"className":86,"code":2786,"language":88,"meta":89,"style":89},"\u003C?php\n$jsonFile = 'users.json';\n$data = file_get_contents($jsonFile);\n$users = json_decode($data, true);\n$uri = $_SERVER['REQUEST_URI'];\n$method = $_SERVER['REQUEST_METHOD'];\nswitch ($method | $uri) {\n   case ($method == 'GET' && $uri == '/api/users'):\n       header('Content-Type: application/json');\n       echo json_encode($users, JSON_PRETTY_PRINT);\n       break;\n   case ($method == 'GET' && preg_match('/\\/api\\/users\\/[1-9]/', $uri)):\n       header('Content-Type: application/json');\n       $id = basename($uri);\n       if (!array_key_exists($id, $users)) {\n           http_response_code(404);\n           echo json_encode(['error' => 'user does not exist']);\n           break;\n       }\n       $responseData = [$id => $users[$id]];\n       echo json_encode($responseData, JSON_PRETTY_PRINT);\n       break;\n   case ($method == 'POST' && $uri == '/api/users'):\n       header('Content-Type: application/json');\n       $requestBody = json_decode(file_get_contents('php://input'), true);\n       $name = $requestBody['name'];\n       if (empty($name)) {\n           http_response_code(404);\n           echo json_encode(['error' => 'Please add name of the user']);\n       }\n       $users[] = $name;\n       $data = json_encode($users, JSON_PRETTY_PRINT);\n       file_put_contents($jsonFile, $data);\n       echo json_encode(['message' => 'user added successfully']);\n       break;\n   case ($method == 'PUT' && preg_match('/\\/api\\/users\\/[1-9]/', $uri)):\n       header('Content-Type: application/json');\n       $id = basename($uri);\n       if (!array_key_exists($id, $users)) {\n           http_response_code(404);\n           echo json_encode(['error' => 'user does not exist']);\n           break;\n       }\n       $requestBody = json_decode(file_get_contents('php://input'), true);\n       $name = $requestBody['name'];\n       if (empty($name)) {\n           http_response_code(404);\n           echo json_encode(['error' => 'Please add name of the user']);\n       }\n       $users[$id] = $name;\n       $data = json_encode($users, JSON_PRETTY_PRINT);\n       file_put_contents($jsonFile, $data);\n       echo json_encode(['message' => 'user updated successfully']);\n       break;\n   case ($method == 'DELETE' && preg_match('/\\/api\\/users\\/[1-9]/', $uri)):\n       header('Content-Type: application/json');\n       $id = basename($uri);\n       if (empty($users[$id])) {\n           http_response_code(404);\n           echo json_encode(['error' => 'user does not exist']);\n           break;\n       }\n       unset($users[$id]);\n       $data = json_encode($users, JSON_PRETTY_PRINT);\n       file_put_contents($jsonFile, $data);\n       echo json_encode(['message' => 'user deleted successfully']);\n       break;\n   default:\n       http_response_code(404);\n       echo json_encode(['error' => \"We cannot find what you're looking for.\"]);\n       break;\n}\n",[45,2788,2789,2801,2812,2828,2846,2860,2874,2888,2910,2921,2937,2943,2981,2991,3006,3027,3038,3055,3062,3067,3088,3104,3110,3132,3142,3165,3180,3194,3204,3220,3224,3237,3256,3271,3287,3293,3331,3341,3355,3375,3386,3403,3410,3415,3438,3453,3468,3479,3496,3501,3518,3537,3552,3569,3576,3619,3630,3645,3664,3675,3692,3699,3704,3720,3739,3754,3771,3778,3785,3796,3814,3821],{"__ignoreMap":89},[93,2790,2791,2794,2798],{"class":95,"line":96},[93,2792,2793],{"class":1213},"\u003C",[93,2795,2797],{"class":2796},"sblXP","?",[93,2799,2800],{"class":1835},"php\n",[93,2802,2803,2805,2807,2810],{"class":95,"line":247},[93,2804,1742],{"class":250},[93,2806,308],{"class":1213},[93,2808,2809],{"class":107}," 'users.json'",[93,2811,1343],{"class":103},[93,2813,2814,2817,2819,2822,2824,2826],{"class":95,"line":267},[93,2815,2816],{"class":250},"$data",[93,2818,308],{"class":1213},[93,2820,2821],{"class":99}," file_get_contents",[93,2823,104],{"class":103},[93,2825,1742],{"class":250},[93,2827,111],{"class":103},[93,2829,2830,2832,2834,2836,2838,2840,2842,2844],{"class":95,"line":356},[93,2831,1830],{"class":250},[93,2833,308],{"class":1213},[93,2835,2112],{"class":99},[93,2837,104],{"class":103},[93,2839,2816],{"class":250},[93,2841,1403],{"class":103},[93,2843,2127],{"class":439},[93,2845,111],{"class":103},[93,2847,2848,2850,2852,2854,2856,2858],{"class":95,"line":3},[93,2849,1210],{"class":250},[93,2851,308],{"class":1213},[93,2853,1091],{"class":250},[93,2855,1094],{"class":103},[93,2857,1097],{"class":107},[93,2859,1100],{"class":103},[93,2861,2862,2864,2866,2868,2870,2872],{"class":95,"line":383},[93,2863,1226],{"class":250},[93,2865,308],{"class":1213},[93,2867,1091],{"class":250},[93,2869,1094],{"class":103},[93,2871,1194],{"class":107},[93,2873,1100],{"class":103},[93,2875,2876,2878,2880,2882,2884,2886],{"class":95,"line":393},[93,2877,1273],{"class":232},[93,2879,1276],{"class":103},[93,2881,1226],{"class":250},[93,2883,1281],{"class":1213},[93,2885,1284],{"class":250},[93,2887,1287],{"class":103},[93,2889,2890,2892,2894,2896,2898,2900,2902,2904,2906,2908],{"class":95,"line":403},[93,2891,1312],{"class":232},[93,2893,1276],{"class":103},[93,2895,1226],{"class":250},[93,2897,1319],{"class":1213},[93,2899,1322],{"class":107},[93,2901,1325],{"class":1213},[93,2903,1284],{"class":250},[93,2905,1319],{"class":1213},[93,2907,1332],{"class":107},[93,2909,1335],{"class":103},[93,2911,2912,2915,2917,2919],{"class":95,"line":413},[93,2913,2914],{"class":99},"       header",[93,2916,104],{"class":103},[93,2918,1815],{"class":107},[93,2920,111],{"class":103},[93,2922,2923,2925,2927,2929,2931,2933,2935],{"class":95,"line":430},[93,2924,1970],{"class":99},[93,2926,1825],{"class":99},[93,2928,104],{"class":103},[93,2930,1830],{"class":250},[93,2932,1403],{"class":103},[93,2934,1836],{"class":1835},[93,2936,111],{"class":103},[93,2938,2939,2941],{"class":95,"line":446},[93,2940,1340],{"class":232},[93,2942,1343],{"class":103},[93,2944,2945,2947,2949,2951,2953,2955,2957,2959,2961,2963,2965,2967,2969,2971,2973,2975,2977,2979],{"class":95,"line":459},[93,2946,1312],{"class":232},[93,2948,1276],{"class":103},[93,2950,1226],{"class":250},[93,2952,1319],{"class":1213},[93,2954,1322],{"class":107},[93,2956,1325],{"class":1213},[93,2958,1378],{"class":99},[93,2960,104],{"class":103},[93,2962,1384],{"class":1383},[93,2964,1387],{"class":99},[93,2966,1390],{"class":1383},[93,2968,1387],{"class":99},[93,2970,1395],{"class":1383},[93,2972,1387],{"class":99},[93,2974,1400],{"class":1383},[93,2976,1403],{"class":103},[93,2978,1284],{"class":250},[93,2980,1408],{"class":103},[93,2982,2983,2985,2987,2989],{"class":95,"line":465},[93,2984,2914],{"class":99},[93,2986,104],{"class":103},[93,2988,1815],{"class":107},[93,2990,111],{"class":103},[93,2992,2993,2996,2998,3000,3002,3004],{"class":95,"line":471},[93,2994,2995],{"class":250},"       $id",[93,2997,308],{"class":1213},[93,2999,1921],{"class":99},[93,3001,104],{"class":103},[93,3003,1210],{"class":250},[93,3005,111],{"class":103},[93,3007,3008,3011,3013,3015,3017,3019,3021,3023,3025],{"class":95,"line":477},[93,3009,3010],{"class":232},"       if",[93,3012,1276],{"class":103},[93,3014,1937],{"class":1213},[93,3016,1940],{"class":99},[93,3018,104],{"class":103},[93,3020,1945],{"class":250},[93,3022,1403],{"class":103},[93,3024,1950],{"class":250},[93,3026,1953],{"class":103},[93,3028,3029,3032,3034,3036],{"class":95,"line":483},[93,3030,3031],{"class":99},"           http_response_code",[93,3033,104],{"class":103},[93,3035,1963],{"class":439},[93,3037,111],{"class":103},[93,3039,3040,3043,3045,3047,3049,3051,3053],{"class":95,"line":499},[93,3041,3042],{"class":99},"           echo",[93,3044,1825],{"class":99},[93,3046,1975],{"class":103},[93,3048,1978],{"class":107},[93,3050,1981],{"class":103},[93,3052,1984],{"class":107},[93,3054,1987],{"class":103},[93,3056,3057,3060],{"class":95,"line":1435},[93,3058,3059],{"class":232},"           break",[93,3061,1343],{"class":103},[93,3063,3064],{"class":95,"line":1459},[93,3065,3066],{"class":103},"       }\n",[93,3068,3069,3072,3074,3076,3078,3080,3082,3084,3086],{"class":95,"line":1466},[93,3070,3071],{"class":250},"       $responseData",[93,3073,308],{"class":1213},[93,3075,258],{"class":103},[93,3077,1945],{"class":250},[93,3079,2012],{"class":103},[93,3081,1830],{"class":250},[93,3083,1094],{"class":103},[93,3085,1945],{"class":250},[93,3087,2021],{"class":103},[93,3089,3090,3092,3094,3096,3098,3100,3102],{"class":95,"line":1471},[93,3091,1970],{"class":99},[93,3093,1825],{"class":99},[93,3095,104],{"class":103},[93,3097,2032],{"class":250},[93,3099,1403],{"class":103},[93,3101,1836],{"class":1835},[93,3103,111],{"class":103},[93,3105,3106,3108],{"class":95,"line":1477},[93,3107,1340],{"class":232},[93,3109,1343],{"class":103},[93,3111,3112,3114,3116,3118,3120,3122,3124,3126,3128,3130],{"class":95,"line":1483},[93,3113,1312],{"class":232},[93,3115,1276],{"class":103},[93,3117,1226],{"class":250},[93,3119,1319],{"class":1213},[93,3121,1446],{"class":107},[93,3123,1325],{"class":1213},[93,3125,1284],{"class":250},[93,3127,1319],{"class":1213},[93,3129,1332],{"class":107},[93,3131,1335],{"class":103},[93,3133,3134,3136,3138,3140],{"class":95,"line":1488},[93,3135,2914],{"class":99},[93,3137,104],{"class":103},[93,3139,1815],{"class":107},[93,3141,111],{"class":103},[93,3143,3144,3147,3149,3151,3153,3155,3157,3159,3161,3163],{"class":95,"line":1528},[93,3145,3146],{"class":250},"       $requestBody",[93,3148,308],{"class":1213},[93,3150,2112],{"class":99},[93,3152,104],{"class":103},[93,3154,1737],{"class":99},[93,3156,104],{"class":103},[93,3158,2121],{"class":107},[93,3160,2124],{"class":103},[93,3162,2127],{"class":439},[93,3164,111],{"class":103},[93,3166,3167,3170,3172,3174,3176,3178],{"class":95,"line":1535},[93,3168,3169],{"class":250},"       $name",[93,3171,308],{"class":1213},[93,3173,2139],{"class":250},[93,3175,1094],{"class":103},[93,3177,2144],{"class":107},[93,3179,1100],{"class":103},[93,3181,3182,3184,3186,3188,3190,3192],{"class":95,"line":1540},[93,3183,3010],{"class":232},[93,3185,1276],{"class":103},[93,3187,2155],{"class":99},[93,3189,104],{"class":103},[93,3191,2160],{"class":250},[93,3193,1953],{"class":103},[93,3195,3196,3198,3200,3202],{"class":95,"line":1546},[93,3197,3031],{"class":99},[93,3199,104],{"class":103},[93,3201,1963],{"class":439},[93,3203,111],{"class":103},[93,3205,3206,3208,3210,3212,3214,3216,3218],{"class":95,"line":1552},[93,3207,3042],{"class":99},[93,3209,1825],{"class":99},[93,3211,1975],{"class":103},[93,3213,1978],{"class":107},[93,3215,1981],{"class":103},[93,3217,2187],{"class":107},[93,3219,1987],{"class":103},[93,3221,3222],{"class":95,"line":1557},[93,3223,3066],{"class":103},[93,3225,3226,3229,3231,3233,3235],{"class":95,"line":1603},[93,3227,3228],{"class":250},"       $users",[93,3230,2201],{"class":103},[93,3232,2204],{"class":1213},[93,3234,2207],{"class":250},[93,3236,1343],{"class":103},[93,3238,3239,3242,3244,3246,3248,3250,3252,3254],{"class":95,"line":1610},[93,3240,3241],{"class":250},"       $data",[93,3243,308],{"class":1213},[93,3245,1825],{"class":99},[93,3247,104],{"class":103},[93,3249,1830],{"class":250},[93,3251,1403],{"class":103},[93,3253,1836],{"class":1835},[93,3255,111],{"class":103},[93,3257,3258,3261,3263,3265,3267,3269],{"class":95,"line":1615},[93,3259,3260],{"class":99},"       file_put_contents",[93,3262,104],{"class":103},[93,3264,1742],{"class":250},[93,3266,1403],{"class":103},[93,3268,1766],{"class":250},[93,3270,111],{"class":103},[93,3272,3273,3275,3277,3279,3281,3283,3285],{"class":95,"line":1621},[93,3274,1970],{"class":99},[93,3276,1825],{"class":99},[93,3278,1975],{"class":103},[93,3280,2254],{"class":107},[93,3282,1981],{"class":103},[93,3284,2259],{"class":107},[93,3286,1987],{"class":103},[93,3288,3289,3291],{"class":95,"line":1627},[93,3290,1340],{"class":232},[93,3292,1343],{"class":103},[93,3294,3295,3297,3299,3301,3303,3305,3307,3309,3311,3313,3315,3317,3319,3321,3323,3325,3327,3329],{"class":95,"line":1633},[93,3296,1312],{"class":232},[93,3298,1276],{"class":103},[93,3300,1226],{"class":250},[93,3302,1319],{"class":1213},[93,3304,1499],{"class":107},[93,3306,1325],{"class":1213},[93,3308,1378],{"class":99},[93,3310,104],{"class":103},[93,3312,1384],{"class":1383},[93,3314,1387],{"class":99},[93,3316,1390],{"class":1383},[93,3318,1387],{"class":99},[93,3320,1395],{"class":1383},[93,3322,1387],{"class":99},[93,3324,1400],{"class":1383},[93,3326,1403],{"class":103},[93,3328,1284],{"class":250},[93,3330,1408],{"class":103},[93,3332,3333,3335,3337,3339],{"class":95,"line":1638},[93,3334,2914],{"class":99},[93,3336,104],{"class":103},[93,3338,1815],{"class":107},[93,3340,111],{"class":103},[93,3342,3343,3345,3347,3349,3351,3353],{"class":95,"line":1647},[93,3344,2995],{"class":250},[93,3346,308],{"class":1213},[93,3348,1921],{"class":99},[93,3350,104],{"class":103},[93,3352,1210],{"class":250},[93,3354,111],{"class":103},[93,3356,3357,3359,3361,3363,3365,3367,3369,3371,3373],{"class":95,"line":1654},[93,3358,3010],{"class":232},[93,3360,1276],{"class":103},[93,3362,1937],{"class":1213},[93,3364,1940],{"class":99},[93,3366,104],{"class":103},[93,3368,1945],{"class":250},[93,3370,1403],{"class":103},[93,3372,1950],{"class":250},[93,3374,1953],{"class":103},[93,3376,3378,3380,3382,3384],{"class":95,"line":3377},40,[93,3379,3031],{"class":99},[93,3381,104],{"class":103},[93,3383,1963],{"class":439},[93,3385,111],{"class":103},[93,3387,3389,3391,3393,3395,3397,3399,3401],{"class":95,"line":3388},41,[93,3390,3042],{"class":99},[93,3392,1825],{"class":99},[93,3394,1975],{"class":103},[93,3396,1978],{"class":107},[93,3398,1981],{"class":103},[93,3400,1984],{"class":107},[93,3402,1987],{"class":103},[93,3404,3406,3408],{"class":95,"line":3405},42,[93,3407,3059],{"class":232},[93,3409,1343],{"class":103},[93,3411,3413],{"class":95,"line":3412},43,[93,3414,3066],{"class":103},[93,3416,3418,3420,3422,3424,3426,3428,3430,3432,3434,3436],{"class":95,"line":3417},44,[93,3419,3146],{"class":250},[93,3421,308],{"class":1213},[93,3423,2112],{"class":99},[93,3425,104],{"class":103},[93,3427,1737],{"class":99},[93,3429,104],{"class":103},[93,3431,2121],{"class":107},[93,3433,2124],{"class":103},[93,3435,2127],{"class":439},[93,3437,111],{"class":103},[93,3439,3441,3443,3445,3447,3449,3451],{"class":95,"line":3440},45,[93,3442,3169],{"class":250},[93,3444,308],{"class":1213},[93,3446,2139],{"class":250},[93,3448,1094],{"class":103},[93,3450,2144],{"class":107},[93,3452,1100],{"class":103},[93,3454,3456,3458,3460,3462,3464,3466],{"class":95,"line":3455},46,[93,3457,3010],{"class":232},[93,3459,1276],{"class":103},[93,3461,2155],{"class":99},[93,3463,104],{"class":103},[93,3465,2160],{"class":250},[93,3467,1953],{"class":103},[93,3469,3471,3473,3475,3477],{"class":95,"line":3470},47,[93,3472,3031],{"class":99},[93,3474,104],{"class":103},[93,3476,1963],{"class":439},[93,3478,111],{"class":103},[93,3480,3482,3484,3486,3488,3490,3492,3494],{"class":95,"line":3481},48,[93,3483,3042],{"class":99},[93,3485,1825],{"class":99},[93,3487,1975],{"class":103},[93,3489,1978],{"class":107},[93,3491,1981],{"class":103},[93,3493,2187],{"class":107},[93,3495,1987],{"class":103},[93,3497,3499],{"class":95,"line":3498},49,[93,3500,3066],{"class":103},[93,3502,3504,3506,3508,3510,3512,3514,3516],{"class":95,"line":3503},50,[93,3505,3228],{"class":250},[93,3507,1094],{"class":103},[93,3509,1945],{"class":250},[93,3511,2500],{"class":103},[93,3513,2204],{"class":1213},[93,3515,2207],{"class":250},[93,3517,1343],{"class":103},[93,3519,3521,3523,3525,3527,3529,3531,3533,3535],{"class":95,"line":3520},51,[93,3522,3241],{"class":250},[93,3524,308],{"class":1213},[93,3526,1825],{"class":99},[93,3528,104],{"class":103},[93,3530,1830],{"class":250},[93,3532,1403],{"class":103},[93,3534,1836],{"class":1835},[93,3536,111],{"class":103},[93,3538,3540,3542,3544,3546,3548,3550],{"class":95,"line":3539},52,[93,3541,3260],{"class":99},[93,3543,104],{"class":103},[93,3545,1742],{"class":250},[93,3547,1403],{"class":103},[93,3549,1766],{"class":250},[93,3551,111],{"class":103},[93,3553,3555,3557,3559,3561,3563,3565,3567],{"class":95,"line":3554},53,[93,3556,1970],{"class":99},[93,3558,1825],{"class":99},[93,3560,1975],{"class":103},[93,3562,2254],{"class":107},[93,3564,1981],{"class":103},[93,3566,2553],{"class":107},[93,3568,1987],{"class":103},[93,3570,3572,3574],{"class":95,"line":3571},54,[93,3573,1340],{"class":232},[93,3575,1343],{"class":103},[93,3577,3579,3581,3583,3585,3587,3589,3591,3593,3595,3597,3599,3601,3603,3605,3607,3609,3611,3613,3615,3617],{"class":95,"line":3578},55,[93,3580,1312],{"class":232},[93,3582,1276],{"class":103},[93,3584,1226],{"class":250},[93,3586,1319],{"class":1213},[93,3588,1568],{"class":107},[93,3590,1571],{"class":232},[93,3592,1574],{"class":107},[93,3594,1325],{"class":1213},[93,3596,1378],{"class":99},[93,3598,104],{"class":103},[93,3600,1384],{"class":1383},[93,3602,1387],{"class":99},[93,3604,1390],{"class":1383},[93,3606,1387],{"class":99},[93,3608,1395],{"class":1383},[93,3610,1387],{"class":99},[93,3612,1400],{"class":1383},[93,3614,1403],{"class":103},[93,3616,1284],{"class":250},[93,3618,1408],{"class":103},[93,3620,3622,3624,3626,3628],{"class":95,"line":3621},56,[93,3623,2914],{"class":99},[93,3625,104],{"class":103},[93,3627,1815],{"class":107},[93,3629,111],{"class":103},[93,3631,3633,3635,3637,3639,3641,3643],{"class":95,"line":3632},57,[93,3634,2995],{"class":250},[93,3636,308],{"class":1213},[93,3638,1921],{"class":99},[93,3640,104],{"class":103},[93,3642,1210],{"class":250},[93,3644,111],{"class":103},[93,3646,3648,3650,3652,3654,3656,3658,3660,3662],{"class":95,"line":3647},58,[93,3649,3010],{"class":232},[93,3651,1276],{"class":103},[93,3653,2155],{"class":99},[93,3655,104],{"class":103},[93,3657,1830],{"class":250},[93,3659,1094],{"class":103},[93,3661,1945],{"class":250},[93,3663,2663],{"class":103},[93,3665,3667,3669,3671,3673],{"class":95,"line":3666},59,[93,3668,3031],{"class":99},[93,3670,104],{"class":103},[93,3672,1963],{"class":439},[93,3674,111],{"class":103},[93,3676,3678,3680,3682,3684,3686,3688,3690],{"class":95,"line":3677},60,[93,3679,3042],{"class":99},[93,3681,1825],{"class":99},[93,3683,1975],{"class":103},[93,3685,1978],{"class":107},[93,3687,1981],{"class":103},[93,3689,1984],{"class":107},[93,3691,1987],{"class":103},[93,3693,3695,3697],{"class":95,"line":3694},61,[93,3696,3059],{"class":232},[93,3698,1343],{"class":103},[93,3700,3702],{"class":95,"line":3701},62,[93,3703,3066],{"class":103},[93,3705,3707,3710,3712,3714,3716,3718],{"class":95,"line":3706},63,[93,3708,3709],{"class":99},"       unset",[93,3711,104],{"class":103},[93,3713,1830],{"class":250},[93,3715,1094],{"class":103},[93,3717,1945],{"class":250},[93,3719,1987],{"class":103},[93,3721,3723,3725,3727,3729,3731,3733,3735,3737],{"class":95,"line":3722},64,[93,3724,3241],{"class":250},[93,3726,308],{"class":1213},[93,3728,1825],{"class":99},[93,3730,104],{"class":103},[93,3732,1830],{"class":250},[93,3734,1403],{"class":103},[93,3736,1836],{"class":1835},[93,3738,111],{"class":103},[93,3740,3742,3744,3746,3748,3750,3752],{"class":95,"line":3741},65,[93,3743,3260],{"class":99},[93,3745,104],{"class":103},[93,3747,1742],{"class":250},[93,3749,1403],{"class":103},[93,3751,1766],{"class":250},[93,3753,111],{"class":103},[93,3755,3757,3759,3761,3763,3765,3767,3769],{"class":95,"line":3756},66,[93,3758,1970],{"class":99},[93,3760,1825],{"class":99},[93,3762,1975],{"class":103},[93,3764,2254],{"class":107},[93,3766,1981],{"class":103},[93,3768,2761],{"class":107},[93,3770,1987],{"class":103},[93,3772,3774,3776],{"class":95,"line":3773},67,[93,3775,1340],{"class":232},[93,3777,1343],{"class":103},[93,3779,3781,3783],{"class":95,"line":3780},68,[93,3782,1641],{"class":232},[93,3784,1644],{"class":103},[93,3786,3788,3790,3792,3794],{"class":95,"line":3787},69,[93,3789,1958],{"class":99},[93,3791,104],{"class":103},[93,3793,1963],{"class":439},[93,3795,111],{"class":103},[93,3797,3799,3801,3803,3805,3807,3809,3812],{"class":95,"line":3798},70,[93,3800,1970],{"class":99},[93,3802,1825],{"class":99},[93,3804,1975],{"class":103},[93,3806,1978],{"class":107},[93,3808,1981],{"class":103},[93,3810,3811],{"class":107}," \"We cannot find what you're looking for.\"",[93,3813,1987],{"class":103},[93,3815,3817,3819],{"class":95,"line":3816},71,[93,3818,1340],{"class":232},[93,3820,1343],{"class":103},[93,3822,3824],{"class":95,"line":3823},72,[93,3825,1657],{"class":103},[33,3827,3828],{"id":3828},"额外内容",[20,3830,3831],{},"在这种情况下，我不希望删除我的所有用户，所以我加了一个新的语句，如果只剩下最后一个用户，它将不会被删除，像这样",[84,3833,3835],{"className":86,"code":3834,"language":88,"meta":89,"style":89},"if (sizeof($users) == 1){\n   http_response_code(404);\n   echo json_encode(['error' => 'there is only one user left. you cannot delete it!']);\n   break;\n}\n",[45,3836,3837,3863,3874,3891,3897],{"__ignoreMap":89},[93,3838,3839,3842,3844,3847,3849,3851,3854,3857,3860],{"class":95,"line":96},[93,3840,3841],{"class":232},"if",[93,3843,1276],{"class":103},[93,3845,3846],{"class":99},"sizeof",[93,3848,104],{"class":103},[93,3850,1830],{"class":250},[93,3852,3853],{"class":103},") ",[93,3855,3856],{"class":1213},"==",[93,3858,3859],{"class":439}," 1",[93,3861,3862],{"class":103},"){\n",[93,3864,3865,3868,3870,3872],{"class":95,"line":247},[93,3866,3867],{"class":99},"   http_response_code",[93,3869,104],{"class":103},[93,3871,1963],{"class":439},[93,3873,111],{"class":103},[93,3875,3876,3878,3880,3882,3884,3886,3889],{"class":95,"line":267},[93,3877,1822],{"class":99},[93,3879,1825],{"class":99},[93,3881,1975],{"class":103},[93,3883,1978],{"class":107},[93,3885,1981],{"class":103},[93,3887,3888],{"class":107}," 'there is only one user left. you cannot delete it!'",[93,3890,1987],{"class":103},[93,3892,3893,3895],{"class":95,"line":356},[93,3894,1843],{"class":232},[93,3896,1343],{"class":103},[93,3898,3899],{"class":95,"line":3},[93,3900,1657],{"class":103},[33,3902,3903],{"id":3903},"源码",[20,3905,3906,3907,3912],{},"你可以在",[24,3908,3911],{"href":3909,"rel":3910},"https://github.com/amirkamizi/php-simple-restful-api",[73],"原作者的 github"," 上看到完整注释的源代码以及 post man 集合",[33,3914,3915],{"id":3915},"总结",[20,3917,3918],{},"现在你知道如何在 PHP 中创建一个简单的 RESTful API。",[20,3920,3921],{},"我推荐你打开一个 PHP 文件并复习所有的这些我们进行的步骤，并且像本文一样添加一些额外的资源",[20,3923,3924],{},"如果你有任何的建议、问题或者观点，请联系文章原作者，他期待着听到你的声音。",[33,3926,3927],{"id":3927},"要点",[1244,3929,3930,3933,3936,3939,3942],{},[920,3931,3932],{},"不使用框架，用 PHP 创建一个 RESTful API",[920,3934,3935],{},"在 PHP 中使用优雅的 URL",[920,3937,3938],{},"处理请求的 body",[920,3940,3941],{},"使用 Json 文件作为你的数据库",[920,3943,3944],{},"使用多个变量作为 switch 的关键词",[530,3946,3947],{},"html .default .shiki span {color: var(--shiki-default);background: var(--shiki-default-bg);font-style: var(--shiki-default-font-style);font-weight: var(--shiki-default-font-weight);text-decoration: var(--shiki-default-text-decoration);}html .shiki span {color: var(--shiki-default);background: var(--shiki-default-bg);font-style: var(--shiki-default-font-style);font-weight: var(--shiki-default-font-weight);text-decoration: var(--shiki-default-text-decoration);}html .dark .shiki span {color: var(--shiki-dark);background: var(--shiki-dark-bg);font-style: var(--shiki-dark-font-style);font-weight: var(--shiki-dark-font-weight);text-decoration: var(--shiki-dark-text-decoration);}html.dark .shiki span {color: var(--shiki-dark);background: var(--shiki-dark-bg);font-style: var(--shiki-dark-font-style);font-weight: var(--shiki-dark-font-weight);text-decoration: var(--shiki-dark-text-decoration);}html pre.shiki code .sW2Sy, html code.shiki .sW2Sy{--shiki-default:#A0A1A7;--shiki-default-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic}html pre.shiki code .s_Sar, html code.shiki .s_Sar{--shiki-default:#0184BC;--shiki-dark:#56B6C2}html pre.shiki code .sJa8x, html code.shiki .sJa8x{--shiki-default:#E45649;--shiki-dark:#E06C75}html pre.shiki code .s5ixo, html code.shiki .s5ixo{--shiki-default:#383A42;--shiki-dark:#ABB2BF}html pre.shiki code .sDhpE, html code.shiki .sDhpE{--shiki-default:#50A14F;--shiki-dark:#98C379}html pre.shiki code .sknuh, html code.shiki .sknuh{--shiki-default:#383A42;--shiki-dark:#56B6C2}html pre.shiki code .sLKXg, html code.shiki .sLKXg{--shiki-default:#A626A4;--shiki-dark:#C678DD}html pre.shiki code .sDaw7, html code.shiki .sDaw7{--shiki-default:#0184BC;--shiki-dark:#E06C75}html pre.shiki code .sxymB, html code.shiki .sxymB{--shiki-default:#986801;--shiki-dark:#ABB2BF}html pre.shiki code .sAGMh, html code.shiki .sAGMh{--shiki-default:#986801;--shiki-dark:#D19A66}html pre.shiki code .sblXP, html code.shiki .sblXP{--shiki-default:#383A42;--shiki-dark:#C678DD}",{"title":89,"searchDepth":247,"depth":247,"links":3949},[3950,3951,3952,3953,3957,3958,3959,3960,3961,3962,3963,3964,3965,3966,3967,3968,3969],{"id":891,"depth":247,"text":891},{"id":912,"depth":247,"text":912},{"id":934,"depth":247,"text":934},{"id":951,"depth":247,"text":952,"children":3954},[3955,3956],{"id":961,"depth":267,"text":961},{"id":996,"depth":267,"text":996},{"id":1063,"depth":247,"text":1064},{"id":1173,"depth":247,"text":1173},{"id":1670,"depth":247,"text":1670},{"id":1777,"depth":247,"text":1777},{"id":1853,"depth":247,"text":1853},{"id":2065,"depth":247,"text":2065},{"id":2282,"depth":247,"text":2282},{"id":2569,"depth":247,"text":2569},{"id":2777,"depth":247,"text":2777},{"id":3828,"depth":247,"text":3828},{"id":3903,"depth":247,"text":3903},{"id":3915,"depth":247,"text":3915},{"id":3927,"depth":247,"text":3927},{"title":3971,"date":3972,"path":3973,"tags":3974,"body":3977},"在 Hexo Fluid 主题中使用霞鹜文楷","2023-11-28 00:16:23","/2023/11/28/use-lxgw-wenkai-in-hexo-fluid",[3975,3976,15],"Hexo","CSS",{"type":17,"value":3978,"toc":4204},[3979,3982,3988,3996,4014,4023,4056,4068,4071,4097,4100,4113,4119,4128,4134,4183,4186,4201],[20,3980,3981],{},"我的博客换到 fluid 主题已经有两年了，期间一直有为博客更换字体的想法，但之前没有前端开发的相关知识支撑我换字体的需求。不过现在，我已经有了一些 Vue.js 的开发经验，相信能支撑我完成这个目标。",[20,3983,3984],{},[52,3985],{"alt":3986,"src":3987},"最终成品","https://static.031130.xyz/uploads/2024/08/12/6564d0f926e58.webp",[20,3989,3990,3991,909],{},"我在谷歌搜索到了这篇文章——",[24,3992,3995],{"href":3993,"rel":3994},"https://penghh.fun/2023/05/07/2023-5-7-hexo_blog_font/",[73],"《Hexo博客Fluid主题，字体全局更改为霞鹜文楷体》",[20,3997,3998,3999,4002,4003,4006,4007,720,4010,4013],{},"文章中直接修改了 ",[45,4000,4001],{},"themes/fluid/layout/_partial/head.ejs"," 让文章生成时在 html 的 head 标签中引入 lxgw-wenkai-screen-webfont 的 css 文件，并使用自定义 css 方案。但这种方案我不喜欢，我的 fluid 主题是通过 npm 安装 hexo-theme-fluid 的方式引入的，这意味着我不能直接编辑 ",[45,4004,4005],{},"themes/fluid"," 下的文件，包括文章中需要编辑的 ",[45,4008,4009],{},"head.ejs",[45,4011,4012],{},"_config.yml"," 。",[20,4015,4016,4017,4022],{},"我翻阅了 ",[24,4018,4021],{"href":4019,"rel":4020},"https://github.com/chawyehsu/lxgw-wenkai-webfont",[73],"lxgw-wenkai-webfont"," 的 README，找到了使用 cdn 引入的方式。我们需要在 html 的 head 标签中加上下面这段:",[84,4024,4028],{"className":4025,"code":4026,"language":4027,"meta":89,"style":89},"language-html shiki shiki-themes one-light one-dark-pro","\u003Clink rel=\"stylesheet\" href=\"https://cdn.jsdelivr.net/npm/lxgw-wenkai-screen-webfont@1.1.0/style.css\" />\n","html",[45,4029,4030],{"__ignoreMap":89},[93,4031,4032,4034,4037,4040,4042,4045,4048,4050,4053],{"class":95,"line":96},[93,4033,2793],{"class":103},[93,4035,4036],{"class":250},"link",[93,4038,4039],{"class":439}," rel",[93,4041,2204],{"class":103},[93,4043,4044],{"class":107},"\"stylesheet\"",[93,4046,4047],{"class":439}," href",[93,4049,2204],{"class":103},[93,4051,4052],{"class":107},"\"https://cdn.jsdelivr.net/npm/lxgw-wenkai-screen-webfont@1.1.0/style.css\"",[93,4054,4055],{"class":103}," />\n",[20,4057,4058],{},[4059,4060,4061,4062,4067],"del",{},"但我注意到我想要的 lxgw-wenkai-screen-webfont 在 ",[24,4063,4066],{"href":4064,"rel":4065},"https://staticfile.org/",[73],"staticfile.org"," 上也有 cdn 提供，且该 cdn 有海外节点，是不错的选择，所以我要通过下面这段引入:",[20,4069,4070],{},"staticfile 已经因为供应链投毒被各 adblock 插件屏蔽，已改用 npmmirror",[84,4072,4074],{"className":4025,"code":4073,"language":4027,"meta":89,"style":89},"\u003Clink rel=\"stylesheet\" href=\"https://registry.npmmirror.com/lxgw-wenkai-screen-web/latest/files/style.min.css\" />\n",[45,4075,4076],{"__ignoreMap":89},[93,4077,4078,4080,4082,4084,4086,4088,4090,4092,4095],{"class":95,"line":96},[93,4079,2793],{"class":103},[93,4081,4036],{"class":250},[93,4083,4039],{"class":439},[93,4085,2204],{"class":103},[93,4087,4044],{"class":107},[93,4089,4047],{"class":439},[93,4091,2204],{"class":103},[93,4093,4094],{"class":107},"\"https://registry.npmmirror.com/lxgw-wenkai-screen-web/latest/files/style.min.css\"",[93,4096,4055],{"class":103},[20,4098,4099],{},"但要如何引入呢？",[20,4101,4102,4103,4108,4109,4112],{},"在 hexo 的",[24,4104,4107],{"href":4105,"rel":4106},"https://hexo.io/docs/plugins.html",[73],"官方文档","中，我找到了一个方案。可以在博客的 workdir 下创建一个 ",[45,4110,4111],{},"scripts"," 文件夹，在当中放入需要执行的 js 脚本。",[20,4114,4115],{},[52,4116],{"alt":4117,"src":4118},"hexo 文档","https://static.031130.xyz/uploads/2024/08/12/6564cea5c71ca.webp",[20,4120,4121,4122,4127],{},"在这篇名为",[24,4123,4126],{"href":4124,"rel":4125},"https://www.zywvvd.com/notes/hexo/theme/fluid/fluid-add-umami/fluid-add-umami/",[73],"《Fluid -23- 添加 Umami 统计》"," 的文章里，我找到了在 hexo 生成静态文件时直接注入的方式。",[20,4129,216,4130,4133],{},[45,4131,4132],{},"scripts/font.js"," 中写入:",[84,4135,4139],{"className":4136,"code":4137,"language":4138,"meta":89,"style":89},"language-javascript shiki shiki-themes one-light one-dark-pro","hexo.extend.injector.register('head_end',\n'\u003Clink rel=\"stylesheet\" href=\"https://registry.npmmirror.com/lxgw-wenkai-screen-web/latest/files/style.min.css\" />',\n'default');\n","javascript",[45,4140,4141,4169,4176],{"__ignoreMap":89},[93,4142,4143,4146,4148,4152,4154,4157,4159,4162,4164,4167],{"class":95,"line":96},[93,4144,4145],{"class":298},"hexo",[93,4147,302],{"class":103},[93,4149,4151],{"class":4150},"s2QsP","extend",[93,4153,302],{"class":103},[93,4155,4156],{"class":4150},"injector",[93,4158,302],{"class":103},[93,4160,4161],{"class":240},"register",[93,4163,104],{"class":103},[93,4165,4166],{"class":107},"'head_end'",[93,4168,443],{"class":103},[93,4170,4171,4174],{"class":95,"line":247},[93,4172,4173],{"class":107},"'\u003Clink rel=\"stylesheet\" href=\"https://registry.npmmirror.com/lxgw-wenkai-screen-web/latest/files/style.min.css\" />'",[93,4175,443],{"class":103},[93,4177,4178,4181],{"class":95,"line":267},[93,4179,4180],{"class":107},"'default'",[93,4182,111],{"class":103},[20,4184,4185],{},"这样一来，字体文件的 css 便被我们成功引入了，我们还需要指定页面使用霞鹜文楷作为默认字体。",[20,4187,4188,4189,4192,4193,4196,4197,4200],{},"在 fluid 主题的配置文件 ",[45,4190,4191],{},"_config.fluid.yml"," 中，有一个名为 ",[45,4194,4195],{},"font-family"," 的配置项，直接写上 ",[45,4198,4199],{},"font-family: \"LXGW Wenkai Screen\""," 便可大功告成。",[530,4202,4203],{},"html pre.shiki code .s5ixo, html code.shiki .s5ixo{--shiki-default:#383A42;--shiki-dark:#ABB2BF}html pre.shiki code .sJa8x, html code.shiki .sJa8x{--shiki-default:#E45649;--shiki-dark:#E06C75}html pre.shiki code .sAGMh, html code.shiki .sAGMh{--shiki-default:#986801;--shiki-dark:#D19A66}html pre.shiki code .sDhpE, html code.shiki .sDhpE{--shiki-default:#50A14F;--shiki-dark:#98C379}html .default .shiki span {color: var(--shiki-default);background: var(--shiki-default-bg);font-style: var(--shiki-default-font-style);font-weight: var(--shiki-default-font-weight);text-decoration: var(--shiki-default-text-decoration);}html .shiki span {color: var(--shiki-default);background: var(--shiki-default-bg);font-style: var(--shiki-default-font-style);font-weight: var(--shiki-default-font-weight);text-decoration: var(--shiki-default-text-decoration);}html .dark .shiki span {color: var(--shiki-dark);background: var(--shiki-dark-bg);font-style: var(--shiki-dark-font-style);font-weight: var(--shiki-dark-font-weight);text-decoration: var(--shiki-dark-text-decoration);}html.dark .shiki span {color: var(--shiki-dark);background: var(--shiki-dark-bg);font-style: var(--shiki-dark-font-style);font-weight: var(--shiki-dark-font-weight);text-decoration: var(--shiki-dark-text-decoration);}html pre.shiki code .s7GmK, html code.shiki .s7GmK{--shiki-default:#383A42;--shiki-dark:#E5C07B}html pre.shiki code .s2QsP, html code.shiki .s2QsP{--shiki-default:#E45649;--shiki-dark:#E5C07B}html pre.shiki code .sAdtL, html code.shiki .sAdtL{--shiki-default:#4078F2;--shiki-dark:#61AFEF}",{"title":89,"searchDepth":247,"depth":247,"links":4205},[],{"title":4207,"date":4208,"path":4209,"tags":4210,"body":4212},"【翻译】GLWTPL——祝你好运开源许可证","2023-11-12 01:09:09","/2023/11/12/a-introduce-of-glwtpl",[4211,877],"Fun",{"type":17,"value":4213,"toc":4502},[4214,4223,4226,4232,4241,4244,4250,4259,4262,4279,4282,4473,4478,4481,4484,4487,4493,4496],[116,4215,4216],{},[20,4217,4218,4219],{},"说实话，当我第一次看见 GLWTPL( Good Luck With That Public License ) 的时候，我差点把嘴里的饭给喷出来了，这是一个非常有意思的开源许可证。原文请直接戳原仓库 -> ",[24,4220,4221],{"href":4221,"rel":4222},"https://github.com/me-shaon/GLWTPL",[73],[20,4224,4225],{},"如果你对你的代码有这样的感觉:",[84,4227,4230],{"className":4228,"code":4229,"language":748},[746],"当我写下这段代码的时候，只有上帝和我知道我在写什么。\n现在只有上帝知道了。\n",[45,4231,4229],{"__ignoreMap":89},[20,4233,4234,4235,4240],{},"那不如来考虑一下将这份",[24,4236,4239],{"href":4237,"rel":4238},"https://github.com/me-shaon/GLWTPL/blob/master/LICENSE",[73],"开源许可证","添加到你的项目中！",[20,4242,4243],{},"并且，祝你未来的自己、人类同胞、外星人或人工智能机器人（可以编码并会毁灭人类）——实际上是任何敢于参与你的项目的人好运。",[20,4245,4246],{},[52,4247],{"alt":4248,"src":4249},"good-luck.gif","https://static.031130.xyz/uploads/2024/08/12/654fb6e4581bf.gif",[20,4251,4252,4253,4258],{},"当然，它还有一个",[24,4254,4257],{"href":4255,"rel":4256},"https://github.com/me-shaon/GLWTPL/blob/master/NSFW_LICENSE",[73],"脏话版本","。干杯！",[33,4260,4261],{"id":4261},"可能的使用场景",[1244,4263,4264,4267,4270,4273,4276],{},[920,4265,4266],{},"你写了一些你并不为此自豪的代码，但你想要将它开源。",[920,4268,4269],{},"你想要将你写的代码“放生”，但不想为此负任何责任。",[920,4271,4272],{},"“无论如何我都已经写完了”，并且你没有时间/意图对你的代码进行修复、修改或改进。",[920,4274,4275],{},"想要将自己参加的黑客马拉松/代码竞赛的代码打造成一个爆火的仓库？该使用什么开源许可证？这就是为你量身打造的开源许可证！",[920,4277,4278],{},"你的大学课设或科研工作与这份许可证是天作之合。",[33,4280,4281],{"id":4281},"一些翻译版本",[1244,4283,4284,4291,4298,4305,4312,4319,4326,4333,4340,4347,4354,4361,4368,4375,4382,4389,4396,4403,4410,4417,4424,4431,4438,4445,4452,4459,4466],{},[920,4285,4286],{},[24,4287,4290],{"href":4288,"rel":4289},"https://github.com/me-shaon/GLWTPL/blob/master/translations/LICENSE_al-AL",[73],"Albanian - Shqip",[920,4292,4293],{},[24,4294,4297],{"href":4295,"rel":4296},"https://github.com/me-shaon/GLWTPL/blob/master/translations/LICENSE_ar-AR",[73],"Arabic - العربية",[920,4299,4300],{},[24,4301,4304],{"href":4302,"rel":4303},"https://github.com/me-shaon/GLWTPL/blob/master/translations/LICENSE_bn-BN",[73],"Bangla - বাংলা",[920,4306,4307],{},[24,4308,4311],{"href":4309,"rel":4310},"https://github.com/me-shaon/GLWTPL/blob/master/translations/LICENSE_zh-HK",[73],"Cantonese - 廣東話",[920,4313,4314],{},[24,4315,4318],{"href":4316,"rel":4317},"https://github.com/me-shaon/GLWTPL/blob/master/translations/LICENSE_cat-CAT",[73],"Catalan - Català",[920,4320,4321],{},[24,4322,4325],{"href":4323,"rel":4324},"https://github.com/me-shaon/GLWTPL/blob/master/translations/LICENSE_hr-HR",[73],"Croatian - Hrvatski",[920,4327,4328],{},[24,4329,4332],{"href":4330,"rel":4331},"https://github.com/me-shaon/GLWTPL/blob/master/translations/LICENSE_da-DK",[73],"Danish - Dansk",[920,4334,4335],{},[24,4336,4339],{"href":4337,"rel":4338},"https://github.com/me-shaon/GLWTPL/blob/master/translations/LICENSE_nl-NL",[73],"Dutch - Nederlands",[920,4341,4342],{},[24,4343,4346],{"href":4344,"rel":4345},"https://github.com/me-shaon/GLWTPL/blob/master/translations/LICENSE_fr-FR",[73],"French - Français",[920,4348,4349],{},[24,4350,4353],{"href":4351,"rel":4352},"https://github.com/me-shaon/GLWTPL/blob/master/translations/NSFW_LICENSE_gl-GL",[73],"Galician - Galego",[920,4355,4356],{},[24,4357,4360],{"href":4358,"rel":4359},"https://github.com/me-shaon/GLWTPL/blob/master/translations/LICENSE_ka-GE",[73],"Georgian - ქართული",[920,4362,4363],{},[24,4364,4367],{"href":4365,"rel":4366},"https://github.com/me-shaon/GLWTPL/blob/master/translations/LICENSE_de-DE",[73],"German - Deutsch",[920,4369,4370],{},[24,4371,4374],{"href":4372,"rel":4373},"https://github.com/me-shaon/GLWTPL/blob/master/translations/LICENSE_gr-GR",[73],"Greek - Ελληνικά",[920,4376,4377],{},[24,4378,4381],{"href":4379,"rel":4380},"https://github.com/me-shaon/GLWTPL/blob/master/translations/LICENSE_he-HE",[73],"Hebrew - עברית",[920,4383,4384],{},[24,4385,4388],{"href":4386,"rel":4387},"https://github.com/me-shaon/GLWTPL/blob/master/translations/LICENSE_id-ID",[73],"Indonesian - Bahasa Indonesia",[920,4390,4391],{},[24,4392,4395],{"href":4393,"rel":4394},"https://github.com/me-shaon/GLWTPL/blob/master/translations/LICENSE_it-IT",[73],"Italian - Italiano",[920,4397,4398],{},[24,4399,4402],{"href":4400,"rel":4401},"https://github.com/me-shaon/GLWTPL/blob/master/translations/LICENSE_ja-JP",[73],"Japanese - 日本語",[920,4404,4405],{},[24,4406,4409],{"href":4407,"rel":4408},"https://github.com/me-shaon/GLWTPL/blob/master/translations/LICENSE_ko-KR",[73],"Korea - 한국어",[920,4411,4412],{},[24,4413,4416],{"href":4414,"rel":4415},"https://github.com/me-shaon/GLWTPL/blob/master/translations/LICENSE_lv-LV",[73],"Latvian - Latviski",[920,4418,4419],{},[24,4420,4423],{"href":4421,"rel":4422},"https://github.com/me-shaon/GLWTPL/blob/master/translations/LICENSE_pt-BR",[73],"Portuguese - Português (BR)",[920,4425,4426],{},[24,4427,4430],{"href":4428,"rel":4429},"https://github.com/me-shaon/GLWTPL/blob/master/translations/LICENSE_ru-RU",[73],"Russian - Русский",[920,4432,4433],{},[24,4434,4437],{"href":4435,"rel":4436},"https://github.com/me-shaon/GLWTPL/blob/master/translations/LICENSE_zh-CN",[73],"Simplified Chinese - 简体中文",[920,4439,4440],{},[24,4441,4444],{"href":4442,"rel":4443},"https://github.com/me-shaon/GLWTPL/blob/master/translations/LICENSE_es-ES",[73],"Spanish - Español",[920,4446,4447],{},[24,4448,4451],{"href":4449,"rel":4450},"https://github.com/me-shaon/GLWTPL/blob/master/translations/LICENSE_sv-SE",[73],"Swedish - Svenska",[920,4453,4454],{},[24,4455,4458],{"href":4456,"rel":4457},"https://github.com/me-shaon/GLWTPL/blob/master/translations/LICENSE_zh-TW",[73],"Traditional Chinese - 正體中文",[920,4460,4461],{},[24,4462,4465],{"href":4463,"rel":4464},"https://github.com/me-shaon/GLWTPL/blob/master/translations/LICENSE_tr-TR",[73],"Turkish - Türkçe",[920,4467,4468],{},[24,4469,4472],{"href":4470,"rel":4471},"https://github.com/me-shaon/GLWTPL/blob/master/translations/LICENSE_vn-VN",[73],"Vietnamese - Tiếng Việt",[116,4474,4475],{},[20,4476,4477],{},"本译文翻译于 2023 年 11 月 12 日，日后大概率也不会对本文进行任何改进，故也采用 GLWTPL 向所有人授权。",[4479,4480],"hr",{},[33,4482,4483],{"id":4483},"附",[20,4485,4486],{},"此协议的英文原版：",[84,4488,4491],{"className":4489,"code":4490,"language":748},[746],"               GLWT(Good Luck With That) Public License\n                 Copyright (c) Everyone, except Author\n\nEveryone is permitted to copy, distribute, modify, merge, sell, publish,\nsublicense or whatever they want with this software but at their OWN RISK.\n\n                            Preamble\n\nThe author has absolutely no clue what the code in this project does.\nIt might just work or not, there is no third option.\n\n\n                GOOD LUCK WITH THAT PUBLIC LICENSE\n   TERMS AND CONDITIONS FOR COPYING, DISTRIBUTION, AND MODIFICATION\n\n  0. You just DO WHATEVER YOU WANT TO as long as you NEVER LEAVE A\nTRACE TO TRACK THE AUTHOR of the original product to blame for or hold\nresponsible.\n\nIN NO EVENT SHALL THE AUTHORS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER\nLIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING\nFROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER\nDEALINGS IN THE SOFTWARE.\n\nGood luck and Godspeed.\n",[45,4492,4490],{"__ignoreMap":89},[20,4494,4495],{},"此协议在 Github 上的中文翻译版本：",[84,4497,4500],{"className":4498,"code":4499,"language":748},[746],"GLWT（Good Luck With That，祝你好运）公共许可证\n版权所有© 每个人，除了作者\n\n任何人都被允许复制、分发、修改、合并、销售、出版、再授权或\n任何其它操作，但风险自负。\n\n作者对这个项目中的代码一无所知。\n代码处于可用或不可用状态，没有第三种情况。\n\n\n                祝你好运公共许可证\n            复制、分发和修改的条款和条件\n\n0 ：在不导致作者被指责或承担责任的情况下，你可以做任何你想\n要做的事情。\n\n无论是在合同行为、侵权行为或其它因使用本软件产生的情形，作\n者不对任何索赔、损害承担责任。\n\n祖宗保佑。\n",[45,4501,4499],{"__ignoreMap":89},{"title":89,"searchDepth":247,"depth":247,"links":4503},[4504,4505,4506],{"id":4261,"depth":247,"text":4261},{"id":4281,"depth":247,"text":4281},{"id":4483,"depth":247,"text":4483},{"title":4508,"date":4509,"path":4510,"tags":4511,"body":4517},"通过巴法云将向日葵智能插座接入米家，实现小爱同学远程控制","2023-11-02 10:17:02","/2023/11/02/integrating-sunflower-smart-socket-with-mi-home-via-bemfa-cloud",[4512,4513,13,4514,4515,4516,4211],"IoT","MiAI","Linux","Python","Hardware",{"type":17,"value":4518,"toc":5257},[4519,4525,4534,4543,4552,4557,4560,4566,4569,4572,4612,4618,4621,4627,4630,4633,4636,5228,5231,5254],[20,4520,22,4521,4524],{},[24,4522,27],{"href":4523},"/2023/11/01/unveiling-sunflower-smart-adapter-api-intercepting-utilizing-api-android-packet-sniffing/","中，我们介绍了如何在本地局域网中通过发送 http 请求控制向日葵智能插座 C2 的开关状态。但这还远远不够，我自己是小米生态链的忠实用户，在宿舍里也接入了四五个米家的智能设备，因此我想把这个智能插座接入米家，实现离家时一键关闭。",[20,4526,4527,4528,4533],{},"在阅读",[24,4529,4532],{"href":4530,"rel":4531},"https://iot.mi.com/",[73],"小米IoT开发者平台","的接入文档后，我发现米家对于个人开发者并不友好，接入文档大部分要完成企业认证以后才能实现。在谷歌一番搜索过后，我发现了通过假设 Home Assistant 后通过巴法云接入米家的方案。但我眼下就这一个非米家的智能家具，暂时还不想去碰 Home Assistant 那套体系。",[20,4535,4536,4537,4542],{},"因此我便找上了",[24,4538,4541],{"href":4539,"rel":4540},"https://cloud.bemfa.com/",[73],"巴法云","。在巴法云的官网中提到，他们是「专注物联网设备接入&一站式解决方案」，对于个人开发者，目前平台免费使用。网站的文档虽然并不优雅美观，却透露出实用主义的气息，针对接入提供了 TCP 长连接和 MQTT 两种方案，看着就很适合实现我的需求。",[20,4544,4545,4546,4551],{},"在巴法云文档中的「",[24,4547,4550],{"href":4548,"rel":4549},"https://cloud.bemfa.com/docs/#/?id=_21-%e8%ae%a2%e9%98%85%e5%8f%91%e5%b8%83%e6%a8%a1%e5%bc%8f",[73],"五分钟入门","」那一栏介绍了远程控制的业务逻辑:",[116,4553,4554],{},[20,4555,4556],{},"如果单片机订阅了一个主题，手机往这个主题推送个消息指令，单片机由于订阅了这个主题，就可以收到发往这个主题的消息，就可以达到手机控制单片机的目的。",[20,4558,4559],{},"所以我需要在巴法云的控制台创建一个针对于智能插座的主题，让我局域网内的一台设备订阅这个主题。接入米家以后，米家需要控制向日葵的智能插座时就向巴法云的这个主题推送一条消息，局域网内的设备就能接收到推送消息，进而调用智能插座的 api 实现远程开关。在这里，我选择使用一台刷了 Armbian 的 N1 作为局域网内的转发器。整个控制流程看上去是下面这个样子:",[20,4561,4562],{},[52,4563],{"alt":4564,"src":4565},"控制流程图","https://static.031130.xyz/uploads/2024/08/12/65430fbf56dee.webp",[20,4567,4568],{},"我并不知道 tcp 长连接的数据传输应该如何实现，但看起来 MQTT 是一个比较成熟的协议，因此我选择使用 MQTT 作为巴法云和 N1 之间的通讯协议。",[20,4570,4571],{},"在巴法云的控制台，选择 MQTT 设备云，创建一个新的主题，注意需要以 001~009 结尾，否则在米家里看不见创建的这个主题。",[116,4573,4574,4579,4584,4589,4594,4599,4604,4609],{},[116,4575,4576],{},[20,4577,4578],{},"当主题名字后三位是001时为插座设备。",[116,4580,4581],{},[20,4582,4583],{},"当主题名字后三位是002时为灯泡设备。",[116,4585,4586],{},[20,4587,4588],{},"当主题名字后三位是003时为风扇设备。",[116,4590,4591],{},[20,4592,4593],{},"当主题名字后三位是004时为传感器设备。",[116,4595,4596],{},[20,4597,4598],{},"当主题名字后三位是005时为空调设备。",[116,4600,4601],{},[20,4602,4603],{},"当主题名字后三位是006时为开关设备。",[116,4605,4606],{},[20,4607,4608],{},"当主题名字后三位是009时为窗帘设备。",[20,4610,4611],{},"当主题名字为其他时，默认为普通主题节点，不会同步到米家。",[20,4613,4614],{},[52,4615],{"alt":4616,"src":4617},"创建新主题","https://static.031130.xyz/uploads/2024/08/12/654310bb3133b.webp",[20,4619,4620],{},"此时，我便可以在手机的米家中找到巴法云并接入这个插座。",[20,4622,4623],{},[52,4624],{"alt":4625,"src":4626},"米家找连接巴法云","https://static.031130.xyz/uploads/2024/08/12/654312974e393.webp",[20,4628,4629],{},"至此，米家那边的接入已经完成了，虽然没法在米家中找到对应设备的卡片，但是可以在小爱同学的小爱训练计划中找到对应的设备。",[20,4631,4632],{},"我们还需要让本地的 N1 盒子使用 MQTT 协议订阅巴法云的消息。",[20,4634,4635],{},"参考代码如下:",[84,4637,4641],{"className":4638,"code":4639,"language":4640,"meta":89,"style":89},"language-python shiki shiki-themes one-light one-dark-pro","#!/usr/bin/python3\n\nimport paho.mqtt.client as mqtt\nimport requests\n\n# 智能插座相关\nhost = ''\nsn = ''\nkey = ''\ntime = ''\n\n# 巴法云相关\nclient_id = ''\ntheme = ''\n\ndef set_adapter_status(status: bool):\n    url = 'http://' + host + '/plug'\n    requests.get(url, params={\n        \"status\": 1 if status else 0,\n        \"sn\": sn,\n        \"key\": key,\n        \"_api\": \"set_plug_status\",\n        \"time\": time,\n        \"index\": 0\n    })\n\ndef on_connect(client, userdata, flags, rc):\n    print(\"Connection returned with result code:\" + str(rc))\n    client.subscribe(theme, qos=1)\n\ndef on_message(client, userdata, msg):\n    if msg.payload.decode(\"utf-8\") == 'on':\n        set_adapter_status(True)\n    elif msg.payload.decode(\"utf-8\") == 'off':\n        set_adapter_status(False)\n\ndef on_subscribe(client, userdata, mid, granted_qos):\n    print(\"Subscribed: \" + str(mid) + \" \" + str(granted_qos))\n    \nclient = mqtt.Client(client_id=client_id, clean_session=False, protocol=mqtt.MQTTv311)\nclient.on_connect = on_connect\nclient.on_message = on_message\nclient.on_subscribe = on_subscribe\n\nclient.connect(\"bemfa.com\", 9501, 60)\nclient.loop_forever()\n","python",[45,4642,4643,4648,4652,4666,4673,4677,4682,4692,4701,4710,4719,4723,4728,4737,4746,4750,4771,4793,4813,4837,4845,4853,4865,4873,4883,4888,4892,4921,4939,4959,4963,4985,5010,5022,5044,5055,5059,5086,5114,5119,5159,5169,5179,5189,5193,5218],{"__ignoreMap":89},[93,4644,4645],{"class":95,"line":96},[93,4646,4647],{"class":426},"#!/usr/bin/python3\n",[93,4649,4650],{"class":95,"line":247},[93,4651,353],{"emptyLinePlaceholder":352},[93,4653,4654,4657,4660,4663],{"class":95,"line":267},[93,4655,4656],{"class":232},"import",[93,4658,4659],{"class":103}," paho.mqtt.client ",[93,4661,4662],{"class":232},"as",[93,4664,4665],{"class":103}," mqtt\n",[93,4667,4668,4670],{"class":95,"line":356},[93,4669,4656],{"class":232},[93,4671,4672],{"class":103}," requests\n",[93,4674,4675],{"class":95,"line":3},[93,4676,353],{"emptyLinePlaceholder":352},[93,4678,4679],{"class":95,"line":383},[93,4680,4681],{"class":426},"# 智能插座相关\n",[93,4683,4684,4687,4689],{"class":95,"line":393},[93,4685,4686],{"class":103},"host ",[93,4688,2204],{"class":1213},[93,4690,4691],{"class":107}," ''\n",[93,4693,4694,4697,4699],{"class":95,"line":403},[93,4695,4696],{"class":103},"sn ",[93,4698,2204],{"class":1213},[93,4700,4691],{"class":107},[93,4702,4703,4706,4708],{"class":95,"line":413},[93,4704,4705],{"class":103},"key ",[93,4707,2204],{"class":1213},[93,4709,4691],{"class":107},[93,4711,4712,4715,4717],{"class":95,"line":430},[93,4713,4714],{"class":103},"time ",[93,4716,2204],{"class":1213},[93,4718,4691],{"class":107},[93,4720,4721],{"class":95,"line":446},[93,4722,353],{"emptyLinePlaceholder":352},[93,4724,4725],{"class":95,"line":459},[93,4726,4727],{"class":426},"# 巴法云相关\n",[93,4729,4730,4733,4735],{"class":95,"line":465},[93,4731,4732],{"class":103},"client_id ",[93,4734,2204],{"class":1213},[93,4736,4691],{"class":107},[93,4738,4739,4742,4744],{"class":95,"line":471},[93,4740,4741],{"class":103},"theme ",[93,4743,2204],{"class":1213},[93,4745,4691],{"class":107},[93,4747,4748],{"class":95,"line":477},[93,4749,353],{"emptyLinePlaceholder":352},[93,4751,4752,4755,4758,4760,4764,4766,4769],{"class":95,"line":483},[93,4753,4754],{"class":232},"def",[93,4756,4757],{"class":240}," set_adapter_status",[93,4759,104],{"class":103},[93,4761,4763],{"class":4762},"so_Uh","status",[93,4765,255],{"class":103},[93,4767,4768],{"class":99}," bool",[93,4770,1335],{"class":103},[93,4772,4773,4776,4778,4781,4784,4787,4790],{"class":95,"line":499},[93,4774,4775],{"class":103},"    url ",[93,4777,2204],{"class":1213},[93,4779,4780],{"class":107}," 'http://'",[93,4782,4783],{"class":1213}," +",[93,4785,4786],{"class":103}," host ",[93,4788,4789],{"class":1213},"+",[93,4791,4792],{"class":107}," '/plug'\n",[93,4794,4795,4798,4802,4805,4809,4811],{"class":95,"line":1435},[93,4796,4797],{"class":103},"    requests.",[93,4799,4801],{"class":4800},"slOjB","get",[93,4803,4804],{"class":103},"(url, ",[93,4806,4808],{"class":4807},"sp7wS","params",[93,4810,2204],{"class":1213},[93,4812,1688],{"class":103},[93,4814,4815,4818,4820,4823,4826,4829,4832,4835],{"class":95,"line":1459},[93,4816,4817],{"class":107},"        \"status\"",[93,4819,436],{"class":103},[93,4821,4822],{"class":439},"1",[93,4824,4825],{"class":232}," if",[93,4827,4828],{"class":103}," status ",[93,4830,4831],{"class":232},"else",[93,4833,4834],{"class":439}," 0",[93,4836,443],{"class":103},[93,4838,4839,4842],{"class":95,"line":1466},[93,4840,4841],{"class":107},"        \"sn\"",[93,4843,4844],{"class":103},": sn,\n",[93,4846,4847,4850],{"class":95,"line":1471},[93,4848,4849],{"class":107},"        \"key\"",[93,4851,4852],{"class":103},": key,\n",[93,4854,4855,4858,4860,4863],{"class":95,"line":1477},[93,4856,4857],{"class":107},"        \"_api\"",[93,4859,436],{"class":103},[93,4861,4862],{"class":107},"\"set_plug_status\"",[93,4864,443],{"class":103},[93,4866,4867,4870],{"class":95,"line":1483},[93,4868,4869],{"class":107},"        \"time\"",[93,4871,4872],{"class":103},": time,\n",[93,4874,4875,4878,4880],{"class":95,"line":1488},[93,4876,4877],{"class":107},"        \"index\"",[93,4879,436],{"class":103},[93,4881,4882],{"class":439},"0\n",[93,4884,4885],{"class":95,"line":1528},[93,4886,4887],{"class":103},"    })\n",[93,4889,4890],{"class":95,"line":1535},[93,4891,353],{"emptyLinePlaceholder":352},[93,4893,4894,4896,4899,4901,4904,4906,4909,4911,4914,4916,4919],{"class":95,"line":1540},[93,4895,4754],{"class":232},[93,4897,4898],{"class":240}," on_connect",[93,4900,104],{"class":103},[93,4902,4903],{"class":4762},"client",[93,4905,1403],{"class":103},[93,4907,4908],{"class":4762}," userdata",[93,4910,1403],{"class":103},[93,4912,4913],{"class":4762}," flags",[93,4915,1403],{"class":103},[93,4917,4918],{"class":4762}," rc",[93,4920,1335],{"class":103},[93,4922,4923,4926,4928,4931,4933,4936],{"class":95,"line":1546},[93,4924,4925],{"class":99},"    print",[93,4927,104],{"class":103},[93,4929,4930],{"class":107},"\"Connection returned with result code:\"",[93,4932,4783],{"class":1213},[93,4934,4935],{"class":99}," str",[93,4937,4938],{"class":103},"(rc))\n",[93,4940,4941,4944,4947,4950,4953,4955,4957],{"class":95,"line":1552},[93,4942,4943],{"class":103},"    client.",[93,4945,4946],{"class":4800},"subscribe",[93,4948,4949],{"class":103},"(theme, ",[93,4951,4952],{"class":4807},"qos",[93,4954,2204],{"class":1213},[93,4956,4822],{"class":439},[93,4958,496],{"class":103},[93,4960,4961],{"class":95,"line":1557},[93,4962,353],{"emptyLinePlaceholder":352},[93,4964,4965,4967,4970,4972,4974,4976,4978,4980,4983],{"class":95,"line":1603},[93,4966,4754],{"class":232},[93,4968,4969],{"class":240}," on_message",[93,4971,104],{"class":103},[93,4973,4903],{"class":4762},[93,4975,1403],{"class":103},[93,4977,4908],{"class":4762},[93,4979,1403],{"class":103},[93,4981,4982],{"class":4762}," msg",[93,4984,1335],{"class":103},[93,4986,4987,4990,4993,4996,4998,5001,5003,5005,5008],{"class":95,"line":1610},[93,4988,4989],{"class":232},"    if",[93,4991,4992],{"class":103}," msg.payload.",[93,4994,4995],{"class":4800},"decode",[93,4997,104],{"class":103},[93,4999,5000],{"class":107},"\"utf-8\"",[93,5002,3853],{"class":103},[93,5004,3856],{"class":1213},[93,5006,5007],{"class":107}," 'on'",[93,5009,1644],{"class":103},[93,5011,5012,5015,5017,5020],{"class":95,"line":1615},[93,5013,5014],{"class":4800},"        set_adapter_status",[93,5016,104],{"class":103},[93,5018,5019],{"class":439},"True",[93,5021,496],{"class":103},[93,5023,5024,5027,5029,5031,5033,5035,5037,5039,5042],{"class":95,"line":1621},[93,5025,5026],{"class":232},"    elif",[93,5028,4992],{"class":103},[93,5030,4995],{"class":4800},[93,5032,104],{"class":103},[93,5034,5000],{"class":107},[93,5036,3853],{"class":103},[93,5038,3856],{"class":1213},[93,5040,5041],{"class":107}," 'off'",[93,5043,1644],{"class":103},[93,5045,5046,5048,5050,5053],{"class":95,"line":1627},[93,5047,5014],{"class":4800},[93,5049,104],{"class":103},[93,5051,5052],{"class":439},"False",[93,5054,496],{"class":103},[93,5056,5057],{"class":95,"line":1633},[93,5058,353],{"emptyLinePlaceholder":352},[93,5060,5061,5063,5066,5068,5070,5072,5074,5076,5079,5081,5084],{"class":95,"line":1638},[93,5062,4754],{"class":232},[93,5064,5065],{"class":240}," on_subscribe",[93,5067,104],{"class":103},[93,5069,4903],{"class":4762},[93,5071,1403],{"class":103},[93,5073,4908],{"class":4762},[93,5075,1403],{"class":103},[93,5077,5078],{"class":4762}," mid",[93,5080,1403],{"class":103},[93,5082,5083],{"class":4762}," granted_qos",[93,5085,1335],{"class":103},[93,5087,5088,5090,5092,5095,5097,5099,5102,5104,5107,5109,5111],{"class":95,"line":1647},[93,5089,4925],{"class":99},[93,5091,104],{"class":103},[93,5093,5094],{"class":107},"\"Subscribed: \"",[93,5096,4783],{"class":1213},[93,5098,4935],{"class":99},[93,5100,5101],{"class":103},"(mid) ",[93,5103,4789],{"class":1213},[93,5105,5106],{"class":107}," \" \"",[93,5108,4783],{"class":1213},[93,5110,4935],{"class":99},[93,5112,5113],{"class":103},"(granted_qos))\n",[93,5115,5116],{"class":95,"line":1654},[93,5117,5118],{"class":103},"    \n",[93,5120,5121,5124,5126,5129,5132,5134,5137,5139,5142,5145,5147,5149,5151,5154,5156],{"class":95,"line":3377},[93,5122,5123],{"class":103},"client ",[93,5125,2204],{"class":1213},[93,5127,5128],{"class":103}," mqtt.",[93,5130,5131],{"class":4800},"Client",[93,5133,104],{"class":103},[93,5135,5136],{"class":4807},"client_id",[93,5138,2204],{"class":1213},[93,5140,5141],{"class":103},"client_id, ",[93,5143,5144],{"class":4807},"clean_session",[93,5146,2204],{"class":1213},[93,5148,5052],{"class":439},[93,5150,324],{"class":103},[93,5152,5153],{"class":4807},"protocol",[93,5155,2204],{"class":1213},[93,5157,5158],{"class":103},"mqtt.MQTTv311)\n",[93,5160,5161,5164,5166],{"class":95,"line":3388},[93,5162,5163],{"class":103},"client.on_connect ",[93,5165,2204],{"class":1213},[93,5167,5168],{"class":103}," on_connect\n",[93,5170,5171,5174,5176],{"class":95,"line":3405},[93,5172,5173],{"class":103},"client.on_message ",[93,5175,2204],{"class":1213},[93,5177,5178],{"class":103}," on_message\n",[93,5180,5181,5184,5186],{"class":95,"line":3412},[93,5182,5183],{"class":103},"client.on_subscribe ",[93,5185,2204],{"class":1213},[93,5187,5188],{"class":103}," on_subscribe\n",[93,5190,5191],{"class":95,"line":3417},[93,5192,353],{"emptyLinePlaceholder":352},[93,5194,5195,5198,5201,5203,5206,5208,5211,5213,5216],{"class":95,"line":3440},[93,5196,5197],{"class":103},"client.",[93,5199,5200],{"class":4800},"connect",[93,5202,104],{"class":103},[93,5204,5205],{"class":107},"\"bemfa.com\"",[93,5207,324],{"class":103},[93,5209,5210],{"class":439},"9501",[93,5212,324],{"class":103},[93,5214,5215],{"class":439},"60",[93,5217,496],{"class":103},[93,5219,5220,5222,5225],{"class":95,"line":3455},[93,5221,5197],{"class":103},[93,5223,5224],{"class":4800},"loop_forever",[93,5226,5227],{"class":103},"()\n",[33,5229,5230],{"id":5230},"参考链接",[1244,5232,5233,5240,5247],{},[920,5234,5235],{},[24,5236,5239],{"href":5237,"rel":5238},"https://cloud.bemfa.com/docs/#/",[73],"巴法开放平台",[920,5241,5242],{},[24,5243,5246],{"href":5244,"rel":5245},"https://www.cnblogs.com/Mickey-7/p/17402095.html",[73],"Python MQTT客户端  paho-mqtt",[920,5248,5249],{},[24,5250,5253],{"href":5251,"rel":5252},"https://www.emqx.com/zh/blog/comparision-of-python-mqtt-client",[73],"Python MQTT 客户端对比",[530,5255,5256],{},"html pre.shiki code .sW2Sy, html code.shiki .sW2Sy{--shiki-default:#A0A1A7;--shiki-default-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic}html pre.shiki code .sLKXg, html code.shiki .sLKXg{--shiki-default:#A626A4;--shiki-dark:#C678DD}html pre.shiki code .s5ixo, html code.shiki .s5ixo{--shiki-default:#383A42;--shiki-dark:#ABB2BF}html pre.shiki code .sknuh, html code.shiki .sknuh{--shiki-default:#383A42;--shiki-dark:#56B6C2}html pre.shiki code .sDhpE, html code.shiki .sDhpE{--shiki-default:#50A14F;--shiki-dark:#98C379}html pre.shiki code .sAdtL, html code.shiki .sAdtL{--shiki-default:#4078F2;--shiki-dark:#61AFEF}html pre.shiki code .so_Uh, html code.shiki .so_Uh{--shiki-default:#986801;--shiki-default-font-style:inherit;--shiki-dark:#D19A66;--shiki-dark-font-style:italic}html pre.shiki code .s_Sar, html code.shiki .s_Sar{--shiki-default:#0184BC;--shiki-dark:#56B6C2}html pre.shiki code .slOjB, html code.shiki .slOjB{--shiki-default:#383A42;--shiki-dark:#61AFEF}html pre.shiki code .sp7wS, html code.shiki .sp7wS{--shiki-default:#986801;--shiki-default-font-style:inherit;--shiki-dark:#E06C75;--shiki-dark-font-style:italic}html pre.shiki code .sAGMh, html code.shiki .sAGMh{--shiki-default:#986801;--shiki-dark:#D19A66}html .default .shiki span {color: var(--shiki-default);background: var(--shiki-default-bg);font-style: var(--shiki-default-font-style);font-weight: var(--shiki-default-font-weight);text-decoration: var(--shiki-default-text-decoration);}html .shiki span {color: var(--shiki-default);background: var(--shiki-default-bg);font-style: var(--shiki-default-font-style);font-weight: var(--shiki-default-font-weight);text-decoration: var(--shiki-default-text-decoration);}html .dark .shiki span {color: var(--shiki-dark);background: var(--shiki-dark-bg);font-style: var(--shiki-dark-font-style);font-weight: var(--shiki-dark-font-weight);text-decoration: var(--shiki-dark-text-decoration);}html.dark .shiki span {color: var(--shiki-dark);background: var(--shiki-dark-bg);font-style: var(--shiki-dark-font-style);font-weight: var(--shiki-dark-font-weight);text-decoration: var(--shiki-dark-text-decoration);}",{"title":89,"searchDepth":247,"depth":247,"links":5258},[5259],{"id":5230,"depth":247,"text":5230},{"title":5261,"date":5262,"path":5263,"tags":5264,"body":5266},"使用 Root 后的安卓手机获取向日葵智能插座 C2 的开关 api","2023-11-01 23:46:28","/2023/11/01/unveiling-sunflower-smart-adapter-api-intercepting-utilizing-api-android-packet-sniffing",[5265,13,4512,4211,4516],"Android",{"type":17,"value":5267,"toc":5375},[5268,5279,5282,5288,5291,5297,5300,5341,5344,5347,5353,5356,5362,5369],[116,5269,5270],{},[20,5271,5272,5273,5278],{},"之前看到 ",[24,5274,5277],{"href":5275,"rel":5276},"https://https.gs/archives/338/",[73],"https.gs 上的一篇文章","，发现可以抓取向日葵智能插座 C1Pro 的开关 api，并实现局域网或公网的控制。这样一来，我们其实就不需要依赖于向日葵自己家的 App 去实现智能插座的开关操作，还是比较方便的。今年趁着双十一，直接低价拿下来带有计电功能的 C2，便也来试一试能不能抓到接口。",[20,5280,5281],{},"首先，拿到插座以后肯定还是下载向日葵的官方 App，完成 wifi 的链接，这里就不再赘述。",[20,5283,5284],{},[52,5285],{"alt":5286,"src":5287},"向日葵的操作界面","https://static.031130.xyz/uploads/2024/08/12/65427474ba54d.webp",[20,5289,5290],{},"然后就可以打开我们的抓包软件。需要注意的是，原博客中抓到的接口是 http 协议，但这个接口在新版的 App 上已经变为了 https 协议，因此我们需要找一台 Root 过后的安卓机去抓包。抓包的步骤没什么好说的，用 Root 权限给本地安装自己的 CA 证书，然后打开抓包模式，在向日葵的 App 那边开关几次插座，回来就能看到这一段时间内的请求。",[20,5292,5293],{},[52,5294],{"alt":5295,"src":5296},"HttpCanary 操作界面","https://static.031130.xyz/uploads/2024/08/12/654275e167583.webp",[20,5298,5299],{},"点开可以看到，这是一个 GET 请求，一共有如下几个参数",[1244,5301,5302,5307,5313,5319,5329,5335],{},[920,5303,5304,5306],{},[45,5305,4763],{}," 这是状态设置，设置为 1 时为打开指令，0 为关闭指令",[920,5308,5309,5312],{},[45,5310,5311],{},"sn"," 这个应该是设备码",[920,5314,5315,5318],{},[45,5316,5317],{},"key"," 应该是用来操作设备的密钥",[920,5320,5321,5324,5325,5328],{},[45,5322,5323],{},"_api"," 操作类型，我只关心插座的打开关闭，所以设为 ",[45,5326,5327],{},"set_plug_status"," 即可",[920,5330,5331,5334],{},[45,5332,5333],{},"time"," 奇奇怪怪的而参数，也不是 unix 时间戳，反正照抄就行了",[920,5336,5337,5340],{},[45,5338,5339],{},"index"," 原博说是用来给插排操作指定第几个孔位的，我们智能插座直接设置为 0 即可",[20,5342,5343],{},"理论上你用抓出来的 url 已经可以实现公网访问了，但我测试下来并不行，可能是向日葵那边的服务器做了别的校验，比如说判断了 ua 之类的？不过无所谓，我本来就是打算局域网内操作。",[20,5345,5346],{},"登陆路由器后台，寻找疑似智能插座的设备，一般很容易就能找到。",[20,5348,5349],{},[52,5350],{"alt":5351,"src":5352},"路由器后台管理界面","https://static.031130.xyz/uploads/2024/08/12/654277f0d5c2a.webp",[20,5354,5355],{},"使用 nmap 命令扫对应 ip 开放的端口。不知道是不是巧合，我和原博扫出来的端口都是 6767 端口。",[20,5357,5358],{},[52,5359],{"alt":5360,"src":5361},"扫描端口","https://static.031130.xyz/uploads/2024/08/12/654278685f137.webp",[20,5363,5364,5365,5368],{},"将上面抓到的 url 的域名换成 ",[45,5366,5367],{},"ip:port","，https 协议改成 http 协议，在浏览器中直接访问，获得了 0 的状态码，插座也正常开关。",[20,5370,5371],{},[52,5372],{"alt":5373,"src":5374},"浏览器操作测试","https://static.031130.xyz/uploads/2024/08/12/654279513c1f8.webp",{"title":89,"searchDepth":247,"depth":247,"links":5376},[],{"title":5378,"date":5379,"path":5380,"tags":5381,"body":5384},"创建 b23.tv 追踪参数移除 bot","2023-10-29 00:35:48","/2023/10/29/create-b23tv-remover-bot",[4515,5382,5383],"Bot","Privacy",{"type":17,"value":5385,"toc":6470},[5386,5391,5394,5397,5400,5404,5407,5412,5415,5421,5424,5428,5431,5434,5441,5444,5637,5640,5642,5969,5973,5976,5978,6447,6456,6467],[116,5387,5388],{},[20,5389,5390],{},"前两天似乎有人高调宣称自己发 b23.tv 没问题，结果过两天就被拿下的消息。我自己并不是他的粉丝，但这个戏剧性的流言也又一次说明了注重隐私保护的重要性。",[20,5392,5393],{},"早前就有 b23.tf 和 b23.wtf 两个域名专门在做移除追踪参数的事情。只要将短链接中的 b23.tv 改成 b23.tf ，别人访问链接时就会被转到移除了追踪参数的链接。但这需要发送者在分享时手动更改域名。",[20,5395,5396],{},"因此，我也开始为自己的 bot 添加了 b23.tv 的 track id 移除功能。当用户的信息中包含 b23.tv 短链接，将会自动发送一条移除了 track id 的信息，用户就可以直接点击无追踪参数的链接。",[20,5398,5399],{},"当然，这两种方案并不能保护链接分享者的个人信息泄漏，因为 b23.tv 后面的参数是可以被别人看到的，通过这些参数就可以定位到链接分享者的个人信息，所以不能防止群里的内鬼倒查分享者的个人信息，但起码可以阻止大数据算法对群里的几个人产生关联。",[33,5401,5403],{"id":5402},"b23-短链接将会泄漏哪些个人信息","b23 短链接将会泄漏哪些个人信息？",[20,5405,5406],{},"通过 curl 命令，我们就可以看到 b23.tv 短链接重定向到了哪个页面。",[20,5408,5409],{},[52,5410],{"alt":89,"src":5411},"https://static.031130.xyz/uploads/2024/08/12/653d49fe955f7.webp",[20,5413,5414],{},"这是所携带的 GET 请求参数",[84,5416,5419],{"className":5417,"code":5418,"language":748},[746]," 'buvid': ['*************************************'],\n 'from_spmid': ['tm.recommend.0.0'],\n 'is_story_h5': ['false'],\n 'mid': ['************************'],\n 'p': ['1'],\n 'plat_id': ['116'],\n 'share_from': ['ugc'],\n 'share_medium': ['android'],\n 'share_plat': ['android'],\n 'share_session_id': ['************************************'],\n 'share_source': ['GENERIC'],\n 'share_tag': ['s_i'],\n 'spmid': ['united.player-video-detail.0.0'],\n 'timestamp': ['**********'],\n 'unique_k': ['*******'],\n 'up_id': ['*********']\n",[45,5420,5418],{"__ignoreMap":89},[20,5422,5423],{},"其中，我替换成星号的部分都是有可能涉及到信息泄漏的部分，甚至没打码的部分也可以用来推测你的平台信息。",[33,5425,5427],{"id":5426},"qq-bot","QQ Bot",[20,5429,5430],{},"尽管目前腾讯针对 go-cqhttp 的封杀力度挺大的，但我还在用。",[20,5432,5433],{},"在 QQ 中的 b23.tv 追踪参数移除主要有两个方面。一是用户发送的消息中可能含有 b23.tv 短链接，二是用户在手机端直接调用 bilibili 自带的「分享到QQ」的功能，这样的话在 QQ 中会显示为小程序，go-cqhttp 接收到的是一个 json 的 CQ Code。",[20,5435,5436,5437,5440],{},"针对第一种情况，处理起来就相对简单，首先判断用户的信息中是否存在 ",[45,5438,5439],{},"b23.tv"," 这一关键词，然后用正则表达式获取完整的 b23 链接，再使用 python 的 requests 库去请求对应链接，返回带有明文追踪参数的 url 后去除 GET 参数即可。",[20,5442,5443],{},"参考代码如下",[84,5445,5447],{"className":4638,"code":5446,"language":4640,"meta":89,"style":89},"if 'https://b23.tv' in message:\n    pattern = r'https://b23\\.tv/[^\\s]+'\n    urls = re.findall(pattern, message)\n    ret = 'TrackID removed:'\n    for i in urls:\n    ret = ret + '\\n' + b23_to_bvid(i)\n    \ndef b23_to_bvid(url):\n    tracked_url = requests.get(url,allow_redirects=False).headers['location']\n    return tracked_url.split('?', 1)[0]\n",[45,5448,5449,5462,5496,5512,5522,5536,5562,5566,5579,5609],{"__ignoreMap":89},[93,5450,5451,5453,5456,5459],{"class":95,"line":96},[93,5452,3841],{"class":232},[93,5454,5455],{"class":107}," 'https://b23.tv'",[93,5457,5458],{"class":232}," in",[93,5460,5461],{"class":103}," message:\n",[93,5463,5464,5467,5469,5472,5475,5478,5481,5484,5487,5490,5493],{"class":95,"line":247},[93,5465,5466],{"class":103},"    pattern ",[93,5468,2204],{"class":1213},[93,5470,5471],{"class":232}," r",[93,5473,5474],{"class":1383},"'https://b23",[93,5476,5477],{"class":99},"\\.",[93,5479,5480],{"class":1383},"tv/",[93,5482,1094],{"class":5483},"sYebD",[93,5485,5486],{"class":103},"^",[93,5488,5489],{"class":1383},"\\s",[93,5491,5492],{"class":5483},"]+",[93,5494,5495],{"class":1383},"'\n",[93,5497,5498,5501,5503,5506,5509],{"class":95,"line":267},[93,5499,5500],{"class":103},"    urls ",[93,5502,2204],{"class":1213},[93,5504,5505],{"class":103}," re.",[93,5507,5508],{"class":4800},"findall",[93,5510,5511],{"class":103},"(pattern, message)\n",[93,5513,5514,5517,5519],{"class":95,"line":356},[93,5515,5516],{"class":103},"    ret ",[93,5518,2204],{"class":1213},[93,5520,5521],{"class":107}," 'TrackID removed:'\n",[93,5523,5524,5527,5530,5533],{"class":95,"line":3},[93,5525,5526],{"class":232},"    for",[93,5528,5529],{"class":103}," i ",[93,5531,5532],{"class":232},"in",[93,5534,5535],{"class":103}," urls:\n",[93,5537,5538,5540,5542,5545,5547,5549,5552,5554,5556,5559],{"class":95,"line":383},[93,5539,5516],{"class":103},[93,5541,2204],{"class":1213},[93,5543,5544],{"class":103}," ret ",[93,5546,4789],{"class":1213},[93,5548,1568],{"class":107},[93,5550,5551],{"class":99},"\\n",[93,5553,1574],{"class":107},[93,5555,4783],{"class":1213},[93,5557,5558],{"class":4800}," b23_to_bvid",[93,5560,5561],{"class":103},"(i)\n",[93,5563,5564],{"class":95,"line":393},[93,5565,5118],{"class":103},[93,5567,5568,5570,5572,5574,5577],{"class":95,"line":403},[93,5569,4754],{"class":232},[93,5571,5558],{"class":240},[93,5573,104],{"class":103},[93,5575,5576],{"class":4762},"url",[93,5578,1335],{"class":103},[93,5580,5581,5584,5586,5589,5591,5594,5597,5599,5601,5604,5607],{"class":95,"line":413},[93,5582,5583],{"class":103},"    tracked_url ",[93,5585,2204],{"class":1213},[93,5587,5588],{"class":103}," requests.",[93,5590,4801],{"class":4800},[93,5592,5593],{"class":103},"(url,",[93,5595,5596],{"class":4807},"allow_redirects",[93,5598,2204],{"class":1213},[93,5600,5052],{"class":439},[93,5602,5603],{"class":103},").headers[",[93,5605,5606],{"class":107},"'location'",[93,5608,1197],{"class":103},[93,5610,5611,5614,5617,5620,5622,5625,5627,5629,5632,5635],{"class":95,"line":430},[93,5612,5613],{"class":232},"    return",[93,5615,5616],{"class":103}," tracked_url.",[93,5618,5619],{"class":4800},"split",[93,5621,104],{"class":103},[93,5623,5624],{"class":107},"'?'",[93,5626,324],{"class":103},[93,5628,4822],{"class":439},[93,5630,5631],{"class":103},")[",[93,5633,5634],{"class":439},"0",[93,5636,1197],{"class":103},[20,5638,5639],{},"而针对第二种情况，则需要先解析对应的 json 信息，再参考第一种方法获取无追踪参数的链接。",[20,5641,5443],{},[84,5643,5645],{"className":4638,"code":5644,"language":4640,"meta":89,"style":89},"if message.startswith('[CQ:json,data') and 'b23.tv' in message:\n    decoded_data = html.unescape(message)\n    match = re.search(r'\\[CQ:json,data=(\\{.*?\\})\\]', decoded_data)\n    json_str = match.group(1)\n    json_data = json.loads(json_str)\n    if json_data['meta'].get('detail_1') is not None:\n        raw_url = json_data['meta'].get('detail_1').get('qqdocurl')\n    elif json_data['meta'].get('news') is not None:\n        raw_url = json_data['meta'].get('news').get('jumpUrl')\n    clean_url = b23_to_bvid(raw_url)\n    \ndef b23_to_bvid(url):\n    tracked_url = requests.get(url,allow_redirects=False).headers['location']\n    return tracked_url.split('?', 1)[0]\n",[45,5646,5647,5674,5690,5740,5759,5775,5808,5839,5866,5895,5907,5911,5923,5947],{"__ignoreMap":89},[93,5648,5649,5651,5654,5657,5659,5662,5664,5667,5670,5672],{"class":95,"line":96},[93,5650,3841],{"class":232},[93,5652,5653],{"class":103}," message.",[93,5655,5656],{"class":4800},"startswith",[93,5658,104],{"class":103},[93,5660,5661],{"class":107},"'[CQ:json,data'",[93,5663,3853],{"class":103},[93,5665,5666],{"class":232},"and",[93,5668,5669],{"class":107}," 'b23.tv'",[93,5671,5458],{"class":232},[93,5673,5461],{"class":103},[93,5675,5676,5679,5681,5684,5687],{"class":95,"line":247},[93,5677,5678],{"class":103},"    decoded_data ",[93,5680,2204],{"class":1213},[93,5682,5683],{"class":103}," html.",[93,5685,5686],{"class":4800},"unescape",[93,5688,5689],{"class":103},"(message)\n",[93,5691,5692,5695,5697,5699,5702,5704,5707,5709,5712,5715,5718,5721,5723,5726,5729,5732,5735,5737],{"class":95,"line":267},[93,5693,5694],{"class":103},"    match ",[93,5696,2204],{"class":1213},[93,5698,5505],{"class":103},[93,5700,5701],{"class":4800},"search",[93,5703,104],{"class":103},[93,5705,5706],{"class":232},"r",[93,5708,1574],{"class":1383},[93,5710,5711],{"class":99},"\\[",[93,5713,5714],{"class":1383},"CQ:json,data=",[93,5716,104],{"class":5717},"sYoRg",[93,5719,5720],{"class":99},"\\{",[93,5722,302],{"class":1383},[93,5724,5725],{"class":5483},"*?",[93,5727,5728],{"class":99},"\\}",[93,5730,5731],{"class":5717},")",[93,5733,5734],{"class":99},"\\]",[93,5736,1574],{"class":1383},[93,5738,5739],{"class":103},", decoded_data)\n",[93,5741,5742,5745,5747,5750,5753,5755,5757],{"class":95,"line":356},[93,5743,5744],{"class":103},"    json_str ",[93,5746,2204],{"class":1213},[93,5748,5749],{"class":103}," match.",[93,5751,5752],{"class":4800},"group",[93,5754,104],{"class":103},[93,5756,4822],{"class":439},[93,5758,496],{"class":103},[93,5760,5761,5764,5766,5769,5772],{"class":95,"line":3},[93,5762,5763],{"class":103},"    json_data ",[93,5765,2204],{"class":1213},[93,5767,5768],{"class":103}," json.",[93,5770,5771],{"class":4800},"loads",[93,5773,5774],{"class":103},"(json_str)\n",[93,5776,5777,5779,5782,5785,5788,5790,5792,5795,5797,5800,5803,5806],{"class":95,"line":383},[93,5778,4989],{"class":232},[93,5780,5781],{"class":103}," json_data[",[93,5783,5784],{"class":107},"'meta'",[93,5786,5787],{"class":103},"].",[93,5789,4801],{"class":4800},[93,5791,104],{"class":103},[93,5793,5794],{"class":107},"'detail_1'",[93,5796,3853],{"class":103},[93,5798,5799],{"class":232},"is",[93,5801,5802],{"class":232}," not",[93,5804,5805],{"class":439}," None",[93,5807,1644],{"class":103},[93,5809,5810,5813,5815,5817,5819,5821,5823,5825,5827,5830,5832,5834,5837],{"class":95,"line":393},[93,5811,5812],{"class":103},"        raw_url ",[93,5814,2204],{"class":1213},[93,5816,5781],{"class":103},[93,5818,5784],{"class":107},[93,5820,5787],{"class":103},[93,5822,4801],{"class":4800},[93,5824,104],{"class":103},[93,5826,5794],{"class":107},[93,5828,5829],{"class":103},").",[93,5831,4801],{"class":4800},[93,5833,104],{"class":103},[93,5835,5836],{"class":107},"'qqdocurl'",[93,5838,496],{"class":103},[93,5840,5841,5843,5845,5847,5849,5851,5853,5856,5858,5860,5862,5864],{"class":95,"line":403},[93,5842,5026],{"class":232},[93,5844,5781],{"class":103},[93,5846,5784],{"class":107},[93,5848,5787],{"class":103},[93,5850,4801],{"class":4800},[93,5852,104],{"class":103},[93,5854,5855],{"class":107},"'news'",[93,5857,3853],{"class":103},[93,5859,5799],{"class":232},[93,5861,5802],{"class":232},[93,5863,5805],{"class":439},[93,5865,1644],{"class":103},[93,5867,5868,5870,5872,5874,5876,5878,5880,5882,5884,5886,5888,5890,5893],{"class":95,"line":413},[93,5869,5812],{"class":103},[93,5871,2204],{"class":1213},[93,5873,5781],{"class":103},[93,5875,5784],{"class":107},[93,5877,5787],{"class":103},[93,5879,4801],{"class":4800},[93,5881,104],{"class":103},[93,5883,5855],{"class":107},[93,5885,5829],{"class":103},[93,5887,4801],{"class":4800},[93,5889,104],{"class":103},[93,5891,5892],{"class":107},"'jumpUrl'",[93,5894,496],{"class":103},[93,5896,5897,5900,5902,5904],{"class":95,"line":430},[93,5898,5899],{"class":103},"    clean_url ",[93,5901,2204],{"class":1213},[93,5903,5558],{"class":4800},[93,5905,5906],{"class":103},"(raw_url)\n",[93,5908,5909],{"class":95,"line":446},[93,5910,5118],{"class":103},[93,5912,5913,5915,5917,5919,5921],{"class":95,"line":459},[93,5914,4754],{"class":232},[93,5916,5558],{"class":240},[93,5918,104],{"class":103},[93,5920,5576],{"class":4762},[93,5922,1335],{"class":103},[93,5924,5925,5927,5929,5931,5933,5935,5937,5939,5941,5943,5945],{"class":95,"line":465},[93,5926,5583],{"class":103},[93,5928,2204],{"class":1213},[93,5930,5588],{"class":103},[93,5932,4801],{"class":4800},[93,5934,5593],{"class":103},[93,5936,5596],{"class":4807},[93,5938,2204],{"class":1213},[93,5940,5052],{"class":439},[93,5942,5603],{"class":103},[93,5944,5606],{"class":107},[93,5946,1197],{"class":103},[93,5948,5949,5951,5953,5955,5957,5959,5961,5963,5965,5967],{"class":95,"line":471},[93,5950,5613],{"class":232},[93,5952,5616],{"class":103},[93,5954,5619],{"class":4800},[93,5956,104],{"class":103},[93,5958,5624],{"class":107},[93,5960,324],{"class":103},[93,5962,4822],{"class":439},[93,5964,5631],{"class":103},[93,5966,5634],{"class":439},[93,5968,1197],{"class":103},[33,5970,5972],{"id":5971},"tg-bot","TG Bot",[20,5974,5975],{},"这个平台是提供了 Bot 的 API 的，所以也不用担心会被官方封杀，可惜用户访问起来可能相对困难，也不能要求所有联系人都迁移到这个平台上。思路也是一样的，用 requests 去请求 b23 短链，返回去除跟踪参数的 url。",[20,5977,5443],{},[84,5979,5981],{"className":4638,"code":5980,"language":4640,"meta":89,"style":89},"from telegram import Update\nfrom telegram.ext import ApplicationBuilder, ContextTypes, CommandHandler, MessageHandler, filters\nimport requests\nimport re\n\nua = 'Mozilla/5.0 (X11; Linux x86_64; rv:120.0) Gecko/20100101 Firefox/120.0'\n\nasync def start(update: Update, context):\n    await context.bot.send_message(chat_id=update.effective_chat.id, text=\"Hello World!\")\n    \nasync def b23_remover(update: Update, context):\n    seng_msg = 'TrackID removed:'\n    if 'https://b23.tv' in update.message.text:\n        pattern = r'https://b23\\.tv/[^\\s]+'\n        urls = re.findall(pattern, update.message.text)\n        for i in urls:\n            seng_msg += '\\n' + await b23_to_bvid(i)\n        await context.bot.send_message(chat_id=update.effective_chat.id, text=seng_msg)\n        \nasync def b23_to_bvid(url):\n    tracked_url = requests.get(url,allow_redirects=False,headers={'User-Agent': ua}).headers['Location']\n    return tracked_url.split('?', 1)[0]\n    \nstart_handler = CommandHandler(\"start\", start)\nb23_remove_handler = MessageHandler(filters.TEXT, b23_remover)\n\nif __name__ == '__main__':\n    TOKEN='**********************************************'\n    application = ApplicationBuilder().token(TOKEN).build()\n    application.add_handler(start_handler)\n    application.add_handler(b23_remove_handler)\n    application.run_polling()\n\n",[45,5982,5983,5996,6008,6014,6021,6025,6035,6039,6067,6097,6101,6124,6133,6144,6169,6183,6194,6217,6241,6246,6260,6299,6321,6325,6343,6362,6366,6380,6390,6418,6429,6438],{"__ignoreMap":89},[93,5984,5985,5988,5991,5993],{"class":95,"line":96},[93,5986,5987],{"class":232},"from",[93,5989,5990],{"class":103}," telegram ",[93,5992,4656],{"class":232},[93,5994,5995],{"class":103}," Update\n",[93,5997,5998,6000,6003,6005],{"class":95,"line":247},[93,5999,5987],{"class":232},[93,6001,6002],{"class":103}," telegram.ext ",[93,6004,4656],{"class":232},[93,6006,6007],{"class":103}," ApplicationBuilder, ContextTypes, CommandHandler, MessageHandler, filters\n",[93,6009,6010,6012],{"class":95,"line":267},[93,6011,4656],{"class":232},[93,6013,4672],{"class":103},[93,6015,6016,6018],{"class":95,"line":356},[93,6017,4656],{"class":232},[93,6019,6020],{"class":103}," re\n",[93,6022,6023],{"class":95,"line":3},[93,6024,353],{"emptyLinePlaceholder":352},[93,6026,6027,6030,6032],{"class":95,"line":383},[93,6028,6029],{"class":103},"ua ",[93,6031,2204],{"class":1213},[93,6033,6034],{"class":107}," 'Mozilla/5.0 (X11; Linux x86_64; rv:120.0) Gecko/20100101 Firefox/120.0'\n",[93,6036,6037],{"class":95,"line":393},[93,6038,353],{"emptyLinePlaceholder":352},[93,6040,6041,6044,6047,6050,6052,6055,6057,6060,6062,6065],{"class":95,"line":403},[93,6042,6043],{"class":232},"async",[93,6045,6046],{"class":232}," def",[93,6048,6049],{"class":240}," start",[93,6051,104],{"class":103},[93,6053,6054],{"class":4762},"update",[93,6056,255],{"class":103},[93,6058,6059],{"class":1835}," Update",[93,6061,1403],{"class":103},[93,6063,6064],{"class":4762}," context",[93,6066,1335],{"class":103},[93,6068,6069,6072,6075,6078,6080,6083,6085,6088,6090,6092,6095],{"class":95,"line":413},[93,6070,6071],{"class":232},"    await",[93,6073,6074],{"class":103}," context.bot.",[93,6076,6077],{"class":4800},"send_message",[93,6079,104],{"class":103},[93,6081,6082],{"class":4807},"chat_id",[93,6084,2204],{"class":1213},[93,6086,6087],{"class":103},"update.effective_chat.id, ",[93,6089,748],{"class":4807},[93,6091,2204],{"class":1213},[93,6093,6094],{"class":107},"\"Hello World!\"",[93,6096,496],{"class":103},[93,6098,6099],{"class":95,"line":430},[93,6100,5118],{"class":103},[93,6102,6103,6105,6107,6110,6112,6114,6116,6118,6120,6122],{"class":95,"line":446},[93,6104,6043],{"class":232},[93,6106,6046],{"class":232},[93,6108,6109],{"class":240}," b23_remover",[93,6111,104],{"class":103},[93,6113,6054],{"class":4762},[93,6115,255],{"class":103},[93,6117,6059],{"class":1835},[93,6119,1403],{"class":103},[93,6121,6064],{"class":4762},[93,6123,1335],{"class":103},[93,6125,6126,6129,6131],{"class":95,"line":459},[93,6127,6128],{"class":103},"    seng_msg ",[93,6130,2204],{"class":1213},[93,6132,5521],{"class":107},[93,6134,6135,6137,6139,6141],{"class":95,"line":465},[93,6136,4989],{"class":232},[93,6138,5455],{"class":107},[93,6140,5458],{"class":232},[93,6142,6143],{"class":103}," update.message.text:\n",[93,6145,6146,6149,6151,6153,6155,6157,6159,6161,6163,6165,6167],{"class":95,"line":471},[93,6147,6148],{"class":103},"        pattern ",[93,6150,2204],{"class":1213},[93,6152,5471],{"class":232},[93,6154,5474],{"class":1383},[93,6156,5477],{"class":99},[93,6158,5480],{"class":1383},[93,6160,1094],{"class":5483},[93,6162,5486],{"class":103},[93,6164,5489],{"class":1383},[93,6166,5492],{"class":5483},[93,6168,5495],{"class":1383},[93,6170,6171,6174,6176,6178,6180],{"class":95,"line":477},[93,6172,6173],{"class":103},"        urls ",[93,6175,2204],{"class":1213},[93,6177,5505],{"class":103},[93,6179,5508],{"class":4800},[93,6181,6182],{"class":103},"(pattern, update.message.text)\n",[93,6184,6185,6188,6190,6192],{"class":95,"line":483},[93,6186,6187],{"class":232},"        for",[93,6189,5529],{"class":103},[93,6191,5532],{"class":232},[93,6193,5535],{"class":103},[93,6195,6196,6199,6202,6204,6206,6208,6210,6213,6215],{"class":95,"line":499},[93,6197,6198],{"class":103},"            seng_msg ",[93,6200,6201],{"class":1213},"+=",[93,6203,1568],{"class":107},[93,6205,5551],{"class":99},[93,6207,1574],{"class":107},[93,6209,4783],{"class":1213},[93,6211,6212],{"class":232}," await",[93,6214,5558],{"class":4800},[93,6216,5561],{"class":103},[93,6218,6219,6222,6224,6226,6228,6230,6232,6234,6236,6238],{"class":95,"line":1435},[93,6220,6221],{"class":232},"        await",[93,6223,6074],{"class":103},[93,6225,6077],{"class":4800},[93,6227,104],{"class":103},[93,6229,6082],{"class":4807},[93,6231,2204],{"class":1213},[93,6233,6087],{"class":103},[93,6235,748],{"class":4807},[93,6237,2204],{"class":1213},[93,6239,6240],{"class":103},"seng_msg)\n",[93,6242,6243],{"class":95,"line":1459},[93,6244,6245],{"class":103},"        \n",[93,6247,6248,6250,6252,6254,6256,6258],{"class":95,"line":1466},[93,6249,6043],{"class":232},[93,6251,6046],{"class":232},[93,6253,5558],{"class":240},[93,6255,104],{"class":103},[93,6257,5576],{"class":4762},[93,6259,1335],{"class":103},[93,6261,6262,6264,6266,6268,6270,6272,6274,6276,6278,6280,6283,6285,6288,6291,6294,6297],{"class":95,"line":1471},[93,6263,5583],{"class":103},[93,6265,2204],{"class":1213},[93,6267,5588],{"class":103},[93,6269,4801],{"class":4800},[93,6271,5593],{"class":103},[93,6273,5596],{"class":4807},[93,6275,2204],{"class":1213},[93,6277,5052],{"class":439},[93,6279,1403],{"class":103},[93,6281,6282],{"class":4807},"headers",[93,6284,2204],{"class":1213},[93,6286,6287],{"class":103},"{",[93,6289,6290],{"class":107},"'User-Agent'",[93,6292,6293],{"class":103},": ua}).headers[",[93,6295,6296],{"class":107},"'Location'",[93,6298,1197],{"class":103},[93,6300,6301,6303,6305,6307,6309,6311,6313,6315,6317,6319],{"class":95,"line":1477},[93,6302,5613],{"class":232},[93,6304,5616],{"class":103},[93,6306,5619],{"class":4800},[93,6308,104],{"class":103},[93,6310,5624],{"class":107},[93,6312,324],{"class":103},[93,6314,4822],{"class":439},[93,6316,5631],{"class":103},[93,6318,5634],{"class":439},[93,6320,1197],{"class":103},[93,6322,6323],{"class":95,"line":1483},[93,6324,5118],{"class":103},[93,6326,6327,6330,6332,6335,6337,6340],{"class":95,"line":1488},[93,6328,6329],{"class":103},"start_handler ",[93,6331,2204],{"class":1213},[93,6333,6334],{"class":4800}," CommandHandler",[93,6336,104],{"class":103},[93,6338,6339],{"class":107},"\"start\"",[93,6341,6342],{"class":103},", start)\n",[93,6344,6345,6348,6350,6353,6356,6359],{"class":95,"line":1528},[93,6346,6347],{"class":103},"b23_remove_handler ",[93,6349,2204],{"class":1213},[93,6351,6352],{"class":4800}," MessageHandler",[93,6354,6355],{"class":103},"(filters.",[93,6357,6358],{"class":5483},"TEXT",[93,6360,6361],{"class":103},", b23_remover)\n",[93,6363,6364],{"class":95,"line":1535},[93,6365,353],{"emptyLinePlaceholder":352},[93,6367,6368,6370,6373,6375,6378],{"class":95,"line":1540},[93,6369,3841],{"class":232},[93,6371,6372],{"class":250}," __name__",[93,6374,1319],{"class":1213},[93,6376,6377],{"class":107}," '__main__'",[93,6379,1644],{"class":103},[93,6381,6382,6385,6387],{"class":95,"line":1546},[93,6383,6384],{"class":5483},"    TOKEN",[93,6386,2204],{"class":1213},[93,6388,6389],{"class":107},"'**********************************************'\n",[93,6391,6392,6395,6397,6400,6403,6406,6408,6411,6413,6416],{"class":95,"line":1552},[93,6393,6394],{"class":103},"    application ",[93,6396,2204],{"class":1213},[93,6398,6399],{"class":4800}," ApplicationBuilder",[93,6401,6402],{"class":103},"().",[93,6404,6405],{"class":4800},"token",[93,6407,104],{"class":103},[93,6409,6410],{"class":5483},"TOKEN",[93,6412,5829],{"class":103},[93,6414,6415],{"class":4800},"build",[93,6417,5227],{"class":103},[93,6419,6420,6423,6426],{"class":95,"line":1557},[93,6421,6422],{"class":103},"    application.",[93,6424,6425],{"class":4800},"add_handler",[93,6427,6428],{"class":103},"(start_handler)\n",[93,6430,6431,6433,6435],{"class":95,"line":1603},[93,6432,6422],{"class":103},[93,6434,6425],{"class":4800},[93,6436,6437],{"class":103},"(b23_remove_handler)\n",[93,6439,6440,6442,6445],{"class":95,"line":1610},[93,6441,6422],{"class":103},[93,6443,6444],{"class":4800},"run_polling",[93,6446,5227],{"class":103},[20,6448,6449,6450,6455],{},"代码编写参考了 ",[24,6451,6454],{"href":6452,"rel":6453},"https://krau.top/posts/tg-bot-dev-note-kmua",[73],"柯罗krau的博客 | krau's blog","，使用时请注意以下问题:",[1244,6457,6458,6461,6464],{},[920,6459,6460],{},"你的机子是否拥有能访问到对应的 api 的网络环境",[920,6462,6463],{},"botfather 那边是否打开了 allow group",[920,6465,6466],{},"botfather 那边是否关闭了 privacy mode",[530,6468,6469],{},"html pre.shiki code .sLKXg, html code.shiki .sLKXg{--shiki-default:#A626A4;--shiki-dark:#C678DD}html pre.shiki code .sDhpE, html code.shiki .sDhpE{--shiki-default:#50A14F;--shiki-dark:#98C379}html pre.shiki code .s5ixo, html code.shiki .s5ixo{--shiki-default:#383A42;--shiki-dark:#ABB2BF}html pre.shiki code .sknuh, html code.shiki .sknuh{--shiki-default:#383A42;--shiki-dark:#56B6C2}html pre.shiki code .sDaw7, html code.shiki .sDaw7{--shiki-default:#0184BC;--shiki-dark:#E06C75}html pre.shiki code .s_Sar, html code.shiki .s_Sar{--shiki-default:#0184BC;--shiki-dark:#56B6C2}html pre.shiki code .sYebD, html code.shiki .sYebD{--shiki-default:#383A42;--shiki-dark:#D19A66}html pre.shiki code .slOjB, html code.shiki .slOjB{--shiki-default:#383A42;--shiki-dark:#61AFEF}html pre.shiki code .sAdtL, html code.shiki .sAdtL{--shiki-default:#4078F2;--shiki-dark:#61AFEF}html pre.shiki code .so_Uh, html code.shiki .so_Uh{--shiki-default:#986801;--shiki-default-font-style:inherit;--shiki-dark:#D19A66;--shiki-dark-font-style:italic}html pre.shiki code .sp7wS, html code.shiki .sp7wS{--shiki-default:#986801;--shiki-default-font-style:inherit;--shiki-dark:#E06C75;--shiki-dark-font-style:italic}html pre.shiki code .sAGMh, html code.shiki .sAGMh{--shiki-default:#986801;--shiki-dark:#D19A66}html .default .shiki span {color: var(--shiki-default);background: var(--shiki-default-bg);font-style: var(--shiki-default-font-style);font-weight: var(--shiki-default-font-weight);text-decoration: var(--shiki-default-text-decoration);}html .shiki span {color: var(--shiki-default);background: var(--shiki-default-bg);font-style: var(--shiki-default-font-style);font-weight: var(--shiki-default-font-weight);text-decoration: var(--shiki-default-text-decoration);}html .dark .shiki span {color: var(--shiki-dark);background: var(--shiki-dark-bg);font-style: var(--shiki-dark-font-style);font-weight: var(--shiki-dark-font-weight);text-decoration: var(--shiki-dark-text-decoration);}html.dark .shiki span {color: var(--shiki-dark);background: var(--shiki-dark-bg);font-style: var(--shiki-dark-font-style);font-weight: var(--shiki-dark-font-weight);text-decoration: var(--shiki-dark-text-decoration);}html pre.shiki code .sYoRg, html code.shiki .sYoRg{--shiki-default:#0184BC;--shiki-dark:#D19A66}html pre.shiki code .sxymB, html code.shiki .sxymB{--shiki-default:#986801;--shiki-dark:#ABB2BF}html pre.shiki code .sJa8x, html code.shiki .sJa8x{--shiki-default:#E45649;--shiki-dark:#E06C75}",{"title":89,"searchDepth":247,"depth":247,"links":6471},[6472,6473,6474],{"id":5402,"depth":247,"text":5403},{"id":5426,"depth":247,"text":5427},{"id":5971,"depth":247,"text":5972},{"title":6476,"date":6477,"path":6478,"tags":6479,"body":6481},"jinja2 中如何优雅地实现换行","2023-09-03 13:37:35","/2023/09/03/jinja2-nl-to-br",[4514,4515,6480,3976],"jinja2",{"type":17,"value":6482,"toc":6784},[6483,6492,6502,6752,6755,6763,6774,6781],[20,6484,6485,6486,6488,6489,6491],{},"在使用 python 的 jinja2 模板引擎生成 html 的时候，会遇到 ",[45,6487,5551],{}," 换行符无法被正常换行的问题。我本能的想法就是将 ",[45,6490,5551],{}," 替换成 html 标签 \u003Cbr />，但失败了，jinja2 有自动转义的功能，直接将标签原模原样地渲染了出来，并没有生效。而为这一段代码块关闭自动转义则会有被 js 注入的风险，因此这也不是上策。",[20,6493,6494,6495,6497,6498],{},"在 jinja2 的官方文档中，提出了使用 filter 的方案。也就是说，filter 将 ",[45,6496,5551],{}," 识别出来，并自动替换成 \u003Cbr /> 标签，并且使用 Markup 函数将这一段 html 文本标记成安全且无需转义的。见: ",[24,6499,6500],{"href":6500,"rel":6501},"https://jinja.palletsprojects.com/en/3.1.x/api/#custom-filters",[73],[116,6503,6504],{},[84,6505,6507],{"className":4638,"code":6506,"language":4640,"meta":89,"style":89},"import re\nfrom jinja2 import pass_eval_context\nfrom markupsafe import Markup, escape\n\n@pass_eval_context\ndef nl2br(eval_ctx, value):\n    br = \"\u003Cbr>\\n\"\n\n    if eval_ctx.autoescape:\n        value = escape(value)\n        br = Markup(br)\n\n    result = \"\\n\\n\".join(\n        f\"\u003Cp>{br.join(p.splitlines())}\u003C\\p>\"\n        for p in re.split(r\"(?:\\r\\n|\\r(?!\\n)|\\n){2,}\", value)\n    )\n    return Markup(result) if autoescape else result\n",[45,6508,6509,6515,6527,6539,6543,6548,6567,6582,6586,6593,6606,6619,6623,6647,6677,6728,6733],{"__ignoreMap":89},[93,6510,6511,6513],{"class":95,"line":96},[93,6512,4656],{"class":232},[93,6514,6020],{"class":103},[93,6516,6517,6519,6522,6524],{"class":95,"line":247},[93,6518,5987],{"class":232},[93,6520,6521],{"class":103}," jinja2 ",[93,6523,4656],{"class":232},[93,6525,6526],{"class":103}," pass_eval_context\n",[93,6528,6529,6531,6534,6536],{"class":95,"line":267},[93,6530,5987],{"class":232},[93,6532,6533],{"class":103}," markupsafe ",[93,6535,4656],{"class":232},[93,6537,6538],{"class":103}," Markup, escape\n",[93,6540,6541],{"class":95,"line":356},[93,6542,353],{"emptyLinePlaceholder":352},[93,6544,6545],{"class":95,"line":3},[93,6546,6547],{"class":240},"@pass_eval_context\n",[93,6549,6550,6552,6555,6557,6560,6562,6565],{"class":95,"line":383},[93,6551,4754],{"class":232},[93,6553,6554],{"class":240}," nl2br",[93,6556,104],{"class":103},[93,6558,6559],{"class":4762},"eval_ctx",[93,6561,1403],{"class":103},[93,6563,6564],{"class":4762}," value",[93,6566,1335],{"class":103},[93,6568,6569,6572,6574,6577,6579],{"class":95,"line":393},[93,6570,6571],{"class":103},"    br ",[93,6573,2204],{"class":1213},[93,6575,6576],{"class":107}," \"\u003Cbr>",[93,6578,5551],{"class":99},[93,6580,6581],{"class":107},"\"\n",[93,6583,6584],{"class":95,"line":403},[93,6585,353],{"emptyLinePlaceholder":352},[93,6587,6588,6590],{"class":95,"line":413},[93,6589,4989],{"class":232},[93,6591,6592],{"class":103}," eval_ctx.autoescape:\n",[93,6594,6595,6598,6600,6603],{"class":95,"line":430},[93,6596,6597],{"class":103},"        value ",[93,6599,2204],{"class":1213},[93,6601,6602],{"class":4800}," escape",[93,6604,6605],{"class":103},"(value)\n",[93,6607,6608,6611,6613,6616],{"class":95,"line":446},[93,6609,6610],{"class":103},"        br ",[93,6612,2204],{"class":1213},[93,6614,6615],{"class":4800}," Markup",[93,6617,6618],{"class":103},"(br)\n",[93,6620,6621],{"class":95,"line":459},[93,6622,353],{"emptyLinePlaceholder":352},[93,6624,6625,6628,6630,6633,6636,6639,6641,6644],{"class":95,"line":465},[93,6626,6627],{"class":103},"    result ",[93,6629,2204],{"class":1213},[93,6631,6632],{"class":107}," \"",[93,6634,6635],{"class":99},"\\n\\n",[93,6637,6638],{"class":107},"\"",[93,6640,302],{"class":103},[93,6642,6643],{"class":4800},"join",[93,6645,6646],{"class":103},"(\n",[93,6648,6649,6652,6655,6657,6660,6662,6665,6668,6671,6674],{"class":95,"line":471},[93,6650,6651],{"class":232},"        f",[93,6653,6654],{"class":107},"\"\u003Cp>",[93,6656,6287],{"class":439},[93,6658,6659],{"class":103},"br.",[93,6661,6643],{"class":4800},[93,6663,6664],{"class":103},"(p.",[93,6666,6667],{"class":4800},"splitlines",[93,6669,6670],{"class":103},"())",[93,6672,6673],{"class":439},"}",[93,6675,6676],{"class":107},"\u003C\\p>\"\n",[93,6678,6679,6681,6684,6686,6688,6690,6692,6694,6696,6699,6702,6705,6708,6711,6713,6716,6718,6720,6723,6725],{"class":95,"line":477},[93,6680,6187],{"class":232},[93,6682,6683],{"class":103}," p ",[93,6685,5532],{"class":232},[93,6687,5505],{"class":103},[93,6689,5619],{"class":4800},[93,6691,104],{"class":103},[93,6693,5706],{"class":232},[93,6695,6638],{"class":1383},[93,6697,6698],{"class":5717},"(?:",[93,6700,6701],{"class":99},"\\r\\n",[93,6703,6704],{"class":103},"|",[93,6706,6707],{"class":99},"\\r",[93,6709,6710],{"class":103},"(?!",[93,6712,5551],{"class":99},[93,6714,6715],{"class":103},")|",[93,6717,5551],{"class":99},[93,6719,5731],{"class":5717},[93,6721,6722],{"class":5483},"{2,}",[93,6724,6638],{"class":1383},[93,6726,6727],{"class":103},", value)\n",[93,6729,6730],{"class":95,"line":483},[93,6731,6732],{"class":103},"    )\n",[93,6734,6735,6737,6739,6742,6744,6747,6749],{"class":95,"line":499},[93,6736,5613],{"class":232},[93,6738,6615],{"class":4800},[93,6740,6741],{"class":103},"(result) ",[93,6743,3841],{"class":232},[93,6745,6746],{"class":103}," autoescape ",[93,6748,4831],{"class":232},[93,6750,6751],{"class":103}," result\n",[20,6753,6754],{},"使用这段代码后，我遇到了连续两个换行符被识别成一个换行符的问题，依然不满意。",[20,6756,216,6757,6762],{},[24,6758,6761],{"href":6759,"rel":6760},"https://github.com/pallets/flask/issues/2628",[73],"issue#2628"," 中，我找到了一个相对优雅的解决方案——使用 css 样式来完成这个任务。",[20,6764,6765,6766,6769,6770,6773],{},"通过设置 ",[45,6767,6768],{},"white-space: pre-line;"," 的 css 样式，html 在被渲染时将会不再忽略换行符，浏览器就能够在没有 br 标签标注的情况下实现自动换行。而如果设置为 ",[45,6771,6772],{},"white-space: pre-wrap;"," 则多个空格将不会再被合并成一个空格，直接治好了我在入门 html 时的各种不适。",[20,6775,6776,6777,6780],{},"此外，通过 ",[45,6778,6779],{},"word-break: break-word;"," 的 css 样式可以实现只有当一个单词一整行都显示不下时，才会拆分换行该单词的效果，可以避免 break-all 拆分所有单词或者 normal 时遇到长单词直接元素溢出的问题。",[530,6782,6783],{},"html pre.shiki code .sLKXg, html code.shiki .sLKXg{--shiki-default:#A626A4;--shiki-dark:#C678DD}html pre.shiki code .s5ixo, html code.shiki .s5ixo{--shiki-default:#383A42;--shiki-dark:#ABB2BF}html pre.shiki code .sAdtL, html code.shiki .sAdtL{--shiki-default:#4078F2;--shiki-dark:#61AFEF}html pre.shiki code .so_Uh, html code.shiki .so_Uh{--shiki-default:#986801;--shiki-default-font-style:inherit;--shiki-dark:#D19A66;--shiki-dark-font-style:italic}html pre.shiki code .sknuh, html code.shiki .sknuh{--shiki-default:#383A42;--shiki-dark:#56B6C2}html pre.shiki code .sDhpE, html code.shiki .sDhpE{--shiki-default:#50A14F;--shiki-dark:#98C379}html pre.shiki code .s_Sar, html code.shiki .s_Sar{--shiki-default:#0184BC;--shiki-dark:#56B6C2}html pre.shiki code .slOjB, html code.shiki .slOjB{--shiki-default:#383A42;--shiki-dark:#61AFEF}html pre.shiki code .sAGMh, html code.shiki .sAGMh{--shiki-default:#986801;--shiki-dark:#D19A66}html pre.shiki code .sDaw7, html code.shiki .sDaw7{--shiki-default:#0184BC;--shiki-dark:#E06C75}html pre.shiki code .sYoRg, html code.shiki .sYoRg{--shiki-default:#0184BC;--shiki-dark:#D19A66}html pre.shiki code .sYebD, html code.shiki .sYebD{--shiki-default:#383A42;--shiki-dark:#D19A66}html .default .shiki span {color: var(--shiki-default);background: var(--shiki-default-bg);font-style: var(--shiki-default-font-style);font-weight: var(--shiki-default-font-weight);text-decoration: var(--shiki-default-text-decoration);}html .shiki span {color: var(--shiki-default);background: var(--shiki-default-bg);font-style: var(--shiki-default-font-style);font-weight: var(--shiki-default-font-weight);text-decoration: var(--shiki-default-text-decoration);}html .dark .shiki span {color: var(--shiki-dark);background: var(--shiki-dark-bg);font-style: var(--shiki-dark-font-style);font-weight: var(--shiki-dark-font-weight);text-decoration: var(--shiki-dark-text-decoration);}html.dark .shiki span {color: var(--shiki-dark);background: var(--shiki-dark-bg);font-style: var(--shiki-dark-font-style);font-weight: var(--shiki-dark-font-weight);text-decoration: var(--shiki-dark-text-decoration);}",{"title":89,"searchDepth":247,"depth":247,"links":6785},[],{"title":6787,"date":6788,"path":6789,"tags":6790,"body":6793},"手动指定 python-selenium 的 driver path 以解决在中国大陆网络环境下启动卡住的问题","2023-09-02 01:59:18","/2023/09/02/python-selenium-start-difficult-in-china-mainland",[4515,6791,4514,6792],"selenium","Firefox",{"type":17,"value":6794,"toc":7205},[6795,6804,6807,6925,6933,6938,6941,6954,6962,7080,7083,7199,7202],[20,6796,6797,6798,6803],{},"之前因为学校社团迎新的需求，就临时写了一个 QQ Bot，最近又给 bot 加上了 ",[24,6799,6802],{"href":6800,"rel":6801},"https://github.com/zhullyb/qq-quote-generator",[73],"/q 的功能","，原理是通过 python 的 selenium 去启动一个 headless Firefox 去截由 jinja2 模板引擎生成的 html 的图。",[20,6805,6806],{},"每次这个 bot 重启的时候都因为 selenium 而需要花费好几秒的时间，甚至经常概率性启动失败。我就寻思者应该把这个图片生成的 generator 从 bot 中抽出来，这样就不至于每次重启 bot 都要遭此一劫。但就在我将 generator 打包成 docker 部署上云服务器的时候，发现居然无法启动。于是手动进 docker 的 shell 开 python 的交互式终端，发现在创建 firefox 的 webdriver 对象的时候异常缓慢，等了半分钟以后蹲到一个报错如下:",[84,6808,6812],{"className":6809,"code":6810,"language":6811,"meta":89,"style":89},"language-pyth shiki shiki-themes one-light one-dark-pro","Traceback (most recent call last):\n  File \"/usr/local/lib/python3.11/site-packages/selenium/webdriver/common/driver_finder.py\", line 38, in get_path\n    path = SeleniumManager().driver_location(options) if path is None else path\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/usr/local/lib/python3.11/site-packages/selenium/webdriver/common/selenium_manager.py\", line 95, in driver_location\n    output = self.run(args)\n             ^^^^^^^^^^^^^^\n  File \"/usr/local/lib/python3.11/site-packages/selenium/webdriver/common/selenium_manager.py\", line 141, in run\n    raise WebDriverException(f\"Unsuccessful command executed: {command}.\\n{result}{stderr}\")\nselenium.common.exceptions.WebDriverException: Message: Unsuccessful command executed: /usr/local/lib/python3.11/site-packages/selenium/webdriver/common/linux/selenium-manager --browser firefox --output json.\n{'code': 65, 'message': 'error sending request for url (https://github.com/mozilla/geckodriver/releases/latest): connection error: unexpected end of file', 'driver_path': '', 'browser_path': ''}\n\n\nThe above exception was the direct cause of the following exception:\n\nTraceback (most recent call last):\n  File \"\u003Cstdin>\", line 1, in \u003Cmodule>\n  File \"/usr/local/lib/python3.11/site-packages/selenium/webdriver/firefox/webdriver.py\", line 59, in __init__\n    self.service.path = DriverFinder.get_path(self.service, options)\n                        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/usr/local/lib/python3.11/site-packages/selenium/webdriver/common/driver_finder.py\", line 41, in get_path\n    raise NoSuchDriverException(msg) from err\nselenium.common.exceptions.NoSuchDriverException: Message: Unable to obtain driver for firefox using Selenium Manager.; For documentation on this error, please visit: https://www.selenium.dev/documentation/webdriver/troubleshooting/errors/driver_location\n","pyth",[45,6813,6814,6819,6824,6829,6834,6839,6844,6849,6854,6859,6864,6869,6873,6877,6882,6886,6890,6895,6900,6905,6910,6915,6920],{"__ignoreMap":89},[93,6815,6816],{"class":95,"line":96},[93,6817,6818],{},"Traceback (most recent call last):\n",[93,6820,6821],{"class":95,"line":247},[93,6822,6823],{},"  File \"/usr/local/lib/python3.11/site-packages/selenium/webdriver/common/driver_finder.py\", line 38, in get_path\n",[93,6825,6826],{"class":95,"line":267},[93,6827,6828],{},"    path = SeleniumManager().driver_location(options) if path is None else path\n",[93,6830,6831],{"class":95,"line":356},[93,6832,6833],{},"           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n",[93,6835,6836],{"class":95,"line":3},[93,6837,6838],{},"  File \"/usr/local/lib/python3.11/site-packages/selenium/webdriver/common/selenium_manager.py\", line 95, in driver_location\n",[93,6840,6841],{"class":95,"line":383},[93,6842,6843],{},"    output = self.run(args)\n",[93,6845,6846],{"class":95,"line":393},[93,6847,6848],{},"             ^^^^^^^^^^^^^^\n",[93,6850,6851],{"class":95,"line":403},[93,6852,6853],{},"  File \"/usr/local/lib/python3.11/site-packages/selenium/webdriver/common/selenium_manager.py\", line 141, in run\n",[93,6855,6856],{"class":95,"line":413},[93,6857,6858],{},"    raise WebDriverException(f\"Unsuccessful command executed: {command}.\\n{result}{stderr}\")\n",[93,6860,6861],{"class":95,"line":430},[93,6862,6863],{},"selenium.common.exceptions.WebDriverException: Message: Unsuccessful command executed: /usr/local/lib/python3.11/site-packages/selenium/webdriver/common/linux/selenium-manager --browser firefox --output json.\n",[93,6865,6866],{"class":95,"line":446},[93,6867,6868],{},"{'code': 65, 'message': 'error sending request for url (https://github.com/mozilla/geckodriver/releases/latest): connection error: unexpected end of file', 'driver_path': '', 'browser_path': ''}\n",[93,6870,6871],{"class":95,"line":459},[93,6872,353],{"emptyLinePlaceholder":352},[93,6874,6875],{"class":95,"line":465},[93,6876,353],{"emptyLinePlaceholder":352},[93,6878,6879],{"class":95,"line":471},[93,6880,6881],{},"The above exception was the direct cause of the following exception:\n",[93,6883,6884],{"class":95,"line":477},[93,6885,353],{"emptyLinePlaceholder":352},[93,6887,6888],{"class":95,"line":483},[93,6889,6818],{},[93,6891,6892],{"class":95,"line":499},[93,6893,6894],{},"  File \"\u003Cstdin>\", line 1, in \u003Cmodule>\n",[93,6896,6897],{"class":95,"line":1435},[93,6898,6899],{},"  File \"/usr/local/lib/python3.11/site-packages/selenium/webdriver/firefox/webdriver.py\", line 59, in __init__\n",[93,6901,6902],{"class":95,"line":1459},[93,6903,6904],{},"    self.service.path = DriverFinder.get_path(self.service, options)\n",[93,6906,6907],{"class":95,"line":1466},[93,6908,6909],{},"                        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n",[93,6911,6912],{"class":95,"line":1471},[93,6913,6914],{},"  File \"/usr/local/lib/python3.11/site-packages/selenium/webdriver/common/driver_finder.py\", line 41, in get_path\n",[93,6916,6917],{"class":95,"line":1477},[93,6918,6919],{},"    raise NoSuchDriverException(msg) from err\n",[93,6921,6922],{"class":95,"line":1483},[93,6923,6924],{},"selenium.common.exceptions.NoSuchDriverException: Message: Unable to obtain driver for firefox using Selenium Manager.; For documentation on this error, please visit: https://www.selenium.dev/documentation/webdriver/troubleshooting/errors/driver_location\n",[20,6926,6927,6928,6932],{},"我才发现 selenium 试图访问 ",[24,6929,6930],{"href":6930,"rel":6931},"https://github.com/mozilla/geckodriver/releases/latest",[73]," 且访问失败了。仔细阅读了 selenium 项目的文档发现新版本的 selenium 会尝试自动下载 webdriver:",[116,6934,6935],{},[20,6936,6937],{},"As of Selenium 4.6, Selenium downloads the correct driver for you. You shouldn’t need to do anything.",[20,6939,6940],{},"表面上看上去我不需要做任何事情，但项目组忽略了中国大陆的网络环境。",[20,6942,6943,6944,6949,6950,6953],{},"服务是要在境内的云服务器上跑的，我也不敢开代理，现在比较靠谱的方案是我去手动指定 Firefox 的 geckodriver，避免 selenium 去帮我自动下载一份。在 ",[24,6945,6948],{"href":6946,"rel":6947},"https://selenium-python.readthedocs.io/api.html#module-selenium.webdriver.firefox.webdriver",[73],"python-selenium 的官方文档","中是让我们创建 Firefox 的 webdriver 时去传入一个 ",[45,6951,6952],{},"executable_path='geckodriver'"," 的关键词参数，可惜这是过时的用法，应该是维护者还没来得及更新文档。",[20,6955,6956,6957],{},"随后便在 stackoverflow 上找到了新版 selenium ",[24,6958,6961],{"href":6959,"rel":6960},"https://stackoverflow.com/questions/76550506/typeerror-webdriver-init-got-an-unexpected-keyword-argument-executable-p",[73],"手动指定 Chrome 的 chromedriver 的方法",[116,6963,6964],{},[84,6965,6967],{"className":4638,"code":6966,"language":4640,"meta":89,"style":89},"from selenium import webdriver\nfrom selenium.webdriver.chrome.service import Service\n\nservice = Service(executable_path='chromedriver.exe') \noptions = webdriver.ChromeOptions()\ndriver = webdriver.Chrome(service=service, options=options)\n# ...\ndriver.quit()\n",[45,6968,6969,6981,6993,6997,7020,7035,7065,7070],{"__ignoreMap":89},[93,6970,6971,6973,6976,6978],{"class":95,"line":96},[93,6972,5987],{"class":232},[93,6974,6975],{"class":103}," selenium ",[93,6977,4656],{"class":232},[93,6979,6980],{"class":103}," webdriver\n",[93,6982,6983,6985,6988,6990],{"class":95,"line":247},[93,6984,5987],{"class":232},[93,6986,6987],{"class":103}," selenium.webdriver.chrome.service ",[93,6989,4656],{"class":232},[93,6991,6992],{"class":103}," Service\n",[93,6994,6995],{"class":95,"line":267},[93,6996,353],{"emptyLinePlaceholder":352},[93,6998,6999,7002,7004,7007,7009,7012,7014,7017],{"class":95,"line":356},[93,7000,7001],{"class":103},"service ",[93,7003,2204],{"class":1213},[93,7005,7006],{"class":4800}," Service",[93,7008,104],{"class":103},[93,7010,7011],{"class":4807},"executable_path",[93,7013,2204],{"class":1213},[93,7015,7016],{"class":107},"'chromedriver.exe'",[93,7018,7019],{"class":103},") \n",[93,7021,7022,7025,7027,7030,7033],{"class":95,"line":3},[93,7023,7024],{"class":103},"options ",[93,7026,2204],{"class":1213},[93,7028,7029],{"class":103}," webdriver.",[93,7031,7032],{"class":4800},"ChromeOptions",[93,7034,5227],{"class":103},[93,7036,7037,7040,7042,7044,7047,7049,7052,7054,7057,7060,7062],{"class":95,"line":383},[93,7038,7039],{"class":103},"driver ",[93,7041,2204],{"class":1213},[93,7043,7029],{"class":103},[93,7045,7046],{"class":4800},"Chrome",[93,7048,104],{"class":103},[93,7050,7051],{"class":4807},"service",[93,7053,2204],{"class":1213},[93,7055,7056],{"class":103},"service, ",[93,7058,7059],{"class":4807},"options",[93,7061,2204],{"class":1213},[93,7063,7064],{"class":103},"options)\n",[93,7066,7067],{"class":95,"line":393},[93,7068,7069],{"class":426},"# ...\n",[93,7071,7072,7075,7078],{"class":95,"line":403},[93,7073,7074],{"class":103},"driver.",[93,7076,7077],{"class":4800},"quit",[93,7079,5227],{"class":103},[20,7081,7082],{},"原文给的是 chrome 的方案，但 Firefox 的方案基本也是一致的，应该也是去创建一个 service 对象，猜一猜就能猜到。",[84,7084,7086],{"className":4638,"code":7085,"language":4640,"meta":89,"style":89},"from selenium import webdriver\nfrom selenium.webdriver.firefox.service import Service\nfrom selenium.webdriver.firefox.options import Options\n\nservice = Service(executable_path='/root/geckodriver') # 我这里是 docker 打包，懒得创建一个普通用户了，就直接用了 root 用户的 home 目录\noptions = Options(\"--headless\")\ndriver = webdriver.Firefox(service=service, options=options)\n# ...\ndriver.quit()\n",[45,7087,7088,7098,7109,7121,7125,7147,7163,7187,7191],{"__ignoreMap":89},[93,7089,7090,7092,7094,7096],{"class":95,"line":96},[93,7091,5987],{"class":232},[93,7093,6975],{"class":103},[93,7095,4656],{"class":232},[93,7097,6980],{"class":103},[93,7099,7100,7102,7105,7107],{"class":95,"line":247},[93,7101,5987],{"class":232},[93,7103,7104],{"class":103}," selenium.webdriver.firefox.service ",[93,7106,4656],{"class":232},[93,7108,6992],{"class":103},[93,7110,7111,7113,7116,7118],{"class":95,"line":267},[93,7112,5987],{"class":232},[93,7114,7115],{"class":103}," selenium.webdriver.firefox.options ",[93,7117,4656],{"class":232},[93,7119,7120],{"class":103}," Options\n",[93,7122,7123],{"class":95,"line":356},[93,7124,353],{"emptyLinePlaceholder":352},[93,7126,7127,7129,7131,7133,7135,7137,7139,7142,7144],{"class":95,"line":3},[93,7128,7001],{"class":103},[93,7130,2204],{"class":1213},[93,7132,7006],{"class":4800},[93,7134,104],{"class":103},[93,7136,7011],{"class":4807},[93,7138,2204],{"class":1213},[93,7140,7141],{"class":107},"'/root/geckodriver'",[93,7143,3853],{"class":103},[93,7145,7146],{"class":426},"# 我这里是 docker 打包，懒得创建一个普通用户了，就直接用了 root 用户的 home 目录\n",[93,7148,7149,7151,7153,7156,7158,7161],{"class":95,"line":383},[93,7150,7024],{"class":103},[93,7152,2204],{"class":1213},[93,7154,7155],{"class":4800}," Options",[93,7157,104],{"class":103},[93,7159,7160],{"class":107},"\"--headless\"",[93,7162,496],{"class":103},[93,7164,7165,7167,7169,7171,7173,7175,7177,7179,7181,7183,7185],{"class":95,"line":393},[93,7166,7039],{"class":103},[93,7168,2204],{"class":1213},[93,7170,7029],{"class":103},[93,7172,6792],{"class":4800},[93,7174,104],{"class":103},[93,7176,7051],{"class":4807},[93,7178,2204],{"class":1213},[93,7180,7056],{"class":103},[93,7182,7059],{"class":4807},[93,7184,2204],{"class":1213},[93,7186,7064],{"class":103},[93,7188,7189],{"class":95,"line":403},[93,7190,7069],{"class":426},[93,7192,7193,7195,7197],{"class":95,"line":413},[93,7194,7074],{"class":103},[93,7196,7077],{"class":4800},[93,7198,5227],{"class":103},[20,7200,7201],{},"手动指定 geckodriver 后，在我 1 核 1 G 的小主机上创建 webdriver 对象，基本都可以秒完成。",[530,7203,7204],{},"html .default .shiki span {color: var(--shiki-default);background: var(--shiki-default-bg);font-style: var(--shiki-default-font-style);font-weight: var(--shiki-default-font-weight);text-decoration: var(--shiki-default-text-decoration);}html .shiki span {color: var(--shiki-default);background: var(--shiki-default-bg);font-style: var(--shiki-default-font-style);font-weight: var(--shiki-default-font-weight);text-decoration: var(--shiki-default-text-decoration);}html .dark .shiki span {color: var(--shiki-dark);background: var(--shiki-dark-bg);font-style: var(--shiki-dark-font-style);font-weight: var(--shiki-dark-font-weight);text-decoration: var(--shiki-dark-text-decoration);}html.dark .shiki span {color: var(--shiki-dark);background: var(--shiki-dark-bg);font-style: var(--shiki-dark-font-style);font-weight: var(--shiki-dark-font-weight);text-decoration: var(--shiki-dark-text-decoration);}html pre.shiki code .sLKXg, html code.shiki .sLKXg{--shiki-default:#A626A4;--shiki-dark:#C678DD}html pre.shiki code .s5ixo, html code.shiki .s5ixo{--shiki-default:#383A42;--shiki-dark:#ABB2BF}html pre.shiki code .sknuh, html code.shiki .sknuh{--shiki-default:#383A42;--shiki-dark:#56B6C2}html pre.shiki code .slOjB, html code.shiki .slOjB{--shiki-default:#383A42;--shiki-dark:#61AFEF}html pre.shiki code .sp7wS, html code.shiki .sp7wS{--shiki-default:#986801;--shiki-default-font-style:inherit;--shiki-dark:#E06C75;--shiki-dark-font-style:italic}html pre.shiki code .sDhpE, html code.shiki .sDhpE{--shiki-default:#50A14F;--shiki-dark:#98C379}html pre.shiki code .sW2Sy, html code.shiki .sW2Sy{--shiki-default:#A0A1A7;--shiki-default-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic}",{"title":89,"searchDepth":247,"depth":247,"links":7206},[],129,1763668765411]