[{"data":1,"prerenderedAt":8383},["ShallowReactive",2],{"randomIndex/page/3/":3,"language-switch-/page/3/-en":4,"index-page-3-zh":5,"posts-total-zh":8382},0,"/en/",[6,1408,1934,4034,4545,5378,5830,7183,7641,8085],{"title":7,"date":8,"path":9,"tags":10,"body":13},"构建部署在 Cloudflare Workers 上的 TG Bot","2024-12-30 19:45:43","/2024/12/30/tg-bot-hosted-on-cloudflare-workers",[11,12],"Bot","Cloudflare",{"type":14,"value":15,"toc":1397},"minimark",[16,20,34,47,50,54,62,71,74,77,80,83,87,90,98,161,164,167,432,435,438,936,939,1369,1373,1376,1379,1385,1388,1393],[17,18,19],"h2",{"id":19},"起因",[21,22,23,24,29,30],"p",{},"早在去年 10 月，我就写过一篇",[25,26,28],"a",{"href":27},"/2023/10/29/create-b23tv-remover-bot/","《创建 b23.tv 追踪参数移除 bot》","。记录了部署 b23.tv 的追踪参数移除 Bot 的部署方案。其中提到的 TG Bot 随着服务器到期不再续费也一同落灰了——",[31,32,33],"strong",{},"公益服务总是这样，开始时满腔热血，随着时间散去没有多少人能坚持投入成本，徒留下一地鸡毛。",[21,35,36,37,43,44],{},"大概半个月前，我在群里看见 ",[25,38,42],{"href":39,"rel":40},"https://asukaminato.eu.org/",[41],"nofollow","Asuka Minato"," 开发的群消息总结 Bot，整体部署在 Cloudflare Workers 上，在保证零运营成本的情况下有着相当非常不错的在线率保证，因此便考虑将这个 Bot 迁移到 Cloudflare Workers 上。",[31,45,46],{},"选用免费的 serverless 能够有效延长服务的可持续性，它不需要额外投入时间精力和财力进行维护，通常可以活很久。",[21,48,49],{},"之所以可以把 TG Bot 部署到 Cloudflare Workers 上，主要是得益于 TG 平台支持 webhook 的方式让 Bot 程序提供服务。我们所需要提供的是一个公网能访问的 http 地址，在成功注册 webhook 服务后，TG 的官方服务器会将所有 Bot 所在群或者和所有对个人的对话以 http 请求的方式打到这个 url 上，而 Cloudflare Workers 平台就能提供一个 workers.dev 结尾的公网 url 作为 webhook 提供给 TG 服务器。",[17,51,53],{"id":52},"怎么做","怎么做？",[21,55,56,61],{},[25,57,60],{"href":58,"rel":59},"https://github.com/cvzi/telegram-bot-cloudflare",[41],"在这个 Github 仓库中","，给出了不少例子，用以讲述如何利用 Cloudflare Workers 构建 TG Bot。",[21,63,64,65,70],{},"在 ",[25,66,69],{"href":67,"rel":68},"https://github.com/cvzi/telegram-bot-cloudflare/blob/main/bot.js",[41],"bot.js"," 这个文件中编写了一个最简单的 TG Bot，其功能是: 将受到的所有消息在头部添加「Echo:」字符串，并发送回刚才的对话。",[21,72,73],{},"例: 用户发送 「Hello」，bot 回复 「Echo: Hello」",[75,76],"hr",{},[17,78,79],{"id":79},"代码分析",[21,81,82],{},"代码整体分为四个部分",[84,85,86],"h3",{"id":86},"顶部变量",[21,88,89],{},"文件顶部定义了 Bot 的 token、webhook 的 url 路径以及一个简易的 webhook 密码。",[21,91,92,93,97],{},"TOKEN 是从 botfather 那里获得的 bot token，SECRET 是自己设置的 webhook 密码，TG 的 webhook 服务器会通过把这个字段添加到名为 ",[94,95,96],"code",{},"X-Telegram-Bot-Api-Secret-Token"," 的请求头中来证明自己的官方身份。",[99,100,105],"pre",{"className":101,"code":102,"language":103,"meta":104,"style":104},"language-javascript shiki shiki-themes one-light one-dark-pro","const TOKEN = ENV_BOT_TOKEN // Get it from @BotFather https://core.telegram.org/bots#6-botfather\nconst WEBHOOK = '/endpoint'\nconst SECRET = ENV_BOT_SECRET // A-Z, a-z, 0-9, _ and -\n","javascript","",[94,106,107,131,145],{"__ignoreMap":104},[108,109,112,116,120,124,127],"span",{"class":110,"line":111},"line",1,[108,113,115],{"class":114},"sLKXg","const",[108,117,119],{"class":118},"sNmU0"," TOKEN",[108,121,123],{"class":122},"s_Sar"," =",[108,125,126],{"class":118}," ENV_BOT_TOKEN",[108,128,130],{"class":129},"sW2Sy"," // Get it from @BotFather https://core.telegram.org/bots#6-botfather\n",[108,132,134,136,139,141],{"class":110,"line":133},2,[108,135,115],{"class":114},[108,137,138],{"class":118}," WEBHOOK",[108,140,123],{"class":122},[108,142,144],{"class":143},"sDhpE"," '/endpoint'\n",[108,146,148,150,153,155,158],{"class":110,"line":147},3,[108,149,115],{"class":114},[108,151,152],{"class":118}," SECRET",[108,154,123],{"class":122},[108,156,157],{"class":118}," ENV_BOT_SECRET",[108,159,160],{"class":129}," // A-Z, a-z, 0-9, _ and -\n",[84,162,163],{"id":163},"简易路由",[21,165,166],{},"紧接着定义了一个简易的路由",[99,168,170],{"className":101,"code":169,"language":103,"meta":104,"style":104},"addEventListener('fetch', event => {\n  const url = new URL(event.request.url)\n  if (url.pathname === WEBHOOK) {\n    event.respondWith(handleWebhook(event))\n  } else if (url.pathname === '/registerWebhook') {\n    event.respondWith(registerWebhook(event, url, WEBHOOK, SECRET))\n  } else if (url.pathname === '/unRegisterWebhook') {\n    event.respondWith(unRegisterWebhook(event))\n  } else {\n    event.respondWith(new Response('No handler for this request'))\n  }\n})\n",[94,171,172,198,235,258,282,309,343,367,387,396,420,426],{"__ignoreMap":104},[108,173,174,178,182,185,188,192,195],{"class":110,"line":111},[108,175,177],{"class":176},"sAdtL","addEventListener",[108,179,181],{"class":180},"s5ixo","(",[108,183,184],{"class":143},"'fetch'",[108,186,187],{"class":180},", ",[108,189,191],{"class":190},"s8iYz","event",[108,193,194],{"class":114}," =>",[108,196,197],{"class":180}," {\n",[108,199,200,203,206,208,211,214,216,219,222,226,228,232],{"class":110,"line":133},[108,201,202],{"class":114},"  const",[108,204,205],{"class":118}," url",[108,207,123],{"class":122},[108,209,210],{"class":114}," new",[108,212,213],{"class":176}," URL",[108,215,181],{"class":180},[108,217,191],{"class":218},"s7GmK",[108,220,221],{"class":180},".",[108,223,225],{"class":224},"s2QsP","request",[108,227,221],{"class":180},[108,229,231],{"class":230},"sJa8x","url",[108,233,234],{"class":180},")\n",[108,236,237,240,243,245,247,250,253,255],{"class":110,"line":147},[108,238,239],{"class":114},"  if",[108,241,242],{"class":180}," (",[108,244,231],{"class":218},[108,246,221],{"class":180},[108,248,249],{"class":230},"pathname",[108,251,252],{"class":122}," ===",[108,254,138],{"class":118},[108,256,257],{"class":180},") {\n",[108,259,261,264,266,269,271,274,276,279],{"class":110,"line":260},4,[108,262,263],{"class":218},"    event",[108,265,221],{"class":180},[108,267,268],{"class":176},"respondWith",[108,270,181],{"class":180},[108,272,273],{"class":176},"handleWebhook",[108,275,181],{"class":180},[108,277,191],{"class":278},"sz0mV",[108,280,281],{"class":180},"))\n",[108,283,285,288,291,294,296,298,300,302,304,307],{"class":110,"line":284},5,[108,286,287],{"class":180},"  } ",[108,289,290],{"class":114},"else",[108,292,293],{"class":114}," if",[108,295,242],{"class":180},[108,297,231],{"class":218},[108,299,221],{"class":180},[108,301,249],{"class":230},[108,303,252],{"class":122},[108,305,306],{"class":143}," '/registerWebhook'",[108,308,257],{"class":180},[108,310,312,314,316,318,320,323,325,327,329,331,333,336,338,341],{"class":110,"line":311},6,[108,313,263],{"class":218},[108,315,221],{"class":180},[108,317,268],{"class":176},[108,319,181],{"class":180},[108,321,322],{"class":176},"registerWebhook",[108,324,181],{"class":180},[108,326,191],{"class":278},[108,328,187],{"class":180},[108,330,231],{"class":278},[108,332,187],{"class":180},[108,334,335],{"class":118},"WEBHOOK",[108,337,187],{"class":180},[108,339,340],{"class":118},"SECRET",[108,342,281],{"class":180},[108,344,346,348,350,352,354,356,358,360,362,365],{"class":110,"line":345},7,[108,347,287],{"class":180},[108,349,290],{"class":114},[108,351,293],{"class":114},[108,353,242],{"class":180},[108,355,231],{"class":218},[108,357,221],{"class":180},[108,359,249],{"class":230},[108,361,252],{"class":122},[108,363,364],{"class":143}," '/unRegisterWebhook'",[108,366,257],{"class":180},[108,368,370,372,374,376,378,381,383,385],{"class":110,"line":369},8,[108,371,263],{"class":218},[108,373,221],{"class":180},[108,375,268],{"class":176},[108,377,181],{"class":180},[108,379,380],{"class":176},"unRegisterWebhook",[108,382,181],{"class":180},[108,384,191],{"class":278},[108,386,281],{"class":180},[108,388,390,392,394],{"class":110,"line":389},9,[108,391,287],{"class":180},[108,393,290],{"class":114},[108,395,197],{"class":180},[108,397,399,401,403,405,407,410,413,415,418],{"class":110,"line":398},10,[108,400,263],{"class":218},[108,402,221],{"class":180},[108,404,268],{"class":176},[108,406,181],{"class":180},[108,408,409],{"class":114},"new",[108,411,412],{"class":176}," Response",[108,414,181],{"class":180},[108,416,417],{"class":143},"'No handler for this request'",[108,419,281],{"class":180},[108,421,423],{"class":110,"line":422},11,[108,424,425],{"class":180},"  }\n",[108,427,429],{"class":110,"line":428},12,[108,430,431],{"class":180},"})\n",[84,433,434],{"id":434},"核心功能",[21,436,437],{},"随后的三个函数，会先进行 SECRET 的校验，并将 message 类型消息从 TG 的所有消息类型中分离开单独处理",[99,439,441],{"className":101,"code":440,"language":103,"meta":104,"style":104},"/**\n * Handle requests to WEBHOOK\n * https://core.telegram.org/bots/api#update\n */\nasync function handleWebhook (event) {\n  // Check secret\n  if (event.request.headers.get('X-Telegram-Bot-Api-Secret-Token') !== SECRET) {\n    return new Response('Unauthorized', { status: 403 })\n  }\n\n  // Read request body synchronously\n  const update = await event.request.json()\n  // Deal with response asynchronously\n  event.waitUntil(onUpdate(update))\n\n  return new Response('Ok')\n}\n\n/**\n * Handle incoming Update\n * https://core.telegram.org/bots/api#update\n */\nasync function onUpdate (update) {\n  if ('message' in update) {\n    await onMessage(update.message)\n  }\n}\n\n/**\n * Handle incoming Message\n * https://core.telegram.org/bots/api#message\n */\nfunction onMessage (message) {\n  return sendPlainText(message.chat.id, 'Echo:\\n' + message.text)\n}\n\n/**\n * Send plain text message\n * https://core.telegram.org/bots/api#sendmessage\n */\nasync function sendPlainText (chatId, text) {\n  return (await fetch(apiUrl('sendMessage', {\n    chat_id: chatId,\n    text\n  }))).json()\n",[94,442,443,448,453,458,463,480,485,522,553,557,563,568,595,601,624,629,646,652,657,662,668,673,678,694,711,731,736,741,746,751,757,763,768,782,828,833,838,843,849,855,860,880,906,920,926],{"__ignoreMap":104},[108,444,445],{"class":110,"line":111},[108,446,447],{"class":129},"/**\n",[108,449,450],{"class":110,"line":133},[108,451,452],{"class":129}," * Handle requests to WEBHOOK\n",[108,454,455],{"class":110,"line":147},[108,456,457],{"class":129}," * https://core.telegram.org/bots/api#update\n",[108,459,460],{"class":110,"line":260},[108,461,462],{"class":129}," */\n",[108,464,465,468,471,474,476,478],{"class":110,"line":284},[108,466,467],{"class":114},"async",[108,469,470],{"class":114}," function",[108,472,473],{"class":176}," handleWebhook",[108,475,242],{"class":180},[108,477,191],{"class":190},[108,479,257],{"class":180},[108,481,482],{"class":110,"line":311},[108,483,484],{"class":129},"  // Check secret\n",[108,486,487,489,491,493,495,497,499,502,504,507,509,512,515,518,520],{"class":110,"line":345},[108,488,239],{"class":114},[108,490,242],{"class":180},[108,492,191],{"class":218},[108,494,221],{"class":180},[108,496,225],{"class":224},[108,498,221],{"class":180},[108,500,501],{"class":224},"headers",[108,503,221],{"class":180},[108,505,506],{"class":176},"get",[108,508,181],{"class":180},[108,510,511],{"class":143},"'X-Telegram-Bot-Api-Secret-Token'",[108,513,514],{"class":180},") ",[108,516,517],{"class":122},"!==",[108,519,152],{"class":118},[108,521,257],{"class":180},[108,523,524,527,529,531,533,536,539,542,546,550],{"class":110,"line":369},[108,525,526],{"class":114},"    return",[108,528,210],{"class":114},[108,530,412],{"class":176},[108,532,181],{"class":180},[108,534,535],{"class":143},"'Unauthorized'",[108,537,538],{"class":180},", { ",[108,540,541],{"class":230},"status",[108,543,545],{"class":544},"st7oF",":",[108,547,549],{"class":548},"sAGMh"," 403",[108,551,552],{"class":180}," })\n",[108,554,555],{"class":110,"line":389},[108,556,425],{"class":180},[108,558,559],{"class":110,"line":398},[108,560,562],{"emptyLinePlaceholder":561},true,"\n",[108,564,565],{"class":110,"line":422},[108,566,567],{"class":129},"  // Read request body synchronously\n",[108,569,570,572,575,577,580,583,585,587,589,592],{"class":110,"line":428},[108,571,202],{"class":114},[108,573,574],{"class":118}," update",[108,576,123],{"class":122},[108,578,579],{"class":114}," await",[108,581,582],{"class":218}," event",[108,584,221],{"class":180},[108,586,225],{"class":224},[108,588,221],{"class":180},[108,590,591],{"class":176},"json",[108,593,594],{"class":180},"()\n",[108,596,598],{"class":110,"line":597},13,[108,599,600],{"class":129},"  // Deal with response asynchronously\n",[108,602,604,607,609,612,614,617,619,622],{"class":110,"line":603},14,[108,605,606],{"class":218},"  event",[108,608,221],{"class":180},[108,610,611],{"class":176},"waitUntil",[108,613,181],{"class":180},[108,615,616],{"class":176},"onUpdate",[108,618,181],{"class":180},[108,620,621],{"class":278},"update",[108,623,281],{"class":180},[108,625,627],{"class":110,"line":626},15,[108,628,562],{"emptyLinePlaceholder":561},[108,630,632,635,637,639,641,644],{"class":110,"line":631},16,[108,633,634],{"class":114},"  return",[108,636,210],{"class":114},[108,638,412],{"class":176},[108,640,181],{"class":180},[108,642,643],{"class":143},"'Ok'",[108,645,234],{"class":180},[108,647,649],{"class":110,"line":648},17,[108,650,651],{"class":180},"}\n",[108,653,655],{"class":110,"line":654},18,[108,656,562],{"emptyLinePlaceholder":561},[108,658,660],{"class":110,"line":659},19,[108,661,447],{"class":129},[108,663,665],{"class":110,"line":664},20,[108,666,667],{"class":129}," * Handle incoming Update\n",[108,669,671],{"class":110,"line":670},21,[108,672,457],{"class":129},[108,674,676],{"class":110,"line":675},22,[108,677,462],{"class":129},[108,679,681,683,685,688,690,692],{"class":110,"line":680},23,[108,682,467],{"class":114},[108,684,470],{"class":114},[108,686,687],{"class":176}," onUpdate",[108,689,242],{"class":180},[108,691,621],{"class":190},[108,693,257],{"class":180},[108,695,697,699,701,704,707,709],{"class":110,"line":696},24,[108,698,239],{"class":114},[108,700,242],{"class":180},[108,702,703],{"class":143},"'message'",[108,705,706],{"class":114}," in",[108,708,574],{"class":278},[108,710,257],{"class":180},[108,712,714,717,720,722,724,726,729],{"class":110,"line":713},25,[108,715,716],{"class":114},"    await",[108,718,719],{"class":176}," onMessage",[108,721,181],{"class":180},[108,723,621],{"class":218},[108,725,221],{"class":180},[108,727,728],{"class":230},"message",[108,730,234],{"class":180},[108,732,734],{"class":110,"line":733},26,[108,735,425],{"class":180},[108,737,739],{"class":110,"line":738},27,[108,740,651],{"class":180},[108,742,744],{"class":110,"line":743},28,[108,745,562],{"emptyLinePlaceholder":561},[108,747,749],{"class":110,"line":748},29,[108,750,447],{"class":129},[108,752,754],{"class":110,"line":753},30,[108,755,756],{"class":129}," * Handle incoming Message\n",[108,758,760],{"class":110,"line":759},31,[108,761,762],{"class":129}," * https://core.telegram.org/bots/api#message\n",[108,764,766],{"class":110,"line":765},32,[108,767,462],{"class":129},[108,769,771,774,776,778,780],{"class":110,"line":770},33,[108,772,773],{"class":114},"function",[108,775,719],{"class":176},[108,777,242],{"class":180},[108,779,728],{"class":190},[108,781,257],{"class":180},[108,783,785,787,790,792,794,796,799,801,804,806,809,812,815,818,821,823,826],{"class":110,"line":784},34,[108,786,634],{"class":114},[108,788,789],{"class":176}," sendPlainText",[108,791,181],{"class":180},[108,793,728],{"class":218},[108,795,221],{"class":180},[108,797,798],{"class":224},"chat",[108,800,221],{"class":180},[108,802,803],{"class":230},"id",[108,805,187],{"class":180},[108,807,808],{"class":143},"'Echo:",[108,810,811],{"class":122},"\\n",[108,813,814],{"class":143},"'",[108,816,817],{"class":122}," +",[108,819,820],{"class":218}," message",[108,822,221],{"class":180},[108,824,825],{"class":230},"text",[108,827,234],{"class":180},[108,829,831],{"class":110,"line":830},35,[108,832,651],{"class":180},[108,834,836],{"class":110,"line":835},36,[108,837,562],{"emptyLinePlaceholder":561},[108,839,841],{"class":110,"line":840},37,[108,842,447],{"class":129},[108,844,846],{"class":110,"line":845},38,[108,847,848],{"class":129}," * Send plain text message\n",[108,850,852],{"class":110,"line":851},39,[108,853,854],{"class":129}," * https://core.telegram.org/bots/api#sendmessage\n",[108,856,858],{"class":110,"line":857},40,[108,859,462],{"class":129},[108,861,863,865,867,869,871,874,876,878],{"class":110,"line":862},41,[108,864,467],{"class":114},[108,866,470],{"class":114},[108,868,789],{"class":176},[108,870,242],{"class":180},[108,872,873],{"class":190},"chatId",[108,875,187],{"class":180},[108,877,825],{"class":190},[108,879,257],{"class":180},[108,881,883,885,887,890,893,895,898,900,903],{"class":110,"line":882},42,[108,884,634],{"class":114},[108,886,242],{"class":180},[108,888,889],{"class":114},"await",[108,891,892],{"class":176}," fetch",[108,894,181],{"class":180},[108,896,897],{"class":176},"apiUrl",[108,899,181],{"class":180},[108,901,902],{"class":143},"'sendMessage'",[108,904,905],{"class":180},", {\n",[108,907,909,912,914,917],{"class":110,"line":908},43,[108,910,911],{"class":230},"    chat_id",[108,913,545],{"class":544},[108,915,916],{"class":278}," chatId",[108,918,919],{"class":180},",\n",[108,921,923],{"class":110,"line":922},44,[108,924,925],{"class":278},"    text\n",[108,927,929,932,934],{"class":110,"line":928},45,[108,930,931],{"class":180},"  }))).",[108,933,591],{"class":176},[108,935,594],{"class":180},[21,937,938],{},"我们需要更改的就是这个 onMessage 函数，用户输入的文本信息通过 message.text 获取，我们可以很轻易的把 b23 remover 的逻辑用 js 实现",[99,940,942],{"className":101,"code":941,"language":103,"meta":104,"style":104},"async function onMessage(message) {\n    if (!message.text) {\n        return;\n    }\n    const b23Reg = /b23\\.tv\\/[a-zA-Z0-9]+/g;\n    if (!b23Reg.test(message.text)) {\n        console.log('No match found');\n    }\n    const b23Links = message.text.match(b23Reg);\n    const cleanLinks = [];\n    await Promise.all(\n        b23Links.map(link => b23Remover('https://' + link))\n    ).then(result => {\n        cleanLinks.push(...result);\n    });\n\n    const text2Send = \"Track ID removed:\\n\" + cleanLinks.join(\"\\n\");\n    return sendPlainText(message.chat.id, text2Send);\n}\n\nasync function b23Remover (url) {\n    const r = await fetch(url)\n    const v = r.url\n    const u = new URL(v)\n    return u.origin + u.pathname\n}\n",[94,943,944,958,976,984,989,1027,1054,1072,1076,1102,1114,1130,1162,1179,1198,1203,1207,1243,1268,1272,1276,1290,1309,1325,1345,1365],{"__ignoreMap":104},[108,945,946,948,950,952,954,956],{"class":110,"line":111},[108,947,467],{"class":114},[108,949,470],{"class":114},[108,951,719],{"class":176},[108,953,181],{"class":180},[108,955,728],{"class":190},[108,957,257],{"class":180},[108,959,960,963,965,968,970,972,974],{"class":110,"line":133},[108,961,962],{"class":114},"    if",[108,964,242],{"class":180},[108,966,967],{"class":122},"!",[108,969,728],{"class":218},[108,971,221],{"class":180},[108,973,825],{"class":230},[108,975,257],{"class":180},[108,977,978,981],{"class":110,"line":147},[108,979,980],{"class":114},"        return",[108,982,983],{"class":180},";\n",[108,985,986],{"class":110,"line":260},[108,987,988],{"class":180},"    }\n",[108,990,991,994,997,999,1003,1006,1009,1012,1015,1019,1022,1025],{"class":110,"line":284},[108,992,993],{"class":114},"    const",[108,995,996],{"class":118}," b23Reg",[108,998,123],{"class":122},[108,1000,1002],{"class":1001},"sDaw7"," /b23",[108,1004,1005],{"class":122},"\\.",[108,1007,1008],{"class":1001},"tv",[108,1010,1011],{"class":122},"\\/",[108,1013,1014],{"class":548},"[a-zA-Z0-9]",[108,1016,1018],{"class":1017},"sYoRg","+",[108,1020,1021],{"class":1001},"/",[108,1023,1024],{"class":114},"g",[108,1026,983],{"class":180},[108,1028,1029,1031,1033,1035,1038,1040,1043,1045,1047,1049,1051],{"class":110,"line":311},[108,1030,962],{"class":114},[108,1032,242],{"class":180},[108,1034,967],{"class":122},[108,1036,1037],{"class":218},"b23Reg",[108,1039,221],{"class":180},[108,1041,1042],{"class":176},"test",[108,1044,181],{"class":180},[108,1046,728],{"class":218},[108,1048,221],{"class":180},[108,1050,825],{"class":230},[108,1052,1053],{"class":180},")) {\n",[108,1055,1056,1059,1061,1064,1066,1069],{"class":110,"line":345},[108,1057,1058],{"class":218},"        console",[108,1060,221],{"class":180},[108,1062,1063],{"class":176},"log",[108,1065,181],{"class":180},[108,1067,1068],{"class":143},"'No match found'",[108,1070,1071],{"class":180},");\n",[108,1073,1074],{"class":110,"line":369},[108,1075,988],{"class":180},[108,1077,1078,1080,1083,1085,1087,1089,1091,1093,1096,1098,1100],{"class":110,"line":389},[108,1079,993],{"class":114},[108,1081,1082],{"class":118}," b23Links",[108,1084,123],{"class":122},[108,1086,820],{"class":218},[108,1088,221],{"class":180},[108,1090,825],{"class":224},[108,1092,221],{"class":180},[108,1094,1095],{"class":176},"match",[108,1097,181],{"class":180},[108,1099,1037],{"class":278},[108,1101,1071],{"class":180},[108,1103,1104,1106,1109,1111],{"class":110,"line":398},[108,1105,993],{"class":114},[108,1107,1108],{"class":118}," cleanLinks",[108,1110,123],{"class":122},[108,1112,1113],{"class":180}," [];\n",[108,1115,1116,1118,1122,1124,1127],{"class":110,"line":422},[108,1117,716],{"class":114},[108,1119,1121],{"class":1120},"sC09Y"," Promise",[108,1123,221],{"class":180},[108,1125,1126],{"class":176},"all",[108,1128,1129],{"class":180},"(\n",[108,1131,1132,1135,1137,1140,1142,1145,1147,1150,1152,1155,1157,1160],{"class":110,"line":428},[108,1133,1134],{"class":218},"        b23Links",[108,1136,221],{"class":180},[108,1138,1139],{"class":176},"map",[108,1141,181],{"class":180},[108,1143,1144],{"class":190},"link",[108,1146,194],{"class":114},[108,1148,1149],{"class":176}," b23Remover",[108,1151,181],{"class":180},[108,1153,1154],{"class":143},"'https://'",[108,1156,817],{"class":122},[108,1158,1159],{"class":278}," link",[108,1161,281],{"class":180},[108,1163,1164,1167,1170,1172,1175,1177],{"class":110,"line":597},[108,1165,1166],{"class":180},"    ).",[108,1168,1169],{"class":176},"then",[108,1171,181],{"class":180},[108,1173,1174],{"class":190},"result",[108,1176,194],{"class":114},[108,1178,197],{"class":180},[108,1180,1181,1184,1186,1189,1191,1194,1196],{"class":110,"line":603},[108,1182,1183],{"class":218},"        cleanLinks",[108,1185,221],{"class":180},[108,1187,1188],{"class":176},"push",[108,1190,181],{"class":180},[108,1192,1193],{"class":544},"...",[108,1195,1174],{"class":278},[108,1197,1071],{"class":180},[108,1199,1200],{"class":110,"line":626},[108,1201,1202],{"class":180},"    });\n",[108,1204,1205],{"class":110,"line":631},[108,1206,562],{"emptyLinePlaceholder":561},[108,1208,1209,1211,1214,1216,1219,1221,1224,1226,1228,1230,1233,1235,1237,1239,1241],{"class":110,"line":648},[108,1210,993],{"class":114},[108,1212,1213],{"class":118}," text2Send",[108,1215,123],{"class":122},[108,1217,1218],{"class":143}," \"Track ID removed:",[108,1220,811],{"class":122},[108,1222,1223],{"class":143},"\"",[108,1225,817],{"class":122},[108,1227,1108],{"class":218},[108,1229,221],{"class":180},[108,1231,1232],{"class":176},"join",[108,1234,181],{"class":180},[108,1236,1223],{"class":143},[108,1238,811],{"class":122},[108,1240,1223],{"class":143},[108,1242,1071],{"class":180},[108,1244,1245,1247,1249,1251,1253,1255,1257,1259,1261,1263,1266],{"class":110,"line":654},[108,1246,526],{"class":114},[108,1248,789],{"class":176},[108,1250,181],{"class":180},[108,1252,728],{"class":218},[108,1254,221],{"class":180},[108,1256,798],{"class":224},[108,1258,221],{"class":180},[108,1260,803],{"class":230},[108,1262,187],{"class":180},[108,1264,1265],{"class":278},"text2Send",[108,1267,1071],{"class":180},[108,1269,1270],{"class":110,"line":659},[108,1271,651],{"class":180},[108,1273,1274],{"class":110,"line":664},[108,1275,562],{"emptyLinePlaceholder":561},[108,1277,1278,1280,1282,1284,1286,1288],{"class":110,"line":670},[108,1279,467],{"class":114},[108,1281,470],{"class":114},[108,1283,1149],{"class":176},[108,1285,242],{"class":180},[108,1287,231],{"class":190},[108,1289,257],{"class":180},[108,1291,1292,1294,1297,1299,1301,1303,1305,1307],{"class":110,"line":675},[108,1293,993],{"class":114},[108,1295,1296],{"class":118}," r",[108,1298,123],{"class":122},[108,1300,579],{"class":114},[108,1302,892],{"class":176},[108,1304,181],{"class":180},[108,1306,231],{"class":278},[108,1308,234],{"class":180},[108,1310,1311,1313,1316,1318,1320,1322],{"class":110,"line":680},[108,1312,993],{"class":114},[108,1314,1315],{"class":118}," v",[108,1317,123],{"class":122},[108,1319,1296],{"class":218},[108,1321,221],{"class":180},[108,1323,1324],{"class":230},"url\n",[108,1326,1327,1329,1332,1334,1336,1338,1340,1343],{"class":110,"line":696},[108,1328,993],{"class":114},[108,1330,1331],{"class":118}," u",[108,1333,123],{"class":122},[108,1335,210],{"class":114},[108,1337,213],{"class":176},[108,1339,181],{"class":180},[108,1341,1342],{"class":278},"v",[108,1344,234],{"class":180},[108,1346,1347,1349,1351,1353,1356,1358,1360,1362],{"class":110,"line":713},[108,1348,526],{"class":114},[108,1350,1331],{"class":218},[108,1352,221],{"class":180},[108,1354,1355],{"class":230},"origin",[108,1357,817],{"class":122},[108,1359,1331],{"class":218},[108,1361,221],{"class":180},[108,1363,1364],{"class":230},"pathname\n",[108,1366,1367],{"class":110,"line":733},[108,1368,651],{"class":180},[84,1370,1372],{"id":1371},"webhook-注册相关","webhook 注册相关",[21,1374,1375],{},"后面的 registerWebhook、unRegisterWebhook、apiUrl 在没有特定需求的情况下不需要变动。",[21,1377,1378],{},"在 Cloudflare 部署后，就可以访问 aaa.bbb.workers.dev/registerWebhook 这个 url 注册 TG 的 webhook 服务。收到 Ok 就代表注册好了。",[21,1380,1381],{},[1382,1383],"img",{"alt":104,"src":1384},"https://static.031130.xyz/uploads/2024/12/30/5fd442bb18064.webp",[17,1386,1387],{"id":1387},"成果展示",[21,1389,1390],{},[1382,1391],{"alt":104,"src":1392},"https://static.031130.xyz/uploads/2024/12/30/3b0b929960840.webp",[1394,1395,1396],"style",{},"html pre.shiki code .sLKXg, html code.shiki .sLKXg{--shiki-default:#A626A4;--shiki-dark:#C678DD}html pre.shiki code .sNmU0, html code.shiki .sNmU0{--shiki-default:#986801;--shiki-dark:#E5C07B}html pre.shiki code .s_Sar, html code.shiki .s_Sar{--shiki-default:#0184BC;--shiki-dark:#56B6C2}html pre.shiki code .sW2Sy, html code.shiki .sW2Sy{--shiki-default:#A0A1A7;--shiki-default-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic}html pre.shiki code .sDhpE, html code.shiki .sDhpE{--shiki-default:#50A14F;--shiki-dark:#98C379}html .default .shiki span {color: var(--shiki-default);background: var(--shiki-default-bg);font-style: var(--shiki-default-font-style);font-weight: var(--shiki-default-font-weight);text-decoration: var(--shiki-default-text-decoration);}html .shiki span {color: var(--shiki-default);background: var(--shiki-default-bg);font-style: var(--shiki-default-font-style);font-weight: var(--shiki-default-font-weight);text-decoration: var(--shiki-default-text-decoration);}html .dark .shiki span {color: var(--shiki-dark);background: var(--shiki-dark-bg);font-style: var(--shiki-dark-font-style);font-weight: var(--shiki-dark-font-weight);text-decoration: var(--shiki-dark-text-decoration);}html.dark .shiki span {color: var(--shiki-dark);background: var(--shiki-dark-bg);font-style: var(--shiki-dark-font-style);font-weight: var(--shiki-dark-font-weight);text-decoration: var(--shiki-dark-text-decoration);}html pre.shiki code .sAdtL, html code.shiki .sAdtL{--shiki-default:#4078F2;--shiki-dark:#61AFEF}html pre.shiki code .s5ixo, html code.shiki .s5ixo{--shiki-default:#383A42;--shiki-dark:#ABB2BF}html pre.shiki code .s8iYz, html code.shiki .s8iYz{--shiki-default:#383A42;--shiki-default-font-style:inherit;--shiki-dark:#E06C75;--shiki-dark-font-style:italic}html pre.shiki code .s7GmK, html code.shiki .s7GmK{--shiki-default:#383A42;--shiki-dark:#E5C07B}html pre.shiki code .s2QsP, html code.shiki .s2QsP{--shiki-default:#E45649;--shiki-dark:#E5C07B}html pre.shiki code .sJa8x, html code.shiki .sJa8x{--shiki-default:#E45649;--shiki-dark:#E06C75}html pre.shiki code .sz0mV, html code.shiki .sz0mV{--shiki-default:#383A42;--shiki-dark:#E06C75}html pre.shiki code .st7oF, html code.shiki .st7oF{--shiki-default:#0184BC;--shiki-dark:#ABB2BF}html pre.shiki code .sAGMh, html code.shiki .sAGMh{--shiki-default:#986801;--shiki-dark:#D19A66}html pre.shiki code .sDaw7, html code.shiki .sDaw7{--shiki-default:#0184BC;--shiki-dark:#E06C75}html pre.shiki code .sYoRg, html code.shiki .sYoRg{--shiki-default:#0184BC;--shiki-dark:#D19A66}html pre.shiki code .sC09Y, html code.shiki .sC09Y{--shiki-default:#C18401;--shiki-dark:#E5C07B}",{"title":104,"searchDepth":133,"depth":133,"links":1398},[1399,1400,1401,1407],{"id":19,"depth":133,"text":19},{"id":52,"depth":133,"text":53},{"id":79,"depth":133,"text":79,"children":1402},[1403,1404,1405,1406],{"id":86,"depth":147,"text":86},{"id":163,"depth":147,"text":163},{"id":434,"depth":147,"text":434},{"id":1371,"depth":147,"text":1372},{"id":1387,"depth":133,"text":1387},{"title":1409,"date":1410,"path":1411,"tags":1412,"body":1416},"2024年，Firefox 是唯一还在坚持执行在线的 SSL 证书吊销状态检查的主流浏览器","2024-11-19 17:58:14","/2024/11/19/firefox-is-the-only-mainstream-brower-doing-online-certificate-revocation-checks",[1413,1414,1415],"Firefox","SSL","OpenSSL",{"type":14,"value":1417,"toc":1924},[1418,1422,1425,1441,1448,1451,1456,1459,1466,1479,1488,1493,1496,1501,1505,1514,1518,1521,1525,1528,1531,1572,1577,1583,1587,1590,1602,1605,1611,1615,1622,1667,1677,1680,1696,1700,1703,1706,1709,1727,1730,1735,1739,1756,1759,1776,1779,1782,1785,1791,1794,1797,1806,1809,1921],[17,1419,1421],{"id":1420},"小试一下","小试一下？",[21,1423,1424],{},"在开始阅读后面的内容之前，或许你可以试试看你正在使用的浏览器能不能访问下面两个链接:",[1426,1427,1428,1435],"ul",{},[1429,1430,1431],"li",{},[25,1432,1433],{"href":1433,"rel":1434},"https://digicert-tls-ecc-p384-root-g5-revoked.chain-demos.digicert.com/",[41],[1429,1436,1437],{},[25,1438,1439],{"href":1439,"rel":1440},"https://revoked-isrgrootx1.letsencrypt.org/",[41],[21,1442,1443,1444,1447],{},"这两个链接分别是由 digicert 和 Let's Encrypt 维护的，特意维持了一个",[31,1445,1446],{},"证书没过期，但被 CA 吊销","的状态。",[21,1449,1450],{},"在我的 Firefox for Linux 上，两个链接我都无法打开。",[21,1452,1453],{},[1382,1454],{"alt":104,"src":1455},"https://static.031130.xyz/uploads/2024/11/19/f7785db60b2c8.webp",[21,1457,1458],{},"这是预期行为。Firefox 在与目标站点建立 https 链接之前，先向 CA 提供的 OCSP 服务器打了一个 http 请求来判断目标站点的 ssl 证书是否有效（是否没有被 CA 主动吊销）。",[21,1460,1461,1462],{},"在 Firefox for Android 上，我无法打开第一个链接，但可以打开第二个，这是因为 Mozilla 给 Android 用户设置的策略为「只对 EV 证书进行 ocsp 校验，跳过 DV 证书和 OV 证书」，",[1463,1464,1465],"em",{},"似乎在竞争更加激烈的移动端，Firefox 为了加载速度做出了安全性上的妥协。",[1467,1468,1469,1473,1476],"div",{},[1382,1470],{"src":1471,"style":1472},"https://static.031130.xyz/uploads/2024/11/19/b097e954f766f.webp","zoom:33%;",[108,1474],{"style":1475},"width: 20%;",[1382,1477],{"src":1478,"style":1472},"https://static.031130.xyz/uploads/2024/11/19/a5f58dbb50cfe.webp",[21,1480,1481,1482,1487],{},"而在 Google Chrome / Microsoft Edge 上，OCSP 是不被支持的，chromium 团队在 2014 年就禁用了 OCSP 校验，且目前没有设置项允许用户手动开启，目前它只支持",[25,1483,1486],{"href":1484,"rel":1485},"https://www.chromium.org/Home/chromium-security/crlsets/",[41],"本地的 CRLSets 规则集","。",[21,1489,1490],{},[1382,1491],{"alt":104,"src":1492},"https://static.031130.xyz/uploads/2024/11/19/bd84e9aff71d0.webp",[21,1494,1495],{},"Safari 经我本人测试默认只对 EV 证书进行有效性检验。",[21,1497,1498],{},[1382,1499],{"alt":104,"src":1500},"https://static.031130.xyz/uploads/2024/11/19/50352339f7473.webp",[17,1502,1504],{"id":1503},"ssl-证书被吊销是怎么回事","SSL 证书被吊销是怎么回事？",[21,1506,1507,1508,1513],{},"在某些情况下（比如用户告知 CA 颁发给自己的证书私钥不慎被泄漏了，或者 ",[25,1509,1512],{"href":1510,"rel":1511},"https://www.trustasia.com/view-security-lets-encrypt/",[41],"CA 的颁发程序出现漏洞被人滥用，需要吊销在此期间发出去的所有证书","），CA 需要吊销一些证书，并通过自己的渠道将被吊销的证书尽快告知所有用户——需要被吊销的证书和正常的证书在外观上没有任何区别，用户的浏览器必须依赖 CA 的外部消息通知才能知道哪些证书是被吊销的。",[17,1515,1517],{"id":1516},"firefox-是如何接收来自-ca-的吊销信息的","Firefox 是如何接收来自 CA 的吊销信息的？",[21,1519,1520],{},"Firefox 通过提供了两种方案，以便用户从 CA 处得知目标站点的证书是否被吊销。",[84,1522,1524],{"id":1523},"ocsp","OCSP",[21,1526,1527],{},"正如我前文所说的，Firefox 的 PC 端在与目标站点建立 https 连接之前，会先通过 http 协议向 CA 的 OCSP 服务器打一个 POST 请求来确认证书是否被吊销。",[21,1529,1530],{},"我们可以通过 openssl 拿到目标站点的 ssl 公钥，查看 CA 指定的 OCSP Server",[99,1532,1536],{"className":1533,"code":1534,"language":1535,"meta":104,"style":104},"language-bash shiki shiki-themes one-light one-dark-pro","openssl s_client -connect example.com:443 -servername example.com | openssl x509 -text -noout\n\n","bash",[94,1537,1538],{"__ignoreMap":104},[108,1539,1540,1543,1546,1549,1552,1555,1558,1561,1563,1566,1569],{"class":110,"line":111},[108,1541,1542],{"class":176},"openssl",[108,1544,1545],{"class":143}," s_client",[108,1547,1548],{"class":548}," -connect",[108,1550,1551],{"class":143}," example.com:443",[108,1553,1554],{"class":548}," -servername",[108,1556,1557],{"class":143}," example.com",[108,1559,1560],{"class":180}," | ",[108,1562,1542],{"class":176},[108,1564,1565],{"class":143}," x509",[108,1567,1568],{"class":548}," -text",[108,1570,1571],{"class":548}," -noout\n",[21,1573,1574],{},[1382,1575],{"alt":104,"src":1576},"https://static.031130.xyz/uploads/2024/11/19/32579fb56b77b.webp",[21,1578,1579],{},[1382,1580],{"alt":1581,"src":1582},"访问第二个链接时的抓包结果","https://static.031130.xyz/uploads/2024/11/19/244704705924f.webp",[1584,1585,1586],"h4",{"id":1586},"软失败",[21,1588,1589],{},"这个请求一共有三种结果:",[1591,1592,1593,1596,1599],"ol",{},[1429,1594,1595],{},"请求结果正常，证书没有被吊销：Firefox 继续和目标站点建立 https 连接",[1429,1597,1598],{},"请求结果正常，证书被吊销：Firefox 拒绝和目标站点建立 https 连接，如同我在博客开头贴的图",[1429,1600,1601],{},"请求结果异常（请求超时）：Firefox 继续和目标站点建立 https 连接",[21,1603,1604],{},"透过在第三种情况，我们可以发现，Firefox 对 OCSP 检查的结果是软失败 (soft fail) 态度——即如果在 OCSP 过程中发生异常，Firefox 将不得不放弃 OCSP 检查并放行。根据 Mozilla Blog 的说法，如今有 9.9% 的 OCSP 检查都是超时的。",[21,1606,1607],{},[1382,1608],{"alt":1609,"src":1610},"https://blog.mozilla.org/security/files/2020/01/figure4-ocsp_results.png","https://static.031130.xyz/uploads/2024/11/19/4a6c899a41128.webp",[1584,1612,1614],{"id":1613},"firefox-中的相关配置项","Firefox 中的相关配置项",[21,1616,1617,1618,1621],{},"在 Firefox 的 ",[94,1619,1620],{},"about:config"," 配置中搜索，我们可以看到一些关于 OCSP 的配置项",[1426,1623,1624,1641,1655,1661],{},[1429,1625,1626,1629,1630],{},[94,1627,1628],{},"security.OCSP.enabled",": 是否开启 OCSP 检查，默认为 1",[1426,1631,1632,1635,1638],{},[1429,1633,1634],{},"0: 关闭 OCSP 检查",[1429,1636,1637],{},"1: 开启 OCSP 检查",[1429,1639,1640],{},"2: 只对 EV 证书进行 OCSP 检查",[1429,1642,1643,1646,1647],{},[94,1644,1645],{},"security.OCSP.required",": 是否一定要通过 OCSP 才允许建立连接（即是否不允许“软失败”），默认为 false",[1426,1648,1649,1652],{},[1429,1650,1651],{},"false: 允许软失败",[1429,1653,1654],{},"true: 不允许软失败",[1429,1656,1657,1660],{},[94,1658,1659],{},"security.OCSP.timeoutMilliseconds.hard",": 针对 EV 证书，OCSP 检查的超时时间，默认为 10000 (10 秒)",[1429,1662,1663,1666],{},[94,1664,1665],{},"security.OCSP.timeoutMilliseconds.soft",": 针对 DV 和 OV 证书，OCSP 检查的超时时间，默认为 2000（2 秒），移动端为 1 秒。",[21,1668,1669],{},[1463,1670,1671,1672],{},"EV 证书相比 DV 和 OV 有更严苛的申请条件，区别可以参考",[25,1673,1676],{"href":1674,"rel":1675},"https://www.digicert.com/cn/difference-between-dv-ov-and-ev-ssl-certificates",[41],"DV、OV和EV SSL证书之间有什么区别？",[1584,1678,1679],{"id":1679},"弊端",[1426,1681,1682,1685,1693],{},[1429,1683,1684],{},"ocsp 不能在不增加用户负担的情况下使用硬失败(hard fail)，对于无响应或者超时的 ocsp 验证只能直接放行，这意味着攻击者可以直接屏蔽浏览器和 CA 之间的连接，拖到 ocsp 超时，并不能有效保障用户免受攻击。",[1429,1686,1687,1688,1487],{},"在 ocsp server 响应或者连接超时前，与目标站点的 https 连接会被阻塞，这带来了更大的访问延迟。有时还会出现",[25,1689,1692],{"href":1690,"rel":1691},"https://blog.wolfogre.com/posts/letsencrypt-ocsp-breakdown/",[41],"用户与 ocsp server 无法连接的情况",[1429,1694,1695],{},"ocsp 是由用户浏览器主动向 CA 发起 http 请求，可能会导致用户隐私泄漏（IP 地址、位置、用户的部分浏览历史记录等）。即使 CA 故意不保留这些信息，地区法律也可能强制 CA 收集这些信息。",[1584,1697,1699],{"id":1698},"ocsp-装订-ocsp-stapling","OCSP 装订 (OCSP stapling)",[21,1701,1702],{},"这是一种新的方式，由目标站点的服务器主动向 CA 的 ocsp 服务器缓存 ocsp 信息（有效期最长为 7 天），并将其在用户访问时将相关信息一起提供给用户，避免用户直接向 CA 的服务器发起查询请求，能够规避部分弊端（避免 CA 收集用户信息，规避用户与 CA OCSP 服务器连接性不好等问题）。",[21,1704,1705],{},"目前，caddy 是默认开启 OCSP 装订的，而 nginx 可以在配置后手动开启。",[21,1707,1708],{},"可以采用 openssl 来查询目标站点是否开启了 OCSP 装订：",[99,1710,1712],{"className":1533,"code":1711,"language":1535,"meta":104,"style":104},"openssl s_client -connect example.com:443 -status\n",[94,1713,1714],{"__ignoreMap":104},[108,1715,1716,1718,1720,1722,1724],{"class":110,"line":111},[108,1717,1542],{"class":176},[108,1719,1545],{"class":143},[108,1721,1548],{"class":548},[108,1723,1551],{"class":143},[108,1725,1726],{"class":548}," -status\n",[21,1728,1729],{},"如果开启了 OCSP 装订，那么返回的数据中会有 OCSP Response Data 相关的描述",[21,1731,1732],{},[1382,1733],{"alt":104,"src":1734},"https://static.031130.xyz/uploads/2024/11/19/71f252c97e96e.webp",[84,1736,1738],{"id":1737},"crlite-wip","CRLite (WIP)",[21,1740,1741,1746,1747,1752,1753],{},[25,1742,1745],{"href":1743,"rel":1744},"https://obj.umiacs.umd.edu/papers_for_stories/crlite_oakland17.pdf",[41],"CRLite"," 是 ",[25,1748,1751],{"href":1749,"rel":1750},"https://www.ieee-security.org/TC/SP2017/",[41],"2017 年 IEEE 安全和隐私研讨会","上一组研究人员提出的一项技术，该技术可以有效地压缩吊销信息，使 300 兆字节的吊销数据可以变成 1 兆字节。CRLite 数据由 Mozilla 收集处理后推送给浏览器实现证书状态的本地查找，",[1463,1754,1755],{},"这项技术仍然处于开发阶段。",[21,1757,1758],{},"当浏览器使用 CRLite 查询对应站点的 ssl 证书的有效状态时，一般会有 5 种查询结果",[1591,1760,1761,1764,1767,1770,1773],{},[1429,1762,1763],{},"Certificate Valid，表示 CRLite 权威返回证书有效。",[1429,1765,1766],{},"Certificate Revoked，表示 CRLite 权威返回证书已被吊销。",[1429,1768,1769],{},"Issuer Not Enrolled, 这意味着正在评估的证书未包含在 CRLite 筛选器集中，可能是因为颁发证书的证书颁发机构 （CA） 未发布 CRL。",[1429,1771,1772],{},"Certificate Too New，表示正在评估的证书比 CRLite 筛选器新。",[1429,1774,1775],{},"Filter Not Available，这意味着 CRLite 过滤器要么尚未从 Remote Settings 下载，要么已经过时以至于停止服务。",[21,1777,1778],{},"Mozilla 计划每天发布 4 次 CRLite 的更新，以减少第 4 种情况。",[1584,1780,1781],{"id":1781},"速度优势",[21,1783,1784],{},"CRLite 的本地数据查询相比起 OCSP 的在线查询拥有天然的优势，99% 的情况下，CRLite 会比 OCSP 快，其中 56% 的情况下，CRLite 会比 OCSP 快 100 毫秒以上。",[21,1786,1787],{},[1382,1788],{"alt":1789,"src":1790},"https://blog.mozilla.org/security/files/2020/01/figure3-speedup_vs_ocsp.png","https://static.031130.xyz/uploads/2024/11/19/bfba9ba3515ca.webp",[21,1792,1793],{},"此外，当 CRLite 不可用时，Firefox 仍然可以回退到传统的 OCSP 检测机制。",[17,1795,1796],{"id":1796},"其他",[21,1798,1799,1800,1805],{},"Let's Encrypt 在 2024 年 7 月",[25,1801,1804],{"href":1802,"rel":1803},"https://letsencrypt.org/2024/07/23/replacing-ocsp-with-crls/",[41],"发布博客","，CA/Browser Forum在上一年 8 月通过了一向投票允许 Let's Encrypt 等公开信任的 CA 将设立 OCSP server 作为可选选项。他们计划在未来 6~12 月内宣布关闭 OCSP 服务的时间表。",[17,1807,1808],{"id":1808},"参见",[1426,1810,1811,1818,1825,1832,1839,1846,1853,1860,1871,1878,1885,1891,1898,1904,1910,1916],{},[1429,1812,1813],{},[25,1814,1817],{"href":1815,"rel":1816},"https://wiki.mozilla.org/CA/Revocation_Checking_in_Firefox",[41],"CA/Revocation Checking in Firefox - MozillaWiki",[1429,1819,1820],{},[25,1821,1824],{"href":1822,"rel":1823},"https://discourse.mozilla.org/t/firefox-ocsp-policy/83150",[41],"Firefox OCSP policy - Firefox Development - Mozilla Discourse",[1429,1826,1827],{},[25,1828,1831],{"href":1829,"rel":1830},"https://knowledge.digicert.com/nl/nl/quovadis/ssl-certificates/ssl-general-topics/in-which-browsers-is-ocsp-online-certificates-status-protocol-supported-in",[41],"In which browsers is OCSP (Online Certificates Status Protocol) supported in?",[1429,1833,1834],{},[25,1835,1838],{"href":1836,"rel":1837},"https://blog.mozilla.org/security/2020/01/09/crlite-part-1-all-web-pki-revocations-compressed/",[41],"Introducing CRLite: All of the Web PKI’s revocations, compressed - Mozilla Security Blog",[1429,1840,1841],{},[25,1842,1845],{"href":1843,"rel":1844},"https://blog.mozilla.org/security/2020/01/21/crlite-part-3-speeding-up-secure-browsing/",[41],"CRLite: Speeding Up Secure Browsing - Mozilla Security Blog",[1429,1847,1848],{},[25,1849,1852],{"href":1850,"rel":1851},"https://blog.cloudflare.com/high-reliability-ocsp-stapling/",[41],"High-reliability OCSP stapling and why it matters - The Cloudflare Blog",[1429,1854,1855],{},[25,1856,1859],{"href":1857,"rel":1858},"https://en.wikipedia.org/wiki/Online_Certificate_Status_Protocol",[41],"Online Certificate Status Protocol - Wikipedia",[1429,1861,1862],{},[25,1863,1866,1867,1870],{"href":1864,"rel":1865},"https://bugzilla.mozilla.org/show_bug.cgi?id=1429800",[41],"1429800 - (crlite) ",[108,1868,1869],{},"meta"," Implement a CRLite based revocation mechanism",[1429,1872,1873],{},[25,1874,1877],{"href":1875,"rel":1876},"https://bugzilla.mozilla.org/show_bug.cgi?id=1761109",[41],"1761109 - Make check-revocations mode the default CRLite mode",[1429,1879,1880],{},[25,1881,1884],{"href":1882,"rel":1883},"https://www.reddit.com/r/browsers/comments/1bb81y8/firefox_the_only_browser_doing_certificate/",[41],"Firefox - The only browser doing certificate revocation checks right : r/browsers",[1429,1886,1887],{},[25,1888,1890],{"href":1802,"rel":1889},[41],"Intent to End OCSP Service - Let's Encrypt",[1429,1892,1893],{},[25,1894,1897],{"href":1895,"rel":1896},"https://groups.google.com/a/mozilla.org/g/dev-security-policy/c/S6A14e_X-T0/m/T4WxWgajAAAJ",[41],"Revocation checking for EV server certificates in Chrome - Google Groups",[1429,1899,1900],{},[25,1901,1903],{"href":1484,"rel":1902},[41],"CRLSets - The Chromium Projects",[1429,1905,1906],{},[25,1907,1909],{"href":1510,"rel":1908},[41],"由于Bug，Let's Encrypt决定吊销300多万张证书！",[1429,1911,1912],{},[25,1913,1915],{"href":1690,"rel":1914},[41],"Let’s Encrypt OCSP 域名被封",[1429,1917,1918],{},[25,1919,1676],{"href":1674,"rel":1920},[41],[1394,1922,1923],{},"html pre.shiki code .sAdtL, html code.shiki .sAdtL{--shiki-default:#4078F2;--shiki-dark:#61AFEF}html pre.shiki code .sDhpE, html code.shiki .sDhpE{--shiki-default:#50A14F;--shiki-dark:#98C379}html pre.shiki code .sAGMh, html code.shiki .sAGMh{--shiki-default:#986801;--shiki-dark:#D19A66}html pre.shiki code .s5ixo, html code.shiki .s5ixo{--shiki-default:#383A42;--shiki-dark:#ABB2BF}html .default .shiki span {color: var(--shiki-default);background: var(--shiki-default-bg);font-style: var(--shiki-default-font-style);font-weight: var(--shiki-default-font-weight);text-decoration: var(--shiki-default-text-decoration);}html .shiki span {color: var(--shiki-default);background: var(--shiki-default-bg);font-style: var(--shiki-default-font-style);font-weight: var(--shiki-default-font-weight);text-decoration: var(--shiki-default-text-decoration);}html .dark .shiki span {color: var(--shiki-dark);background: var(--shiki-dark-bg);font-style: var(--shiki-dark-font-style);font-weight: var(--shiki-dark-font-weight);text-decoration: var(--shiki-dark-text-decoration);}html.dark .shiki span {color: var(--shiki-dark);background: var(--shiki-dark-bg);font-style: var(--shiki-dark-font-style);font-weight: var(--shiki-dark-font-weight);text-decoration: var(--shiki-dark-text-decoration);}",{"title":104,"searchDepth":133,"depth":133,"links":1925},[1926,1927,1928,1932,1933],{"id":1420,"depth":133,"text":1421},{"id":1503,"depth":133,"text":1504},{"id":1516,"depth":133,"text":1517,"children":1929},[1930,1931],{"id":1523,"depth":147,"text":1524},{"id":1737,"depth":147,"text":1738},{"id":1796,"depth":133,"text":1796},{"id":1808,"depth":133,"text":1808},{"title":1935,"date":1936,"path":1937,"tags":1938,"body":1942},"小爱课程表适配不完全指北——以 ZJUT 本科正方教务系统为例","2024-11-18 21:13:56","/2024/11/18/mi-ai-class-schedule-adapter-for-zjut",[1939,1940,1941],"JavaScript","MiAI","Fun",{"type":14,"value":1943,"toc":4020},[1944,1947,1950,1953,1956,1964,1972,1975,1978,1989,2003,2010,2024,2027,2030,2039,2042,2045,2050,2053,2058,2061,2064,2067,2070,2075,2078,2081,2086,2092,2096,2099,2104,2107,2260,2263,2274,2277,2314,2317,2320,2419,2422,2425,2428,2435,2440,2444,2450,2453,2459,2478,2485,2846,2849,3051,3054,3137,3141,3144,3369,3372,3425,3428,3435,3438,3514,3517,3632,3639,3643,3652,3980,3983,3990,3993,3998,4001,4006,4009,4014,4017],[17,1945,1946],{"id":1946},"写在前面",[21,1948,1949],{},"一个月前，我发现小爱课程表中针对我学校的教务系统导入系统年久失修，因此我便决定自己另立门户、独立维护一版针对 ZJUT 教务系统课表信息导入的适配项目。",[21,1951,1952],{},"整个流程不难，如果你对于 js 代码和爬虫技术有简单的了解，那么很快就可以上手，我大概只花了 2 小时就完成了 阅读文档-编写代码-自测通过-提交审核 的过程，并在一周内正式上架，得到了身边同学的认可。",[21,1954,1955],{},"在适配过程中，一定要仔细阅读官方文档，所有技术性问题几乎都能通过官方文档解决。这篇博客我尽量详细记录了使用 fetch 打请求获取 json 的正方教务系统适配方案，仅供参考。",[21,1957,1958,1959],{},"官方文档地址: ",[25,1960,1963],{"href":1961,"rel":1962},"https://open-schedule-prod.ai.xiaomi.com/docs/#/help/",[41],"小爱课程表开发者工具使用教程",[21,1965,1966,1967],{},"我的代码: ",[25,1968,1971],{"href":1969,"rel":1970},"https://github.com/zhullyb/ZJUT-Mi-Schedule-Adapter/",[41],"Github",[17,1973,1974],{"id":1974},"运行原理",[21,1976,1977],{},"小爱课表获取课表信息的大致流程如下",[1591,1979,1980,1983,1986],{},[1429,1981,1982],{},"在你的手机上调用系统 webview 进入你指定的教务系统，让你手动输入账号密码并完成登陆流程",[1429,1984,1985],{},"获取含有课表信息的字符串（可以是直接获取页面展示的 html 代码，也可以是利用登陆时获取的 cookie/session 信息直接向后端发送请求拿响应）",[1429,1987,1988],{},"解析获取到的字符串，按照小米预先定义好的 json 格式输出",[21,1990,1991,1992,1995,1996,1999,2000],{},"作为适配者，我们需要提供三个代码文件，分别是 ",[94,1993,1994],{},"Provider","、",[94,1997,1998],{},"Parser"," 和 ",[94,2001,2002],{},"Timer",[21,2004,2005,1999,2007,2009],{},[94,2006,1994],{},[94,2008,2002],{}," 都在本地登陆好教务系统后的 webview 环境中执行，前者需要返回步骤 2 中描述的带有课表信息的字符串，Timer 则返回课程时间、学期周数等信息。",[21,2011,2012,2014,2015,2017,2018,2023],{},[94,2013,1994],{}," 获取到的字符串将会成为 ",[94,2016,1998],{}," 的函数参数，这个函数将会上传到小米的服务器中运行，根据文档所说是为了满足部分开发者保护自己的代码防止被抓包而刻意设计的（虽然我不理解这种东西有什么好闭源的，",[108,2019,2022],{"className":2020},[2021],"heimu","可能是为了防止友商批量抓包获取解析算法以后直接推出竞品","）。",[17,2025,2026],{"id":2026},"适配实战",[84,2028,2029],{"id":2029},"安装浏览器插件",[21,2031,2032,2033,2038],{},"首先下载小米提供给我们的资源包，目前我拿到的最新的版本是 v0.3.8，",[25,2034,2037],{"href":2035,"rel":2036},"https://open-schedule-prod.ai.xiaomi.com/docs/#/help/?id=%e4%b8%8b%e8%bd%bd",[41],"下载链接","。注意不要被后缀骗了，这不是个 rar 包，我这里后缀改成 tar 后可以被 ark 正确解压，后缀名是 rar 可能是开发者希望 Windows 用户能用 winrar 进行解压？",[21,2040,2041],{},"这里需要一个 Chromium-based 的浏览器安装小米提供的浏览器插件。",[21,2043,2044],{},"然后使用 Chrome 的「加载已解压的扩展程序」安装整个被解压的目录。Chrome 安装后提示 Manifest version 2 将会在 2024 年被弃用，不知道小米能不能在 Chrome 弃用前支持 Manifest version 3，趁着能用我先不管它。",[21,2046,2047],{},[1382,2048],{"alt":104,"src":2049},"https://static.031130.xyz/uploads/2024/11/18/f2a063c982a42.webp",[21,2051,2052],{},"随后打开自己学校的教务网站，F12 打开开发者工具，可以看到多了一栏叫「AISchedule」的选项",[21,2054,2055],{},[1382,2056],{"alt":104,"src":2057},"https://static.031130.xyz/uploads/2024/11/18/800054d7f4ff8.webp",[21,2059,2060],{},"随后正常登陆自己的小米账号，放一旁备用。",[84,2062,2063],{"id":2063},"抓数据包",[21,2065,2066],{},"随后，登陆自己的教务网站，打开课表页面，查看 F12 开发者工具的网络一览，刷新页面加载自己的课表，查看开发者页面中显示的数据流，找到含有课表信息的那一个。",[21,2068,2069],{},"这个流程我个人用惯了 Firefox 浏览器，因此数据分析这一块的截图都是 Firefox 的截图。",[21,2071,2072],{},[1382,2073],{"alt":104,"src":2074},"https://static.031130.xyz/uploads/2024/11/18/7ea6e1e0bbfcf.webp",[21,2076,2077],{},"在我的例子中，第一个请求的响应是一个 html 页面，勾勒出了这个页面的大致轮廓，不过没有样式。这是一个好的迹象，说明这大概率是一个前后端分离的站点，授课数据很可能是通过 json 的数据单独传递给前端的，我们就不需要从 html 中解析我们的课表。",[21,2079,2080],{},"如果能确定是前后端分离的站点，我们可以尝试勾选这里的「XHR」选项，XHR 的全名是 XMLHttpRequest，是一种前端向后端发起请求的方式，前后端的数据一般都会在这里展示。",[21,2082,2083],{},[1382,2084],{"alt":104,"src":2085},"https://static.031130.xyz/uploads/2024/11/18/36880519d2109.webp",[21,2087,2088,2089,2091],{},"我在第三个请求中发现了我的课表信息，在已经登陆的情况下，小米的课程表允许我通过 fetch 函数打一个相同的请求给后端，获取这个响应结果作为 ",[94,2090,1994],{}," 部分的输出字符串。",[84,2093,2095],{"id":2094},"调试-fetch-参数","调试 fetch 参数",[21,2097,2098],{},"这个请求的 fetch 函数如何构建？可以直接右键这个请求，在菜单中选择「复制为 Fetch 语句」",[21,2100,2101],{},[1382,2102],{"alt":104,"src":2103},"https://static.031130.xyz/uploads/2024/11/18/ff498f0a0957e.webp",[21,2105,2106],{},"复制下来的语句长下面这个样子",[99,2108,2110],{"className":101,"code":2109,"language":103,"meta":104,"style":104},"await fetch(\"http://www.gdjw.zjut.edu.cn/jwglxt/kbcx/xskbcx_cxXsgrkb.html?gnmkdm=N2151\", {\n    \"credentials\": \"include\",\n    \"headers\": {\n        \"User-Agent\": \"Mozilla/5.0 (X11; Linux x86_64; rv:133.0) Gecko/20100101 Firefox/133.0\",\n        \"Accept\": \"*/*\",\n        \"Accept-Language\": \"zh-CN,zh;q=0.8,zh-TW;q=0.7,zh-HK;q=0.5,en-US;q=0.3,en;q=0.2\",\n        \"Content-Type\": \"application/x-www-form-urlencoded;charset=utf-8\",\n        \"X-Requested-With\": \"XMLHttpRequest\"\n    },\n    \"referrer\": \"http://www.gdjw.zjut.edu.cn/jwglxt/kbcx/xskbcx_cxXskbcxIndex.html?gnmkdm=N2151&layout=default\",\n    \"body\": \"xnm=2024&xqm=3&kzlx=ck&xsdm=\",\n    \"method\": \"POST\",\n    \"mode\": \"cors\"\n});\n",[94,2111,2112,2125,2137,2146,2158,2170,2182,2194,2204,2209,2221,2233,2245,2255],{"__ignoreMap":104},[108,2113,2114,2116,2118,2120,2123],{"class":110,"line":111},[108,2115,889],{"class":114},[108,2117,892],{"class":176},[108,2119,181],{"class":180},[108,2121,2122],{"class":143},"\"http://www.gdjw.zjut.edu.cn/jwglxt/kbcx/xskbcx_cxXsgrkb.html?gnmkdm=N2151\"",[108,2124,905],{"class":180},[108,2126,2127,2130,2132,2135],{"class":110,"line":133},[108,2128,2129],{"class":143},"    \"credentials\"",[108,2131,545],{"class":544},[108,2133,2134],{"class":143}," \"include\"",[108,2136,919],{"class":180},[108,2138,2139,2142,2144],{"class":110,"line":147},[108,2140,2141],{"class":143},"    \"headers\"",[108,2143,545],{"class":544},[108,2145,197],{"class":180},[108,2147,2148,2151,2153,2156],{"class":110,"line":260},[108,2149,2150],{"class":143},"        \"User-Agent\"",[108,2152,545],{"class":544},[108,2154,2155],{"class":143}," \"Mozilla/5.0 (X11; Linux x86_64; rv:133.0) Gecko/20100101 Firefox/133.0\"",[108,2157,919],{"class":180},[108,2159,2160,2163,2165,2168],{"class":110,"line":284},[108,2161,2162],{"class":143},"        \"Accept\"",[108,2164,545],{"class":544},[108,2166,2167],{"class":143}," \"*/*\"",[108,2169,919],{"class":180},[108,2171,2172,2175,2177,2180],{"class":110,"line":311},[108,2173,2174],{"class":143},"        \"Accept-Language\"",[108,2176,545],{"class":544},[108,2178,2179],{"class":143}," \"zh-CN,zh;q=0.8,zh-TW;q=0.7,zh-HK;q=0.5,en-US;q=0.3,en;q=0.2\"",[108,2181,919],{"class":180},[108,2183,2184,2187,2189,2192],{"class":110,"line":345},[108,2185,2186],{"class":143},"        \"Content-Type\"",[108,2188,545],{"class":544},[108,2190,2191],{"class":143}," \"application/x-www-form-urlencoded;charset=utf-8\"",[108,2193,919],{"class":180},[108,2195,2196,2199,2201],{"class":110,"line":369},[108,2197,2198],{"class":143},"        \"X-Requested-With\"",[108,2200,545],{"class":544},[108,2202,2203],{"class":143}," \"XMLHttpRequest\"\n",[108,2205,2206],{"class":110,"line":389},[108,2207,2208],{"class":180},"    },\n",[108,2210,2211,2214,2216,2219],{"class":110,"line":398},[108,2212,2213],{"class":143},"    \"referrer\"",[108,2215,545],{"class":544},[108,2217,2218],{"class":143}," \"http://www.gdjw.zjut.edu.cn/jwglxt/kbcx/xskbcx_cxXskbcxIndex.html?gnmkdm=N2151&layout=default\"",[108,2220,919],{"class":180},[108,2222,2223,2226,2228,2231],{"class":110,"line":422},[108,2224,2225],{"class":143},"    \"body\"",[108,2227,545],{"class":544},[108,2229,2230],{"class":143}," \"xnm=2024&xqm=3&kzlx=ck&xsdm=\"",[108,2232,919],{"class":180},[108,2234,2235,2238,2240,2243],{"class":110,"line":428},[108,2236,2237],{"class":143},"    \"method\"",[108,2239,545],{"class":544},[108,2241,2242],{"class":143}," \"POST\"",[108,2244,919],{"class":180},[108,2246,2247,2250,2252],{"class":110,"line":597},[108,2248,2249],{"class":143},"    \"mode\"",[108,2251,545],{"class":544},[108,2253,2254],{"class":143}," \"cors\"\n",[108,2256,2257],{"class":110,"line":603},[108,2258,2259],{"class":180},"});\n",[21,2261,2262],{},"先看 body 部分",[1426,2264,2265,2268,2271],{},[1429,2266,2267],{},"xnm=2024 很明显是年份的意思",[1429,2269,2270],{},"xqm 表示学期，这个通过多次尝试获取不同学期的课表可以得出结果，3 表示第一学期，12 表示第二学期，16 表示第三学期（短学期）",[1429,2272,2273],{},"其余的参数我不关心，一模一样带上就行",[21,2275,2276],{},"这个函数是可以直接放在 F12 开发者工具的控制台中运行的，通过在 fetch 函数的尾部（分号前）添加一个回调函数就可以打印出函数获取的结果。",[99,2278,2280],{"className":101,"code":2279,"language":103,"meta":104,"style":104},"await fetch(...).then(response => response.json())\n",[94,2281,2282],{"__ignoreMap":104},[108,2283,2284,2286,2288,2290,2292,2295,2297,2299,2302,2304,2307,2309,2311],{"class":110,"line":111},[108,2285,889],{"class":114},[108,2287,892],{"class":176},[108,2289,181],{"class":180},[108,2291,1193],{"class":544},[108,2293,2294],{"class":180},").",[108,2296,1169],{"class":176},[108,2298,181],{"class":180},[108,2300,2301],{"class":190},"response",[108,2303,194],{"class":114},[108,2305,2306],{"class":218}," response",[108,2308,221],{"class":180},[108,2310,591],{"class":176},[108,2312,2313],{"class":180},"())\n",[21,2315,2316],{},"这就允许我们去尝试是否可以删减一些 fetch 函数的参数，获得相同的结果。",[21,2318,2319],{},"如删除 headers 中的 User-Agent、删除 referer 等等，我最后精简了一些参数，fetch 函数长这个样子。",[99,2321,2323],{"className":101,"code":2322,"language":103,"meta":104,"style":104},"await fetch(\"http://www.gdjw.zjut.edu.cn/jwglxt/kbcx/xskbcx_cxXsgrkb.html?gnmkdm=N2151\", {\n    \"credentials\": \"include\",\n    \"headers\": {\n        \"Accept\": \"*/*\",\n        \"Content-Type\": \"application/x-www-form-urlencoded;charset=utf-8\",\n        \"X-Requested-With\": \"XMLHttpRequest\"\n    },\n    \"body\": \"xnm=2024&xqm=3&kzlx=ck&xsdm=\",\n    \"method\": \"POST\",\n    \"mode\": \"cors\"\n});\n",[94,2324,2325,2337,2347,2355,2365,2375,2383,2387,2397,2407,2415],{"__ignoreMap":104},[108,2326,2327,2329,2331,2333,2335],{"class":110,"line":111},[108,2328,889],{"class":114},[108,2330,892],{"class":176},[108,2332,181],{"class":180},[108,2334,2122],{"class":143},[108,2336,905],{"class":180},[108,2338,2339,2341,2343,2345],{"class":110,"line":133},[108,2340,2129],{"class":143},[108,2342,545],{"class":544},[108,2344,2134],{"class":143},[108,2346,919],{"class":180},[108,2348,2349,2351,2353],{"class":110,"line":147},[108,2350,2141],{"class":143},[108,2352,545],{"class":544},[108,2354,197],{"class":180},[108,2356,2357,2359,2361,2363],{"class":110,"line":260},[108,2358,2162],{"class":143},[108,2360,545],{"class":544},[108,2362,2167],{"class":143},[108,2364,919],{"class":180},[108,2366,2367,2369,2371,2373],{"class":110,"line":284},[108,2368,2186],{"class":143},[108,2370,545],{"class":544},[108,2372,2191],{"class":143},[108,2374,919],{"class":180},[108,2376,2377,2379,2381],{"class":110,"line":311},[108,2378,2198],{"class":143},[108,2380,545],{"class":544},[108,2382,2203],{"class":143},[108,2384,2385],{"class":110,"line":345},[108,2386,2208],{"class":180},[108,2388,2389,2391,2393,2395],{"class":110,"line":369},[108,2390,2225],{"class":143},[108,2392,545],{"class":544},[108,2394,2230],{"class":143},[108,2396,919],{"class":180},[108,2398,2399,2401,2403,2405],{"class":110,"line":389},[108,2400,2237],{"class":143},[108,2402,545],{"class":544},[108,2404,2242],{"class":143},[108,2406,919],{"class":180},[108,2408,2409,2411,2413],{"class":110,"line":398},[108,2410,2249],{"class":143},[108,2412,545],{"class":544},[108,2414,2254],{"class":143},[108,2416,2417],{"class":110,"line":422},[108,2418,2259],{"class":180},[21,2420,2421],{},"现在，将 fetch 函数自身和其执行后获取的结果复制下来保存到本地备用，我们就可以开始写代码了。",[84,2423,2424],{"id":2424},"安装依赖",[21,2426,2427],{},"在刚刚的压缩包解压出来的目录中，有一个叫 localTools 的文件夹，我们可以把它复制到自己的工作目录下，我们的代码工作主要就是在那里进行。",[21,2429,2430,2431,2434],{},"打开 VSCode，命令行运行 ",[94,2432,2433],{},"pnpm i"," 安装其运行时的依赖，顺便截图给你们看一眼目录结构。",[21,2436,2437],{},[1382,2438],{"alt":104,"src":2439},"https://static.031130.xyz/uploads/2024/11/18/d8316deee7e50.webp",[84,2441,2443],{"id":2442},"编写-provider","编写 provider",[21,2445,2446,2447],{},"首先编写 ",[94,2448,2449],{},"code/provider.js",[21,2451,2452],{},"在这个文件中，我们需要执行 fetch 函数，return 其获取到的 json 数据。",[21,2454,2455,2456],{},"按照官方文档，先 ",[94,2457,2458],{},"loadTool",[99,2460,2462],{"className":101,"code":2461,"language":103,"meta":104,"style":104},"await loadTool('AIScheduleTools')\n",[94,2463,2464],{"__ignoreMap":104},[108,2465,2466,2468,2471,2473,2476],{"class":110,"line":111},[108,2467,889],{"class":114},[108,2469,2470],{"class":176}," loadTool",[108,2472,181],{"class":180},[108,2474,2475],{"class":143},"'AIScheduleTools'",[108,2477,234],{"class":180},[21,2479,2480,2481,2484],{},"随后，我选择使用 ",[94,2482,2483],{},"AISchedulePrompt"," 这个小米封装的工具让用户手动输入需要导入课表的学年和学期信息，并对输入数据进行简单校验。",[99,2486,2488],{"className":101,"code":2487,"language":103,"meta":104,"style":104},"const year = await AISchedulePrompt({\n  titleText: '学年',\n  tipText: '请输入本学年开始的年份',\n  defaultText: '2024',\n  validator: value => {\n    try {\n      const v = parseInt(value)\n      if (v \u003C 2000 || v > 2100) {\n        return '请输入正确的学年'\n      }\n      return false\n    } catch (error) {\n      return '请输入正确的学年'\n    }\n  }\n})\n\nconst term = await AISchedulePrompt({\n  titleText: '学期',\n  tipText: '请输入本学期的学期(1,2,3 分别表示上、下、短学期)',\n  defaultText: '1',\n  validator: value => {\n    if (value === '1' || value === '2' || value === '3') {\n      return false\n    }\n    return '请输入正确的学期'\n  }\n})\n\nconst xqm = {\n  '1': '3',\n  '2': '12',\n  '3': '16',\n}[term]\n",[94,2489,2490,2507,2519,2531,2543,2557,2564,2583,2611,2618,2623,2631,2646,2652,2656,2660,2664,2668,2683,2694,2705,2716,2728,2760,2766,2770,2777,2781,2785,2789,2800,2811,2823,2835],{"__ignoreMap":104},[108,2491,2492,2494,2497,2499,2501,2504],{"class":110,"line":111},[108,2493,115],{"class":114},[108,2495,2496],{"class":118}," year",[108,2498,123],{"class":122},[108,2500,579],{"class":114},[108,2502,2503],{"class":176}," AISchedulePrompt",[108,2505,2506],{"class":180},"({\n",[108,2508,2509,2512,2514,2517],{"class":110,"line":133},[108,2510,2511],{"class":230},"  titleText",[108,2513,545],{"class":544},[108,2515,2516],{"class":143}," '学年'",[108,2518,919],{"class":180},[108,2520,2521,2524,2526,2529],{"class":110,"line":147},[108,2522,2523],{"class":230},"  tipText",[108,2525,545],{"class":544},[108,2527,2528],{"class":143}," '请输入本学年开始的年份'",[108,2530,919],{"class":180},[108,2532,2533,2536,2538,2541],{"class":110,"line":260},[108,2534,2535],{"class":230},"  defaultText",[108,2537,545],{"class":544},[108,2539,2540],{"class":143}," '2024'",[108,2542,919],{"class":180},[108,2544,2545,2548,2550,2553,2555],{"class":110,"line":284},[108,2546,2547],{"class":176},"  validator",[108,2549,545],{"class":544},[108,2551,2552],{"class":190}," value",[108,2554,194],{"class":114},[108,2556,197],{"class":180},[108,2558,2559,2562],{"class":110,"line":311},[108,2560,2561],{"class":114},"    try",[108,2563,197],{"class":180},[108,2565,2566,2569,2571,2573,2576,2578,2581],{"class":110,"line":345},[108,2567,2568],{"class":114},"      const",[108,2570,1315],{"class":118},[108,2572,123],{"class":122},[108,2574,2575],{"class":176}," parseInt",[108,2577,181],{"class":180},[108,2579,2580],{"class":278},"value",[108,2582,234],{"class":180},[108,2584,2585,2588,2590,2592,2595,2598,2601,2603,2606,2609],{"class":110,"line":369},[108,2586,2587],{"class":114},"      if",[108,2589,242],{"class":180},[108,2591,1342],{"class":278},[108,2593,2594],{"class":122}," \u003C",[108,2596,2597],{"class":548}," 2000",[108,2599,2600],{"class":122}," ||",[108,2602,1315],{"class":278},[108,2604,2605],{"class":122}," >",[108,2607,2608],{"class":548}," 2100",[108,2610,257],{"class":180},[108,2612,2613,2615],{"class":110,"line":389},[108,2614,980],{"class":114},[108,2616,2617],{"class":143}," '请输入正确的学年'\n",[108,2619,2620],{"class":110,"line":398},[108,2621,2622],{"class":180},"      }\n",[108,2624,2625,2628],{"class":110,"line":422},[108,2626,2627],{"class":114},"      return",[108,2629,2630],{"class":548}," false\n",[108,2632,2633,2636,2639,2641,2644],{"class":110,"line":428},[108,2634,2635],{"class":180},"    } ",[108,2637,2638],{"class":114},"catch",[108,2640,242],{"class":180},[108,2642,2643],{"class":278},"error",[108,2645,257],{"class":180},[108,2647,2648,2650],{"class":110,"line":597},[108,2649,2627],{"class":114},[108,2651,2617],{"class":143},[108,2653,2654],{"class":110,"line":603},[108,2655,988],{"class":180},[108,2657,2658],{"class":110,"line":626},[108,2659,425],{"class":180},[108,2661,2662],{"class":110,"line":631},[108,2663,431],{"class":180},[108,2665,2666],{"class":110,"line":648},[108,2667,562],{"emptyLinePlaceholder":561},[108,2669,2670,2672,2675,2677,2679,2681],{"class":110,"line":654},[108,2671,115],{"class":114},[108,2673,2674],{"class":118}," term",[108,2676,123],{"class":122},[108,2678,579],{"class":114},[108,2680,2503],{"class":176},[108,2682,2506],{"class":180},[108,2684,2685,2687,2689,2692],{"class":110,"line":659},[108,2686,2511],{"class":230},[108,2688,545],{"class":544},[108,2690,2691],{"class":143}," '学期'",[108,2693,919],{"class":180},[108,2695,2696,2698,2700,2703],{"class":110,"line":664},[108,2697,2523],{"class":230},[108,2699,545],{"class":544},[108,2701,2702],{"class":143}," '请输入本学期的学期(1,2,3 分别表示上、下、短学期)'",[108,2704,919],{"class":180},[108,2706,2707,2709,2711,2714],{"class":110,"line":670},[108,2708,2535],{"class":230},[108,2710,545],{"class":544},[108,2712,2713],{"class":143}," '1'",[108,2715,919],{"class":180},[108,2717,2718,2720,2722,2724,2726],{"class":110,"line":675},[108,2719,2547],{"class":176},[108,2721,545],{"class":544},[108,2723,2552],{"class":190},[108,2725,194],{"class":114},[108,2727,197],{"class":180},[108,2729,2730,2732,2734,2736,2738,2740,2742,2744,2746,2749,2751,2753,2755,2758],{"class":110,"line":680},[108,2731,962],{"class":114},[108,2733,242],{"class":180},[108,2735,2580],{"class":278},[108,2737,252],{"class":122},[108,2739,2713],{"class":143},[108,2741,2600],{"class":122},[108,2743,2552],{"class":278},[108,2745,252],{"class":122},[108,2747,2748],{"class":143}," '2'",[108,2750,2600],{"class":122},[108,2752,2552],{"class":278},[108,2754,252],{"class":122},[108,2756,2757],{"class":143}," '3'",[108,2759,257],{"class":180},[108,2761,2762,2764],{"class":110,"line":696},[108,2763,2627],{"class":114},[108,2765,2630],{"class":548},[108,2767,2768],{"class":110,"line":713},[108,2769,988],{"class":180},[108,2771,2772,2774],{"class":110,"line":733},[108,2773,526],{"class":114},[108,2775,2776],{"class":143}," '请输入正确的学期'\n",[108,2778,2779],{"class":110,"line":738},[108,2780,425],{"class":180},[108,2782,2783],{"class":110,"line":743},[108,2784,431],{"class":180},[108,2786,2787],{"class":110,"line":748},[108,2788,562],{"emptyLinePlaceholder":561},[108,2790,2791,2793,2796,2798],{"class":110,"line":753},[108,2792,115],{"class":114},[108,2794,2795],{"class":118}," xqm",[108,2797,123],{"class":122},[108,2799,197],{"class":180},[108,2801,2802,2805,2807,2809],{"class":110,"line":759},[108,2803,2804],{"class":143},"  '1'",[108,2806,545],{"class":544},[108,2808,2757],{"class":143},[108,2810,919],{"class":180},[108,2812,2813,2816,2818,2821],{"class":110,"line":765},[108,2814,2815],{"class":143},"  '2'",[108,2817,545],{"class":544},[108,2819,2820],{"class":143}," '12'",[108,2822,919],{"class":180},[108,2824,2825,2828,2830,2833],{"class":110,"line":770},[108,2826,2827],{"class":143},"  '3'",[108,2829,545],{"class":544},[108,2831,2832],{"class":143}," '16'",[108,2834,919],{"class":180},[108,2836,2837,2840,2843],{"class":110,"line":784},[108,2838,2839],{"class":180},"}[",[108,2841,2842],{"class":278},"term",[108,2844,2845],{"class":180},"]\n",[21,2847,2848],{},"随后将学年和学期信息拼入 fetch 函数，打出请求，并将返回的 json 数据转为 string 作为函数的返回值",[99,2850,2852],{"className":101,"code":2851,"language":103,"meta":104,"style":104},"const res = await fetch(\"http://www.gdjw.zjut.edu.cn/jwglxt/kbcx/xskbcx_cxXsgrkb.html?gnmkdm=N2151\", {\n  \"headers\": {\n    \"accept\": \"*/*\",\n    \"content-type\": \"application/x-www-form-urlencoded;charset=UTF-8\",\n    \"x-requested-with\": \"XMLHttpRequest\"\n  },\n  \"referrerPolicy\": \"strict-origin-when-cross-origin\",\n  \"body\": `xnm=${year}&xqm=${xqm}&kzlx=ck&xsdm=`,\n  \"method\": \"POST\",\n  \"mode\": \"cors\",\n  \"credentials\": \"include\"\n})\n\nconst ret = await res.json()\nreturn JSON.stringify(ret.kbList)\n",[94,2853,2854,2873,2882,2893,2905,2914,2919,2931,2966,2977,2989,2999,3003,3007,3026],{"__ignoreMap":104},[108,2855,2856,2858,2861,2863,2865,2867,2869,2871],{"class":110,"line":111},[108,2857,115],{"class":114},[108,2859,2860],{"class":118}," res",[108,2862,123],{"class":122},[108,2864,579],{"class":114},[108,2866,892],{"class":176},[108,2868,181],{"class":180},[108,2870,2122],{"class":143},[108,2872,905],{"class":180},[108,2874,2875,2878,2880],{"class":110,"line":133},[108,2876,2877],{"class":143},"  \"headers\"",[108,2879,545],{"class":544},[108,2881,197],{"class":180},[108,2883,2884,2887,2889,2891],{"class":110,"line":147},[108,2885,2886],{"class":143},"    \"accept\"",[108,2888,545],{"class":544},[108,2890,2167],{"class":143},[108,2892,919],{"class":180},[108,2894,2895,2898,2900,2903],{"class":110,"line":260},[108,2896,2897],{"class":143},"    \"content-type\"",[108,2899,545],{"class":544},[108,2901,2902],{"class":143}," \"application/x-www-form-urlencoded;charset=UTF-8\"",[108,2904,919],{"class":180},[108,2906,2907,2910,2912],{"class":110,"line":284},[108,2908,2909],{"class":143},"    \"x-requested-with\"",[108,2911,545],{"class":544},[108,2913,2203],{"class":143},[108,2915,2916],{"class":110,"line":311},[108,2917,2918],{"class":180},"  },\n",[108,2920,2921,2924,2926,2929],{"class":110,"line":345},[108,2922,2923],{"class":143},"  \"referrerPolicy\"",[108,2925,545],{"class":544},[108,2927,2928],{"class":143}," \"strict-origin-when-cross-origin\"",[108,2930,919],{"class":180},[108,2932,2933,2936,2938,2941,2945,2948,2951,2954,2956,2959,2961,2964],{"class":110,"line":369},[108,2934,2935],{"class":143},"  \"body\"",[108,2937,545],{"class":544},[108,2939,2940],{"class":143}," `xnm=",[108,2942,2944],{"class":2943},"sAOjX","${",[108,2946,2947],{"class":278},"year",[108,2949,2950],{"class":2943},"}",[108,2952,2953],{"class":143},"&xqm=",[108,2955,2944],{"class":2943},[108,2957,2958],{"class":278},"xqm",[108,2960,2950],{"class":2943},[108,2962,2963],{"class":143},"&kzlx=ck&xsdm=`",[108,2965,919],{"class":180},[108,2967,2968,2971,2973,2975],{"class":110,"line":389},[108,2969,2970],{"class":143},"  \"method\"",[108,2972,545],{"class":544},[108,2974,2242],{"class":143},[108,2976,919],{"class":180},[108,2978,2979,2982,2984,2987],{"class":110,"line":398},[108,2980,2981],{"class":143},"  \"mode\"",[108,2983,545],{"class":544},[108,2985,2986],{"class":143}," \"cors\"",[108,2988,919],{"class":180},[108,2990,2991,2994,2996],{"class":110,"line":422},[108,2992,2993],{"class":143},"  \"credentials\"",[108,2995,545],{"class":544},[108,2997,2998],{"class":143}," \"include\"\n",[108,3000,3001],{"class":110,"line":428},[108,3002,431],{"class":180},[108,3004,3005],{"class":110,"line":597},[108,3006,562],{"emptyLinePlaceholder":561},[108,3008,3009,3011,3014,3016,3018,3020,3022,3024],{"class":110,"line":603},[108,3010,115],{"class":114},[108,3012,3013],{"class":118}," ret",[108,3015,123],{"class":122},[108,3017,579],{"class":114},[108,3019,2860],{"class":218},[108,3021,221],{"class":180},[108,3023,591],{"class":176},[108,3025,594],{"class":180},[108,3027,3028,3031,3034,3036,3039,3041,3044,3046,3049],{"class":110,"line":626},[108,3029,3030],{"class":114},"return",[108,3032,3033],{"class":118}," JSON",[108,3035,221],{"class":180},[108,3037,3038],{"class":176},"stringify",[108,3040,181],{"class":180},[108,3042,3043],{"class":218},"ret",[108,3045,221],{"class":180},[108,3047,3048],{"class":230},"kbList",[108,3050,234],{"class":180},[21,3052,3053],{},"最外层使用 try-catch 做简单的异常处理，如果出错就让用户确认是否正确登陆了教务系统",[99,3055,3057],{"className":101,"code":3056,"language":103,"meta":104,"style":104},"async function scheduleHtmlProvider() {\n  await loadTool('AIScheduleTools')\n  try {\n    //...\n  } catch (error) {\n    await AIScheduleAlert('请确定你已经登陆了教务系统')\n    return 'do not continue'\n  }\n}\n",[94,3058,3059,3071,3084,3091,3096,3108,3122,3129,3133],{"__ignoreMap":104},[108,3060,3061,3063,3065,3068],{"class":110,"line":111},[108,3062,467],{"class":114},[108,3064,470],{"class":114},[108,3066,3067],{"class":176}," scheduleHtmlProvider",[108,3069,3070],{"class":180},"() {\n",[108,3072,3073,3076,3078,3080,3082],{"class":110,"line":133},[108,3074,3075],{"class":114},"  await",[108,3077,2470],{"class":176},[108,3079,181],{"class":180},[108,3081,2475],{"class":143},[108,3083,234],{"class":180},[108,3085,3086,3089],{"class":110,"line":147},[108,3087,3088],{"class":114},"  try",[108,3090,197],{"class":180},[108,3092,3093],{"class":110,"line":260},[108,3094,3095],{"class":129},"    //...\n",[108,3097,3098,3100,3102,3104,3106],{"class":110,"line":284},[108,3099,287],{"class":180},[108,3101,2638],{"class":114},[108,3103,242],{"class":180},[108,3105,2643],{"class":278},[108,3107,257],{"class":180},[108,3109,3110,3112,3115,3117,3120],{"class":110,"line":311},[108,3111,716],{"class":114},[108,3113,3114],{"class":176}," AIScheduleAlert",[108,3116,181],{"class":180},[108,3118,3119],{"class":143},"'请确定你已经登陆了教务系统'",[108,3121,234],{"class":180},[108,3123,3124,3126],{"class":110,"line":345},[108,3125,526],{"class":114},[108,3127,3128],{"class":143}," 'do not continue'\n",[108,3130,3131],{"class":110,"line":369},[108,3132,425],{"class":180},[108,3134,3135],{"class":110,"line":389},[108,3136,651],{"class":180},[84,3138,3140],{"id":3139},"编写-parser","编写 parser",[21,3142,3143],{},"官方文档对 parser 函数做了明确的规范，格式如下",[99,3145,3148],{"className":3146,"code":3147,"language":591,"meta":104,"style":104},"language-json shiki shiki-themes one-light one-dark-pro","[\n  {\n    name: \"数学\", // 课程名称\n    position: \"教学楼1\", // 上课地点\n    teacher: \"张三\", // 教师名称\n    weeks: [1, 2, 3, 4], // 周数\n    day: 3, // 星期\n    sections: [1, 2, 3], // 节次\n  },{\n    name: \"数学\",\n    position: \"教学楼1\",\n    teacher: \"张三\",\n    weeks: [1, 2, 3, 4],\n    day: 1,\n    sections: [1, 2, 3],\n  },\n]\n",[94,3149,3150,3155,3160,3177,3192,3207,3239,3253,3275,3280,3290,3300,3310,3333,3343,3361,3365],{"__ignoreMap":104},[108,3151,3152],{"class":110,"line":111},[108,3153,3154],{"class":180},"[\n",[108,3156,3157],{"class":110,"line":133},[108,3158,3159],{"class":180},"  {\n",[108,3161,3162,3166,3169,3172,3174],{"class":110,"line":147},[108,3163,3165],{"class":3164},"sUNH4","    name",[108,3167,3168],{"class":180},": ",[108,3170,3171],{"class":143},"\"数学\"",[108,3173,187],{"class":180},[108,3175,3176],{"class":129},"// 课程名称\n",[108,3178,3179,3182,3184,3187,3189],{"class":110,"line":260},[108,3180,3181],{"class":3164},"    position",[108,3183,3168],{"class":180},[108,3185,3186],{"class":143},"\"教学楼1\"",[108,3188,187],{"class":180},[108,3190,3191],{"class":129},"// 上课地点\n",[108,3193,3194,3197,3199,3202,3204],{"class":110,"line":284},[108,3195,3196],{"class":3164},"    teacher",[108,3198,3168],{"class":180},[108,3200,3201],{"class":143},"\"张三\"",[108,3203,187],{"class":180},[108,3205,3206],{"class":129},"// 教师名称\n",[108,3208,3209,3212,3215,3218,3220,3223,3225,3228,3230,3233,3236],{"class":110,"line":311},[108,3210,3211],{"class":3164},"    weeks",[108,3213,3214],{"class":180},": [",[108,3216,3217],{"class":548},"1",[108,3219,187],{"class":180},[108,3221,3222],{"class":548},"2",[108,3224,187],{"class":180},[108,3226,3227],{"class":548},"3",[108,3229,187],{"class":180},[108,3231,3232],{"class":548},"4",[108,3234,3235],{"class":180},"], ",[108,3237,3238],{"class":129},"// 周数\n",[108,3240,3241,3244,3246,3248,3250],{"class":110,"line":345},[108,3242,3243],{"class":3164},"    day",[108,3245,3168],{"class":180},[108,3247,3227],{"class":548},[108,3249,187],{"class":180},[108,3251,3252],{"class":129},"// 星期\n",[108,3254,3255,3258,3260,3262,3264,3266,3268,3270,3272],{"class":110,"line":369},[108,3256,3257],{"class":3164},"    sections",[108,3259,3214],{"class":180},[108,3261,3217],{"class":548},[108,3263,187],{"class":180},[108,3265,3222],{"class":548},[108,3267,187],{"class":180},[108,3269,3227],{"class":548},[108,3271,3235],{"class":180},[108,3273,3274],{"class":129},"// 节次\n",[108,3276,3277],{"class":110,"line":389},[108,3278,3279],{"class":180},"  },{\n",[108,3281,3282,3284,3286,3288],{"class":110,"line":398},[108,3283,3165],{"class":3164},[108,3285,3168],{"class":180},[108,3287,3171],{"class":143},[108,3289,919],{"class":180},[108,3291,3292,3294,3296,3298],{"class":110,"line":422},[108,3293,3181],{"class":3164},[108,3295,3168],{"class":180},[108,3297,3186],{"class":143},[108,3299,919],{"class":180},[108,3301,3302,3304,3306,3308],{"class":110,"line":428},[108,3303,3196],{"class":3164},[108,3305,3168],{"class":180},[108,3307,3201],{"class":143},[108,3309,919],{"class":180},[108,3311,3312,3314,3316,3318,3320,3322,3324,3326,3328,3330],{"class":110,"line":597},[108,3313,3211],{"class":3164},[108,3315,3214],{"class":180},[108,3317,3217],{"class":548},[108,3319,187],{"class":180},[108,3321,3222],{"class":548},[108,3323,187],{"class":180},[108,3325,3227],{"class":548},[108,3327,187],{"class":180},[108,3329,3232],{"class":548},[108,3331,3332],{"class":180},"],\n",[108,3334,3335,3337,3339,3341],{"class":110,"line":603},[108,3336,3243],{"class":3164},[108,3338,3168],{"class":180},[108,3340,3217],{"class":548},[108,3342,919],{"class":180},[108,3344,3345,3347,3349,3351,3353,3355,3357,3359],{"class":110,"line":626},[108,3346,3257],{"class":3164},[108,3348,3214],{"class":180},[108,3350,3217],{"class":548},[108,3352,187],{"class":180},[108,3354,3222],{"class":548},[108,3356,187],{"class":180},[108,3358,3227],{"class":548},[108,3360,3332],{"class":180},[108,3362,3363],{"class":110,"line":631},[108,3364,2918],{"class":180},[108,3366,3367],{"class":110,"line":648},[108,3368,2845],{"class":180},[21,3370,3371],{},"最外层是一个 array，里面包含若干个 object，每个 object 表示一节课",[3373,3374,3375,3382,3387,3392,3403,3413],"blockquote",{},[21,3376,3377,3378,3381],{},"课程名称：",[94,3379,3380],{},"String"," 长度50字节（一汉字两字节）",[21,3383,3384,3385,3381],{},"上课地点：",[94,3386,3380],{},[21,3388,3389,3390,3381],{},"教师名称：",[94,3391,3380],{},[21,3393,3394,3395,3398,3399,3402],{},"周数：",[94,3396,3397],{},"Number[]"," ",[108,3400,3401],{},"1，30"," 之间的整数 超出会被裁掉",[21,3404,3405,3406,3398,3409,3412],{},"星期：",[94,3407,3408],{},"Number",[108,3410,3411],{},"1，7"," 之间的整数",[21,3414,3415,3416,3398,3418,3420,3421,3424],{},"节次：",[94,3417,3408],{},[108,3419,3401],{}," 之间的整数 (默认",[108,3422,3423],{},"1，12",") 根据后续时间设置自动裁剪",[21,3426,3427],{},"（只有这节课的星期几、上课地点、上课时间都一致才算一节课。比如我一周上两节算法课，周一 34 节和周三 56，那么这应该分成两个 object 来写）",[21,3429,3430,3431,3434],{},"这部分代码没什么好说的，就是对 ",[94,3432,3433],{},"provider"," 传过来的 string 用 js 做字符串解析，最后把整个 array 作为返回值返回就行，需要注意处理数组越界、空数组等等的低级错误。",[21,3436,3437],{},"第一步是将刚才的字符串转成 json 格式（如果你采用的是解析 html 的方式，请参考官方文档）",[99,3439,3441],{"className":101,"code":3440,"language":103,"meta":104,"style":104},"function scheduleHtmlParser(json_str) {\n  courses_json = JSON.parse(json_str)\n  const courseInfos = []\n\n  //...\n  \n  return courseInfos\n}\n",[94,3442,3443,3457,3477,3489,3493,3498,3503,3510],{"__ignoreMap":104},[108,3444,3445,3447,3450,3452,3455],{"class":110,"line":111},[108,3446,773],{"class":114},[108,3448,3449],{"class":176}," scheduleHtmlParser",[108,3451,181],{"class":180},[108,3453,3454],{"class":190},"json_str",[108,3456,257],{"class":180},[108,3458,3459,3462,3464,3466,3468,3471,3473,3475],{"class":110,"line":133},[108,3460,3461],{"class":278},"  courses_json",[108,3463,123],{"class":122},[108,3465,3033],{"class":118},[108,3467,221],{"class":180},[108,3469,3470],{"class":176},"parse",[108,3472,181],{"class":180},[108,3474,3454],{"class":278},[108,3476,234],{"class":180},[108,3478,3479,3481,3484,3486],{"class":110,"line":147},[108,3480,202],{"class":114},[108,3482,3483],{"class":118}," courseInfos",[108,3485,123],{"class":122},[108,3487,3488],{"class":180}," []\n",[108,3490,3491],{"class":110,"line":260},[108,3492,562],{"emptyLinePlaceholder":561},[108,3494,3495],{"class":110,"line":284},[108,3496,3497],{"class":129},"  //...\n",[108,3499,3500],{"class":110,"line":311},[108,3501,3502],{"class":180},"  \n",[108,3504,3505,3507],{"class":110,"line":345},[108,3506,634],{"class":114},[108,3508,3509],{"class":278}," courseInfos\n",[108,3511,3512],{"class":110,"line":369},[108,3513,651],{"class":180},[21,3515,3516],{},"如果需要一个临时的测试方案，可以用以下的测试结构",[99,3518,3520],{"className":101,"code":3519,"language":103,"meta":104,"style":104},"function scheduleHtmlParser(json_str) {\n  courses_json = JSON.parse(json_str)\n  const courseInfos = []\n\n  //...\n  \n  return courseInfos\n}\n\ninput_text = `\n// 这里是我在上文中复制的 fetch 函数输出的 json 结果\n`\n\nconsole.log(scheduleHtmlParser(input_text))\n",[94,3521,3522,3534,3552,3562,3566,3570,3574,3580,3584,3588,3598,3603,3608,3612],{"__ignoreMap":104},[108,3523,3524,3526,3528,3530,3532],{"class":110,"line":111},[108,3525,773],{"class":114},[108,3527,3449],{"class":176},[108,3529,181],{"class":180},[108,3531,3454],{"class":190},[108,3533,257],{"class":180},[108,3535,3536,3538,3540,3542,3544,3546,3548,3550],{"class":110,"line":133},[108,3537,3461],{"class":278},[108,3539,123],{"class":122},[108,3541,3033],{"class":118},[108,3543,221],{"class":180},[108,3545,3470],{"class":176},[108,3547,181],{"class":180},[108,3549,3454],{"class":278},[108,3551,234],{"class":180},[108,3553,3554,3556,3558,3560],{"class":110,"line":147},[108,3555,202],{"class":114},[108,3557,3483],{"class":118},[108,3559,123],{"class":122},[108,3561,3488],{"class":180},[108,3563,3564],{"class":110,"line":260},[108,3565,562],{"emptyLinePlaceholder":561},[108,3567,3568],{"class":110,"line":284},[108,3569,3497],{"class":129},[108,3571,3572],{"class":110,"line":311},[108,3573,3502],{"class":180},[108,3575,3576,3578],{"class":110,"line":345},[108,3577,634],{"class":114},[108,3579,3509],{"class":278},[108,3581,3582],{"class":110,"line":369},[108,3583,651],{"class":180},[108,3585,3586],{"class":110,"line":389},[108,3587,562],{"emptyLinePlaceholder":561},[108,3589,3590,3593,3595],{"class":110,"line":398},[108,3591,3592],{"class":278},"input_text",[108,3594,123],{"class":122},[108,3596,3597],{"class":143}," `\n",[108,3599,3600],{"class":110,"line":422},[108,3601,3602],{"class":143},"// 这里是我在上文中复制的 fetch 函数输出的 json 结果\n",[108,3604,3605],{"class":110,"line":428},[108,3606,3607],{"class":143},"`\n",[108,3609,3610],{"class":110,"line":597},[108,3611,562],{"emptyLinePlaceholder":561},[108,3613,3614,3617,3619,3621,3623,3626,3628,3630],{"class":110,"line":603},[108,3615,3616],{"class":218},"console",[108,3618,221],{"class":180},[108,3620,1063],{"class":176},[108,3622,181],{"class":180},[108,3624,3625],{"class":176},"scheduleHtmlParser",[108,3627,181],{"class":180},[108,3629,3592],{"class":278},[108,3631,281],{"class":180},[21,3633,3634,3635,3638],{},"执行 ",[94,3636,3637],{},"node code/parser.js"," ，观察输出结果是否和官方要求的结构严格一致。",[84,3640,3642],{"id":3641},"编写-timer","编写 timer",[21,3644,3645,3648,3649,3651],{},[94,3646,3647],{},"timer"," 函数的运行环境和 ",[94,3650,3433],{}," 一致，都允许你使用 fetch 向教务系统打请求，或者解析页面的 html 函数，但我们学校的教务系统一不写第一周的周一是几号，二不写每节课具体的上下课时间，所以我把我校的相关数据都进行了硬编码，这里直接放个官方文档的示例文件。",[99,3653,3655],{"className":101,"code":3654,"language":103,"meta":104,"style":104},"/**\n * 时间配置函数，此为入口函数，不要改动函数名\n */\nasync function scheduleTimer({\n  providerRes,\n  parserRes\n} = {}) {\n  // 支持异步操作 推荐await写法\n\n  // 这是一个示例函数，用于演示，正常用不到可以删掉\n  const someAsyncFunc = () => new Promise(resolve => {\n    setTimeout(() => resolve(), 1)\n  })\n  await someAsyncFunc()\n\n  // 这个函数中也支持使用 AIScheduleTools 譬如给出多条时间配置让用户选择之类的\n\n  // 返回时间配置JSON，所有项都为可选项，如果不进行时间配置，请返回空对象\n  return {\n    totalWeek: 20, // 总周数：[1, 30]之间的整数\n    startSemester: '', // 开学时间：时间戳，13位长度字符串，推荐用代码生成\n    startWithSunday: false, // 是否是周日为起始日，该选项为true时，会开启显示周末选项\n    showWeekend: false, // 是否显示周末\n    forenoon: 1, // 上午课程节数：[1, 10]之间的整数\n    afternoon: 0, // 下午课程节数：[0, 10]之间的整数\n    night: 0, // 晚间课程节数：[0, 10]之间的整数\n    sections: [{\n      section: 1, // 节次：[1, 30]之间的整数\n      startTime: '08:00', // 开始时间：参照这个标准格式5位长度字符串\n      endTime: '08:50', // 结束时间：同上\n    }], // 课程时间表，注意：总长度要和上边配置的节数加和对齐\n  }\n  // PS: 夏令时什么的还是让用户在夏令时的时候重新导入一遍吧，在这个函数里边适配吧！奥里给！————不愿意透露姓名的嘤某人\n}\n",[94,3656,3657,3661,3666,3670,3681,3688,3693,3704,3709,3713,3718,3746,3766,3771,3779,3783,3788,3792,3797,3803,3818,3833,3848,3862,3877,3892,3906,3915,3929,3944,3959,3967,3971,3976],{"__ignoreMap":104},[108,3658,3659],{"class":110,"line":111},[108,3660,447],{"class":129},[108,3662,3663],{"class":110,"line":133},[108,3664,3665],{"class":129}," * 时间配置函数，此为入口函数，不要改动函数名\n",[108,3667,3668],{"class":110,"line":147},[108,3669,462],{"class":129},[108,3671,3672,3674,3676,3679],{"class":110,"line":260},[108,3673,467],{"class":114},[108,3675,470],{"class":114},[108,3677,3678],{"class":176}," scheduleTimer",[108,3680,2506],{"class":180},[108,3682,3683,3686],{"class":110,"line":284},[108,3684,3685],{"class":190},"  providerRes",[108,3687,919],{"class":180},[108,3689,3690],{"class":110,"line":311},[108,3691,3692],{"class":190},"  parserRes\n",[108,3694,3695,3698,3701],{"class":110,"line":345},[108,3696,3697],{"class":180},"} ",[108,3699,3700],{"class":122},"=",[108,3702,3703],{"class":180}," {}) {\n",[108,3705,3706],{"class":110,"line":369},[108,3707,3708],{"class":129},"  // 支持异步操作 推荐await写法\n",[108,3710,3711],{"class":110,"line":389},[108,3712,562],{"emptyLinePlaceholder":561},[108,3714,3715],{"class":110,"line":398},[108,3716,3717],{"class":129},"  // 这是一个示例函数，用于演示，正常用不到可以删掉\n",[108,3719,3720,3722,3725,3727,3730,3733,3735,3737,3739,3742,3744],{"class":110,"line":422},[108,3721,202],{"class":114},[108,3723,3724],{"class":176}," someAsyncFunc",[108,3726,123],{"class":122},[108,3728,3729],{"class":180}," () ",[108,3731,3732],{"class":114},"=>",[108,3734,210],{"class":114},[108,3736,1121],{"class":1120},[108,3738,181],{"class":180},[108,3740,3741],{"class":190},"resolve",[108,3743,194],{"class":114},[108,3745,197],{"class":180},[108,3747,3748,3751,3754,3756,3759,3762,3764],{"class":110,"line":428},[108,3749,3750],{"class":176},"    setTimeout",[108,3752,3753],{"class":180},"(() ",[108,3755,3732],{"class":114},[108,3757,3758],{"class":176}," resolve",[108,3760,3761],{"class":180},"(), ",[108,3763,3217],{"class":548},[108,3765,234],{"class":180},[108,3767,3768],{"class":110,"line":597},[108,3769,3770],{"class":180},"  })\n",[108,3772,3773,3775,3777],{"class":110,"line":603},[108,3774,3075],{"class":114},[108,3776,3724],{"class":176},[108,3778,594],{"class":180},[108,3780,3781],{"class":110,"line":626},[108,3782,562],{"emptyLinePlaceholder":561},[108,3784,3785],{"class":110,"line":631},[108,3786,3787],{"class":129},"  // 这个函数中也支持使用 AIScheduleTools 譬如给出多条时间配置让用户选择之类的\n",[108,3789,3790],{"class":110,"line":648},[108,3791,562],{"emptyLinePlaceholder":561},[108,3793,3794],{"class":110,"line":654},[108,3795,3796],{"class":129},"  // 返回时间配置JSON，所有项都为可选项，如果不进行时间配置，请返回空对象\n",[108,3798,3799,3801],{"class":110,"line":659},[108,3800,634],{"class":114},[108,3802,197],{"class":180},[108,3804,3805,3808,3810,3813,3815],{"class":110,"line":664},[108,3806,3807],{"class":230},"    totalWeek",[108,3809,545],{"class":544},[108,3811,3812],{"class":548}," 20",[108,3814,187],{"class":180},[108,3816,3817],{"class":129},"// 总周数：[1, 30]之间的整数\n",[108,3819,3820,3823,3825,3828,3830],{"class":110,"line":670},[108,3821,3822],{"class":230},"    startSemester",[108,3824,545],{"class":544},[108,3826,3827],{"class":143}," ''",[108,3829,187],{"class":180},[108,3831,3832],{"class":129},"// 开学时间：时间戳，13位长度字符串，推荐用代码生成\n",[108,3834,3835,3838,3840,3843,3845],{"class":110,"line":675},[108,3836,3837],{"class":230},"    startWithSunday",[108,3839,545],{"class":544},[108,3841,3842],{"class":548}," false",[108,3844,187],{"class":180},[108,3846,3847],{"class":129},"// 是否是周日为起始日，该选项为true时，会开启显示周末选项\n",[108,3849,3850,3853,3855,3857,3859],{"class":110,"line":680},[108,3851,3852],{"class":230},"    showWeekend",[108,3854,545],{"class":544},[108,3856,3842],{"class":548},[108,3858,187],{"class":180},[108,3860,3861],{"class":129},"// 是否显示周末\n",[108,3863,3864,3867,3869,3872,3874],{"class":110,"line":696},[108,3865,3866],{"class":230},"    forenoon",[108,3868,545],{"class":544},[108,3870,3871],{"class":548}," 1",[108,3873,187],{"class":180},[108,3875,3876],{"class":129},"// 上午课程节数：[1, 10]之间的整数\n",[108,3878,3879,3882,3884,3887,3889],{"class":110,"line":713},[108,3880,3881],{"class":230},"    afternoon",[108,3883,545],{"class":544},[108,3885,3886],{"class":548}," 0",[108,3888,187],{"class":180},[108,3890,3891],{"class":129},"// 下午课程节数：[0, 10]之间的整数\n",[108,3893,3894,3897,3899,3901,3903],{"class":110,"line":733},[108,3895,3896],{"class":230},"    night",[108,3898,545],{"class":544},[108,3900,3886],{"class":548},[108,3902,187],{"class":180},[108,3904,3905],{"class":129},"// 晚间课程节数：[0, 10]之间的整数\n",[108,3907,3908,3910,3912],{"class":110,"line":738},[108,3909,3257],{"class":230},[108,3911,545],{"class":544},[108,3913,3914],{"class":180}," [{\n",[108,3916,3917,3920,3922,3924,3926],{"class":110,"line":743},[108,3918,3919],{"class":230},"      section",[108,3921,545],{"class":544},[108,3923,3871],{"class":548},[108,3925,187],{"class":180},[108,3927,3928],{"class":129},"// 节次：[1, 30]之间的整数\n",[108,3930,3931,3934,3936,3939,3941],{"class":110,"line":748},[108,3932,3933],{"class":230},"      startTime",[108,3935,545],{"class":544},[108,3937,3938],{"class":143}," '08:00'",[108,3940,187],{"class":180},[108,3942,3943],{"class":129},"// 开始时间：参照这个标准格式5位长度字符串\n",[108,3945,3946,3949,3951,3954,3956],{"class":110,"line":753},[108,3947,3948],{"class":230},"      endTime",[108,3950,545],{"class":544},[108,3952,3953],{"class":143}," '08:50'",[108,3955,187],{"class":180},[108,3957,3958],{"class":129},"// 结束时间：同上\n",[108,3960,3961,3964],{"class":110,"line":759},[108,3962,3963],{"class":180},"    }], ",[108,3965,3966],{"class":129},"// 课程时间表，注意：总长度要和上边配置的节数加和对齐\n",[108,3968,3969],{"class":110,"line":765},[108,3970,425],{"class":180},[108,3972,3973],{"class":110,"line":770},[108,3974,3975],{"class":129},"  // PS: 夏令时什么的还是让用户在夏令时的时候重新导入一遍吧，在这个函数里边适配吧！奥里给！————不愿意透露姓名的嘤某人\n",[108,3977,3978],{"class":110,"line":784},[108,3979,651],{"class":180},[84,3981,3982],{"id":3982},"调试阶段",[21,3984,3985,3986,3989],{},"运行 ",[94,3987,3988],{},"pnpm main"," 能调起一个临时的服务器和浏览器插件进行互动，将编辑器的代码实时同步到浏览器插件。",[21,3991,3992],{},"在浏览器插件中，先创建一个新项目",[21,3994,3995],{},[1382,3996],{"alt":104,"src":3997},"https://static.031130.xyz/uploads/2024/11/18/d1ebba67ddc83.webp",[21,3999,4000],{},"保存后再次打开，选择「编写代码」按钮",[21,4002,4003],{},[1382,4004],{"alt":104,"src":4005},"https://static.031130.xyz/uploads/2024/11/18/e697bcf2a7a1f.webp",[21,4007,4008],{},"检查自己的代码是不是被实时同步到了浏览器插件中，然后可以点击右上角的「本地测试」按钮",[21,4010,4011],{},[1382,4012],{"alt":104,"src":4013},"https://static.031130.xyz/uploads/2024/11/18/eb563904a64a1.webp",[21,4015,4016],{},"如果本机测试出现了问题，可以使用 console.log 语句进行 debug ，问题可能会出现在 F12 开发者工具的控制台，也可能会出现在 vscode 的终端中。确认本机测试无问题后，点击右上角蓝色的「上传」按钮，就可以在上传到云端，在登陆了自己小米账号的手机中找到自己适配的教务导入测试项目，顺利完成导入后给自己的满意度打满分，就可以在浏览器插件中点击上传审核，审核通过后你的适配工作就会公开啦。",[1394,4018,4019],{},"html pre.shiki code .sLKXg, html code.shiki .sLKXg{--shiki-default:#A626A4;--shiki-dark:#C678DD}html pre.shiki code .sAdtL, html code.shiki .sAdtL{--shiki-default:#4078F2;--shiki-dark:#61AFEF}html pre.shiki code .s5ixo, html code.shiki .s5ixo{--shiki-default:#383A42;--shiki-dark:#ABB2BF}html pre.shiki code .sDhpE, html code.shiki .sDhpE{--shiki-default:#50A14F;--shiki-dark:#98C379}html pre.shiki code .st7oF, html code.shiki .st7oF{--shiki-default:#0184BC;--shiki-dark:#ABB2BF}html .default .shiki span {color: var(--shiki-default);background: var(--shiki-default-bg);font-style: var(--shiki-default-font-style);font-weight: var(--shiki-default-font-weight);text-decoration: var(--shiki-default-text-decoration);}html .shiki span {color: var(--shiki-default);background: var(--shiki-default-bg);font-style: var(--shiki-default-font-style);font-weight: var(--shiki-default-font-weight);text-decoration: var(--shiki-default-text-decoration);}html .dark .shiki span {color: var(--shiki-dark);background: var(--shiki-dark-bg);font-style: var(--shiki-dark-font-style);font-weight: var(--shiki-dark-font-weight);text-decoration: var(--shiki-dark-text-decoration);}html.dark .shiki span {color: var(--shiki-dark);background: var(--shiki-dark-bg);font-style: var(--shiki-dark-font-style);font-weight: var(--shiki-dark-font-weight);text-decoration: var(--shiki-dark-text-decoration);}html pre.shiki code .s8iYz, html code.shiki .s8iYz{--shiki-default:#383A42;--shiki-default-font-style:inherit;--shiki-dark:#E06C75;--shiki-dark-font-style:italic}html pre.shiki code .s7GmK, html code.shiki .s7GmK{--shiki-default:#383A42;--shiki-dark:#E5C07B}html pre.shiki code .sNmU0, html code.shiki .sNmU0{--shiki-default:#986801;--shiki-dark:#E5C07B}html pre.shiki code .s_Sar, html code.shiki .s_Sar{--shiki-default:#0184BC;--shiki-dark:#56B6C2}html pre.shiki code .sJa8x, html code.shiki .sJa8x{--shiki-default:#E45649;--shiki-dark:#E06C75}html pre.shiki code .sz0mV, html code.shiki .sz0mV{--shiki-default:#383A42;--shiki-dark:#E06C75}html pre.shiki code .sAGMh, html code.shiki .sAGMh{--shiki-default:#986801;--shiki-dark:#D19A66}html pre.shiki code .sAOjX, html code.shiki .sAOjX{--shiki-default:#CA1243;--shiki-dark:#C678DD}html pre.shiki code .sW2Sy, html code.shiki .sW2Sy{--shiki-default:#A0A1A7;--shiki-default-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic}html pre.shiki code .sUNH4, html code.shiki .sUNH4{--shiki-default:white;--shiki-dark:#FFFFFF}html pre.shiki code .sC09Y, html code.shiki .sC09Y{--shiki-default:#C18401;--shiki-dark:#E5C07B}",{"title":104,"searchDepth":133,"depth":133,"links":4021},[4022,4023,4024],{"id":1946,"depth":133,"text":1946},{"id":1974,"depth":133,"text":1974},{"id":2026,"depth":133,"text":2026,"children":4025},[4026,4027,4028,4029,4030,4031,4032,4033],{"id":2029,"depth":147,"text":2029},{"id":2063,"depth":147,"text":2063},{"id":2094,"depth":147,"text":2095},{"id":2424,"depth":147,"text":2424},{"id":2442,"depth":147,"text":2443},{"id":3139,"depth":147,"text":3140},{"id":3641,"depth":147,"text":3642},{"id":3982,"depth":147,"text":3982},{"title":4035,"date":4036,"path":4037,"tags":4038,"body":4042},"将博客从 waline v2 更新到 waline v3","2024-11-15 23:49:43","/2024/11/15/upgrade-waline-from-v2-to-v3",[4039,4040,4041],"Python","waline","Hexo",{"type":14,"value":4043,"toc":4541},[4044,4049,4056,4073,4077,4080,4086,4091,4100,4116,4124,4127,4133,4137,4140,4145,4154,4159,4162,4165,4170,4173,4176,4181,4184,4187,4201,4204,4211,4218,4225,4228,4521,4528,4533,4538],[3373,4045,4046],{},[21,4047,4048],{},"waline 更新到 V3 版本已经是九个月前的事情了，眼瞅着 hexo fluid 主题并没有带我更新的意思，我就打算自己更新到最新版，结果遇到了两个坑，写文供大家参考。",[21,4050,4051,4052,4055],{},"在 Hexo 目录下的 ",[94,4053,4054],{},"_config.fluid.yml"," 文件中找到 waline 的 cdn，将版本号指向最新版。",[99,4057,4061],{"className":4058,"code":4059,"language":4060,"meta":104,"style":104},"language-diff shiki shiki-themes one-light one-dark-pro","-  waline: https://registry.npmmirror.com/@waline/client/2.15.8/files/dist/\n+  waline: https://registry.npmmirror.com/@waline/client/^3/files/dist/\n","diff",[94,4062,4063,4068],{"__ignoreMap":104},[108,4064,4065],{"class":110,"line":111},[108,4066,4067],{"class":230},"-  waline: https://registry.npmmirror.com/@waline/client/2.15.8/files/dist/\n",[108,4069,4070],{"class":110,"line":133},[108,4071,4072],{"class":143},"+  waline: https://registry.npmmirror.com/@waline/client/^3/files/dist/\n",[17,4074,4076],{"id":4075},"插曲一waline-不加载","插曲一——waline 不加载",[21,4078,4079],{},"再次部署博客，我遇到了第一个坑：waline 没有在页面上正常加载。",[21,4081,4082,4083],{},"打开控制台一看，报错给得很明白：",[94,4084,4085],{},"Waline is not defined",[21,4087,4088],{},[1382,4089],{"alt":104,"src":4090},"https://static.031130.xyz/uploads/2024/11/16/663e910db29b7.webp",[21,4092,4093,4094,4099],{},"根据 ",[25,4095,4098],{"href":4096,"rel":4097},"https://github.com/walinejs/waline/issues/2483",[41],"issue#2483","，",[3373,4101,4102,4109],{},[21,4103,4104,4108],{},[25,4105,4106],{"href":4106,"rel":4107},"https://unpkg.com/@waline/client@3.1.3/dist/waline.umd.js",[41]," 用这个地址",[21,4110,4111,4112,4115],{},"本质是 ...... 没有使用 ES Module 的加载方式 ",[94,4113,4114],{},"\u003Cscript type=\"module\">","，所以需要使用 UMD 的模块",[21,4117,4118,4119],{},"那么按照正常的脑回路，我们应该修改主题中的引入 waline 部分的 js 文件，把针对 waline.js 的引用改成 waline.umd.js，具体的修改处",[25,4120,4123],{"href":4121,"rel":4122},"https://github.com/fluid-dev/hexo-theme-fluid/blob/94049b2e6da5ae865f5cf7088f0c53917a6dc8bc/layout/_partials/comments/waline.ejs#L5-L6",[41],"在这里",[21,4125,4126],{},"但是，我是使用 npm 安装的主题，方便在主题更新时直接同步上游的更改，如果使用这种修改源文件引用的方式将会导致我不得不放弃原有的主题安装方式，改用下载主题源码的方式。",[21,4128,4129,4130,4132],{},"那么有没有办法，既能够成功加载带 umd 的 js，又不用改动主题源码呢？还真有，我自己部署 cdn 就好了。从 npmjs 下载带 umd 的 waline.umd.js，重命名成 waline.js，和 waline.css 一起放在同一路径下，在把自己的 cdn 链接前缀填入 ",[94,4131,4054],{}," 中，就可以实现移花接木——表面上访问的是 waline.js，实际上内容是 waline.umd.js 。",[17,4134,4136],{"id":4135},"插曲二重复显示的","插曲二——重复显示的 @",[21,4138,4139],{},"更新到 v3 版本以后，我发现所有的评论都出现了重复两遍的 @",[21,4141,4142],{},[1382,4143],{"alt":104,"src":4144},"https://static.031130.xyz/uploads/2024/11/16/f6fbaa99a784e.webp",[21,4146,4147,4148,4153],{},"我去群里提问，管理员 ",[25,4149,4152],{"href":4150,"rel":4151},"https://imnerd.org/",[41],"li zheming"," 给出了这样的答复:",[3373,4155,4156],{},[21,4157,4158],{},"这个是 feature 了，早版本 @ 是渲染在评论内容里的，这块后来重构了下，@ 是 Waline 自己渲染了。不过历史数据我们并没有处理，所以会出现这种情况。如果比较介意的话可以手动去数据库里删除下。",[21,4160,4161],{},"那么很显然，我很介意这点，我需要删除数据库中的 @ 信息。",[21,4163,4164],{},"打开 waline 的后台管理站点，我发现我有整整 30 页的评论——很显然我是 waline 的牢用户了，我不太可能一个一个手动去掉评论中的 @",[21,4166,4167],{},[1382,4168],{"alt":104,"src":4169},"https://static.031130.xyz/uploads/2024/11/16/c4487502542e5.webp",[21,4171,4172],{},"我的 waline 数据库是 leancloud，对方的 webui 没办法帮助我批量去除 html 或者 markdown 形式的内容（就算对方支持 sql 语句，处理这个问题都够呛），我需要一个脚本来直接处理数据库中的信息。",[21,4174,4175],{},"首先，我们需要导出数据库数据，自然是登陆 leancloud，然后找到 数据存储 - 导入导出 - 数据导出，选择 Comment 单个 Class，单击导出按钮。",[21,4177,4178],{},[1382,4179],{"alt":104,"src":4180},"https://static.031130.xyz/uploads/2024/11/16/d2cd564739120.webp",[21,4182,4183],{},"err，我寻思凌晨 1 点应该是 16 点前吧，怎么导出不了，而我昨晚 23 点反而可以导出，leancloud 到底是哪门子时区。所以我直接拿了 23 点时导出的数据进行处理。",[21,4185,4186],{},"leancloud 导出的数据是 jsonl 格式的，我们对需要去除的 @ 信息进行归纳总结，发现一共有两种 @ 的渲染方式",[1426,4188,4189,4195],{},[1429,4190,4191,4194],{},[94,4192,4193],{},"\u003Ca class=\"at\" href=\"#id\">@username\u003C/a>","  的 html 风格（有时 class 和 href 顺序还会反过来）",[1429,4196,4197,4200],{},[94,4198,4199],{},"[@username](#id)"," 的 markdown 风格",[21,4202,4203],{},"而 html 风格还有两种结尾方式，",[21,4205,4206,4207,4210],{},"一种是如 ",[94,4208,4209],{},"\u003Ca class=\"at\" href=\"#id\">@username\u003C/a> , "," 这样以 空格 + 半角逗号 + 空格 结尾的形式，",[21,4212,4213,4214,4217],{},"令一种是如 ",[94,4215,4216],{},"\u003Ca class=\"at\" href=\"#id\">@username\u003C/a>: "," 这样以 半角冒号 + 空格结尾的形式。",[21,4219,4220,4221,4224],{},"markdown 风格的结尾方式我就只看到一种，如 ",[94,4222,4223],{},"[@username](#id): ","这样以 半角冒号 + 空格结尾的形式。",[21,4226,4227],{},"因此，我们需要对三种形式分别编写正则表达式进行匹配并删除，参考代码如下",[99,4229,4233],{"className":4230,"code":4231,"language":4232,"meta":104,"style":104},"language-python shiki shiki-themes one-light one-dark-pro","import re\n\nwith open('Comment.0.jsonl', 'r') as f:\n    s = f.read()\n\npatterns = [\n    r'\u003Ca class=\\\\\"at\\\\\" href=\\\\\"#(?:.*?)\\\\\">@(?:.*?)\u003C/a>: ',\n    r'\u003Ca class=\\\\\"at\\\\\" href=\\\\\"#(?:.*?)\\\\\">@(?:.*?)\u003C/a> , ',\n    r'\\[@(?:.*?)\\]\\(#(?:.*?)\\):'\n]\n\nfor pattern in patterns:\n    s = re.sub(pattern, \"\", s)\n\nwith open('Comment.1.jsonl', 'w') as f:\n    f.write(s)\n","python",[94,4234,4235,4243,4247,4273,4290,4294,4304,4358,4401,4441,4445,4449,4463,4484,4488,4510],{"__ignoreMap":104},[108,4236,4237,4240],{"class":110,"line":111},[108,4238,4239],{"class":114},"import",[108,4241,4242],{"class":180}," re\n",[108,4244,4245],{"class":110,"line":133},[108,4246,562],{"emptyLinePlaceholder":561},[108,4248,4249,4252,4255,4257,4260,4262,4265,4267,4270],{"class":110,"line":147},[108,4250,4251],{"class":114},"with",[108,4253,4254],{"class":122}," open",[108,4256,181],{"class":180},[108,4258,4259],{"class":143},"'Comment.0.jsonl'",[108,4261,187],{"class":180},[108,4263,4264],{"class":143},"'r'",[108,4266,514],{"class":180},[108,4268,4269],{"class":114},"as",[108,4271,4272],{"class":180}," f:\n",[108,4274,4275,4278,4281,4284,4288],{"class":110,"line":260},[108,4276,4277],{"class":180},"    s ",[108,4279,3700],{"class":4280},"sknuh",[108,4282,4283],{"class":180}," f.",[108,4285,4287],{"class":4286},"slOjB","read",[108,4289,594],{"class":180},[108,4291,4292],{"class":110,"line":284},[108,4293,562],{"emptyLinePlaceholder":561},[108,4295,4296,4299,4301],{"class":110,"line":311},[108,4297,4298],{"class":180},"patterns ",[108,4300,3700],{"class":4280},[108,4302,4303],{"class":180}," [\n",[108,4305,4306,4309,4312,4315,4318,4320,4323,4325,4328,4331,4333,4337,4340,4342,4345,4347,4349,4351,4353,4356],{"class":110,"line":345},[108,4307,4308],{"class":114},"    r",[108,4310,4311],{"class":1001},"'\u003Ca class=",[108,4313,4314],{"class":122},"\\\\",[108,4316,4317],{"class":1001},"\"at",[108,4319,4314],{"class":122},[108,4321,4322],{"class":1001},"\" href=",[108,4324,4314],{"class":122},[108,4326,4327],{"class":1001},"\"#",[108,4329,4330],{"class":1017},"(?:",[108,4332,221],{"class":1001},[108,4334,4336],{"class":4335},"sYebD","*?",[108,4338,4339],{"class":1017},")",[108,4341,4314],{"class":122},[108,4343,4344],{"class":1001},"\">@",[108,4346,4330],{"class":1017},[108,4348,221],{"class":1001},[108,4350,4336],{"class":4335},[108,4352,4339],{"class":1017},[108,4354,4355],{"class":1001},"\u003C/a>: '",[108,4357,919],{"class":180},[108,4359,4360,4362,4364,4366,4368,4370,4372,4374,4376,4378,4380,4382,4384,4386,4388,4390,4392,4394,4396,4399],{"class":110,"line":369},[108,4361,4308],{"class":114},[108,4363,4311],{"class":1001},[108,4365,4314],{"class":122},[108,4367,4317],{"class":1001},[108,4369,4314],{"class":122},[108,4371,4322],{"class":1001},[108,4373,4314],{"class":122},[108,4375,4327],{"class":1001},[108,4377,4330],{"class":1017},[108,4379,221],{"class":1001},[108,4381,4336],{"class":4335},[108,4383,4339],{"class":1017},[108,4385,4314],{"class":122},[108,4387,4344],{"class":1001},[108,4389,4330],{"class":1017},[108,4391,221],{"class":1001},[108,4393,4336],{"class":4335},[108,4395,4339],{"class":1017},[108,4397,4398],{"class":1001},"\u003C/a> , '",[108,4400,919],{"class":180},[108,4402,4403,4405,4407,4410,4413,4415,4417,4419,4421,4424,4427,4429,4431,4433,4435,4438],{"class":110,"line":389},[108,4404,4308],{"class":114},[108,4406,814],{"class":1001},[108,4408,4409],{"class":122},"\\[",[108,4411,4412],{"class":1001},"@",[108,4414,4330],{"class":1017},[108,4416,221],{"class":1001},[108,4418,4336],{"class":4335},[108,4420,4339],{"class":1017},[108,4422,4423],{"class":122},"\\]\\(",[108,4425,4426],{"class":1001},"#",[108,4428,4330],{"class":1017},[108,4430,221],{"class":1001},[108,4432,4336],{"class":4335},[108,4434,4339],{"class":1017},[108,4436,4437],{"class":122},"\\)",[108,4439,4440],{"class":1001},":'\n",[108,4442,4443],{"class":110,"line":398},[108,4444,2845],{"class":180},[108,4446,4447],{"class":110,"line":422},[108,4448,562],{"emptyLinePlaceholder":561},[108,4450,4451,4454,4457,4460],{"class":110,"line":428},[108,4452,4453],{"class":114},"for",[108,4455,4456],{"class":180}," pattern ",[108,4458,4459],{"class":114},"in",[108,4461,4462],{"class":180}," patterns:\n",[108,4464,4465,4467,4469,4472,4475,4478,4481],{"class":110,"line":597},[108,4466,4277],{"class":180},[108,4468,3700],{"class":4280},[108,4470,4471],{"class":180}," re.",[108,4473,4474],{"class":4286},"sub",[108,4476,4477],{"class":180},"(pattern, ",[108,4479,4480],{"class":143},"\"\"",[108,4482,4483],{"class":180},", s)\n",[108,4485,4486],{"class":110,"line":603},[108,4487,562],{"emptyLinePlaceholder":561},[108,4489,4490,4492,4494,4496,4499,4501,4504,4506,4508],{"class":110,"line":626},[108,4491,4251],{"class":114},[108,4493,4254],{"class":122},[108,4495,181],{"class":180},[108,4497,4498],{"class":143},"'Comment.1.jsonl'",[108,4500,187],{"class":180},[108,4502,4503],{"class":143},"'w'",[108,4505,514],{"class":180},[108,4507,4269],{"class":114},[108,4509,4272],{"class":180},[108,4511,4512,4515,4518],{"class":110,"line":631},[108,4513,4514],{"class":180},"    f.",[108,4516,4517],{"class":4286},"write",[108,4519,4520],{"class":180},"(s)\n",[21,4522,4523,4524,4527],{},"随后删除 Comment 表中所有数据，把生成的 ",[94,4525,4526],{},"Comment.1.jsonl"," 导入 leancloud，就算是大功告成了。",[21,4529,4530],{},[1382,4531],{"alt":104,"src":4532},"https://static.031130.xyz/uploads/2024/11/16/d248ae2eac74c.webp",[21,4534,4535],{},[1382,4536],{"alt":104,"src":4537},"https://static.031130.xyz/uploads/2024/11/16/c3875dcde1d97.webp",[1394,4539,4540],{},"html pre.shiki code .sJa8x, html code.shiki .sJa8x{--shiki-default:#E45649;--shiki-dark:#E06C75}html pre.shiki code .sDhpE, html code.shiki .sDhpE{--shiki-default:#50A14F;--shiki-dark:#98C379}html .default .shiki span {color: var(--shiki-default);background: var(--shiki-default-bg);font-style: var(--shiki-default-font-style);font-weight: var(--shiki-default-font-weight);text-decoration: var(--shiki-default-text-decoration);}html .shiki span {color: var(--shiki-default);background: var(--shiki-default-bg);font-style: var(--shiki-default-font-style);font-weight: var(--shiki-default-font-weight);text-decoration: var(--shiki-default-text-decoration);}html .dark .shiki span {color: var(--shiki-dark);background: var(--shiki-dark-bg);font-style: var(--shiki-dark-font-style);font-weight: var(--shiki-dark-font-weight);text-decoration: var(--shiki-dark-text-decoration);}html.dark .shiki span {color: var(--shiki-dark);background: var(--shiki-dark-bg);font-style: var(--shiki-dark-font-style);font-weight: var(--shiki-dark-font-weight);text-decoration: var(--shiki-dark-text-decoration);}html pre.shiki code .sLKXg, html code.shiki .sLKXg{--shiki-default:#A626A4;--shiki-dark:#C678DD}html pre.shiki code .s5ixo, html code.shiki .s5ixo{--shiki-default:#383A42;--shiki-dark:#ABB2BF}html pre.shiki code .s_Sar, html code.shiki .s_Sar{--shiki-default:#0184BC;--shiki-dark:#56B6C2}html pre.shiki code .sknuh, html code.shiki .sknuh{--shiki-default:#383A42;--shiki-dark:#56B6C2}html pre.shiki code .slOjB, html code.shiki .slOjB{--shiki-default:#383A42;--shiki-dark:#61AFEF}html pre.shiki code .sDaw7, html code.shiki .sDaw7{--shiki-default:#0184BC;--shiki-dark:#E06C75}html pre.shiki code .sYoRg, html code.shiki .sYoRg{--shiki-default:#0184BC;--shiki-dark:#D19A66}html pre.shiki code .sYebD, html code.shiki .sYebD{--shiki-default:#383A42;--shiki-dark:#D19A66}",{"title":104,"searchDepth":133,"depth":133,"links":4542},[4543,4544],{"id":4075,"depth":133,"text":4076},{"id":4135,"depth":133,"text":4136},{"title":4546,"date":4547,"path":4548,"tags":4549,"body":4556},"给家里云装上 Fedora 41 KDE 后，我是如何配置的","2024-11-01 23:35:08","/2024/11/01/my-config-for-fedora-kde-41",[4550,4551,4552,4553,4554,4555],"Linux","Fedora","KDE","HomeServer","Rustdesk","Notes",{"type":14,"value":4557,"toc":5350},[4558,4563,4566,4574,4604,4608,4616,4619,4673,4676,4737,4744,4762,4765,4768,4789,4793,4812,4815,4831,4835,4855,4859,4884,4887,4903,4906,4909,4925,4930,4934,4950,4954,4973,4976,4998,5002,5009,5112,5116,5138,5141,5144,5150,5156,5160,5166,5245,5248,5252,5307,5310,5313,5316,5337,5341,5347],[3373,4559,4560],{},[21,4561,4562],{},"前两天给自己的 N100 小主机重装成了最近发布的 Fedora 41 ( KDE )，也是花了不少时间把整个系统调成自己熟悉的样子，因此开一篇博客记录一下。以下仅为我个人的 HomeServer 小主机使用，不具有普适性。",[17,4564,4565],{"id":4565},"换官方源",[21,4567,4568,4569,1487],{},"我这里比较适合用上交的源，直接参考",[25,4570,4573],{"href":4571,"rel":4572},"https://mirrors.sjtug.sjtu.edu.cn/docs/fedora/linux",[41],"他们的文档",[99,4575,4577],{"className":1533,"code":4576,"language":1535,"meta":104,"style":104},"sudo sed -e 's/^metalink=/#metalink=/g' -e 's|^#baseurl=http://download.example/pub/|baseurl=https://mirror.sjtu.edu.cn/|g' -i.bak /etc/yum.repos.d/{fedora.repo,fedora-updates.repo}\n",[94,4578,4579],{"__ignoreMap":104},[108,4580,4581,4584,4587,4590,4593,4595,4598,4601],{"class":110,"line":111},[108,4582,4583],{"class":176},"sudo",[108,4585,4586],{"class":143}," sed",[108,4588,4589],{"class":548}," -e",[108,4591,4592],{"class":143}," 's/^metalink=/#metalink=/g'",[108,4594,4589],{"class":548},[108,4596,4597],{"class":143}," 's|^#baseurl=http://download.example/pub/|baseurl=https://mirror.sjtu.edu.cn/|g'",[108,4599,4600],{"class":548}," -i.bak",[108,4602,4603],{"class":143}," /etc/yum.repos.d/{fedora.repo,fedora-updates.repo}\n",[17,4605,4607],{"id":4606},"加-rpmfusion-源","加 rpmfusion 源",[21,4609,4610,4611],{},"参考 ",[25,4612,4615],{"href":4613,"rel":4614},"https://help.mirrors.cernet.edu.cn/rpmfusion/?mirror=SJTUG-Siyuan",[41],"help.cernet.edu.cn 提供的文档",[21,4617,4618],{},"安装源配置文件",[99,4620,4622],{"className":1533,"code":4621,"language":1535,"meta":104,"style":104},"sudo yum install --nogpgcheck https://mirror.sjtu.edu.cn/rpmfusion/free/fedora/rpmfusion-free-release-$(rpm -E %fedora).noarch.rpm https://mirror.sjtu.edu.cn/rpmfusion/nonfree/fedora/rpmfusion-nonfree-release-$(rpm -E %fedora).noarch.rpm\n",[94,4623,4624],{"__ignoreMap":104},[108,4625,4626,4628,4631,4634,4637,4640,4643,4646,4649,4652,4654,4657,4660,4662,4664,4666,4668,4670],{"class":110,"line":111},[108,4627,4583],{"class":176},[108,4629,4630],{"class":143}," yum",[108,4632,4633],{"class":143}," install",[108,4635,4636],{"class":548}," --nogpgcheck",[108,4638,4639],{"class":143}," https://mirror.sjtu.edu.cn/rpmfusion/free/fedora/rpmfusion-free-release-",[108,4641,4642],{"class":180},"$(",[108,4644,4645],{"class":176},"rpm",[108,4647,4648],{"class":548}," -E",[108,4650,4651],{"class":143}," %fedora",[108,4653,4339],{"class":180},[108,4655,4656],{"class":143},".noarch.rpm",[108,4658,4659],{"class":143}," https://mirror.sjtu.edu.cn/rpmfusion/nonfree/fedora/rpmfusion-nonfree-release-",[108,4661,4642],{"class":180},[108,4663,4645],{"class":176},[108,4665,4648],{"class":548},[108,4667,4651],{"class":143},[108,4669,4339],{"class":180},[108,4671,4672],{"class":143},".noarch.rpm\n",[21,4674,4675],{},"换源",[99,4677,4679],{"className":1533,"code":4678,"language":1535,"meta":104,"style":104},"sudo sed -e 's!^metalink=!#metalink=!g' \\\n         -e 's!^mirrorlist=!#mirrorlist=!g' \\\n         -e 's!^#baseurl=!baseurl=!g' \\\n         -e 's!https\\?://download1\\.rpmfusion\\.org/!https://mirror.sjtu.edu.cn/rpmfusion/!g' \\\n         -i.bak /etc/yum.repos.d/rpmfusion*.repo\n",[94,4680,4681,4695,4705,4714,4723],{"__ignoreMap":104},[108,4682,4683,4685,4687,4689,4692],{"class":110,"line":111},[108,4684,4583],{"class":176},[108,4686,4586],{"class":143},[108,4688,4589],{"class":548},[108,4690,4691],{"class":143}," 's!^metalink=!#metalink=!g'",[108,4693,4694],{"class":122}," \\\n",[108,4696,4697,4700,4703],{"class":110,"line":133},[108,4698,4699],{"class":548},"         -e",[108,4701,4702],{"class":143}," 's!^mirrorlist=!#mirrorlist=!g'",[108,4704,4694],{"class":122},[108,4706,4707,4709,4712],{"class":110,"line":147},[108,4708,4699],{"class":548},[108,4710,4711],{"class":143}," 's!^#baseurl=!baseurl=!g'",[108,4713,4694],{"class":122},[108,4715,4716,4718,4721],{"class":110,"line":260},[108,4717,4699],{"class":548},[108,4719,4720],{"class":143}," 's!https\\?://download1\\.rpmfusion\\.org/!https://mirror.sjtu.edu.cn/rpmfusion/!g'",[108,4722,4694],{"class":122},[108,4724,4725,4728,4731,4734],{"class":110,"line":284},[108,4726,4727],{"class":548},"         -i.bak",[108,4729,4730],{"class":143}," /etc/yum.repos.d/rpmfusion",[108,4732,4733],{"class":224},"*",[108,4735,4736],{"class":143},".repo\n",[17,4738,4740,4741],{"id":4739},"dnf-操作默认使用-yn","dnf 操作默认使用 ",[108,4742,4743],{},"Y/n",[99,4745,4747],{"className":1533,"code":4746,"language":1535,"meta":104,"style":104},"sudo sh -c \"echo 'defaultyes=True' >> /etc/dnf/dnf.conf\"\n",[94,4748,4749],{"__ignoreMap":104},[108,4750,4751,4753,4756,4759],{"class":110,"line":111},[108,4752,4583],{"class":176},[108,4754,4755],{"class":143}," sh",[108,4757,4758],{"class":548}," -c",[108,4760,4761],{"class":143}," \"echo 'defaultyes=True' >> /etc/dnf/dnf.conf\"\n",[17,4763,4764],{"id":4764},"移除不想要的软件",[84,4766,4767],{"id":4767},"libreoffice",[99,4769,4771],{"className":1533,"code":4770,"language":1535,"meta":104,"style":104},"sudo dnf remove libreoffice*\n",[94,4772,4773],{"__ignoreMap":104},[108,4774,4775,4777,4780,4783,4786],{"class":110,"line":111},[108,4776,4583],{"class":176},[108,4778,4779],{"class":143}," dnf",[108,4781,4782],{"class":143}," remove",[108,4784,4785],{"class":143}," libreoffice",[108,4787,4788],{"class":224},"*\n",[84,4790,4792],{"id":4791},"discover-flatpak","discover, flatpak",[99,4794,4796],{"className":1533,"code":4795,"language":1535,"meta":104,"style":104},"sudo dnf remove discover flatpak\n",[94,4797,4798],{"__ignoreMap":104},[108,4799,4800,4802,4804,4806,4809],{"class":110,"line":111},[108,4801,4583],{"class":176},[108,4803,4779],{"class":143},[108,4805,4782],{"class":143},[108,4807,4808],{"class":143}," discover",[108,4810,4811],{"class":143}," flatpak\n",[84,4813,4814],{"id":4814},"podman",[99,4816,4818],{"className":1533,"code":4817,"language":1535,"meta":104,"style":104},"sudo dnf remove podman\n",[94,4819,4820],{"__ignoreMap":104},[108,4821,4822,4824,4826,4828],{"class":110,"line":111},[108,4823,4583],{"class":176},[108,4825,4779],{"class":143},[108,4827,4782],{"class":143},[108,4829,4830],{"class":143}," podman\n",[17,4832,4834],{"id":4833},"关闭-selinux","关闭 selinux",[99,4836,4838],{"className":1533,"code":4837,"language":1535,"meta":104,"style":104},"sudo sed -i \"s|SELINUX=enforcing|SELINUX=disabled|\" /etc/selinux/config\n",[94,4839,4840],{"__ignoreMap":104},[108,4841,4842,4844,4846,4849,4852],{"class":110,"line":111},[108,4843,4583],{"class":176},[108,4845,4586],{"class":143},[108,4847,4848],{"class":548}," -i",[108,4850,4851],{"class":143}," \"s|SELINUX=enforcing|SELINUX=disabled|\"",[108,4853,4854],{"class":143}," /etc/selinux/config\n",[17,4856,4858],{"id":4857},"vlcmpvffmpeg-补全大部分编码器","vlc，mpv，ffmpeg （补全大部分编码器）",[99,4860,4862],{"className":1533,"code":4861,"language":1535,"meta":104,"style":104},"sudo dnf install vlc mpv ffmpeg --allowerasing\n",[94,4863,4864],{"__ignoreMap":104},[108,4865,4866,4868,4870,4872,4875,4878,4881],{"class":110,"line":111},[108,4867,4583],{"class":176},[108,4869,4779],{"class":143},[108,4871,4633],{"class":143},[108,4873,4874],{"class":143}," vlc",[108,4876,4877],{"class":143}," mpv",[108,4879,4880],{"class":143}," ffmpeg",[108,4882,4883],{"class":548}," --allowerasing\n",[17,4885,4886],{"id":4886},"docker",[99,4888,4890],{"className":1533,"code":4889,"language":1535,"meta":104,"style":104},"sudo dnf install docker\n",[94,4891,4892],{"__ignoreMap":104},[108,4893,4894,4896,4898,4900],{"class":110,"line":111},[108,4895,4583],{"class":176},[108,4897,4779],{"class":143},[108,4899,4633],{"class":143},[108,4901,4902],{"class":143}," docker\n",[17,4904,4905],{"id":4905},"rustdesk",[21,4907,4908],{},"直接去官方的 Github Release 下载安装包",[99,4910,4912],{"className":1533,"code":4911,"language":1535,"meta":104,"style":104},"sudo dnf install https://github.com/rustdesk/rustdesk/releases/download/1.3.2/rustdesk-1.3.2-0.x86_64.rpm\n",[94,4913,4914],{"__ignoreMap":104},[108,4915,4916,4918,4920,4922],{"class":110,"line":111},[108,4917,4583],{"class":176},[108,4919,4779],{"class":143},[108,4921,4633],{"class":143},[108,4923,4924],{"class":143}," https://github.com/rustdesk/rustdesk/releases/download/1.3.2/rustdesk-1.3.2-0.x86_64.rpm\n",[3373,4926,4927],{},[21,4928,4929],{},"尽管 Rustdesk 支持被控端使用 wayland，但因为权限原因需要被控端手动选择被控区域，不适合无人值守的环境，因此还是要换 x11。",[84,4931,4933],{"id":4932},"安装-x11-支持","安装 x11 支持",[99,4935,4937],{"className":1533,"code":4936,"language":1535,"meta":104,"style":104},"sudo dnf install plasma-workspace-x11\n",[94,4938,4939],{"__ignoreMap":104},[108,4940,4941,4943,4945,4947],{"class":110,"line":111},[108,4942,4583],{"class":176},[108,4944,4779],{"class":143},[108,4946,4633],{"class":143},[108,4948,4949],{"class":143}," plasma-workspace-x11\n",[84,4951,4953],{"id":4952},"使用-x11-启动-sddm","使用 x11 启动 sddm",[99,4955,4957],{"className":1533,"code":4956,"language":1535,"meta":104,"style":104},"sudo sed -i \"s|^#DisplayServer=wayland|DisplayServer=x11|\" /etc/sddm.conf\n",[94,4958,4959],{"__ignoreMap":104},[108,4960,4961,4963,4965,4967,4970],{"class":110,"line":111},[108,4962,4583],{"class":176},[108,4964,4586],{"class":143},[108,4966,4848],{"class":548},[108,4968,4969],{"class":143}," \"s|^#DisplayServer=wayland|DisplayServer=x11|\"",[108,4971,4972],{"class":143}," /etc/sddm.conf\n",[17,4974,4975],{"id":4975},"开发相关",[99,4977,4979],{"className":1533,"code":4978,"language":1535,"meta":104,"style":104},"sudo dnf install gcc g++ python3-devel\n",[94,4980,4981],{"__ignoreMap":104},[108,4982,4983,4985,4987,4989,4992,4995],{"class":110,"line":111},[108,4984,4583],{"class":176},[108,4986,4779],{"class":143},[108,4988,4633],{"class":143},[108,4990,4991],{"class":143}," gcc",[108,4993,4994],{"class":143}," g++",[108,4996,4997],{"class":143}," python3-devel\n",[17,4999,5001],{"id":5000},"解除-systemd-resolved-53-端口占用","解除 systemd-resolved 53 端口占用",[21,5003,5004,5005,5008],{},"编辑 ",[94,5006,5007],{},"/usr/lib/systemd/resolved.conf","，取消注释，yes 改 no",[99,5010,5012],{"className":4058,"code":5011,"language":4060,"meta":104,"style":104},"[Resolve]\n# Some examples of DNS servers which may be used for DNS= and FallbackDNS=:\n\n//...\n\n#DNS=\n#FallbackDNS=\n#Domains=\n#DNSSEC=no\n#DNSOverTLS=no\n#MulticastDNS=yes\n#LLMNR=yes\n#Cache=yes\n#CacheFromLocalhost=no\n-#DNSStubListener=yes\n+DNSStubListener=no\n#DNSStubListenerExtra=\n#ReadEtcHosts=yes\n#ResolveUnicastSingleLabel=no\n#StaleRetentionSec=0\n",[94,5013,5014,5019,5024,5028,5033,5037,5042,5047,5052,5057,5062,5067,5072,5077,5082,5087,5092,5097,5102,5107],{"__ignoreMap":104},[108,5015,5016],{"class":110,"line":111},[108,5017,5018],{"class":180},"[Resolve]\n",[108,5020,5021],{"class":110,"line":133},[108,5022,5023],{"class":129},"# Some examples of DNS servers which may be used for DNS= and FallbackDNS=:\n",[108,5025,5026],{"class":110,"line":147},[108,5027,562],{"emptyLinePlaceholder":561},[108,5029,5030],{"class":110,"line":260},[108,5031,5032],{"class":180},"//...\n",[108,5034,5035],{"class":110,"line":284},[108,5036,562],{"emptyLinePlaceholder":561},[108,5038,5039],{"class":110,"line":311},[108,5040,5041],{"class":129},"#DNS=\n",[108,5043,5044],{"class":110,"line":345},[108,5045,5046],{"class":129},"#FallbackDNS=\n",[108,5048,5049],{"class":110,"line":369},[108,5050,5051],{"class":129},"#Domains=\n",[108,5053,5054],{"class":110,"line":389},[108,5055,5056],{"class":129},"#DNSSEC=no\n",[108,5058,5059],{"class":110,"line":398},[108,5060,5061],{"class":129},"#DNSOverTLS=no\n",[108,5063,5064],{"class":110,"line":422},[108,5065,5066],{"class":129},"#MulticastDNS=yes\n",[108,5068,5069],{"class":110,"line":428},[108,5070,5071],{"class":129},"#LLMNR=yes\n",[108,5073,5074],{"class":110,"line":597},[108,5075,5076],{"class":129},"#Cache=yes\n",[108,5078,5079],{"class":110,"line":603},[108,5080,5081],{"class":129},"#CacheFromLocalhost=no\n",[108,5083,5084],{"class":110,"line":626},[108,5085,5086],{"class":230},"-#DNSStubListener=yes\n",[108,5088,5089],{"class":110,"line":631},[108,5090,5091],{"class":143},"+DNSStubListener=no\n",[108,5093,5094],{"class":110,"line":648},[108,5095,5096],{"class":129},"#DNSStubListenerExtra=\n",[108,5098,5099],{"class":110,"line":654},[108,5100,5101],{"class":129},"#ReadEtcHosts=yes\n",[108,5103,5104],{"class":110,"line":659},[108,5105,5106],{"class":129},"#ResolveUnicastSingleLabel=no\n",[108,5108,5109],{"class":110,"line":664},[108,5110,5111],{"class":129},"#StaleRetentionSec=0\n",[17,5113,5115],{"id":5114},"配置-fcitx5","配置 fcitx5",[99,5117,5119],{"className":1533,"code":5118,"language":1535,"meta":104,"style":104},"sudo dnf install fcitx5-chinese-addons kcm-fcitx5 fcitx5-autostart\n",[94,5120,5121],{"__ignoreMap":104},[108,5122,5123,5125,5127,5129,5132,5135],{"class":110,"line":111},[108,5124,4583],{"class":176},[108,5126,4779],{"class":143},[108,5128,4633],{"class":143},[108,5130,5131],{"class":143}," fcitx5-chinese-addons",[108,5133,5134],{"class":143}," kcm-fcitx5",[108,5136,5137],{"class":143}," fcitx5-autostart\n",[21,5139,5140],{},"在 设置 - 输入法 中添加拼音",[84,5142,5143],{"id":5143},"安装词库",[21,5145,5146],{},[25,5147,5148],{"href":5148,"rel":5149},"https://github.com/felixonmars/fcitx5-pinyin-zhwiki",[41],[21,5151,5152],{},[25,5153,5154],{"href":5154,"rel":5155},"https://github.com/outloudvi/mw2fcitx",[41],[84,5157,5159],{"id":5158},"在-wayland-下使用","在 wayland 下使用",[21,5161,4610,5162],{},[25,5163,5165],{"href":5164},"/2022/07/03/fcitx5-blinking-on-tg-under-wayland-kde/","处理 fcitx5 的文字候选框在 tg 客户端上闪烁的问题",[99,5167,5169],{"className":4058,"code":5168,"language":4060,"meta":104,"style":104},"if [ ! \"$XDG_SESSION_TYPE\" = \"tty\" ]   # if this is a gui session (not tty)\nthen\n    # let's use fcitx instead of fcitx5 to make flatpak happy\n    # this may break behavior for users who have installed both\n    # fcitx and fcitx5, let then change the file on their own\n\n    export INPUT_METHOD=fcitx\n    export GTK_IM_MODULE=fcitx\n    export QT_IM_MODULE=fcitx\n    export XMODIFIERS=@im=fcitx\nfi\n+if [ \"$XDG_SESSION_TYPE\" = \"wayland\" ]\n+then\n+        unset QT_IM_MODULE\n+fi\n",[94,5170,5171,5176,5181,5186,5191,5196,5200,5205,5210,5215,5220,5225,5230,5235,5240],{"__ignoreMap":104},[108,5172,5173],{"class":110,"line":111},[108,5174,5175],{"class":180},"if [ ! \"$XDG_SESSION_TYPE\" = \"tty\" ]   # if this is a gui session (not tty)\n",[108,5177,5178],{"class":110,"line":133},[108,5179,5180],{"class":180},"then\n",[108,5182,5183],{"class":110,"line":147},[108,5184,5185],{"class":180},"    # let's use fcitx instead of fcitx5 to make flatpak happy\n",[108,5187,5188],{"class":110,"line":260},[108,5189,5190],{"class":180},"    # this may break behavior for users who have installed both\n",[108,5192,5193],{"class":110,"line":284},[108,5194,5195],{"class":180},"    # fcitx and fcitx5, let then change the file on their own\n",[108,5197,5198],{"class":110,"line":311},[108,5199,562],{"emptyLinePlaceholder":561},[108,5201,5202],{"class":110,"line":345},[108,5203,5204],{"class":180},"    export INPUT_METHOD=fcitx\n",[108,5206,5207],{"class":110,"line":369},[108,5208,5209],{"class":180},"    export GTK_IM_MODULE=fcitx\n",[108,5211,5212],{"class":110,"line":389},[108,5213,5214],{"class":180},"    export QT_IM_MODULE=fcitx\n",[108,5216,5217],{"class":110,"line":398},[108,5218,5219],{"class":180},"    export XMODIFIERS=@im=fcitx\n",[108,5221,5222],{"class":110,"line":422},[108,5223,5224],{"class":180},"fi\n",[108,5226,5227],{"class":110,"line":428},[108,5228,5229],{"class":143},"+if [ \"$XDG_SESSION_TYPE\" = \"wayland\" ]\n",[108,5231,5232],{"class":110,"line":597},[108,5233,5234],{"class":143},"+then\n",[108,5236,5237],{"class":110,"line":603},[108,5238,5239],{"class":143},"+        unset QT_IM_MODULE\n",[108,5241,5242],{"class":110,"line":626},[108,5243,5244],{"class":143},"+fi\n",[21,5246,5247],{},"然后仍然要去 设置 - 键盘 - 虚拟键盘 中选中 fcitx5",[17,5249,5251],{"id":5250},"安装-vscode","安装 vscode",[99,5253,5255],{"className":1533,"code":5254,"language":1535,"meta":104,"style":104},"sudo rpm --import https://packages.microsoft.com/keys/microsoft.asc\necho -e \"[code]\\nname=Visual Studio Code\\nbaseurl=https://packages.microsoft.com/yumrepos/vscode\\nenabled=1\\ngpgcheck=1\\ngpgkey=https://packages.microsoft.com/keys/microsoft.asc\" | sudo tee /etc/yum.repos.d/vscode.repo > /dev/null\nsudo dnf install code\n",[94,5256,5257,5270,5296],{"__ignoreMap":104},[108,5258,5259,5261,5264,5267],{"class":110,"line":111},[108,5260,4583],{"class":176},[108,5262,5263],{"class":143}," rpm",[108,5265,5266],{"class":548}," --import",[108,5268,5269],{"class":143}," https://packages.microsoft.com/keys/microsoft.asc\n",[108,5271,5272,5275,5277,5280,5282,5284,5287,5290,5293],{"class":110,"line":133},[108,5273,5274],{"class":122},"echo",[108,5276,4589],{"class":548},[108,5278,5279],{"class":143}," \"[code]\\nname=Visual Studio Code\\nbaseurl=https://packages.microsoft.com/yumrepos/vscode\\nenabled=1\\ngpgcheck=1\\ngpgkey=https://packages.microsoft.com/keys/microsoft.asc\"",[108,5281,1560],{"class":180},[108,5283,4583],{"class":176},[108,5285,5286],{"class":143}," tee",[108,5288,5289],{"class":143}," /etc/yum.repos.d/vscode.repo",[108,5291,5292],{"class":180}," > ",[108,5294,5295],{"class":143},"/dev/null\n",[108,5297,5298,5300,5302,5304],{"class":110,"line":147},[108,5299,4583],{"class":176},[108,5301,4779],{"class":143},[108,5303,4633],{"class":143},[108,5305,5306],{"class":143}," code\n",[17,5308,5309],{"id":5309},"网络优化工具",[21,5311,5312],{},"略",[17,5314,5315],{"id":5315},"禁用防火墙",[99,5317,5319],{"className":1533,"code":5318,"language":1535,"meta":104,"style":104},"sudo systemctl disable firewalld --now\n",[94,5320,5321],{"__ignoreMap":104},[108,5322,5323,5325,5328,5331,5334],{"class":110,"line":111},[108,5324,4583],{"class":176},[108,5326,5327],{"class":143}," systemctl",[108,5329,5330],{"class":143}," disable",[108,5332,5333],{"class":143}," firewalld",[108,5335,5336],{"class":548}," --now\n",[17,5338,5340],{"id":5339},"rpm-构建","RPM 构建",[21,5342,4610,5343],{},[25,5344,5346],{"href":5345},"/2024/05/03/open-rpmbuild-in-the-way-of-archlinux-makepkg/","以 Archlinux 中 makepkg 的方式打开 rpmbuild",[1394,5348,5349],{},"html pre.shiki code .sAdtL, html code.shiki .sAdtL{--shiki-default:#4078F2;--shiki-dark:#61AFEF}html pre.shiki code .sDhpE, html code.shiki .sDhpE{--shiki-default:#50A14F;--shiki-dark:#98C379}html pre.shiki code .sAGMh, html code.shiki .sAGMh{--shiki-default:#986801;--shiki-dark:#D19A66}html .default .shiki span {color: var(--shiki-default);background: var(--shiki-default-bg);font-style: var(--shiki-default-font-style);font-weight: var(--shiki-default-font-weight);text-decoration: var(--shiki-default-text-decoration);}html .shiki span {color: var(--shiki-default);background: var(--shiki-default-bg);font-style: var(--shiki-default-font-style);font-weight: var(--shiki-default-font-weight);text-decoration: var(--shiki-default-text-decoration);}html .dark .shiki span {color: var(--shiki-dark);background: var(--shiki-dark-bg);font-style: var(--shiki-dark-font-style);font-weight: var(--shiki-dark-font-weight);text-decoration: var(--shiki-dark-text-decoration);}html.dark .shiki span {color: var(--shiki-dark);background: var(--shiki-dark-bg);font-style: var(--shiki-dark-font-style);font-weight: var(--shiki-dark-font-weight);text-decoration: var(--shiki-dark-text-decoration);}html pre.shiki code .s5ixo, html code.shiki .s5ixo{--shiki-default:#383A42;--shiki-dark:#ABB2BF}html pre.shiki code .s_Sar, html code.shiki .s_Sar{--shiki-default:#0184BC;--shiki-dark:#56B6C2}html pre.shiki code .s2QsP, html code.shiki .s2QsP{--shiki-default:#E45649;--shiki-dark:#E5C07B}html pre.shiki code .sW2Sy, html code.shiki .sW2Sy{--shiki-default:#A0A1A7;--shiki-default-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic}html pre.shiki code .sJa8x, html code.shiki .sJa8x{--shiki-default:#E45649;--shiki-dark:#E06C75}",{"title":104,"searchDepth":133,"depth":133,"links":5351},[5352,5353,5354,5356,5361,5362,5363,5364,5368,5369,5370,5374,5375,5376,5377],{"id":4565,"depth":133,"text":4565},{"id":4606,"depth":133,"text":4607},{"id":4739,"depth":133,"text":5355},"dnf 操作默认使用 Y/n",{"id":4764,"depth":133,"text":4764,"children":5357},[5358,5359,5360],{"id":4767,"depth":147,"text":4767},{"id":4791,"depth":147,"text":4792},{"id":4814,"depth":147,"text":4814},{"id":4833,"depth":133,"text":4834},{"id":4857,"depth":133,"text":4858},{"id":4886,"depth":133,"text":4886},{"id":4905,"depth":133,"text":4905,"children":5365},[5366,5367],{"id":4932,"depth":147,"text":4933},{"id":4952,"depth":147,"text":4953},{"id":4975,"depth":133,"text":4975},{"id":5000,"depth":133,"text":5001},{"id":5114,"depth":133,"text":5115,"children":5371},[5372,5373],{"id":5143,"depth":147,"text":5143},{"id":5158,"depth":147,"text":5159},{"id":5250,"depth":133,"text":5251},{"id":5309,"depth":133,"text":5309},{"id":5315,"depth":133,"text":5315},{"id":5339,"depth":133,"text":5340},{"title":5379,"date":5380,"path":5381,"tags":5382,"body":5384},"为 Hexo 添加 follow 认证","2024-10-23 23:11:32","/2024/10/23/follow-cert-for-hexo-feed",[4041,5383],"Follow",{"type":14,"value":5385,"toc":5826},[5386,5389,5392,5397,5400,5403,5410,5417,5423,5429,5440,5495,5543,5546,5549,5558,5569,5663,5669,5674,5677,5729,5809,5811,5814,5816,5823],[17,5387,5388],{"id":5388},"前言",[21,5390,5391],{},"Follow 从今天开始不需要邀请码就可以开始使用部分功能了，除了只能订阅五个订阅源、成就系统没开放、签到不能获得 power 以外，还有部分功能没有解锁（如下图）",[21,5393,5394],{},[1382,5395],{"alt":104,"src":5396},"https://static.031130.xyz/uploads/2024/10/23/d3a69a7bcde58.webp",[21,5398,5399],{},"我注意到 Follow 的认证机制目前对于 Hexo 用户还是相对不友好的，起码对于 Hexo 用户来说。",[21,5401,5402],{},"「内容」方案要我们在网页（也可能是 rss，follow 没有给出非常明确的指示）上添加非常明显的一段文本，我并不是很喜欢这种行为。",[99,5404,5408],{"className":5405,"code":5407,"language":825},[5406],"language-text","This message is used to verify that this feed (feedId:56144913816835091) belongs to me (userId:70410173045150720). Join me in enjoying the next generation information browser https://follow.is.\n",[94,5409,5407],{"__ignoreMap":104},[21,5411,5412,5413,5416],{},"「描述」方案要求我们在 rss 的 xml 文件的 ",[94,5414,5415],{},"\u003Cdescription />"," 字段添加一段丑丑的代码。无论是使用 follow 的读者还是其他 rss reader 的读者都会看到博客的 description 中含有一段丑丑的代码，这对于强迫症的我来说是无法忍受的，更别提 atom 类型的订阅根本没有这个字段。",[99,5418,5421],{"className":5419,"code":5420,"language":825},[5406],"feedId:56144913816835091+userId:70410173045150720\n",[94,5422,5420],{"__ignoreMap":104},[21,5424,5425],{},[1382,5426],{"alt":5427,"src":5428},"即使是在 follow 中，这样的文字也是非常眨眼","https://static.031130.xyz/uploads/2024/10/23/10dfda54f4dcc.webp",[21,5430,5431,5432,5435,5436,5439],{},"「RSS 标签」方案是我唯一能接受的方案，这个方案需要我们在 rss 的 xml 文件中添加一个名为 ",[94,5433,5434],{},"\u003Cfollow_challenge>"," 的标签，或者是 json 文件中的一个 ",[94,5437,5438],{},"follow_challenge"," 对象。虽然具有一定的侵入性，但对于读者来说不会受到影响——应该没有除了 follow 以外的 rss reader 对这个字段进行解析。",[99,5441,5445],{"className":5442,"code":5443,"language":5444,"meta":104,"style":104},"language-xml shiki shiki-themes one-light one-dark-pro","\u003Cfollow_challenge>\n    \u003CfeedId>56144913816835091\u003C/feedId>\n    \u003CuserId>70410173045150720\u003C/userId>\n\u003C/follow_challenge>\n","xml",[94,5446,5447,5457,5472,5486],{"__ignoreMap":104},[108,5448,5449,5452,5454],{"class":110,"line":111},[108,5450,5451],{"class":180},"\u003C",[108,5453,5438],{"class":230},[108,5455,5456],{"class":180},">\n",[108,5458,5459,5462,5465,5468,5470],{"class":110,"line":133},[108,5460,5461],{"class":180},"    \u003C",[108,5463,5464],{"class":230},"feedId",[108,5466,5467],{"class":180},">56144913816835091\u003C/",[108,5469,5464],{"class":230},[108,5471,5456],{"class":180},[108,5473,5474,5476,5479,5482,5484],{"class":110,"line":147},[108,5475,5461],{"class":180},[108,5477,5478],{"class":230},"userId",[108,5480,5481],{"class":180},">70410173045150720\u003C/",[108,5483,5478],{"class":230},[108,5485,5456],{"class":180},[108,5487,5488,5491,5493],{"class":110,"line":260},[108,5489,5490],{"class":180},"\u003C/",[108,5492,5438],{"class":230},[108,5494,5456],{"class":180},[99,5496,5498],{"className":3146,"code":5497,"language":591,"meta":104,"style":104},"{\n  \"follow_challenge\": {\n    \"feed_id\": \"56144913816835091\",\n    \"user_id\": \"70410173045150720\"\n  }\n}\n",[94,5499,5500,5505,5513,5525,5535,5539],{"__ignoreMap":104},[108,5501,5502],{"class":110,"line":111},[108,5503,5504],{"class":180},"{\n",[108,5506,5507,5510],{"class":110,"line":133},[108,5508,5509],{"class":230},"  \"follow_challenge\"",[108,5511,5512],{"class":180},": {\n",[108,5514,5515,5518,5520,5523],{"class":110,"line":147},[108,5516,5517],{"class":230},"    \"feed_id\"",[108,5519,3168],{"class":180},[108,5521,5522],{"class":143},"\"56144913816835091\"",[108,5524,919],{"class":180},[108,5526,5527,5530,5532],{"class":110,"line":260},[108,5528,5529],{"class":230},"    \"user_id\"",[108,5531,3168],{"class":180},[108,5533,5534],{"class":143},"\"70410173045150720\"\n",[108,5536,5537],{"class":110,"line":284},[108,5538,425],{"class":180},[108,5540,5541],{"class":110,"line":311},[108,5542,651],{"class":180},[17,5544,5545],{"id":5545},"正篇",[21,5547,5548],{},"那么问题来了，Hexo 用户应该如何使用「RSS 标签」的方案给我们的博客进行 Follow 认证呢？",[21,5550,5551,5552,5557],{},"首先确认前提，我在使用 ",[25,5553,5556],{"href":5554,"rel":5555},"https://github.com/hexojs/hexo-generator-feed",[41],"hexo-generator-feed"," 这个 npm 库来生成 Hexo 博客的 rss 订阅文件。",[21,5559,5560,5561,5564,5565,5568],{},"在项目的 README 文件中，我们知道可以在 ",[94,5562,5563],{},"_config.yml"," 文件中指定 rss 生成时使用的模板文件。模板文件位于 ",[94,5566,5567],{},"./node_modules/hexo-generator-feed"," 路径下，atom.xml 和 rss2.xml 就是这个库所使用的模板文件。我正在使用 atom，所以我把 atom.xml 复制一份放到博客的根目录下魔改模板。下面是 _config.yml 的 feed 配置，你可以看到我在最后两行指定了 template 模板文件。",[99,5570,5574],{"className":5571,"code":5572,"language":5573,"meta":104,"style":104},"language-yml shiki shiki-themes one-light one-dark-pro","feed:\n    type: atom\n    path: rss.xml\n    limit: 0\n    hub:\n    content: true\n    content_limit:\n    content_limit_delim: ' '\n    template:\n      - atom.xml\n","yml",[94,5575,5576,5584,5594,5604,5614,5621,5631,5638,5648,5655],{"__ignoreMap":104},[108,5577,5578,5581],{"class":110,"line":111},[108,5579,5580],{"class":230},"feed",[108,5582,5583],{"class":180},":\n",[108,5585,5586,5589,5591],{"class":110,"line":133},[108,5587,5588],{"class":230},"    type",[108,5590,3168],{"class":180},[108,5592,5593],{"class":143},"atom\n",[108,5595,5596,5599,5601],{"class":110,"line":147},[108,5597,5598],{"class":230},"    path",[108,5600,3168],{"class":180},[108,5602,5603],{"class":143},"rss.xml\n",[108,5605,5606,5609,5611],{"class":110,"line":260},[108,5607,5608],{"class":230},"    limit",[108,5610,3168],{"class":180},[108,5612,5613],{"class":548},"0\n",[108,5615,5616,5619],{"class":110,"line":284},[108,5617,5618],{"class":230},"    hub",[108,5620,5583],{"class":180},[108,5622,5623,5626,5628],{"class":110,"line":311},[108,5624,5625],{"class":230},"    content",[108,5627,3168],{"class":180},[108,5629,5630],{"class":548},"true\n",[108,5632,5633,5636],{"class":110,"line":345},[108,5634,5635],{"class":230},"    content_limit",[108,5637,5583],{"class":180},[108,5639,5640,5643,5645],{"class":110,"line":369},[108,5641,5642],{"class":230},"    content_limit_delim",[108,5644,3168],{"class":180},[108,5646,5647],{"class":143},"' '\n",[108,5649,5650,5653],{"class":110,"line":389},[108,5651,5652],{"class":230},"    template",[108,5654,5583],{"class":180},[108,5656,5657,5660],{"class":110,"line":398},[108,5658,5659],{"class":180},"      - ",[108,5661,5662],{"class":143},"atom.xml\n",[21,5664,5665,5666,5668],{},"如果是个人用途，其实可以直接硬编码，在文件的倒数第二行把我们复制的 ",[94,5667,5434],{}," 放进去。",[21,5670,5671],{},[1382,5672],{"alt":104,"src":5673},"https://static.031130.xyz/uploads/2024/10/23/fae341d7985ea.webp",[21,5675,5676],{},"或者如果我们想要写得考究一些，那么可以是下面这个样子的",[99,5678,5680],{"className":5571,"code":5679,"language":5573,"meta":104,"style":104},"feed:\n  template:\n    - atom.xml\n  follow_challenge:\n    feedId: 56144913816835091\n    userId: 70410173045150720\n",[94,5681,5682,5688,5695,5702,5709,5719],{"__ignoreMap":104},[108,5683,5684,5686],{"class":110,"line":111},[108,5685,5580],{"class":230},[108,5687,5583],{"class":180},[108,5689,5690,5693],{"class":110,"line":133},[108,5691,5692],{"class":230},"  template",[108,5694,5583],{"class":180},[108,5696,5697,5700],{"class":110,"line":147},[108,5698,5699],{"class":180},"    - ",[108,5701,5662],{"class":143},[108,5703,5704,5707],{"class":110,"line":260},[108,5705,5706],{"class":230},"  follow_challenge",[108,5708,5583],{"class":180},[108,5710,5711,5714,5716],{"class":110,"line":284},[108,5712,5713],{"class":230},"    feedId",[108,5715,3168],{"class":180},[108,5717,5718],{"class":548},"56144913816835091\n",[108,5720,5721,5724,5726],{"class":110,"line":311},[108,5722,5723],{"class":230},"    userId",[108,5725,3168],{"class":180},[108,5727,5728],{"class":548},"70410173045150720\n",[99,5730,5732],{"className":5442,"code":5731,"language":5444,"meta":104,"style":104},"\u003C!-- //... -->\n  {% endfor %}\n  {% if config.feed.follow_challenge %}\n    \u003Cfollow_challenge>\n      \u003CfeedId>{{ config.feed.follow_challenge.feedId }}\u003C/feedId>\n      \u003CuserId>{{ config.feed.follow_challenge.userId }}\u003C/userId>\n    \u003C/follow_challenge>\n  {% endif %}\n\u003C/feed>\n",[94,5733,5734,5742,5747,5752,5760,5774,5787,5796,5801],{"__ignoreMap":104},[108,5735,5736,5739],{"class":110,"line":111},[108,5737,5738],{"class":129},"\u003C!--",[108,5740,5741],{"class":129}," //... -->\n",[108,5743,5744],{"class":110,"line":133},[108,5745,5746],{"class":180},"  {% endfor %}\n",[108,5748,5749],{"class":110,"line":147},[108,5750,5751],{"class":180},"  {% if config.feed.follow_challenge %}\n",[108,5753,5754,5756,5758],{"class":110,"line":260},[108,5755,5461],{"class":180},[108,5757,5438],{"class":230},[108,5759,5456],{"class":180},[108,5761,5762,5765,5767,5770,5772],{"class":110,"line":284},[108,5763,5764],{"class":180},"      \u003C",[108,5766,5464],{"class":230},[108,5768,5769],{"class":180},">{{ config.feed.follow_challenge.feedId }}\u003C/",[108,5771,5464],{"class":230},[108,5773,5456],{"class":180},[108,5775,5776,5778,5780,5783,5785],{"class":110,"line":311},[108,5777,5764],{"class":180},[108,5779,5478],{"class":230},[108,5781,5782],{"class":180},">{{ config.feed.follow_challenge.userId }}\u003C/",[108,5784,5478],{"class":230},[108,5786,5456],{"class":180},[108,5788,5789,5792,5794],{"class":110,"line":345},[108,5790,5791],{"class":180},"    \u003C/",[108,5793,5438],{"class":230},[108,5795,5456],{"class":180},[108,5797,5798],{"class":110,"line":369},[108,5799,5800],{"class":180},"  {% endif %}\n",[108,5802,5803,5805,5807],{"class":110,"line":389},[108,5804,5490],{"class":180},[108,5806,5580],{"class":230},[108,5808,5456],{"class":180},[75,5810],{},[21,5812,5813],{},"（说起来，这两个小改动一改，其实完全可以上传 npmjs.com 作为一个新的插件，不过我有点懒了）",[75,5815],{},[21,5817,5818,5819],{},"文末附一个 follow 邀请码: ",[108,5820,5822],{"className":5821},[2021],"6O0oBazB9s",[1394,5824,5825],{},"html pre.shiki code .s5ixo, html code.shiki .s5ixo{--shiki-default:#383A42;--shiki-dark:#ABB2BF}html pre.shiki code .sJa8x, html code.shiki .sJa8x{--shiki-default:#E45649;--shiki-dark:#E06C75}html .default .shiki span {color: var(--shiki-default);background: var(--shiki-default-bg);font-style: var(--shiki-default-font-style);font-weight: var(--shiki-default-font-weight);text-decoration: var(--shiki-default-text-decoration);}html .shiki span {color: var(--shiki-default);background: var(--shiki-default-bg);font-style: var(--shiki-default-font-style);font-weight: var(--shiki-default-font-weight);text-decoration: var(--shiki-default-text-decoration);}html .dark .shiki span {color: var(--shiki-dark);background: var(--shiki-dark-bg);font-style: var(--shiki-dark-font-style);font-weight: var(--shiki-dark-font-weight);text-decoration: var(--shiki-dark-text-decoration);}html.dark .shiki span {color: var(--shiki-dark);background: var(--shiki-dark-bg);font-style: var(--shiki-dark-font-style);font-weight: var(--shiki-dark-font-weight);text-decoration: var(--shiki-dark-text-decoration);}html pre.shiki code .sDhpE, html code.shiki .sDhpE{--shiki-default:#50A14F;--shiki-dark:#98C379}html pre.shiki code .sAGMh, html code.shiki .sAGMh{--shiki-default:#986801;--shiki-dark:#D19A66}html pre.shiki code .sW2Sy, html code.shiki .sW2Sy{--shiki-default:#A0A1A7;--shiki-default-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic}",{"title":104,"searchDepth":133,"depth":133,"links":5827},[5828,5829],{"id":5388,"depth":133,"text":5388},{"id":5545,"depth":133,"text":5545},{"title":5831,"date":5832,"path":5833,"tags":5834,"body":5836},"使用 GPT 对 waline 的评论进行审查","2024-10-12 16:11:06","/2024/10/12/use-gpt-to-review-waline-comments",[4040,5835],"GPT",{"type":14,"value":5837,"toc":7181},[5838,5841,5855,5858,5864,5872,5881,6550,6565,6568,6571,6574,6905,6908,6917,6922,6937,6942,7118,7123,7170,7173,7178],[21,5839,5840],{},"前一阵子收到了这么一条来自 waline 的评论提醒。",[3373,5842,5843],{},[21,5844,5845,5846,5850,5851],{},"New comment on 竹林里有冰的博客\n【网站名称】：竹林里有冰的博客\n【评论者昵称】：专业数据库\n【评论者邮箱】：",[25,5847,5849],{"href":5848},"mailto:rakhiranijhhg@gmail.com","rakhiranijhhg@gmail.com","\n【内容】：总之，优化专业数据库对于保持数据准确性、提高系统性能和推动业务成功至关重要。通过遵循本文中概述的策略，您可以提高数据库操作的效率并释放新的增长机会。\n【地址】：",[25,5852,5853],{"href":5853,"rel":5854},"https://zhul.in/2021/04/04/yay-more/#66f7a8889ab78865d5f5ae19",[41],[21,5856,5857],{},"评论的内容不仅透露着一股 AI 味，还和文章内容可谓是一点关系都没有，点开评论者的网站一看，一股塑料机翻味，怕是又是个来蹭 SEO 的广告哥。",[21,5859,5860],{},[1382,5861],{"alt":5862,"src":5863},"广告哥留下的网站","https://static.031130.xyz/uploads/2024/10/07/4673580090861.webp",[21,5865,4093,5866,5871],{},[25,5867,5870],{"href":5868,"rel":5869},"https://waline.js.org/advanced/faq.html#%E5%8F%91%E5%B8%83%E8%AF%84%E8%AE%BA%E5%BE%88%E6%85%A2%E6%80%8E%E4%B9%88%E5%8A%9E",[41],"waline 的官方文档","所言，waline 是使用了 Akismet 提供的垃圾内容检测服务的。可惜它似乎对 AI 生成的垃圾没有分辨能力。因此我计划使用 GPT 代替 Akismet 对 waline 的新评论进行审核。",[21,5873,5874,5875,5880],{},"walinejs/plugin 提供了一个 ",[25,5876,5879],{"href":5877,"rel":5878},"https://github.com/walinejs/plugins/blob/master/packages/tencent-tms/index.js",[41],"tencent-cms"," 的插件，功能是使用腾讯云的内容审查接口审查评论内容，这和我们需要的功能很像，主体部分和调用方法可以直接借鉴。",[99,5882,5884],{"className":101,"code":5883,"language":103,"meta":104,"style":104},"// index.js\n\nconst tencentcloud = require(\"tencentcloud-sdk-nodejs-tms\");\nconst TmsClient = tencentcloud.tms.v20201229.Client;\n\n\nmodule.exports = function({secretId, secretKey, region}) {\n  if (!secretId || !secretKey || !region) {\n    return {};\n  }\n\n  const clientConfig = {\n    credential: {\n      secretId,\n      secretKey,\n    },\n    region,\n    profile: {\n      httpProfile: {\n        endpoint: \"tms.tencentcloudapi.com\",\n      },\n    },\n  };\n  \n  return {\n    hooks: {\n      async preSave(data) {\n        const { userInfo } = this.ctx.state;\n        const isAdmin = userInfo.type === 'administrator';\n        // ignore admin comment\n        if (isAdmin) {\n          return;\n        }\n\n        const client = new TmsClient(clientConfig);\n        try {\n          const resp = await client.TextModeration({ Content: data.comment });\n          if (!resp.Suggestion) {\n            throw new Error('Suggestion is empty. Tencent Cloud TMS info:', resp);\n          }\n\n          switch(resp.Suggestion) {\n            case 'Pass':\n              data.status = 'approved';\n              break;\n            case 'Block':\n              data.status = 'spam';\n              break;\n              case 'Review':\n              default:\n                data.status = 'waiting';\n                break;\n          }\n        } catch(e) {\n          console.log(e);\n          data.status = 'waiting';\n        }\n      },\n    },\n  };\n}\n",[94,5885,5886,5891,5895,5914,5942,5946,5950,5983,6008,6015,6019,6023,6034,6043,6050,6057,6061,6068,6077,6086,6098,6103,6107,6112,6116,6122,6131,6146,6177,6201,6206,6218,6225,6230,6234,6254,6261,6299,6318,6339,6344,6348,6363,6373,6389,6396,6406,6422,6429,6440,6448,6465,6473,6478,6493,6509,6525,6530,6535,6540,6545],{"__ignoreMap":104},[108,5887,5888],{"class":110,"line":111},[108,5889,5890],{"class":129},"// index.js\n",[108,5892,5893],{"class":110,"line":133},[108,5894,562],{"emptyLinePlaceholder":561},[108,5896,5897,5899,5902,5904,5907,5909,5912],{"class":110,"line":147},[108,5898,115],{"class":114},[108,5900,5901],{"class":118}," tencentcloud",[108,5903,123],{"class":122},[108,5905,5906],{"class":176}," require",[108,5908,181],{"class":180},[108,5910,5911],{"class":143},"\"tencentcloud-sdk-nodejs-tms\"",[108,5913,1071],{"class":180},[108,5915,5916,5918,5921,5923,5925,5927,5930,5932,5935,5937,5940],{"class":110,"line":260},[108,5917,115],{"class":114},[108,5919,5920],{"class":118}," TmsClient",[108,5922,123],{"class":122},[108,5924,5901],{"class":218},[108,5926,221],{"class":180},[108,5928,5929],{"class":224},"tms",[108,5931,221],{"class":180},[108,5933,5934],{"class":224},"v20201229",[108,5936,221],{"class":180},[108,5938,5939],{"class":230},"Client",[108,5941,983],{"class":180},[108,5943,5944],{"class":110,"line":284},[108,5945,562],{"emptyLinePlaceholder":561},[108,5947,5948],{"class":110,"line":311},[108,5949,562],{"emptyLinePlaceholder":561},[108,5951,5952,5955,5957,5960,5962,5964,5967,5970,5972,5975,5977,5980],{"class":110,"line":345},[108,5953,5954],{"class":224},"module",[108,5956,221],{"class":180},[108,5958,5959],{"class":224},"exports",[108,5961,123],{"class":122},[108,5963,470],{"class":114},[108,5965,5966],{"class":180},"({",[108,5968,5969],{"class":190},"secretId",[108,5971,187],{"class":180},[108,5973,5974],{"class":190},"secretKey",[108,5976,187],{"class":180},[108,5978,5979],{"class":190},"region",[108,5981,5982],{"class":180},"}) {\n",[108,5984,5985,5987,5989,5991,5993,5995,5998,6000,6002,6004,6006],{"class":110,"line":369},[108,5986,239],{"class":114},[108,5988,242],{"class":180},[108,5990,967],{"class":122},[108,5992,5969],{"class":278},[108,5994,2600],{"class":122},[108,5996,5997],{"class":122}," !",[108,5999,5974],{"class":278},[108,6001,2600],{"class":122},[108,6003,5997],{"class":122},[108,6005,5979],{"class":278},[108,6007,257],{"class":180},[108,6009,6010,6012],{"class":110,"line":389},[108,6011,526],{"class":114},[108,6013,6014],{"class":180}," {};\n",[108,6016,6017],{"class":110,"line":398},[108,6018,425],{"class":180},[108,6020,6021],{"class":110,"line":422},[108,6022,562],{"emptyLinePlaceholder":561},[108,6024,6025,6027,6030,6032],{"class":110,"line":428},[108,6026,202],{"class":114},[108,6028,6029],{"class":118}," clientConfig",[108,6031,123],{"class":122},[108,6033,197],{"class":180},[108,6035,6036,6039,6041],{"class":110,"line":597},[108,6037,6038],{"class":230},"    credential",[108,6040,545],{"class":544},[108,6042,197],{"class":180},[108,6044,6045,6048],{"class":110,"line":603},[108,6046,6047],{"class":278},"      secretId",[108,6049,919],{"class":180},[108,6051,6052,6055],{"class":110,"line":626},[108,6053,6054],{"class":278},"      secretKey",[108,6056,919],{"class":180},[108,6058,6059],{"class":110,"line":631},[108,6060,2208],{"class":180},[108,6062,6063,6066],{"class":110,"line":648},[108,6064,6065],{"class":278},"    region",[108,6067,919],{"class":180},[108,6069,6070,6073,6075],{"class":110,"line":654},[108,6071,6072],{"class":230},"    profile",[108,6074,545],{"class":544},[108,6076,197],{"class":180},[108,6078,6079,6082,6084],{"class":110,"line":659},[108,6080,6081],{"class":230},"      httpProfile",[108,6083,545],{"class":544},[108,6085,197],{"class":180},[108,6087,6088,6091,6093,6096],{"class":110,"line":664},[108,6089,6090],{"class":230},"        endpoint",[108,6092,545],{"class":544},[108,6094,6095],{"class":143}," \"tms.tencentcloudapi.com\"",[108,6097,919],{"class":180},[108,6099,6100],{"class":110,"line":670},[108,6101,6102],{"class":180},"      },\n",[108,6104,6105],{"class":110,"line":675},[108,6106,2208],{"class":180},[108,6108,6109],{"class":110,"line":680},[108,6110,6111],{"class":180},"  };\n",[108,6113,6114],{"class":110,"line":696},[108,6115,3502],{"class":180},[108,6117,6118,6120],{"class":110,"line":713},[108,6119,634],{"class":114},[108,6121,197],{"class":180},[108,6123,6124,6127,6129],{"class":110,"line":733},[108,6125,6126],{"class":230},"    hooks",[108,6128,545],{"class":544},[108,6130,197],{"class":180},[108,6132,6133,6136,6139,6141,6144],{"class":110,"line":738},[108,6134,6135],{"class":114},"      async",[108,6137,6138],{"class":176}," preSave",[108,6140,181],{"class":180},[108,6142,6143],{"class":190},"data",[108,6145,257],{"class":180},[108,6147,6148,6151,6154,6157,6160,6162,6165,6167,6170,6172,6175],{"class":110,"line":743},[108,6149,6150],{"class":114},"        const",[108,6152,6153],{"class":180}," { ",[108,6155,6156],{"class":118},"userInfo",[108,6158,6159],{"class":180}," } ",[108,6161,3700],{"class":122},[108,6163,6164],{"class":224}," this",[108,6166,221],{"class":180},[108,6168,6169],{"class":224},"ctx",[108,6171,221],{"class":180},[108,6173,6174],{"class":230},"state",[108,6176,983],{"class":180},[108,6178,6179,6181,6184,6186,6189,6191,6194,6196,6199],{"class":110,"line":748},[108,6180,6150],{"class":114},[108,6182,6183],{"class":118}," isAdmin",[108,6185,123],{"class":122},[108,6187,6188],{"class":218}," userInfo",[108,6190,221],{"class":180},[108,6192,6193],{"class":230},"type",[108,6195,252],{"class":122},[108,6197,6198],{"class":143}," 'administrator'",[108,6200,983],{"class":180},[108,6202,6203],{"class":110,"line":753},[108,6204,6205],{"class":129},"        // ignore admin comment\n",[108,6207,6208,6211,6213,6216],{"class":110,"line":759},[108,6209,6210],{"class":114},"        if",[108,6212,242],{"class":180},[108,6214,6215],{"class":278},"isAdmin",[108,6217,257],{"class":180},[108,6219,6220,6223],{"class":110,"line":765},[108,6221,6222],{"class":114},"          return",[108,6224,983],{"class":180},[108,6226,6227],{"class":110,"line":770},[108,6228,6229],{"class":180},"        }\n",[108,6231,6232],{"class":110,"line":784},[108,6233,562],{"emptyLinePlaceholder":561},[108,6235,6236,6238,6241,6243,6245,6247,6249,6252],{"class":110,"line":830},[108,6237,6150],{"class":114},[108,6239,6240],{"class":118}," client",[108,6242,123],{"class":122},[108,6244,210],{"class":114},[108,6246,5920],{"class":176},[108,6248,181],{"class":180},[108,6250,6251],{"class":278},"clientConfig",[108,6253,1071],{"class":180},[108,6255,6256,6259],{"class":110,"line":835},[108,6257,6258],{"class":114},"        try",[108,6260,197],{"class":180},[108,6262,6263,6266,6269,6271,6273,6275,6277,6280,6283,6286,6288,6291,6293,6296],{"class":110,"line":840},[108,6264,6265],{"class":114},"          const",[108,6267,6268],{"class":118}," resp",[108,6270,123],{"class":122},[108,6272,579],{"class":114},[108,6274,6240],{"class":218},[108,6276,221],{"class":180},[108,6278,6279],{"class":176},"TextModeration",[108,6281,6282],{"class":180},"({ ",[108,6284,6285],{"class":230},"Content",[108,6287,545],{"class":544},[108,6289,6290],{"class":218}," data",[108,6292,221],{"class":180},[108,6294,6295],{"class":230},"comment",[108,6297,6298],{"class":180}," });\n",[108,6300,6301,6304,6306,6308,6311,6313,6316],{"class":110,"line":845},[108,6302,6303],{"class":114},"          if",[108,6305,242],{"class":180},[108,6307,967],{"class":122},[108,6309,6310],{"class":218},"resp",[108,6312,221],{"class":180},[108,6314,6315],{"class":230},"Suggestion",[108,6317,257],{"class":180},[108,6319,6320,6323,6325,6328,6330,6333,6335,6337],{"class":110,"line":851},[108,6321,6322],{"class":114},"            throw",[108,6324,210],{"class":114},[108,6326,6327],{"class":176}," Error",[108,6329,181],{"class":180},[108,6331,6332],{"class":143},"'Suggestion is empty. Tencent Cloud TMS info:'",[108,6334,187],{"class":180},[108,6336,6310],{"class":278},[108,6338,1071],{"class":180},[108,6340,6341],{"class":110,"line":857},[108,6342,6343],{"class":180},"          }\n",[108,6345,6346],{"class":110,"line":862},[108,6347,562],{"emptyLinePlaceholder":561},[108,6349,6350,6353,6355,6357,6359,6361],{"class":110,"line":882},[108,6351,6352],{"class":114},"          switch",[108,6354,181],{"class":180},[108,6356,6310],{"class":218},[108,6358,221],{"class":180},[108,6360,6315],{"class":230},[108,6362,257],{"class":180},[108,6364,6365,6368,6371],{"class":110,"line":908},[108,6366,6367],{"class":114},"            case",[108,6369,6370],{"class":143}," 'Pass'",[108,6372,5583],{"class":180},[108,6374,6375,6378,6380,6382,6384,6387],{"class":110,"line":922},[108,6376,6377],{"class":218},"              data",[108,6379,221],{"class":180},[108,6381,541],{"class":230},[108,6383,123],{"class":122},[108,6385,6386],{"class":143}," 'approved'",[108,6388,983],{"class":180},[108,6390,6391,6394],{"class":110,"line":928},[108,6392,6393],{"class":114},"              break",[108,6395,983],{"class":180},[108,6397,6399,6401,6404],{"class":110,"line":6398},46,[108,6400,6367],{"class":114},[108,6402,6403],{"class":143}," 'Block'",[108,6405,5583],{"class":180},[108,6407,6409,6411,6413,6415,6417,6420],{"class":110,"line":6408},47,[108,6410,6377],{"class":218},[108,6412,221],{"class":180},[108,6414,541],{"class":230},[108,6416,123],{"class":122},[108,6418,6419],{"class":143}," 'spam'",[108,6421,983],{"class":180},[108,6423,6425,6427],{"class":110,"line":6424},48,[108,6426,6393],{"class":114},[108,6428,983],{"class":180},[108,6430,6432,6435,6438],{"class":110,"line":6431},49,[108,6433,6434],{"class":114},"              case",[108,6436,6437],{"class":143}," 'Review'",[108,6439,5583],{"class":180},[108,6441,6443,6446],{"class":110,"line":6442},50,[108,6444,6445],{"class":114},"              default",[108,6447,5583],{"class":180},[108,6449,6451,6454,6456,6458,6460,6463],{"class":110,"line":6450},51,[108,6452,6453],{"class":218},"                data",[108,6455,221],{"class":180},[108,6457,541],{"class":230},[108,6459,123],{"class":122},[108,6461,6462],{"class":143}," 'waiting'",[108,6464,983],{"class":180},[108,6466,6468,6471],{"class":110,"line":6467},52,[108,6469,6470],{"class":114},"                break",[108,6472,983],{"class":180},[108,6474,6476],{"class":110,"line":6475},53,[108,6477,6343],{"class":180},[108,6479,6481,6484,6486,6488,6491],{"class":110,"line":6480},54,[108,6482,6483],{"class":180},"        } ",[108,6485,2638],{"class":114},[108,6487,181],{"class":180},[108,6489,6490],{"class":278},"e",[108,6492,257],{"class":180},[108,6494,6496,6499,6501,6503,6505,6507],{"class":110,"line":6495},55,[108,6497,6498],{"class":218},"          console",[108,6500,221],{"class":180},[108,6502,1063],{"class":176},[108,6504,181],{"class":180},[108,6506,6490],{"class":278},[108,6508,1071],{"class":180},[108,6510,6512,6515,6517,6519,6521,6523],{"class":110,"line":6511},56,[108,6513,6514],{"class":218},"          data",[108,6516,221],{"class":180},[108,6518,541],{"class":230},[108,6520,123],{"class":122},[108,6522,6462],{"class":143},[108,6524,983],{"class":180},[108,6526,6528],{"class":110,"line":6527},57,[108,6529,6229],{"class":180},[108,6531,6533],{"class":110,"line":6532},58,[108,6534,6102],{"class":180},[108,6536,6538],{"class":110,"line":6537},59,[108,6539,2208],{"class":180},[108,6541,6543],{"class":110,"line":6542},60,[108,6544,6111],{"class":180},[108,6546,6548],{"class":110,"line":6547},61,[108,6549,651],{"class":180},[21,6551,6552,6553,6558,6559,6564],{},"可以看到，我们需要在这个被 module.exports 导出的函数中，return 一个对象，如果使用 hooks 编写的话可以调用",[25,6554,6557],{"href":6555,"rel":6556},"https://waline.js.org/reference/server/config.html#%E8%AF%84%E8%AE%BA-hooks",[41],"一些生命周期 hook",": 在 preSave 阶段，我们可以通过标注 data.status 参数来反馈评论类型。approved 为接受，spam 为垃圾邮件，waiting 为等待人工审核；除此之外，还可以",[25,6560,6563],{"href":6561,"rel":6562},"https://waline.js.org/reference/server/plugin.html#%E5%9F%BA%E4%BA%8E%E4%B8%AD%E9%97%B4%E4%BB%B6%E5%88%B6%E4%BD%9C",[41],"基于 Koa 中间件制作插件","，文档中有具体的描述。",[21,6566,6567],{},"index.js 顶部是需要引入的依赖。当然，如果需要引入外部的第三方包的话，需要在 packages.json 中加入需要的依赖（使用包管理器的命令进行安装）。",[21,6569,6570],{},"有了这些基础知识，就能手搓一个基于 GPT 的评论审查插件。",[21,6572,6573],{},"OpenAI 提供的是标准的 Restful API，本身的鉴权逻辑也不复杂，其实没必要调用 SDK，直接使用 fetch 调用就行。",[99,6575,6577],{"className":101,"code":6576,"language":103,"meta":104,"style":104},"const doReview = async (comment) => {\n  const response = await fetch(openaiBaseUrl + '/v1/chat/completions', {\n    method: 'POST',\n    headers: {\n      'Content-Type': 'application/json',\n      'Authorization': `Bearer ${openaiApiKey}`,\n    },\n    body: JSON.stringify({\n      model: openaiModel,\n      messages: [\n        {\n          role: 'system',\n          content: prompt\n        },\n        {\n          role: 'user',\n          content: comment,\n        },\n      ],\n    }),\n  });\n  const data = await response.json();\n  if (data && data.choices && data.choices.length > 0) {\n    return data.choices[0].message.content;\n  } else {\n    return 'waiting';\n  }\n}\n",[94,6578,6579,6601,6625,6637,6646,6658,6680,6684,6699,6711,6720,6725,6737,6747,6752,6756,6767,6778,6782,6787,6792,6797,6816,6853,6881,6889,6897,6901],{"__ignoreMap":104},[108,6580,6581,6583,6586,6588,6591,6593,6595,6597,6599],{"class":110,"line":111},[108,6582,115],{"class":114},[108,6584,6585],{"class":176}," doReview",[108,6587,123],{"class":122},[108,6589,6590],{"class":114}," async",[108,6592,242],{"class":180},[108,6594,6295],{"class":190},[108,6596,514],{"class":180},[108,6598,3732],{"class":114},[108,6600,197],{"class":180},[108,6602,6603,6605,6607,6609,6611,6613,6615,6618,6620,6623],{"class":110,"line":133},[108,6604,202],{"class":114},[108,6606,2306],{"class":118},[108,6608,123],{"class":122},[108,6610,579],{"class":114},[108,6612,892],{"class":176},[108,6614,181],{"class":180},[108,6616,6617],{"class":278},"openaiBaseUrl",[108,6619,817],{"class":122},[108,6621,6622],{"class":143}," '/v1/chat/completions'",[108,6624,905],{"class":180},[108,6626,6627,6630,6632,6635],{"class":110,"line":147},[108,6628,6629],{"class":230},"    method",[108,6631,545],{"class":544},[108,6633,6634],{"class":143}," 'POST'",[108,6636,919],{"class":180},[108,6638,6639,6642,6644],{"class":110,"line":260},[108,6640,6641],{"class":230},"    headers",[108,6643,545],{"class":544},[108,6645,197],{"class":180},[108,6647,6648,6651,6653,6656],{"class":110,"line":284},[108,6649,6650],{"class":143},"      'Content-Type'",[108,6652,545],{"class":544},[108,6654,6655],{"class":143}," 'application/json'",[108,6657,919],{"class":180},[108,6659,6660,6663,6665,6668,6670,6673,6675,6678],{"class":110,"line":311},[108,6661,6662],{"class":143},"      'Authorization'",[108,6664,545],{"class":544},[108,6666,6667],{"class":143}," `Bearer ",[108,6669,2944],{"class":2943},[108,6671,6672],{"class":278},"openaiApiKey",[108,6674,2950],{"class":2943},[108,6676,6677],{"class":143},"`",[108,6679,919],{"class":180},[108,6681,6682],{"class":110,"line":345},[108,6683,2208],{"class":180},[108,6685,6686,6689,6691,6693,6695,6697],{"class":110,"line":369},[108,6687,6688],{"class":230},"    body",[108,6690,545],{"class":544},[108,6692,3033],{"class":118},[108,6694,221],{"class":180},[108,6696,3038],{"class":176},[108,6698,2506],{"class":180},[108,6700,6701,6704,6706,6709],{"class":110,"line":389},[108,6702,6703],{"class":230},"      model",[108,6705,545],{"class":544},[108,6707,6708],{"class":278}," openaiModel",[108,6710,919],{"class":180},[108,6712,6713,6716,6718],{"class":110,"line":398},[108,6714,6715],{"class":230},"      messages",[108,6717,545],{"class":544},[108,6719,4303],{"class":180},[108,6721,6722],{"class":110,"line":422},[108,6723,6724],{"class":180},"        {\n",[108,6726,6727,6730,6732,6735],{"class":110,"line":428},[108,6728,6729],{"class":230},"          role",[108,6731,545],{"class":544},[108,6733,6734],{"class":143}," 'system'",[108,6736,919],{"class":180},[108,6738,6739,6742,6744],{"class":110,"line":597},[108,6740,6741],{"class":230},"          content",[108,6743,545],{"class":544},[108,6745,6746],{"class":278}," prompt\n",[108,6748,6749],{"class":110,"line":603},[108,6750,6751],{"class":180},"        },\n",[108,6753,6754],{"class":110,"line":626},[108,6755,6724],{"class":180},[108,6757,6758,6760,6762,6765],{"class":110,"line":631},[108,6759,6729],{"class":230},[108,6761,545],{"class":544},[108,6763,6764],{"class":143}," 'user'",[108,6766,919],{"class":180},[108,6768,6769,6771,6773,6776],{"class":110,"line":648},[108,6770,6741],{"class":230},[108,6772,545],{"class":544},[108,6774,6775],{"class":278}," comment",[108,6777,919],{"class":180},[108,6779,6780],{"class":110,"line":654},[108,6781,6751],{"class":180},[108,6783,6784],{"class":110,"line":659},[108,6785,6786],{"class":180},"      ],\n",[108,6788,6789],{"class":110,"line":664},[108,6790,6791],{"class":180},"    }),\n",[108,6793,6794],{"class":110,"line":670},[108,6795,6796],{"class":180},"  });\n",[108,6798,6799,6801,6803,6805,6807,6809,6811,6813],{"class":110,"line":675},[108,6800,202],{"class":114},[108,6802,6290],{"class":118},[108,6804,123],{"class":122},[108,6806,579],{"class":114},[108,6808,2306],{"class":218},[108,6810,221],{"class":180},[108,6812,591],{"class":176},[108,6814,6815],{"class":180},"();\n",[108,6817,6818,6820,6822,6824,6827,6829,6831,6834,6836,6838,6840,6842,6844,6847,6849,6851],{"class":110,"line":680},[108,6819,239],{"class":114},[108,6821,242],{"class":180},[108,6823,6143],{"class":278},[108,6825,6826],{"class":122}," &&",[108,6828,6290],{"class":218},[108,6830,221],{"class":180},[108,6832,6833],{"class":230},"choices",[108,6835,6826],{"class":122},[108,6837,6290],{"class":218},[108,6839,221],{"class":180},[108,6841,6833],{"class":224},[108,6843,221],{"class":180},[108,6845,6846],{"class":230},"length",[108,6848,2605],{"class":122},[108,6850,3886],{"class":548},[108,6852,257],{"class":180},[108,6854,6855,6857,6859,6861,6863,6866,6869,6872,6874,6876,6879],{"class":110,"line":696},[108,6856,526],{"class":114},[108,6858,6290],{"class":218},[108,6860,221],{"class":180},[108,6862,6833],{"class":230},[108,6864,6865],{"class":180},"[",[108,6867,6868],{"class":548},"0",[108,6870,6871],{"class":180},"].",[108,6873,728],{"class":224},[108,6875,221],{"class":180},[108,6877,6878],{"class":230},"content",[108,6880,983],{"class":180},[108,6882,6883,6885,6887],{"class":110,"line":713},[108,6884,287],{"class":180},[108,6886,290],{"class":114},[108,6888,197],{"class":180},[108,6890,6891,6893,6895],{"class":110,"line":733},[108,6892,526],{"class":114},[108,6894,6462],{"class":143},[108,6896,983],{"class":180},[108,6898,6899],{"class":110,"line":738},[108,6900,425],{"class":180},[108,6902,6903],{"class":110,"line":743},[108,6904,651],{"class":180},[21,6906,6907],{},"再配合相应的封装，一款基于 GPT 的 waline 评论审核插件就完成了",[1426,6909,6910],{},[1429,6911,6912],{},[25,6913,6916],{"href":6914,"rel":6915},"https://github.com/zhullyb/waline-plugin-llm-reviewer",[41],"zhullyb/waline-plugin-llm-reviewer",[21,6918,6919],{},[31,6920,6921],{},"如何安装",[99,6923,6925],{"className":1533,"code":6924,"language":1535,"meta":104,"style":104},"npm install waline-plugin-llm-reviewer\n",[94,6926,6927],{"__ignoreMap":104},[108,6928,6929,6932,6934],{"class":110,"line":111},[108,6930,6931],{"class":176},"npm",[108,6933,4633],{"class":143},[108,6935,6936],{"class":143}," waline-plugin-llm-reviewer\n",[21,6938,6939],{},[31,6940,6941],{},"如何使用",[99,6943,6945],{"className":101,"code":6944,"language":103,"meta":104,"style":104},"// index.js\nconst Waline = require('@waline/vercel');\nconst GPTReviewer = require('waline-plugin-llm-reviewer');\n\nmodule.exports = Waline({\n  plugins: [\n    GptReviewer({\n        openaiBaseUrl: process.env.OPENAI_BASE_URL,\n        openaiModel: process.env.OPENAI_MODEL,\n        openaiApiKey: process.env.OPENAI_API_KEY,\n        openaiPrompt: process.env.OPENAI_PROMPT,\n    })\n  ]\n});\n",[94,6946,6947,6951,6969,6987,6991,7005,7014,7021,7044,7064,7084,7104,7109,7114],{"__ignoreMap":104},[108,6948,6949],{"class":110,"line":111},[108,6950,5890],{"class":129},[108,6952,6953,6955,6958,6960,6962,6964,6967],{"class":110,"line":133},[108,6954,115],{"class":114},[108,6956,6957],{"class":118}," Waline",[108,6959,123],{"class":122},[108,6961,5906],{"class":176},[108,6963,181],{"class":180},[108,6965,6966],{"class":143},"'@waline/vercel'",[108,6968,1071],{"class":180},[108,6970,6971,6973,6976,6978,6980,6982,6985],{"class":110,"line":147},[108,6972,115],{"class":114},[108,6974,6975],{"class":118}," GPTReviewer",[108,6977,123],{"class":122},[108,6979,5906],{"class":176},[108,6981,181],{"class":180},[108,6983,6984],{"class":143},"'waline-plugin-llm-reviewer'",[108,6986,1071],{"class":180},[108,6988,6989],{"class":110,"line":260},[108,6990,562],{"emptyLinePlaceholder":561},[108,6992,6993,6995,6997,6999,7001,7003],{"class":110,"line":284},[108,6994,5954],{"class":224},[108,6996,221],{"class":180},[108,6998,5959],{"class":224},[108,7000,123],{"class":122},[108,7002,6957],{"class":176},[108,7004,2506],{"class":180},[108,7006,7007,7010,7012],{"class":110,"line":311},[108,7008,7009],{"class":230},"  plugins",[108,7011,545],{"class":544},[108,7013,4303],{"class":180},[108,7015,7016,7019],{"class":110,"line":345},[108,7017,7018],{"class":176},"    GptReviewer",[108,7020,2506],{"class":180},[108,7022,7023,7026,7028,7031,7033,7036,7038,7042],{"class":110,"line":369},[108,7024,7025],{"class":230},"        openaiBaseUrl",[108,7027,545],{"class":544},[108,7029,7030],{"class":218}," process",[108,7032,221],{"class":180},[108,7034,7035],{"class":1120},"env",[108,7037,221],{"class":180},[108,7039,7041],{"class":7040},"sRZ4U","OPENAI_BASE_URL",[108,7043,919],{"class":180},[108,7045,7046,7049,7051,7053,7055,7057,7059,7062],{"class":110,"line":389},[108,7047,7048],{"class":230},"        openaiModel",[108,7050,545],{"class":544},[108,7052,7030],{"class":218},[108,7054,221],{"class":180},[108,7056,7035],{"class":1120},[108,7058,221],{"class":180},[108,7060,7061],{"class":7040},"OPENAI_MODEL",[108,7063,919],{"class":180},[108,7065,7066,7069,7071,7073,7075,7077,7079,7082],{"class":110,"line":398},[108,7067,7068],{"class":230},"        openaiApiKey",[108,7070,545],{"class":544},[108,7072,7030],{"class":218},[108,7074,221],{"class":180},[108,7076,7035],{"class":1120},[108,7078,221],{"class":180},[108,7080,7081],{"class":7040},"OPENAI_API_KEY",[108,7083,919],{"class":180},[108,7085,7086,7089,7091,7093,7095,7097,7099,7102],{"class":110,"line":422},[108,7087,7088],{"class":230},"        openaiPrompt",[108,7090,545],{"class":544},[108,7092,7030],{"class":218},[108,7094,221],{"class":180},[108,7096,7035],{"class":1120},[108,7098,221],{"class":180},[108,7100,7101],{"class":7040},"OPENAI_PROMPT",[108,7103,919],{"class":180},[108,7105,7106],{"class":110,"line":428},[108,7107,7108],{"class":180},"    })\n",[108,7110,7111],{"class":110,"line":597},[108,7112,7113],{"class":180},"  ]\n",[108,7115,7116],{"class":110,"line":603},[108,7117,2259],{"class":180},[21,7119,7120],{},[31,7121,7122],{},"环境变量",[1426,7124,7125,7138,7146,7154,7162],{},[1429,7126,7127,7130,7131,1487],{},[94,7128,7129],{},"ASISMET_KEY",": Waline 使用的反垃圾评论服务，",[31,7132,7133,7134,7137],{},"建议设置为 ",[94,7135,7136],{},"false"," 以禁用",[1429,7139,7140,7142,7143],{},[94,7141,7041],{},": API 基础 URL。例如 ",[94,7144,7145],{},"https://api.openai.com",[1429,7147,7148,7150,7151],{},[94,7149,7061],{},": 模型名称。例如 ",[94,7152,7153],{},"gpt-4o-mini",[1429,7155,7156,7158,7159],{},[94,7157,7081],{},": API 密钥。例如 ",[94,7160,7161],{},"ak-xxxxxx",[1429,7163,7164,7166,7167],{},[94,7165,7101],{},"(可选): 模型的提示。例如 ",[94,7168,7169],{},"这是一个评论审查: ",[21,7171,7172],{},"在 waline 中设置好对应的环境变量，使用 npm 安装好对应的包，就算大功告成了。",[21,7174,7175],{},[1382,7176],{"alt":104,"src":7177},"https://static.031130.xyz/uploads/2024/10/12/45f06a78286de.webp",[1394,7179,7180],{},"html pre.shiki code .sW2Sy, html code.shiki .sW2Sy{--shiki-default:#A0A1A7;--shiki-default-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic}html pre.shiki code .sLKXg, html code.shiki .sLKXg{--shiki-default:#A626A4;--shiki-dark:#C678DD}html pre.shiki code .sNmU0, html code.shiki .sNmU0{--shiki-default:#986801;--shiki-dark:#E5C07B}html pre.shiki code .s_Sar, html code.shiki .s_Sar{--shiki-default:#0184BC;--shiki-dark:#56B6C2}html pre.shiki code .sAdtL, html code.shiki .sAdtL{--shiki-default:#4078F2;--shiki-dark:#61AFEF}html pre.shiki code .s5ixo, html code.shiki .s5ixo{--shiki-default:#383A42;--shiki-dark:#ABB2BF}html pre.shiki code .sDhpE, html code.shiki .sDhpE{--shiki-default:#50A14F;--shiki-dark:#98C379}html pre.shiki code .s7GmK, html code.shiki .s7GmK{--shiki-default:#383A42;--shiki-dark:#E5C07B}html pre.shiki code .s2QsP, html code.shiki .s2QsP{--shiki-default:#E45649;--shiki-dark:#E5C07B}html pre.shiki code .sJa8x, html code.shiki .sJa8x{--shiki-default:#E45649;--shiki-dark:#E06C75}html pre.shiki code .s8iYz, html code.shiki .s8iYz{--shiki-default:#383A42;--shiki-default-font-style:inherit;--shiki-dark:#E06C75;--shiki-dark-font-style:italic}html pre.shiki code .sz0mV, html code.shiki .sz0mV{--shiki-default:#383A42;--shiki-dark:#E06C75}html pre.shiki code .st7oF, html code.shiki .st7oF{--shiki-default:#0184BC;--shiki-dark:#ABB2BF}html .default .shiki span {color: var(--shiki-default);background: var(--shiki-default-bg);font-style: var(--shiki-default-font-style);font-weight: var(--shiki-default-font-weight);text-decoration: var(--shiki-default-text-decoration);}html .shiki span {color: var(--shiki-default);background: var(--shiki-default-bg);font-style: var(--shiki-default-font-style);font-weight: var(--shiki-default-font-weight);text-decoration: var(--shiki-default-text-decoration);}html .dark .shiki span {color: var(--shiki-dark);background: var(--shiki-dark-bg);font-style: var(--shiki-dark-font-style);font-weight: var(--shiki-dark-font-weight);text-decoration: var(--shiki-dark-text-decoration);}html.dark .shiki span {color: var(--shiki-dark);background: var(--shiki-dark-bg);font-style: var(--shiki-dark-font-style);font-weight: var(--shiki-dark-font-weight);text-decoration: var(--shiki-dark-text-decoration);}html pre.shiki code .sAOjX, html code.shiki .sAOjX{--shiki-default:#CA1243;--shiki-dark:#C678DD}html pre.shiki code .sAGMh, html code.shiki .sAGMh{--shiki-default:#986801;--shiki-dark:#D19A66}html pre.shiki code .sC09Y, html code.shiki .sC09Y{--shiki-default:#C18401;--shiki-dark:#E5C07B}html pre.shiki code .sRZ4U, html code.shiki .sRZ4U{--shiki-default:#986801;--shiki-dark:#E06C75}",{"title":104,"searchDepth":133,"depth":133,"links":7182},[],{"title":7184,"date":7185,"path":7186,"tags":7187,"body":7188},"基于 JavaScript 的 Hexo Fluid 主题 banner 随机背景图实现","2024-09-25 00:00:42","/2024/09/25/random-banner-backgroud-image-implement-for-hexo-fluid-with-javascript",[1939,4041],{"type":14,"value":7189,"toc":7628},[7190,7194,7203,7209,7213,7221,7227,7230,7233,7236,7240,7243,7247,7250,7253,7266,7272,7276,7279,7330,7333,7342,7603,7606,7614,7616,7625],[17,7191,7193],{"id":7192},"为什么要换掉随机图片-api","为什么要换掉随机图片 API",[21,7195,7196,7197,7202],{},"因为 API 太慢了。根据 ",[25,7198,7201],{"href":7199,"rel":7200},"https://pagespeed.web.dev/",[41],"PageSpeed"," 的测速，使用 API 的图片加载时间来到了整整 2.5s，这似乎有些不可忍受。",[21,7204,7205],{},[1382,7206],{"alt":7207,"src":7208},"PageSpeed 测速","https://static.031130.xyz/uploads/2024/09/25/3ef1a17bca955.webp",[84,7210,7212],{"id":7211},"vercel-冷启动问题","Vercel 冷启动问题",[21,7214,7215,7216,7220],{},"当初年少无知，为了实现 banner 随机背景图，选择了",[25,7217,7219],{"href":7218},"/2021/05/21/create-a-random-picture-api-with-vercel/","使用 vercel 创建随机图片 API","。这带来了一些问题，首先 vercel 在站点一段时间没人访问以后会进入一种类似休眠的模式，下一次启动将会经历一个冷启动（cold start）的过程。我认为这对于一个图片背景的随机 API 而言是不可忍受的。",[21,7222,7223],{},[1382,7224],{"alt":7225,"src":7226},"冷启动","https://static.031130.xyz/uploads/2024/09/24/f8cb9fd7a963e.webp",[21,7228,7229],{},"观察图上就可以发现，第一次访问时花费了 1.9 秒，第二次只需要 0.5 秒，这是因为第一次是冷启动，需要花费更多时间。",[84,7231,7232],{"id":7232},"多一次网络请求",[21,7234,7235],{},"抛开冷启动不谈，引入 API 就会导致一次额外的网络请求。访客的浏览器将会先请求随机图片 API，然后根据 API 返回的 302 相应去请求真正的图片，而且这一过程是没法并行的，只能串行执行，这会浪费更多的等待时间。",[84,7237,7239],{"id":7238},"vercel-在大陆境内的访问质量","Vercel 在大陆境内的访问质量",[21,7241,7242],{},"Vercel 在大陆境内的访问质量其实并不算好，即使是使用了所谓的优选节点，也不一定能保证整个大陆境内大部分访客都有不错的访问质量，因此使用 Vercel 搭建 API 的行为并不是最优解。",[17,7244,7246],{"id":7245},"转向-javascript-实现","转向 JavaScript 实现",[21,7248,7249],{},"这个方案本身没多少复杂的，只不过是三年前的我对前端一无所知不敢操刀罢了。",[84,7251,7252],{"id":7252},"删除原有的背景图",[21,7254,64,7255,7257,7258,7261,7262,7265],{},[94,7256,4054],{}," 中，将所有的 ",[94,7259,7260],{},"banner_img:"," 字段全部置空，防止其加载默认的 ",[94,7263,7264],{},"/img/default.png"," 而白白浪费用户的流量。这个字段一共在配置文件中出现了九次。",[21,7267,7268],{},[1382,7269],{"alt":7270,"src":7271},"字段置空","https://static.031130.xyz/uploads/2024/09/25/70bd0b27f5aad.webp",[84,7273,7275],{"id":7274},"添加-js","添加 js",[21,7277,7278],{},"我们的目标是修改 id 为 banner 的 div 块的 backgroud 的 css 属性，Hexo Fluid 默认的生成内容是这样的",[99,7280,7284],{"className":7281,"code":7282,"language":7283,"meta":104,"style":104},"language-html shiki shiki-themes one-light one-dark-pro","\u003Cdiv id=\"banner\" class=\"banner\" parallax=true style=\"background: url('/img/default.png') no-repeat center center; background-size: cover;\">\n","html",[94,7285,7286],{"__ignoreMap":104},[108,7287,7288,7290,7292,7295,7297,7300,7303,7305,7307,7310,7312,7315,7318,7320,7322,7326,7328],{"class":110,"line":111},[108,7289,5451],{"class":180},[108,7291,1467],{"class":230},[108,7293,7294],{"class":548}," id",[108,7296,3700],{"class":180},[108,7298,7299],{"class":143},"\"banner\"",[108,7301,7302],{"class":548}," class",[108,7304,3700],{"class":180},[108,7306,7299],{"class":143},[108,7308,7309],{"class":548}," parallax",[108,7311,3700],{"class":180},[108,7313,7314],{"class":143},"true",[108,7316,7317],{"class":548}," style",[108,7319,3700],{"class":180},[108,7321,1223],{"class":143},[108,7323,7325],{"class":7324},"s-4uI","background: url('/img/default.png') no-repeat center center; background-size: cover;",[108,7327,1223],{"class":143},[108,7329,5456],{"class":180},[21,7331,7332],{},"我们可以通过 id 来定位这个元素，修改其 style.background 属性。",[21,7334,7335,7336,7341],{},"可以在任何地方引入下面的 js 代码，在这篇名为",[25,7337,7340],{"href":7338,"rel":7339},"https://www.zywvvd.com/notes/hexo/theme/fluid/fluid-add-umami/fluid-add-umami/",[41],"《Fluid -23- 添加 Umami 统计》"," 的文章里的方案是可供参考的。",[99,7343,7345],{"className":101,"code":7344,"language":103,"meta":104,"style":104},"const imgs = [\n    \"https://example.com/1.jpg\",\n    \"https://example.com/2.jpg\",\n    \"https://example.com/3.jpg\",\n    \"https://example.com/4.jpg\",\n    \"https://example.com/5.jpg\",\n    \"https://example.com/6.jpg\",\n    \"https://example.com/7.jpg\",\n    \"https://example.com/8.jpg\",\n    \"https://example.com/9.jpg\",\n    \"https://example.com/10.jpg\",\n    \"https://example.com/11.jpg\",\n    \"https://example.com/12.jpg\",\n    \"https://example.com/13.jpg\",\n    \"https://example.com/14.jpg\",\n    \"https://example.com/15.jpg\",\n    \"https://example.com/16.jpg\",\n    \"https://example.com/17.jpg\",\n    \"https://example.com/18.jpg\",\n    \"https://example.com/19.jpg\",\n    \"https://example.com/20.jpg\",\n]\n\nconst luck_img = imgs[Math.floor(Math.random() * imgs.length)]\nconst banner = document.getElementById('banner')\nbanner.style.background = `url(${luck_img}) center center / cover no-repeat`\n",[94,7346,7347,7358,7365,7372,7379,7386,7393,7400,7407,7414,7421,7428,7435,7442,7449,7456,7463,7470,7477,7484,7491,7498,7502,7506,7550,7574],{"__ignoreMap":104},[108,7348,7349,7351,7354,7356],{"class":110,"line":111},[108,7350,115],{"class":114},[108,7352,7353],{"class":118}," imgs",[108,7355,123],{"class":122},[108,7357,4303],{"class":180},[108,7359,7360,7363],{"class":110,"line":133},[108,7361,7362],{"class":143},"    \"https://example.com/1.jpg\"",[108,7364,919],{"class":180},[108,7366,7367,7370],{"class":110,"line":147},[108,7368,7369],{"class":143},"    \"https://example.com/2.jpg\"",[108,7371,919],{"class":180},[108,7373,7374,7377],{"class":110,"line":260},[108,7375,7376],{"class":143},"    \"https://example.com/3.jpg\"",[108,7378,919],{"class":180},[108,7380,7381,7384],{"class":110,"line":284},[108,7382,7383],{"class":143},"    \"https://example.com/4.jpg\"",[108,7385,919],{"class":180},[108,7387,7388,7391],{"class":110,"line":311},[108,7389,7390],{"class":143},"    \"https://example.com/5.jpg\"",[108,7392,919],{"class":180},[108,7394,7395,7398],{"class":110,"line":345},[108,7396,7397],{"class":143},"    \"https://example.com/6.jpg\"",[108,7399,919],{"class":180},[108,7401,7402,7405],{"class":110,"line":369},[108,7403,7404],{"class":143},"    \"https://example.com/7.jpg\"",[108,7406,919],{"class":180},[108,7408,7409,7412],{"class":110,"line":389},[108,7410,7411],{"class":143},"    \"https://example.com/8.jpg\"",[108,7413,919],{"class":180},[108,7415,7416,7419],{"class":110,"line":398},[108,7417,7418],{"class":143},"    \"https://example.com/9.jpg\"",[108,7420,919],{"class":180},[108,7422,7423,7426],{"class":110,"line":422},[108,7424,7425],{"class":143},"    \"https://example.com/10.jpg\"",[108,7427,919],{"class":180},[108,7429,7430,7433],{"class":110,"line":428},[108,7431,7432],{"class":143},"    \"https://example.com/11.jpg\"",[108,7434,919],{"class":180},[108,7436,7437,7440],{"class":110,"line":597},[108,7438,7439],{"class":143},"    \"https://example.com/12.jpg\"",[108,7441,919],{"class":180},[108,7443,7444,7447],{"class":110,"line":603},[108,7445,7446],{"class":143},"    \"https://example.com/13.jpg\"",[108,7448,919],{"class":180},[108,7450,7451,7454],{"class":110,"line":626},[108,7452,7453],{"class":143},"    \"https://example.com/14.jpg\"",[108,7455,919],{"class":180},[108,7457,7458,7461],{"class":110,"line":631},[108,7459,7460],{"class":143},"    \"https://example.com/15.jpg\"",[108,7462,919],{"class":180},[108,7464,7465,7468],{"class":110,"line":648},[108,7466,7467],{"class":143},"    \"https://example.com/16.jpg\"",[108,7469,919],{"class":180},[108,7471,7472,7475],{"class":110,"line":654},[108,7473,7474],{"class":143},"    \"https://example.com/17.jpg\"",[108,7476,919],{"class":180},[108,7478,7479,7482],{"class":110,"line":659},[108,7480,7481],{"class":143},"    \"https://example.com/18.jpg\"",[108,7483,919],{"class":180},[108,7485,7486,7489],{"class":110,"line":664},[108,7487,7488],{"class":143},"    \"https://example.com/19.jpg\"",[108,7490,919],{"class":180},[108,7492,7493,7496],{"class":110,"line":670},[108,7494,7495],{"class":143},"    \"https://example.com/20.jpg\"",[108,7497,919],{"class":180},[108,7499,7500],{"class":110,"line":675},[108,7501,2845],{"class":180},[108,7503,7504],{"class":110,"line":680},[108,7505,562],{"emptyLinePlaceholder":561},[108,7507,7508,7510,7513,7515,7517,7519,7522,7524,7527,7529,7531,7533,7536,7539,7541,7543,7545,7547],{"class":110,"line":696},[108,7509,115],{"class":114},[108,7511,7512],{"class":118}," luck_img",[108,7514,123],{"class":122},[108,7516,7353],{"class":278},[108,7518,6865],{"class":180},[108,7520,7521],{"class":218},"Math",[108,7523,221],{"class":180},[108,7525,7526],{"class":176},"floor",[108,7528,181],{"class":180},[108,7530,7521],{"class":218},[108,7532,221],{"class":180},[108,7534,7535],{"class":176},"random",[108,7537,7538],{"class":180},"() ",[108,7540,4733],{"class":122},[108,7542,7353],{"class":218},[108,7544,221],{"class":180},[108,7546,6846],{"class":230},[108,7548,7549],{"class":180},")]\n",[108,7551,7552,7554,7557,7559,7562,7564,7567,7569,7572],{"class":110,"line":713},[108,7553,115],{"class":114},[108,7555,7556],{"class":118}," banner",[108,7558,123],{"class":122},[108,7560,7561],{"class":218}," document",[108,7563,221],{"class":180},[108,7565,7566],{"class":176},"getElementById",[108,7568,181],{"class":180},[108,7570,7571],{"class":143},"'banner'",[108,7573,234],{"class":180},[108,7575,7576,7579,7581,7583,7585,7588,7590,7593,7595,7598,7600],{"class":110,"line":733},[108,7577,7578],{"class":218},"banner",[108,7580,221],{"class":180},[108,7582,1394],{"class":224},[108,7584,221],{"class":180},[108,7586,7587],{"class":230},"background",[108,7589,123],{"class":122},[108,7591,7592],{"class":143}," `url(",[108,7594,2944],{"class":2943},[108,7596,7597],{"class":278},"luck_img",[108,7599,2950],{"class":2943},[108,7601,7602],{"class":143},") center center / cover no-repeat`\n",[17,7604,7605],{"id":7605},"成果",[21,7607,7608,7609,7613],{},"博客能够在不引入外部 api 的情况下通过 js 自主实现随机的 banner 背景图，",[7610,7611,7612],"del",{},"但 pagespeed 的测速结果并没有明显好转","，因为 pagespeed 模拟了低速 4G 的访问速度，无论如何都无法提升大文件的加载速度。不过避免了多一次网络请求后，打开页面时的加载速度确实有提升。",[17,7615,1808],{"id":1808},[1426,7617,7618],{},[1429,7619,7620],{},[25,7621,7624],{"href":7622,"rel":7623},"https://vercel.com/guides/how-can-i-improve-serverless-function-lambda-cold-start-performance-on-vercel",[41],"How can I improve function cold start performance on Vercel?",[1394,7626,7627],{},"html pre.shiki code .s5ixo, html code.shiki .s5ixo{--shiki-default:#383A42;--shiki-dark:#ABB2BF}html pre.shiki code .sJa8x, html code.shiki .sJa8x{--shiki-default:#E45649;--shiki-dark:#E06C75}html pre.shiki code .sAGMh, html code.shiki .sAGMh{--shiki-default:#986801;--shiki-dark:#D19A66}html pre.shiki code .sDhpE, html code.shiki .sDhpE{--shiki-default:#50A14F;--shiki-dark:#98C379}html pre.shiki code .s-4uI, html code.shiki .s-4uI{--shiki-default:#383A42;--shiki-dark:#98C379}html .default .shiki span {color: var(--shiki-default);background: var(--shiki-default-bg);font-style: var(--shiki-default-font-style);font-weight: var(--shiki-default-font-weight);text-decoration: var(--shiki-default-text-decoration);}html .shiki span {color: var(--shiki-default);background: var(--shiki-default-bg);font-style: var(--shiki-default-font-style);font-weight: var(--shiki-default-font-weight);text-decoration: var(--shiki-default-text-decoration);}html .dark .shiki span {color: var(--shiki-dark);background: var(--shiki-dark-bg);font-style: var(--shiki-dark-font-style);font-weight: var(--shiki-dark-font-weight);text-decoration: var(--shiki-dark-text-decoration);}html.dark .shiki span {color: var(--shiki-dark);background: var(--shiki-dark-bg);font-style: var(--shiki-dark-font-style);font-weight: var(--shiki-dark-font-weight);text-decoration: var(--shiki-dark-text-decoration);}html pre.shiki code .sLKXg, html code.shiki .sLKXg{--shiki-default:#A626A4;--shiki-dark:#C678DD}html pre.shiki code .sNmU0, html code.shiki .sNmU0{--shiki-default:#986801;--shiki-dark:#E5C07B}html pre.shiki code .s_Sar, html code.shiki .s_Sar{--shiki-default:#0184BC;--shiki-dark:#56B6C2}html pre.shiki code .sz0mV, html code.shiki .sz0mV{--shiki-default:#383A42;--shiki-dark:#E06C75}html pre.shiki code .s7GmK, html code.shiki .s7GmK{--shiki-default:#383A42;--shiki-dark:#E5C07B}html pre.shiki code .sAdtL, html code.shiki .sAdtL{--shiki-default:#4078F2;--shiki-dark:#61AFEF}html pre.shiki code .s2QsP, html code.shiki .s2QsP{--shiki-default:#E45649;--shiki-dark:#E5C07B}html pre.shiki code .sAOjX, html code.shiki .sAOjX{--shiki-default:#CA1243;--shiki-dark:#C678DD}",{"title":104,"searchDepth":133,"depth":133,"links":7629},[7630,7635,7639,7640],{"id":7192,"depth":133,"text":7193,"children":7631},[7632,7633,7634],{"id":7211,"depth":147,"text":7212},{"id":7232,"depth":147,"text":7232},{"id":7238,"depth":147,"text":7239},{"id":7245,"depth":133,"text":7246,"children":7636},[7637,7638],{"id":7252,"depth":147,"text":7252},{"id":7274,"depth":147,"text":7275},{"id":7605,"depth":133,"text":7605},{"id":1808,"depth":133,"text":1808},{"title":7642,"date":7643,"path":7644,"tags":7645,"body":7648},"使用向日葵智能插座 C2 用电记录推算宿舍上次烧水时间","2024-09-24 05:17:47","/2024/09/24/log-last-water-boiling-water-with-sunlogin-adapter-power-consumption",[7646,4039,7647,11],"IoT","Hardware",{"type":14,"value":7649,"toc":8083},[7650,7656,7662,7669,7685,7691,7698,7704,7719,7722,7728,7731,7801,7815,7818,8068,8071,8074,8080],[21,7651,7652,7653],{},"我宿舍里入口处有一张公用的桌子，上面有一个烧水壶。根据生活经验，当用手摸烧水壶外壳能感受到明显热量时，水壶内的水大概是两小时内烧的，绝对能喝；但如果用手摸烧水壶外壳感受不到明显热量时，水壶内的水就不知道是什么时候烧的了，可能是三小时前，也可能是三天前。此时，在不寻求外部科学仪器介入的情况下，唯一能做的是询问寝室成员上一次水是谁烧的，是什么时候烧的。但寝室成员并不总是能够及时回答，可能在睡觉，也可能不在寝室里，",[7610,7654,7655],{},"还有可能出现记忆错乱。",[21,7657,7658,7659],{},"因此，",[31,7660,7661],{},"我们需要一种可靠的方案获取上一次烧水时间。",[21,7663,7664,7665,7668],{},"前两天陪黄老板出门吃宵夜的时候和他提到了这个难题，我提出在烧水壶附近加装物理按钮，按动时向局域网内的 HomeServer 发送请求记录准确的烧水时间。他提出可以在烧水壶前加装智能插座，使用智能插座的耗电量来推算上一次烧水时间。这是一个可行方案，上次烧水时间不需要分钟级的精准度，",[31,7666,7667],{},"小时级的精准度在这个需求上完全够用","，这是一个更好的方案。",[21,7670,7671,7672,7676,7677,7680,7681,7684],{},"在「",[25,7673,7675],{"href":7674},"/2023/11/01/unveiling-sunflower-smart-adapter-api-intercepting-utilizing-api-android-packet-sniffing/","使用 Root 后的安卓手机获取向日葵智能插座 C2 的开关 api","」这篇文章中，我有过抓包向日葵官方 app 的流量数据的经验，这一次直接故技重施。很可惜，我发现",[31,7678,7679],{},"用电量数据","并不能直接从局域网内向智能插座获取，",[31,7682,7683],{},"必须要从向日葵官方的服务器拉下来","。其实想想也知道，用电数据一旦精确到小时级，日积月累下来会对硬件的存储提出一定的挑战，而比较合理的方案就是由硬件向官方的服务器每小时通信一次记录下来。",[21,7686,7687],{},[1382,7688],{"alt":7689,"src":7690},"抓包","https://static.031130.xyz/uploads/2024/09/24/bd6b0bdbab1da.webp",[21,7692,7693,7694,7697],{},"不过好消息是，",[31,7695,7696],{},"官方服务器的这个接口并没有进行鉴权","，不需要进行额外的操作，一条 curl 命令都能下载下来。",[21,7699,7700],{},[1382,7701],{"alt":7702,"src":7703},"curl 命令下载用电量数据","https://static.031130.xyz/uploads/2024/09/24/bf4ad72e00044.webp",[99,7705,7709],{"className":7706,"code":7707,"language":7708,"meta":104,"style":104},"language-shell shiki shiki-themes one-light one-dark-pro","https://sl-api.oray.com/smartplug/powerconsumes/${SN}\n","shell",[94,7710,7711],{"__ignoreMap":104},[108,7712,7713,7716],{"class":110,"line":111},[108,7714,7715],{"class":176},"https://sl-api.oray.com/smartplug/powerconsumes/$",[108,7717,7718],{"class":143},"{SN}\n",[21,7720,7721],{},"SN 码也不需要自己去抓包，直接在官方应用的设备关于页面就能看到。",[21,7723,7724],{},[1382,7725],{"alt":7726,"src":7727},"关于页面","https://static.031130.xyz/uploads/2024/09/24/edca671f53571.webp",[21,7729,7730],{},"json 数据的结构很明显，最外层是一个 Array，里面有若干个 object",[99,7732,7734],{"className":3146,"code":7733,"language":591,"meta":104,"style":104},"[\n  {\n    \"consume\": 0,\n    \"starttime\": 1727125200,\n    \"endtime\": 1727128740,\n    \"index\": 0\n  },\n...\n]\n",[94,7735,7736,7740,7744,7755,7767,7779,7788,7792,7797],{"__ignoreMap":104},[108,7737,7738],{"class":110,"line":111},[108,7739,3154],{"class":180},[108,7741,7742],{"class":110,"line":133},[108,7743,3159],{"class":180},[108,7745,7746,7749,7751,7753],{"class":110,"line":147},[108,7747,7748],{"class":230},"    \"consume\"",[108,7750,3168],{"class":180},[108,7752,6868],{"class":548},[108,7754,919],{"class":180},[108,7756,7757,7760,7762,7765],{"class":110,"line":260},[108,7758,7759],{"class":230},"    \"starttime\"",[108,7761,3168],{"class":180},[108,7763,7764],{"class":548},"1727125200",[108,7766,919],{"class":180},[108,7768,7769,7772,7774,7777],{"class":110,"line":284},[108,7770,7771],{"class":230},"    \"endtime\"",[108,7773,3168],{"class":180},[108,7775,7776],{"class":548},"1727128740",[108,7778,919],{"class":180},[108,7780,7781,7784,7786],{"class":110,"line":311},[108,7782,7783],{"class":230},"    \"index\"",[108,7785,3168],{"class":180},[108,7787,5613],{"class":548},[108,7789,7790],{"class":110,"line":345},[108,7791,2918],{"class":180},[108,7793,7794],{"class":110,"line":369},[108,7795,7796],{"class":3164},"...\n",[108,7798,7799],{"class":110,"line":389},[108,7800,2845],{"class":180},[1426,7802,7803,7806,7809,7812],{},[1429,7804,7805],{},"consume: 这段时间消耗的用电量，单位 Wh",[1429,7807,7808],{},"starttime: 开始时间，unix 时间戳",[1429,7810,7811],{},"endtime: 结束时间，unix 时间戳",[1429,7813,7814],{},"index: 智能插座的第几个孔位（为插排预留的参数，智能插座只有 0 这一个位置）",[21,7816,7817],{},"所以我们要做的就是每小时下载一次这个 json 文件，需要时从 json 中寻找上一次用电量较高的小时，取那个小时的 starttime 时间戳转换为东八区人类可读的时间即可。",[99,7819,7821],{"className":4230,"code":7820,"language":4232,"meta":104,"style":104},"def last_water():\n    with open('power.json', 'r') as f:\n        powers = json.load(f)\n    for i in powers:\n        if i.get('consume') >= 30:\n            t = i.get('starttime')\n            break\n    last_water_time = datetime.datetime.fromtimestamp(t)\n    now = datetime.datetime.now()\n    time_delta = now - last_water_time\n    sec = time_delta.total_seconds()\n    hours = sec / 3600\n    lwt_str = last_water_time.strftime('%m月%d日%H点')\n    return f\"上次烧水时间为「{lwt_str}」，距离现在「{hours:.2f}」小时\"\n",[94,7822,7823,7834,7856,7872,7885,7909,7927,7932,7948,7962,7978,7993,8008,8034],{"__ignoreMap":104},[108,7824,7825,7828,7831],{"class":110,"line":111},[108,7826,7827],{"class":114},"def",[108,7829,7830],{"class":176}," last_water",[108,7832,7833],{"class":180},"():\n",[108,7835,7836,7839,7841,7843,7846,7848,7850,7852,7854],{"class":110,"line":133},[108,7837,7838],{"class":114},"    with",[108,7840,4254],{"class":122},[108,7842,181],{"class":180},[108,7844,7845],{"class":143},"'power.json'",[108,7847,187],{"class":180},[108,7849,4264],{"class":143},[108,7851,514],{"class":180},[108,7853,4269],{"class":114},[108,7855,4272],{"class":180},[108,7857,7858,7861,7863,7866,7869],{"class":110,"line":147},[108,7859,7860],{"class":180},"        powers ",[108,7862,3700],{"class":4280},[108,7864,7865],{"class":180}," json.",[108,7867,7868],{"class":4286},"load",[108,7870,7871],{"class":180},"(f)\n",[108,7873,7874,7877,7880,7882],{"class":110,"line":260},[108,7875,7876],{"class":114},"    for",[108,7878,7879],{"class":180}," i ",[108,7881,4459],{"class":114},[108,7883,7884],{"class":180}," powers:\n",[108,7886,7887,7889,7892,7894,7896,7899,7901,7904,7907],{"class":110,"line":284},[108,7888,6210],{"class":114},[108,7890,7891],{"class":180}," i.",[108,7893,506],{"class":4286},[108,7895,181],{"class":180},[108,7897,7898],{"class":143},"'consume'",[108,7900,514],{"class":180},[108,7902,7903],{"class":4280},">=",[108,7905,7906],{"class":548}," 30",[108,7908,5583],{"class":180},[108,7910,7911,7914,7916,7918,7920,7922,7925],{"class":110,"line":311},[108,7912,7913],{"class":180},"            t ",[108,7915,3700],{"class":4280},[108,7917,7891],{"class":180},[108,7919,506],{"class":4286},[108,7921,181],{"class":180},[108,7923,7924],{"class":143},"'starttime'",[108,7926,234],{"class":180},[108,7928,7929],{"class":110,"line":345},[108,7930,7931],{"class":114},"            break\n",[108,7933,7934,7937,7939,7942,7945],{"class":110,"line":369},[108,7935,7936],{"class":180},"    last_water_time ",[108,7938,3700],{"class":4280},[108,7940,7941],{"class":180}," datetime.datetime.",[108,7943,7944],{"class":4286},"fromtimestamp",[108,7946,7947],{"class":180},"(t)\n",[108,7949,7950,7953,7955,7957,7960],{"class":110,"line":389},[108,7951,7952],{"class":180},"    now ",[108,7954,3700],{"class":4280},[108,7956,7941],{"class":180},[108,7958,7959],{"class":4286},"now",[108,7961,594],{"class":180},[108,7963,7964,7967,7969,7972,7975],{"class":110,"line":398},[108,7965,7966],{"class":180},"    time_delta ",[108,7968,3700],{"class":4280},[108,7970,7971],{"class":180}," now ",[108,7973,7974],{"class":4280},"-",[108,7976,7977],{"class":180}," last_water_time\n",[108,7979,7980,7983,7985,7988,7991],{"class":110,"line":422},[108,7981,7982],{"class":180},"    sec ",[108,7984,3700],{"class":4280},[108,7986,7987],{"class":180}," time_delta.",[108,7989,7990],{"class":4286},"total_seconds",[108,7992,594],{"class":180},[108,7994,7995,7998,8000,8003,8005],{"class":110,"line":428},[108,7996,7997],{"class":180},"    hours ",[108,7999,3700],{"class":4280},[108,8001,8002],{"class":180}," sec ",[108,8004,1021],{"class":4280},[108,8006,8007],{"class":548}," 3600\n",[108,8009,8010,8013,8015,8018,8021,8023,8026,8029,8032],{"class":110,"line":597},[108,8011,8012],{"class":180},"    lwt_str ",[108,8014,3700],{"class":4280},[108,8016,8017],{"class":180}," last_water_time.",[108,8019,8020],{"class":4286},"strftime",[108,8022,181],{"class":180},[108,8024,8025],{"class":143},"'%m月",[108,8027,8028],{"class":548},"%d",[108,8030,8031],{"class":143},"日%H点'",[108,8033,234],{"class":180},[108,8035,8036,8038,8041,8044,8047,8050,8052,8055,8057,8060,8063,8065],{"class":110,"line":603},[108,8037,526],{"class":114},[108,8039,8040],{"class":114}," f",[108,8042,8043],{"class":143},"\"上次烧水时间为「",[108,8045,8046],{"class":548},"{",[108,8048,8049],{"class":180},"lwt_str",[108,8051,2950],{"class":548},[108,8053,8054],{"class":143},"」，距离现在「",[108,8056,8046],{"class":548},[108,8058,8059],{"class":180},"hours",[108,8061,8062],{"class":114},":.2f",[108,8064,2950],{"class":548},[108,8066,8067],{"class":143},"」小时\"\n",[21,8069,8070],{},"至于每小时下载的任务，我这里是使用 crontab + curl 命令实现的，用 python 写个死循环跑也可以。",[21,8072,8073],{},"那么数据都取到了，剩下的就是人机交互的部分，这部分夸张点的可以写 web，写小程序，甚至写个安卓应用挂个桌面插件，想怎么做都可以。我这里就单纯将数据接入 qqbot 扔到了宿舍群，简单写了个关键词触发。",[21,8075,8076],{},[1382,8077],{"alt":8078,"src":8079},"宿舍群","https://static.031130.xyz/uploads/2024/09/24/1a0637d61471f.webp",[1394,8081,8082],{},"html pre.shiki code .sAdtL, html code.shiki .sAdtL{--shiki-default:#4078F2;--shiki-dark:#61AFEF}html pre.shiki code .sDhpE, html code.shiki .sDhpE{--shiki-default:#50A14F;--shiki-dark:#98C379}html .default .shiki span {color: var(--shiki-default);background: var(--shiki-default-bg);font-style: var(--shiki-default-font-style);font-weight: var(--shiki-default-font-weight);text-decoration: var(--shiki-default-text-decoration);}html .shiki span {color: var(--shiki-default);background: var(--shiki-default-bg);font-style: var(--shiki-default-font-style);font-weight: var(--shiki-default-font-weight);text-decoration: var(--shiki-default-text-decoration);}html .dark .shiki span {color: var(--shiki-dark);background: var(--shiki-dark-bg);font-style: var(--shiki-dark-font-style);font-weight: var(--shiki-dark-font-weight);text-decoration: var(--shiki-dark-text-decoration);}html.dark .shiki span {color: var(--shiki-dark);background: var(--shiki-dark-bg);font-style: var(--shiki-dark-font-style);font-weight: var(--shiki-dark-font-weight);text-decoration: var(--shiki-dark-text-decoration);}html pre.shiki code .s5ixo, html code.shiki .s5ixo{--shiki-default:#383A42;--shiki-dark:#ABB2BF}html pre.shiki code .sJa8x, html code.shiki .sJa8x{--shiki-default:#E45649;--shiki-dark:#E06C75}html pre.shiki code .sAGMh, html code.shiki .sAGMh{--shiki-default:#986801;--shiki-dark:#D19A66}html pre.shiki code .sUNH4, html code.shiki .sUNH4{--shiki-default:white;--shiki-dark:#FFFFFF}html pre.shiki code .sLKXg, html code.shiki .sLKXg{--shiki-default:#A626A4;--shiki-dark:#C678DD}html pre.shiki code .s_Sar, html code.shiki .s_Sar{--shiki-default:#0184BC;--shiki-dark:#56B6C2}html pre.shiki code .sknuh, html code.shiki .sknuh{--shiki-default:#383A42;--shiki-dark:#56B6C2}html pre.shiki code .slOjB, html code.shiki .slOjB{--shiki-default:#383A42;--shiki-dark:#61AFEF}",{"title":104,"searchDepth":133,"depth":133,"links":8084},[],{"title":8086,"date":8087,"path":8088,"tags":8089,"body":8095},"使用 Caddy 反向代理 dockerhub 需要几步？","2024-09-21 01:29:17","/2024/09/21/how-to-reverse-proxy-dockerhub-with-caddy",[8090,8091,8092,8093,4550,8094],"Caddy","Docker","mitmproxy","Network","Mirror Site",{"type":14,"value":8096,"toc":8374},[8097,8100,8103,8106,8109,8117,8120,8129,8173,8176,8191,8197,8215,8218,8224,8227,8233,8237,8243,8248,8253,8259,8264,8267,8273,8276,8282,8285,8289,8299,8314,8317,8331,8334,8336,8343,8349,8352,8355,8357,8364,8371],[21,8098,8099],{},"几个月前，由于众所周知的原因，中国大陆境内失去了所有公共的 dockerhub 镜像（或者说是反代）。网上随即涌现了一批自建 dockerhub 反代的，有用 Cloudflare Workers 的，也有用 nginx 的，甚至还有自建 registry 的。",[21,8101,8102],{},"我使用 caddy 去反代 dockerhub 的原因很简单，一是配置简单，二是通过一台国内访问质量良好的境外服务器进行反向代理的访问质量会比 Cloudflare 减速器好很多。",[21,8104,8105],{},"在网上一阵搜索后，并没有发现任何使用 caddy 去反向代理 dockerhub 的文章， 于是本文应运而生。",[17,8107,8108],{"id":8108},"遇事不决先抓包",[21,8110,8111,8112,8116],{},"为了弄清楚 docker 从 dockerhub 拉取镜像的过程，需要先对网络请求进行抓包。具体的抓包方案我使用的是 mitmproxy，手动信任 ssl 证书的操作在「",[25,8113,8115],{"href":8114},"/2024/02/29/capture-https-traffic-on-linux-with-mitmproxy/","在 Linux 下使用 mitmproxy 抓取 HTTPS 流量","」这篇文章中已经讲过了，只需要配置 dockerd 使用本机的 8080 端口进行代理即可。",[21,8118,8119],{},"docker pull 时，是调用 dockerd 进行镜像拉取，而 dockerd 在绝大多数发行版上都是由 systemd 进程直接启用了，在 shell 中直接设置环境变量的方式并不能进行代理，而透明代理的方案会引入大量无关请求，增加流量分析的难度。",[21,8121,8122,8123,8128],{},"比较好的方案是直接在 systemd 服务这一层设置好代理的环境变量，我这里参考的是「",[25,8124,8127],{"href":8125,"rel":8126},"https://yeasy.gitbook.io/docker_practice/advanced_network/http_https_proxy",[41],"配置 HTTP/HTTPS 网络代理 | Docker — 从入门到实践","」这篇文章。",[99,8130,8132],{"className":1533,"code":8131,"language":1535,"meta":104,"style":104},"$ cat /etc/systemd/system/docker.service.d/http-proxy.conf\n\n[Service]\nEnvironment=\"HTTP_PROXY=http://127.0.0.1:8080\"\nEnvironment=\"HTTPS_PROXY=http://127.0.0.1:8080\"\n",[94,8133,8134,8145,8149,8154,8164],{"__ignoreMap":104},[108,8135,8136,8139,8142],{"class":110,"line":111},[108,8137,8138],{"class":176},"$",[108,8140,8141],{"class":143}," cat",[108,8143,8144],{"class":143}," /etc/systemd/system/docker.service.d/http-proxy.conf\n",[108,8146,8147],{"class":110,"line":133},[108,8148,562],{"emptyLinePlaceholder":561},[108,8150,8151],{"class":110,"line":147},[108,8152,8153],{"class":180},"[Service]\n",[108,8155,8156,8159,8161],{"class":110,"line":260},[108,8157,8158],{"class":230},"Environment",[108,8160,3700],{"class":4280},[108,8162,8163],{"class":143},"\"HTTP_PROXY=http://127.0.0.1:8080\"\n",[108,8165,8166,8168,8170],{"class":110,"line":284},[108,8167,8158],{"class":230},[108,8169,3700],{"class":4280},[108,8171,8172],{"class":143},"\"HTTPS_PROXY=http://127.0.0.1:8080\"\n",[21,8174,8175],{},"重启完 systemd 服务，万事俱备，我拉取了一个较小的 docker 镜像，顺利得到了预期的结果。",[99,8177,8179],{"className":1533,"code":8178,"language":1535,"meta":104,"style":104},"docker pull svenstaro/miniserve:latest\n",[94,8180,8181],{"__ignoreMap":104},[108,8182,8183,8185,8188],{"class":110,"line":111},[108,8184,4886],{"class":176},[108,8186,8187],{"class":143}," pull",[108,8189,8190],{"class":143}," svenstaro/miniserve:latest\n",[21,8192,8193],{},[1382,8194],{"alt":8195,"src":8196},"抓包结果","https://static.031130.xyz/uploads/2024/09/21/acbee0959be78.webp",[21,8198,8199,8200,8203,8204,8207,8208,8210,8211,8214],{},"docker 先请求了 ",[94,8201,8202],{},"registry-1.docker.io"," 得到了 401 的 http 状态码后转去访问了 ",[94,8205,8206],{},"auth.docker.io","，得到了 Authorization 字段以后重新请求 ",[94,8209,8202],{},"，获取源数据后被 307 转发到了 ",[94,8212,8213],{},"production.cloudflare.docker.com"," 上。",[21,8216,8217],{},"其中，第一个 401 响应的响应头中，用 WWW-Authenticate 字段标注了 auth 鉴权的域",[21,8219,8220],{},[1382,8221],{"alt":8222,"src":8223},"WWW-Authenticate","https://static.031130.xyz/uploads/2024/09/21/e905c55e76a25.webp",[21,8225,8226],{},"而 307 响应的响应头中，使用 Location 字段标注了被转发到的 url",[21,8228,8229],{},[1382,8230],{"alt":8231,"src":8232},"Location","https://static.031130.xyz/uploads/2024/09/21/6a2e0bf6a8284.webp",[17,8234,8236],{"id":8235},"三个域名都需要反向代理嘛","三个域名都需要反向代理嘛？",[21,8238,8239,8240,8242],{},"首先，作为我们提供反代服务的入口，",[94,8241,8202],{}," 一定是需要代理的，否则就无法提供反代后的服务。",[21,8244,8245,8247],{},[94,8246,8206],{}," 只出现了一次，需要反代嘛？根据它在境内的访问质量，恐怕是需要反代的。",[21,8249,8250],{},[1382,8251],{"alt":8206,"src":8252},"https://static.031130.xyz/uploads/2024/09/21/4a70c8cac6a4c.webp",[21,8254,8255,8256,8258],{},"最后就是 ",[94,8257,8213],{}," ，这也是我们最终下载镜像文件的地方，99% 以上的流量都是打到这里去的，而 cloudflare 在境内的访问质量是知名的减速器，完全不可以信赖。",[21,8260,8261],{},[31,8262,8263],{},"因此，三个域名都需要反代。",[17,8265,8266],{"id":8266},"如何反代",[21,8268,8269,8270,8272],{},"分三个域名各自代理，在 ",[94,8271,8202],{}," 那一块进行特殊处理，将响应头中的 WWW-Authenticate 和 location 字段进行关键词替换，将原域名替换为反代域名。",[21,8274,8275],{},"最后的成果大概就是这个样子:",[99,8277,8280],{"className":8278,"code":8279,"language":825},[5406],"dockerhub.example.com {\n    reverse_proxy https://registry-1.docker.io {\n        header_up Host {http.reverse_proxy.upstream.hostport}\n        header_down WWW-Authenticate \"https://auth.docker.io\" \"https://auth.dockerhub.example.com\"\n        header_down Location \"https://production.cloudflare.docker.com\" \"https://production.dockerhub.example.com\"\n    }\n}\n\nauth.dockerhub.example.com {\n    reverse_proxy https://auth.docker.io {\n        header_up Host {http.reverse_proxy.upstream.hostport}\n    }\n}\n\nproduction.dockerhub.example.com {\n    reverse_proxy https://production.cloudflare.docker.com {\n        header_up Host {http.reverse_proxy.upstream.hostport}\n    }\n}\n",[94,8281,8279],{"__ignoreMap":104},[21,8283,8284],{},"PS: 推荐后两个域名使用 CNAME 解析到第一个域名，这样后面更改解析的时候更方便一些。",[17,8286,8288],{"id":8287},"如何设置-docker-使用反代","如何设置 docker 使用反代",[21,8290,8291,8292,1999,8295,8298],{},"可以直接在 ",[94,8293,8294],{},"docker pull",[94,8296,8297],{},"docker run"," 的命令前加上域名，比如原本的",[99,8300,8302],{"className":1533,"code":8301,"language":1535,"meta":104,"style":104},"docker run hello-world\n",[94,8303,8304],{"__ignoreMap":104},[108,8305,8306,8308,8311],{"class":110,"line":111},[108,8307,4886],{"class":176},[108,8309,8310],{"class":143}," run",[108,8312,8313],{"class":143}," hello-world\n",[21,8315,8316],{},"改成",[99,8318,8320],{"className":1533,"code":8319,"language":1535,"meta":104,"style":104},"docker run dockerhub.example.com/library/hello-world\n",[94,8321,8322],{"__ignoreMap":104},[108,8323,8324,8326,8328],{"class":110,"line":111},[108,8325,4886],{"class":176},[108,8327,8310],{"class":143},[108,8329,8330],{"class":143}," dockerhub.example.com/library/hello-world\n",[21,8332,8333],{},"（如果原本的镜像由 dockerhub 官方提供，没有用户名，路径需要加上 “library”）",[75,8335],{},[21,8337,8338,8339,8342],{},"也可以选择以前的方案，创建或修改 ",[94,8340,8341],{},"/etc/docker/daemon.json","：",[99,8344,8347],{"className":8345,"code":8346,"language":825},[5406],"sudo mkdir -p /etc/docker\nsudo tee /etc/docker/daemon.json \u003C\u003C-'EOF'\n{\n    \"registry-mirrors\": [\n        \"https://dockerhub.example.com\"\n    ]\n}\nEOF\nsudo systemctl daemon-reload\nsudo systemctl restart docker\n",[94,8348,8346],{"__ignoreMap":104},[17,8350,8351],{"id":8351},"验证",[21,8353,8354],{},"一般来说，能够在中国大陆境内的网络质量下较快地下拉镜像本身就代表反代成功了，但保险起见可以像本文的第一部分一样抓个包，看看是不是都走了自己的域名了。",[17,8356,1808],{"id":1808},[21,8358,8359],{},[25,8360,8363],{"href":8361,"rel":8362},"https://gist.github.com/y0ngb1n/7e8f16af3242c7815e7ca2f0833d3ea6",[41],"国内的 Docker Hub 镜像加速器，由国内教育机构与各大云服务商提供的镜像加速服务",[21,8365,8366],{},[25,8367,8370],{"href":8368,"rel":8369},"https://blog.hentioe.dev/posts/unhindered-accesss-dockerhub.html",[41],"无障碍访问 Docker Hub 的各种方法（自建 registry、Cloudflare 加速、Nginx 反代、代理 Docker 网络） | 绅士喵",[1394,8372,8373],{},"html pre.shiki code .sAdtL, html code.shiki .sAdtL{--shiki-default:#4078F2;--shiki-dark:#61AFEF}html pre.shiki code .sDhpE, html code.shiki .sDhpE{--shiki-default:#50A14F;--shiki-dark:#98C379}html pre.shiki code .s5ixo, html code.shiki .s5ixo{--shiki-default:#383A42;--shiki-dark:#ABB2BF}html pre.shiki code .sJa8x, html code.shiki .sJa8x{--shiki-default:#E45649;--shiki-dark:#E06C75}html pre.shiki code .sknuh, html code.shiki .sknuh{--shiki-default:#383A42;--shiki-dark:#56B6C2}html .default .shiki span {color: var(--shiki-default);background: var(--shiki-default-bg);font-style: var(--shiki-default-font-style);font-weight: var(--shiki-default-font-weight);text-decoration: var(--shiki-default-text-decoration);}html .shiki span {color: var(--shiki-default);background: var(--shiki-default-bg);font-style: var(--shiki-default-font-style);font-weight: var(--shiki-default-font-weight);text-decoration: var(--shiki-default-text-decoration);}html .dark .shiki span {color: var(--shiki-dark);background: var(--shiki-dark-bg);font-style: var(--shiki-dark-font-style);font-weight: var(--shiki-dark-font-weight);text-decoration: var(--shiki-dark-text-decoration);}html.dark .shiki span {color: var(--shiki-dark);background: var(--shiki-dark-bg);font-style: var(--shiki-dark-font-style);font-weight: var(--shiki-dark-font-weight);text-decoration: var(--shiki-dark-text-decoration);}",{"title":104,"searchDepth":133,"depth":133,"links":8375},[8376,8377,8378,8379,8380,8381],{"id":8108,"depth":133,"text":8108},{"id":8235,"depth":133,"text":8236},{"id":8266,"depth":133,"text":8266},{"id":8287,"depth":133,"text":8288},{"id":8351,"depth":133,"text":8351},{"id":1808,"depth":133,"text":1808},132,1766526708405]