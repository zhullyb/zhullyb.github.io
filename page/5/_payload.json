[{"data":1,"prerenderedAt":3442},["ShallowReactive",2],{"randomIndex/page/5/":3,"index-page-5-zh":4,"posts-total-zh":3441},10,[5,396,744,1399,1699,1928,2195,2463,2665,3011],{"title":6,"date":7,"path":8,"tags":9,"body":14},"以 Archlinux 中 makepkg 的方式打开 rpmbuild","2024-05-03 22:48:39","/2024/05/03/open-rpmbuild-in-the-way-of-archlinux-makepkg",[10,11,12,13],"Archlinux","Fedora","RPM Package","Linux",{"type":15,"value":16,"toc":389},"minimark",[17,21,29,110,127,135,175,182,186,189,192,206,209,224,232,235,238,241,249,252,255,258,284,291,311,318,324,331,334,341,359,362,365,372,379,382,385],[18,19,20],"p",{},"在 Redhat 系的发行版上打包软件的时候，会发现与 Archlinux 完全不同的思路。",[18,22,23,24,28],{},"Fedora 所代表的 Redhat 阵营一看就是那种宏大叙事的大型发行版，rpmbuild 在默认情况下会在 $HOME/rpmbuild 下的一系列文件夹进行构建过程。使用 ",[25,26,27],"code",{},"rpmdev-setuptree"," 命令会创建好下面这些目录进行构建。",[30,31,36],"pre",{"className":32,"code":33,"language":34,"meta":35,"style":35},"language-bash shiki shiki-themes one-light one-dark-pro","$ tree rpmbuild\nrpmbuild\n├── BUILD\n├── BUILDROOT\n├── RPMS\n├── SOURCES\n├── SPECS\n└── SRPMS\n","bash","",[25,37,38,54,60,69,77,85,93,101],{"__ignoreMap":35},[39,40,43,47,51],"span",{"class":41,"line":42},"line",1,[39,44,46],{"class":45},"sAdtL","$",[39,48,50],{"class":49},"sDhpE"," tree",[39,52,53],{"class":49}," rpmbuild\n",[39,55,57],{"class":41,"line":56},2,[39,58,59],{"class":45},"rpmbuild\n",[39,61,63,66],{"class":41,"line":62},3,[39,64,65],{"class":45},"├──",[39,67,68],{"class":49}," BUILD\n",[39,70,72,74],{"class":41,"line":71},4,[39,73,65],{"class":45},[39,75,76],{"class":49}," BUILDROOT\n",[39,78,80,82],{"class":41,"line":79},5,[39,81,65],{"class":45},[39,83,84],{"class":49}," RPMS\n",[39,86,88,90],{"class":41,"line":87},6,[39,89,65],{"class":45},[39,91,92],{"class":49}," SOURCES\n",[39,94,96,98],{"class":41,"line":95},7,[39,97,65],{"class":45},[39,99,100],{"class":49}," SPECS\n",[39,102,104,107],{"class":41,"line":103},8,[39,105,106],{"class":45},"└──",[39,108,109],{"class":49}," SRPMS\n",[18,111,112,113,120,121,126],{},"Fedora 将所有的软件的构建都集中在一个 rpmbuild 目录中，BUILD 是编译时使用的，BUILDROOT 是最终安装目录，RPMS 是存放最终产物的，SOURCES 是存放源码等文件的，SPECS 是存放指导构建过程的 spec 文件的，而 SRPMS 是 RH 系为了 reproducibility 而单独将 spec 和源文件打包的产物。除了 rpmbuild 命令以外，Fedora 还有一套使用容器构建 rpm 包的 ",[114,115,119],"a",{"href":116,"rel":117},"https://fedoraproject.org/wiki/Using_Mock_to_test_package_builds",[118],"nofollow","mock"," 构建系统，与 Archlinux 的 ",[114,122,125],{"href":123,"rel":124},"https://archlinux.org/packages/extra/any/devtools/",[118],"devtools"," 类似，这里不作过多叙述。",[18,128,129,130,134],{},"反观 Arch 的构建目录，",[131,132,133],"del",{},"就有一股浓浓的小作坊气味","。每个软件包自己拥有一个目录，指导构建过程的 PKGBUILD 文件、源文件和最终的产物都放在这个目录下，目录下的 src 和 pkg 文件夹分别对应 rpm 的 BUILD 和 BUILDROOT，前者是源文件被解压的目录和编译过程进行的目录，后者是软件最终的安装目录。",[30,136,138],{"className":32,"code":137,"language":34,"meta":35,"style":35},"$ tree repo\nrepo\n├── src\n├── pkg\n└── PKGBUILD\n",[25,139,140,149,154,161,168],{"__ignoreMap":35},[39,141,142,144,146],{"class":41,"line":42},[39,143,46],{"class":45},[39,145,50],{"class":49},[39,147,148],{"class":49}," repo\n",[39,150,151],{"class":41,"line":56},[39,152,153],{"class":45},"repo\n",[39,155,156,158],{"class":41,"line":62},[39,157,65],{"class":45},[39,159,160],{"class":49}," src\n",[39,162,163,165],{"class":41,"line":71},[39,164,65],{"class":45},[39,166,167],{"class":49}," pkg\n",[39,169,170,172],{"class":41,"line":79},[39,171,106],{"class":45},[39,173,174],{"class":49}," PKGBUILD\n",[18,176,177,178,181],{},"好巧不巧，我偏偏习惯这个小作坊气息的 arch build system，每个软件包独享一个自己的目录，",[131,179,180],{},"干净又卫生","。我自然也希望在 Fedora 下打 rpm 包的时候能够使用类似 Archlinux 下 makepkg 使用的目录结构。",[183,184,185],"h2",{"id":185},"简单了解",[18,187,188],{},"在了解一系列 rpmbuild 中宏（macros）相关的知识后，我意识到这并非不可能。",[18,190,191],{},"使用如下的命令可以获取目前系统中定义的所有宏",[30,193,195],{"className":32,"code":194,"language":34,"meta":35,"style":35},"rpm --showrc\n",[25,196,197],{"__ignoreMap":35},[39,198,199,202],{"class":41,"line":42},[39,200,201],{"class":45},"rpm",[39,203,205],{"class":204},"sAGMh"," --showrc\n",[18,207,208],{},"而可以使用如下命令检查某一个宏目前被定义成了什么值",[30,210,212],{"className":32,"code":211,"language":34,"meta":35,"style":35},"rpm --eval \"%{_topdir}\"\n",[25,213,214],{"__ignoreMap":35},[39,215,216,218,221],{"class":41,"line":42},[39,217,201],{"class":45},[39,219,220],{"class":204}," --eval",[39,222,223],{"class":49}," \"%{_topdir}\"\n",[18,225,226,227,231],{},"更多关于宏的描述可以在 ",[114,228,229],{"href":229,"rel":230},"https://rpm-software-management.github.io/rpm/manual/macros.html",[118]," 获取",[183,233,234],{"id":234},"修改路径",[18,236,237],{},"我们可以把定义成 $HOME/rpmbuild 的 %_topdir 重新定义成当前目录。",[18,239,240],{},"在 $HOME/.rpmmacros 中，去除顶部对 %_topdir 的定义，重新填上以下这些定义，即可初步完成我想要的效果。",[30,242,247],{"className":243,"code":245,"language":246},[244],"language-text","%_topdir    %(pwd)\n%_builddir %{_topdir}/src\n%_buildrootdir %{_topdir}/pkg\n%_rpmdir %{_topdir}\n%_sourcedir %{_topdir}\n%_specdir %{_topdir}\n%_srcrpmdir %{_topdir}\n","text",[25,248,245],{"__ignoreMap":35},[18,250,251],{},"现在在任何一个目录下执行 rpmbuild 相关命令，都会把 src 认为是构建目录，pkg 是最后安装目录，spec 文件和源文件早当前文件夹下，构建产物在当前文件夹下的 x86_64（或者别的架构名，这一层目录我还没有找到应该如何去掉）下。",[183,253,254],{"id":254},"自动安装依赖文件",[18,256,257],{},"Fedora 中的 rpmbuild 不带有 makepkg -s 的功能，不能自动安装依赖。不过这也不意味着需要自己傻傻地去翻 spec 看看需要哪些构建依赖。可以使用 dnf 的 builddep 命令实现",[30,259,261],{"className":32,"code":260,"language":34,"meta":35,"style":35},"sudo dnf builddep ./*.spec\n",[25,262,263],{"__ignoreMap":35},[39,264,265,268,271,274,277,281],{"class":41,"line":42},[39,266,267],{"class":45},"sudo",[39,269,270],{"class":49}," dnf",[39,272,273],{"class":49}," builddep",[39,275,276],{"class":49}," ./",[39,278,280],{"class":279},"s2QsP","*",[39,282,283],{"class":49},".spec\n",[18,285,286,287,290],{},"不过 dnf 没有什么完成构建后自动卸载依赖的选项。",[131,288,289],{},"这些依赖装完以后就一辈子赖在你的电脑上了","，才不是，可以在构建完成后使用 dnf 自带的后悔药功能撤销上一条命令执行的效果。",[30,292,294],{"className":32,"code":293,"language":34,"meta":35,"style":35},"sudo dnf history undo 0\n",[25,295,296],{"__ignoreMap":35},[39,297,298,300,302,305,308],{"class":41,"line":42},[39,299,267],{"class":45},[39,301,270],{"class":49},[39,303,304],{"class":49}," history",[39,306,307],{"class":49}," undo",[39,309,310],{"class":204}," 0\n",[18,312,313,314,317],{},"不过如果在 builddep 过程中，dnf 从 updates 源里更新了一些软件，那么它在 undo 时可能就没法获取更新前的软件版本。会有 ",[25,315,316],{},"Cannot find rpm nevra","  的提示",[18,319,320],{},[321,322],"img",{"alt":35,"src":323},"https://static.031130.xyz/uploads/2024/08/12/6635018238ffa.webp",[18,325,326,327,330],{},"可以使用 ",[25,328,329],{},"--skip-broken"," 命令跳过那些没法找到老版本的软件，继续卸载其余的软件。",[183,332,333],{"id":333},"自动下载源文件",[18,335,336,337,340],{},"很多使用 spec 中会在 source 里写上下载地址，而不是附上源码文件。rpm 似乎因为一些原因禁止了 rpmbuild 自动下载源文件的功能。可以通过在使用 rpmbuild 的时候带上 ",[25,338,339],{},"--undefine=_disable_source_fetch"," 取消定义这个行为，或者干脆在调用 rpmbuild 之前执行一遍",[30,342,344],{"className":32,"code":343,"language":34,"meta":35,"style":35},"spectool -gR *.spec\n",[25,345,346],{"__ignoreMap":35},[39,347,348,351,354,357],{"class":41,"line":42},[39,349,350],{"class":45},"spectool",[39,352,353],{"class":204}," -gR",[39,355,356],{"class":279}," *",[39,358,283],{"class":49},[18,360,361],{},"这样也能自动下载源文件。",[183,363,364],{"id":364},"构建行为",[18,366,367,368,371],{},"makepkg 的默认构建行为就是只构建最终的安装包，Archlinux 中并没有 Fedora 那样打 source rpm 保证 reproduceability 的行为，这在 rpmbuild 中对应的是 ",[25,369,370],{},"-bb"," 选项。",[18,373,374,375,378],{},"使用 ",[25,376,377],{},"rpmbuild -bb *.spec"," 即可",[380,381],"hr",{},[18,383,384],{},"上面介绍完了 rpmbuild 和 makepkg 的主要差异，应该可以自己搓一个 rpmbuild-wrapper 去实现以 makepkg 的方式打开 rpmbuild 的目标了，具体的 wrapper 脚本我就不放出来献丑了。",[386,387,388],"style",{},"html pre.shiki code .sAdtL, html code.shiki .sAdtL{--shiki-default:#4078F2;--shiki-dark:#61AFEF}html pre.shiki code .sDhpE, html code.shiki .sDhpE{--shiki-default:#50A14F;--shiki-dark:#98C379}html .default .shiki span {color: var(--shiki-default);background: var(--shiki-default-bg);font-style: var(--shiki-default-font-style);font-weight: var(--shiki-default-font-weight);text-decoration: var(--shiki-default-text-decoration);}html .shiki span {color: var(--shiki-default);background: var(--shiki-default-bg);font-style: var(--shiki-default-font-style);font-weight: var(--shiki-default-font-weight);text-decoration: var(--shiki-default-text-decoration);}html .dark .shiki span {color: var(--shiki-dark);background: var(--shiki-dark-bg);font-style: var(--shiki-dark-font-style);font-weight: var(--shiki-dark-font-weight);text-decoration: var(--shiki-dark-text-decoration);}html.dark .shiki span {color: var(--shiki-dark);background: var(--shiki-dark-bg);font-style: var(--shiki-dark-font-style);font-weight: var(--shiki-dark-font-weight);text-decoration: var(--shiki-dark-text-decoration);}html pre.shiki code .sAGMh, html code.shiki .sAGMh{--shiki-default:#986801;--shiki-dark:#D19A66}html pre.shiki code .s2QsP, html code.shiki .s2QsP{--shiki-default:#E45649;--shiki-dark:#E5C07B}",{"title":35,"searchDepth":56,"depth":56,"links":390},[391,392,393,394,395],{"id":185,"depth":56,"text":185},{"id":234,"depth":56,"text":234},{"id":254,"depth":56,"text":254},{"id":333,"depth":56,"text":333},{"id":364,"depth":56,"text":364},{"title":397,"date":398,"path":399,"tags":400,"body":402},"使用 Github Action 更新用于 rpm 打包的 spec 文件","2024-04-29 19:19:54","/2024/04/29/update-a-rpm-spec-by-github-action",[11,12,401],"Github Action",{"type":15,"value":403,"toc":742},[404,411,420,423,425,428,479,482,519,522,556,559,631,634,691,694,731,739],[18,405,406,407,410],{},"有一些软件包的上游本身就是使用 Github Action 发版的，每次 commit 都会触发 Github Action 去构建并分发新版本，使用构建时的时间日期作为版本号。针对这种包，手动更新费时费力，而规范的 specfile 应当是更新 ",[25,408,409],{},"%changelog"," 的，因此应当是使用 rpmdev-bumpspec 命令。只不过 rpmdev-bumpspec 需要在 rpm 系发行版或者装有 rpm 系列依赖包的发行版下执行，这不是随随便便一个 Linux 环境就能运行的。",[18,412,413,414,419],{},"我找到了 ",[114,415,418],{"href":416,"rel":417},"https://github.com/netoarmando/rpmdev-bumpspec-action",[118],"netoarmando/rpmdev-bumpspec-action"," 这个 Github Action，它通过启动一个 Fedora 的 docker 实现了使用 rpmdev-bumpspec 的效果。虽然 release 中只有一个 2021 年构建的 v1 版本，~~但 Fedora 的版本高低不影响 rpmdev-bumpspec 的效果。~~但每次 Github Action 执行时都会使用 fedora:latest 的 docker 重新构建一遍，不用担心 fedora 版本过低。",[18,421,422],{},"于是我们便解决了最核心的问题——处理 spec 文件。接下来只要补充好头尾的步骤即可。",[380,424],{},[18,426,427],{},"首先使用 actions/checkout 释出仓库内的文件",[30,429,433],{"className":430,"code":431,"language":432,"meta":35,"style":35},"language-yaml shiki shiki-themes one-light one-dark-pro","- name: Checkout\n  uses: actions/checkout@v2\n  with:\n    fetch-depth: 0\n","yaml",[25,434,435,451,461,469],{"__ignoreMap":35},[39,436,437,441,445,448],{"class":41,"line":42},[39,438,440],{"class":439},"s5ixo","- ",[39,442,444],{"class":443},"sJa8x","name",[39,446,447],{"class":439},": ",[39,449,450],{"class":49},"Checkout\n",[39,452,453,456,458],{"class":41,"line":56},[39,454,455],{"class":443},"  uses",[39,457,447],{"class":439},[39,459,460],{"class":49},"actions/checkout@v2\n",[39,462,463,466],{"class":41,"line":62},[39,464,465],{"class":443},"  with",[39,467,468],{"class":439},":\n",[39,470,471,474,476],{"class":41,"line":71},[39,472,473],{"class":443},"    fetch-depth",[39,475,447],{"class":439},[39,477,478],{"class":204},"0\n",[18,480,481],{},"通过 shell 命令获取仓库内 spec 文件的版本号，存入 $GITHUB_ENV",[30,483,485],{"className":430,"code":484,"language":432,"meta":35,"style":35},"- name: Get Current Version\n  run: |\n    CURRENT_VERSION=`grep -E '^Version:' *.spec | awk '{print $2}'`\n    echo \"CURRENT_VERSION=$CURRENT_VERSION\" >> $GITHUB_ENV\n",[25,486,487,498,509,514],{"__ignoreMap":35},[39,488,489,491,493,495],{"class":41,"line":42},[39,490,440],{"class":439},[39,492,444],{"class":443},[39,494,447],{"class":439},[39,496,497],{"class":49},"Get Current Version\n",[39,499,500,503,505],{"class":41,"line":56},[39,501,502],{"class":443},"  run",[39,504,447],{"class":439},[39,506,508],{"class":507},"sLKXg","|\n",[39,510,511],{"class":41,"line":62},[39,512,513],{"class":49},"    CURRENT_VERSION=`grep -E '^Version:' *.spec | awk '{print $2}'`\n",[39,515,516],{"class":41,"line":71},[39,517,518],{"class":49},"    echo \"CURRENT_VERSION=$CURRENT_VERSION\" >> $GITHUB_ENV\n",[18,520,521],{},"通过 Github API 获取目标软件的最新版本号，存入 $GITHUB_ENV",[30,523,525],{"className":430,"code":524,"language":432,"meta":35,"style":35},"- name: Export latest geoip version\n  run: |\n    NEW_VERSION=`curl -s https://api.github.com/repos/{user_name}/{repo_name}/releases/latest | jq -r '.tag_name' | sed 's/v//g'`\n    echo \"NEW_VERSION=$NEW_VERSION\" >> $GITHUB_ENV\n",[25,526,527,538,546,551],{"__ignoreMap":35},[39,528,529,531,533,535],{"class":41,"line":42},[39,530,440],{"class":439},[39,532,444],{"class":443},[39,534,447],{"class":439},[39,536,537],{"class":49},"Export latest geoip version\n",[39,539,540,542,544],{"class":41,"line":56},[39,541,502],{"class":443},[39,543,447],{"class":439},[39,545,508],{"class":507},[39,547,548],{"class":41,"line":62},[39,549,550],{"class":49},"    NEW_VERSION=`curl -s https://api.github.com/repos/{user_name}/{repo_name}/releases/latest | jq -r '.tag_name' | sed 's/v//g'`\n",[39,552,553],{"class":41,"line":71},[39,554,555],{"class":49},"    echo \"NEW_VERSION=$NEW_VERSION\" >> $GITHUB_ENV\n",[18,557,558],{},"当仓库内 spec 版本号与软件最新版本号不一致时，运行 rpmdev-bumpspec",[30,560,562],{"className":430,"code":561,"language":432,"meta":35,"style":35},"- name: Run rpmdev-bumpspec action\n  if: ${{ env.CURRENT_VERSION != env.NEW_VERSION }}\n  uses: netoarmando/rpmdev-bumpspec-action@v1\n  with: \n    specfile: '{filename}'\n    new: ${{ env.NEW_VERSION }}\n    userstring: \"username \u003Cusername@mail.com>\"\n",[25,563,564,575,585,594,601,611,621],{"__ignoreMap":35},[39,565,566,568,570,572],{"class":41,"line":42},[39,567,440],{"class":439},[39,569,444],{"class":443},[39,571,447],{"class":439},[39,573,574],{"class":49},"Run rpmdev-bumpspec action\n",[39,576,577,580,582],{"class":41,"line":56},[39,578,579],{"class":443},"  if",[39,581,447],{"class":439},[39,583,584],{"class":49},"${{ env.CURRENT_VERSION != env.NEW_VERSION }}\n",[39,586,587,589,591],{"class":41,"line":62},[39,588,455],{"class":443},[39,590,447],{"class":439},[39,592,593],{"class":49},"netoarmando/rpmdev-bumpspec-action@v1\n",[39,595,596,598],{"class":41,"line":71},[39,597,465],{"class":443},[39,599,600],{"class":439},": \n",[39,602,603,606,608],{"class":41,"line":79},[39,604,605],{"class":443},"    specfile",[39,607,447],{"class":439},[39,609,610],{"class":49},"'{filename}'\n",[39,612,613,616,618],{"class":41,"line":87},[39,614,615],{"class":443},"    new",[39,617,447],{"class":439},[39,619,620],{"class":49},"${{ env.NEW_VERSION }}\n",[39,622,623,626,628],{"class":41,"line":95},[39,624,625],{"class":443},"    userstring",[39,627,447],{"class":439},[39,629,630],{"class":49},"\"username \u003Cusername@mail.com>\"\n",[18,632,633],{},"当仓库内 spec 版本号与软件最新版本号不一致时，保存更改，推入仓库。",[30,635,637],{"className":430,"code":636,"language":432,"meta":35,"style":35},"- name: Commit changes\n  if: ${{ env.CURRENT_VERSION != env.NEW_VERSION }}\n  run: |\n    git config --local user.email \"zhullyb@outlook.com\"\n    git config --local user.name \"zhullyb\"\n    git add .\n    git commit -m \"upgpkg: v2ray-geoip@${{ env.NEW_VERSION }}\"\n    git push\n",[25,638,639,650,658,666,671,676,681,686],{"__ignoreMap":35},[39,640,641,643,645,647],{"class":41,"line":42},[39,642,440],{"class":439},[39,644,444],{"class":443},[39,646,447],{"class":439},[39,648,649],{"class":49},"Commit changes\n",[39,651,652,654,656],{"class":41,"line":56},[39,653,579],{"class":443},[39,655,447],{"class":439},[39,657,584],{"class":49},[39,659,660,662,664],{"class":41,"line":62},[39,661,502],{"class":443},[39,663,447],{"class":439},[39,665,508],{"class":507},[39,667,668],{"class":41,"line":71},[39,669,670],{"class":49},"    git config --local user.email \"zhullyb@outlook.com\"\n",[39,672,673],{"class":41,"line":79},[39,674,675],{"class":49},"    git config --local user.name \"zhullyb\"\n",[39,677,678],{"class":41,"line":87},[39,679,680],{"class":49},"    git add .\n",[39,682,683],{"class":41,"line":95},[39,684,685],{"class":49},"    git commit -m \"upgpkg: v2ray-geoip@${{ env.NEW_VERSION }}\"\n",[39,687,688],{"class":41,"line":103},[39,689,690],{"class":49},"    git push\n",[18,692,693],{},"（可选）当仓库内 spec 版本号与软件最新版本号不一致时，通过 curl 语句触发 copr 的 webhook，让 copr 进行构建。",[30,695,697],{"className":430,"code":696,"language":432,"meta":35,"style":35},"- name: trigger copr webhook\n  if: ${{ env.CURRENT_VERSION != env.NEW_VERSION }}\n  run: |\n    curl -X POST ${{ secrets.COPR_HOOK_URL }}v2ray-geoip/\n",[25,698,699,710,718,726],{"__ignoreMap":35},[39,700,701,703,705,707],{"class":41,"line":42},[39,702,440],{"class":439},[39,704,444],{"class":443},[39,706,447],{"class":439},[39,708,709],{"class":49},"trigger copr webhook\n",[39,711,712,714,716],{"class":41,"line":56},[39,713,579],{"class":443},[39,715,447],{"class":439},[39,717,584],{"class":49},[39,719,720,722,724],{"class":41,"line":62},[39,721,502],{"class":443},[39,723,447],{"class":439},[39,725,508],{"class":507},[39,727,728],{"class":41,"line":71},[39,729,730],{"class":49},"    curl -X POST ${{ secrets.COPR_HOOK_URL }}v2ray-geoip/\n",[18,732,733,734],{},"最终的 yml 文件可以参考",[114,735,738],{"href":736,"rel":737},"https://github.com/v2rayA/v2raya-copr/blob/master/.github/workflows/upgpkg-v2ray-geoip.yml",[118],"这里",[386,740,741],{},"html pre.shiki code .s5ixo, html code.shiki .s5ixo{--shiki-default:#383A42;--shiki-dark:#ABB2BF}html pre.shiki code .sJa8x, html code.shiki .sJa8x{--shiki-default:#E45649;--shiki-dark:#E06C75}html pre.shiki code .sDhpE, html code.shiki .sDhpE{--shiki-default:#50A14F;--shiki-dark:#98C379}html pre.shiki code .sAGMh, html code.shiki .sAGMh{--shiki-default:#986801;--shiki-dark:#D19A66}html .default .shiki span {color: var(--shiki-default);background: var(--shiki-default-bg);font-style: var(--shiki-default-font-style);font-weight: var(--shiki-default-font-weight);text-decoration: var(--shiki-default-text-decoration);}html .shiki span {color: var(--shiki-default);background: var(--shiki-default-bg);font-style: var(--shiki-default-font-style);font-weight: var(--shiki-default-font-weight);text-decoration: var(--shiki-default-text-decoration);}html .dark .shiki span {color: var(--shiki-dark);background: var(--shiki-dark-bg);font-style: var(--shiki-dark-font-style);font-weight: var(--shiki-dark-font-weight);text-decoration: var(--shiki-dark-text-decoration);}html.dark .shiki span {color: var(--shiki-dark);background: var(--shiki-dark-bg);font-style: var(--shiki-dark-font-style);font-weight: var(--shiki-dark-font-weight);text-decoration: var(--shiki-dark-text-decoration);}html pre.shiki code .sLKXg, html code.shiki .sLKXg{--shiki-default:#A626A4;--shiki-dark:#C678DD}",{"title":35,"searchDepth":56,"depth":56,"links":743},[],{"title":745,"date":746,"path":747,"tags":748,"body":750},"使用 Python 生成甘特图(Gantt Chart)","2024-04-24 12:02:58","/2024/04/24/generate-gantt-chart-with-python",[749],"Python",{"type":15,"value":751,"toc":1397},[752,755,758,764,773,776,781,784,787,789,1181,1186,1188,1389,1394],[18,753,754],{},"在写操作系统的作业的时候有几道题给出了几个进程的相关信息，要求我们画出几种简单调度的甘特图。操作系统的作业一直是电子版，上传 pdf 即可的。我觉得手画甘特图拍照嵌入 pdf 中不太优雅，过于掉价，因此就想直接生成甘特图嵌入。",[18,756,757],{},"在谷歌搜寻了一番，我发现现在的甘特图生成网站都太现代化了，根本不是操作系统课上教的样子了。",[18,759,760],{},[321,761],{"alt":762,"src":763},"现代化的甘特图","https://static.031130.xyz/uploads/2024/08/12/662888bd5a0af.webp",[18,765,766,767,772],{},"所幸我找到了 ",[114,768,771],{"href":769,"rel":770},"https://github.com/gao-keyong/matplotlib-gantt/",[118],"gao-keyong/matplotlib-gantt","，虽然只有两个 star（没事，加上我就 3 stars 了），但确实能用，README 中的样例也是我期望的样子。",[18,774,775],{},"项目中自带了一个 jupyter 的示例，算得上是非常简单易上手的了，依赖方面只要装好 matplotlib 就可以使用，不存在依赖地狱。尽管是三年前的项目，在我本机的 Python 3.11 上仍然能够正常运行。",[18,777,778],{},[321,779],{"alt":35,"src":780},"https://static.031130.xyz/uploads/2024/08/12/66288ba6414d4.webp",[18,782,783],{},"tuple 中的第一个数字表示从当前时间开始，第二个数字表示持续时间。每一个表示 category 的 list 中可以存在多个 tuple。",[18,785,786],{},"给一些咱生成的例子。",[380,788],{},[30,790,794],{"className":791,"code":792,"language":793,"meta":35,"style":35},"language-python shiki shiki-themes one-light one-dark-pro","from gantt import *\ncategory_names = ['P1', 'P2', 'P3', 'P4', 'P5']\n\nresults = {\n    'FCFS': [[(0,2)], [(2,1)], [(3,8)], [(11,4)], [(15,5)]],\n    'SJF': [[(1,2)], [(0,1)], [(12,8)], [(3,4)], [(7,5)]],\n    'non-compreemptive priority': [[(13,2)],[(19,1)],[(0,8)],[(15,4)],[(8,5)]],\n    'RR (quantum=2)': [[(0,2)], [(2,1)],[(3,2),(9,2),(15,2),(18,2)], [(5,2),(11,2)], [(7,2),(13,2),(17,1)]]\n}\n\narrival_t = [0, 0, 0, 0]\n\ngantt(category_names, results, arrival_t).show()\n\n","python",[25,795,796,811,849,855,865,925,974,1024,1124,1130,1134,1160,1165],{"__ignoreMap":35},[39,797,798,801,804,807],{"class":41,"line":42},[39,799,800],{"class":507},"from",[39,802,803],{"class":439}," gantt ",[39,805,806],{"class":507},"import",[39,808,810],{"class":809},"sknuh"," *\n",[39,812,813,816,819,822,825,828,831,833,836,838,841,843,846],{"class":41,"line":56},[39,814,815],{"class":439},"category_names ",[39,817,818],{"class":809},"=",[39,820,821],{"class":439}," [",[39,823,824],{"class":49},"'P1'",[39,826,827],{"class":439},", ",[39,829,830],{"class":49},"'P2'",[39,832,827],{"class":439},[39,834,835],{"class":49},"'P3'",[39,837,827],{"class":439},[39,839,840],{"class":49},"'P4'",[39,842,827],{"class":439},[39,844,845],{"class":49},"'P5'",[39,847,848],{"class":439},"]\n",[39,850,851],{"class":41,"line":62},[39,852,854],{"emptyLinePlaceholder":853},true,"\n",[39,856,857,860,862],{"class":41,"line":71},[39,858,859],{"class":439},"results ",[39,861,818],{"class":809},[39,863,864],{"class":439}," {\n",[39,866,867,870,873,876,879,882,885,887,889,892,894,897,899,902,904,907,909,912,914,917,919,922],{"class":41,"line":79},[39,868,869],{"class":49},"    'FCFS'",[39,871,872],{"class":439},": [[(",[39,874,875],{"class":204},"0",[39,877,878],{"class":439},",",[39,880,881],{"class":204},"2",[39,883,884],{"class":439},")], [(",[39,886,881],{"class":204},[39,888,878],{"class":439},[39,890,891],{"class":204},"1",[39,893,884],{"class":439},[39,895,896],{"class":204},"3",[39,898,878],{"class":439},[39,900,901],{"class":204},"8",[39,903,884],{"class":439},[39,905,906],{"class":204},"11",[39,908,878],{"class":439},[39,910,911],{"class":204},"4",[39,913,884],{"class":439},[39,915,916],{"class":204},"15",[39,918,878],{"class":439},[39,920,921],{"class":204},"5",[39,923,924],{"class":439},")]],\n",[39,926,927,930,932,934,936,938,940,942,944,946,948,951,953,955,957,959,961,963,965,968,970,972],{"class":41,"line":87},[39,928,929],{"class":49},"    'SJF'",[39,931,872],{"class":439},[39,933,891],{"class":204},[39,935,878],{"class":439},[39,937,881],{"class":204},[39,939,884],{"class":439},[39,941,875],{"class":204},[39,943,878],{"class":439},[39,945,891],{"class":204},[39,947,884],{"class":439},[39,949,950],{"class":204},"12",[39,952,878],{"class":439},[39,954,901],{"class":204},[39,956,884],{"class":439},[39,958,896],{"class":204},[39,960,878],{"class":439},[39,962,911],{"class":204},[39,964,884],{"class":439},[39,966,967],{"class":204},"7",[39,969,878],{"class":439},[39,971,921],{"class":204},[39,973,924],{"class":439},[39,975,976,979,981,984,986,988,991,994,996,998,1000,1002,1004,1006,1008,1010,1012,1014,1016,1018,1020,1022],{"class":41,"line":95},[39,977,978],{"class":49},"    'non-compreemptive priority'",[39,980,872],{"class":439},[39,982,983],{"class":204},"13",[39,985,878],{"class":439},[39,987,881],{"class":204},[39,989,990],{"class":439},")],[(",[39,992,993],{"class":204},"19",[39,995,878],{"class":439},[39,997,891],{"class":204},[39,999,990],{"class":439},[39,1001,875],{"class":204},[39,1003,878],{"class":439},[39,1005,901],{"class":204},[39,1007,990],{"class":439},[39,1009,916],{"class":204},[39,1011,878],{"class":439},[39,1013,911],{"class":204},[39,1015,990],{"class":439},[39,1017,901],{"class":204},[39,1019,878],{"class":439},[39,1021,921],{"class":204},[39,1023,924],{"class":439},[39,1025,1026,1029,1031,1033,1035,1037,1039,1041,1043,1045,1047,1049,1051,1053,1056,1059,1061,1063,1065,1067,1069,1071,1073,1076,1078,1080,1082,1084,1086,1088,1090,1092,1094,1096,1098,1100,1102,1104,1106,1108,1110,1112,1114,1117,1119,1121],{"class":41,"line":103},[39,1027,1028],{"class":49},"    'RR (quantum=2)'",[39,1030,872],{"class":439},[39,1032,875],{"class":204},[39,1034,878],{"class":439},[39,1036,881],{"class":204},[39,1038,884],{"class":439},[39,1040,881],{"class":204},[39,1042,878],{"class":439},[39,1044,891],{"class":204},[39,1046,990],{"class":439},[39,1048,896],{"class":204},[39,1050,878],{"class":439},[39,1052,881],{"class":204},[39,1054,1055],{"class":439},"),(",[39,1057,1058],{"class":204},"9",[39,1060,878],{"class":439},[39,1062,881],{"class":204},[39,1064,1055],{"class":439},[39,1066,916],{"class":204},[39,1068,878],{"class":439},[39,1070,881],{"class":204},[39,1072,1055],{"class":439},[39,1074,1075],{"class":204},"18",[39,1077,878],{"class":439},[39,1079,881],{"class":204},[39,1081,884],{"class":439},[39,1083,921],{"class":204},[39,1085,878],{"class":439},[39,1087,881],{"class":204},[39,1089,1055],{"class":439},[39,1091,906],{"class":204},[39,1093,878],{"class":439},[39,1095,881],{"class":204},[39,1097,884],{"class":439},[39,1099,967],{"class":204},[39,1101,878],{"class":439},[39,1103,881],{"class":204},[39,1105,1055],{"class":439},[39,1107,983],{"class":204},[39,1109,878],{"class":439},[39,1111,881],{"class":204},[39,1113,1055],{"class":439},[39,1115,1116],{"class":204},"17",[39,1118,878],{"class":439},[39,1120,891],{"class":204},[39,1122,1123],{"class":439},")]]\n",[39,1125,1127],{"class":41,"line":1126},9,[39,1128,1129],{"class":439},"}\n",[39,1131,1132],{"class":41,"line":3},[39,1133,854],{"emptyLinePlaceholder":853},[39,1135,1137,1140,1142,1144,1146,1148,1150,1152,1154,1156,1158],{"class":41,"line":1136},11,[39,1138,1139],{"class":439},"arrival_t ",[39,1141,818],{"class":809},[39,1143,821],{"class":439},[39,1145,875],{"class":204},[39,1147,827],{"class":439},[39,1149,875],{"class":204},[39,1151,827],{"class":439},[39,1153,875],{"class":204},[39,1155,827],{"class":439},[39,1157,875],{"class":204},[39,1159,848],{"class":439},[39,1161,1163],{"class":41,"line":1162},12,[39,1164,854],{"emptyLinePlaceholder":853},[39,1166,1168,1172,1175,1178],{"class":41,"line":1167},13,[39,1169,1171],{"class":1170},"slOjB","gantt",[39,1173,1174],{"class":439},"(category_names, results, arrival_t).",[39,1176,1177],{"class":1170},"show",[39,1179,1180],{"class":439},"()\n",[18,1182,1183],{},[321,1184],{"alt":35,"src":1185},"https://static.031130.xyz/uploads/2024/08/12/662890f78f1da.webp",[380,1187],{},[30,1189,1191],{"className":791,"code":1190,"language":793,"meta":35,"style":35},"from gantt import *\ncategory_names = ['P1', 'P2', 'P3', 'P4', 'P5', 'P6']\n\nresults = {\n    '': [[(0,20)], [(25,10),(45,10),(75,5)], [(35,10),(55,5),(80,10)], [(60,15)], [(100,5),(115,5)],[(105,10)]],\n}\n\narrival_t = [0]\n\ngantt(category_names, results, arrival_t).show()\n\n",[25,1192,1193,1203,1236,1240,1248,1355,1359,1363,1375,1379],{"__ignoreMap":35},[39,1194,1195,1197,1199,1201],{"class":41,"line":42},[39,1196,800],{"class":507},[39,1198,803],{"class":439},[39,1200,806],{"class":507},[39,1202,810],{"class":809},[39,1204,1205,1207,1209,1211,1213,1215,1217,1219,1221,1223,1225,1227,1229,1231,1234],{"class":41,"line":56},[39,1206,815],{"class":439},[39,1208,818],{"class":809},[39,1210,821],{"class":439},[39,1212,824],{"class":49},[39,1214,827],{"class":439},[39,1216,830],{"class":49},[39,1218,827],{"class":439},[39,1220,835],{"class":49},[39,1222,827],{"class":439},[39,1224,840],{"class":49},[39,1226,827],{"class":439},[39,1228,845],{"class":49},[39,1230,827],{"class":439},[39,1232,1233],{"class":49},"'P6'",[39,1235,848],{"class":439},[39,1237,1238],{"class":41,"line":62},[39,1239,854],{"emptyLinePlaceholder":853},[39,1241,1242,1244,1246],{"class":41,"line":71},[39,1243,859],{"class":439},[39,1245,818],{"class":809},[39,1247,864],{"class":439},[39,1249,1250,1253,1255,1257,1259,1262,1264,1267,1269,1272,1274,1277,1279,1281,1283,1286,1288,1290,1292,1295,1297,1299,1301,1304,1306,1308,1310,1313,1315,1317,1319,1322,1324,1326,1328,1331,1333,1335,1337,1340,1342,1344,1346,1349,1351,1353],{"class":41,"line":79},[39,1251,1252],{"class":49},"    ''",[39,1254,872],{"class":439},[39,1256,875],{"class":204},[39,1258,878],{"class":439},[39,1260,1261],{"class":204},"20",[39,1263,884],{"class":439},[39,1265,1266],{"class":204},"25",[39,1268,878],{"class":439},[39,1270,1271],{"class":204},"10",[39,1273,1055],{"class":439},[39,1275,1276],{"class":204},"45",[39,1278,878],{"class":439},[39,1280,1271],{"class":204},[39,1282,1055],{"class":439},[39,1284,1285],{"class":204},"75",[39,1287,878],{"class":439},[39,1289,921],{"class":204},[39,1291,884],{"class":439},[39,1293,1294],{"class":204},"35",[39,1296,878],{"class":439},[39,1298,1271],{"class":204},[39,1300,1055],{"class":439},[39,1302,1303],{"class":204},"55",[39,1305,878],{"class":439},[39,1307,921],{"class":204},[39,1309,1055],{"class":439},[39,1311,1312],{"class":204},"80",[39,1314,878],{"class":439},[39,1316,1271],{"class":204},[39,1318,884],{"class":439},[39,1320,1321],{"class":204},"60",[39,1323,878],{"class":439},[39,1325,916],{"class":204},[39,1327,884],{"class":439},[39,1329,1330],{"class":204},"100",[39,1332,878],{"class":439},[39,1334,921],{"class":204},[39,1336,1055],{"class":439},[39,1338,1339],{"class":204},"115",[39,1341,878],{"class":439},[39,1343,921],{"class":204},[39,1345,990],{"class":439},[39,1347,1348],{"class":204},"105",[39,1350,878],{"class":439},[39,1352,1271],{"class":204},[39,1354,924],{"class":439},[39,1356,1357],{"class":41,"line":87},[39,1358,1129],{"class":439},[39,1360,1361],{"class":41,"line":95},[39,1362,854],{"emptyLinePlaceholder":853},[39,1364,1365,1367,1369,1371,1373],{"class":41,"line":103},[39,1366,1139],{"class":439},[39,1368,818],{"class":809},[39,1370,821],{"class":439},[39,1372,875],{"class":204},[39,1374,848],{"class":439},[39,1376,1377],{"class":41,"line":1126},[39,1378,854],{"emptyLinePlaceholder":853},[39,1380,1381,1383,1385,1387],{"class":41,"line":3},[39,1382,1171],{"class":1170},[39,1384,1174],{"class":439},[39,1386,1177],{"class":1170},[39,1388,1180],{"class":439},[18,1390,1391],{},[321,1392],{"alt":35,"src":1393},"https://static.031130.xyz/uploads/2024/08/12/662891bfa52fc.webp",[386,1395,1396],{},"html pre.shiki code .sLKXg, html code.shiki .sLKXg{--shiki-default:#A626A4;--shiki-dark:#C678DD}html pre.shiki code .s5ixo, html code.shiki .s5ixo{--shiki-default:#383A42;--shiki-dark:#ABB2BF}html pre.shiki code .sknuh, html code.shiki .sknuh{--shiki-default:#383A42;--shiki-dark:#56B6C2}html pre.shiki code .sDhpE, html code.shiki .sDhpE{--shiki-default:#50A14F;--shiki-dark:#98C379}html pre.shiki code .sAGMh, html code.shiki .sAGMh{--shiki-default:#986801;--shiki-dark:#D19A66}html pre.shiki code .slOjB, html code.shiki .slOjB{--shiki-default:#383A42;--shiki-dark:#61AFEF}html .default .shiki span {color: var(--shiki-default);background: var(--shiki-default-bg);font-style: var(--shiki-default-font-style);font-weight: var(--shiki-default-font-weight);text-decoration: var(--shiki-default-text-decoration);}html .shiki span {color: var(--shiki-default);background: var(--shiki-default-bg);font-style: var(--shiki-default-font-style);font-weight: var(--shiki-default-font-weight);text-decoration: var(--shiki-default-text-decoration);}html .dark .shiki span {color: var(--shiki-dark);background: var(--shiki-dark-bg);font-style: var(--shiki-dark-font-style);font-weight: var(--shiki-dark-font-weight);text-decoration: var(--shiki-dark-text-decoration);}html.dark .shiki span {color: var(--shiki-dark);background: var(--shiki-dark-bg);font-style: var(--shiki-dark-font-style);font-weight: var(--shiki-dark-font-weight);text-decoration: var(--shiki-dark-text-decoration);}",{"title":35,"searchDepth":56,"depth":56,"links":1398},[],{"title":1400,"date":1401,"path":1402,"tags":1403,"body":1408},"uniapp 中的图片预加载","2024-04-01 05:31:25","/2024/04/01/image-preload-in-uniapp",[1404,1405,1406,1407],"uniapp","Vue.js","Web","JavaScript",{"type":15,"value":1409,"toc":1697},[1410,1413,1415,1428,1430,1439,1449,1459,1465,1471,1473,1480,1682,1687,1694],[18,1411,1412],{},"最近在做微信小程序的时候遇到了图片资源过大无法正常打包的问题，没什么太好的方法，只能是使用图床托管这些图片资源。但部分图片的体积实在太大，即使是采用了境内 cdn 的图床，即使是采用 webp 对图片进行了压缩，部分图片都需要小几秒去把图片加载出来，这导致的用户体验就不是很好了，因此我们需要实现图片预加载的功能。",[380,1414],{},[18,1416,1417,1418,1423,1424,1427],{},"在 ",[114,1419,1422],{"href":1420,"rel":1421},"https://uniapp.dcloud.net.cn/api/preload-page.html#preloadpage",[118],"uniapp 的官方文档","中，我找到了 ",[25,1425,1426],{},"uni.preloadPage(OBJECT)"," 方法。很可惜，这个方法并不支持微信小程序，自然不能完成被预加载页面的图片资源预加载。",[380,1429],{},[18,1431,1432,1433,1438],{},"经过搜索，在",[114,1434,1437],{"href":1435,"rel":1436},"https://frontend.mimiwuqi.com/qianduan/202517.html",[118],"一篇奇奇怪怪的文章","中提到：",[1440,1441,1442],"blockquote",{},[18,1443,1444,1445,1448],{},"在UniApp中，图片预加载可以通过使用",[25,1446,1447],{},"uni.getImageInfo","方法来实现。这个方法可以获取图片的信息，包括宽度、高度等。可以在应用启动时就开始加载图片，以提高后续图片显示的速度。",[18,1450,1451,1452,1455,1456,1458],{},"很遗憾，经过实测，提前使用 ",[25,1453,1454],{},"getImageInfo()"," 方法并不能实现图片的预加载。",[25,1457,1454],{}," 获取时的 Type 是 xhr，而后续图片加载时的 Type 为 webp，图片会被重复下载，并没有实现预加载的作用。",[18,1460,1461],{},[321,1462],{"alt":1463,"src":1464},"下载测试","https://static.031130.xyz/uploads/2024/08/12/6609d97bc4f7f.webp",[18,1466,1467,1468,1470],{},"上图中，蓝色部分是 ",[25,1469,1454],{}," 的网络请求，红色部分是真正的图片加载请求，可谓是一点用都没有，该加载慢还是加载慢。",[380,1472],{},[18,1474,1475,1476,1479],{},"那有没有什么办法能够实现预加载呢？我没找到优雅的方法，选择在应用的首页创建一个 ",[25,1477,1478],{},"display: none"," 的 view 将所有的图片先加载一遍。",[30,1481,1485],{"className":1482,"code":1483,"language":1484,"meta":35,"style":35},"language-vue shiki shiki-themes one-light one-dark-pro","\u003Ctemplate>\n    \u003Cview style=\"display: none;\">\n        \u003Cimage\n            v-for=\"image in imageToPreload\"\n            :src=\"image\"\n        />\n    \u003C/view>\n\u003C/template>\n\u003Cscript setup lang=\"ts\">\nconst imageToPreload = [\n    \"https://http.cat/100\",\n    \"https://http.cat/200\",\n    \"https://http.cat/300\",\n    \"https://http.cat/400\",\n    \"https://http.cat/500\"\n]\n\u003C/script>\n","vue",[25,1486,1487,1498,1528,1536,1558,1574,1579,1588,1597,1617,1632,1640,1647,1654,1662,1668,1673],{"__ignoreMap":35},[39,1488,1489,1492,1495],{"class":41,"line":42},[39,1490,1491],{"class":439},"\u003C",[39,1493,1494],{"class":443},"template",[39,1496,1497],{"class":439},">\n",[39,1499,1500,1503,1506,1509,1511,1514,1517,1521,1524,1526],{"class":41,"line":56},[39,1501,1502],{"class":439},"    \u003C",[39,1504,1505],{"class":443},"view",[39,1507,1508],{"class":204}," style",[39,1510,818],{"class":439},[39,1512,1513],{"class":439},"\"",[39,1515,1516],{"class":439},"display: ",[39,1518,1520],{"class":1519},"sYebD","none",[39,1522,1523],{"class":439},";",[39,1525,1513],{"class":439},[39,1527,1497],{"class":439},[39,1529,1530,1533],{"class":41,"line":62},[39,1531,1532],{"class":439},"        \u003C",[39,1534,1535],{"class":443},"image\n",[39,1537,1538,1541,1543,1545,1549,1552,1555],{"class":41,"line":71},[39,1539,1540],{"class":507},"            v-for",[39,1542,818],{"class":439},[39,1544,1513],{"class":439},[39,1546,1548],{"class":1547},"sz0mV","image",[39,1550,1551],{"class":507}," in",[39,1553,1554],{"class":1547}," imageToPreload",[39,1556,1557],{"class":439},"\"\n",[39,1559,1560,1563,1566,1568,1570,1572],{"class":41,"line":79},[39,1561,1562],{"class":439},"            :",[39,1564,1565],{"class":204},"src",[39,1567,818],{"class":439},[39,1569,1513],{"class":439},[39,1571,1548],{"class":1547},[39,1573,1557],{"class":439},[39,1575,1576],{"class":41,"line":87},[39,1577,1578],{"class":439},"        />\n",[39,1580,1581,1584,1586],{"class":41,"line":95},[39,1582,1583],{"class":439},"    \u003C/",[39,1585,1505],{"class":443},[39,1587,1497],{"class":439},[39,1589,1590,1593,1595],{"class":41,"line":103},[39,1591,1592],{"class":439},"\u003C/",[39,1594,1494],{"class":443},[39,1596,1497],{"class":439},[39,1598,1599,1601,1604,1607,1610,1612,1615],{"class":41,"line":1126},[39,1600,1491],{"class":439},[39,1602,1603],{"class":443},"script",[39,1605,1606],{"class":204}," setup",[39,1608,1609],{"class":204}," lang",[39,1611,818],{"class":439},[39,1613,1614],{"class":49},"\"ts\"",[39,1616,1497],{"class":439},[39,1618,1619,1622,1625,1629],{"class":41,"line":3},[39,1620,1621],{"class":507},"const",[39,1623,1554],{"class":1624},"sNmU0",[39,1626,1628],{"class":1627},"s_Sar"," =",[39,1630,1631],{"class":439}," [\n",[39,1633,1634,1637],{"class":41,"line":1136},[39,1635,1636],{"class":49},"    \"https://http.cat/100\"",[39,1638,1639],{"class":439},",\n",[39,1641,1642,1645],{"class":41,"line":1162},[39,1643,1644],{"class":49},"    \"https://http.cat/200\"",[39,1646,1639],{"class":439},[39,1648,1649,1652],{"class":41,"line":1167},[39,1650,1651],{"class":49},"    \"https://http.cat/300\"",[39,1653,1639],{"class":439},[39,1655,1657,1660],{"class":41,"line":1656},14,[39,1658,1659],{"class":49},"    \"https://http.cat/400\"",[39,1661,1639],{"class":439},[39,1663,1665],{"class":41,"line":1664},15,[39,1666,1667],{"class":49},"    \"https://http.cat/500\"\n",[39,1669,1671],{"class":41,"line":1670},16,[39,1672,848],{"class":439},[39,1674,1676,1678,1680],{"class":41,"line":1675},17,[39,1677,1592],{"class":439},[39,1679,1603],{"class":443},[39,1681,1497],{"class":439},[18,1683,1684],{},[321,1685],{"alt":1463,"src":1686},"https://static.031130.xyz/uploads/2024/08/12/6609db8a213da.webp",[18,1688,1689,1690,1693],{},"可以看到，红色部分的资源在 size 那一栏变成了 ",[25,1691,1692],{},"(disk cache)","，加载时间也明显降低，虽然方法不优雅，但起码实现了图片资源的预加载。",[386,1695,1696],{},"html pre.shiki code .s5ixo, html code.shiki .s5ixo{--shiki-default:#383A42;--shiki-dark:#ABB2BF}html pre.shiki code .sJa8x, html code.shiki .sJa8x{--shiki-default:#E45649;--shiki-dark:#E06C75}html pre.shiki code .sAGMh, html code.shiki .sAGMh{--shiki-default:#986801;--shiki-dark:#D19A66}html pre.shiki code .sYebD, html code.shiki .sYebD{--shiki-default:#383A42;--shiki-dark:#D19A66}html pre.shiki code .sLKXg, html code.shiki .sLKXg{--shiki-default:#A626A4;--shiki-dark:#C678DD}html pre.shiki code .sz0mV, html code.shiki .sz0mV{--shiki-default:#383A42;--shiki-dark:#E06C75}html pre.shiki code .sDhpE, html code.shiki .sDhpE{--shiki-default:#50A14F;--shiki-dark:#98C379}html pre.shiki code .sNmU0, html code.shiki .sNmU0{--shiki-default:#986801;--shiki-dark:#E5C07B}html pre.shiki code .s_Sar, html code.shiki .s_Sar{--shiki-default:#0184BC;--shiki-dark:#56B6C2}html .default .shiki span {color: var(--shiki-default);background: var(--shiki-default-bg);font-style: var(--shiki-default-font-style);font-weight: var(--shiki-default-font-weight);text-decoration: var(--shiki-default-text-decoration);}html .shiki span {color: var(--shiki-default);background: var(--shiki-default-bg);font-style: var(--shiki-default-font-style);font-weight: var(--shiki-default-font-weight);text-decoration: var(--shiki-default-text-decoration);}html .dark .shiki span {color: var(--shiki-dark);background: var(--shiki-dark-bg);font-style: var(--shiki-dark-font-style);font-weight: var(--shiki-dark-font-weight);text-decoration: var(--shiki-dark-text-decoration);}html.dark .shiki span {color: var(--shiki-dark);background: var(--shiki-dark-bg);font-style: var(--shiki-dark-font-style);font-weight: var(--shiki-dark-font-weight);text-decoration: var(--shiki-dark-text-decoration);}",{"title":35,"searchDepth":56,"depth":56,"links":1698},[],{"title":1700,"date":1701,"path":1702,"tags":1703,"body":1706},"小记 - 尝试拼凑出 apt 仓库中的 deb 包下载地址","2024-03-13 21:55:04","/2024/03/13/try-to-compose-download-links-of-deb-packages-in-apt-repository",[13,1704,1705],"Apt","deepin",{"type":15,"value":1707,"toc":1926},[1708,1711,1720,1723,1726,1732,1739,1742,1745,1753,1764,1833,1840,1846,1857,1863,1866,1869,1897,1903,1914,1917,1923],[18,1709,1710],{},"大概一周前，有一个来源不明的 Linux 微信，从包的结构来看是基于 qt 实现的图形化界面，deb 包中的 control 信息表明是腾讯团队官方出品的。今天听人说 UOS 的商店上架了最新的微信，便尝试从 UOS 的官方仓库提取下载链接，帮助 AUR Maintainer 获取到新的地址。",[18,1712,1713,1714,1719],{},"在我的",[114,1715,1718],{"href":1716,"rel":1717},"https://zhul.in/2021/11/20/what-is-deepin-elf-verify/",[118],"《deepin-elf-verify究竟是何物？》","这篇文章中，我成功从 uos.deepin.cn 下载到了来自 UOS 中的软件包。可惜，当我采用同样的方法搜索 weixin 或者 wechat 字样时，没有得到任何结果。",[18,1721,1722],{},"UOS 上的软件来源起码来自两个仓库，一个是与系统有关的软件，比如 Linux Kernel，GCC 一类开源软件，应该就是来自我之前下载到 deepin-elf-verify 的那个源。除此之外，还有一个 appstore 源，里面存放的都是应用商店中上架的软件（大部分可能是闭源的）。",[18,1724,1725],{},"在 chinauos.com 下载到最新的 ISO 安装镜像后，直接在虚拟机中走完正常的安装流畅，然后直捣黄龙。",[18,1727,1728],{},[321,1729],{"alt":1730,"src":1731},"源地址","https://static.031130.xyz/uploads/2024/08/12/65f1b344e5581.webp",[18,1733,1734,1735,1738],{},"可以看出，",[25,1736,1737],{},"/etc/apt/sources.list.d/appstore.list"," 文件中列出的源很有可能就是我们要找的新版微信的所在源。",[18,1740,1741],{},"可惜直接访问的时候，源地址给出了 403。他们似乎不愿意公开源地址的 filelist index。",[18,1743,1744],{},"不过没关系，既然 UOS Desktop 目前仍然依赖 APT 实现软件安装，那它的源应该仍然符合 Debian 的 APT Repository 目录结构。",[18,1746,1747,1748],{},"根据 ",[114,1749,1752],{"href":1750,"rel":1751},"https://wiki.debian.org/DebianRepository/Format",[118],"DebianWiki 中的描述",[1440,1754,1755,1758],{},[18,1756,1757],{},"gives an example:",[30,1759,1762],{"className":1760,"code":1761,"language":246},[244],"deb https://deb.debian.org/debian stable main contrib non-free\n",[25,1763,1761],{"__ignoreMap":35},[1440,1765,1766,1769,1787,1820],{},[18,1767,1768],{},"An archive can have either source packages or binary packages or both but they have to be specified separately to apt.",[18,1770,1771,1772,1778,1779,1782,1783,1786],{},"The uri, in this case ",[1773,1774,1775],"em",{},[25,1776,1777],{},"https://deb.debian.org/debian"," specifies the root of the archive. Often Debian archives are in the ",[1773,1780,1781],{},"debian/"," directory on the server but can be anywhere else (many mirrors for example have it in a ",[1773,1784,1785],{},"pub/linux/debian"," directory, for example).",[18,1788,1789,1790,1793,1794,1798,1799,1802,1803,1806,1807,1810,1811,1814,1815],{},"The distribution part (",[1773,1791,1792],{},"stable"," in this case) specifies a subdirectory in ",[1795,1796,1797],"strong",{},"$ARCHIVE_ROOT/dists",". It can contain additional slashes to specify subdirectories nested deeper, eg. ",[1773,1800,1801],{},"stable/updates",". distribution typically corresponds to ",[1795,1804,1805],{},"Suite"," or ",[1795,1808,1809],{},"Codename"," specified in the ",[1795,1812,1813],{},"Release"," files. ",[1773,1816,1817],{},[1795,1818,1819],{},"FIXME is this enforced anyhow?",[18,1821,1822,1823,1806,1826,1828,1829,1832],{},"To download packages from a repository apt would download an ",[1795,1824,1825],{},"InRelease",[1795,1827,1813],{}," file from the ",[1795,1830,1831],{},"$ARCHIVE_ROOT/dists/$DISTRIBUTION"," directory.",[18,1834,1835,1836,1839],{},"我尝试了访问 ",[25,1837,1838],{},"https://pro-store-packages.uniontech.com/appstore/dists/eagle-pro/Release","，获得了一系列索引文件的索引。",[18,1841,1842],{},[321,1843],{"alt":1844,"src":1845},"索引的索引（很拗口）","https://static.031130.xyz/uploads/2024/08/12/65f1b5166810a.webp",[18,1847,1848,1849,1852,1853],{},"第一段中就能看到熟悉的 ",[25,1850,1851],{},"Packages"," 文件。根据我 deepin-elf-verify 相关博客中记载，这个文件中会保存 deb 文件的相对路径。我们先拼出 amd64 架构的 Packages 文件下载链接: ",[114,1854,1855],{"href":1855,"rel":1856},"https://pro-store-packages.uniontech.com/appstore/dists/eagle-pro/appstore/binary-amd64/Packages",[118],[18,1858,1859],{},[321,1860],{"alt":1861,"src":1862},"deb 包详细信息","https://static.031130.xyz/uploads/2024/08/12/65f1b5faccc86.webp",[18,1864,1865],{},"这里可以看到源中每一个 deb 包的信息。图中红色方框框出的便是其中一个 deb 包在源中的相对路径。",[18,1867,1868],{},"我们可以使用 grep 命令去检索 weixin 或者 wechat 关键词",[30,1870,1872],{"className":32,"code":1871,"language":34,"meta":35,"style":35},"curl -sL https://pro-store-packages.uniontech.com/appstore/dists/eagle-pro/appstore/binary-amd64/Packages | grep -E \"weixin|wechat\"\n",[25,1873,1874],{"__ignoreMap":35},[39,1875,1876,1879,1882,1885,1888,1891,1894],{"class":41,"line":42},[39,1877,1878],{"class":45},"curl",[39,1880,1881],{"class":204}," -sL",[39,1883,1884],{"class":49}," https://pro-store-packages.uniontech.com/appstore/dists/eagle-pro/appstore/binary-amd64/Packages",[39,1886,1887],{"class":439}," | ",[39,1889,1890],{"class":45},"grep",[39,1892,1893],{"class":204}," -E",[39,1895,1896],{"class":49}," \"weixin|wechat\"\n",[18,1898,1899],{},[321,1900],{"alt":1901,"src":1902},"获取到我们想要的 deb 包的相对路径","https://static.031130.xyz/uploads/2024/08/12/65f1b6a4c3239.webp",[18,1904,1905,1906,1909,1910],{},"在这个路径前加上之前 ",[25,1907,1908],{},"appstore.list"," 文件中给出的 url 前缀，即可拼凑出 deb 包的完整下载地址: ",[114,1911,1912],{"href":1912,"rel":1913},"https://pro-store-packages.uniontech.com/appstore/pool/appstore/c/com.tencent.wechat/com.tencent.wechat_1.0.0.236_amd64.deb",[118],[18,1915,1916],{},"放到浏览器中尝试，果然可以正常下载",[18,1918,1919],{},[321,1920],{"alt":1921,"src":1922},"正常下载","https://static.031130.xyz/uploads/2024/08/12/65f1b73567121.webp",[386,1924,1925],{},"html pre.shiki code .sAdtL, html code.shiki .sAdtL{--shiki-default:#4078F2;--shiki-dark:#61AFEF}html pre.shiki code .sAGMh, html code.shiki .sAGMh{--shiki-default:#986801;--shiki-dark:#D19A66}html pre.shiki code .sDhpE, html code.shiki .sDhpE{--shiki-default:#50A14F;--shiki-dark:#98C379}html pre.shiki code .s5ixo, html code.shiki .s5ixo{--shiki-default:#383A42;--shiki-dark:#ABB2BF}html .default .shiki span {color: var(--shiki-default);background: var(--shiki-default-bg);font-style: var(--shiki-default-font-style);font-weight: var(--shiki-default-font-weight);text-decoration: var(--shiki-default-text-decoration);}html .shiki span {color: var(--shiki-default);background: var(--shiki-default-bg);font-style: var(--shiki-default-font-style);font-weight: var(--shiki-default-font-weight);text-decoration: var(--shiki-default-text-decoration);}html .dark .shiki span {color: var(--shiki-dark);background: var(--shiki-dark-bg);font-style: var(--shiki-dark-font-style);font-weight: var(--shiki-dark-font-weight);text-decoration: var(--shiki-dark-text-decoration);}html.dark .shiki span {color: var(--shiki-dark);background: var(--shiki-dark-bg);font-style: var(--shiki-dark-font-style);font-weight: var(--shiki-dark-font-weight);text-decoration: var(--shiki-dark-text-decoration);}",{"title":35,"searchDepth":56,"depth":56,"links":1927},[],{"title":1929,"date":1930,"path":1931,"tags":1932,"body":1935},"在 Linux 下使用 mitmproxy 抓取 HTTPS 流量","2024-02-29 22:03:58","/2024/02/29/capture-https-traffic-on-linux-with-mitmproxy",[13,10,1933,1934],"Network","mitmproxy",{"type":15,"value":1936,"toc":2188},[1937,1940,1943,1947,1954,1972,1976,1979,1991,1999,2005,2015,2020,2024,2027,2034,2040,2051,2058,2078,2087,2108,2113,2125,2128,2132,2135,2142,2148,2157,2160,2166,2169,2172,2182,2185],[18,1938,1939],{},"作为部分 AUR Package 的 maintainer，一直以来我都有在 Linux 下抓取 https 流量的需求，比如抓取应用内的更新检测时访问的 url 地址。之前一直没有空去研究，趁着最近课少，总算是完成了这个目标。",[18,1941,1942],{},"在这里我使用的 mitmproxy，基于 python 和 webui 的一款开源简洁的流量代理软件，可以用于抓取 https 流量信息。",[183,1944,1946],{"id":1945},"安装-mitmproxy","安装 mitmproxy",[18,1948,1949,1950,1953],{},"在 Arch Linux 下，官方 ",[25,1951,1952],{},"extra"," 源中已经打包好了这款软件，直接使用下面的命令即可完成安装。",[30,1955,1957],{"className":32,"code":1956,"language":34,"meta":35,"style":35},"sudo pacman -S mitmproxy\n",[25,1958,1959],{"__ignoreMap":35},[39,1960,1961,1963,1966,1969],{"class":41,"line":42},[39,1962,267],{"class":45},[39,1964,1965],{"class":49}," pacman",[39,1967,1968],{"class":204}," -S",[39,1970,1971],{"class":49}," mitmproxy\n",[183,1973,1975],{"id":1974},"尝试运行-mitmweb","尝试运行 mitmweb",[18,1977,1978],{},"安装完成后，我们将会获得三个新的命令可用：",[1980,1981,1982,1986,1988],"ul",{},[1983,1984,1985],"li",{},"mitmdump",[1983,1987,1934],{},[1983,1989,1990],{},"mitmweb",[18,1992,1993,1994,1998],{},"我们只要使用 mitmweb 即可同时打开 8080 的代理端口和 8081 端口的 webui。访问 ",[114,1995,1996],{"href":1996,"rel":1997},"http://127.0.0.1:8081",[118]," 即可看到 mitmproxy 的网页。",[18,2000,2001],{},[321,2002],{"alt":2003,"src":2004},"mitmweb 的界面","https://static.031130.xyz/uploads/2024/08/12/65e092503d5bb.webp",[18,2006,2007,2008],{},"当然，也可以在 mitmweb 命令后面追加 -p ",[2009,2010,2011,2012],"port",{}," 和 --web-port=",[2009,2013,2014],{}," 分别设置代理端口和 webui 的端口。",[18,2016,2017,2018],{},"首先，我们先运行一次 ",[25,2019,1990],{},[183,2021,2023],{"id":2022},"安装-ca-证书","安装 ca 证书",[18,2025,2026],{},"为了解密 https 流量，我们需要为系统安装上 mitmproxy 自己的证书文件，让系统信任我们的证书。",[18,2028,2029,2030,2033],{},"先来看看 ",[25,2031,2032],{},"/usr/share/ca-certificates/trust-source/README"," 这个文件",[30,2035,2038],{"className":2036,"code":2037,"language":246},[244],"This directory /usr/share/ca-certificates/trust-source/ contains CA certificates\nand trust settings in the PEM file format. The trust settings found here will be\ninterpreted with a low priority - lower than the ones found in \n/etc/ca-certificates/trust-source/ .\n\n=============================================================================\nQUICK HELP: To add a certificate in the simple PEM or DER file formats to the\n            list of CAs trusted on the system:\n\n            Copy it to the\n                    /usr/share/ca-certificates/trust-source/anchors/\n            subdirectory, and run the\n                    update-ca-trust\n            command.\n\n            If your certificate is in the extended BEGIN TRUSTED file format,\n            then place it into the main trust-source/ directory instead.\n=============================================================================\n\nPlease refer to the update-ca-trust(8) manual page for additional information.\n",[25,2039,2037],{"__ignoreMap":35},[18,2041,2042,2043,2046,2047,2050],{},"这份文件告诉我们可以在 ",[25,2044,2045],{},"/usr/share/ca-certificates/trust-source/anchors/"," 路径下放置 PEM 证书文件，并使用 ",[25,2048,2049],{},"update-ca-trust"," 命令更新系统的信任。",[18,2052,2053,2054,2057],{},"mitmproxy 软件第一次运行时，将会在当前用户的 ",[25,2055,2056],{},"$HOME/.mitmproxy/"," 文件夹下生成证书，我们打开这个文件夹，发现一共有六个文件：",[1980,2059,2060,2063,2066,2069,2072,2075],{},[1983,2061,2062],{},"mitmproxy-ca-cert.cer",[1983,2064,2065],{},"mitmproxy-ca-cert.p12",[1983,2067,2068],{},"mitmproxy-ca-cert.pem",[1983,2070,2071],{},"mitmproxy-ca.p12",[1983,2073,2074],{},"mitmproxy-ca.pem",[1983,2076,2077],{},"mitmproxy-dhparam.pem",[18,2079,2080,2081,2083,2084,2086],{},"我们这里需要将 ",[25,2082,2068],{}," 文件复制到 ",[25,2085,2045],{}," 路径下",[30,2088,2090],{"className":32,"code":2089,"language":34,"meta":35,"style":35},"sudo cp $HOME/.mitmproxy/mitmproxy-ca-cert.pem /usr/share/ca-certificates/trust-source/anchors/\n",[25,2091,2092],{"__ignoreMap":35},[39,2093,2094,2096,2099,2102,2105],{"class":41,"line":42},[39,2095,267],{"class":45},[39,2097,2098],{"class":49}," cp",[39,2100,2101],{"class":443}," $HOME",[39,2103,2104],{"class":49},"/.mitmproxy/mitmproxy-ca-cert.pem",[39,2106,2107],{"class":49}," /usr/share/ca-certificates/trust-source/anchors/\n",[18,2109,2110,2111],{},"随后执行 ",[25,2112,2049],{},[30,2114,2116],{"className":32,"code":2115,"language":34,"meta":35,"style":35},"sudo update-ca-trust\n",[25,2117,2118],{"__ignoreMap":35},[39,2119,2120,2122],{"class":41,"line":42},[39,2121,267],{"class":45},[39,2123,2124],{"class":49}," update-ca-trust\n",[18,2126,2127],{},"这样便完成了 ca 证书的安装",[183,2129,2131],{"id":2130},"使目标软件使用-8080-端口通信","使目标软件使用 8080 端口通信",[18,2133,2134],{},"其实我试过使用透明代理进行抓包，只不过我的 Archlinux 是作为日常主力机使用的，系统无时无刻不在向外通信，透明代理以后 mitmproxy 的 webui 各种刷屏，便放弃了这个想法，选择指定目标软件使用 8080 端口通信。",[18,2136,2137,2138,2141],{},"网上比较常见的做法是使用 ",[25,2139,2140],{},"proxychains-ng"," 代理目标软件。这个方案是可行的，只不过我这边测试下来，部分软件使用 proxychains 代理以后出现了仍然不使用代理、无法联网、甚至直接崩溃的情况。",[18,2143,2144],{},[321,2145],{"alt":2146,"src":2147},"程序崩溃","https://static.031130.xyz/uploads/2024/08/12/65e09559dceef.webp",[18,2149,2150,2151,2156],{},"因此我转向了 ",[114,2152,2155],{"href":2153,"rel":2154},"https://github.com/mzz2017/gg",[118],"gg","。gg 和 proxychains-ng 的定位相同，都是使目标命令通过指定的代理进行通信，只不过 gg 解决了部分 golang 编写的软件无法被 proxychains 代理的问题，并支持一些常见的用来国际联网的协议。",[18,2158,2159],{},"在不对 gg 进行配置的情况下，每次启动时，gg 都会要求我们输入代理地址，这正合我意。",[18,2161,2162],{},[321,2163],{"alt":2164,"src":2165},"gg 要求输入代理地址","https://static.031130.xyz/uploads/2024/08/12/65e0963840449.webp",[18,2167,2168],{},"此时，软件正常启动，流量全部经过 mitmproxy，可以在 webui 上看到具体情况",[183,2170,2171],{"id":2171},"抓包成功",[18,2173,2174,2178],{},[321,2175],{"alt":2176,"src":2177},"命令行下看到流量信息","https://static.031130.xyz/uploads/2024/08/12/65e097dfe1f17.webp",[321,2179],{"alt":2180,"src":2181},"mitmweb 正常获取解密后的流量信息","https://static.031130.xyz/uploads/2024/08/12/65e09780dd2c0.webp",[18,2183,2184],{},"我们可以看到 mitmproxy 成功捕获并解密的 https 流量，针对图片等信息甚至可以直接实现预览。",[386,2186,2187],{},"html pre.shiki code .sAdtL, html code.shiki .sAdtL{--shiki-default:#4078F2;--shiki-dark:#61AFEF}html pre.shiki code .sDhpE, html code.shiki .sDhpE{--shiki-default:#50A14F;--shiki-dark:#98C379}html pre.shiki code .sAGMh, html code.shiki .sAGMh{--shiki-default:#986801;--shiki-dark:#D19A66}html .default .shiki span {color: var(--shiki-default);background: var(--shiki-default-bg);font-style: var(--shiki-default-font-style);font-weight: var(--shiki-default-font-weight);text-decoration: var(--shiki-default-text-decoration);}html .shiki span {color: var(--shiki-default);background: var(--shiki-default-bg);font-style: var(--shiki-default-font-style);font-weight: var(--shiki-default-font-weight);text-decoration: var(--shiki-default-text-decoration);}html .dark .shiki span {color: var(--shiki-dark);background: var(--shiki-dark-bg);font-style: var(--shiki-dark-font-style);font-weight: var(--shiki-dark-font-weight);text-decoration: var(--shiki-dark-text-decoration);}html.dark .shiki span {color: var(--shiki-dark);background: var(--shiki-dark-bg);font-style: var(--shiki-dark-font-style);font-weight: var(--shiki-dark-font-weight);text-decoration: var(--shiki-dark-text-decoration);}html pre.shiki code .sJa8x, html code.shiki .sJa8x{--shiki-default:#E45649;--shiki-dark:#E06C75}",{"title":35,"searchDepth":56,"depth":56,"links":2189},[2190,2191,2192,2193,2194],{"id":1945,"depth":56,"text":1946},{"id":1974,"depth":56,"text":1975},{"id":2022,"depth":56,"text":2023},{"id":2130,"depth":56,"text":2131},{"id":2171,"depth":56,"text":2171},{"title":2196,"date":2197,"path":2198,"tags":2199,"body":2204},"如何使用 docker 部署 onemanager","2024-02-11 16:30:29","/2024/02/11/how-to-deploy-onemanager-with-docker",[2200,2201,2202,2203],"PHP","OneDrive","OpenSource Project","Docker",{"type":15,"value":2205,"toc":2453},[2206,2208,2211,2218,2220,2229,2234,2263,2267,2282,2285,2289,2314,2321,2327,2336,2347,2363,2372,2381,2384,2387,2397,2416,2420,2447,2450],[380,2207],{},[183,2209,2210],{"id":2210},"部署方法",[18,2212,2213,2214],{},"如果你只是想找一个 OneManager-php 的 Docker 部署方法，直接看 ",[114,2215,2216],{"href":2216,"rel":2217},"https://github.com/zhullyb/OneManager-php-docker",[118],[380,2219],{},[18,2221,2222,2223,2228],{},"一直以来，我都是 ",[114,2224,2227],{"href":2225,"rel":2226},"https://github.com/qkqpttgf/OneManager-php",[118],"OneManager-php"," 的忠实用户。这些年来，尽管有 alist 这种 UI 好看，多种网盘高度聚合的项目逐渐取代了 onemanager 的生态位，但 onemanager 支持文件分片上传、上传流量不经服务器的特点还是让我非常满意。前一阵子，glitch 暂停了针对项目自定义域名的支持，因此在我手贱地取消了项目原本绑定的域名后，迫切地需要寻找一个新的部署的平台，只不过 onemanager 项目现在列出的方案都不太让我满意，因此我就萌生出了在 vps 上自己部署的想法。",[2230,2231,2233],"h3",{"id":2232},"docker-镜像选用","Docker 镜像选用",[18,2235,2236,2237,2240,2241,2246,2247,2250,2251,2254,2255,2258,2259,2262],{},"vps 上自己部署 php 项目，最简单的方法是使用 Docker，",[131,2238,2239],{},"使用 Docker 就可以免去配置 nginx 或者同类产品的 php-fpm 配置","才怪。我打开 Docker 提供的 ",[114,2242,2245],{"href":2243,"rel":2244},"https://hub.docker.com/_/php",[118],"php 官方镜像","，最小的镜像是带",[25,2248,2249],{},"-cli","后缀的，这个镜像就不适合进行部署，php 内置的开发服务器是单线程的，当同时打开两个网页访问开发服务器的时候，其中一个网页就会卡住；以",[25,2252,2253],{},"-fpm","结尾的镜像变体很明显，仍然需要去 nginx 或同类产品的配置文件那边去配置 fpm，这给部署了好几次 php 项目的我带来的心理阴影；剩下一个就是",[25,2256,2257],{},"-apache","后缀、使用 apache server 提供 php 服务的镜像，体积虽然大了点，但好在操作简单，只需要将 php 文件放进 ",[25,2260,2261],{},"/var/www/html","，启用 php 的相关拓展，启用 apache 的相关功能即可。",[183,2264,2266],{"id":2265},"php-拓展","php 拓展",[18,2268,2269,2270,2273,2274,2277,2278,2281],{},"php 的拓展可以使用镜像自带的 ",[25,2271,2272],{},"docker-php-ext-install"," 和 ",[25,2275,2276],{},"docker-php-ext-enable"," 命令进行操作，此外还有一个 ",[25,2279,2280],{},"docker-php-ext-configure"," 命令可以配置相关的拓展，不过我并不是 php 开发者，不熟悉拓展有什么好配置的。",[18,2283,2284],{},"OneManager-php 没有依赖任何的 php 拓展，因此这个步骤可以直接跳过。",[183,2286,2288],{"id":2287},"apache-server-配置","Apache Server 配置",[18,2290,2291,2292,2295,2296,2295,2299,2295,2302,2295,2305,2295,2308,2295,2311,2313],{},"和 php 拓展一样，镜像内也提供了几个命令进行 Apache Server 的配置，分别为 ",[25,2293,2294],{},"a2disconf","、",[25,2297,2298],{},"a2dismod",[25,2300,2301],{},"a2dissite",[25,2303,2304],{},"a2enconf",[25,2306,2307],{},"a2enmod",[25,2309,2310],{},"a2ensite",[25,2312,2310],{},"。",[18,2315,2316,2317,2320],{},"OneManager-php 在部署的时候依赖于 Apache Server 的 rewrite 的模块，因此在 Dockerfile 中需要使用 ",[25,2318,2319],{},"a2enmod rewrite"," 开启 rewrite 支持。至于别的 Apache Server 配置，都可以通过项目中的 .htaccess 文件进行配置。",[183,2322,2324],{"id":2323},"htaccess-文件纠错",[131,2325,2326],{},".htaccess 文件纠错",[18,2328,2329],{},[131,2330,2331,2332,2335],{},"在 OneManager-php 仓库中，",[25,2333,2334],{},".htaccess"," 文件有一些小问题。",[30,2337,2341],{"className":2338,"code":2339,"language":2340,"meta":35,"style":35},"language-htaccess shiki shiki-themes one-light one-dark-pro","RewriteRule ^(.*) index.php?/$1 [L]\n","htaccess",[25,2342,2343],{"__ignoreMap":35},[39,2344,2345],{"class":41,"line":42},[39,2346,2339],{},[18,2348,2349],{},[131,2350,2351,2352,2355,2356,2295,2359,2362],{},"这行配置原本是将访问的路径追加到 ",[25,2353,2354],{},"index.php?/"," 后面的意思，但 一旦路径中出现了 ",[25,2357,2358],{},"[",[25,2360,2361],{},"]"," 或者空格等字符时，会触发 Apache 自带的保护，因此我们将这行改成下面这个样子即可。",[30,2364,2366],{"className":2338,"code":2365,"language":2340,"meta":35,"style":35},"RewriteRule ^(.*) index.php [QSA,L]\n",[25,2367,2368],{"__ignoreMap":35},[39,2369,2370],{"class":41,"line":42},[39,2371,2365],{},[18,2373,2374,2375,2380],{},"原项目合并了",[114,2376,2379],{"href":2377,"rel":2378},"https://github.com/qkqpttgf/OneManager-php/pull/716",[118],"我的 PR","，因此这一过程不再需要。",[183,2382,2383],{"id":2383},"处理文件权限问题",[18,2385,2386],{},"OneManager-php 在运行过程中，会有针对配置文件的读写操作，此外还内置了一键更新的功能，因此会对路径内的文件进行读写，我们需要确保 php 在运行过程中有权限对这些文件进行读写。",[18,2388,2389,2390,2392,2393,2396],{},"可以直接将 ",[25,2391,2261],{}," 路径的所有权转给 ",[25,2394,2395],{},"www-data"," 用户。",[30,2398,2400],{"className":32,"code":2399,"language":34,"meta":35,"style":35},"chown -R www-data:www-data /var/www/html\n",[25,2401,2402],{"__ignoreMap":35},[39,2403,2404,2407,2410,2413],{"class":41,"line":42},[39,2405,2406],{"class":45},"chown",[39,2408,2409],{"class":204}," -R",[39,2411,2412],{"class":49}," www-data:www-data",[39,2414,2415],{"class":49}," /var/www/html\n",[183,2417,2419],{"id":2418},"最终的-dockerfile","最终的 Dockerfile",[30,2421,2425],{"className":2422,"code":2423,"language":2424,"meta":35,"style":35},"language-dockerfile shiki shiki-themes one-light one-dark-pro","FROM php:8-apache\nRUN a2enmod rewrite\nCOPY OneManager-php /var/www/html\nRUN chown -R www-data:www-data /var/www/html\n","dockerfile",[25,2426,2427,2432,2437,2442],{"__ignoreMap":35},[39,2428,2429],{"class":41,"line":42},[39,2430,2431],{},"FROM php:8-apache\n",[39,2433,2434],{"class":41,"line":56},[39,2435,2436],{},"RUN a2enmod rewrite\n",[39,2438,2439],{"class":41,"line":62},[39,2440,2441],{},"COPY OneManager-php /var/www/html\n",[39,2443,2444],{"class":41,"line":71},[39,2445,2446],{},"RUN chown -R www-data:www-data /var/www/html\n",[18,2448,2449],{},"其实一共就 4 行，还是挺简单的。",[386,2451,2452],{},"html .default .shiki span {color: var(--shiki-default);background: var(--shiki-default-bg);font-style: var(--shiki-default-font-style);font-weight: var(--shiki-default-font-weight);text-decoration: var(--shiki-default-text-decoration);}html .shiki span {color: var(--shiki-default);background: var(--shiki-default-bg);font-style: var(--shiki-default-font-style);font-weight: var(--shiki-default-font-weight);text-decoration: var(--shiki-default-text-decoration);}html .dark .shiki span {color: var(--shiki-dark);background: var(--shiki-dark-bg);font-style: var(--shiki-dark-font-style);font-weight: var(--shiki-dark-font-weight);text-decoration: var(--shiki-dark-text-decoration);}html.dark .shiki span {color: var(--shiki-dark);background: var(--shiki-dark-bg);font-style: var(--shiki-dark-font-style);font-weight: var(--shiki-dark-font-weight);text-decoration: var(--shiki-dark-text-decoration);}html pre.shiki code .sAdtL, html code.shiki .sAdtL{--shiki-default:#4078F2;--shiki-dark:#61AFEF}html pre.shiki code .sAGMh, html code.shiki .sAGMh{--shiki-default:#986801;--shiki-dark:#D19A66}html pre.shiki code .sDhpE, html code.shiki .sDhpE{--shiki-default:#50A14F;--shiki-dark:#98C379}",{"title":35,"searchDepth":56,"depth":56,"links":2454},[2455,2458,2459,2460,2461,2462],{"id":2210,"depth":56,"text":2210,"children":2456},[2457],{"id":2232,"depth":62,"text":2233},{"id":2265,"depth":56,"text":2266},{"id":2287,"depth":56,"text":2288},{"id":2323,"depth":56,"text":2326},{"id":2383,"depth":56,"text":2383},{"id":2418,"depth":56,"text":2419},{"title":2464,"date":2465,"path":2466,"tags":2467,"body":2469},"crontab 中简单的@语法糖","2024-02-08 17:21:31","/2024/02/08/extra-usage-for-crontab",[13,2468],"crontab",{"type":15,"value":2470,"toc":2663},[2471,2477,2490,2613,2616,2619,2660],[18,2472,2473,2474],{},"说来惭愧，其实我用了这么久的 Linux，一直没有学会编写 crontab 脚本。一行的开头写上五位莫名其妙的数字或星号，后面跟上需要执行的命令，看上去很 kiss，",[131,2475,2476],{},"但我确实记不住，以至于我现在每次写 crontab 都是让 ChatGPT 来帮我写。",[18,2478,2479,2480,2483,2484,2489],{},"不过我最近查阅 Linux 下设置开机自启脚本的方案的时候，意外地看到 crontab 中居然可以用 ",[25,2481,2482],{},"@reboot command"," 的方式去写，这让我意识到 crontab 也是有一些简单的语法糖的。在查阅了 ",[114,2485,2488],{"href":2486,"rel":2487},"https://man.archlinux.org/man/crontab.5.en#EXTENSIONS",[118],"crontab 的 manual"," 后，我发现一共有下面这么几种 @ 写法的语法糖。这是在全网大部分的 crontab 中文教程中是没有的。",[2491,2492,2493,2509],"table",{},[2494,2495,2496],"thead",{},[2497,2498,2499,2503,2506],"tr",{},[2500,2501,2502],"th",{},"语法糖",[2500,2504,2505],{},"执行条件",[2500,2507,2508],{},"等效表达式",[2510,2511,2512,2525,2540,2553,2568,2583,2598],"tbody",{},[2497,2513,2514,2520,2523],{},[2515,2516,2517],"td",{},[25,2518,2519],{},"@reboot",[2515,2521,2522],{},"开机时候运行",[2515,2524],{},[2497,2526,2527,2532,2535],{},[2515,2528,2529],{},[25,2530,2531],{},"@yearly",[2515,2533,2534],{},"一年一次",[2515,2536,2537],{},[25,2538,2539],{},"0 0 1 1 *",[2497,2541,2542,2547,2549],{},[2515,2543,2544],{},[25,2545,2546],{},"@annually",[2515,2548,2534],{},[2515,2550,2551],{},[25,2552,2539],{},[2497,2554,2555,2560,2563],{},[2515,2556,2557],{},[25,2558,2559],{},"@monthly",[2515,2561,2562],{},"一月一次",[2515,2564,2565],{},[25,2566,2567],{},"0 0 1 * *",[2497,2569,2570,2575,2578],{},[2515,2571,2572],{},[25,2573,2574],{},"@weekly",[2515,2576,2577],{},"一周一次",[2515,2579,2580],{},[25,2581,2582],{},"0 0 * * 0",[2497,2584,2585,2590,2593],{},[2515,2586,2587],{},[25,2588,2589],{},"@daily",[2515,2591,2592],{},"一天一次",[2515,2594,2595],{},[25,2596,2597],{},"0 0 * * *",[2497,2599,2600,2605,2608],{},[2515,2601,2602],{},[25,2603,2604],{},"@hourly",[2515,2606,2607],{},"一小时一次",[2515,2609,2610],{},[25,2611,2612],{},"0 * * * *",[18,2614,2615],{},"这几个简单的语法糖可以满足大部分 crontab 的情况，免去了对使用者学习并记忆 crontab 的表达式的要求。",[18,2617,2618],{},"比如说，如果我希望我的系统在每次开机时都用 TG Bot 发送一条上线信息，那就是",[30,2620,2622],{"className":32,"code":2621,"language":34,"meta":35,"style":35},"@reboot curl -s -X POST https://api.telegram.org/bot{id}:{apikey}/sendMessage -d chat_id={uid} -d text=\"`date`\"\n",[25,2623,2624],{"__ignoreMap":35},[39,2625,2626,2628,2631,2634,2637,2640,2643,2646,2649,2651,2654,2657],{"class":41,"line":42},[39,2627,2519],{"class":45},[39,2629,2630],{"class":49}," curl",[39,2632,2633],{"class":204}," -s",[39,2635,2636],{"class":204}," -X",[39,2638,2639],{"class":49}," POST",[39,2641,2642],{"class":49}," https://api.telegram.org/bot{id}:{apikey}/sendMessage",[39,2644,2645],{"class":204}," -d",[39,2647,2648],{"class":49}," chat_id={uid}",[39,2650,2645],{"class":204},[39,2652,2653],{"class":49}," text=\"`",[39,2655,2656],{"class":45},"date",[39,2658,2659],{"class":49},"`\"\n",[386,2661,2662],{},"html pre.shiki code .sAdtL, html code.shiki .sAdtL{--shiki-default:#4078F2;--shiki-dark:#61AFEF}html pre.shiki code .sDhpE, html code.shiki .sDhpE{--shiki-default:#50A14F;--shiki-dark:#98C379}html pre.shiki code .sAGMh, html code.shiki .sAGMh{--shiki-default:#986801;--shiki-dark:#D19A66}html .default .shiki span {color: var(--shiki-default);background: var(--shiki-default-bg);font-style: var(--shiki-default-font-style);font-weight: var(--shiki-default-font-weight);text-decoration: var(--shiki-default-text-decoration);}html .shiki span {color: var(--shiki-default);background: var(--shiki-default-bg);font-style: var(--shiki-default-font-style);font-weight: var(--shiki-default-font-weight);text-decoration: var(--shiki-default-text-decoration);}html .dark .shiki span {color: var(--shiki-dark);background: var(--shiki-dark-bg);font-style: var(--shiki-dark-font-style);font-weight: var(--shiki-dark-font-weight);text-decoration: var(--shiki-dark-text-decoration);}html.dark .shiki span {color: var(--shiki-dark);background: var(--shiki-dark-bg);font-style: var(--shiki-dark-font-style);font-weight: var(--shiki-dark-font-weight);text-decoration: var(--shiki-dark-text-decoration);}",{"title":35,"searchDepth":56,"depth":56,"links":2664},[],{"title":2666,"date":2667,"path":2668,"tags":2669,"body":2673},"备份 umami 数据库，并使用 TG Bot 保存 dump 文件","2024-02-01 00:00:01","/2024/02/01/backup-umami-database-and-send-it-by-tg-bot",[2670,2671,2672],"umami","Shell Script","Bot",{"type":15,"value":2674,"toc":3009},[2675,2684,2692,2698,2701,2704,2858,2869,2872,2881,2884,2890,2899,2972,2979,3000,3006],[18,2676,2677,2678,2683],{},"前一阵子看到点墨的博客",[114,2679,2682],{"href":2680,"rel":2681},"https://blog.m-l.cc/2023/11/09/ding-shi-bei-fen-mysql-mariadb-shu-ju-ku-bing-shang-chuan-zhi-tgbot/",[118],"「定时备份mysql/mariadb数据库并上传至tgbot」","，我意识到个人站点的数据库 dump 使用 TG Bot 存放是一个非常合适的做法。个人站点的数据库体积本身就不大，TG Bot 又有官方提供的 api，非常适合自动化任务。我就寻思着给我的 umami 数据库也写个定时任务备份一下，也不至于之前做一次迁移数据全部爆炸的悲剧重演。",[18,2685,2686,2687,2691],{},"我的 umami 是",[114,2688,2690],{"href":2689},"/2022/11/08/free-umami-deploy-plan/","「使用 vercel+supabase 免费部署 umami」","部署出来的，数据库在 supabase 上，因此我们先打开 supabase 的 dashboard，获取到数据库的 url。",[18,2693,2694],{},[321,2695],{"alt":2696,"src":2697},"supabase 操作面板","https://static.031130.xyz/uploads/2024/08/12/65ba6aae157e6.webp",[18,2699,2700],{},"密码我自然是不记得了，不过好在 Firefox 的密码管理器帮我记住了，直接去设置里就能找到。即使密码忘了也不要紧，往下翻有重置密码的按钮。",[18,2702,2703],{},"随后就要开始编写我们的教本了，这是我的",[30,2705,2707],{"className":32,"code":2706,"language":34,"meta":35,"style":35},"#!/bin/bash\n\nDATABASE_URL=\"postgres://\"\nDATE=$(date '+%F')\n\nTG_BOT_TOKEN='1145141919:ABCDEFGHIJKLVMNOPQRSTUVWXYZabcdefgh'\nTG_CHAT_ID='9191415411'\n\npg_dump ${DATABASE_URL} > umami_dump_${DATE}.sql\ncurl -F document=@umami_dump_${DATE}.sql https://api.telegram.org/bot${TG_BOT_TOKEN}/sendDocument?chat_id=${TG_CHAT_ID}\nrm umami_dump_${DATE}.sql\n",[25,2708,2709,2715,2719,2729,2747,2751,2761,2771,2775,2805,2842],{"__ignoreMap":35},[39,2710,2711],{"class":41,"line":42},[39,2712,2714],{"class":2713},"sW2Sy","#!/bin/bash\n",[39,2716,2717],{"class":41,"line":56},[39,2718,854],{"emptyLinePlaceholder":853},[39,2720,2721,2724,2726],{"class":41,"line":62},[39,2722,2723],{"class":443},"DATABASE_URL",[39,2725,818],{"class":809},[39,2727,2728],{"class":49},"\"postgres://\"\n",[39,2730,2731,2734,2736,2739,2741,2744],{"class":41,"line":71},[39,2732,2733],{"class":443},"DATE",[39,2735,818],{"class":809},[39,2737,2738],{"class":439},"$(",[39,2740,2656],{"class":45},[39,2742,2743],{"class":49}," '+%F'",[39,2745,2746],{"class":439},")\n",[39,2748,2749],{"class":41,"line":79},[39,2750,854],{"emptyLinePlaceholder":853},[39,2752,2753,2756,2758],{"class":41,"line":87},[39,2754,2755],{"class":443},"TG_BOT_TOKEN",[39,2757,818],{"class":809},[39,2759,2760],{"class":49},"'1145141919:ABCDEFGHIJKLVMNOPQRSTUVWXYZabcdefgh'\n",[39,2762,2763,2766,2768],{"class":41,"line":95},[39,2764,2765],{"class":443},"TG_CHAT_ID",[39,2767,818],{"class":809},[39,2769,2770],{"class":49},"'9191415411'\n",[39,2772,2773],{"class":41,"line":103},[39,2774,854],{"emptyLinePlaceholder":853},[39,2776,2777,2780,2784,2786,2789,2792,2795,2798,2800,2802],{"class":41,"line":1126},[39,2778,2779],{"class":45},"pg_dump",[39,2781,2783],{"class":2782},"sr1Ac"," ${",[39,2785,2723],{"class":443},[39,2787,2788],{"class":2782},"}",[39,2790,2791],{"class":439}," > ",[39,2793,2794],{"class":49},"umami_dump_",[39,2796,2797],{"class":2782},"${",[39,2799,2733],{"class":443},[39,2801,2788],{"class":2782},[39,2803,2804],{"class":49},".sql\n",[39,2806,2807,2809,2812,2815,2817,2819,2821,2824,2827,2829,2831,2833,2836,2838,2840],{"class":41,"line":3},[39,2808,1878],{"class":45},[39,2810,2811],{"class":204}," -F",[39,2813,2814],{"class":49}," document=@umami_dump_",[39,2816,2797],{"class":2782},[39,2818,2733],{"class":443},[39,2820,2788],{"class":2782},[39,2822,2823],{"class":49},".sql",[39,2825,2826],{"class":49}," https://api.telegram.org/bot",[39,2828,2797],{"class":2782},[39,2830,2755],{"class":443},[39,2832,2788],{"class":2782},[39,2834,2835],{"class":49},"/sendDocument?chat_id=",[39,2837,2797],{"class":2782},[39,2839,2765],{"class":443},[39,2841,1129],{"class":2782},[39,2843,2844,2847,2850,2852,2854,2856],{"class":41,"line":1136},[39,2845,2846],{"class":45},"rm",[39,2848,2849],{"class":49}," umami_dump_",[39,2851,2797],{"class":2782},[39,2853,2733],{"class":443},[39,2855,2788],{"class":2782},[39,2857,2804],{"class":49},[18,2859,2860,2861,2864,2865,2868],{},"将这段代码保存为 ",[25,2862,2863],{},"umami_db_dumper.sh","，随后 ",[25,2866,2867],{},"chmod +x ./umami_db_dumper.sh"," 授予可执行权限。",[18,2870,2871],{},"可以先在命令行中执行命令试一下这段脚本是否正常工作",[30,2873,2875],{"className":32,"code":2874,"language":34,"meta":35,"style":35},"./umami_db_dumper.sh\n",[25,2876,2877],{"__ignoreMap":35},[39,2878,2879],{"class":41,"line":42},[39,2880,2874],{"class":45},[18,2882,2883],{},"这段代码在我本机正常工作，可惜在我的 Ubuntu VPS 上报错",[30,2885,2888],{"className":2886,"code":2887,"language":246},[244],"pg_dump: error: server version: 14.1; pg_dump version: 12.17 (Ubuntu 12.17-0ubuntu0.20.04.1)\npg_dump: error: aborting because of server version mismatch\n",[25,2889,2887],{"__ignoreMap":35},[18,2891,2892,2893,2898],{},"看上去是 VPS 上的 PostgreSQL 版本过低，Google 搜索一顿后，我在一篇",[114,2894,2897],{"href":2895,"rel":2896},"https://devopsworld.medium.com/upgrade-pg-dump-version-in-ubuntu-545d691d4695",[118],"「Upgrade pg_dump version in ubuntu | by Anushareddy」"," 文章中找到了方案，添加 PostgreSQL 官方提供的 apt 源将 VPS 上的 PostgreSQL 更新到新版即可解决。",[30,2900,2902],{"className":32,"code":2901,"language":34,"meta":35,"style":35},"wget --quiet -O - https://www.postgresql.org/media/keys/ACCC4CF8.asc | apt-key add -\necho \"deb http://apt.postgresql.org/pub/repos/apt/ $(lsb_release -cs)-pgdg main\" > /etc/apt/sources.list.d/pgdg.list\napt update\napt install postgresql-client\n",[25,2903,2904,2932,2954,2962],{"__ignoreMap":35},[39,2905,2906,2909,2912,2915,2918,2921,2923,2926,2929],{"class":41,"line":42},[39,2907,2908],{"class":45},"wget",[39,2910,2911],{"class":204}," --quiet",[39,2913,2914],{"class":204}," -O",[39,2916,2917],{"class":49}," -",[39,2919,2920],{"class":49}," https://www.postgresql.org/media/keys/ACCC4CF8.asc",[39,2922,1887],{"class":439},[39,2924,2925],{"class":45},"apt-key",[39,2927,2928],{"class":49}," add",[39,2930,2931],{"class":49}," -\n",[39,2933,2934,2937,2940,2943,2946,2949,2951],{"class":41,"line":56},[39,2935,2936],{"class":1627},"echo",[39,2938,2939],{"class":49}," \"deb http://apt.postgresql.org/pub/repos/apt/ $(",[39,2941,2942],{"class":45},"lsb_release",[39,2944,2945],{"class":204}," -cs",[39,2947,2948],{"class":49},")-pgdg main\"",[39,2950,2791],{"class":439},[39,2952,2953],{"class":49},"/etc/apt/sources.list.d/pgdg.list\n",[39,2955,2956,2959],{"class":41,"line":62},[39,2957,2958],{"class":45},"apt",[39,2960,2961],{"class":49}," update\n",[39,2963,2964,2966,2969],{"class":41,"line":71},[39,2965,2958],{"class":45},[39,2967,2968],{"class":49}," install",[39,2970,2971],{"class":49}," postgresql-client\n",[18,2973,2974,2975,2978],{},"确保脚本正常工作后，使用 ",[25,2976,2977],{},"crontab -e"," 设置自动任务",[30,2980,2982],{"className":32,"code":2981,"language":34,"meta":35,"style":35},"0 2 * * * /root/umami_db_dumper.sh\n",[25,2983,2984],{"__ignoreMap":35},[39,2985,2986,2988,2991,2993,2995,2997],{"class":41,"line":42},[39,2987,875],{"class":45},[39,2989,2990],{"class":204}," 2",[39,2992,356],{"class":279},[39,2994,356],{"class":279},[39,2996,356],{"class":279},[39,2998,2999],{"class":49}," /root/umami_db_dumper.sh\n",[18,3001,3002],{},[321,3003],{"alt":3004,"src":3005},"数据库备份","https://static.031130.xyz/uploads/2024/08/12/65c79455b2e40.webp",[386,3007,3008],{},"html pre.shiki code .sW2Sy, html code.shiki .sW2Sy{--shiki-default:#A0A1A7;--shiki-default-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic}html pre.shiki code .sJa8x, html code.shiki .sJa8x{--shiki-default:#E45649;--shiki-dark:#E06C75}html pre.shiki code .sknuh, html code.shiki .sknuh{--shiki-default:#383A42;--shiki-dark:#56B6C2}html pre.shiki code .sDhpE, html code.shiki .sDhpE{--shiki-default:#50A14F;--shiki-dark:#98C379}html pre.shiki code .s5ixo, html code.shiki .s5ixo{--shiki-default:#383A42;--shiki-dark:#ABB2BF}html pre.shiki code .sAdtL, html code.shiki .sAdtL{--shiki-default:#4078F2;--shiki-dark:#61AFEF}html pre.shiki code .sr1Ac, html code.shiki .sr1Ac{--shiki-default:#E45649;--shiki-dark:#ABB2BF}html pre.shiki code .sAGMh, html code.shiki .sAGMh{--shiki-default:#986801;--shiki-dark:#D19A66}html .default .shiki span {color: var(--shiki-default);background: var(--shiki-default-bg);font-style: var(--shiki-default-font-style);font-weight: var(--shiki-default-font-weight);text-decoration: var(--shiki-default-text-decoration);}html .shiki span {color: var(--shiki-default);background: var(--shiki-default-bg);font-style: var(--shiki-default-font-style);font-weight: var(--shiki-default-font-weight);text-decoration: var(--shiki-default-text-decoration);}html .dark .shiki span {color: var(--shiki-dark);background: var(--shiki-dark-bg);font-style: var(--shiki-dark-font-style);font-weight: var(--shiki-dark-font-weight);text-decoration: var(--shiki-dark-text-decoration);}html.dark .shiki span {color: var(--shiki-dark);background: var(--shiki-dark-bg);font-style: var(--shiki-dark-font-style);font-weight: var(--shiki-dark-font-weight);text-decoration: var(--shiki-dark-text-decoration);}html pre.shiki code .s_Sar, html code.shiki .s_Sar{--shiki-default:#0184BC;--shiki-dark:#56B6C2}html pre.shiki code .s2QsP, html code.shiki .s2QsP{--shiki-default:#E45649;--shiki-dark:#E5C07B}",{"title":35,"searchDepth":56,"depth":56,"links":3010},[],{"title":3012,"date":3013,"path":3014,"tags":3015,"body":3016},"在 JavaScript 中，箭头函数中的 this 指针到底指向哪里？","2024-01-14 02:50:03","/2024/01/14/where-does-this-refer-in-arrow-function-in-js",[1407],{"type":15,"value":3017,"toc":3438},[3018,3025,3332,3335,3342,3348,3359,3362,3365,3376,3382,3398,3405,3411,3414,3421,3428,3435],[18,3019,3020,3021,3024],{},"这学期期末复习的时候，学校里负责上 JavaScript 的老师给我们提出了一个问题。下面这段代码中，",[25,3022,3023],{},"a.u2()"," 在 ES Module 下执行会抛出 TypeError 的异常，在 CommonJS 下运行则会输出 undefined，而 B 这个类的 u2 函数则能够在对象实例化以后正常运行。",[30,3026,3030],{"className":3027,"code":3028,"language":3029,"meta":35,"style":35},"language-javascript shiki shiki-themes one-light one-dark-pro","const a = {\n    x: 3,\n    u1: function () {\n        console.log(this.x)\n    },\n    u2: () => {\n        console.log(this.x)\n    }\n}\n\nclass b {\n    x = 3\n\n    u1 = function () {\n        console.log(this.x)\n    }\n\n    u2 = () => {\n        console.log(this.x)\n    }\n}\n\na.u1()\n// 3\na.u2()\n// undefined\n\nnew b().u1()\n// 3\nnew b().u2()\n// 3\n","javascript",[25,3031,3032,3043,3057,3070,3095,3100,3115,3133,3138,3142,3146,3157,3166,3170,3180,3198,3202,3206,3219,3238,3243,3248,3253,3265,3271,3283,3289,3294,3309,3314,3327],{"__ignoreMap":35},[39,3033,3034,3036,3039,3041],{"class":41,"line":42},[39,3035,1621],{"class":507},[39,3037,3038],{"class":1624}," a",[39,3040,1628],{"class":1627},[39,3042,864],{"class":439},[39,3044,3045,3048,3052,3055],{"class":41,"line":56},[39,3046,3047],{"class":443},"    x",[39,3049,3051],{"class":3050},"st7oF",":",[39,3053,3054],{"class":204}," 3",[39,3056,1639],{"class":439},[39,3058,3059,3062,3064,3067],{"class":41,"line":62},[39,3060,3061],{"class":45},"    u1",[39,3063,3051],{"class":3050},[39,3065,3066],{"class":507}," function",[39,3068,3069],{"class":439}," () {\n",[39,3071,3072,3076,3079,3082,3085,3088,3090,3093],{"class":41,"line":71},[39,3073,3075],{"class":3074},"s7GmK","        console",[39,3077,3078],{"class":439},".",[39,3080,3081],{"class":45},"log",[39,3083,3084],{"class":439},"(",[39,3086,3087],{"class":279},"this",[39,3089,3078],{"class":439},[39,3091,3092],{"class":443},"x",[39,3094,2746],{"class":439},[39,3096,3097],{"class":41,"line":79},[39,3098,3099],{"class":439},"    },\n",[39,3101,3102,3105,3107,3110,3113],{"class":41,"line":87},[39,3103,3104],{"class":45},"    u2",[39,3106,3051],{"class":3050},[39,3108,3109],{"class":439}," () ",[39,3111,3112],{"class":507},"=>",[39,3114,864],{"class":439},[39,3116,3117,3119,3121,3123,3125,3127,3129,3131],{"class":41,"line":95},[39,3118,3075],{"class":3074},[39,3120,3078],{"class":439},[39,3122,3081],{"class":45},[39,3124,3084],{"class":439},[39,3126,3087],{"class":279},[39,3128,3078],{"class":439},[39,3130,3092],{"class":443},[39,3132,2746],{"class":439},[39,3134,3135],{"class":41,"line":103},[39,3136,3137],{"class":439},"    }\n",[39,3139,3140],{"class":41,"line":1126},[39,3141,1129],{"class":439},[39,3143,3144],{"class":41,"line":3},[39,3145,854],{"emptyLinePlaceholder":853},[39,3147,3148,3151,3155],{"class":41,"line":1136},[39,3149,3150],{"class":507},"class",[39,3152,3154],{"class":3153},"sC09Y"," b",[39,3156,864],{"class":439},[39,3158,3159,3161,3163],{"class":41,"line":1162},[39,3160,3047],{"class":1547},[39,3162,1628],{"class":1627},[39,3164,3165],{"class":204}," 3\n",[39,3167,3168],{"class":41,"line":1167},[39,3169,854],{"emptyLinePlaceholder":853},[39,3171,3172,3174,3176,3178],{"class":41,"line":1656},[39,3173,3061],{"class":45},[39,3175,1628],{"class":1627},[39,3177,3066],{"class":507},[39,3179,3069],{"class":439},[39,3181,3182,3184,3186,3188,3190,3192,3194,3196],{"class":41,"line":1664},[39,3183,3075],{"class":3074},[39,3185,3078],{"class":439},[39,3187,3081],{"class":45},[39,3189,3084],{"class":439},[39,3191,3087],{"class":279},[39,3193,3078],{"class":439},[39,3195,3092],{"class":443},[39,3197,2746],{"class":439},[39,3199,3200],{"class":41,"line":1670},[39,3201,3137],{"class":439},[39,3203,3204],{"class":41,"line":1675},[39,3205,854],{"emptyLinePlaceholder":853},[39,3207,3209,3211,3213,3215,3217],{"class":41,"line":3208},18,[39,3210,3104],{"class":45},[39,3212,1628],{"class":1627},[39,3214,3109],{"class":439},[39,3216,3112],{"class":507},[39,3218,864],{"class":439},[39,3220,3222,3224,3226,3228,3230,3232,3234,3236],{"class":41,"line":3221},19,[39,3223,3075],{"class":3074},[39,3225,3078],{"class":439},[39,3227,3081],{"class":45},[39,3229,3084],{"class":439},[39,3231,3087],{"class":279},[39,3233,3078],{"class":439},[39,3235,3092],{"class":443},[39,3237,2746],{"class":439},[39,3239,3241],{"class":41,"line":3240},20,[39,3242,3137],{"class":439},[39,3244,3246],{"class":41,"line":3245},21,[39,3247,1129],{"class":439},[39,3249,3251],{"class":41,"line":3250},22,[39,3252,854],{"emptyLinePlaceholder":853},[39,3254,3256,3258,3260,3263],{"class":41,"line":3255},23,[39,3257,114],{"class":3074},[39,3259,3078],{"class":439},[39,3261,3262],{"class":45},"u1",[39,3264,1180],{"class":439},[39,3266,3268],{"class":41,"line":3267},24,[39,3269,3270],{"class":2713},"// 3\n",[39,3272,3274,3276,3278,3281],{"class":41,"line":3273},25,[39,3275,114],{"class":3074},[39,3277,3078],{"class":439},[39,3279,3280],{"class":45},"u2",[39,3282,1180],{"class":439},[39,3284,3286],{"class":41,"line":3285},26,[39,3287,3288],{"class":2713},"// undefined\n",[39,3290,3292],{"class":41,"line":3291},27,[39,3293,854],{"emptyLinePlaceholder":853},[39,3295,3297,3300,3302,3305,3307],{"class":41,"line":3296},28,[39,3298,3299],{"class":507},"new",[39,3301,3154],{"class":45},[39,3303,3304],{"class":439},"().",[39,3306,3262],{"class":45},[39,3308,1180],{"class":439},[39,3310,3312],{"class":41,"line":3311},29,[39,3313,3270],{"class":2713},[39,3315,3317,3319,3321,3323,3325],{"class":41,"line":3316},30,[39,3318,3299],{"class":507},[39,3320,3154],{"class":45},[39,3322,3304],{"class":439},[39,3324,3280],{"class":45},[39,3326,1180],{"class":439},[39,3328,3330],{"class":41,"line":3329},31,[39,3331,3270],{"class":2713},[18,3333,3334],{},"这个问题涉及到 JavaScript 中箭头函数的作用域以及 this 指向。",[18,3336,3337,3338,3341],{},"**在 JS 中使用 function 关键字定义的普通函数中，this 指针遵循一个规则：谁调用指向谁。**即 ",[25,3339,3340],{},"obj.func()"," 这种调用情况下，func 方法内部的this指向obj；如果没有调用者，则严格模式下 this 为 undefined，非严格模式下 this 指向window(浏览器)或者global(node环境)。",[18,3343,3344,3345],{},"而箭头函数比较特殊，",[1795,3346,3347],{},"箭头函数的 this 在定义时就被绑定，绑定的是定义时所在作用域中的 this。",[18,3349,3350,3351,3354,3355,3358],{},"在老师给的示例代码中，第一行定义了 a 这个对象字面量，而",[1795,3352,3353],{},"定义对象字面量不会创建新的作用域","，因此 a 中定义的 u2 的 this 指向的是全局对象。因此在 Es Module 默认启用 strict mode 的情况下，全局对象的 this 指向 undefined，进而导致 a 的 u2 内 this 也指向 undefined，this.x 就抛了 TypeError；而在 ",[1795,3356,3357],{},"CommonJS 未启用 strict mode 的情况下，全局对象的 this 指向全局对象","，因而 u2 内的 this 也指向全局对象，因此 this 存在，this.x 就不会抛 TypeError，只会报 undefined。",[18,3360,3361],{},"而 B 类在对象初始化阶段拥有一个新的作用域，因此箭头函数的 this 能够正确指向 B 被实例化出来的对象，因此也就能够正确读取到 this.x 的值。",[18,3363,3364],{},"理论上来说，我们可以给全局对象也赋一个不一样的 x 值，这样 a.u2() 就能够读取到全局对象中的 x 值，验证我们的结论。",[18,3366,3367,3368,3371,3372,3375],{},"在浏览器中，可以在代码的头部加一行 ",[25,3369,3370],{},"var x = 10"," 或者 ",[25,3373,3374],{},"window.x = 10","，可以看到a.u2() 顺利的输出了 10，验证了我的结论。",[18,3377,3378],{},[321,3379],{"alt":3380,"src":3381},"浏览器控制台调试","https://static.031130.xyz/uploads/2024/08/12/65a2e1d093b78.webp",[18,3383,3384,3385,3371,3387,3390,3391,3393,3394,3397],{},"但在 Node.js 中，直接使用 ",[25,3386,3370],{},[25,3388,3389],{},"global.x = 10"," 并不能达到我们想要的效果。因为Node.js 中的每个 CommonJS 模块都有其自己的模块作用域，即模块的顶层作用域不是全局作用域。在模块内部，",[25,3392,3087],{}," 关键字不是指向 ",[25,3395,3396],{},"global"," 对象，而是指向模块的导出对象。这是为了确保模块内部的作用域隔离和模块的封装性。",[18,3399,3400,3401,3404],{},"那么我们可以通过为模块的导出对象添加一个 x 属性来验证我们的结论，我们可以使用 ",[25,3402,3403],{},"exports.x = 10"," 来为模块的顶层作用域添加一个值为 10 的 x 属性。",[18,3406,3407],{},[321,3408],{"alt":3409,"src":3410},"nodejs 环境运行","https://static.031130.xyz/uploads/2024/08/12/65a2e379ba89e.webp",[183,3412,3413],{"id":3413},"参考文章",[18,3415,3416],{},[114,3417,3420],{"href":3418,"rel":3419},"https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Functions/Arrow_functions",[118],"箭头函数表达式 - JavaScript | MDN",[18,3422,3423],{},[114,3424,3427],{"href":3425,"rel":3426},"https://segmentfault.com/q/1010000022948115",[118],"ES6箭头函数作用域的问题",[18,3429,3430],{},[114,3431,3434],{"href":3432,"rel":3433},"https://www.zhihu.com/tardis/zm/art/57204184",[118],"ES6箭头函数的this指向详解",[386,3436,3437],{},"html pre.shiki code .sLKXg, html code.shiki .sLKXg{--shiki-default:#A626A4;--shiki-dark:#C678DD}html pre.shiki code .sNmU0, html code.shiki .sNmU0{--shiki-default:#986801;--shiki-dark:#E5C07B}html pre.shiki code .s_Sar, html code.shiki .s_Sar{--shiki-default:#0184BC;--shiki-dark:#56B6C2}html pre.shiki code .s5ixo, html code.shiki .s5ixo{--shiki-default:#383A42;--shiki-dark:#ABB2BF}html pre.shiki code .sJa8x, html code.shiki .sJa8x{--shiki-default:#E45649;--shiki-dark:#E06C75}html pre.shiki code .st7oF, html code.shiki .st7oF{--shiki-default:#0184BC;--shiki-dark:#ABB2BF}html pre.shiki code .sAGMh, html code.shiki .sAGMh{--shiki-default:#986801;--shiki-dark:#D19A66}html pre.shiki code .sAdtL, html code.shiki .sAdtL{--shiki-default:#4078F2;--shiki-dark:#61AFEF}html pre.shiki code .s7GmK, html code.shiki .s7GmK{--shiki-default:#383A42;--shiki-dark:#E5C07B}html pre.shiki code .s2QsP, html code.shiki .s2QsP{--shiki-default:#E45649;--shiki-dark:#E5C07B}html pre.shiki code .sC09Y, html code.shiki .sC09Y{--shiki-default:#C18401;--shiki-dark:#E5C07B}html pre.shiki code .sz0mV, html code.shiki .sz0mV{--shiki-default:#383A42;--shiki-dark:#E06C75}html pre.shiki code .sW2Sy, html code.shiki .sW2Sy{--shiki-default:#A0A1A7;--shiki-default-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic}html .default .shiki span {color: var(--shiki-default);background: var(--shiki-default-bg);font-style: var(--shiki-default-font-style);font-weight: var(--shiki-default-font-weight);text-decoration: var(--shiki-default-text-decoration);}html .shiki span {color: var(--shiki-default);background: var(--shiki-default-bg);font-style: var(--shiki-default-font-style);font-weight: var(--shiki-default-font-weight);text-decoration: var(--shiki-default-text-decoration);}html .dark .shiki span {color: var(--shiki-dark);background: var(--shiki-dark-bg);font-style: var(--shiki-dark-font-style);font-weight: var(--shiki-dark-font-weight);text-decoration: var(--shiki-dark-text-decoration);}html.dark .shiki span {color: var(--shiki-dark);background: var(--shiki-dark-bg);font-style: var(--shiki-dark-font-style);font-weight: var(--shiki-dark-font-weight);text-decoration: var(--shiki-dark-text-decoration);}",{"title":35,"searchDepth":56,"depth":56,"links":3439},[3440],{"id":3413,"depth":56,"text":3413},129,1763565780173]